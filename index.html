<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Curriculum Tracker</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

  <!-- React -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    @keyframes fall { to { transform: translateY(120vh) rotate(20deg); opacity: 0; } }
    * { box-sizing: border-box; }
    /* Flip card styles */
    .flip-card { perspective: 1200px; }
    .flip-card-inner { transition: transform 0.6s; transform-style: preserve-3d; position: relative; }
    .flip-card.flip .flip-card-inner { transform: rotateY(180deg); }
    .flip-card-front, .flip-card-back {
      backface-visibility: hidden;
      -webkit-backface-visibility: hidden;
      position: absolute; inset: 0;
    }
    .flip-card-back { transform: rotateY(180deg); }
    /* small focus glow for selects and inputs */
    input:focus, select:focus, textarea:focus { outline: none; box-shadow: 0 0 0 5px rgba(99,102,241,0.08); border-color: #6366F1; }
    /* confetti defaults */
    .confetti-piece { position: absolute; font-size: 18px; animation: fall 3s linear forwards; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
/* Curriculum Tracker - single file app
   - Firebase Firestore read/write
   - Admin CRUD (teachers, curriculum)
   - Chapter target logic, confetti, birthdays
   - Chart.js analytics
   - CSS flip animations on chapter cards
*/

const { useState, useEffect, useRef } = React;

// --- === USE YOUR EXISTING FIREBASE PROJECT CONFIG BELOW (kept same) === ---
const firebaseConfig = {
  apiKey: "AIzaSyDyyGAHNJvhuint86USW36eBJKfw_u3AcA",
  authDomain: "curriculum-dbb10.firebaseapp.com",
  projectId: "curriculum-dbb10",
  storageBucket: "curriculum-dbb10.firebasestorage.app",
  messagingSenderId: "706387632109",
  appId: "1:706387632109:web:06c78a304fdbdc12f391e4"
};
// -------------------------------------------------------------------------

if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

function App() {
  // global states
  const [currentUser, setCurrentUser] = useState(null);
  const [isAdmin, setIsAdmin] = useState(false);
  const [activeTab, setActiveTab] = useState('overview');
  const [loginForm, setLoginForm] = useState({ afid: '', password: '' });
  const [loading, setLoading] = useState(false);

  const [teachers, setTeachers] = useState([]);
  const [curriculum, setCurriculum] = useState({});
  const [chapterProgress, setChapterProgress] = useState({});
  const [analyticsData, setAnalyticsData] = useState(null);

  // UI states
  const [expandedChapters, setExpandedChapters] = useState({});
  const [flipState, setFlipState] = useState({}); // for card flips
  const [showConfetti, setShowConfetti] = useState(false);

  // Chart refs
  const pieRef = useRef(null), barRef = useRef(null), schoolRef = useRef(null);
  const charts = useRef({});

  // seed data used only if DB not initialized
  const TEACHERS_SEED = [
    { afid:'AF248', name:'Vivek Bansal', subject:'Physics', school:'CoE Barwani', dob:'1990-03-15', email:'vivek@example.com', phone:'9876543210', password:'pass123' },
    { afid:'AF464', name:'Sandeep Dixit', subject:'Chemistry', school:'CoE Barwani', dob:'1988-07-22', email:'sandeep@example.com', phone:'9876543211', password:'pass123' },
    { afid:'AF853', name:'Dayanand Kumar', subject:'Maths', school:'CoE Barwani', dob:'1992-11-08', email:'dayanand@example.com', phone:'9876543212', password:'pass123' },
    { afid:'AF723', name:'Ranjesh', subject:'Biology', school:'JNV Bharuch', dob:'1990-05-05', email:'ranjesh@example.com', phone:'9876543228', password:'pass123' }
  ];
  const CURRICULUM_SEED = {
    Physics:{11:[{id:'P11-1', name:'Physical World', topics:['Units','Dimensions','Motion'], targetDate:'2025-11-15'}],12:[{id:'P12-1', name:'Electric Charges',topics:['Charge','Coulomb'], targetDate:'2025-12-15'}]},
    Chemistry:{11:[{id:'C11-1', name:'Basic Concepts', topics:['Matter','Atoms'], targetDate:'2025-11-20'}],12:[{id:'C12-1', name:'Solutions', topics:['Concentration'], targetDate:'2025-12-05'}]},
    Maths:{11:[{id:'M11-1', name:'Sets', topics:['Theory'], targetDate:'2025-11-25'}],12:[{id:'M12-1', name:'Functions', topics:['Types'], targetDate:'2025-12-10'}]},
    Biology:{11:[{id:'B11-1', name:'Living World', topics:['Diversity'], targetDate:'2025-11-18'}],12:[{id:'B12-1', name:'Reproduction', topics:['Asexual'], targetDate:'2025-12-12'}]}
  };

  // ----- initialize, listeners, and seeding -----
  useEffect(() => {
    let unsubP, unsubT, unsubC;
    const init = async () => {
      try {
        const initDoc = await db.collection('system').doc('initialized').get();
        if (!initDoc.exists) {
          // seed
          for (const t of TEACHERS_SEED) await db.collection('teachers').doc(t.afid).set(t);
          await db.collection('meta').doc('curriculum').set(CURRICULUM_SEED);
          await db.collection('system').doc('initialized').set({ date: new Date().toISOString() });
          console.log('DB seeded');
        }
      } catch (e) { console.error('init error', e); }
    };

    unsubP = db.collection('chapterProgress').onSnapshot(snap => {
      const map = {};
      snap.docs.forEach(d => map[d.id] = d.data());
      setChapterProgress(map);
    });

    unsubT = db.collection('teachers').onSnapshot(snap => {
      setTeachers(snap.docs.map(d => d.data()));
    });

    unsubC = db.collection('meta').doc('curriculum').onSnapshot(doc => {
      if (doc.exists) setCurriculum(doc.data());
      else setCurriculum(CURRICULUM_SEED);
    });

    init();
    return () => { if (unsubP) unsubP(); if (unsubT) unsubT(); if (unsubC) unsubC(); };
  }, []);

  // ----- helper: compute chapter status -----
  function computeChapterStatus(chapter = {}, progress = {}) {
    // handles targetDate, completed, testConducted, completedTopics
    if (!chapter || !chapter.targetDate) return { label:'No target', key:'no-target', color:'bg-gray-100' };
    const target = new Date(chapter.targetDate);
    const today = new Date();
    const compDate = progress.completionDate ? new Date(progress.completionDate) : null;
    const topicsDone = (progress.completedTopics || []).length;
    const topicsTotal = (chapter.topics || []).length;

    // If completed yes but test not conducted -> partial
    if (progress.completed === 'Yes' && progress.testConducted !== 'Yes') {
      // If target passed -> partial (but still delayed-like, show orange)
      return { label:'Partially completed', key:'partial', color:'bg-orange-100' };
    }

    // Not completed
    if (progress.completed !== 'Yes') {
      // partial topics
      if (topicsDone > 0 && topicsDone < topicsTotal) {
        return { label:'Partially done', key:'partial-topics', color:'bg-orange-100' };
      }
      // not started and overdue
      if (today > target) return { label:'Delayed', key:'delayed', color:'bg-red-100' };
      return { label:'Pending', key:'pending', color:'bg-yellow-100' };
    }

    // If completed === 'Yes' AND test conducted === 'Yes'
    if (compDate) {
      if (compDate > target) return { label:'Delayed', key:'delayed', color:'bg-red-100' };
      if (compDate.toDateString() === target.toDateString()) return { label:'On Track', key:'ontrack', color:'bg-green-100' };
      if (compDate < target) return { label:'Ahead ‚Äî Good job', key:'ahead', color:'bg-green-100' };
      return { label:'Completed', key:'completed', color:'bg-green-100' };
    }

    // fallback
    return { label:'Completed', key:'completed', color:'bg-green-100' };
  }

  // ----- analytics compute -----
  useEffect(() => {
    if (!curriculum) return;
    const schoolStatus = {};
    const teacherMap = {};
    let totalChapters = 0, totalCompleted = 0;

    Object.keys(curriculum).forEach(subject => {
      Object.keys(curriculum[subject]).forEach(grade => {
        (curriculum[subject][grade] || []).forEach(ch => {
          totalChapters++;
          const prog = chapterProgress[ch.id] || {};
          const st = computeChapterStatus(ch, prog);
          if (st.key === 'completed') totalCompleted++;
          teachers.forEach(t => {
            if (t.subject === subject) {
              teacherMap[t.afid] = teacherMap[t.afid] || { afid: t.afid, name: t.name, school: t.school, completed:0, total:0 };
              teacherMap[t.afid].total++;
              if (st.key === 'completed') teacherMap[t.afid].completed++;
            }
            // school accum
            schoolStatus[t.school] = schoolStatus[t.school] || { delayed:0, ontrack:0, total:0 };
            schoolStatus[t.school].total++;
            if (st.key === 'delayed') schoolStatus[t.school].delayed++;
            else if (['ontrack','ahead','completed'].includes(st.key)) schoolStatus[t.school].ontrack++;
          });
        });
      });
    });

    const teacherArr = Object.values(teacherMap).map(t => ({ ...t, percent: t.total ? Math.round((t.completed / t.total) * 100) : 0 }));
    teacherArr.sort((a,b) => b.percent - a.percent);
    setAnalyticsData({ totalChapters, totalCompleted, teacherArr, schoolStatus });
  }, [curriculum, chapterProgress, teachers]);

  // ----- Chart rendering -----
  useEffect(() => {
    if (!analyticsData) {
      destroyAllCharts();
      return;
    }
    // Doughnut
    const completed = analyticsData.totalCompleted || 0;
    const pending = Math.max(0, (analyticsData.totalChapters || 0) - completed);
    if (pieRef.current) {
      if (charts.current?.pie) charts.current.pie.destroy();
      charts.current.pie = new Chart(pieRef.current.getContext('2d'), {
        type:'doughnut',
        data:{ labels:['Completed','Pending'], datasets:[{ data:[completed,pending], backgroundColor:['#10B981','#F97316'] }] },
        options:{ plugins:{ legend:{ position:'bottom' } }, cutout: '65%' }
      });
    }

    // Bar (teacher)
    if (barRef.current) {
      if (charts.current.bar) charts.current.bar.destroy();
      const top = analyticsData.teacherArr.slice(0,8);
      charts.current.bar = new Chart(barRef.current.getContext('2d'), {
        type:'bar',
        data:{ labels: top.map(t => `${t.name} (${t.afid})`), datasets:[{ label:'Completion %', data: top.map(t=>t.percent), backgroundColor:'#6366F1' }] },
        options:{ indexAxis:'y', plugins:{ legend:{ display:false } }, scales:{ x:{ min:0, max:100, ticks:{ callback:v => v + '%' } } } }
      });
    }

    // School stacked
    if (schoolRef.current) {
      if (charts.current.school) charts.current.school.destroy();
      const schools = Object.keys(analyticsData.schoolStatus || {});
      const ontrack = schools.map(s => analyticsData.schoolStatus[s].ontrack || 0);
      const delayed = schools.map(s => analyticsData.schoolStatus[s].delayed || 0);
      charts.current.school = new Chart(schoolRef.current.getContext('2d'), {
        type:'bar',
        data:{ labels: schools, datasets: [{ label:'On track', data:ontrack, backgroundColor:'#10B981' }, { label:'Delayed', data:delayed, backgroundColor:'#EF4444' }] },
        options:{ plugins:{ legend:{ position:'bottom' } }, scales:{ x:{ stacked:true }, y:{ stacked:true } } }
      });
    }

  }, [analyticsData]);

  function destroyAllCharts() { Object.values(charts.current || {}).forEach(c => { if (c && c.destroy) c.destroy(); }); charts.current = {}; }

  // ----- login (mocked) -----
  const handleLogin = async () => {
    setLoading(true);
    try {
      const afid = (loginForm.afid || '').trim().toUpperCase();
      if (!afid) { alert('Enter AFID'); setLoading(false); return; }
      // admin hidden - no hint on UI
      if (afid === 'ADMIN' && loginForm.password === 'admin123') {
        setIsAdmin(true);
        setCurrentUser({ name:'Administrator', afid:'ADMIN' });
        setActiveTab('admin');
        setLoading(false);
        return;
      }
      const doc = await db.collection('teachers').doc(afid).get();
      if (!doc.exists) { alert('Invalid AFID or password'); setLoading(false); return; }
      const t = doc.data();
      if (t.password === loginForm.password) {
        setCurrentUser(t);
        setIsAdmin(false);
        setActiveTab('overview');
        // birthday confetti
        if (t.dob) {
          const d = new Date(t.dob); const now = new Date();
          if (d.getMonth() === now.getMonth() && d.getDate() === now.getDate()) setShowConfetti(true);
        }
      } else { alert('Invalid AFID or password'); }
    } catch (e) { console.error('login error', e); alert('Login failed'); }
    setLoading(false);
  };

  // ----- update chapter progress (write to firestore) -----
  const updateChapterProgress = async (chapterId, field, value) => {
    try {
      // if clearing date, set null
      const updateObj = { [field]: value };
      // special-case: if completed set to No -> clear completionDate
      if (field === 'completed' && value === 'No') updateObj['completionDate'] = null;
      await db.collection('chapterProgress').doc(chapterId).set(updateObj, { merge: true });
      // optimistic local update
      setChapterProgress(prev => ({ ...prev, [chapterId]: { ...(prev[chapterId]||{}), ...updateObj } }));
      // confetti logic: if completed yes and testconducted yes -> show confetti
      if (field === 'completed' && value === 'Yes') {
        // read current testConducted after update (optimistic)
        const cur = chapterProgress[chapterId] || {};
        if (cur.testConducted === 'Yes' || updateObj.testConducted === 'Yes') {
          setShowConfetti(true);
          setTimeout(() => setShowConfetti(false), 3500);
        }
      }
    } catch (e) {
      console.error('update error', e);
      alert('Failed to update. Check Firestore rules and network.');
    }
  };

  // manual toggle expand for topics
  const toggleExpand = (id) => setExpandedChapters(prev => ({ ...prev, [id]: !prev[id] }));

  // flip state on card
  const toggleFlip = (id) => setFlipState(prev => ({ ...prev, [id]: !prev[id] }));

  // export analytics CSV
  const exportCSV = () => {
    if (!analyticsData) return alert('No analytics yet');
    const rows = [['AFID','Name','School','Completed','Total','Percent']];
    analyticsData.teacherArr.forEach(t => rows.push([t.afid, t.name, t.school, t.completed, t.total, t.percent + '%']));
    const csv = rows.map(r => r.map(c => `"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download = `analytics_${new Date().toISOString().slice(0,10)}.csv`; a.click(); URL.revokeObjectURL(url);
  };

  // todays birthdays list
  const todaysBirthdays = teachers.filter(t => {
    if (!t.dob) return false;
    const d = new Date(t.dob); const now = new Date();
    return d.getDate() === now.getDate() && d.getMonth() === now.getMonth();
  });

  // upcoming week/month birthdays
  const upcoming = (period='week') => {
    const now = new Date();
    return teachers.filter(t => {
      if (!t.dob) return false;
      const d = new Date(t.dob);
      const next = new Date(now.getFullYear(), d.getMonth(), d.getDate());
      const diff = Math.ceil((next - now)/(1000*60*60*24));
      if (period === 'week') return diff >=0 && diff <= 7;
      return diff >=0 && diff <= 30;
    });
  };

  // ----- Admin CRUD helpers -----
  const addOrUpdateTeacher = async (teacherObj) => {
    if (!teacherObj.afid) return alert('AFID required');
    const id = teacherObj.afid.toUpperCase();
    try {
      await db.collection('teachers').doc(id).set({ ...teacherObj, afid: id }, { merge: true });
      alert('Saved teacher');
    } catch (e) { console.error('save teacher err', e); alert('Save failed'); }
  };

  const deleteTeacher = async (afid) => {
    if (!confirm('Delete teacher ' + afid + '?')) return;
    try { await db.collection('teachers').doc(afid).delete(); alert('Deleted'); } catch (e) { console.error(e); alert('Delete failed'); }
  };

  const saveCurriculum = async (newCurr) => {
    try { await db.collection('meta').doc('curriculum').set(newCurr); alert('Curriculum updated'); } catch (e) { console.error(e); alert('Failed'); }
  };

  const addChapterAdmin = async (subject, grade, chapter) => {
    const newCurr = { ...(curriculum || {}) };
    newCurr[subject] = newCurr[subject] || {};
    newCurr[subject][grade] = newCurr[subject][grade] || [];
    chapter.id = chapter.id || (subject.charAt(0).toUpperCase() + grade + '-' + (newCurr[subject][grade].length + 1) + '-' + Date.now().toString().slice(-4));
    newCurr[subject][grade].push(chapter);
    await saveCurriculum(newCurr);
  };

  const updateChapterAdmin = async (subject, grade, chapterId, updates) => {
    try {
      const newCurr = { ...(curriculum || {}) };
      const arr = newCurr[subject][grade];
      const idx = arr.findIndex(x => x.id === chapterId);
      if (idx === -1) return;
      arr[idx] = { ...arr[idx], ...updates };
      await saveCurriculum(newCurr);
    } catch (e) { console.error(e); alert('Failed update'); }
  };

  const deleteChapterAdmin = async (subject, grade, id) => {
    if (!confirm('Delete chapter?')) return;
    try {
      const newCurr = { ...(curriculum || {}) };
      newCurr[subject][grade] = newCurr[subject][grade].filter(ch => ch.id !== id);
      await saveCurriculum(newCurr);
    } catch (e) { console.error(e); alert('Delete failed'); }
  };

  // ----- UI Components render -----
  if (!currentUser) {
    // Login UI - remove demo credentials
    return (
      <div className="min-h-screen bg-gradient-to-br from-purple-600 via-pink-500 to-red-500 flex items-center justify-center p-4">
        <div className="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
          <div className="text-center mb-6">
            <div className="text-6xl">üìö</div>
            <h1 className="text-3xl font-bold text-gray-800">Curriculum Tracker</h1>
            <p className="text-gray-600 mt-2">Login to continue</p>
          </div>

          <div className="space-y-4">
            <input className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg" value={loginForm.afid} onChange={e => setLoginForm({...loginForm, afid: e.target.value})} placeholder="AFID" />
            <input type="password" className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg" value={loginForm.password} onChange={e => setLoginForm({...loginForm, password: e.target.value})} placeholder="Password" />
            <button onClick={handleLogin} disabled={loading} className="w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white py-3 rounded-lg font-semibold">{loading ? 'Logging in...' : 'Login'}</button>
          </div>
        </div>
      </div>
    );
  }

  // Confetti component
  function Confetti() {
    const colors = ['üéâ','‚ú®','üéä','ü•≥','üéà'];
    return (
      <div className="fixed inset-0 pointer-events-none z-50">
        {Array.from({length: 40}).map((_,i) => (
          <div key={i} className="confetti-piece" style={{
            left: `${Math.random()*100}%`,
            top: `${Math.random()*8}%`,
            animationDelay: `${Math.random()*1.5}s`,
            fontSize: `${12 + Math.random()*18}px`
          }}>{colors[i % colors.length]}</div>
        ))}
      </div>
    );
  }

  // Overview for teachers
  const Overview = () => {
    const subjects = Object.keys(curriculum || {});
    return (
      <div className="space-y-6">
        <h2 className="text-3xl font-bold">üìä Overview</h2>
        <div className="grid md:grid-cols-2 gap-6">
          {[11,12].map(g => (
            <div key={g} className="bg-white rounded-xl shadow p-6">
              <h3 className="text-xl font-semibold mb-4">Class {g}th</h3>
              <div className="space-y-3">
                {subjects.map(s => {
                  const chapters = (curriculum[s] && curriculum[s][g]) || [];
                  const completedCount = chapters.filter(ch => (chapterProgress[ch.id]?.completed === 'Yes' && chapterProgress[ch.id]?.testConducted === 'Yes')).length;
                  const percentage = chapters.length ? Math.round((completedCount / chapters.length) * 100) : 0;
                  return (
                    <div key={s} className="p-3 border rounded">
                      <div className="flex justify-between"><div className="font-medium">{s}</div><div className="font-bold">{percentage}%</div></div>
                      <div className="h-3 bg-gray-200 rounded mt-2"><div className="h-3 rounded bg-green-500" style={{ width: `${percentage}%` }}></div></div>
                      <div className="text-sm text-gray-500 mt-1">{completedCount} / {chapters.length} chapters completed (test done)</div>
                    </div>
                  );
                })}
              </div>
            </div>
          ))}

          <div className="bg-white rounded-xl shadow p-6">
            <h3 className="text-xl font-semibold">Birthdays</h3>
            <div className="mt-3 space-y-3">
              <div className="p-3 border rounded">
                <div className="font-semibold">This Week</div>
                <div className="text-sm text-gray-600 mt-2">{upcoming('week').length ? upcoming('week').map(t => <div key={t.afid} className="flex justify-between"><div>{t.name} ({t.afid})</div><div className="text-sm">{new Date(t.dob).toLocaleDateString(undefined,{month:'short',day:'numeric'})}</div></div>) : <div className="text-gray-500">No birthdays this week</div>}</div>
              </div>

              <div className="p-3 border rounded">
                <div className="font-semibold">This Month</div>
                <div className="text-sm text-gray-600 mt-2">{upcoming('month').length ? upcoming('month').map(t => <div key={t.afid} className="flex justify-between"><div>{t.name} ({t.afid})</div><div className="text-sm">{new Date(t.dob).toLocaleDateString(undefined,{month:'short',day:'numeric'})}</div></div>) : <div className="text-gray-500">No birthdays this month</div>}</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    );
  };

  // Chapters page for teacher
  const Chapters = () => {
    const [selectedGrade, setSelectedGrade] = useState(11);
    const subj = currentUser.subject;
    const chapters = (curriculum[subj] && curriculum[subj][selectedGrade]) || [];

    return (
      <div className="space-y-6">
        <h2 className="text-3xl font-bold">üìò Chapters - {subj}</h2>
        <div className="flex gap-3 mb-4">
          <button onClick={() => setSelectedGrade(11)} className={`px-4 py-2 rounded ${selectedGrade===11 ? 'bg-purple-600 text-white' : 'bg-white'}`}>Class 11th</button>
          <button onClick={() => setSelectedGrade(12)} className={`px-4 py-2 rounded ${selectedGrade===12 ? 'bg-purple-600 text-white' : 'bg-white'}`}>Class 12th</button>
        </div>

        <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
          {chapters.map(ch => {
            const prog = chapterProgress[ch.id] || {};
            const status = computeChapterStatus(ch, prog);
            const colorClass = status.key === 'delayed' ? 'bg-red-50 border-red-400' : (status.key === 'partial' || status.key === 'partial-topics') ? 'bg-orange-50 border-orange-400' : (['ontrack','ahead','completed'].includes(status.key) ? 'bg-green-50 border-green-400' : 'bg-white border-gray-200');
            const completedTopics = prog.completedTopics || [];
            const isFlipped = !!flipState[ch.id];

            return (
              <div key={ch.id} className={`flip-card ${isFlipped ? 'flip' : ''} ${colorClass} border-2 rounded-xl shadow p-4`} >
                <div className="flip-card-inner relative">
                  {/* FRONT */}
                  <div className="flip-card-front p-3">
                    <div className="flex justify-between items-start">
                      <div>
                        <h3 className="text-lg font-semibold">{ch.name}</h3>
                        <div className="text-sm text-gray-600 mt-1">Topics: <span className="font-semibold">{completedTopics.length}/{(ch.topics||[]).length}</span></div>
                        <div className="text-sm text-gray-600">Target: <span className="font-semibold">{ch.targetDate || '‚Äî'}</span></div>
                      </div>
                      <div className="text-sm text-gray-600">{status.label}</div>
                    </div>

                    <hr className="my-3" />

                    <div className="space-y-3">
                      <div>
                        <label className="block text-sm font-medium text-gray-700">Chapter Test Conducted?</label>
                        <select value={prog.testConducted || 'No'} onChange={e => updateChapterProgress(ch.id, 'testConducted', e.target.value)} className="w-full border px-3 py-2 rounded mt-1">
                          <option>No</option><option>Yes</option>
                        </select>
                      </div>

                      <div>
                        <label className="block text-sm font-medium text-gray-700">Chapter Completed?</label>
                        <select value={prog.completed || 'No'} onChange={e => {
                          const val = e.target.value;
                          if (val === 'No') {
                            updateChapterProgress(ch.id, 'completed', 'No');
                            updateChapterProgress(ch.id, 'completionDate', null);
                          } else {
                            updateChapterProgress(ch.id, 'completed', 'Yes');
                            const todayStr = new Date().toISOString().split('T')[0];
                            updateChapterProgress(ch.id, 'completionDate', todayStr);
                            // show confetti only after verifying test conducted (handled by compute and listener)
                            const cur = chapterProgress[ch.id] || {};
                            if (cur.testConducted === 'Yes') { setShowConfetti(true); setTimeout(()=>setShowConfetti(false), 3500); }
                          }
                        }} className="w-full border px-3 py-2 rounded mt-1">
                          <option>No</option><option>Yes</option>
                        </select>
                        <div className="text-xs text-gray-500 mt-1">Note: If test is not conducted, marking Completed will show as <span className="font-semibold">Partially completed</span>.</div>
                      </div>

                      <div>
                        <label className="block text-sm font-medium text-gray-700">Method</label>
                        <select value={prog.method || 'Online'} onChange={e => updateChapterProgress(ch.id, 'method', e.target.value)} className="w-full border px-3 py-2 rounded mt-1">
                          <option>Online</option><option>Offline</option>
                        </select>
                      </div>

                      { (chapterProgress[ch.id] && chapterProgress[ch.id].method === 'Offline') && (
                        <div>
                          <label className="block text-sm font-medium text-gray-700">Notes (Why offline?)</label>
                          <textarea value={chapterProgress[ch.id].notes || ''} onChange={e => updateChapterProgress(ch.id, 'notes', e.target.value)} className="w-full border px-3 py-2 rounded mt-1" rows="2" placeholder="Reason for offline teaching..." />
                        </div>
                      )}

                      {/* Expand/minimize topics manual */}
                      <div>
                        <div className="flex justify-between items-center">
                          <div className="font-semibold text-sm text-purple-700">Topics ({completedTopics.length}/{(ch.topics||[]).length})</div>
                          <div className="flex gap-2">
                            <button onClick={() => toggleExpand(ch.id)} className="text-sm text-gray-600 underline">{expandedChapters[ch.id] ? 'Minimize' : 'Expand'}</button>
                            <button onClick={() => toggleFlip(ch.id)} className="text-sm text-gray-600 underline">Flip</button>
                          </div>
                        </div>

                        { expandedChapters[ch.id] && (
                          <div className="mt-2 space-y-2 max-h-48 overflow-y-auto">
                            { (ch.topics || []).map((t, idx) => {
                              const checked = (chapterProgress[ch.id] && (chapterProgress[ch.id].completedTopics || []).includes(t));
                              return (
                                <label key={idx} className="flex items-center gap-2 p-2 rounded hover:bg-purple-50 cursor-pointer">
                                  <input type="checkbox" checked={checked} onChange={e => {
                                    const prev = (chapterProgress[ch.id] && chapterProgress[ch.id].completedTopics) || [];
                                    const updated = e.target.checked ? [...prev, t] : prev.filter(x=>x!==t);
                                    updateChapterProgress(ch.id, 'completedTopics', updated);
                                    // DO NOT auto-collapse
                                  }} className="w-4 h-4" />
                                  <span className={checked ? 'line-through text-gray-500' : ''}>{t}</span>
                                </label>
                              );
                            })}
                          </div>
                        )}
                      </div>
                    </div>
                  </div>

                  {/* BACK of card - allow teacher notes / quick stats */}
                  <div className="flip-card-back p-3 bg-white rounded">
                    <div className="flex justify-between items-start">
                      <div>
                        <h3 className="text-lg font-semibold">Details ‚Äî {ch.name}</h3>
                        <div className="text-sm text-gray-600 mt-1">Target: <span className="font-semibold">{ch.targetDate}</span></div>
                        <div className="text-sm text-gray-600 mt-2">Topics:</div>
                        <ul className="list-disc ml-5 mt-2 text-sm text-gray-700 max-h-36 overflow-y-auto">
                          { (ch.topics||[]).map((t, i) => <li key={i}>{t}</li>) }
                        </ul>
                      </div>
                      <div>
                        <button onClick={() => toggleFlip(ch.id)} className="px-3 py-1 bg-purple-600 text-white rounded">Back</button>
                      </div>
                    </div>

                    <hr className="my-3" />
                    <div className="text-sm text-gray-700">
                      <div><strong>Completed topics:</strong> {(chapterProgress[ch.id] && (chapterProgress[ch.id].completedTopics||[]).length) || 0} / {(ch.topics||[]).length}</div>
                      <div className="mt-2"><strong>Test Conducted:</strong> {(chapterProgress[ch.id] && chapterProgress[ch.id].testConducted) || 'No'}</div>
                      <div className="mt-2"><strong>Completion Date:</strong> {(chapterProgress[ch.id] && chapterProgress[ch.id].completionDate) || '‚Äî'}</div>
                    </div>
                  </div>
                </div>
              </div>
            );
          })}
        </div>
      </div>
    );
  };

  // Profile
  const Profile = () => (
    <div className="space-y-6">
      <h2 className="text-3xl font-bold">üë§ Profile</h2>
      <div className="bg-white p-6 rounded shadow">
        <div className="grid md:grid-cols-2 gap-4">
          <div><div className="text-sm text-gray-500">Name</div><div className="font-semibold">{currentUser.name}</div></div>
          <div><div className="text-sm text-gray-500">AFID</div><div className="font-semibold">{currentUser.afid}</div></div>
          <div><div className="text-sm text-gray-500">Subject</div><div className="font-semibold">{currentUser.subject}</div></div>
          <div><div className="text-sm text-gray-500">School</div><div className="font-semibold">{currentUser.school}</div></div>
          <div><div className="text-sm text-gray-500">DOB</div><div className="font-semibold">{currentUser.dob ? new Date(currentUser.dob).toLocaleDateString() : '‚Äî'}</div></div>
          <div><div className="text-sm text-gray-500">Email</div><div className="font-semibold">{currentUser.email || '‚Äî'}</div></div>
        </div>
      </div>
    </div>
  );

  // Admin - Teachers management
  function AdminTeachers() {
    const [editing, setEditing] = useState(null);
    const [form, setForm] = useState({ afid:'', name:'', subject:'', school:'', dob:'', email:'', phone:'', password:'' });

    useEffect(() => setForm(editing || { afid:'', name:'', subject:'', school:'', dob:'', email:'', phone:'', password:'' }), [editing]);

    const save = async () => {
      if (!form.afid) return alert('AFID required');
      await addOrUpdateTeacher(form);
      setEditing(null);
    };

    return (
      <div className="space-y-6">
        <div className="flex justify-between items-center">
          <h3 className="text-2xl font-bold">Teacher Directory</h3>
          <button onClick={() => setEditing({})} className="px-4 py-2 bg-blue-600 text-white rounded">+ Add Teacher</button>
        </div>

        <div className="bg-white p-4 rounded shadow overflow-x-auto">
          <table className="w-full">
            <thead><tr className="bg-gray-50"><th className="p-2">AFID</th><th className="p-2">Name</th><th className="p-2">Subject</th><th className="p-2">School</th><th className="p-2">Phone</th><th className="p-2">Actions</th></tr></thead>
            <tbody>
              {teachers.map(t => (
                <tr key={t.afid} className="border-b hover:bg-gray-50">
                  <td className="p-2 font-mono">{t.afid}</td>
                  <td className="p-2">{t.name}</td>
                  <td className="p-2">{t.subject}</td>
                  <td className="p-2">{t.school}</td>
                  <td className="p-2">{t.phone}</td>
                  <td className="p-2">
                    <div className="flex gap-2">
                      <button onClick={() => setEditing(t)} className="px-2 py-1 bg-yellow-400 rounded">Edit</button>
                      <button onClick={() => deleteTeacher(t.afid)} className="px-2 py-1 bg-red-500 text-white rounded">Delete</button>
                    </div>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>

        { editing !== null && (
          <div className="bg-white p-4 rounded shadow">
            <h4 className="font-semibold mb-3">{editing.afid ? 'Edit Teacher' : 'Add Teacher'}</h4>
            <div className="grid md:grid-cols-2 gap-3">
              {['afid','name','subject','school','dob','email','phone','password'].map(k => (
                <div key={k}><label className="text-sm text-gray-600">{k.toUpperCase()}</label><input value={form[k] || ''} onChange={e => setForm({...form, [k]: e.target.value})} className="w-full border px-2 py-2 rounded" /></div>
              ))}
            </div>
            <div className="mt-3 flex gap-2">
              <button onClick={save} className="px-4 py-2 bg-green-600 text-white rounded">Save</button>
              <button onClick={() => setEditing(null)} className="px-4 py-2 bg-gray-200 rounded">Cancel</button>
            </div>
          </div>
        )}
      </div>
    );
  }

  // Admin - Curriculum
  function AdminCurriculum() {
    const [subject, setSubject] = useState(Object.keys(curriculum || {})[0] || 'Physics');
    const [grade, setGrade] = useState(11);
    const [newChapter, setNewChapter] = useState({ name:'', topics:'', targetDate:'' });

    useEffect(() => { if (!subject) setSubject(Object.keys(curriculum||{})[0]||'Physics'); }, [curriculum]);

    const addNew = async () => {
      if (!newChapter.name) return alert('Name required');
      await addChapterAdmin(subject, grade, { name: newChapter.name, topics: newChapter.topics ? newChapter.topics.split(',').map(x=>x.trim()) : [], targetDate: newChapter.targetDate || '' });
      setNewChapter({ name:'', topics:'', targetDate:'' });
    };

    return (
      <div className="space-y-6">
        <div className="flex items-center gap-3">
          <h3 className="text-2xl font-bold">Curriculum</h3>
          <select value={subject} onChange={e=>setSubject(e.target.value)} className="border px-2 py-1 rounded">
            {Object.keys(curriculum || {}).map(s => <option key={s} value={s}>{s}</option>)}
          </select>
          <select value={grade} onChange={e=>setGrade(Number(e.target.value))} className="border px-2 py-1 rounded">
            <option value={11}>Class 11</option><option value={12}>Class 12</option>
          </select>
        </div>

        <div className="bg-white p-4 rounded shadow">
          <h4 className="font-semibold mb-2">Add New Chapter</h4>
          <div className="grid md:grid-cols-3 gap-2">
            <input placeholder="Chapter name" value={newChapter.name} onChange={e => setNewChapter({...newChapter, name: e.target.value})} className="border px-2 py-2 rounded" />
            <input placeholder="Topics (comma separated)" value={newChapter.topics} onChange={e=>setNewChapter({...newChapter, topics: e.target.value})} className="border px-2 py-2 rounded" />
            <input type="date" value={newChapter.targetDate} onChange={e=>setNewChapter({...newChapter, targetDate: e.target.value})} className="border px-2 py-2 rounded" />
          </div>
          <div className="mt-3"><button onClick={addNew} className="px-4 py-2 bg-blue-600 text-white rounded">Add Chapter</button></div>
        </div>

        <div className="space-y-3">
          { (curriculum[subject] && (curriculum[subject][grade] || []).map(ch => {
            const prog = chapterProgress[ch.id] || {};
            const status = computeChapterStatus(ch, prog);
            return (
              <div key={ch.id} className={`p-3 rounded border ${status.key==='delayed' ? 'border-red-300' : status.key.includes('partial') ? 'border-orange-300' : 'border-gray-200'} bg-white flex justify-between items-center`}>
                <div>
                  <div className="font-semibold">{ch.name} <span className="text-xs text-gray-500">({ch.id})</span></div>
                  <div className="text-sm text-gray-600">{(ch.topics||[]).join(', ')}</div>
                  <div className="text-sm mt-1">Target: {ch.targetDate || '‚Äî'}</div>
                </div>
                <div className="flex flex-col items-end gap-2">
                  <div className="text-sm">{status.label}</div>
                  <div className="flex gap-2">
                    <button onClick={() => { const n = prompt('Edit name', ch.name); if (n !== null) updateChapterAdmin(subject, grade, ch.id, { name: n }); }} className="px-2 py-1 bg-yellow-300 rounded">Edit</button>
                    <button onClick={() => { const t = prompt('Set target (YYYY-MM-DD)', ch.targetDate || ''); if (t !== null) updateChapterAdmin(subject, grade, ch.id, { targetDate: t }); }} className="px-2 py-1 bg-blue-300 rounded">Set Target</button>
                    <button onClick={() => { const ts = prompt('Edit topics (comma separated)', (ch.topics||[]).join(', ')); if (ts !== null) updateChapterAdmin(subject, grade, ch.id, { topics: ts.split(',').map(x=>x.trim()) }); }} className="px-2 py-1 bg-green-300 rounded">Edit Topics</button>
                    <button onClick={() => deleteChapterAdmin(subject, grade, ch.id)} className="px-2 py-1 bg-red-500 text-white rounded">Delete</button>
                  </div>
                </div>
              </div>
            );
          })) || <div className="text-gray-500">No chapters for this selection</div> }
        </div>
      </div>
    );
  }

  // Admin Analytics
  function AdminAnalytics() {
    const data = analyticsData;
    return (
      <div className="space-y-6">
        <div className="flex justify-between items-center">
          <h3 className="text-2xl font-bold">Analytics</h3>
          <div className="flex gap-2">
            <button onClick={exportCSV} className="px-3 py-2 bg-green-600 text-white rounded">Export CSV</button>
            <button onClick={() => alert('Analytics refreshes automatically')} className="px-3 py-2 bg-gray-200 rounded">Refresh</button>
          </div>
        </div>

        <div className="grid md:grid-cols-3 gap-6">
          <div className="bg-white p-4 rounded shadow text-center">
            <div className="text-sm text-gray-500">Total Chapters</div>
            <div className="text-3xl font-bold mt-2">{data ? data.totalChapters : '‚Äî'}</div>
            <div className="text-sm text-gray-500 mt-1">Completed: {data ? data.totalCompleted : '‚Äî'}</div>
          </div>

          <div className="bg-white p-4 rounded shadow text-center">
            <div className="text-sm text-gray-500">Syllabus Completion</div>
            { data ? <canvas ref={pieRef} width="220" height="160"></canvas> : <div className="text-gray-500 mt-6">No data</div> }
          </div>

          <div className="bg-white p-4 rounded shadow">
            <div className="text-sm text-gray-500">Top Teachers</div>
            <div className="mt-3 space-y-2">
              { data && data.teacherArr.length ? data.teacherArr.slice(0,6).map(t => (
                <div key={t.afid} className="flex justify-between">
                  <div><div className="font-medium">{t.name} <span className="text-xs text-gray-500">({t.afid})</span></div><div className="text-xs text-gray-500">{t.school}</div></div>
                  <div className="text-sm font-bold">{t.percent}%</div>
                </div>
              )) : <div className="text-gray-500">No data</div> }
            </div>
          </div>
        </div>

        <div className="bg-white p-4 rounded shadow">
          <div className="text-sm text-gray-500 mb-2">Teacher Completion % (Top 8)</div>
          { data ? <canvas ref={barRef} width="800" height="300"></canvas> : <div className="h-40 flex items-center justify-center text-gray-500">No data</div> }
        </div>

        <div className="bg-white p-4 rounded shadow">
          <div className="text-sm text-gray-500 mb-2">Schools - On Track vs Delayed</div>
          { data ? <canvas ref={schoolRef} width="800" height="240"></canvas> : <div className="h-40 flex items-center justify-center text-gray-500">No data</div> }
        </div>

        <div className="bg-white p-4 rounded shadow">
          <div className="text-sm text-gray-500 mb-2">Detailed Teacher Table</div>
          <div className="overflow-x-auto">
            <table className="w-full">
              <thead className="bg-gray-50"><tr><th className="p-2">AFID</th><th className="p-2">Name</th><th className="p-2">School</th><th className="p-2">Completed</th><th className="p-2">Total</th><th className="p-2">Percent</th></tr></thead>
              <tbody>{ data && data.teacherArr.length ? data.teacherArr.map(t => (<tr key={t.afid} className="border-b hover:bg-gray-50"><td className="p-2 font-mono">{t.afid}</td><td className="p-2">{t.name}</td><td className="p-2">{t.school}</td><td className="p-2">{t.completed}</td><td className="p-2">{t.total}</td><td className="p-2">{t.percent}%</td></tr>)) : <tr><td colSpan="6" className="p-4 text-gray-500">No data</td></tr> }</tbody>
            </table>
          </div>
        </div>
      </div>
    );
  }

  // Admin Dashboard
  function AdminDashboard() {
    const [tab, setTab] = useState('overview');
    return (
      <div className="space-y-6">
        <h2 className="text-3xl font-bold">üìà Admin Dashboard</h2>
        <div className="flex gap-2 mb-4">
          {['overview','teachers','curriculum','analytics','settings'].map(t => <button key={t} onClick={()=>setTab(t)} className={`px-3 py-2 rounded ${tab===t ? 'bg-purple-600 text-white' : 'bg-white'}`}>{t.charAt(0).toUpperCase() + t.slice(1)}</button>)}
        </div>

        { tab === 'overview' && (
          <div className="grid md:grid-cols-3 gap-6">
            <div className="bg-white p-4 rounded shadow text-center">
              <div className="text-sm text-gray-500">Total Teachers</div>
              <div className="text-2xl font-bold mt-2">{teachers.length}</div>
            </div>
            <div className="bg-white p-4 rounded shadow text-center">
              <div className="text-sm text-gray-500">Total Schools</div>
              <div className="text-2xl font-bold mt-2">{[...new Set(teachers.map(t=>t.school))].length}</div>
            </div>
            <div className="bg-white p-4 rounded shadow text-center">
              <div className="text-sm text-gray-500">Chapters Tracked</div>
              <div className="text-2xl font-bold mt-2">{Object.keys(chapterProgress || {}).length}</div>
            </div>
          </div>
        )}

        { tab === 'teachers' && <AdminTeachers /> }
        { tab === 'curriculum' && <AdminCurriculum /> }
        { tab === 'analytics' && <AdminAnalytics /> }
        { tab === 'settings' && <div className="bg-white p-4 rounded shadow">Admin settings will be here</div> }
      </div>
    );
  }

  // ----- main render layout -----
  return (
    <div className="min-h-screen bg-gradient-to-br from-purple-50 via-pink-50 to-red-50">
      <nav className="bg-white shadow sticky top-0 z-40">
        <div className="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
          <div className="flex items-center gap-3">
            <div className="text-2xl">üìö</div>
            <div>
              <div className="font-bold text-lg">Curriculum Tracker</div>
              <div className="text-sm text-gray-500">{isAdmin ? 'Administrator' : `${currentUser.name} - ${currentUser.school}`}</div>
            </div>
          </div>
          <div className="flex items-center gap-3">
            <button onClick={() => { setCurrentUser(null); setIsAdmin(false); setActiveTab('overview'); }} className="px-3 py-2 bg-red-500 text-white rounded">Logout</button>
          </div>
        </div>
      </nav>

      {/* Birthday banner top-right */}
      { todaysBirthdays.length > 0 && (
        <div className="fixed top-6 right-6 z-50">
          <div className="bg-white border p-3 rounded shadow flex items-center gap-3">
            <div className="text-2xl">üéÇ</div>
            <div>
              <div className="font-semibold">Happy Birthday!</div>
              <div className="text-sm text-gray-600">{todaysBirthdays.map(t => t.name).join(', ')}</div>
            </div>
          </div>
        </div>
      )}

      <div className="max-w-7xl mx-auto px-4 py-6">
        <div className="mb-6">
          { !isAdmin && (
            <div className="flex gap-2">
              <button onClick={() => setActiveTab('overview')} className={`px-4 py-2 rounded ${activeTab==='overview' ? 'bg-gradient-to-r from-purple-600 to-pink-600 text-white' : 'bg-white'}`}>üè† Overview</button>
              <button onClick={() => setActiveTab('chapters')} className={`px-4 py-2 rounded ${activeTab==='chapters' ? 'bg-gradient-to-r from-purple-600 to-pink-600 text-white' : 'bg-white'}`}>üìñ Chapters</button>
              <button onClick={() => setActiveTab('profile')} className={`px-4 py-2 rounded ${activeTab==='profile' ? 'bg-gradient-to-r from-purple-600 to-pink-600 text-white' : 'bg-white'}`}>üë§ Profile</button>
            </div>
          )}

          { isAdmin && (
            <div className="flex gap-2">
              <button onClick={() => setActiveTab('admin')} className="px-4 py-2 rounded bg-white">Admin Dashboard</button>
            </div>
          )}
        </div>

        <div>
          { isAdmin && <AdminDashboard /> }
          { !isAdmin && activeTab === 'overview' && <Overview /> }
          { !isAdmin && activeTab === 'chapters' && <Chapters /> }
          { !isAdmin && activeTab === 'profile' && <Profile /> }
        </div>
      </div>

      <footer className="bg-white mt-12 py-6">
        <div className="max-w-7xl mx-auto px-4 text-center text-gray-600">¬© 2025 Curriculum Tracker</div>
      </footer>

      { showConfetti && <Confetti /> }
    </div>
  );
}

ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
