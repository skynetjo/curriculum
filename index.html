<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Curriculum Tracker</title>
    
    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <!-- React Scripts -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Recharts for Analytics -->
    <script src="https://unpkg.com/recharts@2.5.0/dist/Recharts.js"></script>
    
    <style>
        @keyframes fall { to { transform: translateY(100vh); opacity: 0; } }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-20px); } }
        * { margin: 0; padding: 0; box-sizing: border-box; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        window.addEventListener('load', function() {
            if (typeof firebase === 'undefined') {
                document.getElementById('root').innerHTML = `
                    <div style="display: flex; justify-content: center; align-items: center; height: 100vh; background: linear-gradient(to bottom right, #9333ea, #ec4899); font-family: sans-serif;">
                        <div style="background: white; padding: 2rem; border-radius: 1rem; text-align: center; max-width: 400px;">
                            <div style="font-size: 4rem; margin-bottom: 1rem;">⚠️</div>
                            <h2 style="font-size: 1.5rem; font-weight: bold; color: #1f2937; margin-bottom: 1rem;">Firebase Loading Error</h2>
                            <p style="color: #6b7280; margin-bottom: 1rem;">Unable to load Firebase. Please refresh the page.</p>
                            <button onclick="location.reload()" style="background: #9333ea; color: white; padding: 0.5rem 1.5rem; border-radius: 0.5rem; border: none; cursor: pointer; font-weight: 600;">Reload Page</button>
                        </div>
                    </div>
                `;
                return;
            }

            // ============================================
            // REPLACE WITH YOUR FIREBASE CONFIG
            // ============================================
            const firebaseConfig = {
                apiKey: "YOUR_API_KEY",
                authDomain: "YOUR_PROJECT.firebaseapp.com",
                projectId: "YOUR_PROJECT_ID",
                storageBucket: "YOUR_PROJECT.appspot.com",
                messagingSenderId: "YOUR_SENDER_ID",
                appId: "YOUR_APP_ID"
            };

            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
            const db = firebase.firestore();

            startApp(db);
        });

        function startApp(db) {
            const { useState, useEffect } = React;

            // Initial Data
            const INITIAL_TEACHERS = [
                { afid: 'AF248', name: 'Vivek Bansal', subject: 'Physics', school: 'CoE Barwani', dob: '1990-03-15', email: 'vivek@example.com', phone: '9876543210', password: 'pass123' },
                { afid: 'AF464', name: 'Sandeep Dixit', subject: 'Chemistry', school: 'CoE Barwani', dob: '1988-07-22', email: 'sandeep@example.com', phone: '9876543211', password: 'pass123' },
                { afid: 'AF853', name: 'Dayanand Kumar', subject: 'Maths', school: 'CoE Barwani', dob: '1992-11-08', email: 'dayanand@example.com', phone: '9876543212', password: 'pass123' },
                { afid: 'AF709', name: 'Arpith Singh', subject: 'Maths', school: 'CoE Cuttak', dob: '1991-05-19', email: 'arpith@example.com', phone: '9876543213', password: 'pass123' },
                { afid: 'AF832', name: 'Shubham Patil', subject: 'Chemistry', school: 'CoE Cuttak', dob: '1989-09-30', email: 'shubham@example.com', phone: '9876543214', password: 'pass123' },
                { afid: 'AF459', name: 'Ekanta Sahu', subject: 'Physics', school: 'CoE Cuttak', dob: '1993-12-25', email: 'ekanta@example.com', phone: '9876543215', password: 'pass123' },
                { afid: 'AF790', name: 'Anubhav Sundaria', subject: 'Maths', school: 'CoE Bundi', dob: '1990-02-14', email: 'anubhav@example.com', phone: '9876543216', password: 'pass123' },
                { afid: 'AF789', name: 'Md. Saif Farooqui', subject: 'Chemistry', school: 'CoE Bundi', dob: '1991-08-07', email: 'saif@example.com', phone: '9876543217', password: 'pass123' },
                { afid: 'AF788', name: 'Ajay Kumar', subject: 'Physics', school: 'CoE Bundi', dob: '1988-10-20', email: 'ajay@example.com', phone: '9876543218', password: 'pass123' },
                { afid: 'AF529', name: 'Shivam Gupta', subject: 'Physics', school: 'EMRS Bhopal', dob: '1992-01-11', email: 'shivam@example.com', phone: '9876543219', password: 'pass123' },
                { afid: 'AF840', name: 'Darshil Jain', subject: 'Chemistry', school: 'EMRS Bhopal', dob: '1990-06-28', email: 'darshil@example.com', phone: '9876543220', password: 'pass123' },
                { afid: 'AF834', name: 'Sunil Parmar', subject: 'Maths', school: 'EMRS Bhopal', dob: '1989-04-17', email: 'sunil@example.com', phone: '9876543221', password: 'pass123' },
                { afid: 'AF843', name: 'Yogesh Kumar', subject: 'Physics', school: 'CoE Mahisagar', dob: '1991-10-03', email: 'yogesh@example.com', phone: '9876543222', password: 'pass123' },
                { afid: 'AF635', name: 'Archana', subject: 'Chemistry', school: 'CoE Mahisagar', dob: '1993-10-15', email: 'archana@example.com', phone: '9876543223', password: 'pass123' },
                { afid: 'AF842', name: 'Monu Kumar', subject: 'Maths', school: 'CoE Mahisagar', dob: '1990-12-09', email: 'monu@example.com', phone: '9876543224', password: 'pass123' },
                { afid: 'AF804', name: 'Nidhi', subject: 'Physics', school: 'JNV Bharuch', dob: '1992-03-21', email: 'nidhi@example.com', phone: '9876543225', password: 'pass123' },
                { afid: 'AF800', name: 'Madan Singh', subject: 'Chemistry', school: 'JNV Bharuch', dob: '1988-08-14', email: 'madan@example.com', phone: '9876543226', password: 'pass123' },
                { afid: 'AF786', name: 'Jyoti', subject: 'Maths', school: 'JNV Bharuch', dob: '1991-11-26', email: 'jyoti@example.com', phone: '9876543227', password: 'pass123' },
                { afid: 'AF723', name: 'Ranjesh', subject: 'Biology', school: 'JNV Bharuch', dob: '1990-05-05', email: 'ranjesh@example.com', phone: '9876543228', password: 'pass123' }
            ];

            function App() {
                const [currentUser, setCurrentUser] = useState(null);
                const [isAdmin, setIsAdmin] = useState(false);
                const [activeTab, setActiveTab] = useState('overview');
                const [loginForm, setLoginForm] = useState({ afid: '', password: '' });
                const [showConfetti, setShowConfetti] = useState(false);
                const [confettiMessage, setConfettiMessage] = useState('');
                const [chapterProgress, setChapterProgress] = useState({});
                const [teachers, setTeachers] = useState([]);
                const [curriculum, setCurriculum] = useState({});
                const [loading, setLoading] = useState(false);
                const [birthdaysThisWeek, setBirthdaysThisWeek] = useState([]);
                const [birthdaysThisMonth, setBirthdaysThisMonth] = useState([]);

                useEffect(() => {
                    const initDB = async () => {
                        try {
                            const initDoc = await db.collection('system').doc('initialized').get();
                            if (!initDoc.exists) {
                                for (const teacher of INITIAL_TEACHERS) {
                                    await db.collection('teachers').doc(teacher.afid).set(teacher);
                                }
                                await db.collection('system').doc('initialized').set({ date: new Date().toISOString() });
                            }
                        } catch (error) {
                            console.error('Init error:', error);
                        }
                    };

                    const loadTeachers = () => {
                        db.collection('teachers').onSnapshot((snapshot) => {
                            const teachersList = snapshot.docs.map(doc => ({ ...doc.data() }));
                            setTeachers(teachersList);
                            checkUpcomingBirthdays(teachersList);
                        });
                    };

                    const loadCurriculum = () => {
                        db.collection('curriculum').onSnapshot((snapshot) => {
                            const curriculumData = {};
                            snapshot.docs.forEach(doc => {
                                curriculumData[doc.id] = doc.data();
                            });
                            setCurriculum(curriculumData);
                        });
                    };

                    const loadProgress = () => {
                        db.collection('chapterProgress').onSnapshot((snapshot) => {
                            const progress = {};
                            snapshot.docs.forEach(doc => {
                                progress[doc.id] = doc.data();
                            });
                            setChapterProgress(progress);
                        });
                    };

                    initDB();
                    loadTeachers();
                    loadCurriculum();
                    loadProgress();
                }, []);

                useEffect(() => {
                    if (showConfetti) {
                        setTimeout(() => setShowConfetti(false), 4000);
                    }
                }, [showConfetti]);

                const checkUpcomingBirthdays = (teachersList) => {
                    const today = new Date();
                    const thisWeek = [];
                    const thisMonth = [];

                    teachersList.forEach(teacher => {
                        const dob = new Date(teacher.dob);
                        const thisYearBirthday = new Date(today.getFullYear(), dob.getMonth(), dob.getDate());
                        const daysUntil = Math.ceil((thisYearBirthday - today) / (1000 * 60 * 60 * 24));

                        if (daysUntil >= 0 && daysUntil <= 7) {
                            thisWeek.push({ ...teacher, daysUntil });
                        }
                        if (today.getMonth() === dob.getMonth()) {
                            thisMonth.push(teacher);
                        }
                    });

                    setBirthdaysThisWeek(thisWeek);
                    setBirthdaysThisMonth(thisMonth);
                };

                const handleLogin = async () => {
                    setLoading(true);
                    setTimeout(async () => {
                        if (loginForm.afid === 'ADMIN' && loginForm.password === 'admin123') {
                            setIsAdmin(true);
                            setCurrentUser({ name: 'Administrator', afid: 'ADMIN' });
                            setActiveTab('teachers');
                        } else {
                            const teacher = teachers.find(t => t.afid === loginForm.afid && t.password === loginForm.password);
                            if (teacher) {
                                setCurrentUser(teacher);
                                setIsAdmin(false);
                                setActiveTab('overview');
                                checkBirthday(teacher);
                            } else {
                                alert('Invalid AFID or Password');
                            }
                        }
                        setLoading(false);
                    }, 500);
                };

                const checkBirthday = (teacher) => {
                    const today = new Date();
                    const dob = new Date(teacher.dob);
                    if (today.getMonth() === dob.getMonth() && today.getDate() === dob.getDate()) {
                        setConfettiMessage(`Happy Birthday ${teacher.name}! 🎂`);
                        setShowConfetti(true);
                    }
                };

                const updateChapterProgress = async (chapterId, field, value) => {
                    try {
                        const currentProgress = chapterProgress[chapterId] || {};
                        const updatedProgress = {
                            ...currentProgress,
                            [field]: value,
                            lastUpdated: new Date().toISOString(),
                            updatedBy: currentUser.afid
                        };
                        await db.collection('chapterProgress').doc(chapterId).set(updatedProgress, { merge: true });
                        
                        if (field === 'completed' && value === 'Yes') {
                            setConfettiMessage('Chapter Completed! Great Work! 🎉');
                            setShowConfetti(true);
                        }
                    } catch (error) {
                        console.error('Update error:', error);
                        alert('Failed to save. Check your internet connection.');
                    }
                };

                const getChapterStatus = (chapter, progress) => {
                    const today = new Date();
                    const targetDate = new Date(chapter.targetDate);
                    const completionDate = progress.completionDate ? new Date(progress.completionDate) : null;

                    if (progress.completed === 'Yes') {
                        if (completionDate && completionDate <= targetDate) {
                            return { status: 'ahead', label: 'Ahead - Good Job!', color: 'bg-green-50 border-green-500' };
                        }
                        return { status: 'completed', label: 'On Track', color: 'bg-green-50 border-green-500' };
                    }

                    if (today > targetDate) {
                        return { status: 'delayed', label: 'Delayed', color: 'bg-red-50 border-red-500' };
                    }

                    return { status: 'pending', label: 'In Progress', color: 'bg-white border-gray-300' };
                };

                const getSubjectCompletion = (subject, grade) => {
                    const chapters = curriculum[subject]?.[grade] || [];
                    const completed = chapters.filter(ch => chapterProgress[ch.id]?.completed === 'Yes').length;
                    return { 
                        total: chapters.length, 
                        completed, 
                        percentage: chapters.length ? Math.round((completed / chapters.length) * 100) : 0 
                    };
                };

                const handleLogout = () => {
                    setCurrentUser(null);
                    setIsAdmin(false);
                    setActiveTab('overview');
                    setLoginForm({ afid: '', password: '' });
                };

                if (!currentUser) {
                    return (
                        <div className="min-h-screen bg-gradient-to-br from-purple-600 via-pink-500 to-red-500 flex items-center justify-center p-4">
                            <div className="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
                                <div className="text-center mb-8">
                                    <div className="text-6xl mb-4">📚</div>
                                    <h1 className="text-3xl font-bold text-gray-800">Curriculum Tracker</h1>
                                    <p className="text-gray-600 mt-2">Track Your Teaching Journey</p>
                                </div>
                                <div className="space-y-4">
                                    <input
                                        type="text"
                                        placeholder="Enter AFID"
                                        value={loginForm.afid}
                                        onChange={(e) => setLoginForm({ ...loginForm, afid: e.target.value.toUpperCase() })}
                                        className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none"
                                    />
                                    <input
                                        type="password"
                                        placeholder="Enter Password"
                                        value={loginForm.password}
                                        onChange={(e) => setLoginForm({ ...loginForm, password: e.target.value })}
                                        onKeyPress={(e) => e.key === 'Enter' && handleLogin()}
                                        className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none"
                                    />
                                    <button
                                        onClick={handleLogin}
                                        disabled={loading}
                                        className="w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white py-3 rounded-lg font-semibold hover:shadow-lg transform hover:scale-105 transition disabled:opacity-50"
                                    >
                                        {loading ? 'Logging in...' : 'Login'}
                                    </button>
                                </div>
                            </div>
                        </div>
                    );
                }

                const Confetti = () => (
                    <div className="fixed inset-0 pointer-events-none z-50">
                        {[...Array(100)].map((_, i) => (
                            <div
                                key={i}
                                className="absolute text-3xl"
                                style={{
                                    left: `${Math.random() * 100}%`,
                                    top: `${-20 + Math.random() * 20}%`,
                                    animation: `fall ${3 + Math.random() * 2}s linear forwards`,
                                    animationDelay: `${Math.random() * 2}s`
                                }}
                            >
                                {['🎉', '🎊', '🎈', '✨', '🌟'][Math.floor(Math.random() * 5)]}
                            </div>
                        ))}
                        {confettiMessage && (
                            <div className="fixed top-20 left-1/2 transform -translate-x-1/2 bg-gradient-to-r from-yellow-400 to-orange-500 text-white px-8 py-4 rounded-full shadow-2xl text-xl font-bold animate-bounce">
                                {confettiMessage}
                            </div>
                        )}
                    </div>
                );

                // Admin Components
                const TeachersManagement = () => {
                    const [editingTeacher, setEditingTeacher] = useState(null);
                    const [isAdding, setIsAdding] = useState(false);
                    const [formData, setFormData] = useState({
                        afid: '', name: '', subject: '', school: '', dob: '', email: '', phone: '', password: 'pass123'
                    });

                    const handleSave = async () => {
                        try {
                            await db.collection('teachers').doc(formData.afid).set(formData);
                            setEditingTeacher(null);
                            setIsAdding(false);
                            setFormData({ afid: '', name: '', subject: '', school: '', dob: '', email: '', phone: '', password: 'pass123' });
                            alert('Teacher saved successfully!');
                        } catch (error) {
                            alert('Error saving teacher');
                        }
                    };

                    const handleDelete = async (afid) => {
                        if (confirm('Are you sure you want to delete this teacher?')) {
                            try {
                                await db.collection('teachers').doc(afid).delete();
                                alert('Teacher deleted successfully!');
                            } catch (error) {
                                alert('Error deleting teacher');
                            }
                        }
                    };

                    return (
                        <div className="space-y-6">
                            <div className="flex justify-between items-center">
                                <h2 className="text-3xl font-bold text-gray-800">👥 Manage Teachers</h2>
                                <button
                                    onClick={() => {
                                        setIsAdding(true);
                                        setFormData({ afid: '', name: '', subject: '', school: '', dob: '', email: '', phone: '', password: 'pass123' });
                                    }}
                                    className="bg-green-500 text-white px-6 py-3 rounded-lg font-semibold hover:bg-green-600 transition shadow-lg"
                                >
                                    ➕ Add New Teacher
                                    </button>
                            </div>

                            {(isAdding || editingTeacher) && (
                                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                                    <div className="bg-white rounded-xl p-8 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                                        <h3 className="text-2xl font-bold mb-6">{isAdding ? 'Add New Teacher' : 'Edit Teacher'}</h3>
                                        <div className="grid grid-cols-2 gap-4">
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-1">AFID</label>
                                                <input
                                                    type="text"
                                                    value={formData.afid}
                                                    onChange={(e) => setFormData({ ...formData, afid: e.target.value.toUpperCase() })}
                                                    disabled={!isAdding}
                                                    className="w-full px-3 py-2 border rounded-lg"
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-1">Name</label>
                                                <input
                                                    type="text"
                                                    value={formData.name}
                                                    onChange={(e) => setFormData({ ...formData, name: e.target.value })}
                                                    className="w-full px-3 py-2 border rounded-lg"
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-1">Subject</label>
                                                <select
                                                    value={formData.subject}
                                                    onChange={(e) => setFormData({ ...formData, subject: e.target.value })}
                                                    className="w-full px-3 py-2 border rounded-lg"
                                                >
                                                    <option value="">Select Subject</option>
                                                    <option>Physics</option>
                                                    <option>Chemistry</option>
                                                    <option>Maths</option>
                                                    <option>Biology</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-1">School</label>
                                                <input
                                                    type="text"
                                                    value={formData.school}
                                                    onChange={(e) => setFormData({ ...formData, school: e.target.value })}
                                                    className="w-full px-3 py-2 border rounded-lg"
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-1">Date of Birth</label>
                                                <input
                                                    type="date"
                                                    value={formData.dob}
                                                    onChange={(e) => setFormData({ ...formData, dob: e.target.value })}
                                                    className="w-full px-3 py-2 border rounded-lg"
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-1">Email</label>
                                                <input
                                                    type="email"
                                                    value={formData.email}
                                                    onChange={(e) => setFormData({ ...formData, email: e.target.value })}
                                                    className="w-full px-3 py-2 border rounded-lg"
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-1">Phone</label>
                                                <input
                                                    type="tel"
                                                    value={formData.phone}
                                                    onChange={(e) => setFormData({ ...formData, phone: e.target.value })}
                                                    className="w-full px-3 py-2 border rounded-lg"
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-1">Password</label>
                                                <input
                                                    type="text"
                                                    value={formData.password}
                                                    onChange={(e) => setFormData({ ...formData, password: e.target.value })}
                                                    className="w-full px-3 py-2 border rounded-lg"
                                                />
                                            </div>
                                        </div>
                                        <div className="flex gap-4 mt-6">
                                            <button onClick={handleSave} className="flex-1 bg-green-500 text-white py-3 rounded-lg font-semibold hover:bg-green-600">
                                                Save
                                            </button>
                                            <button 
                                                onClick={() => { setIsAdding(false); setEditingTeacher(null); }}
                                                className="flex-1 bg-gray-500 text-white py-3 rounded-lg font-semibold hover:bg-gray-600"
                                            >
                                                Cancel
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            )}

                            <div className="bg-white rounded-xl shadow-lg p-6">
                                <div className="overflow-x-auto">
                                    <table className="w-full">
                                        <thead>
                                            <tr className="border-b-2 border-gray-200 bg-gray-50">
                                                <th className="text-left p-3 font-semibold">AFID</th>
                                                <th className="text-left p-3 font-semibold">Name</th>
                                                <th className="text-left p-3 font-semibold">Subject</th>
                                                <th className="text-left p-3 font-semibold">School</th>
                                                <th className="text-left p-3 font-semibold">Contact</th>
                                                <th className="text-left p-3 font-semibold">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {teachers.map((teacher) => (
                                                <tr key={teacher.afid} className="border-b hover:bg-gray-50">
                                                    <td className="p-3">{teacher.afid}</td>
                                                    <td className="p-3 font-medium">{teacher.name}</td>
                                                    <td className="p-3">{teacher.subject}</td>
                                                    <td className="p-3">{teacher.school}</td>
                                                    <td className="p-3 text-sm">{teacher.phone}</td>
                                                    <td className="p-3">
                                                        <div className="flex gap-2">
                                                            <button
                                                                onClick={() => {
                                                                    setEditingTeacher(teacher.afid);
                                                                    setFormData(teacher);
                                                                }}
                                                                className="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600"
                                                            >
                                                                Edit
                                                            </button>
                                                            <button
                                                                onClick={() => handleDelete(teacher.afid)}
                                                                className="bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600"
                                                            >
                                                                Delete
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    );
                };

                const CurriculumManagement = () => {
                    const [selectedSubject, setSelectedSubject] = useState('Physics');
                    const [selectedGrade, setSelectedGrade] = useState(11);
                    const [
