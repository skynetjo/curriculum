<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Curriculum Tracker - Avanti Fellows</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <style>
    :root {
      --avanti-yellow: #F4B41A;
      --avanti-orange: #E8B039;
      --avanti-red: #C8342E;
    }
    .avanti-gradient { background: linear-gradient(135deg, var(--avanti-yellow) 0%, var(--avanti-orange) 50%, var(--avanti-red) 100%); }
    .avanti-gradient-light { background: linear-gradient(135deg, rgba(244, 180, 26, 0.1) 0%, rgba(232, 176, 57, 0.1) 50%, rgba(200, 52, 46, 0.1) 100%); }
    .chapter-card { transition: all 0.3s; }
    .chapter-card.collapsed { max-height: 180px; overflow: hidden; }
    .chapter-card.expanded { max-height: none; }
    .chapter-details { max-height: 0; overflow: hidden; transition: max-height 0.4s, opacity 0.3s; opacity: 0; }
    .chapter-details.show { max-height: 2000px; opacity: 1; }
    .expand-btn { transition: transform 0.3s; }
    .expand-btn.rotated { transform: rotate(180deg); }
    input[type="checkbox"] { appearance: none; width: 20px; height: 20px; border: 2px solid var(--avanti-red); border-radius: 4px; cursor: pointer; position: relative; }
    input[type="checkbox"]:checked { background: var(--avanti-red); }
    input[type="checkbox"]:checked::after { content: '✓'; position: absolute; color: white; font-size: 14px; top: 50%; left: 50%; transform: translate(-50%, -50%); }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
const { useState, useEffect, useRef, useCallback, useMemo } = React;

const firebaseConfig = {
  apiKey: "AIzaSyDyyGAHNJvhuint86USW36eBJKfw_u3AcA",
  authDomain: "curriculum-dbb10.firebaseapp.com",
  projectId: "curriculum-dbb10",
  storageBucket: "curriculum-dbb10.firebasestorage.app",
  messagingSenderId: "706387632109",
  appId: "1:706387632109:web:06c78a304fdbdc12f391e4"
};

if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

const SUBJECTS = ['Physics', 'Chemistry', 'Maths', 'Biology'];
const DEFAULT_SCHOOLS = ['CoE Barwani', 'CoE Cuttak', 'CoE Bundi', 'CoE Mahisagar', 'EMRS Bhopal', 'JNV Bharuch'];
const LOGO = 'https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/svg/1f393.svg';

function App() {
  const [currentUser, setCurrentUser] = useState(null);
  const [isAdmin, setIsAdmin] = useState(false);
  const [activeTab, setActiveTab] = useState('overview');
  const [loginForm, setLoginForm] = useState({ email: '', password: '' });
  const [loading, setLoading] = useState(true);
  const [authLoading, setAuthLoading] = useState(false);
  const [teachers, setTeachers] = useState([]);
  const [curriculum, setCurriculum] = useState({});
  const [chapterProgress, setChapterProgress] = useState({});
  const [analyticsData, setAnalyticsData] = useState(null);
  const [schools, setSchools] = useState(DEFAULT_SCHOOLS);
  const [expandedChapters, setExpandedChapters] = useState({});
  const chartRefs = useRef({});
  const charts = useRef({});
  const updateTimeouts = useRef({});

  useEffect(() => {
    const loadSchools = async () => {
      try {
        const doc = await db.collection('meta').doc('schools').get();
        if (doc.exists) setSchools(doc.data().list || DEFAULT_SCHOOLS);
      } catch (e) { console.error(e); }
    };
    loadSchools();
  }, []);

  useEffect(() => {
    const unsubscribe = auth.onAuthStateChanged(async (user) => {
      if (user) {
        if (user.email === 'admin@avantifellows.org') {
          setIsAdmin(true);
          setCurrentUser({ name: 'Administrator', email: user.email, afid: 'ADMIN' });
          setActiveTab('admin');
        } else {
          const snap = await db.collection('teachers').where('email', '==', user.email).limit(1).get();
          if (!snap.empty) {
            setCurrentUser(snap.docs[0].data());
            setIsAdmin(false);
            setActiveTab('overview');
          } else {
            alert('Teacher profile not found. Contact admin.');
            await auth.signOut();
          }
        }
      } else {
        setCurrentUser(null);
        setIsAdmin(false);
      }
      setLoading(false);
    });
    return () => unsubscribe();
  }, []);

  useEffect(() => {
    const unsubP = db.collection('chapterProgress').onSnapshot(snap => {
      const map = {};
      snap.docs.forEach(d => map[d.id] = d.data());
      setChapterProgress(map);
    });
    const unsubT = db.collection('teachers').onSnapshot(snap => setTeachers(snap.docs.map(d => d.data())));
    const unsubC = db.collection('meta').doc('curriculum').onSnapshot(doc => setCurriculum(doc.exists ? doc.data() : {}));
    return () => { unsubP(); unsubT(); unsubC(); };
  }, []);

  const computeChapterStatus = useCallback((ch = {}, prog = {}) => {
    if (!ch.targetDate) return { label:'No target', key:'no-target', color:'bg-gray-100', textColor:'text-gray-700' };
    const target = new Date(ch.targetDate);
    const today = new Date();
    const compDate = prog.completionDate ? new Date(prog.completionDate) : null;
    const topicsDone = (prog.completedTopics || []).length;
    const topicsTotal = (ch.topics || []).length;

    if (prog.completed === 'Yes' && prog.testConducted === 'Yes') {
      if (compDate && compDate < target) return { label:'Ahead!', key:'ahead', color:'bg-gradient-to-r from-green-400 to-emerald-500', textColor:'text-white' };
      if (compDate && compDate > target) return { label:'Completed (Late)', key:'delayed', color:'bg-orange-100 border-orange-300', textColor:'text-orange-700' };
      return { label:'Completed ✓', key:'completed', color:'bg-green-100 border-green-300', textColor:'text-green-700' };
    }
    if (prog.completed === 'Yes') return { label:'Partial', key:'partial', color:'bg-yellow-100 border-yellow-300', textColor:'text-yellow-700' };
    if (topicsDone > 0 && topicsDone < topicsTotal) {
      if (today > target) return { label:'Delayed (In Progress)', key:'delayed-progress', color:'bg-red-100 border-red-300', textColor:'text-red-700' };
      return { label:`In Progress (${topicsDone}/${topicsTotal})`, key:'in-progress', color:'bg-blue-100 border-blue-300', textColor:'text-blue-700' };
    }
    if (today > target) return { label:'Delayed', key:'delayed', color:'bg-red-100 border-red-300', textColor:'text-red-700' };
    return { label:'Pending', key:'pending', color:'bg-gray-100 border-gray-300', textColor:'text-gray-700' };
  }, []);

  useEffect(() => {
    if (!curriculum) return;
    const schoolStatus = {}, teacherMap = {}, subjectStats = {};
    let totalChapters = 0, totalCompleted = 0, totalPendingTests = 0, totalDaysSpent = 0, chaptersWithDates = 0;

    Object.keys(curriculum).forEach(subject => {
      subjectStats[subject] = { total: 0, completed: 0 };
      Object.keys(curriculum[subject]).forEach(grade => {
        (curriculum[subject][grade] || []).forEach(ch => {
          totalChapters++;
          subjectStats[subject].total++;
          const prog = chapterProgress[ch.id] || {};
          const st = computeChapterStatus(ch, prog);
          
          if (st.key === 'completed' || st.key === 'ahead') {
            totalCompleted++;
            subjectStats[subject].completed++;
            if (prog.completionDate && ch.targetDate) {
              const days = Math.abs(Math.ceil((new Date(prog.completionDate) - new Date(ch.targetDate)) / (1000 * 60 * 60 * 24)));
              totalDaysSpent += days;
              chaptersWithDates++;
            }
          }
          if (prog.completed === 'Yes' && prog.testConducted !== 'Yes') totalPendingTests++;
          
          teachers.forEach(t => {
            if (t.subject === subject) {
              teacherMap[t.afid] = teacherMap[t.afid] || { afid: t.afid, name: t.name, school: t.school, subject: t.subject, completed: 0, total: 0, pendingTests: 0, daysSpent: 0, chaptersWithDays: 0 };
              teacherMap[t.afid].total++;
              if (st.key === 'completed' || st.key === 'ahead') {
                teacherMap[t.afid].completed++;
                if (prog.completionDate && ch.targetDate) {
                  const days = Math.abs(Math.ceil((new Date(prog.completionDate) - new Date(ch.targetDate)) / (1000 * 60 * 60 * 24)));
                  teacherMap[t.afid].daysSpent += days;
                  teacherMap[t.afid].chaptersWithDays++;
                }
              }
              if (prog.completed === 'Yes' && prog.testConducted !== 'Yes') teacherMap[t.afid].pendingTests++;
              
              schoolStatus[t.school] = schoolStatus[t.school] || { delayed: 0, ontrack: 0, total: 0, completed: 0, pendingTests: 0 };
              schoolStatus[t.school].total++;
              if (st.key.includes('delayed')) schoolStatus[t.school].delayed++;
              else if (['ahead','completed'].includes(st.key)) { schoolStatus[t.school].ontrack++; schoolStatus[t.school].completed++; }
              if (prog.completed === 'Yes' && prog.testConducted !== 'Yes') schoolStatus[t.school].pendingTests++;
            }
          });
        });
      });
    });

    const teacherArr = Object.values(teacherMap).map(t => ({ 
      ...t, 
      percent: t.total ? Math.round((t.completed / t.total) * 100) : 0,
      avgDaysPerChapter: t.chaptersWithDays ? Math.round(t.daysSpent / t.chaptersWithDays) : 0
    }));
    teacherArr.sort((a,b) => b.percent - a.percent);

    setAnalyticsData({ 
      totalChapters, totalCompleted, totalPendingTests, teacherArr, schoolStatus, subjectStats,
      avgDaysPerChapter: chaptersWithDates ? Math.round(totalDaysSpent / chaptersWithDates) : 0,
      estimatedClassesRemaining: (totalChapters - totalCompleted) * 5
    });
  }, [curriculum, chapterProgress, teachers, computeChapterStatus]);

  const createChart = useCallback((refKey, config) => {
    if (chartRefs.current[refKey]?.current) {
      if (charts.current[refKey]) charts.current[refKey].destroy();
      charts.current[refKey] = new Chart(chartRefs.current[refKey].current.getContext('2d'), config);
    }
  }, []);

  const handleLogin = async () => {
    setAuthLoading(true);
    try {
      const email = (loginForm.email || '').trim().toLowerCase();
      if (!email || !loginForm.password) { alert('Enter email and password'); setAuthLoading(false); return; }
      await auth.signInWithEmailAndPassword(email, loginForm.password);
    } catch (e) { 
      alert(e.code === 'auth/invalid-credential' ? 'Invalid credentials' : 'Login failed: ' + e.message);
    }
    setAuthLoading(false);
  };

  const updateChapterProgress = useCallback(async (chapterId, field, value, chapter) => {
    try {
      const currentProg = chapterProgress[chapterId] || {};
      if (field === 'completed' && value === 'Yes') {
        const topicsDone = (currentProg.completedTopics || []).length;
        const topicsTotal = (chapter.topics || []).length;
        if (topicsDone < topicsTotal) { alert(`Complete all ${topicsTotal} topics first!\nDone: ${topicsDone}/${topicsTotal}`); return; }
        if (!currentProg.completionDate) { alert('Set completion date first!'); return; }
      }
      const updateObj = { [field]: value };
      if (field === 'completed' && value === 'No') updateObj['completionDate'] = null;
      if (updateTimeouts.current[chapterId]) clearTimeout(updateTimeouts.current[chapterId]);
      setChapterProgress(prev => ({ ...prev, [chapterId]: { ...(prev[chapterId]||{}), ...updateObj } }));
      updateTimeouts.current[chapterId] = setTimeout(async () => {
        await db.collection('chapterProgress').doc(chapterId).set(updateObj, { merge: true });
      }, 300);
    } catch (e) { alert('Update failed'); }
  }, [chapterProgress]);

  const toggleExpand = useCallback((id) => setExpandedChapters(prev => ({ ...prev, [id]: !prev[id] })), []);

  const addOrUpdateTeacher = async (teacherObj, password = null) => {
    if (!teacherObj.afid || !teacherObj.email || !teacherObj.subject || !teacherObj.school) return alert('Fill all required fields');
    const id = teacherObj.afid.toUpperCase();
    const email = teacherObj.email.toLowerCase();
    try {
      await db.collection('teachers').doc(id).set({ ...teacherObj, afid: id, email: email }, { merge: !password });
      alert(password ? `Teacher saved!\n\nCreate Firebase Auth:\nEmail: ${email}\nPassword: ${password}` : 'Teacher updated');
    } catch (e) { alert('Save failed: ' + e.message); }
  };

  const saveCurriculum = async (newCurr) => {
    try { await db.collection('meta').doc('curriculum').set(newCurr); alert('Curriculum updated'); } 
    catch (e) { alert('Failed: ' + e.message); }
  };

  const addChapterAdmin = async (subject, grade, chapter) => {
    const newCurr = { ...(curriculum || {}) };
    newCurr[subject] = newCurr[subject] || {};
    newCurr[subject][grade] = newCurr[subject][grade] || [];
    chapter.id = chapter.id || (subject.charAt(0).toUpperCase() + grade + '-' + (newCurr[subject][grade].length + 1) + '-' + Date.now().toString().slice(-4));
    newCurr[subject][grade].push(chapter);
    await saveCurriculum(newCurr);
  };

  const handleCSVImport = (file, subject, grade) => {
    Papa.parse(file, {
      complete: async (results) => {
        const rows = results.data;
        if (rows.length < 2) { alert('CSV empty'); return; }
        const chapters = [];
        let currentChapter = null;
        rows.forEach((row, index) => {
          if (index === 0) return;
          const chapterName = row[0] ? row[0].trim() : '';
          const topicName = row[1] ? row[1].trim() : '';
          if (chapterName) {
            if (currentChapter) chapters.push(currentChapter);
            currentChapter = { name: chapterName, topics: topicName ? [topicName] : [], targetDate: '' };
          } else if (topicName && currentChapter) currentChapter.topics.push(topicName);
        });
        if (currentChapter) chapters.push(currentChapter);
        if (chapters.length === 0) { alert('No chapters found'); return; }
        for (const chapter of chapters) await addChapterAdmin(subject, grade, chapter);
        alert(`Imported ${chapters.length} chapters!`);
      }
    });
  };

  if (loading) return (
    <div className="min-h-screen avanti-gradient flex items-center justify-center">
      <div className="text-center"><img src={LOGO} className="w-20 h-20 mx-auto mb-4 animate-bounce" /><div className="text-white text-2xl font-bold">Loading...</div></div>
    </div>
  );

  if (!currentUser) return (
    <div className="min-h-screen avanti-gradient flex items-center justify-center p-4">
      <div className="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-md">
        <div className="text-center mb-8">
          <img src={LOGO} className="w-20 h-20 mx-auto mb-4" />
          <h1 className="text-4xl font-bold text-gray-800 mb-2">Curriculum Tracker</h1>
          <p className="text-gray-600 text-lg font-semibold">Avanti Fellows</p>
        </div>
        <div className="space-y-5">
          <input type="email" className="w-full px-5 py-4 border-2 border-gray-300 rounded-xl text-lg" value={loginForm.email} onChange={e => setLoginForm({...loginForm, email: e.target.value})} placeholder="Email" />
          <input type="password" className="w-full px-5 py-4 border-2 border-gray-300 rounded-xl text-lg" value={loginForm.password} onChange={e => setLoginForm({...loginForm, password: e.target.value})} placeholder="Password" onKeyPress={e => e.key === 'Enter' && handleLogin()} />
          <button onClick={handleLogin} disabled={authLoading} className="w-full avanti-gradient text-white py-4 rounded-xl font-bold text-lg disabled:opacity-50">
            {authLoading ? 'Logging in...' : 'Login'}
          </button>
        </div>
      </div>
    </div>
  );

  const Overview = () => {
    if (!chartRefs.current.schoolComp) chartRefs.current.schoolComp = React.createRef();
    if (!chartRefs.current.subjectBreak) chartRefs.current.subjectBreak = React.createRef();

    useEffect(() => {
      if (!analyticsData || !chartRefs.current.schoolComp?.current) return;
      const schoolNames = Object.keys(analyticsData.schoolStatus || {});
      const completionData = schoolNames.map(s => {
        const school = analyticsData.schoolStatus[s];
        return school.total ? Math.round((school.completed / school.total) * 100) : 0;
      });
      createChart('schoolComp', {
        type: 'bar',
        data: { labels: schoolNames, datasets: [{ label: 'Completion %', data: completionData, backgroundColor: schoolNames.map((_, idx) => currentUser.school === schoolNames[idx] ? '#C8342E' : '#E5E7EB'), borderRadius: 8 }] },
        options: { indexAxis: 'y', plugins: { legend: { display: false }, title: { display: true, text: 'School Completion' } }, scales: { x: { min: 0, max: 100, ticks: { callback: v => v + '%' } } } }
      });
    }, [analyticsData, currentUser, createChart]);

    useEffect(() => {
      if (!analyticsData || !chartRefs.current.subjectBreak?.current) return;
      const subjects = Object.keys(analyticsData.subjectStats || {});
      const completedData = subjects.map(s => analyticsData.subjectStats[s].completed);
      const totalData = subjects.map(s => analyticsData.subjectStats[s].total);
      createChart('subjectBreak', {
        type: 'bar',
        data: { labels: subjects, datasets: [ { label: 'Completed', data: completedData, backgroundColor: '#10B981', borderRadius: 6 }, { label: 'Remaining', data: subjects.map((s, i) => totalData[i] - completedData[i]), backgroundColor: '#F59E0B', borderRadius: 6 } ] },
        options: { plugins: { legend: { position: 'bottom' }, title: { display: true, text: 'All Subjects Progress' } }, scales: { x: { stacked: true }, y: { stacked: true } } }
      });
    }, [analyticsData, createChart]);
    
    return (
      <div className="space-y-6 p-4">
        <h2 className="text-3xl font-bold flex items-center gap-3"><img src={LOGO} className="w-10 h-10" />Dashboard</h2>
        <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
          <div className="avanti-gradient text-white p-4 rounded-xl shadow-lg"><div className="text-sm mb-1">Total Chapters</div><div className="text-3xl font-bold">{analyticsData?.totalChapters || 0}</div></div>
          <div className="bg-gradient-to-br from-green-500 to-emerald-500 text-white p-4 rounded-xl shadow-lg"><div className="text-sm mb-1">Completed</div><div className="text-3xl font-bold">{analyticsData?.totalCompleted || 0}</div></div>
          <div className="bg-gradient-to-br from-orange-500 to-red-500 text-white p-4 rounded-xl shadow-lg"><div className="text-sm mb-1">Pending Tests</div><div className="text-3xl font-bold">{analyticsData?.totalPendingTests || 0}</div></div>
          <div className="bg-gradient-to-br from-blue-500 to-cyan-500 text-white p-4 rounded-xl shadow-lg"><div className="text-sm mb-1">Avg Days/Ch</div><div className="text-3xl font-bold">{analyticsData?.avgDaysPerChapter || 0}</div></div>
        </div>
        <div className="bg-white p-6 rounded-xl shadow-lg avanti-gradient-light border-2 border-yellow-200">
          <div className="text-sm font-medium text-gray-700 mb-1">📅 Estimated Classes to Complete</div>
          <div className="text-4xl font-bold" style={{color: 'var(--avanti-red)'}}>{analyticsData?.estimatedClassesRemaining || 0}</div>
          <div className="text-sm text-gray-600 mt-2">Based on ~5 classes per chapter</div>
        </div>
        <div className="grid md:grid-cols-2 gap-6">
          <div className="bg-white p-4 rounded-xl shadow-lg"><canvas ref={chartRefs.current.schoolComp} height="250"></canvas></div>
          <div className="bg-white p-4 rounded-xl shadow-lg"><canvas ref={chartRefs.current.subjectBreak} height="250"></canvas></div>
        </div>
      </div>
    );
  };

  const Chapters = () => {
    const [selectedGrade, setSelectedGrade] = useState(11);
    const subj = currentUser.subject;
    const chapters = useMemo(() => {
      if (!curriculum || !curriculum[subj] || !curriculum[subj][selectedGrade]) return [];
      return curriculum[subj][selectedGrade];
    }, [curriculum, subj, selectedGrade]);

    if (!subj || !curriculum[subj]) return (
      <div className="p-4"><h2 className="text-3xl font-bold mb-4">Chapters</h2><div className="bg-white p-8 rounded-2xl shadow-lg text-center"><img src={LOGO} className="w-20 h-20 mx-auto mb-4" /><h3 className="text-2xl font-bold">No Curriculum</h3><p className="text-gray-600">Contact admin</p></div></div>
    );

    return (
      <div className="p-4 space-y-6">
        <h2 className="text-3xl font-bold">Chapters - {subj}</h2>
        <div className="flex gap-3">
          <button onClick={() => setSelectedGrade(11)} className={`px-6 py-3 rounded-xl font-semibold ${selectedGrade === 11 ? 'avanti-gradient text-white shadow-lg' : 'bg-white text-gray-700'}`}>Class 11th</button>
          <button onClick={() => setSelectedGrade(12)} className={`px-6 py-3 rounded-xl font-semibold ${selectedGrade === 12 ? 'avanti-gradient text-white shadow-lg' : 'bg-white text-gray-700'}`}>Class 12th</button>
        </div>
        {chapters.length === 0 ? (
          <div className="bg-white p-8 rounded-2xl shadow-lg text-center"><img src={LOGO} className="w-20 h-20 mx-auto mb-4" /><h3 className="text-2xl font-bold">No Chapters</h3><p className="text-gray-600">Admin needs to add chapters for Class {selectedGrade}</p></div>
        ) : (
          <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
            {chapters.map(ch => {
              const prog = chapterProgress[ch.id] || {};
              const status = computeChapterStatus(ch, prog);
              const completedTopics = prog.completedTopics || [];
              const isExpanded = !!expandedChapters[ch.id];
              const topicsPercent = ch.topics?.length ? Math.round((completedTopics.length / ch.topics.length) * 100) : 0;

              return (
                <div key={ch.id} className={`chapter-card ${status.color} border-2 rounded-2xl shadow-lg p-5 ${isExpanded ? 'expanded' : 'collapsed'}`}>
                  <div className="mb-4">
                    <div className="flex justify-between items-start mb-2">
                      <h3 className="text-xl font-bold text-gray-800 pr-2">{ch.name}</h3>
                      <span className={`px-3 py-1 rounded-full text-xs font-bold ${status.textColor}`}>{status.label}</span>
                    </div>
                    <div className="space-y-1 text-sm">
                      <div className="flex justify-between text-gray-700"><span className="font-medium">Topics:</span><span className="font-bold" style={{color: 'var(--avanti-red)'}}>{completedTopics.length}/{ch.topics?.length || 0}</span></div>
                      <div className="h-2 bg-gray-200 rounded-full overflow-hidden"><div className="h-2 avanti-gradient" style={{ width: `${topicsPercent}%` }} /></div>
                      <div className="flex justify-between text-gray-600 mt-2"><span>Target:</span><span className="font-semibold">{ch.targetDate || '—'}</span></div>
                    </div>
                  </div>
                  <button onClick={() => toggleExpand(ch.id)} className="w-full flex justify-between items-center p-3 avanti-gradient-light rounded-xl hover:shadow-md mb-4">
                    <span className="font-bold" style={{color: 'var(--avanti-red)'}}>{isExpanded ? 'Hide' : 'Show'} Details</span>
                    <svg className={`w-5 h-5 expand-btn ${isExpanded ? 'rotated' : ''}`} fill="none" stroke="currentColor" viewBox="0 0 24 24" style={{color: 'var(--avanti-red)'}}><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" /></svg>
                  </button>
                  <div className={`chapter-details ${isExpanded ? 'show' : ''}`}>
                    <hr className="my-4 border-gray-300" />
                    <div className="space-y-4">
                      <div className="border-2 rounded-xl p-4 avanti-gradient-light">
                        <div className="font-bold text-gray-700 mb-3">📋 Topics ({completedTopics.length}/{ch.topics?.length || 0})</div>
                        <div className="space-y-2 max-h-64 overflow-y-auto">
                          {(ch.topics || []).map((t, idx) => {
                            const checked = completedTopics.includes(t);
                            return (
                              <label key={idx} className="flex items-center gap-3 p-3 rounded-xl hover:bg-yellow-50 cursor-pointer">
                                <input type="checkbox" checked={checked} onChange={e => {
                                  const updated = e.target.checked ? [...completedTopics, t] : completedTopics.filter(x => x !== t);
                                  updateChapterProgress(ch.id, 'completedTopics', updated, ch);
                                }} />
                                <span className={`flex-1 ${checked ? 'line-through text-gray-500' : 'text-gray-800 font-medium'}`}>{t}</span>
                                {checked && <span className="text-green-500 text-xl">✓</span>}
                              </label>
                            );
                          })}
                        </div>
                      </div>
                      <div className="avanti-gradient-light p-3 rounded-xl border-2" style={{borderColor: 'var(--avanti-yellow)'}}>
                        <label className="block text-sm font-bold text-gray-800 mb-2">Completion Date <span style={{color: 'var(--avanti-red)'}}>*</span></label>
                        <input type="date" value={prog.completionDate || ''} onChange={e => updateChapterProgress(ch.id, 'completionDate', e.target.value, ch)} className="w-full border-2 px-4 py-2 rounded-lg" style={{borderColor: 'var(--avanti-yellow)'}} />
                      </div>
                      <div><label className="block text-sm font-bold text-gray-700 mb-2">Test Conducted?</label><select value={prog.testConducted || 'No'} onChange={e => updateChapterProgress(ch.id, 'testConducted', e.target.value, ch)} className="w-full border-2 border-gray-300 px-4 py-3 rounded-xl"><option>No</option><option>Yes</option></select></div>
                      <div><label className="block text-sm font-bold text-gray-700 mb-2">Chapter Completed?</label><select value={prog.completed || 'No'} onChange={e => updateChapterProgress(ch.id, 'completed', e.target.value, ch)} className="w-full border-2 border-gray-300 px-4 py-3 rounded-xl"><option>No</option><option>Yes</option></select></div>
                      <div><label className="block text-sm font-bold text-gray-700 mb-2">Method</label><select value={prog.method || 'Online'} onChange={e => updateChapterProgress(ch.id, 'method', e.target.value, ch)} className="w-full border-2 border-gray-300 px-4 py-3 rounded-xl"><option>Online</option><option>Offline</option></select></div>
                      {prog.method === 'Offline' && <div><label className="block text-sm font-bold text-gray-700 mb-2">Notes</label><textarea value={prog.notes || ''} onChange={e => updateChapterProgress(ch.id, 'notes', e.target.value, ch)} className="w-full border-2 border-gray-300 px-4 py-2 rounded-xl" rows="2" placeholder="Why offline?" /></div>}
                    </div>
                  </div>
                </div>
              );
            })}
          </div>
        )}
      </div>
    );
  };

  const Profile = () => (
    <div className="p-4 space-y-6">
      <h2 className="text-3xl font-bold">Profile</h2>
      <div className="bg-white p-6 rounded-2xl shadow-lg">
        <div className="grid md:grid-cols-2 gap-6">
          {[
            { label: 'Name', value: currentUser.name },
            { label: 'AFID', value: currentUser.afid },
            { label: 'Subject', value: currentUser.subject },
            { label: 'School', value: currentUser.school },
            { label: 'Email', value: currentUser.email || '—' },
            { label: 'Phone', value: currentUser.phone || '—' }
          ].map(item => (
            <div key={item.label} className="p-4 avanti-gradient-light rounded-xl">
              <div className="text-sm font-medium text-gray-600 mb-1">{item.label}</div>
              <div className="text-lg font-bold text-gray-800">{item.value}</div>
            </div>
          ))}
        </div>
      </div>
    </div>
  );

  const AdminAnalytics = () => {
    if (!chartRefs.current.adminPie) chartRefs.current.adminPie = React.createRef();
    if (!chartRefs.current.adminBar) chartRefs.current.adminBar = React.createRef();

    useEffect(() => {
      if (!analyticsData || !chartRefs.current.adminPie?.current) return;
      const schoolNames = Object.keys(analyticsData.schoolStatus || {});
      const completionData = schoolNames.map(s => analyticsData.schoolStatus[s].completed || 0);
      createChart('adminPie', {
        type: 'pie',
        data: { labels: schoolNames, datasets: [{ data: completionData, backgroundColor: ['#F4B41A', '#E8B039', '#C8342E', '#10B981', '#3B82F6', '#8B5CF6'], borderWidth: 2, borderColor: '#fff' }] },
        options: { plugins: { legend: { position: 'bottom' }, title: { display: true, text: 'School Completion Distribution' } } }
      });
    }, [analyticsData, createChart]);

    useEffect(() => {
      if (!analyticsData || !chartRefs.current.adminBar?.current) return;
      const subjects = Object.keys(analyticsData.subjectStats || {});
      const completedData = subjects.map(s => analyticsData.subjectStats[s].completed);
      const remainingData = subjects.map(s => analyticsData.subjectStats[s].total - analyticsData.subjectStats[s].completed);
      createChart('adminBar', {
        type: 'bar',
        data: { labels: subjects, datasets: [ { label: 'Completed', data: completedData, backgroundColor: '#10B981', borderRadius: 6 }, { label: 'Remaining', data: remainingData, backgroundColor: '#F59E0B', borderRadius: 6 } ] },
        options: { plugins: { legend: { position: 'bottom' } }, scales: { x: { stacked: true }, y: { stacked: true } } }
      });
    }, [analyticsData, createChart]);

    return (
      <div className="space-y-6 p-4">
        <h3 className="text-2xl font-bold">📊 Analytics</h3>
        <div className="grid grid-cols-2 md:grid-cols-5 gap-4">
          <div className="avanti-gradient text-white p-4 rounded-xl shadow-lg text-center"><div className="text-sm mb-1">Total</div><div className="text-3xl font-bold">{analyticsData?.totalChapters || 0}</div></div>
          <div className="bg-gradient-to-br from-green-500 to-emerald-500 text-white p-4 rounded-xl shadow-lg text-center"><div className="text-sm mb-1">Completed</div><div className="text-3xl font-bold">{analyticsData?.totalCompleted || 0}</div></div>
          <div className="bg-gradient-to-br from-orange-500 to-red-500 text-white p-4 rounded-xl shadow-lg text-center"><div className="text-sm mb-1">Tests Pending</div><div className="text-3xl font-bold">{analyticsData?.totalPendingTests || 0}</div></div>
          <div className="bg-gradient-to-br from-blue-500 to-cyan-500 text-white p-4 rounded-xl shadow-lg text-center"><div className="text-sm mb-1">Avg Days</div><div className="text-3xl font-bold">{analyticsData?.avgDaysPerChapter || 0}</div></div>
          <div className="bg-gradient-to-br from-indigo-500 to-purple-500 text-white p-4 rounded-xl shadow-lg text-center"><div className="text-sm mb-1">Classes Left</div><div className="text-3xl font-bold">{analyticsData?.estimatedClassesRemaining || 0}</div></div>
        </div>
        <div className="grid md:grid-cols-2 gap-6">
          <div className="bg-white p-4 rounded-xl shadow-lg"><canvas ref={chartRefs.current.adminPie} height="250"></canvas></div>
          <div className="bg-white p-4 rounded-xl shadow-lg"><canvas ref={chartRefs.current.adminBar} height="250"></canvas></div>
        </div>
        <div className="bg-white p-4 rounded-xl shadow-lg overflow-x-auto">
          <h4 className="font-bold mb-3">Teacher Performance</h4>
          <table className="w-full text-sm">
            <thead className="avanti-gradient-light">
              <tr><th className="p-2 text-left">Rank</th><th className="p-2 text-left">Name</th><th className="p-2 text-left">School</th><th className="p-2 text-left">Subject</th><th className="p-2 text-left">Done</th><th className="p-2 text-left">Total</th><th className="p-2 text-left">%</th></tr>
            </thead>
            <tbody>
              {(analyticsData?.teacherArr || []).map((t, idx) => (
                <tr key={t.afid} className="border-b hover:bg-yellow-50">
                  <td className="p-2">{idx < 3 ? ['🥇','🥈','🥉'][idx] : `#${idx+1}`}</td>
                  <td className="p-2 font-medium">{t.name}</td>
                  <td className="p-2">{t.school}</td>
                  <td className="p-2">{t.subject}</td>
                  <td className="p-2 text-green-600 font-bold">{t.completed}</td>
                  <td className="p-2">{t.total}</td>
                  <td className="p-2"><span className="px-2 py-1 avanti-gradient-light rounded-full font-bold" style={{color: 'var(--avanti-red)'}}>{t.percent}%</span></td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </div>
    );
  };

  const AdminTeachers = () => {
    const [editing, setEditing] = useState(null);
    const [form, setForm] = useState({ afid:'', name:'', subject:'', school:'', email:'', phone:'', password:'' });
    const [isNew, setIsNew] = useState(false);

    useEffect(() => {
      if (editing) { setForm(editing); setIsNew(false); } 
      else { setForm({ afid:'', name:'', subject:'', school:'', email:'', phone:'', password:'' }); setIsNew(true); }
    }, [editing]);

    return (
      <div className="space-y-6 p-4">
        <div className="flex justify-between"><h3 className="text-2xl font-bold">Teachers</h3><button onClick={() => { setEditing(null); setIsNew(true); }} className="px-5 py-3 bg-blue-600 text-white rounded-xl font-semibold">+ Add</button></div>
        {teachers.length > 0 && (
          <div className="bg-white p-4 rounded-xl shadow-lg overflow-x-auto">
            <table className="w-full text-sm">
              <thead className="avanti-gradient-light"><tr><th className="p-2 text-left">AFID</th><th className="p-2 text-left">Name</th><th className="p-2 text-left">Email</th><th className="p-2 text-left">Subject</th><th className="p-2 text-left">School</th><th className="p-2 text-left">Actions</th></tr></thead>
              <tbody>
                {teachers.map(t => (
                  <tr key={t.afid} className="border-b hover:bg-yellow-50"><td className="p-2 font-mono">{t.afid}</td><td className="p-2">{t.name}</td><td className="p-2">{t.email}</td><td className="p-2">{t.subject}</td><td className="p-2">{t.school}</td><td className="p-2"><button onClick={() => { setEditing(t); setIsNew(false); }} className="px-3 py-1 bg-yellow-400 rounded-lg mr-2">Edit</button></td></tr>
                ))}
              </tbody>
            </table>
          </div>
        )}
        {(editing || isNew) && (
          <div className="bg-white p-6 rounded-xl shadow-lg">
            <h4 className="font-bold text-xl mb-4">{isNew ? 'Add Teacher' : 'Edit Teacher'}</h4>
            <div className="grid md:grid-cols-2 gap-4">
              <div><label className="text-sm font-medium block mb-1">AFID *</label><input type="text" value={form.afid || ''} onChange={e => setForm({...form, afid: e.target.value})} className="w-full border-2 px-3 py-2 rounded-lg" disabled={!isNew} /></div>
              <div><label className="text-sm font-medium block mb-1">Name *</label><input type="text" value={form.name || ''} onChange={e => setForm({...form, name: e.target.value})} className="w-full border-2 px-3 py-2 rounded-lg" /></div>
              <div><label className="text-sm font-medium block mb-1">Email *</label><input type="email" value={form.email || ''} onChange={e => setForm({...form, email: e.target.value})} className="w-full border-2 px-3 py-2 rounded-lg" /></div>
              <div><label className="text-sm font-medium block mb-1">Subject *</label><select value={form.subject || ''} onChange={e => setForm({...form, subject: e.target.value})} className="w-full border-2 px-3 py-2 rounded-lg"><option value="">Select</option>{SUBJECTS.map(s => <option key={s}>{s}</option>)}</select></div>
              <div><label className="text-sm font-medium block mb-1">School *</label><select value={form.school || ''} onChange={e => setForm({...form, school: e.target.value})} className="w-full border-2 px-3 py-2 rounded-lg"><option value="">Select</option>{schools.map(s => <option key={s}>{s}</option>)}</select></div>
              <div><label className="text-sm font-medium block mb-1">Phone</label><input type="text" value={form.phone || ''} onChange={e => setForm({...form, phone: e.target.value})} className="w-full border-2 px-3 py-2 rounded-lg" /></div>
              {isNew && <div><label className="text-sm font-medium block mb-1">Password *</label><input type="password" value={form.password || ''} onChange={e => setForm({...form, password: e.target.value})} className="w-full border-2 px-3 py-2 rounded-lg" placeholder="Min 6 chars" /></div>}
            </div>
            <div className="mt-5 flex gap-3">
              <button onClick={() => { addOrUpdateTeacher(form, isNew ? form.password : null); setEditing(null); }} className="px-6 py-3 bg-green-600 text-white rounded-xl font-semibold">Save</button>
              <button onClick={() => setEditing(null)} className="px-6 py-3 bg-gray-200 rounded-xl font-semibold">Cancel</button>
            </div>
          </div>
        )}
      </div>
    );
  };

  const AdminCurriculum = () => {
    const [subject, setSubject] = useState(Object.keys(curriculum || {})[0] || '');
    const [grade, setGrade] = useState(11);
    const [newCh, setNewCh] = useState({ name:'', topics:'', targetDate:'' });
    const fileRef = useRef(null);

    return (
      <div className="space-y-6 p-4">
        <div className="flex gap-3"><h3 className="text-2xl font-bold">Curriculum</h3><select value={subject} onChange={e=>setSubject(e.target.value)} className="border-2 px-4 py-2 rounded-lg"><option value="">Select Subject</option>{SUBJECTS.map(s => <option key={s}>{s}</option>)}</select><select value={grade} onChange={e=>setGrade(Number(e.target.value))} className="border-2 px-4 py-2 rounded-lg"><option value={11}>Class 11</option><option value={12}>Class 12</option></select></div>
        <div className="avanti-gradient-light p-6 rounded-xl">
          <h4 className="font-bold mb-3">📊 Import CSV</h4>
          <input ref={fileRef} type="file" accept=".csv" onChange={e => { if (e.target.files[0]) handleCSVImport(e.target.files[0], subject, grade); }} className="hidden" />
          <button onClick={() => fileRef.current?.click()} disabled={!subject} className="px-5 py-3 avanti-gradient text-white rounded-xl font-semibold disabled:opacity-50">📂 Choose CSV</button>
        </div>
        <div className="bg-white p-6 rounded-xl shadow-lg">
          <h4 className="font-bold mb-3">Or Add Manually</h4>
          <div className="grid md:grid-cols-3 gap-3"><input placeholder="Chapter name" value={newCh.name} onChange={e => setNewCh({...newCh, name: e.target.value})} className="border-2 px-3 py-2 rounded-lg" /><input placeholder="Topics (comma separated)" value={newCh.topics} onChange={e=>setNewCh({...newCh, topics: e.target.value})} className="border-2 px-3 py-2 rounded-lg" /><input type="date" value={newCh.targetDate} onChange={e=>setNewCh({...newCh, targetDate: e.target.value})} className="border-2 px-3 py-2 rounded-lg" /></div>
          <button onClick={() => { if (newCh.name && subject) { addChapterAdmin(subject, grade, { name: newCh.name, topics: newCh.topics ? newCh.topics.split(',').map(x=>x.trim()) : [], targetDate: newCh.targetDate }); setNewCh({ name:'', topics:'', targetDate:'' }); } }} disabled={!subject} className="mt-4 px-5 py-3 bg-green-600 text-white rounded-xl font-semibold disabled:opacity-50">Add Chapter</button>
        </div>
        {subject && curriculum[subject]?.[grade] && (
          <div className="space-y-3">
            {curriculum[subject][grade].map(ch => (
              <div key={ch.id} className="p-4 rounded-xl border-2 bg-white"><div className="font-bold">{ch.name}</div><div className="text-sm text-gray-600">{(ch.topics||[]).join(', ')}</div><div className="text-sm">Target: {ch.targetDate || '—'}</div></div>
            ))}
          </div>
        )}
      </div>
    );
  };

  const AdminDashboard = () => {
    const [tab, setTab] = useState('analytics');
    return (
      <div className="space-y-6">
        <h2 className="text-3xl font-bold p-4">Admin Dashboard</h2>
        <div className="flex gap-2 px-4 overflow-x-auto">
          {['analytics','teachers','curriculum'].map(t => <button key={t} onClick={()=>setTab(t)} className={`px-5 py-3 rounded-xl font-semibold whitespace-nowrap ${tab===t ? 'avanti-gradient text-white' : 'bg-white text-gray-700'}`}>{t.charAt(0).toUpperCase() + t.slice(1)}</button>)}
        </div>
        {tab === 'analytics' && <AdminAnalytics />}
        {tab === 'teachers' && <AdminTeachers />}
        {tab === 'curriculum' && <AdminCurriculum />}
      </div>
    );
  };

  return (
    <div className="bg-gradient-to-br from-yellow-50 via-orange-50 to-red-50 min-h-screen">
      <nav className="bg-white shadow-lg sticky top-0 z-40 px-4 py-4 flex justify-between items-center">
        <div className="flex items-center gap-3"><img src={LOGO} className="w-10 h-10" /><div><div className="font-bold text-xl">Curriculum Tracker</div><div className="text-sm text-gray-600">{isAdmin ? 'Admin' : `${currentUser.name} - ${currentUser.school}`}</div></div></div>
        <button onClick={() => auth.signOut()} className="px-5 py-2 bg-red-500 text-white rounded-xl font-semibold">Logout</button>
      </nav>
      <div className="max-w-7xl mx-auto py-6">
        {!isAdmin && (
          <div className="flex gap-2 px-4 mb-6 overflow-x-auto">
            <button onClick={() => setActiveTab('overview')} className={`px-5 py-3 rounded-xl font-semibold whitespace-nowrap ${activeTab==='overview' ? 'avanti-gradient text-white' : 'bg-white text-gray-700'}`}>🏠 Overview</button>
            <button onClick={() => setActiveTab('chapters')} className={`px-5 py-3 rounded-xl font-semibold whitespace-nowrap ${activeTab==='chapters' ? 'avanti-gradient text-white' : 'bg-white text-gray-700'}`}>📖 Chapters</button>
            <button onClick={() => setActiveTab('profile')} className={`px-5 py-3 rounded-xl font-semibold whitespace-nowrap ${activeTab==='profile' ? 'avanti-gradient text-white' : 'bg-white text-gray-700'}`}>👤 Profile</button>
          </div>
        )}
        {isAdmin && <AdminDashboard />}
        {!isAdmin && activeTab === 'overview' && <Overview />}
        {!isAdmin && activeTab === 'chapters' && <Chapters />}
        {!isAdmin && activeTab === 'profile' && <Profile />}
      </div>
      <footer className="avanti-gradient text-white py-6 mt-12 text-center"><p className="font-medium">© 2025 Curriculum Tracker - Avanti Fellows</p></footer>
    </div>
  );
}

ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
