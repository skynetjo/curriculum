
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Curriculum Tracker - Avanti Fellows</title>
  
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  
  <!-- React -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- ‚úÖ FIX: Chart.js v3.9.1 (specific stable version) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#F4B41A">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Curriculum Tracker">
  <link rel="apple-touch-icon" href="/icon-192.png">

  <!-- CSV & Excel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
  
  <!-- Tally Form -->
  <script>
    window.TallyConfig = {
      "formId": "wQggKA",
      "popup": {
        "width": 250,
        "emoji": {
          "text": "üëã",
          "animation": "flash"
        },
        "hideTitle": true,
        "alignLeft": true,
        "overlay": true,
        "autoClose": 4000,
        "open": {
          "trigger": "scroll",
          "scrollPercent": 10
        },
        "doNotShowAfterSubmit": true
      }
    };
  </script>
  <script async src="https://tally.so/widgets/embed.js"></script>
  <style>
    /* Priority Badge Gradients */
.priority-badge {
  display: inline-block;
  padding: 0.4rem 0.8rem;
  border-radius: 0.4rem;
  font-size: 0.75rem;
  font-weight: 600;
  color: white;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.12);
  text-align: center;
  min-width: 100px;
  letter-spacing: 0.02em;
}

.priority-high {
  background: linear-gradient(90deg, #10B981 0%, #34D399 100%);
}

.priority-medium {
  background: linear-gradient(90deg, #F59E0B 0%, #FBBF24 100%);
}

.priority-low {
  background: linear-gradient(90deg, #EF4444 0%, #F87171 100%);
}
    :root{--avanti-yellow:#F4B41A;--avanti-orange:#E8B039;--avanti-red:#C8342E}
    *{box-sizing:border-box}
    
    /* Enhanced Mobile Sidebar Styles */
    .mobile-sidebar-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 998;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }
    
    .mobile-sidebar-overlay.active {
      opacity: 1;
      visibility: visible;
    }
    
    .mobile-sidebar {
      position: fixed;
      top: 0;
      left: 0;
      bottom: 0;
      width: 280px;
      max-width: 85vw;
      background: white;
      z-index: 999;
      transform: translateX(-100%);
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 2px 0 12px rgba(0, 0, 0, 0.15);
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    
    .mobile-sidebar.active {
      transform: translateX(0);
    }
    
    /* Desktop sidebar adjustments */
    @media (min-width: 768px) {
      .mobile-sidebar {
        position: relative;
        transform: translateX(0) !important;
        width: 16rem;
        max-width: none;
        box-shadow: none;
      }
      
      .mobile-sidebar-overlay {
        display: none;
      }
    }
    
    /* Responsive card improvements */
    @media (max-width: 768px) {
      .stat-card {
        padding: 1rem;
        margin-bottom: 0.75rem;
      }
      
      .chapter-card {
        padding: 1rem;
        margin-bottom: 0.75rem;
      }
      
      .modal-content {
        width: 95%;
        padding: 1.25rem;
        margin: 10px;
      }
      
      .ranking-card {
        padding: 1rem;
        margin-bottom: 0.75rem;
      }
      
      /* Better table responsiveness */
      table {
        font-size: 0.875rem;
      }
      
      th, td {
        padding: 0.5rem !important;
      }
    }
    
    /* Touch-friendly buttons */
    button, .button {
      min-height: 44px;
      touch-action: manipulation;
    }
    
    /* Better spacing for mobile */
    @media (max-width: 768px) {
      .p-6 {
        padding: 1rem !important;
      }
      
      .p-8 {
        padding: 1.5rem !important;
      }
      
      .gap-6 {
        gap: 1rem !important;
      }
      
      .space-y-6 > * + * {
        margin-top: 1rem !important;
      }
      
      /* Responsive grid adjustments */
      .grid-cols-2, .grid-cols-3, .grid-cols-4 {
        grid-template-columns: repeat(1, minmax(0, 1fr)) !important;
      }
      
      .md\:grid-cols-2, .md\:grid-cols-3 {
        grid-template-columns: repeat(1, minmax(0, 1fr)) !important;
      }
    }
    
    /* Small screens - 2 columns for some grids */
    @media (min-width: 480px) and (max-width: 768px) {
      .grid-cols-2 {
        grid-template-columns: repeat(2, minmax(0, 1fr)) !important;
      }
    }
    @keyframes confetti-fall{0%{transform:translateY(-100vh) rotate(0) scale(1);opacity:1}100%{transform:translateY(100vh) rotate(720deg) scale(.5);opacity:0}}
    .confetti-piece{position:fixed;pointer-events:none;z-index:9999;animation:confetti-fall 4s cubic-bezier(.25,.46,.45,.94) forwards}
    .chapter-card{transition:all .3s ease;position:relative;overflow:hidden}
    .chapter-card:hover{transform:translateY(-4px);box-shadow:0 20px 40px -12px rgba(0,0,0,.2)}
    .chapter-card.completed{background:linear-gradient(135deg,#d1fae5,#a7f3d0);border:3px solid #10b981}
    .chapter-card.delayed{background:linear-gradient(135deg,#fed7aa,#fdba74);border:3px solid #f97316}
    .chapter-card.pending{background:linear-gradient(135deg,#fecaca,#fca5a5);border:3px solid #ef4444}
    input:focus,select:focus,textarea:focus{outline:none;box-shadow:0 0 0 4px rgba(244,180,26,.2);border-color:var(--avanti-yellow)}
    .avanti-gradient{background:linear-gradient(135deg,var(--avanti-yellow) 0%,var(--avanti-orange) 50%,var(--avanti-red) 100%)}
    .avanti-gradient-light{background:linear-gradient(135deg,rgba(244,180,26,.1) 0%,rgba(232,176,57,.1) 50%,rgba(200,52,46,.1) 100%)}
    .stat-card{background:white;border-radius:1rem;padding:1.5rem;box-shadow:0 4px 6px -1px rgba(0,0,0,.1);transition:all .3s}
    .stat-card:hover{transform:translateY(-4px);box-shadow:0 10px 15px -3px rgba(0,0,0,.1)}
    input[type="checkbox"]{appearance:none;width:20px;height:20px;border:2px solid var(--avanti-red);border-radius:4px;cursor:pointer;position:relative;flex-shrink:0}
    input[type="checkbox"]:checked{background:var(--avanti-red)}
    input[type="checkbox"]:checked::after{content:'‚úì';position:absolute;color:white;font-size:14px;top:50%;left:50%;transform:translate(-50%,-50%)}
    .birthday-card{background:linear-gradient(135deg,#FFD700,#FFA500);border:3px solid #FF6347;animation:pulse 2s infinite}
    @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
    .modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:9998}
    .modal-content{background:white;border-radius:1rem;padding:2rem;max-width:600px;width:90%;max-height:90vh;overflow-y:auto}
    .status-badge{padding:.5rem 1rem;border-radius:.5rem;font-weight:bold;text-align:center;font-size:.875rem}
    .status-ahead{background:#10b981;color:white}
    .status-ontrack{background:#3b82f6;color:white}
    .status-delayed{background:#f97316;color:white}
    .ranking-card{background:white;border-radius:1rem;padding:1.5rem;box-shadow:0 4px 6px rgba(0,0,0,.1)}
    .ranking-1{border-left:4px solid #fbbf24}
    .ranking-2{border-left:4px solid #c0c0c0}
    .ranking-3{border-left:4px solid #cd7f32}
    .chapter-details{position:relative;z-index:10;pointer-events:auto!important}
.chapter-details input,.chapter-details select,.chapter-details textarea,.chapter-details button,.chapter-details label{position:relative;z-index:20;pointer-events:auto!important;cursor:pointer}
.chapter-details input[type="checkbox"]{cursor:pointer}
.chapter-details select{cursor:pointer;background-color:white}
.chapter-details input[type="date"]{cursor:pointer;background-color:white}

/* Teacher Feedback Styles */
.star-rating {
  display: inline-flex;
  gap: 8px;
  font-size: 32px;
  cursor: pointer;
}
.star {
  color: #d1d5db;
  transition: color 0.2s;
  cursor: pointer;
}
.star.filled {
  color: #F4B41A;
}
.star:hover, .star.hover {
  color: #E8B039;
}
.feedback-modal {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.6);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10000;
  overflow-y: auto;
}
.feedback-content {
  background: white;
  border-radius: 1rem;
  max-width: 600px;
  width: 95%;
  max-height: 90vh;
  overflow-y: auto;
  margin: 20px;
}
.rating-badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 14px;
  font-weight: bold;
}
.rating-excellent {
  background: #10b981;
  color: white;
}
.rating-good {
  background: #3b82f6;
  color: white;
}
.rating-average {
  background: #f59e0b;
  color: white;
}
.rating-poor {
  background: #ef4444;
  color: white;
}
.teacher-card {
  transition: all 0.3s ease;
  cursor: pointer;
}
.teacher-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 10px 20px rgba(0,0,0,0.1);
}
.feedback-notification {
  position: fixed;
  top: 80px;
  right: 20px;
  background: linear-gradient(135deg, #F4B41A, #E8B039);
  color: white;
  padding: 16px 24px;
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  z-index: 9999;
  animation: slideIn 0.5s ease;
}
@keyframes slideIn {
  from {
    transform: translateX(400px);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

/* ========================================
   VERTICAL SIDEBAR STYLES
   ======================================== */
.sidebar {
  position: fixed;
  top: 0;
  left: 0;
  height: 100vh;
  background: linear-gradient(180deg, #F4B41A 0%, #E8B039 50%, #C8342E 100%);
  box-shadow: 2px 0 10px rgba(0,0,0,0.1);
  transition: all 0.3s ease;
  z-index: 1000;
  overflow-y: auto;
}

.sidebar.collapsed {
  width: 70px;
}

.sidebar.expanded {
  width: 260px;
}

.sidebar-header {
  padding: 1.5rem;
  border-bottom: 1px solid rgba(255,255,255,0.2);
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.sidebar-toggle {
  background: rgba(255,255,255,0.2);
  border: none;
  color: white;
  padding: 0.5rem;
  border-radius: 0.5rem;
  cursor: pointer;
  transition: all 0.3s;
  font-size: 1.25rem;
}

.sidebar-toggle:hover {
  background: rgba(255,255,255,0.3);
}

.sidebar-nav {
  padding: 1rem 0;
}

.sidebar-item {
  display: flex;
  align-items: center;
  padding: 1rem 1.5rem;
  color: white;
  cursor: pointer;
  transition: all 0.2s;
  border-left: 4px solid transparent;
  gap: 1rem;
  text-decoration: none;
}

.sidebar-item:hover {
  background: rgba(255,255,255,0.1);
  border-left-color: white;
}

.sidebar-item.active {
  background: rgba(255,255,255,0.2);
  border-left-color: white;
  font-weight: bold;
}

.sidebar-icon {
  font-size: 1.5rem;
  min-width: 1.5rem;
  text-align: center;
}

.sidebar-label {
  white-space: nowrap;
  overflow: hidden;
  transition: opacity 0.3s;
}

.sidebar.collapsed .sidebar-label {
  opacity: 0;
  width: 0;
}

.sidebar.collapsed .sidebar-header h1 {
  opacity: 0;
  width: 0;
}

.main-content {
  transition: margin-left 0.3s ease;
}

.main-content.sidebar-expanded {
  margin-left: 260px;
}

.main-content.sidebar-collapsed {
  margin-left: 70px;
}

/* Mobile responsive */
@media (max-width: 768px) {
  .main-content.sidebar-expanded,
  .main-content.sidebar-collapsed {
    margin-left: 0 !important;
    padding-top: 70px;
    width: 100%;
  }
  
  .sidebar-toggle {
    display: none;
  }
}

/* Scrollbar styling for sidebar */
.sidebar::-webkit-scrollbar {
  width: 6px;
}

.sidebar::-webkit-scrollbar-track {
  background: rgba(255,255,255,0.1);
}

.sidebar::-webkit-scrollbar-thumb {
  background: rgba(255,255,255,0.3);
  border-radius: 3px;
}

.sidebar::-webkit-scrollbar-thumb:hover {
  background: rgba(255,255,255,0.5);
}
  </style>
</head>
<body>
  <div id="root"></div>
  <script>
  // Register Chart.js datalabels plugin safely
if (typeof ChartDataLabels !== 'undefined' && typeof Chart !== 'undefined') {
  try {
    Chart.register(ChartDataLabels);
    
    if (Chart.defaults && Chart.defaults.plugins) {
      Chart.defaults.plugins.datalabels = {
        anchor: 'end',
        align: 'end',
        offset: 4,
        formatter: (value, ctx) => {
          const type = ctx.chart.config.type;
          if (type === 'pie' || type === 'doughnut') {
            const sum = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0) || 1;
            return Math.round((value / sum) * 100) + '%';
          }
          return value;
        },
        color: '#333',
        font: { weight: '600', size: 11 }
      };
    }
  } catch (e) {
    console.warn('ChartDataLabels plugin registration failed:', e);
  }
}

// Optional overrides per chart type
if (typeof Chart !== 'undefined' && Chart.overrides) {
  Chart.overrides.bar = Chart.overrides.bar || {};
  Chart.overrides.bar.plugins = Chart.overrides.bar.plugins || {};
  Chart.overrides.bar.plugins.datalabels = {
    color: '#007bff',
    font: { weight: '700', size: 12 },
    align: 'end',
    anchor: 'end'
  };

  Chart.overrides.pie = Chart.overrides.pie || {};
  Chart.overrides.pie.plugins = Chart.overrides.pie.plugins || {};
  Chart.overrides.pie.plugins.datalabels = {
    color: '#fff',
    font: { weight: '600', size: 14 }
  };
}
</script>
  <script type="text/babel">
const {useState,useEffect,useRef,useCallback,useMemo}=React;
const firebaseConfig={apiKey:"AIzaSyDyyGAHNJvhuint86USW36eBJKfw_u3AcA",authDomain:"curriculum-dbb10.firebaseapp.com",projectId:"curriculum-dbb10",storageBucket:"curriculum-dbb10.firebasestorage.app",messagingSenderId:"706387632109",appId:"1:706387632109:web:06c78a304fdbdc12f391e4"};
if(!firebase.apps.length){firebase.initializeApp(firebaseConfig)}
const db=firebase.firestore();
const auth=firebase.auth();
const SUBJECTS=['Physics','Chemistry','Maths','Biology'];
const SCHOOLS=['CoE Barwani','CoE Cuttak','CoE Bundi','CoE Mahisagar','EMRS Bhopal','JNV Bharuch'];
const LEAVE_REASONS=['Present','Personal Leave','Sick Leave','Weekly Off','Public Holiday','Organization Holiday','School Holiday','Emergency Leave'];
const GENDERS=['Male','Female','Other'];
const isEditing = true;   // keep all admin filters enabled


// ========================================
// TEACHER FEEDBACK COMPONENTS
// ========================================

// Star Rating Component
function StarRating({ value, onChange, readonly = false }) {
  const [hoverValue, setHoverValue] = useState(0);
  
  return (
    <div className="star-rating">
      {[1, 2, 3, 4, 5, 6, 7, 8, 9, 10].map(star => (
        <span
          key={star}
          className={`star ${(hoverValue || value) >= star ? 'filled' : ''}`}
          onClick={() => !readonly && onChange(star)}
          onMouseEnter={() => !readonly && setHoverValue(star)}
          onMouseLeave={() => !readonly && setHoverValue(0)}
        >
          ‚òÖ
        </span>
      ))}
    </div>
  );
}

// Teacher Profile Modal  
function TeacherProfileModal({ teacher, onClose, onGiveFeedback, averageRating }) {
  return (
    <div className="modal-overlay" onClick={onClose}>
      <div className="modal-content" onClick={e => e.stopPropagation()}>
        <div className="p-6">
          <div className="flex justify-between items-start mb-4">
            <h2 className="text-2xl font-bold">{teacher.name}</h2>
            <button onClick={onClose} className="text-2xl font-bold text-gray-500 hover:text-gray-700">
              √ó
            </button>
          </div>
          
          <div className="space-y-4">
            <div>
              <h3 className="font-bold text-lg mb-2">Subject</h3>
              <p className="text-gray-700">{teacher.subject}</p>
            </div>
            
            <div>
              <h3 className="font-bold text-lg mb-2">Education Qualification</h3>
              <p className="text-gray-700">{teacher.qualification || 'Not specified'}</p>
            </div>
            
            <div>
              <h3 className="font-bold text-lg mb-2">Experience</h3>
              <p className="text-gray-700">{teacher.experience || 'Not specified'}</p>
            </div>
            
            <div>
              <h3 className="font-bold text-lg mb-2">Average Rating</h3>
              <div className="flex items-center gap-3">
                <span className="text-3xl font-bold text-yellow-500">
                  {averageRating ? averageRating.toFixed(1) : 'N/A'}
                </span>
                <span className="text-gray-600">/ 10</span>
                {averageRating && (
                  <span className={`rating-badge ${
                    averageRating >= 8 ? 'rating-excellent' :
                    averageRating >= 6 ? 'rating-good' :
                    averageRating >= 4 ? 'rating-average' : 'rating-poor'
                  }`}>
                    {averageRating >= 8 ? '‚≠ê Excellent' :
                     averageRating >= 6 ? 'üëç Good' :
                     averageRating >= 4 ? 'üòê Average' : 'üëé Needs Improvement'}
                  </span>
                )}
              </div>
            </div>
            
            <button
              onClick={onGiveFeedback}
              className="w-full avanti-gradient text-white py-3 rounded-xl font-bold text-lg hover:opacity-90"
            >
              üìù Give Feedback
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}

// Teacher Feedback Form Modal
function TeacherFeedbackForm({ teacher, studentId, onClose, onSubmitSuccess }) {
  const [currentQuestion, setCurrentQuestion] = useState(0);
  const [feedback, setFeedback] = useState({
    teacherId: teacher.docId,
    teacherName: teacher.name,
    subject: teacher.subject,
    studentId: studentId,
    submittedAt: new Date().toISOString(),
    responses: {}
  });
  const [showExplanation, setShowExplanation] = useState(false);

  const questions = [
    { id: 'q1', text: 'The content was at an appropriate level', type: 'rating' },
    { id: 'q2', text: 'The content was relevant to my subject', type: 'rating' },
    { id: 'q3', text: 'Has the teacher covered relevant topics beyond the syllabus', type: 'rating' },
    { id: 'q4', text: 'Effectiveness of teachers in terms of Technical content', type: 'rating' },
    { id: 'q5', text: 'Effectiveness of teachers in terms of communication skills', type: 'rating' },
    { id: 'q6', text: 'The teacher discusses topic details', type: 'rating' },
    { id: 'q7', text: 'The teacher possesses deep knowledge of the subject taught', type: 'rating' },
    { id: 'q8', text: 'The teacher communicates clearly', type: 'rating' },
    { id: 'q9', text: 'The teacher inspires me by his/her knowledge through examples, real life examples, relevant props', type: 'rating' },
    { id: 'q10', text: 'The Teacher comes to the class on time', type: 'yesno' },
    { id: 'q11', text: 'The teacher engages the class for the full duration and complete the course in time', type: 'rating' },
    { id: 'q12', text: 'The teacher comes fully prepared for the class', type: 'rating' },
    { id: 'q13', text: 'The teacher provides guidance and counselling in academic and non-academic matters', type: 'rating' },
    { id: 'q14', text: 'Overall effectiveness', type: 'rating' },
    { id: 'q15', text: 'Learning value (in terms of skills, concepts, knowledge, analytical abilities)', type: 'rating' },
    { id: 'q16', text: `Any Improvements or suggestions for ${teacher.name} you want to share?`, type: 'opentext' },
    { id: 'q17', text: 'Anything you want to share regarding the Avanti Program? How can we improve this more?', type: 'opentext' }
  ];

  const currentQ = questions[currentQuestion];

  const handleRatingChange = (value) => {
    setFeedback({
      ...feedback,
      responses: {
        ...feedback.responses,
        [currentQ.id]: { rating: value }
      }
    });
    setShowExplanation(value < 6);
  };

  const handleYesNoChange = (value) => {
    setFeedback({
      ...feedback,
      responses: {
        ...feedback.responses,
        [currentQ.id]: { answer: value }
      }
    });
    setShowExplanation(value === 'No');
  };

  const handleOpenTextChange = (text) => {
    setFeedback({
      ...feedback,
      responses: {
        ...feedback.responses,
        [currentQ.id]: { text: text }
      }
    });
  };

  const handleExplanationChange = (text) => {
    setFeedback({
      ...feedback,
      responses: {
        ...feedback.responses,
        [currentQ.id]: {
          ...feedback.responses[currentQ.id],
          explanation: text
        }
      }
    });
  };

  const canProceed = () => {
    const response = feedback.responses[currentQ.id];
    if (!response) return false;
    
    if (currentQ.type === 'rating') {
      if (!response.rating) return false;
      if (response.rating < 6 && !response.explanation) return false;
    } else if (currentQ.type === 'yesno') {
      if (!response.answer) return false;
      if (response.answer === 'No' && !response.explanation) return false;
    } else if (currentQ.type === 'opentext') {
      if (!response.text || response.text.trim() === '') return false;
    }
    return true;
  };

  const handleNext = () => {
    if (currentQuestion < questions.length - 1) {
      setCurrentQuestion(currentQuestion + 1);
      const nextQ = questions[currentQuestion + 1];
      const nextResponse = feedback.responses[nextQ.id];
      if (nextQ.type === 'rating') {
        setShowExplanation(nextResponse?.rating < 6);
      } else if (nextQ.type === 'yesno') {
        setShowExplanation(nextResponse?.answer === 'No');
      } else if (nextQ.type === 'opentext') {
        setShowExplanation(false);
      }
    }
  };

  const handlePrevious = () => {
    if (currentQuestion > 0) {
      setCurrentQuestion(currentQuestion - 1);
      const prevQ = questions[currentQuestion - 1];
      const prevResponse = feedback.responses[prevQ.id];
      if (prevQ.type === 'rating') {
        setShowExplanation(prevResponse?.rating < 6);
      } else if (prevQ.type === 'yesno') {
        setShowExplanation(prevResponse?.answer === 'No');
      } else if (prevQ.type === 'opentext') {
        setShowExplanation(false);
      }
    }
  };

  const handleSubmit = async () => {
    try {
      let totalRating = 0;
      let ratingCount = 0;
      Object.values(feedback.responses).forEach(response => {
        if (response.rating) {
          totalRating += response.rating;
          ratingCount++;
        }
      });
      const averageRating = ratingCount > 0 ? totalRating / ratingCount : 0;

      const feedbackData = {
        ...feedback,
        averageRating: averageRating,
        completedAt: new Date().toISOString()
      };

      await db.collection('teacherFeedback').add(feedbackData);
      
      await db.collection('studentProfiles').doc(studentId).set({
        lastFeedbackDate: new Date().toISOString()
      }, { merge: true });

      alert('Feedback submitted successfully! Thank you for your input.');
      onSubmitSuccess();
      onClose();
    } catch (error) {
      console.error('Error submitting feedback:', error);
      alert('Failed to submit feedback. Please try again.');
    }
  };

  return (
    <div className="feedback-modal" onClick={onClose}>
      <div className="feedback-content" onClick={e => e.stopPropagation()}>
        <div className="p-6">
          <div className="flex justify-between items-start mb-4">
            <div>
              <h2 className="text-2xl font-bold">Feedback for {teacher.name}</h2>
              <p className="text-gray-600">{teacher.subject}</p>
            </div>
            <button onClick={onClose} className="text-2xl font-bold text-gray-500 hover:text-gray-700">
              √ó
            </button>
          </div>

          <div className="mb-6">
            <div className="flex justify-between items-center mb-2">
              <span className="text-sm font-semibold text-gray-600">
                Question {currentQuestion + 1} of {questions.length}
              </span>
              <span className="text-sm text-gray-500">
                {Math.round(((currentQuestion + 1) / questions.length) * 100)}% Complete
              </span>
            </div>
            <div className="w-full bg-gray-200 rounded-full h-2">
              <div 
                className="avanti-gradient h-2 rounded-full transition-all duration-300"
                style={{ width: `${((currentQuestion + 1) / questions.length) * 100}%` }}
              ></div>
            </div>
          </div>

          <div className="space-y-6">
            <div>
              <h3 className="text-lg font-semibold mb-4">{currentQ.text}</h3>
              
              {currentQ.type === 'rating' && (
                <div className="flex flex-col items-center gap-4">
                  <StarRating
                    value={feedback.responses[currentQ.id]?.rating || 0}
                    onChange={handleRatingChange}
                  />
                  <div className="text-center text-sm text-gray-600">
                    {feedback.responses[currentQ.id]?.rating || 0} / 10
                  </div>
                </div>
              )}

              {currentQ.type === 'yesno' && (
                <div className="flex gap-4 justify-center">
                  <button
                    onClick={() => handleYesNoChange('Yes')}
                    className={`px-8 py-3 rounded-xl font-bold text-lg ${
                      feedback.responses[currentQ.id]?.answer === 'Yes'
                        ? 'bg-green-500 text-white'
                        : 'bg-gray-200 text-gray-700'
                    }`}
                  >
                    ‚úÖ Yes
                  </button>
                  <button
                    onClick={() => handleYesNoChange('No')}
                    className={`px-8 py-3 rounded-xl font-bold text-lg ${
                      feedback.responses[currentQ.id]?.answer === 'No'
                        ? 'bg-red-500 text-white'
                        : 'bg-gray-200 text-gray-700'
                    }`}
                  >
                    ‚ùå No
                  </button>
                </div>
              )}

              {currentQ.type === 'opentext' && (
                <div className="mt-2">
                  <textarea
                    value={feedback.responses[currentQ.id]?.text || ''}
                    onChange={(e) => handleOpenTextChange(e.target.value)}
                    className="w-full border-2 px-4 py-3 rounded-xl min-h-[120px] focus:border-yellow-500 focus:ring-2 focus:ring-yellow-200"
                    placeholder="Please share your thoughts here..."
                  />
                  <p className="text-sm text-gray-500 mt-2">Your feedback helps us improve!</p>
                </div>
              )}

              {showExplanation && (
                <div className="mt-4">
                  <label className="block text-sm font-semibold mb-2 text-gray-700">
                    {currentQ.type === 'rating' 
                      ? 'Why do you feel it\'s very low/Average?' 
                      : 'Can you please explain why?'}
                  </label>
                  <textarea
                    value={feedback.responses[currentQ.id]?.explanation || ''}
                    onChange={(e) => handleExplanationChange(e.target.value)}
                    className="w-full border-2 px-4 py-3 rounded-xl min-h-[100px]"
                    placeholder="Please provide your explanation..."
                  />
                </div>
              )}
            </div>

            <div className="flex justify-between gap-3">
              <button
                onClick={handlePrevious}
                disabled={currentQuestion === 0}
                className="px-6 py-3 bg-gray-300 text-gray-700 rounded-xl font-semibold disabled:opacity-50 disabled:cursor-not-allowed"
              >
                ‚Üê Previous
              </button>
              
              {currentQuestion < questions.length - 1 ? (
                <button
                  onClick={handleNext}
                  disabled={!canProceed()}
                  className="px-6 py-3 avanti-gradient text-white rounded-xl font-semibold disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  Next ‚Üí
                </button>
              ) : (
                <button
                  onClick={handleSubmit}
                  disabled={!canProceed()}
                  className="px-6 py-3 bg-green-600 text-white rounded-xl font-semibold disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  ‚úì Submit Feedback
                </button>
              )}
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}

// Feedback Notification Component
function FeedbackNotification({ onClose, onGiveFeedback }) {
  return (
    <div className="feedback-notification">
      <div className="flex items-start gap-3">
        <div className="text-2xl">üìù</div>
        <div className="flex-1">
          <div className="font-bold text-lg mb-1">Time for Teacher Feedback!</div>
          <p className="text-sm mb-3">
            It\'s been 2 months since your last feedback. Please share your thoughts about your teachers.
          </p>
          <div className="flex gap-2">
            <button
              onClick={onGiveFeedback}
              className="px-4 py-2 bg-white text-gray-800 rounded-lg font-semibold text-sm hover:bg-gray-100"
            >
              Give Feedback Now
            </button>
            <button
              onClick={onClose}
              className="px-4 py-2 bg-transparent border-2 border-white text-white rounded-lg font-semibold text-sm hover:bg-white hover:text-gray-800"
            >
              Remind Later
            </button>
          </div>
        </div>
        <button onClick={onClose} className="text-xl font-bold text-white hover:text-gray-200">
          √ó
        </button>
      </div>
    </div>
  );
}


// ========================================
// STUDENT SYSTEM CONSTANTS (ADD THIS)
// ========================================
const CATEGORIES=['General','General EWS','OBC','SC','ST','PWD'];
const STREAMS=['JEE','NEET'];
const OCCUPATIONS=['Government Job','Private Job','Business','Farmer','Doctor','Engineer','Teacher','Self-Employed','Unemployed','Retired','Daily Wage Worker','Homemaker','Others'];
const EDUCATION_LEVELS=['1st to 5th Standard','6th to 10th Standard','11th to 12th Standard','Graduation - B.A.','Graduation - B.Sc.','Graduation - B.Com','Post Graduation - M.A.','Post Graduation - M.Sc.','Post Graduation - M.Com','Engineering - B.Tech/B.E.','Ph.D','Diploma','ITI','Others'];
const INCOME_RANGES=['Below ‚Çπ1 Lakh','‚Çπ1 - ‚Çπ2.5 Lakh','‚Çπ2.5 - ‚Çπ5 Lakh','‚Çπ5 - ‚Çπ10 Lakh','‚Çπ10 - ‚Çπ15 Lakh','‚Çπ15 - ‚Çπ25 Lakh','Above ‚Çπ25 Lakh'];
const EXAMS_12TH=['JEE Mains Session 1','JEE Mains Session 2','JEE Advanced','NEET UG','NDA','BITSAT','VITEEE','COMEDK','MHT CET','TS EAMCET','AP EAMCET','KCET','WBJEE'];
const EXAMS_11TH=['JEE Mains','JEE Advanced','NEET UG','KVPY','NTSE','Olympiads','BITSAT','VITEEE'];
const INDIAN_STATES=['Andhra Pradesh','Arunachal Pradesh','Assam','Bihar','Chhattisgarh','Goa','Gujarat','Haryana','Himachal Pradesh','Jharkhand','Karnataka','Kerala','Madhya Pradesh','Maharashtra','Manipur','Meghalaya','Mizoram','Nagaland','Odisha','Punjab','Rajasthan','Sikkim','Tamil Nadu','Telangana','Tripura','Uttar Pradesh','Uttarakhand','West Bengal'];
const STATE_DISTRICTS={
  'Andhra Pradesh':['Anantapur','Chittoor','East Godavari','Guntur','Krishna','Kurnool','Prakasam','Srikakulam','Visakhapatnam','Vizianagaram','West Godavari','YSR Kadapa'],
  'Madhya Pradesh':['Agar Malwa','Alirajpur','Anuppur','Ashoknagar','Balaghat','Barwani','Betul','Bhind','Bhopal','Burhanpur','Chhatarpur','Chhindwara','Damoh','Datia','Dewas','Dhar','Dindori','Guna','Gwalior','Harda','Hoshangabad','Indore','Jabalpur','Jhabua','Katni','Khandwa','Khargone','Mandla','Mandsaur','Morena','Narsinghpur','Neemuch','Panna','Raisen','Rajgarh','Ratlam','Rewa','Sagar','Satna','Sehore','Seoni','Shahdol','Shajapur','Sheopur','Shivpuri','Sidhi','Singrauli','Tikamgarh','Ujjain','Umaria','Vidisha'],
  'Maharashtra':['Ahmednagar','Akola','Amravati','Aurangabad','Beed','Bhandara','Buldhana','Chandrapur','Dhule','Gadchiroli','Gondia','Hingoli','Jalgaon','Jalna','Kolhapur','Latur','Mumbai City','Mumbai Suburban','Nagpur','Nanded','Nandurbar','Nashik','Osmanabad','Palghar','Parbhani','Pune','Raigad','Ratnagiri','Sangli','Satara','Sindhudurg','Solapur','Thane','Wardha','Washim','Yavatmal'],
  'Gujarat':['Ahmedabad','Amreli','Anand','Aravalli','Banaskantha','Bharuch','Bhavnagar','Botad','Chhota Udaipur','Dahod','Dang','Devbhoomi Dwarka','Gandhinagar','Gir Somnath','Jamnagar','Junagadh','Kheda','Kutch','Mahisagar','Mehsana','Morbi','Narmada','Navsari','Panchmahal','Patan','Porbandar','Rajkot','Sabarkantha','Surat','Surendranagar','Tapi','Vadodara','Valsad'],
  'Rajasthan':['Ajmer','Alwar','Banswara','Baran','Barmer','Bharatpur','Bhilwara','Bikaner','Bundi','Chittorgarh','Churu','Dausa','Dholpur','Dungarpur','Hanumangarh','Jaipur','Jaisalmer','Jalore','Jhalawar','Jhunjhunu','Jodhpur','Karauli','Kota','Nagaur','Pali','Pratapgarh','Rajsamand','Sawai Madhopur','Sikar','Sirohi','Sri Ganganagar','Tonk','Udaipur'],
  'Karnataka':['Bagalkot','Ballari','Belagavi','Bengaluru Rural','Bengaluru Urban','Bidar','Chamarajanagar','Chikkaballapur','Chikkamagaluru','Chitradurga','Dakshina Kannada','Davanagere','Dharwad','Gadag','Hassan','Haveri','Kalaburagi','Kodagu','Kolar','Koppal','Mandya','Mysuru','Raichur','Ramanagara','Shivamogga','Tumakuru','Udupi','Uttara Kannada','Vijayapura','Yadgir'],
  'Odisha':['Angul','Balangir','Balasore','Bargarh','Bhadrak','Boudh','Cuttack','Deogarh','Dhenkanal','Gajapati','Ganjam','Jagatsinghpur','Jajpur','Jharsuguda','Kalahandi','Kandhamal','Kendrapara','Kendujhar','Khordha','Koraput','Malkangiri','Mayurbhanj','Nabarangpur','Nayagarh','Nuapada','Puri','Rayagada','Sambalpur','Subarnapur','Sundargarh']
};
const AVANTI_LOGO = 'data:image/png;base64,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';
const exportToExcel=(data,filename)=>{const ws=XLSX.utils.json_to_sheet(data);const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,"Data");XLSX.writeFile(wb,`${filename}_${new Date().toISOString().slice(0,10)}.xlsx`)};
const getBirthdays=(teachers,period='week')=>{const now=new Date();return teachers.filter(t=>{if(!t.dob)return false;const d=new Date(t.dob);const thisYear=new Date(now.getFullYear(),d.getMonth(),d.getDate());const diff=Math.ceil((thisYear-now)/(1000*60*60*24));if(period==='today'){return d.getDate()===now.getDate()&&d.getMonth()===now.getMonth()}else if(period==='week'){return diff>=0&&diff<=7}else if(period==='month'){return d.getMonth()===now.getMonth()}return false})};
const getAnniversaries=(teachers,period='week')=>{const now=new Date();return teachers.filter(t=>{if(!t.joiningDate)return false;const j=new Date(t.joiningDate);if(j.getFullYear()>=now.getFullYear())return false;const thisYear=new Date(now.getFullYear(),j.getMonth(),j.getDate());const diff=Math.ceil((thisYear-now)/(1000*60*60*24));if(period==='today'){return j.getDate()===now.getDate()&&j.getMonth()===now.getMonth()}else if(period==='week'){return diff>=0&&diff<=7}else if(period==='month'){return j.getMonth()===now.getMonth()}return false})};
const getTodayDate=()=>{
const today=new Date();
  return today.toISOString().split('T')[0];
};

const getMonthYear=(date)=>{
  const d=new Date(date);
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
};

const getAttendanceStats=(attendanceRecords,filterDate=null)=>{
  if(filterDate){
    const filtered=attendanceRecords.filter(r=>r.date===filterDate);
    const present=filtered.filter(r=>r.status==='Present').length;
    return{total:filtered.length,present,absent:filtered.length-present};
  }
  const present=attendanceRecords.filter(r=>r.status==='Present').length;
  return{total:attendanceRecords.length,present,absent:attendanceRecords.length-present};
};

const getMonthlyAttendanceStats=(attendanceRecords,month)=>{
  const filtered=attendanceRecords.filter(r=>getMonthYear(r.date)===month);
  const dayStats={};
  filtered.forEach(record=>{
    if(!dayStats[record.date]){
      dayStats[record.date]={present:0,absent:0};
    }
    if(record.status==='Present'){
      dayStats[record.date].present++;
    }else{
      dayStats[record.date].absent++;
    }
  });
  return dayStats;
};
const getChapterStatus=(chapter,progress)=>{
  if(!chapter.targetDate){
    return{label:'No Target',color:'pending',class:'status-delayed'}
  }
  const targetDate=new Date(chapter.targetDate);
  const today=new Date();
  const completionDate=progress.completionDate?new Date(progress.completionDate):null;
  
  // ‚úÖ FIXED: Check if test is NOT 'Yes' (handles both 'No' and undefined)
  if(progress.completed==='Yes'&&progress.testConducted!=='Yes'){
    return{label:'‚ö†Ô∏è Test Pending',color:'delayed',class:'status-delayed'}
  }
  
  // Only show green when BOTH are Yes
  if(progress.completed==='Yes'&&progress.testConducted==='Yes'){
    if(completionDate){
      if(completionDate<targetDate){
        return{label:'Ahead - Good Job! üéâ',color:'completed',class:'status-ahead'}
      }else if(completionDate.toDateString()===targetDate.toDateString()){
        return{label:'On Track ‚úì',color:'completed',class:'status-ontrack'}
      }else{
        return{label:'Completed (Late)',color:'delayed',class:'status-delayed'}
      }
    }
    return{label:'Completed ‚úì',color:'completed',class:'status-ahead'}
  }
  
  if(today>targetDate){
    return{label:'Delayed ‚ö†Ô∏è',color:'delayed',class:'status-delayed'}
  }
  return{label:'Pending',color:'pending',class:'status-delayed'}
};
// ====================================
// INSTALL PROMPT COMPONENT (PWA)
// ====================================
function InstallPrompt(){
  const[deferredPrompt,setDeferredPrompt]=useState(null);
  const[showInstall,setShowInstall]=useState(false);

  useEffect(()=>{
    const handler=(e)=>{
      e.preventDefault();
      setDeferredPrompt(e);
      setShowInstall(true);
    };
    window.addEventListener('beforeinstallprompt',handler);
    
    // Check if already installed
    if(window.matchMedia('(display-mode: standalone)').matches){
      setShowInstall(false);
    }
    
    return()=>window.removeEventListener('beforeinstallprompt',handler);
  },[]);

  const handleInstall=async()=>{
    if(!deferredPrompt)return;
    deferredPrompt.prompt();
    const{outcome}=await deferredPrompt.userChoice;
    setDeferredPrompt(null);
    setShowInstall(false);
  };

  const handleDismiss=()=>{
    setShowInstall(false);
    localStorage.setItem('installDismissed','true');
  };

  // Don't show if dismissed
  if(localStorage.getItem('installDismissed')==='true')return null;
  if(!showInstall)return null;

  return(
    <div className="fixed bottom-4 left-4 right-4 bg-gradient-to-r from-blue-600 to-purple-600 text-white p-4 rounded-2xl shadow-2xl z-[9999] animate-bounce">
      <div className="flex items-center justify-between gap-3">
        <div className="flex-1">
          <p className="font-bold text-lg flex items-center gap-2">
            üì± Install Mobile App
          </p>
          <p className="text-sm opacity-90 mt-1">
            Use like a mobile app - faster & works offline!
          </p>
        </div>
        <div className="flex gap-2">
          <button 
            onClick={handleInstall}
            className="px-6 py-3 bg-white text-blue-600 rounded-xl font-bold hover:bg-gray-100 transition-all"
          >
            Install
          </button>
          <button 
            onClick={handleDismiss}
            className="px-3 py-3 bg-white/20 text-white rounded-xl hover:bg-white/30 transition-all"
          >
            ‚úï
          </button>
        </div>
      </div>
    </div>
  );
}
// ========================================
// STUDENT PROFILE FORM COMPONENT
// ========================================
function StudentProfileForm({ currentUser }) {
  const myId = currentUser.studentId || currentUser.id;

  const [profile, setProfile] = useState({
    firstName: '',
    lastName: '',
    email: '',
    phone: '',
    dob: '',
    grade: currentUser.grade || '',
    category: '',
    stream: '',
    school: currentUser.school || '',
    fatherName: '',
    motherName: '',
    fatherOccupation: '',
    fatherOccupationOther: '',
    motherOccupation: '',
    motherOccupationOther: '',
    fatherEducation: '',
    fatherEducationOther: '',
    motherEducation: '',
    motherEducationOther: '',
    familyIncome: '',
    address: '',
    state: '',
    stateOther: '',
    district: '',
    districtOther: '',
    pincode: '',
    whatsappNumber: '',
    percentage10th: '',
    percentage11th: ''
  });

  const [loading, setLoading] = useState(true);
  const [isEditing, setIsEditing] = useState(false);

  useEffect(() => {
    const fetchProfile = async () => {
      try {
        setLoading(true);
        const docSnap = await db.collection('studentProfiles').doc(myId).get();
        if (docSnap.exists) {
          setProfile(prev => ({ ...prev, ...docSnap.data() }));
        }
        setLoading(false);
      } catch (e) {
        console.error('Error fetching profile:', e);
        setLoading(false);
      }
    };
    fetchProfile();
  }, [myId]);

  const calculateCompletion = () => {
    const requiredFields = [
      'firstName', 'lastName', 'email', 'phone', 'dob', 'grade', 'category',
      'stream', 'school', 'fatherName', 'motherName', 'fatherOccupation',
      'motherOccupation', 'fatherEducation', 'motherEducation', 'familyIncome',
      'address', 'state', 'district', 'pincode', 'whatsappNumber', 'percentage10th'
    ];
    const filled = requiredFields.filter(
      field => profile[field] && String(profile[field]).trim() !== ''
    ).length;
    return Math.round((filled / requiredFields.length) * 100);
  };

  const handleSave = async () => {
    try {
      await db.collection('studentProfiles').doc(myId).set({
        ...profile,
        studentId: myId,
        updatedAt: new Date().toISOString()
      });
      alert('‚úÖ Profile saved successfully!');
      return true;
    } catch (error) {
      console.error('Error saving profile:', error);
      alert('‚ùå Error saving profile: ' + error.message);
      return false;
    }
  };

  const handleToggleEdit = async () => {
    if (isEditing) {
      // closing edit ‚Üí save
      const saved = await handleSave();
      if (saved) {
        setIsEditing(false);
      }
    } else {
      setIsEditing(true);
    }
  };

  const completion = calculateCompletion();

  const inputCls = (extra = '') =>
    `w-full border-2 px-4 py-3 rounded-xl ${extra} ${
      !isEditing ? 'bg-gray-100 cursor-not-allowed' : ''
    }`;

  const disabled = !isEditing;

  if (loading) {
    return <div className="text-center py-8">Loading profile...</div>;
  }

  return (
    <div className="space-y-6">
      <div className="flex justify-between items-center">
        <h2 className="text-3xl font-bold">üë§ My Profile</h2>
        <div className="flex items-center gap-4">
          <div className="text-right">
            <div className="text-sm text-gray-600">Profile Completion</div>
            <div
              className="text-3xl font-bold"
              style={{
                color:
                  completion >= 80
                    ? '#10B981'
                    : completion >= 50
                    ? '#F59E0B'
                    : '#EF4444'
              }}
            >
              {completion}%
            </div>
          </div>
          <button
            onClick={handleToggleEdit}
            className="px-4 py-2 bg-blue-600 text-white rounded-xl font-semibold"
          >
            {isEditing ? 'Save' : 'Edit'}
          </button>
        </div>
      </div>

      {completion < 100 && (
        <div className="bg-orange-50 border-2 border-orange-300 p-4 rounded-xl">
          <p className="text-orange-800 font-semibold">
            ‚ö†Ô∏è Click Edit, complete your profile and then press Save.
          </p>
        </div>
      )}

      <div className="bg-white p-6 rounded-2xl shadow-lg space-y-6">
        {/* Personal Information */}
        <div className="border-4 border-blue-500 rounded-2xl p-6 bg-blue-50">
          <h3 className="text-2xl font-bold mb-4 text-blue-800">üìã Personal Information</h3>
          <div className="grid md:grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-bold mb-2">First Name *</label>
              <input
                type="text"
                value={profile.firstName}
                disabled={disabled}
                onChange={e => setProfile({ ...profile, firstName: e.target.value })}
                className={inputCls()}
              />
            </div>
            <div>
              <label className="block text-sm font-bold mb-2">Last Name *</label>
              <input
                type="text"
                value={profile.lastName}
                disabled={disabled}
                onChange={e => setProfile({ ...profile, lastName: e.target.value })}
                className={inputCls()}
              />
            </div>
            <div>
              <label className="block text-sm font-bold mb-2">Email ID *</label>
              <input
                type="email"
                value={profile.email}
                disabled={disabled}
                onChange={e => setProfile({ ...profile, email: e.target.value })}
                className={inputCls()}
              />
            </div>
            <div>
              <label className="block text-sm font-bold mb-2">Phone Number *</label>
              <input
                type="tel"
                value={profile.phone}
                disabled={disabled}
                onChange={e => setProfile({ ...profile, phone: e.target.value })}
                className={inputCls()}
              />
            </div>
            <div>
              <label className="block text-sm font-bold mb-2">Date of Birth *</label>
              <input
                type="date"
                value={profile.dob}
                disabled={disabled}
                onChange={e => setProfile({ ...profile, dob: e.target.value })}
                className={inputCls()}
              />
            </div>
            <div>
              <label className="block text-sm font-bold mb-2">Class *</label>
              <select
                value={profile.grade}
                disabled={disabled}
                onChange={e => setProfile({ ...profile, grade: e.target.value })}
                className={inputCls()}
              >
                <option value="">Select</option>
                <option value="11">11th</option>
                <option value="12">12th</option>
              </select>
            </div>
            <div>
              <label className="block text-sm font-bold mb-2">Category *</label>
              <select
                value={profile.category}
                disabled={disabled}
                onChange={e => setProfile({ ...profile, category: e.target.value })}
                className={inputCls()}
              >
                <option value="">Select</option>
                {CATEGORIES.map(c => (
                  <option key={c} value={c}>{c}</option>
                ))}
              </select>
            </div>
            <div>
              <label className="block text-sm font-bold mb-2">Stream *</label>
              <select
                value={profile.stream}
                disabled={disabled}
                onChange={e => setProfile({ ...profile, stream: e.target.value })}
                className={inputCls()}
              >
                <option value="">Select</option>
                {STREAMS.map(s => (
                  <option key={s} value={s}>{s}</option>
                ))}
              </select>
            </div>
            <div>
              <label className="block text-sm font-bold mb-2">School *</label>
              <select
                value={profile.school}
                disabled={disabled}
                onChange={e => setProfile({ ...profile, school: e.target.value })}
                className={inputCls()}
              >
                <option value="">Select</option>
                {SCHOOLS.map(s => (
                  <option key={s} value={s}>{s}</option>
                ))}
              </select>
            </div>
            <div>
              <label className="block text-sm font-bold mb-2">
                10th Overall Percentage *
              </label>
              <input
                type="number"
                step="0.01"
                value={profile.percentage10th}
                disabled={disabled}
                onChange={e => setProfile({ ...profile, percentage10th: e.target.value })}
                className={inputCls()}
                placeholder="e.g. 85.5"
              />
            </div>
            <div>
              <label className="block text-sm font-bold mb-2">
                11th Overall Percentage (Optional)
              </label>
              <input
                type="number"
                step="0.01"
                value={profile.percentage11th}
                disabled={disabled}
                onChange={e => setProfile({ ...profile, percentage11th: e.target.value })}
                className={inputCls()}
                placeholder="e.g. 80.0"
              />
            </div>
          </div>
        </div>

        {/* Parent Information */}
        <div className="border-4 border-purple-500 rounded-2xl p-6 bg-purple-50">
          <h3 className="text-2xl font-bold mb-4 text-purple-800">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Parent Information</h3>
          <div className="grid md:grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-bold mb-2">Father's Name *</label>
              <input
                type="text"
                value={profile.fatherName}
                disabled={disabled}
                onChange={e => setProfile({ ...profile, fatherName: e.target.value })}
                className={inputCls()}
              />
            </div>
            <div>
              <label className="block text-sm font-bold mb-2">Mother's Name *</label>
              <input
                type="text"
                value={profile.motherName}
                disabled={disabled}
                onChange={e => setProfile({ ...profile, motherName: e.target.value })}
                className={inputCls()}
              />
            </div>
            <div>
              <label className="block text-sm font-bold mb-2">Father's Occupation *</label>
              <select
                value={profile.fatherOccupation}
                disabled={disabled}
                onChange={e => setProfile({ ...profile, fatherOccupation: e.target.value, fatherOccupationOther: '' })}
                className={inputCls()}
              >
                <option value="">Select Occupation</option>
                {OCCUPATIONS.map(o => <option key={o} value={o}>{o}</option>)}
              </select>
              {profile.fatherOccupation === 'Others' && (
                <input
                  type="text"
                  placeholder="Please specify occupation"
                  value={profile.fatherOccupationOther}
                  disabled={disabled}
                  onChange={e => setProfile({ ...profile, fatherOccupationOther: e.target.value })}
                  className={inputCls('mt-2')}
                />
              )}
            </div>
            <div>
              <label className="block text-sm font-bold mb-2">Mother's Occupation *</label>
              <select
                value={profile.motherOccupation}
                disabled={disabled}
                onChange={e => setProfile({ ...profile, motherOccupation: e.target.value, motherOccupationOther: '' })}
                className={inputCls()}
              >
                <option value="">Select Occupation</option>
                {OCCUPATIONS.map(o => <option key={o} value={o}>{o}</option>)}
              </select>
              {profile.motherOccupation === 'Others' && (
                <input
                  type="text"
                  placeholder="Please specify occupation"
                  value={profile.motherOccupationOther}
                  disabled={disabled}
                  onChange={e => setProfile({ ...profile, motherOccupationOther: e.target.value })}
                  className={inputCls('mt-2')}
                />
              )}
            </div>
            <div>
              <label className="block text-sm font-bold mb-2">Father's Education *</label>
              <select
                value={profile.fatherEducation}
                disabled={disabled}
                onChange={e => setProfile({ ...profile, fatherEducation: e.target.value, fatherEducationOther: '' })}
                className={inputCls()}
              >
                <option value="">Select Education</option>
                {EDUCATION_LEVELS.map(e => <option key={e} value={e}>{e}</option>)}
              </select>
              {profile.fatherEducation === 'Others' && (
                <input
                  type="text"
                  placeholder="Please specify education"
                  value={profile.fatherEducationOther}
                  disabled={disabled}
                  onChange={e => setProfile({ ...profile, fatherEducationOther: e.target.value })}
                  className={inputCls('mt-2')}
                />
              )}
            </div>
            <div>
              <label className="block text-sm font-bold mb-2">Mother's Education *</label>
              <select
                value={profile.motherEducation}
                disabled={disabled}
                onChange={e => setProfile({ ...profile, motherEducation: e.target.value, motherEducationOther: '' })}
                className={inputCls()}
              >
                <option value="">Select Education</option>
                {EDUCATION_LEVELS.map(e => <option key={e} value={e}>{e}</option>)}
              </select>
              {profile.motherEducation === 'Others' && (
                <input
                  type="text"
                  placeholder="Please specify education"
                  value={profile.motherEducationOther}
                  disabled={disabled}
                  onChange={e => setProfile({ ...profile, motherEducationOther: e.target.value })}
                  className={inputCls('mt-2')}
                />
              )}
            </div>
            <div>
              <label className="block text-sm font-bold mb-2">Family Income *</label>
              <select
                value={profile.familyIncome}
                disabled={disabled}
                onChange={e => setProfile({ ...profile, familyIncome: e.target.value })}
                className={inputCls()}
              >
                <option value="">Select Income Range</option>
                {INCOME_RANGES.map(i => <option key={i} value={i}>{i}</option>)}
              </select>
            </div>
          </div>
        </div>

        {/* Contact Details */}
        <div className="border-4 border-green-500 rounded-2xl p-6 bg-green-50">
          <h3 className="text-2xl font-bold mb-4 text-green-800">üìÆ Contact Details</h3>
          <div className="grid md:grid-cols-2 gap-4">
            <div className="md:col-span-2">
              <label className="block text-sm font-bold mb-2">Address *</label>
              <input
                type="text"
                value={profile.address}
                disabled={disabled}
                onChange={e => setProfile({ ...profile, address: e.target.value })}
                className={inputCls()}
              />
            </div>
            <div>
              <label className="block text-sm font-bold mb-2">State *</label>
              <select
                value={profile.state}
                disabled={disabled}
                onChange={e => setProfile({ ...profile, state: e.target.value, district: '', districtOther: '' })}
                className={inputCls()}
              >
                <option value="">Select State</option>
                {INDIAN_STATES.map(s => <option key={s} value={s}>{s}</option>)}
                <option value="Others">Others</option>
              </select>
              {profile.state === 'Others' && (
                <input
                  type="text"
                  placeholder="Please specify state"
                  value={profile.stateOther}
                  disabled={disabled}
                  onChange={e => setProfile({ ...profile, stateOther: e.target.value })}
                  className={inputCls('mt-2')}
                />
              )}
            </div>
            <div>
              <label className="block text-sm font-bold mb-2">District *</label>
              <select
                value={profile.district}
                disabled={disabled || !profile.state || profile.state === 'Others'}
                onChange={e => setProfile({ ...profile, district: e.target.value, districtOther: '' })}
                className={inputCls()}
              >
                <option value="">Select District</option>
                {profile.state && profile.state !== 'Others' && STATE_DISTRICTS[profile.state] && 
                  STATE_DISTRICTS[profile.state].map(d => <option key={d} value={d}>{d}</option>)}
                <option value="Others">Others</option>
              </select>
              {profile.district === 'Others' && (
                <input
                  type="text"
                  placeholder="Please specify district"
                  value={profile.districtOther}
                  disabled={disabled}
                  onChange={e => setProfile({ ...profile, districtOther: e.target.value })}
                  className={inputCls('mt-2')}
                />
              )}
            </div>
            <div>
              <label className="block text-sm font-bold mb-2">Pincode *</label>
              <input
                type="text"
                value={profile.pincode}
                disabled={disabled}
                onChange={e => setProfile({ ...profile, pincode: e.target.value })}
                className={inputCls()}
              />
            </div>
            <div>
              <label className="block text-sm font-bold mb-2">WhatsApp Number *</label>
              <input
                type="text"
                value={profile.whatsappNumber}
                disabled={disabled}
                onChange={e => setProfile({ ...profile, whatsappNumber: e.target.value })}
                className={inputCls()}
              />
            </div>
          </div>
        </div>
      </div>
      {/* Academic Info (optional extras ‚Äì currently just shows percentages again if needed) */}
      <div className="border-4 border-indigo-500 rounded-2xl p-6 bg-indigo-50">
        <div className="flex justify-between items-center mb-4">
          <h3 className="text-2xl font-bold text-indigo-800">üéì Academic Information</h3>
          <button
            onClick={handleToggleEdit}
            className="px-4 py-2 rounded-xl font-semibold text-sm bg-indigo-600 text-white"
          >
            {isEditing ? 'Save' : 'Edit'}
          </button>
        </div>
        <p className="text-sm text-gray-600">
          You can update your marks / percentages here whenever results are updated.
        </p>
        <div className="grid md:grid-cols-2 gap-4 mt-4">
          <div>
            <label className="block text-sm font-bold mb-2">10th Percentage *</label>
            <input
              type="number"
              step="0.01"
              className={inputCls()}
              disabled={!isEditing}
              value={profile.percentage10th}
              onChange={e => setProfile({ ...profile, percentage10th: e.target.value })}
            />
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">11th Percentage (Optional)</label>
            <input
              type="number"
              step="0.01"
              className={inputCls()}
              disabled={!isEditing}
              value={profile.percentage11th}
              onChange={e => setProfile({ ...profile, percentage11th: e.target.value })}
            />
          </div>
        </div>
      </div>
    </div>
  );
}

// ========================================
// STUDENT EXAM REGISTRATION COMPONENT
// ========================================
function StudentExamRegistration({currentUser}) {
  const myId = currentUser.studentId || currentUser.id;
  const myGrade = currentUser.grade;
  const [exams, setExams] = useState([]);
  const [loading, setLoading] = useState(true);
  const [expandedExams, setExpandedExams] = useState(new Set());
  const [editingExams, setEditingExams] = useState(new Set());

  useEffect(() => {
    const fetchExams = async () => {
      try {
        const docSnap = await db.collection('studentExamRegistrations').doc(myId).get();
        if (docSnap.exists) {
          setExams(docSnap.data().exams || []);
        }
        setLoading(false);
      } catch (e) {
        console.error('Error fetching exam registrations:', e);
        setLoading(false);
      }
    };
    fetchExams();
  }, [myId]);

  const handleAddExam = () => {
    const newExams = [...exams, {
      examName: '',
      registrationStatus: 'No',
      registrationNumber: '',
      password: '',
      emailUsed: '',
      phoneUsed: '',
      reasonNotCompleted: '',
      needSupport: 'No',
      supportType: ''
    }];
    setExams(newExams);
    // Auto-expand and edit the new exam
    const newIndex = newExams.length - 1;
    setExpandedExams(new Set([...expandedExams, newIndex]));
    setEditingExams(new Set([...editingExams, newIndex]));
  };

  const handleRemoveExam = (index) => {
    const updated = [...exams];
    updated.splice(index, 1);
    setExams(updated);
    // Remove from expanded and editing sets
    const newExpanded = new Set(expandedExams);
    const newEditing = new Set(editingExams);
    newExpanded.delete(index);
    newEditing.delete(index);
    setExpandedExams(newExpanded);
    setEditingExams(newEditing);
  };

  const handleExamChange = (index, field, value) => {
    const updated = [...exams];
    updated[index][field] = value;
    setExams(updated);
  };

  const toggleExpand = (index) => {
    const newExpanded = new Set(expandedExams);
    if (newExpanded.has(index)) {
      newExpanded.delete(index);
    } else {
      newExpanded.add(index);
    }
    setExpandedExams(newExpanded);
  };

  const toggleEdit = (index) => {
  const newEditing = new Set(editingExams);
  const newExpanded = new Set(expandedExams);

  if (newEditing.has(index)) {
    // closing edit
    newEditing.delete(index);
  } else {
    // going into edit ‚Üí also expand this exam
    newEditing.add(index);
    newExpanded.add(index);
  }

  setEditingExams(newEditing);
  setExpandedExams(newExpanded);
};

  const handleSave = async () => {
    try {
      await db.collection('studentExamRegistrations').doc(myId).set({
        studentId: myId,
        studentName: currentUser.name,
        school: currentUser.school,
        grade: myGrade,
        exams,
        updatedAt: new Date().toISOString()
      });
      alert('‚úÖ Exam registrations saved successfully!');
      // Collapse all exams and exit edit mode
      setExpandedExams(new Set());
      setEditingExams(new Set());
    } catch (e) {
      alert('Failed to save: ' + e.message);
    }
  };

  const examList = myGrade === '12' ? EXAMS_12TH : EXAMS_11TH;

  if (loading) {
    return <div className="text-center py-8">Loading exam registrations...</div>;
  }

  return (
    <div className="space-y-6">
      <div className="flex justify-between items-center">
        <h2 className="text-3xl font-bold">üìù Exam Registration</h2>
        <button onClick={handleAddExam} className="px-6 py-3 bg-blue-600 text-white rounded-xl font-semibold">
          + Add Exam
        </button>
      </div>

      {myGrade === '11' && (
        <div className="bg-blue-50 border-2 border-blue-300 p-4 rounded-xl">
          <p className="font-semibold text-blue-800">
            üìå Class 11: Please list the competitive exams you're interested in appearing for in the future.
          </p>
        </div>
      )}

      {exams.length === 0 ? (
        <div className="bg-white p-8 rounded-2xl text-center">
          <p className="text-gray-600">No exam registrations added yet. Click "+ Add Exam" to start.</p>
        </div>
      ) : (
        exams.map((exam, index) => {
          const isExpanded = expandedExams.has(index);
          const isEditing = editingExams.has(index);
          
          return (
          <div key={index} className="bg-white p-6 rounded-2xl shadow-lg">
            <div className="flex justify-between items-center mb-4">
              <div className="flex items-center gap-3">
                <button 
                  onClick={() => toggleExpand(index)}
                  className="text-2xl"
                >
                  {isExpanded ? '‚ñº' : '‚ñ∂'}
                </button>
                <h3 className="text-xl font-bold">
                  {exam.examName || `Exam ${index + 1}`}
                </h3>
                {exam.registrationStatus === 'Yes' && (
                  <span className="px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm font-bold">
                    ‚úì Completed
                  </span>
                )}
              </div>
              <div className="flex gap-2">
                <button 
                  onClick={() => toggleEdit(index)} 
                  className="px-4 py-2 bg-blue-500 text-white rounded-lg"
                >
                  {isEditing ? 'üíæ Save' : '‚úèÔ∏è Edit'}
                </button>
                <button 
                  onClick={() => handleRemoveExam(index)} 
                  className="px-4 py-2 bg-red-500 text-white rounded-lg"
                >
                  Remove
                </button>
              </div>
            </div>

            {isExpanded && (
            <div className="grid md:grid-cols-2 gap-4">
              <div className="md:col-span-2">
                <label className="block text-sm font-bold mb-2">Exam Name *</label>
                <select value={exam.examName} onChange={e => handleExamChange(index, 'examName', e.target.value)} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed">
                  <option value="">Select Exam</option>
                  {examList.map(e => <option key={e} value={e}>{e}</option>)}
                </select>
              </div>

              {myGrade === '12' && (
                <>
                  <div className="md:col-span-2">
                    <label className="block text-sm font-bold mb-2">Registration Completed? *</label>
                    <select value={exam.registrationStatus} onChange={e => handleExamChange(index, 'registrationStatus', e.target.value)} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed">
                      <option value="No">No</option>
                      <option value="Partially">Partially Completed</option>
                      <option value="Yes">Yes - Fully Completed</option>
                    </select>
                  </div>

                  {exam.registrationStatus === 'Yes' && (
                    <>
                      <div>
                        <label className="block text-sm font-bold mb-2">Registration Number *</label>
                        <input type="text" value={exam.registrationNumber} onChange={e => handleExamChange(index, 'registrationNumber', e.target.value)} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed" />
                      </div>
                      <div>
                        <label className="block text-sm font-bold mb-2">Password *</label>
                        <input type="text" value={exam.password} onChange={e => handleExamChange(index, 'password', e.target.value)} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed" />
                      </div>
                      <div>
                        <label className="block text-sm font-bold mb-2">Email Used for Registration *</label>
                        <input type="email" value={exam.emailUsed} onChange={e => handleExamChange(index, 'emailUsed', e.target.value)} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed" />
                      </div>
                      <div>
                        <label className="block text-sm font-bold mb-2">Phone Number Used *</label>
                        <input type="tel" value={exam.phoneUsed} onChange={e => handleExamChange(index, 'phoneUsed', e.target.value)} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed" />
                      </div>
                    </>
                  )}

                  {exam.registrationStatus === 'No' && (
                    <div className="md:col-span-2">
                      <label className="block text-sm font-bold mb-2">Why is the registration not completed? *</label>
                      <textarea value={exam.reasonNotCompleted} onChange={e => handleExamChange(index, 'reasonNotCompleted', e.target.value)} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed" rows="3" />
                    </div>
                  )}

                  <div className="md:col-span-2">
                    <label className="block text-sm font-bold mb-2">Do you need help/support to complete this application? *</label>
                    <select value={exam.needSupport} onChange={e => handleExamChange(index, 'needSupport', e.target.value)} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed">
                      <option value="No">No</option>
                      <option value="Yes">Yes</option>
                    </select>
                  </div>

                  {exam.needSupport === 'Yes' && (
                    <div className="md:col-span-2">
                      <label className="block text-sm font-bold mb-2">What kind of help do you need? *</label>
                      <textarea value={exam.supportType} onChange={e => handleExamChange(index, 'supportType', e.target.value)} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed" rows="3" placeholder="Please describe the support you need..." />
                    </div>
                  )}
                </>
              )}
            </div>
            )}
          </div>
        );
        })
      )}

      <button onClick={handleSave} className="w-full avanti-gradient text-white py-4 rounded-xl font-bold text-xl">
        üíæ Save Exam Registrations
      </button>
    </div>
  );
}

// ========================================
// COMPLETE STUDENT DASHBOARD - REPLACE EXISTING
// ========================================
function StudentDashboard({currentUser, handleLogout}) {
  const [activeTab, setActiveTab] = useState('dashboard');
  const [loading, setLoading] = useState(true);  // ‚¨ÖÔ∏è ADD THIS LINE
  const [curriculum, setCurriculum] = useState({});
  const [chapterProgress, setChapterProgress] = useState({});
  const [studentAttendance, setStudentAttendance] = useState([]);
  const [teachers, setTeachers] = useState([]);
  const [studentProfile, setStudentProfile] = useState(null);
  const [examRegistrations, setExamRegistrations] = useState(null);
  const [teacherFeedbacks, setTeacherFeedbacks] = useState([]);
  const [selectedTeacher, setSelectedTeacher] = useState(null);
  const [showTeacherProfile, setShowTeacherProfile] = useState(false);
  const [showFeedbackForm, setShowFeedbackForm] = useState(false);
  const [showFeedbackNotification, setShowFeedbackNotification] = useState(false);
  
  const mySchool = currentUser.school;
  const myGrade = currentUser.grade;
  const myId = currentUser.studentId || currentUser.id;

useEffect(() => {
  const fetchData = async () => {
    try {
      // Curriculum
      const currMap = {};
      const currSnap = await db.collection('curriculum').get();
      currSnap.docs.forEach(doc => { currMap[doc.id] = doc.data(); });
      setCurriculum(currMap);

      // Chapter progress
      const progressMap = {};
      const progressSnap = await db.collection('chapterProgress').get();
      progressSnap.docs.forEach(d => { progressMap[d.id] = d.data(); });
      setChapterProgress(progressMap);

      // ‚úÖ ALL attendance records for this student (no date filter)
      const attSnap = await db.collection('studentAttendance')
        .where('studentId', '==', String(myId))
        .get();

      const attendanceData = attSnap.docs
        .map(d => ({ ...d.data(), docId: d.id }))
        .sort((a, b) => b.date.localeCompare(a.date));

      setStudentAttendance(attendanceData);

      // Teachers from this school
      const teacherSnap = await db.collection('teachers')
        .where('school', '==', mySchool)
        .get();
      setTeachers(teacherSnap.docs.map(d => ({ ...d.data(), docId: d.id })));

      // Exam registrations for this student
      const examSnap = await db.collection('studentExamRegistrations').doc(myId).get();
      if (examSnap.exists) {
        setExamRegistrations(examSnap.data());
      }

      setLoading(false);
    } catch (e) {
      console.error('Data fetch error:', e);
      setLoading(false);
    }
  };

  fetchData();
}, [mySchool, myGrade, myId]);


    // Calculate profile completion (same logic as Profile page)
  const calculateCompletion = () => {
    const baseProfile = studentProfile || {
      grade: myGrade,
      school: mySchool
    };

    const requiredFields = [
      'firstName', 'lastName', 'email', 'phone', 'dob', 'grade', 'category',
      'stream', 'school', 'fatherName', 'motherName', 'fatherOccupation',
      'motherOccupation', 'fatherEducation', 'motherEducation', 'familyIncome',
      'address', 'state', 'district', 'pincode', 'whatsappNumber', 'percentage10th'
    ];

    const filled = requiredFields.filter(
      field => baseProfile[field] && String(baseProfile[field]).trim() !== ''
    ).length;

    return Math.round((filled / requiredFields.length) * 100);
  };
    // üîÑ Keep student profile in sync so banner and card match
  useEffect(() => {
    if (!myId) return;

    const unsubscribe = db.collection('studentProfiles')
      .doc(myId)
      .onSnapshot(
        (doc) => {
          if (doc.exists) {
            setStudentProfile(doc.data());
          } else {
            setStudentProfile(null);
          }
        },
        (err) => {
          console.error('Profile listener error:', err);
        }
      );

    return () => unsubscribe();
  }, [myId]);

  // Fetch teacher feedbacks and check if notification needed
  useEffect(() => {
    const fetchFeedbackData = async () => {
      try {
        // Fetch all feedbacks for this student
        const feedbackSnap = await db.collection('teacherFeedback')
          .where('studentId', '==', myId)
          .get();
        setTeacherFeedbacks(feedbackSnap.docs.map(d => ({ ...d.data(), id: d.id })));

        // Check if 2 months have passed since last feedback
        if (studentProfile?.lastFeedbackDate) {
          const lastDate = new Date(studentProfile.lastFeedbackDate);
          const now = new Date();
          const diffMonths = (now.getFullYear() - lastDate.getFullYear()) * 12 + 
                            (now.getMonth() - lastDate.getMonth());
          
          if (diffMonths >= 2) {
            // Show notification after 2 seconds
            setTimeout(() => setShowFeedbackNotification(true), 2000);
          }
        } else {
          // No feedback ever given, show notification
          setTimeout(() => setShowFeedbackNotification(true), 2000);
        }
      } catch (error) {
        console.error('Error fetching feedback data:', error);
      }
    };

    if (myId && studentProfile) {
      fetchFeedbackData();
    }
  }, [myId, studentProfile]);

  // Calculate average rating for a teacher
  const getTeacherAverageRating = (teacherDocId) => {
    const teacherFeedbackList = teacherFeedbacks.filter(f => f.teacherId === teacherDocId);
    if (teacherFeedbackList.length === 0) return null;
    
    const sum = teacherFeedbackList.reduce((acc, f) => acc + (f.averageRating || 0), 0);
    return sum / teacherFeedbackList.length;
  };

  const handleTeacherClick = (teacher) => {
    setSelectedTeacher(teacher);
    setShowTeacherProfile(true);
  };

  const handleGiveFeedback = () => {
    setShowTeacherProfile(false);
    setShowFeedbackForm(true);
  };

  const handleFeedbackSubmitSuccess = () => {
    // Refresh feedback data
    const fetchFeedbackData = async () => {
      const feedbackSnap = await db.collection('teacherFeedback')
        .where('studentId', '==', myId)
        .get();
      setTeacherFeedbacks(feedbackSnap.docs.map(d => ({ ...d.data(), id: d.id })));
    };
    fetchFeedbackData();
  };

  const profileCompletion = calculateCompletion();
  
  // Debug logging
  console.log('=== STUDENT PROFILE DEBUG ===');
  console.log('üìä Profile Completion:', profileCompletion + '%');
  console.log('üë§ Student Data:', studentProfile);
  console.log('üî¢ Student ID:', myId);
  console.log('üè´ School:', mySchool);
  console.log('üìö Grade:', myGrade);
  console.log('============================');

  if (loading) {
    return <div className="text-center py-8">Loading profile...</div>;
  }
  return (
    <div className="min-h-screen bg-gray-50 flex flex-col">
      <nav className="avanti-gradient shadow-lg sticky top-0 z-50">
        <div className="max-w-7xl mx-auto px-4 py-4">
          <div className="flex justify-between items-center">
            <div className="flex items-center gap-3">
              <img src={AVANTI_LOGO} alt="Avanti" className="w-12 h-12"/>
              <div>
                <h1 className="text-2xl font-bold text-white">Student Dashboard</h1>
                <p className="text-sm text-white opacity-90">{mySchool}</p>
              </div>
            </div>
            <div className="flex items-center gap-4">
              <div className="text-right hidden sm:block">
                <p className="text-white font-semibold">{currentUser.name}</p>
                <p className="text-sm text-white opacity-90">Class {myGrade} ‚Ä¢ ID: {myId}</p>
              </div>
              <button onClick={handleLogout} className="px-4 py-2 bg-white text-gray-800 rounded-xl font-semibold">
                Logout
              </button>
            </div>
          </div>
        </div>
      </nav>

      {/* Profile Completion Warning */}
      {profileCompletion < 100 && (
        <div className="bg-red-500 text-white text-center py-3 px-4">
          <p className="font-bold">
            ‚ö†Ô∏è Your profile is {profileCompletion}% complete. Please complete your profile!
          </p>
        </div>
      )}

      <div className="flex-1 max-w-7xl mx-auto px-4 py-6 w-full">
        <div className="flex gap-3 mb-6 overflow-x-auto pb-2">
          {['dashboard', 'profile', 'curriculum', 'attendance', 'exams'].map(tab => (
            <button key={tab} onClick={() => setActiveTab(tab)} 
              className={`px-6 py-3 rounded-xl font-semibold whitespace-nowrap ${activeTab === tab ? 'avanti-gradient text-white' : 'bg-white'}`}>
              {tab === 'dashboard' && 'üìä Dashboard'}
              {tab === 'profile' && 'üë§ My Profile'}
              {tab === 'curriculum' && 'üìö Curriculum'}
              {tab === 'attendance' && '‚úÖ Attendance'}
              {tab === 'exams' && 'üìù Exam Registration'}
            </button>
          ))}
        </div>

                {/* Dashboard Tab */}
        {activeTab === 'dashboard' && (
          <div className="space-y-6">
            <h2 className="text-3xl font-bold">Welcome, {currentUser.name}! üëã</h2>

            {/* Top stats cards */}
            <div className="grid md:grid-cols-5 gap-4">
              <div className="stat-card bg-blue-500 text-white">
                <div className="text-sm opacity-90">My School</div>
                <div className="text-xl font-bold">{mySchool}</div>
              </div>

              <div className="stat-card bg-green-500 text-white">
                <div className="text-sm opacity-90">My Class</div>
                <div className="text-2xl font-bold">Class {myGrade}</div>
              </div>

              <div className="stat-card bg-purple-500 text-white">
                <div className="text-sm opacity-90">Profile Complete</div>
                <div className="text-2xl font-bold">{profileCompletion}%</div>
              </div>

              <div className="stat-card bg-green-500 text-white">
                <div className="text-sm opacity-90">Days Present</div>
                <div className="text-2xl font-bold">
                  {studentAttendance.filter(a => a.status === 'Present').length}
                </div>
              </div>

              <div className="stat-card bg-red-500 text-white">
                <div className="text-sm opacity-90">Days Absent</div>
                <div className="text-2xl font-bold">
                  {studentAttendance.filter(a => a.status === 'Absent').length}
                </div>
              </div>
            </div>

            {/* My Teachers */}
            <div className="bg-white p-6 rounded-2xl shadow-lg">
              <h3 className="text-2xl font-bold mb-4">üë®‚Äçüè´ My Teachers</h3>
              {teachers.length === 0 ? (
                <p className="text-gray-500 text-center py-4">No teachers found</p>
              ) : (
                <div className="grid md:grid-cols-2 gap-4">
                  {SUBJECTS.map(subject => {
                    const teacher = teachers.find(t => t.subject === subject);
                    const averageRating = teacher ? getTeacherAverageRating(teacher.docId) : null;
                    return (
                      <div 
                        key={subject} 
                        className="teacher-card border-2 rounded-xl p-4"
                        onClick={() => teacher && handleTeacherClick(teacher)}
                      >
                        <div className="font-bold text-lg">{subject}</div>
                        <div className="flex items-center justify-between">
                          <div className="text-gray-600">
                            {teacher ? teacher.name : 'Not assigned'}
                          </div>
                          {averageRating && (
                            <div className="flex items-center gap-2">
                              <span className="text-yellow-500 font-bold">‚òÖ</span>
                              <span className="font-semibold">{averageRating.toFixed(1)}</span>
                            </div>
                          )}
                        </div>
                        {teacher && (
                          <div className="text-sm text-blue-600 mt-2">Click to view profile ‚Üí</div>
                        )}
                      </div>
                    );
                  })}
                </div>
              )}
            </div>

            {/* Pending Chapters */}
            <div className="bg-white p-6 rounded-2xl shadow-lg">
              <h3 className="text-2xl font-bold mb-4">üìö Pending Chapters</h3>
              {SUBJECTS.map(subject => {
                const docId = `${mySchool}_${subject}_${myGrade}`;
                const chapters = curriculum[docId]?.chapters || [];
                const pendingChapters = chapters.filter(ch => {
                  const progressId = `${mySchool}_${ch.id}`;
                  const prog = chapterProgress[progressId] || {};
                  return prog.completed !== 'Yes';
                });

                if (pendingChapters.length === 0) return null;

                return (
                  <div key={subject} className="mb-4">
                    <h4 className="font-bold text-lg mb-2">{subject} ({pendingChapters.length} pending)</h4>
                    <ul className="list-disc list-inside space-y-1">
                      {pendingChapters.slice(0, 5).map(ch => (
                        <li key={ch.id} className="text-gray-700">{ch.name}</li>
                      ))}
                      {pendingChapters.length > 5 && (
                        <li className="text-gray-500 italic">...and {pendingChapters.length - 5} more</li>
                      )}
                    </ul>
                  </div>
                );
              })}
            </div>
          </div>
        )}

        {/* Profile Tab */}
{activeTab === 'profile' && (
  <StudentProfileForm
    currentUser={currentUser}
    onProfileUpdated={(updatedProfile) => setStudentProfile(updatedProfile)}
  />
)}


        {/* Curriculum Tab */}
        {activeTab === 'curriculum' && (
          <div className="space-y-6">
            <h2 className="text-3xl font-bold">üìö My Curriculum - Class {myGrade}</h2>
            {SUBJECTS.map(subject => {
              const docId = `${mySchool}_${subject}_${myGrade}`;
              const chapters = curriculum[docId]?.chapters || [];
              
              return (
                <div key={subject} className="bg-white p-6 rounded-2xl shadow-lg">
                  <h3 className="text-2xl font-bold mb-4">{subject}</h3>
                  {chapters.length === 0 ? (
                    <p className="text-gray-500">No chapters available</p>
                  ) : (
                    <div className="space-y-3">
                      {chapters.map(chapter => {
                        const progressId = `${mySchool}_${chapter.id}`;
                        const prog = chapterProgress[progressId] || {};
                        const status = getChapterStatus(chapter, prog);
                        
                        return (
                          <div key={chapter.id} className="border-2 rounded-xl p-4">
                            <div className="flex justify-between items-start">
                              <div>
                                <h4 className="font-bold text-lg">{chapter.name}</h4>
                                <div className="text-sm text-gray-600 mt-1">
                                  Target: {chapter.targetDate || 'Not set'}
                                </div>
                              </div>
                              <div className={`status-badge ${status.class}`}>
                                {status.label}
                              </div>
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  )}
                </div>
              );
            })}
          </div>
        )}

        {/* Attendance Tab */}
        {activeTab === 'attendance' && (
          <div className="space-y-6">
            <h2 className="text-3xl font-bold">‚úÖ My Attendance Record</h2>
            <div className="bg-white p-6 rounded-2xl shadow-lg">
              <div className="overflow-x-auto">
                <table className="w-full">
                  <thead className="avanti-gradient-light">
                    <tr>
                      <th className="p-3 text-left">Date</th>
                      <th className="p-3 text-left">Status</th>
                      <th className="p-3 text-left">Remarks</th>
                    </tr>
                  </thead>
                  <tbody>
                    {studentAttendance.length === 0 ? (
                      <tr><td colSpan="3" className="p-8 text-center text-gray-500">No attendance records</td></tr>
                    ) : (
                      studentAttendance.map((record, idx) => (
                        <tr key={idx} className="border-b hover:bg-gray-50">
                          <td className="p-3">{record.date}</td>
                          <td className="p-3">
                            <span className={`px-3 py-1 rounded-full text-sm font-bold ${
                              record.status === 'Present' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'
                            }`}>
                              {record.status}
                            </span>
                          </td>
                          <td className="p-3 text-sm">{record.remarks || '‚Äî'}</td>
                        </tr>
                      ))
                    )}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        )}

        {/* Exams Tab */}
        {activeTab === 'exams' && <StudentExamRegistration currentUser={currentUser} />}
      </div>

      {/* Teacher Profile Modal */}
      {showTeacherProfile && selectedTeacher && (
        <TeacherProfileModal
          teacher={selectedTeacher}
          onClose={() => setShowTeacherProfile(false)}
          onGiveFeedback={handleGiveFeedback}
          averageRating={getTeacherAverageRating(selectedTeacher.docId)}
        />
      )}

      {/* Teacher Feedback Form */}
      {showFeedbackForm && selectedTeacher && (
        <TeacherFeedbackForm
          teacher={selectedTeacher}
          studentId={myId}
          onClose={() => setShowFeedbackForm(false)}
          onSubmitSuccess={handleFeedbackSubmitSuccess}
        />
      )}

      {/* Feedback Notification */}
      {showFeedbackNotification && (
        <FeedbackNotification
          onClose={() => setShowFeedbackNotification(false)}
          onGiveFeedback={() => {
            setShowFeedbackNotification(false);
            setActiveTab('dashboard');
          }}
        />
      )}

      <footer className="bg-gray-800 text-white text-center py-4 mt-auto">
        <p>Made by Anand with ‚ù§Ô∏è</p>
      </footer>
    </div>
  );
}
function App(){const[currentUser,setCurrentUser]=useState(null);const[isAdmin,setIsAdmin]=useState(false);const[activeTab,setActiveTab]=useState('overview');const[loginForm,setLoginForm]=useState({email:'',password:'',studentId:'',loginType:'teacher'});const[loading,setLoading]=useState(true);const[authLoading,setAuthLoading]=useState(false);const[teachers,setTeachers]=useState([]);const[curriculum,setCurriculum]=useState({});const[chapterProgress,setChapterProgress]=useState({});const[students,setStudents]=useState([]);
const[studentAttendance,setStudentAttendance]=useState([]);
const[teacherAttendance,setTeacherAttendance]=useState([]);
const[schoolInfo,setSchoolInfo]=useState([]);
const[isSidebarOpen,setIsSidebarOpen]=useState(false);               
const[showConfetti,setShowConfetti]=useState(false);const[celebrationMessage,setCelebrationMessage]=useState('');
useEffect(()=>{const unsubscribe=auth.onAuthStateChanged(async(user)=>{if(user){if(user.email==='admin@avantifellows.org'){setIsAdmin(true);setCurrentUser({name:'Administrator',email:user.email,afid:'ADMIN',school:'Admin'});setActiveTab('teachers')}else{const teacherSnapshot=await db.collection('teachers').where('email','==',user.email).limit(1).get();if(!teacherSnapshot.empty){const teacherData=teacherSnapshot.docs[0].data();setCurrentUser(teacherData);setIsAdmin(false);setActiveTab('overview');if(teacherData.dob){const d=new Date(teacherData.dob);const now=new Date();if(d.getMonth()===now.getMonth()&&d.getDate()===now.getDate()){setShowConfetti(true);setCelebrationMessage(`üéÇ Happy Birthday, ${teacherData.name}!`);setTimeout(()=>{setShowConfetti(false);setCelebrationMessage('')},8000)}}if(teacherData.joiningDate){const j=new Date(teacherData.joiningDate);const now=new Date();if(j.getMonth()===now.getMonth()&&j.getDate()===now.getDate()&&j.getFullYear()<now.getFullYear()){const years=now.getFullYear()-j.getFullYear();setShowConfetti(true);setCelebrationMessage(`üéâ Happy ${years} Year Work Anniversary, ${teacherData.name}!`);setTimeout(()=>{setShowConfetti(false);setCelebrationMessage('')},8000)}}}else{alert('Teacher profile not found. Please contact admin.');await auth.signOut()}}}else{// Check for student session in localStorage
const studentSession=localStorage.getItem('studentSession');if(studentSession){try{const studentData=JSON.parse(studentSession);console.log('‚úÖ Restored student session:',studentData);setCurrentUser(studentData);setIsAdmin(false);setActiveTab('dashboard')}catch(e){console.error('Failed to restore student session:',e);localStorage.removeItem('studentSession')}}else{setCurrentUser(null);setIsAdmin(false)}}setLoading(false)});return()=>unsubscribe()},[]);
  // ‚úÖ OPTIMIZED: Fetch data once on load, refresh only when needed
useEffect(() => {
  const fetchData = async () => {
    try {
      // ‚úÖ FETCH ALL DATA IN PARALLEL (MUCH FASTER!)
      const [progressSnap, teachersSnap, curriculumSnap, studentsSnap, studentAttSnap, teacherAttSnap, schoolInfoSnap] = await Promise.all([
        db.collection('chapterProgress').get(),
        db.collection('teachers').get(),
        db.collection('curriculum').get(),
        db.collection('students').get(),
        db.collection('studentAttendance')
          .where('date', '>=', new Date(Date.now() - 30*24*60*60*1000).toISOString().split('T')[0])
          .get(),
        db.collection('teacherAttendance')
          .where('date', '>=', new Date(Date.now() - 30*24*60*60*1000).toISOString().split('T')[0])
          .get(),
        db.collection('schoolInfo').get()
      ]);

      // Process chapter progress
      const map = {};
      progressSnap.docs.forEach(d => map[d.id] = d.data());
      setChapterProgress(map);

      // Process teachers
      setTeachers(teachersSnap.docs.map(d => ({ ...d.data(), docId: d.id })));

      // Process curriculum
      const currMap = {};
      curriculumSnap.docs.forEach(doc => { currMap[doc.id] = doc.data() });
      setCurriculum(currMap);

      // Process students - make sure every student has a proper `id`
setStudents(
  studentsSnap.docs.map(d => {
    const data = d.data();
    // Older students may be missing `id` field ‚Äì fall back to docId suffix
    let studentId = data.id;
    if (!studentId) {
      const parts = d.id.split('_');       // e.g. "JNV_Bharuch_1234"
      studentId = parts[parts.length - 1]; // -> "1234"
    }
    return { ...data, id: studentId, docId: d.id };
  })
);

      // Process attendance
      setStudentAttendance(studentAttSnap.docs.map(d => ({ ...d.data(), docId: d.id })));
      setTeacherAttendance(teacherAttSnap.docs.map(d => ({ ...d.data(), docId: d.id })));
      // Process school info
      setSchoolInfo(schoolInfoSnap.docs.map(d => ({ ...d.data(), docId: d.id })));

    } catch (e) {
      console.error('Data fetch error:', e);
    }
  };

  fetchData();

  // ‚úÖ Refresh data every 2 minutes (faster updates)
  const interval = setInterval(fetchData, 2 * 60 * 1000);
  return () => clearInterval(interval);
}, []);
const handleLogin=async()=>{
  setAuthLoading(true);
  try{
    const email=(loginForm.email||'').trim().toLowerCase();
    const password=loginForm.password;
    const studentId=(loginForm.studentId||'').trim();
    const loginType=loginForm.loginType||'teacher';
    
    if(loginType==='student'){
      // STUDENT LOGIN
      if(!studentId||!password){
        alert('Please enter Student ID and password');
        setAuthLoading(false);
        return;
      }
      if(password!=='pass123'){
        alert('Invalid password. Default password is: pass123');
        setAuthLoading(false);
        return;
      }
      
      try {
        // ‚úÖ Get all students and search for matching ID
        const allStudentsSnap = await db.collection('students').get();
        let foundStudent = null;
        
        allStudentsSnap.docs.forEach(doc => {
          const data = doc.data();
          if(data.id === studentId) {
            foundStudent = { ...data, docId: doc.id };
            console.log('‚úÖ Found student:', foundStudent);
          }
        });
        
        if(foundStudent){
          const studentUser = {
            ...foundStudent,
            userType:'student',
            studentId:studentId
          };
          // ‚úÖ Save to localStorage for session persistence
          localStorage.setItem('studentSession', JSON.stringify(studentUser));
          setCurrentUser(studentUser);
          setIsAdmin(false);
          setActiveTab('dashboard');
          setAuthLoading(false); // ‚¨ÖÔ∏è ADD THIS
        }else{
          alert('Student ID not found. Please contact your teacher.');
          setAuthLoading(false);
          return;
        }
      } catch(e) {
        console.error('Student login error:', e);
        alert('Login failed: ' + e.message);
        setAuthLoading(false);
        return;
      }
    }else{
      // TEACHER/ADMIN LOGIN (existing code)
      if(!email||!password){
        alert('Please enter email and password');
        setAuthLoading(false);
        return;
      }
      await auth.signInWithEmailAndPassword(email,password);
      setAuthLoading(false); // ‚¨ÖÔ∏è ADD THIS
    }
  }catch(e){
    console.error('login error',e);
    alert('Login failed: '+e.message);
    setAuthLoading(false); // ‚¨ÖÔ∏è MAKE SURE THIS EXISTS
  }
};
const handleLogout=async()=>{
  try{
    // Clear student session from localStorage
    localStorage.removeItem('studentSession');
    // For teachers/admins who use Firebase Auth
    if(auth.currentUser){
      await auth.signOut();
    }
    // Reset state for all users (including students)
    setCurrentUser(null);
    setIsAdmin(false);
    setActiveTab('overview');
    setLoginForm({loginType:'teacher',email:'',password:'',studentId:''});
  }catch(e){
    console.error('logout error',e);
  }
};
const updateChapterProgress = useCallback(async (school, chapterId, field, value) => {
  try {
    const docId = `${school}_${chapterId}`;

    // Save to Firebase
    await db.collection('chapterProgress').doc(docId).set(
      { [field]: value },
      { merge: true }
    );

    // üéâ Show confetti when CHAPTER is marked completed
    if (field === 'completed' && value === 'Yes') {
      setShowConfetti(true);
      setCelebrationMessage('üéâ Chapter marked as completed!');
      setTimeout(() => {
        setShowConfetti(false);
        setCelebrationMessage('');
      }, 5000);
    }

    // üéâ Show confetti when TEST is marked completed
    if (field === 'testConducted' && value === 'Yes') {
      setShowConfetti(true);
      setCelebrationMessage('üìù Chapter test completed!');
      setTimeout(() => {
        setShowConfetti(false);
        setCelebrationMessage('');
      }, 5000);
    }
  } catch (e) {
    console.error('Update error', e);
    alert('Failed to update: ' + e.message);
  }
}, [chapterProgress]);
const addChapter=async(school,subject,grade,chapter)=>{try{const docId=`${school}_${subject}_${grade}`;const doc=await db.collection('curriculum').doc(docId).get();const existing=doc.exists?(doc.data().chapters||[]):[];chapter.id=`${subject.charAt(0)}${grade}-${existing.length+1}-${Date.now().toString().slice(-4)}`;const updated=[...existing,chapter];await db.collection('curriculum').doc(docId).set({chapters:updated});alert('Chapter added successfully!')}catch(e){console.error('Add error',e);alert('Failed to add: '+e.message)}};
const updateChapter=async(school,subject,grade,chapterId,updates)=>{try{const docId=`${school}_${subject}_${grade}`;const doc=await db.collection('curriculum').doc(docId).get();const existing=doc.exists?(doc.data().chapters||[]):[];const index=existing.findIndex(ch=>ch.id===chapterId);if(index===-1){alert('Chapter not found');return}existing[index]={...existing[index],...updates};await db.collection('curriculum').doc(docId).set({chapters:existing});alert('Chapter updated successfully!')}catch(e){console.error('Update error',e);alert('Failed to update: '+e.message)}};
const deleteChapter=async(school,subject,grade,chapterId)=>{if(!confirm('Delete this chapter?'))return;try{const docId=`${school}_${subject}_${grade}`;const doc=await db.collection('curriculum').doc(docId).get();const existing=doc.exists?(doc.data().chapters||[]):[];const updated=existing.filter(ch=>ch.id!==chapterId);await db.collection('curriculum').doc(docId).set({chapters:updated});alert('Chapter deleted successfully')}catch(e){console.error('Delete error',e);alert('Failed to delete: '+e.message)}};
function Confetti() {
  const primary = ['#F97316', '#FACC15', '#22C55E', '#0EA5E9', '#6366F1', '#EC4899'];
  const secondary = ['#FDBA74', '#FDE68A', '#86EFAC', '#7DD3FC', '#A5B4FC', '#F9A8D4'];
  const pieces = 120;

  return (
    <div className="fixed inset-0 pointer-events-none z-[9999]">
      {Array.from({ length: pieces }).map((_, i) => {
        const colorIndex = Math.floor(Math.random() * primary.length);
        const left = Math.random() * 100;
        const size = 6 + Math.random() * 10;
        const delay = Math.random() * 1.2;
        const duration = 2.4 + Math.random() * 1.2;
        const isCircle = Math.random() > 0.6;

        return (
          <div
            key={i}
            className="confetti-piece"
            style={{
              left: `${left}%`,
              top: '-40px',
              width: `${size * 1.8}px`,
              height: `${size}px`,
              background: `linear-gradient(135deg, ${primary[colorIndex]}, ${secondary[colorIndex]})`,
              borderRadius: isCircle ? '999px' : '6px',
              boxShadow: '0 0 0 1px rgba(255,255,255,0.5)',
              animationDelay: `${delay}s`,
              animationDuration: `${duration}s`,
              opacity: 0.95,
            }}
          />
        );
      })}
    </div>
  );
}
if(loading){return(<div className="min-h-screen avanti-gradient flex items-center justify-center"><div className="text-center"><img src={AVANTI_LOGO} alt="Avanti Fellows" className="w-20 h-20 mx-auto mb-4 animate-bounce"/><div className="text-white text-2xl font-bold">Loading...</div></div></div>)}
if(!currentUser){
  return(
    <div className="min-h-screen avanti-gradient flex items-center justify-center p-4">
      <div className="bg-white rounded-3xl shadow-2xl p-10 w-full max-w-md">
        <div className="text-center mb-8">
          <img src={AVANTI_LOGO} alt="Avanti Fellows" className="w-20 h-20 mx-auto mb-4"/>
          <h1 className="text-4xl font-bold text-gray-800 mb-2">Curriculum Tracker</h1>
          <p className="text-gray-600 mt-3">Avanti Fellows</p>
        </div>
        
        {/* LOGIN TYPE SELECTOR - NEW */}
        <div className="flex gap-2 mb-6">
          <button
            onClick={()=>setLoginForm({...loginForm,loginType:'teacher'})}
            className={`flex-1 py-3 rounded-xl font-semibold ${loginForm.loginType==='teacher'?'bg-blue-600 text-white':'bg-gray-200'}`}
          >
            üë®‚Äçüè´ Teacher
          </button>
          <button
            onClick={()=>setLoginForm({...loginForm,loginType:'student'})}
            className={`flex-1 py-3 rounded-xl font-semibold ${loginForm.loginType==='student'?'bg-green-600 text-white':'bg-gray-200'}`}
          >
            üë®‚Äçüéì Student
          </button>
        </div>

        <div className="space-y-5">
          {loginForm.loginType==='student'?(
            <>
              <input type="text" className="w-full px-5 py-4 border-2 border-gray-300 rounded-xl text-lg" value={loginForm.studentId||''} onChange={e=>setLoginForm({...loginForm,studentId:e.target.value})} placeholder="Student ID"/>
              <input type="password" className="w-full px-5 py-4 border-2 border-gray-300 rounded-xl text-lg" value={loginForm.password} onChange={e=>setLoginForm({...loginForm,password:e.target.value})} placeholder="Password (pass123)" onKeyPress={e=>e.key==='Enter'&&handleLogin()}/>
              <p className="text-sm text-gray-600 text-center">Default password: <strong>pass123</strong></p>
            </>
          ):(
            <>
              <input type="email" className="w-full px-5 py-4 border-2 border-gray-300 rounded-xl text-lg" value={loginForm.email} onChange={e=>setLoginForm({...loginForm,email:e.target.value})} placeholder="Email"/>
              <input type="password" className="w-full px-5 py-4 border-2 border-gray-300 rounded-xl text-lg" value={loginForm.password} onChange={e=>setLoginForm({...loginForm,password:e.target.value})} placeholder="Password" onKeyPress={e=>e.key==='Enter'&&handleLogin()}/>
            </>
          )}
          <button onClick={handleLogin} disabled={authLoading} className="w-full avanti-gradient text-white py-4 rounded-xl font-bold text-lg disabled:opacity-50">
            {authLoading?'Logging in...':'Login'}
          </button>
        </div>
      </div>
    </div>
  );
}

// ========================================
// ADMIN STUDENT PROFILES VIEW
// ========================================
function AdminStudentProfiles(){
  const[studentProfiles,setStudentProfiles]=useState([]);
  const[filterSchool,setFilterSchool]=useState('All');
  const[filterGrade,setFilterGrade]=useState('All');

  useEffect(()=>{
    const fetchData=async()=>{
      const profilesSnap=await db.collection('studentProfiles').get();
      setStudentProfiles(profilesSnap.docs.map(d=>({...d.data(),id:d.id})));
    };
    fetchData();
  },[]);

  const filteredProfiles=studentProfiles.filter(p=>{
    if(filterSchool!=='All'&&p.school!==filterSchool)return false;
    if(filterGrade!=='All'&&p.grade!==filterGrade)return false;
    return true;
  });

  const handleExport=()=>{
    const exportData=filteredProfiles.map(p=>({
      'Student ID':p.studentId,
      'First Name':p.firstName,
      'Last Name':p.lastName,
      'Email':p.email,
      'Phone':p.phone,
      'DOB':p.dob,
      'Grade':p.grade,
      'Category':p.category,
      'Stream':p.stream,
      'School':p.school,
      'Father Name':p.fatherName,
      'Father Occupation':p.fatherOccupation,
      'Father Education':p.fatherEducation,
      'Mother Name':p.motherName,
      'Mother Occupation':p.motherOccupation,
      'Mother Education':p.motherEducation,
      'Family Income':p.familyIncome,
      'Address':p.address,
      'State':p.state,
      'District':p.district,
      'Pincode':p.pincode,
      'WhatsApp':p.whatsappNumber,
      '10th %':p.percentage10th,
      '11th %':p.percentage11th||'N/A'
    }));
    exportToExcel(exportData,'student_profiles');
  };

  return(
    <div className="space-y-6">
      <div className="flex justify-between items-center">
        <h2 className="text-3xl font-bold">üë®‚Äçüéì Student Profiles ({filteredProfiles.length})</h2>
        <button onClick={handleExport} className="px-6 py-3 bg-green-600 text-white rounded-xl font-semibold">
          üì• Export to Excel
        </button>
      </div>

      <div className="bg-white p-6 rounded-2xl shadow-lg">
        <h3 className="text-xl font-bold mb-4">üîç Filters</h3>
        <div className="grid md:grid-cols-2 gap-4">
          <div>
            <label className="block text-sm font-bold mb-2">School</label>
            <select value={filterSchool} onChange={e=>setFilterSchool(e.target.value)} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed">
              <option value="All">All Schools</option>
              {SCHOOLS.map(s=><option key={s} value={s}>{s}</option>)}
            </select>
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">Grade</label>
            <select value={filterGrade} onChange={e=>setFilterGrade(e.target.value)} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed">
              <option value="All">All Grades</option>
              <option value="11">Class 11</option>
              <option value="12">Class 12</option>
            </select>
          </div>
        </div>
      </div>

      <div className="bg-white p-6 rounded-2xl shadow-lg overflow-x-auto">
        <table className="w-full">
          <thead className="avanti-gradient-light">
            <tr>
              <th className="p-3 text-left">Student ID</th>
              <th className="p-3 text-left">Name</th>
              <th className="p-3 text-left">Grade</th>
              <th className="p-3 text-left">School</th>
              <th className="p-3 text-left">Stream</th>
              <th className="p-3 text-left">Category</th>
              <th className="p-3 text-left">10th %</th>
              <th className="p-3 text-left">Contact</th>
            </tr>
          </thead>
          <tbody>
            {filteredProfiles.length===0?(
              <tr><td colSpan="8" className="p-8 text-center text-gray-500">No student profiles found</td></tr>
            ):filteredProfiles.map(profile=>
              <tr key={profile.id} className="border-b hover:bg-gray-50">
                <td className="p-3 font-mono">{profile.studentId}</td>
                <td className="p-3 font-semibold">{profile.firstName} {profile.lastName}</td>
                <td className="p-3">{profile.grade}th</td>
                <td className="p-3">{profile.school}</td>
                <td className="p-3">{profile.stream}</td>
                <td className="p-3">{profile.category}</td>
                <td className="p-3">{profile.percentage10th}%</td>
                <td className="p-3 text-sm">{profile.phone}</td>
              </tr>
            )}
          </tbody>
        </table>
      </div>
    </div>
  );
}

// ‚úÖ Check if student is logged in
if(currentUser && currentUser.userType === 'student') {
  return <StudentDashboard currentUser={currentUser} handleLogout={handleLogout} />;
}

return isAdmin?<AdminView currentUser={currentUser} handleLogout={handleLogout} teachers={teachers} students={students} curriculum={curriculum} chapterProgress={chapterProgress} studentAttendance={studentAttendance} teacherAttendance={teacherAttendance} schoolInfo={schoolInfo} addChapter={addChapter} updateChapter={updateChapter} deleteChapter={deleteChapter}/>:<TeacherView currentUser={currentUser} handleLogout={handleLogout} showConfetti={showConfetti} Confetti={Confetti} celebrationMessage={celebrationMessage} teachers={teachers} students={students} curriculum={curriculum} chapterProgress={chapterProgress} studentAttendance={studentAttendance} teacherAttendance={teacherAttendance} schoolInfo={schoolInfo} updateChapterProgress={updateChapterProgress} activeTab={activeTab} setActiveTab={setActiveTab}/>;
}

function TeacherView({
  currentUser,
  handleLogout,
  showConfetti,
  Confetti,
  celebrationMessage,
  teachers,
  students,
  curriculum,
  chapterProgress,
  studentAttendance,
  teacherAttendance,
  schoolInfo,
  updateChapterProgress,
  activeTab,
  setActiveTab
}) {
  const teacherTabs = [
    { id: 'overview', label: 'Dashboard', icon: 'üìä' },
    { id: 'analytics', label: 'Analytics', icon: 'üìà' },
    { id: 'class11', label: 'Class 11', icon: 'üìö' },
    { id: 'class12', label: 'Class 12', icon: 'üìï' },
    { id: 'students', label: 'Students', icon: 'üë®‚Äçüéì' },
    { id: 'directory', label: 'Directory', icon: 'üìñ' },
    { id: 'attendance', label: 'Student Attendance', icon: '‚úÖ' },
    { id: 'attendancedash', label: 'Attendance Dashboard', icon: 'üìä' },
    { id: 'myattendance', label: 'My Attendance', icon: 'üïí' },
    { id: 'schoolinfo', label: 'School Info', icon: 'üè´' },
    { id: 'examstats', label: 'Exam Stats', icon: 'üìä' }
  ];

  const [sidebarCollapsed, setSidebarCollapsed] = useState(false);
  const [isMobileSidebarOpen, setIsMobileSidebarOpen] = useState(false);
  
  // Handle navigation and auto-close on mobile
  const handleTabClick = (tabId) => {
    setActiveTab(tabId);
    // Close sidebar on mobile after navigation
    if (window.innerWidth < 768) {
      setIsMobileSidebarOpen(false);
    }
  };
  
  // Swipe gesture detection
  useEffect(() => {
    let touchStartX = 0;
    let touchEndX = 0;
    
    const handleTouchStart = (e) => {
      touchStartX = e.changedTouches[0].screenX;
    };
    
    const handleTouchEnd = (e) => {
      touchEndX = e.changedTouches[0].screenX;
      handleSwipe();
    };
    
    const handleSwipe = () => {
      const swipeThreshold = 50;
      if (touchEndX - touchStartX > swipeThreshold && touchStartX < 50) {
        // Swipe right from left edge - open sidebar
        setIsMobileSidebarOpen(true);
      } else if (touchStartX - touchEndX > swipeThreshold) {
        // Swipe left - close sidebar
        setIsMobileSidebarOpen(false);
      }
    };
    
    document.addEventListener('touchstart', handleTouchStart);
    document.addEventListener('touchend', handleTouchEnd);
    
    return () => {
      document.removeEventListener('touchstart', handleTouchStart);
      document.removeEventListener('touchend', handleTouchEnd);
    };
  }, []);

  return (
    <div className="min-h-screen bg-gray-50">
      {showConfetti && <Confetti />}

      {/* PWA install helper */}
      <InstallPrompt />
      
      {/* Mobile Menu Button */}
      <button
        onClick={() => setIsMobileSidebarOpen(!isMobileSidebarOpen)}
        className="md:hidden fixed top-4 left-4 z-[1000] bg-gradient-to-r from-yellow-400 to-orange-500 text-white p-3 rounded-lg shadow-lg"
      >
        {isMobileSidebarOpen ? '‚úï' : '‚ò∞'}
      </button>

      {/* Manual Install Button - always visible */}
      <div className="fixed bottom-20 right-4 z-[9998]">
        <button
          onClick={() => {
            if (window.matchMedia('(display-mode: standalone)').matches) {
              alert('App is already installed! ‚úì');
            } else {
              alert(
                'To install:\n\n' +
                  'üì± Mobile: Tap browser menu ‚Üí "Add to Home Screen"\n\n' +
                  'üíª Desktop: Look for install icon in address bar (‚äï or üì•)'
              );
            }
          }}
          className="bg-blue-600 text-white px-4 py-3 rounded-full shadow-2xl font-bold hover:bg-blue-700 transition-all flex items-center gap-2"
        >
          üì± Install App
        </button>
      </div>
      
      {/* Mobile Sidebar Overlay */}
      <div 
        className={`mobile-sidebar-overlay ${isMobileSidebarOpen ? 'active' : ''}`}
        onClick={() => setIsMobileSidebarOpen(false)}
      />

      {/* Vertical Sidebar */}
      <div className={`sidebar mobile-sidebar ${sidebarCollapsed ? 'collapsed' : 'expanded'} ${isMobileSidebarOpen ? 'active' : ''}`}>
        <div className="sidebar-header">
          <div className="flex items-center gap-3">
            <img src={AVANTI_LOGO} alt="Avanti" className="w-10 h-10" />
            <h1 className="text-lg font-bold text-white sidebar-label">Curriculum Tracker</h1>
          </div>
          <button
            onClick={() => setSidebarCollapsed(!sidebarCollapsed)}
            className="sidebar-toggle hidden md:block"
          >
            {sidebarCollapsed ? '‚Üí' : '‚Üê'}
          </button>
        </div>

        <div className="sidebar-nav">
          {teacherTabs.map((tab) => (
            <div
              key={tab.id}
              onClick={() => handleTabClick(tab.id)}
              className={`sidebar-item ${activeTab === tab.id ? 'active' : ''}`}
            >
              <span className="sidebar-icon">{tab.icon}</span>
              <span className="sidebar-label">{tab.label}</span>
            </div>
          ))}
        </div>

        {!sidebarCollapsed && (
          <div className="px-4 py-3 border-t border-white border-opacity-20 mt-auto">
            <div className="text-white text-sm mb-2">
              <p className="font-semibold">{currentUser.name}</p>
              <p className="text-xs opacity-90">{currentUser.school}</p>
            </div>
            <button
              onClick={handleLogout}
              className="w-full px-3 py-2 bg-white bg-opacity-20 text-white rounded-lg font-semibold hover:bg-opacity-30 transition"
            >
              Logout
            </button>
          </div>
        )}
      </div>

      {/* Main content */}
      <div className={`main-content ${sidebarCollapsed ? 'sidebar-collapsed' : 'sidebar-expanded'}`}>
        {celebrationMessage && (
          <div className="avanti-gradient text-white text-center py-4 text-xl font-bold">
            {celebrationMessage}
          </div>
        )}

        <div className="px-4 py-6">

        {/* Tab content */}
        {activeTab === 'overview' && (
          <TeacherOverview
            currentUser={currentUser}
            teachers={teachers}
            students={students}
            curriculum={curriculum}
            chapterProgress={chapterProgress}
            studentAttendance={studentAttendance}
            teacherAttendance={teacherAttendance}
            schoolInfo={schoolInfo}
          />
        )}

        {activeTab === 'analytics' && (
          <TeacherAnalytics
            currentUser={currentUser}
            curriculum={curriculum}
            chapterProgress={chapterProgress}
          />
        )}

        {activeTab === 'class11' && (
  <TeacherCurriculum
    grade="11"
    currentUser={currentUser}
    curriculum={curriculum}
    chapterProgress={chapterProgress}
    updateChapterProgress={updateChapterProgress}
  />
)}

        {activeTab === 'class12' && (
  <TeacherCurriculum
    grade="12"
    currentUser={currentUser}
    curriculum={curriculum}
    chapterProgress={chapterProgress}
    updateChapterProgress={updateChapterProgress}
  />
)}

        {activeTab === 'students' && (
          <StudentManagement
            students={students}
            teachers={teachers}
            currentUser={currentUser}
          />
        )}

        {activeTab === 'directory' && (
          <TeacherDirectory teachers={teachers} currentUser={currentUser} />
        )}

        {activeTab === 'attendance' && (
          <StudentAttendanceView
            currentUser={currentUser}
            students={students}
            studentAttendance={studentAttendance}
          />
        )}

        {activeTab === 'attendancedash' && (
          <TeacherAttendanceDashboard
            currentUser={currentUser}
            students={students}
            teachers={teachers}
            studentAttendance={studentAttendance}
            teacherAttendance={teacherAttendance}
          />
        )}

        {activeTab === 'myattendance' && (
          <TeacherAttendanceView
            currentUser={currentUser}
            teacherAttendance={teacherAttendance}
          />
        )}

        {activeTab === 'schoolinfo' && (
          <SchoolInfoView currentUser={currentUser} schoolInfo={schoolInfo} />
        )}

        {activeTab === 'examstats' && <TeacherExamStats currentUser={currentUser} />}
        </div>
      </div>

      <footer className="bg-gray-800 text-white text-center py-4">
        <p>Made by Anand with ‚ù§Ô∏è</p>
      </footer>
    </div>
  );
}
// ========================================
// ADMIN EXAM REGISTRATION STATISTICS
// ========================================
function AdminExamStats() {
  const [examRegistrations, setExamRegistrations] = useState([]);
  const [students, setStudents] = useState([]);

  const [filterSchool, setFilterSchool] = useState('All');
  const [filterGrade, setFilterGrade] = useState('All');
  const [filterGender, setFilterGender] = useState('All');
  const [filterStatus, setFilterStatus] = useState('All'); // Completed / Partial / NotDone / NeedHelp
  const [filterExam, setFilterExam] = useState('All');

  useEffect(() => {
    const fetchData = async () => {
      const regsSnap = await db.collection('studentExamRegistrations').get();
      setExamRegistrations(regsSnap.docs.map(d => ({ ...d.data(), id: d.id })));

      const stuSnap = await db.collection('students').get();
      const studentsData = stuSnap.docs.map(d => {
        const data = d.data();
        let studentId = data.id;
        if (!studentId) {
          const parts = d.id.split('_');
          studentId = parts[parts.length - 1];
        }
        return { ...data, id: studentId, docId: d.id };
      });
      setStudents(studentsData);
    };
    fetchData();
  }, []);

  const schoolOptions = SCHOOLS;
  const gradeOptions = Array.from(new Set(students.map(s => s.grade).filter(Boolean))).sort();
  const genderOptions = Array.from(new Set(students.map(s => s.gender).filter(Boolean))).sort();
  const examOptions = Array.from(
    new Set(examRegistrations.flatMap(r => (r.exams || []).map(e => e.examName)).filter(Boolean))
  ).sort();

  const filteredStudents = students.filter(s => {
    if (filterSchool !== 'All' && s.school !== filterSchool) return false;
    if (filterGrade !== 'All' && s.grade !== filterGrade) return false;
    if (filterGender !== 'All' && (s.gender || '') !== filterGender) return false;
    return true;
  });

  const detailRows = [];
  examRegistrations.forEach(reg => {
    const student = filteredStudents.find(s => s.id === reg.studentId);
    if (!student) return;
    (reg.exams || []).forEach(exam => {
      if (filterExam !== 'All' && exam.examName !== filterExam) return;
      if (filterStatus === 'Completed' && exam.registrationStatus !== 'Yes') return;
      if (filterStatus === 'Partial' && exam.registrationStatus !== 'Partially') return;
      if (filterStatus === 'NotDone' && exam.registrationStatus !== 'No') return;
      if (filterStatus === 'NeedHelp' && exam.needSupport !== 'Yes') return;
      detailRows.push({ student, reg, exam });
    });
  });

  const totalStudents = filteredStudents.length;
  const studentsWithRegs = new Set(detailRows.map(r => r.reg.studentId)).size;
  const pendingStudents = totalStudents - studentsWithRegs;

  const examStats = {};
  detailRows.forEach(({ exam }) => {
    const name = exam.examName || 'Other';
    if (!examStats[name]) {
      examStats[name] = { completed: 0, partial: 0, notCompleted: 0, needSupport: 0 };
    }
    if (exam.registrationStatus === 'Yes') examStats[name].completed++;
    if (exam.registrationStatus === 'Partially') examStats[name].partial++;
    if (exam.registrationStatus === 'No') examStats[name].notCompleted++;
    if (exam.needSupport === 'Yes') examStats[name].needSupport++;
  });

  const handleExport = () => {
    const exportData = detailRows.map(({ student, reg, exam }) => ({
      'Student ID': reg.studentId,
      'Student Name': reg.studentName || student.name,
      'School': student.school,
      'Grade': student.grade,
      'Gender': student.gender || '-',
      'Exam Name': exam.examName,
      'Registration Status': exam.registrationStatus,
      'Registration Number': exam.registrationNumber || '-',
      'Password': exam.password || '-',
      'Email Used': exam.emailUsed || '-',
      'Phone Number Used': exam.phoneUsed || '-',
      'Need Support': exam.needSupport,
      'Support Type': exam.supportType || '-',
      'Reason Not Completed': exam.reasonNotCompleted || '-',
      'Last Updated': reg.updatedAt ? new Date(reg.updatedAt).toLocaleDateString() : '-'
    }));

    if (exportData.length === 0) {
      alert('No data to export!');
      return;
    }
    exportToExcel(exportData, 'exam_registrations_detailed');
  };

  return (
    <div className="space-y-6">
      <div className="flex justify-between items-center">
        <h2 className="text-3xl font-bold">üìä Exam Registration Statistics</h2>
        <button
          onClick={handleExport}
          className="px-6 py-3 bg-green-600 text-white rounded-xl font-semibold"
        >
          üì• Export
        </button>
      </div>

      {/* Filters */}
      <div className="bg-white p-6 rounded-2xl shadow-lg">
        <h3 className="text-xl font-bold mb-4">üîç Filters</h3>
        <div className="grid md:grid-cols-3 gap-4">
          <div>
            <label className="block text-sm font-bold mb-2">School</label>
            <select
              value={filterSchool}
              onChange={e => setFilterSchool(e.target.value)}
              disabled={!isEditing}
              className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"
            >
              <option value="All">All Schools</option>
              {schoolOptions.map(s => (
                <option key={s} value={s}>{s}</option>
              ))}
            </select>
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">Grade</label>
            <select
              value={filterGrade}
              onChange={e => setFilterGrade(e.target.value)}
              disabled={!isEditing}
              className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"
            >
              <option value="All">All Grades</option>
              <option value="11">Class 11</option>
              <option value="12">Class 12</option>
            </select>
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">Gender</label>
            <select
              value={filterGender}
              onChange={e => setFilterGender(e.target.value)}
              disabled={!isEditing}
              className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"
            >
              <option value="All">All</option>
              {genderOptions.map(g => (
                <option key={g} value={g}>{g}</option>
              ))}
            </select>
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">Exam Name</label>
            <select
              value={filterExam}
              onChange={e => setFilterExam(e.target.value)}
              disabled={!isEditing}
              className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"
            >
              <option value="All">All Exams</option>
              {examOptions.map(name => (
                <option key={name} value={name}>{name}</option>
              ))}
            </select>
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">Status</label>
            <select
              value={filterStatus}
              onChange={e => setFilterStatus(e.target.value)}
              disabled={!isEditing}
              className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"
            >
              <option value="All">All</option>
              <option value="Completed">Completed</option>
              <option value="Partial">Partial</option>
              <option value="NotDone">Not Done</option>
              <option value="NeedHelp">Need Help</option>
            </select>
          </div>
        </div>
      </div>

      {/* Summary cards */}
      <div className="grid md:grid-cols-3 gap-4">
        <div className="stat-card bg-blue-500 text-white">
          <div className="text-sm opacity-90">Total Students</div>
          <div className="text-5xl font-bold">{totalStudents}</div>
        </div>
        <div className="stat-card bg-green-500 text-white">
          <div className="text-sm opacity-90">Registered for Exams</div>
          <div className="text-5xl font-bold">{studentsWithRegs}</div>
        </div>
        <div className="stat-card bg-orange-500 text-white">
          <div className="text-sm opacity-90">Pending Registration</div>
          <div className="text-5xl font-bold">{pendingStudents}</div>
        </div>
      </div>

      {/* Exam-wise status */}
      <div className="bg-white p-6 rounded-2xl shadow-lg">
        <h3 className="text-xl font-bold mb-4">üìã Exam-wise Registration Status</h3>
        <div className="overflow-x-auto">
          <table className="w-full">
            <thead className="avanti-gradient-light">
              <tr>
                <th className="p-3 text-left">Exam</th>
                <th className="p-3 text-center">Completed</th>
                <th className="p-3 text-center">Partial</th>
                <th className="p-3 text-center">Not Started</th>
                <th className="p-3 text-center">Need Support</th>
              </tr>
            </thead>
            <tbody>
              {Object.keys(examStats).length === 0 ? (
                <tr>
                  <td colSpan="5" className="p-8 text-center text-gray-500">
                    No exam registrations yet
                  </td>
                </tr>
              ) : (
                Object.entries(examStats).map(([examName, stats]) => (
                  <tr key={examName} className="border-b hover:bg-gray-50">
                    <td className="p-3 font-semibold">{examName}</td>
                    <td className="p-3 text-center">
                      <span className="px-3 py-1 rounded-full bg-green-100 text-green-700 font-bold">
                        {stats.completed}
                      </span>
                    </td>
                    <td className="p-3 text-center">
                      <span className="px-3 py-1 rounded-full bg-yellow-100 text-yellow-700 font-bold">
                        {stats.partial}
                      </span>
                    </td>
                    <td className="p-3 text-center">
                      <span className="px-3 py-1 rounded-full bg-red-100 text-red-700 font-bold">
                        {stats.notCompleted}
                      </span>
                    </td>
                    <td className="p-3 text-center">
                      <span className="px-3 py-1 rounded-full bg-orange-100 text-orange-700 font-bold">
                        {stats.needSupport}
                      </span>
                    </td>
                  </tr>
                ))
              )}
            </tbody>
          </table>
        </div>
      </div>

      {/* Student-wise details */}
      <div className="bg-white p-6 rounded-2xl shadow-lg">
        <h3 className="text-xl font-bold mb-4">üßë‚Äçüéì Student-wise Exam Registrations</h3>
        <div className="overflow-x-auto">
          <table className="w-full text-sm">
            <thead className="bg-gray-100">
              <tr>
                <th className="p-3 text-left">Student ID</th>
                <th className="p-3 text-left">Name</th>
                <th className="p-3 text-left">School</th>
                <th className="p-3 text-left">Grade</th>
                <th className="p-3 text-left">Gender</th>
                <th className="p-3 text-left">Exam</th>
                <th className="p-3 text-left">Status</th>
                <th className="p-3 text-left">Need Help</th>
                <th className="p-3 text-left">Reg. No.</th>
                <th className="p-3 text-left">Email</th>
                <th className="p-3 text-left">Phone</th>
              </tr>
            </thead>
            <tbody>
              {detailRows.length === 0 ? (
                <tr>
                  <td colSpan="11" className="p-6 text-center text-gray-500">
                    No exam registrations with current filters.
                  </td>
                </tr>
              ) : (
                detailRows.map((row, idx) => {
                  const status = row.exam.registrationStatus || 'No';
                  const needHelp = row.exam.needSupport === 'Yes';
                  return (
                    <tr key={idx} className="border-b hover:bg-gray-50">
                      <td className="p-3">{row.student.id}</td>
                      <td className="p-3">{row.student.name}</td>
                      <td className="p-3">{row.student.school}</td>
                      <td className="p-3">{row.student.grade}</td>
                      <td className="p-3">{row.student.gender || '‚Äî'}</td>
                      <td className="p-3">{row.exam.examName}</td>
                      <td className="p-3">
                        {status === 'Yes' && <span className="px-3 py-1 rounded-full bg-green-100 text-green-700 font-semibold">Completed</span>}
                        {status === 'Partially' && <span className="px-3 py-1 rounded-full bg-yellow-100 text-yellow-700 font-semibold">Partial</span>}
                        {status === 'No' && <span className="px-3 py-1 rounded-full bg-red-100 text-red-700 font-semibold">Not Done</span>}
                      </td>
                      <td className="p-3">
                        {needHelp ? (
                          <span className="px-3 py-1 rounded-full bg-orange-100 text-orange-700 font-semibold">Yes</span>
                        ) : (
                          'No'
                        )}
                      </td>
                      <td className="p-3">{row.exam.registrationNumber || '‚Äî'}</td>
                      <td className="p-3">{row.exam.emailUsed || '‚Äî'}</td>
                      <td className="p-3">{row.exam.phoneUsed || '‚Äî'}</td>
                    </tr>
                  );
                })
              )}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  );
}

function AdminView({
  currentUser,
  handleLogout,
  teachers,
  students,
  curriculum,
  chapterProgress,
  studentAttendance,
  teacherAttendance,
  schoolInfo,
  addChapter,
  updateChapter,
  deleteChapter
}) {
  const [activeTab, setActiveTab] = useState('teachers');
  const [sidebarCollapsed, setSidebarCollapsed] = useState(false);
  const [isMobileSidebarOpen, setIsMobileSidebarOpen] = useState(false);

  const adminTabs = [
    { id: 'teachers', label: 'Teachers', icon: 'üë•' },
    { id: 'students', label: 'Students', icon: 'üë®‚Äçüéì' },
    { id: 'directory', label: 'Directory', icon: 'üìñ' },
    { id: 'curriculum', label: 'Curriculum', icon: 'üìö' },
    { id: 'analytics', label: 'Analytics', icon: 'üìä' },
    { id: 'chapter-details', label: 'Chapter Details', icon: 'üìã' },
    { id: 'attendance', label: 'Attendance Analytics', icon: 'üìä' },
    { id: 'schoolinfo', label: 'School Info', icon: 'üè´' },
    { id: 'birthdays', label: 'Celebrations', icon: 'üéÇ' },
    { id: 'studentprofiles', label: 'Student Profiles', icon: 'üë®‚Äçüéì' },
    { id: 'examstats', label: 'Exam Statistics', icon: 'üìä' },
    { id: 'studentfeedback', label: 'Student Feedback', icon: 'üí¨' }
  ];
  
  // Handle navigation and auto-close on mobile
  const handleTabClick = (tabId) => {
    setActiveTab(tabId);
    // Close sidebar on mobile after navigation
    if (window.innerWidth < 768) {
      setIsMobileSidebarOpen(false);
    }
  };
  
  // Swipe gesture detection
  useEffect(() => {
    let touchStartX = 0;
    let touchEndX = 0;
    
    const handleTouchStart = (e) => {
      touchStartX = e.changedTouches[0].screenX;
    };
    
    const handleTouchEnd = (e) => {
      touchEndX = e.changedTouches[0].screenX;
      handleSwipe();
    };
    
    const handleSwipe = () => {
      const swipeThreshold = 50;
      if (touchEndX - touchStartX > swipeThreshold && touchStartX < 50) {
        // Swipe right from left edge - open sidebar
        setIsMobileSidebarOpen(true);
      } else if (touchStartX - touchEndX > swipeThreshold) {
        // Swipe left - close sidebar
        setIsMobileSidebarOpen(false);
      }
    };
    
    document.addEventListener('touchstart', handleTouchStart);
    document.addEventListener('touchend', handleTouchEnd);
    
    return () => {
      document.removeEventListener('touchstart', handleTouchStart);
      document.removeEventListener('touchend', handleTouchEnd);
    };
  }, []);

  return (
    <div className="min-h-screen bg-gray-50">
      <InstallPrompt />
      
      {/* Mobile Menu Button */}
      <button
        onClick={() => setIsMobileSidebarOpen(!isMobileSidebarOpen)}
        className="md:hidden fixed top-4 left-4 z-[1000] bg-gradient-to-r from-yellow-400 to-orange-500 text-white p-3 rounded-lg shadow-lg"
      >
        {isMobileSidebarOpen ? '‚úï' : '‚ò∞'}
      </button>
      
      {/* Mobile Sidebar Overlay */}
      <div 
        className={`mobile-sidebar-overlay ${isMobileSidebarOpen ? 'active' : ''}`}
        onClick={() => setIsMobileSidebarOpen(false)}
      />

      {/* Vertical Sidebar */}
      <div className={`sidebar mobile-sidebar ${sidebarCollapsed ? 'collapsed' : 'expanded'} ${isMobileSidebarOpen ? 'active' : ''}`}>
        <div className="sidebar-header">
          <div className="flex items-center gap-3">
            <img src={AVANTI_LOGO} alt="Avanti" className="w-10 h-10" />
            <h1 className="text-lg font-bold text-white sidebar-label">Admin Dashboard</h1>
          </div>
          <button
            onClick={() => setSidebarCollapsed(!sidebarCollapsed)}
            className="sidebar-toggle hidden md:block"
          >
            {sidebarCollapsed ? '‚Üí' : '‚Üê'}
          </button>
        </div>

        <div className="sidebar-nav">
          {adminTabs.map((tab) => (
            <div
              key={tab.id}
              onClick={() => handleTabClick(tab.id)}
              className={`sidebar-item ${activeTab === tab.id ? 'active' : ''}`}
            >
              <span className="sidebar-icon">{tab.icon}</span>
              <span className="sidebar-label">{tab.label}</span>
            </div>
          ))}
        </div>

        {!sidebarCollapsed && (
          <div className="px-4 py-3 border-t border-white border-opacity-20 mt-auto">
            <button
              onClick={handleLogout}
              className="w-full px-3 py-2 bg-white bg-opacity-20 text-white rounded-lg font-semibold hover:bg-opacity-30 transition"
            >
              Logout
            </button>
          </div>
        )}
      </div>

      {/* Main content */}
      <div className={`main-content ${sidebarCollapsed ? 'sidebar-collapsed' : 'sidebar-expanded'}`}>
        <div className="px-4 py-6">

        {/* Tab Content */}
        {activeTab === 'teachers' && <TeacherManagement teachers={teachers} />}

        {activeTab === 'students' && <StudentManagement students={students} />}

        {activeTab === 'directory' && (
          <TeacherDirectory teachers={teachers} currentUser={currentUser} />
        )}

        {activeTab === 'curriculum' && (
          <AdminCurriculum
            curriculum={curriculum}
            addChapter={addChapter}
            updateChapter={updateChapter}
            deleteChapter={deleteChapter}
          />
        )}

        {activeTab === 'analytics' && (
          <AdminAnalytics
            teachers={teachers}
            curriculum={curriculum}
            chapterProgress={chapterProgress}
          />
        )}

        {activeTab === 'chapter-details' && (
          <AdminChapterDetails
            curriculum={curriculum}
            chapterProgress={chapterProgress}
            teachers={teachers}
          />
        )}

        {activeTab === 'attendance' && (
          <AdminAttendanceAnalytics
            students={students}
            teachers={teachers}
            studentAttendance={studentAttendance}
            teacherAttendance={teacherAttendance}
          />
        )}

        {activeTab === 'schoolinfo' && (
          <AdminSchoolInfo schoolInfo={schoolInfo} />
        )}

        {activeTab === 'birthdays' && <AdminBirthdays teachers={teachers} />}

        {activeTab === 'studentprofiles' && <AdminStudentProfiles />}

        {activeTab === 'examstats' && <AdminExamStats />}
        
        {activeTab === 'studentfeedback' && <StudentFeedbackView />}
        </div>
      </div>

      <footer className="bg-gray-800 text-white text-center py-4">
        <p>Made by Anand with ‚ù§Ô∏è</p>
      </footer>
    </div>
  );
}
function TeacherOverview({currentUser,curriculum,chapterProgress,teachers,teacherAttendance,studentAttendance}){const mySchool=currentUser.school;const mySubject=currentUser.subject;const schoolRankings=useMemo(()=>{
  const rankings=SCHOOLS.map(school=>{
    let total=0,completed=0,testsCompleted=0,testsPending=0;
    SUBJECTS.forEach(subject=>{
      ['11','12'].forEach(grade=>{
        const docId=`${school}_${subject}_${grade}`;
        const chapters=curriculum[docId]?.chapters||[];
        chapters.forEach(ch=>{
          total++;
          const progressId=`${school}_${ch.id}`;
          const prog=chapterProgress[progressId]||{};
          // ‚úÖ Count when chapter is completed (not test)
          if(prog.completed==='Yes'){
            completed++;
            // Track tests separately
            if(prog.testConducted==='Yes'){
              testsCompleted++;
            }else{
              testsPending++;
            }
          }
        })
      })
    });
    return{school,total,completed,testsCompleted,testsPending,percentage:total?Math.round((completed/total)*100):0}
  });
  rankings.sort((a,b)=>b.percentage-a.percentage);
  return rankings
},[curriculum,chapterProgress]);                                                                                                  
  const subjectRankings=useMemo(()=>{
  const rankings=SUBJECTS.map(subject=>{
    let total=0,completed=0;
    ['11','12'].forEach(grade=>{
      const docId=`${mySchool}_${subject}_${grade}`;
      const chapters=curriculum[docId]?.chapters||[];
      chapters.forEach(ch=>{
        total++;
        const progressId=`${mySchool}_${ch.id}`;
        const prog=chapterProgress[progressId]||{};
        // ‚úÖ Count when chapter completed
        if(prog.completed==='Yes'){
          completed++
        }
      })
    });
    return{subject,total,completed,percentage:total?Math.round((completed/total)*100):0}
  })
  .filter(rank=>rank.total>0);
  rankings.sort((a,b)=>b.percentage-a.percentage);
  return rankings
},[curriculum,chapterProgress,mySchool]);const mySchoolRank=schoolRankings.findIndex(r=>r.school===mySchool)+1;const laggingSubject=subjectRankings[subjectRankings.length-1];return(<div className="space-y-6"><h2 className="text-3xl font-bold">Dashboard Overview</h2><div className="grid md:grid-cols-4 gap-4"><div className="stat-card avanti-gradient text-white"><div className="text-sm opacity-90">Your School Rank</div><div className="text-5xl font-bold">#{mySchoolRank}</div><div className="text-sm mt-2">Out of {SCHOOLS.length} schools</div></div><div className="stat-card bg-gradient-to-br from-green-500 to-emerald-600 text-white"><div className="text-sm opacity-90">Best Performing School</div><div className="text-2xl font-bold mt-2">{schoolRankings[0]?.school}</div><div className="text-sm mt-2">{schoolRankings[0]?.percentage}% completed</div></div><div className="stat-card bg-gradient-to-br from-orange-500 to-red-600 text-white"><div className="text-sm opacity-90">Lagging Subject (Your School)</div><div className="text-2xl font-bold mt-2">{laggingSubject?.subject}</div><div className="text-sm mt-2">{laggingSubject?.percentage}% completed</div></div></div><div className="bg-white p-6 rounded-2xl shadow-lg"><h3 className="text-2xl font-bold mb-4">üèÜ School Rankings</h3><div className="space-y-3">{schoolRankings.map((rank,index)=><div key={rank.school} className={`ranking-card ${index===0?'ranking-1':index===1?'ranking-2':index===2?'ranking-3':''} ${rank.school===mySchool?'bg-yellow-50':''}`}><div className="flex justify-between items-center"><div className="flex items-center gap-4"><div className="text-2xl font-bold text-gray-400">#{index+1}</div><div><div className="font-bold text-lg">{rank.school} {rank.school===mySchool&&'‚≠ê'}</div><div className="text-sm text-gray-600">{rank.completed} / {rank.total} chapters completed</div></div></div><div className="text-3xl font-bold" style={{color:'var(--avanti-red)'}}>{rank.percentage}%</div></div></div>)}</div></div><div className="bg-white p-6 rounded-2xl shadow-lg"><h3 className="text-2xl font-bold mb-4">üìö Subject Performance in {mySchool}</h3><div className="grid md:grid-cols-2 gap-4">{subjectRankings.map(rank=><div key={rank.subject} className="border-2 rounded-xl p-4"><div className="flex justify-between items-center mb-2"><div className="font-bold text-lg">{rank.subject}</div><div className="text-2xl font-bold" style={{color:'var(--avanti-red)'}}>{rank.percentage}%</div></div><div className="h-2 bg-gray-200 rounded-full"><div className="h-2 avanti-gradient rounded-full" style={{width:`${rank.percentage}%`}}/></div><div className="text-sm text-gray-600 mt-2">{rank.completed} / {rank.total} chapters</div></div>)}</div></div><div className="stat-card bg-gradient-to-br from-purple-500 to-pink-600 text-white">
  <div className="text-sm opacity-90">My Attendance (This Month)</div>
  <div className="text-2xl font-bold mt-2">
    {teacherAttendance.filter(a=>a.teacherId===currentUser.afid&&getMonthYear(a.date)===getMonthYear(getTodayDate())).length} days
  </div>
  <div className="text-sm mt-2">Marked this month</div>
  <div className="bg-white p-6 rounded-2xl shadow-lg">
  <h3 className="text-2xl font-bold mb-4">üìä Quick Attendance Overview</h3>
  <div className="grid md:grid-cols-2 gap-4">
    <div className="border-2 rounded-xl p-4">
      <h4 className="font-bold mb-2">Today's Student Attendance</h4>
      <p className="text-sm text-gray-600">
        Present: <strong className="text-green-600">
          {studentAttendance.filter(a=>a.date===getTodayDate()&&a.school===currentUser.school&&a.status==='Present').length}
        </strong>
      </p>
      <p className="text-sm text-gray-600">
        Absent: <strong className="text-red-600">
          {studentAttendance.filter(a=>a.date===getTodayDate()&&a.school===currentUser.school&&a.status==='Absent').length}
        </strong>
      </p>
    </div>
    <div className="border-2 rounded-xl p-4">
      <h4 className="font-bold mb-2">My Attendance Status</h4>
      {teacherAttendance.find(a=>a.teacherId===currentUser.afid&&a.date===getTodayDate())?
        <div className="text-sm">
          <p className="text-green-600 font-bold">‚úì Marked for today</p>
          <p className="text-gray-600">
            Status: {teacherAttendance.find(a=>a.teacherId===currentUser.afid&&a.date===getTodayDate()).status}
          </p>
        </div>
      :
        <p className="text-orange-600 font-bold">‚ö†Ô∏è Not marked yet</p>
      }
    </div>
  </div>
</div>
  <div className="bg-white p-6 rounded-2xl shadow-lg">
  <h3 className="text-2xl font-bold mb-4">‚è∞ Today's Punch-In Times - {mySchool}</h3>
  <div className="space-y-2 max-h-96 overflow-y-auto">
    {teachers
      .filter(t=>t.school===mySchool)
      .map(teacher=>{
        const todayAttendance=teacherAttendance.find(
          a=>a.teacherId===teacher.afid&&a.date===getTodayDate()
        );
        return(
          <div key={teacher.afid} className={`p-4 rounded-xl border-2 ${
            teacher.afid===currentUser.afid?'bg-yellow-50 border-yellow-400':'bg-gray-50 border-gray-200'
          }`}>
            <div className="flex justify-between items-center">
              <div className="flex-1">
                <div className="font-bold text-lg">
                  {teacher.name} {teacher.afid===currentUser.afid&&'(You)'}
                </div>
                <div className="text-sm text-gray-600">{teacher.subject}</div>
              </div>
              <div className="text-right">
                {todayAttendance?(
                  <>
                    <div className={`text-2xl font-bold ${
                      todayAttendance.status==='Present'?'text-green-600':'text-orange-600'
                    }`}>
                      ‚è∞ {todayAttendance.punchInTime||'--:--'}
                    </div>
                    <div className={`text-xs font-semibold ${
                      todayAttendance.status==='Present'?'text-green-600':'text-orange-600'
                    }`}>
                      {todayAttendance.status}
                    </div>
                  </>
                ):(
                  <div className="text-gray-400 font-semibold">Not Marked</div>
                )}
              </div>
            </div>
          </div>
        );
      })
    }
  </div>
</div>
</div></div>)}
// ========================================
// CLASS VIEW COMPONENT (for Class 11 & 12 tabs)
// ========================================
function ClassView({grade, currentUser, curriculum, chapterProgress, updateChapterProgress}) {
  const [expandedChapters, setExpandedChapters] = useState({});
  const [currentDate] = useState(new Date().toISOString().split('T')[0]);

  /// Filter curriculum for the specific grade and teacher's subject
  const gradeCurriculum = useMemo(() => {
    const filtered = {};
    Object.keys(curriculum).forEach(subject => {
      if (currentUser.subject === 'All' || subject === currentUser.subject) {
        const chapters = (curriculum[subject] || []).filter(
          ch => String(ch.grade) === String(grade) || ch.grade === `Class ${grade}`
        );
        if (chapters.length > 0) {
          filtered[subject] = chapters;
        }
      }
    });
    return filtered;
  }, [curriculum, grade, currentUser.subject]);

  // Get progress for specific chapter
  const getChapterProgress = (chapterId) => {
    return chapterProgress[currentUser.school]?.[chapterId] || {};
  };

  // Toggle chapter expansion
  const toggleChapter = (chapterId) => {
    setExpandedChapters(prev => ({
      ...prev,
      [chapterId]: !prev[chapterId]
    }));
  };

  // Calculate status based on dates
  const getChapterStatus = (chapter) => {
    const progress = getChapterProgress(chapter.id);
    if (progress.completed) return 'completed';
    
    const today = new Date(currentDate);
    const plannedEnd = new Date(chapter.plannedEndDate);
    
    if (today > plannedEnd) return 'delayed';
    return 'pending';
  };

  // Count chapters by status
  const getStatusCounts = () => {
    let completed = 0, delayed = 0, pending = 0;
    Object.values(gradeCurriculum).forEach(chapters => {
      chapters.forEach(chapter => {
        const status = getChapterStatus(chapter);
        if (status === 'completed') completed++;
        else if (status === 'delayed') delayed++;
        else pending++;
      });
    });
    return { completed, delayed, pending };
  };

  const statusCounts = getStatusCounts();
  const totalChapters = statusCounts.completed + statusCounts.delayed + statusCounts.pending;

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex justify-between items-center">
        <h2 className="text-3xl font-bold">üìö Class {grade} Curriculum</h2>
        <div className="text-sm text-gray-600">
          Subject: <span className="font-bold">{currentUser.subject}</span>
        </div>
      </div>

      {/* Summary Cards */}
      <div className="grid md:grid-cols-4 gap-4">
        <div className="stat-card bg-blue-500 text-white">
          <div className="text-sm opacity-90">Total Chapters</div>
          <div className="text-4xl font-bold">{totalChapters}</div>
        </div>
        <div className="stat-card bg-green-500 text-white">
          <div className="text-sm opacity-90">‚úì Completed</div>
          <div className="text-4xl font-bold">{statusCounts.completed}</div>
        </div>
        <div className="stat-card bg-orange-500 text-white">
          <div className="text-sm opacity-90">‚ö† Delayed</div>
          <div className="text-4xl font-bold">{statusCounts.delayed}</div>
        </div>
        <div className="stat-card bg-red-500 text-white">
          <div className="text-sm opacity-90">‚è≥ Pending</div>
          <div className="text-4xl font-bold">{statusCounts.pending}</div>
        </div>
      </div>

      {/* Chapters by Subject */}
      {Object.keys(gradeCurriculum).length === 0 ? (
        <div className="bg-white p-12 rounded-2xl shadow-lg text-center">
          <div className="text-6xl mb-4">üì≠</div>
          <p className="text-xl text-gray-600">No chapters found for Class {grade}</p>
        </div>
      ) : (
        Object.keys(gradeCurriculum).map(subject => {
          const chapters = gradeCurriculum[subject];
          if (chapters.length === 0) return null;

          return (
            <div key={subject} className="bg-white p-6 rounded-2xl shadow-lg">
              <h3 className="text-2xl font-bold mb-4 text-blue-600">
                {subject} ({chapters.length} chapters)
              </h3>
              
              <div className="space-y-4">
                {chapters.map(chapter => {
                  const progress = getChapterProgress(chapter.id);
                  const status = getChapterStatus(chapter);
                  const isExpanded = expandedChapters[chapter.id];

                  return (
                    <div
                      key={chapter.id}
                      className={`chapter-card ${status} border-2 rounded-xl p-4`}
                    >
                      {/* Chapter Header */}
                      <div 
                        className="flex justify-between items-start cursor-pointer"
                        onClick={() => toggleChapter(chapter.id)}
                      >
                        <div className="flex-1">
                          <div className="flex items-center gap-3 mb-2">
                            <h4 className="text-lg font-bold">{chapter.name}</h4>
                            <span className={`status-badge status-${status}`}>
                              {status === 'completed' ? '‚úì Done' : 
                               status === 'delayed' ? '‚ö† Delayed' : '‚è≥ Pending'}
                            </span>
                          </div>
                          <div className="text-sm text-gray-600 space-y-1">
                            <div><strong>Duration:</strong> {chapter.duration} days</div>
                            <div><strong>Planned:</strong> {chapter.plannedStartDate} ‚Üí {chapter.plannedEndDate}</div>
                            {progress.actualStartDate && (
                              <div><strong>Actual Start:</strong> {progress.actualStartDate}</div>
                            )}
                            {progress.completed && progress.actualEndDate && (
                              <div><strong>Actual End:</strong> {progress.actualEndDate}</div>
                            )}
                          </div>
                        </div>
                        <button className="text-2xl">
                          {isExpanded ? '‚ñ≤' : '‚ñº'}
                        </button>
                      </div>

                      {/* Expanded Details */}
                      {isExpanded && (
                        <div className="mt-4 pt-4 border-t-2 chapter-details">
                          <div className="grid md:grid-cols-2 gap-4 mb-4">
                            {/* Actual Start Date */}
                            <div>
                              <label className="block text-sm font-semibold mb-2">
                                Actual Start Date
                              </label>
                              <input
                                type="date"
                                value={progress.actualStartDate || ''}
                                onChange={(e) => {
                                  updateChapterProgress(chapter.id, {
                                    ...progress,
                                    actualStartDate: e.target.value
                                  });
                                }}
                                className="w-full px-3 py-2 border-2 rounded-lg"
                              />
                            </div>

                            {/* Actual End Date */}
                            <div>
                              <label className="block text-sm font-semibold mb-2">
                                Actual End Date
                              </label>
                              <input
                                type="date"
                                value={progress.actualEndDate || ''}
                                onChange={(e) => {
                                  updateChapterProgress(chapter.id, {
                                    ...progress,
                                    actualEndDate: e.target.value
                                  });
                                }}
                                className="w-full px-3 py-2 border-2 rounded-lg"
                              />
                            </div>
                          </div>

                          {/* Completion Checkbox */}
                          <label className="flex items-center gap-3 p-3 bg-gray-50 rounded-lg cursor-pointer">
                            <input
                              type="checkbox"
                              checked={progress.completed || false}
                              onChange={(e) => {
                                updateChapterProgress(chapter.id, {
                                  ...progress,
                                  completed: e.target.checked,
                                  actualEndDate: e.target.checked && !progress.actualEndDate 
                                    ? currentDate 
                                    : progress.actualEndDate
                                });
                              }}
                            />
                            <span className="font-semibold">Mark as Completed</span>
                          </label>

                          {/* Notes */}
                          <div className="mt-4">
                            <label className="block text-sm font-semibold mb-2">
                              Notes / Remarks
                            </label>
                            <textarea
                              value={progress.notes || ''}
                              onChange={(e) => {
                                updateChapterProgress(chapter.id, {
                                  ...progress,
                                  notes: e.target.value
                                });
                              }}
                              className="w-full px-3 py-2 border-2 rounded-lg"
                              rows="3"
                              placeholder="Add any notes about this chapter..."
                            />
                          </div>
                        </div>
                      )}
                    </div>
                  );
                })}
              </div>
            </div>
          );
        })
      )}
    </div>
  );
}    
function TeacherAnalytics({currentUser,curriculum,chapterProgress}){
  const chart1Ref=useRef(null);
  const chart2Ref=useRef(null);
  const chart3Ref=useRef(null);
  const chart4Ref=useRef(null);
  const chart5Ref=useRef(null);
  
  const chartInstances=useRef({});
  
  const mySchool=currentUser.school;
  const mySubject=currentUser.subject;
  
  // My school data
  const myData=useMemo(()=>{
    const data={
      11:{total:0,completed:0,testsCompleted:0,testsPending:0},
      12:{total:0,completed:0,testsCompleted:0,testsPending:0}
    };
    let totalDays=0;
    let chaptersWithDates=0;
    
    ['11','12'].forEach(grade=>{
      const docId=`${mySchool}_${mySubject}_${grade}`;
      const chapters=curriculum[docId]?.chapters||[];
      chapters.forEach(ch=>{
        data[grade].total++;
        const progressId=`${mySchool}_${ch.id}`;
        const prog=chapterProgress[progressId]||{};
        
        if(prog.completed==='Yes'){
          data[grade].completed++;
          
          if(prog.testConducted==='Yes'){
            data[grade].testsCompleted++;
          }else{
            data[grade].testsPending++;
          }
          
          if(prog.completionDate&&ch.targetDate){
            const target=new Date(ch.targetDate);
            const completion=new Date(prog.completionDate);
            const days=Math.abs(Math.ceil((completion-target)/(1000*60*60*24)));
            totalDays+=days;
            chaptersWithDates++;
          }
        }
      })
    });
    
    const avgDays=chaptersWithDates?Math.round(totalDays/chaptersWithDates):0;
    return{...data,avgDays};
  },[curriculum,chapterProgress,mySchool,mySubject]);

  // All schools comparison data
  const allSchoolsData=useMemo(()=>{
    const data={};
    SCHOOLS.forEach(school=>{
      data[school]={
        11:{total:0,completed:0,testsCompleted:0},
        12:{total:0,completed:0,testsCompleted:0}
      };
      
      ['11','12'].forEach(grade=>{
        const docId=`${school}_${mySubject}_${grade}`;
        const chapters=curriculum[docId]?.chapters||[];
        chapters.forEach(ch=>{
          data[school][grade].total++;
          const progressId=`${school}_${ch.id}`;
          const prog=chapterProgress[progressId]||{};
          if(prog.completed==='Yes'){
            data[school][grade].completed++;
            if(prog.testConducted==='Yes'){
              data[school][grade].testsCompleted++;
            }
          }
        })
      });
    });
    return data;
  },[curriculum,chapterProgress,mySubject]);

  useEffect(()=>{
    Object.values(chartInstances.current).forEach(c=>c&&c.destroy());
    chartInstances.current={};

    // Chart 1: My Chapter Progress (11th & 12th)
    if(chart1Ref.current){
      const ctx=chart1Ref.current.getContext('2d');
      chartInstances.current.chart1=new Chart(ctx,{
        type:'bar',
        data:{
          labels:['Class 11','Class 12'],
          datasets:[{
            label:'Completed',
            data:[myData[11].completed,myData[12].completed],
            backgroundColor:'#10B981'
          },{
            label:'Pending',
            data:[
              myData[11].total-myData[11].completed,
              myData[12].total-myData[12].completed
            ],
            backgroundColor:'#F59E0B'
          }]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            title:{display:true,text:'My Chapter Progress',font:{size:16,weight:'bold'}},
            legend:{position:'bottom'}
          },
          scales:{x:{stacked:true},y:{stacked:true,beginAtZero:true}}
        }
      });
    }

    // Chart 2: My Tests Status (11th & 12th)
    if(chart2Ref.current){
      const ctx=chart2Ref.current.getContext('2d');
      chartInstances.current.chart2=new Chart(ctx,{
        type:'bar',
        data:{
          labels:['Class 11','Class 12'],
          datasets:[{
            label:'Tests Completed',
            data:[myData[11].testsCompleted,myData[12].testsCompleted],
            backgroundColor:'#3B82F6'
          },{
            label:'Tests Pending',
            data:[myData[11].testsPending,myData[12].testsPending],
            backgroundColor:'#EF4444'
          }]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            title:{display:true,text:'My Tests Status',font:{size:16,weight:'bold'}},
            legend:{position:'bottom'}
          },
          scales:{y:{beginAtZero:true}}
        }
      });
    }

    // Chart 3: Class 11 - School Comparison
    if(chart3Ref.current){
      const ctx=chart3Ref.current.getContext('2d');
      chartInstances.current.chart3=new Chart(ctx,{
        type:'bar',
        data:{
          labels:SCHOOLS,
          datasets:[{
            label:'Chapters Completed',
            data:SCHOOLS.map(s=>allSchoolsData[s][11].completed),
            backgroundColor:SCHOOLS.map(s=>s===mySchool?'#C8342E':'#10B981'),
            borderWidth:SCHOOLS.map(s=>s===mySchool?3:0),
            borderColor:'#000'
          }]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            title:{display:true,text:`Class 11 ${mySubject} - School Comparison`,font:{size:16,weight:'bold'}},
            legend:{display:false}
          },
          scales:{y:{beginAtZero:true}}
        }
      });
    }

    // Chart 4: Class 12 - School Comparison
    if(chart4Ref.current){
      const ctx=chart4Ref.current.getContext('2d');
      chartInstances.current.chart4=new Chart(ctx,{
        type:'bar',
        data:{
          labels:SCHOOLS,
          datasets:[{
            label:'Chapters Completed',
            data:SCHOOLS.map(s=>allSchoolsData[s][12].completed),
            backgroundColor:SCHOOLS.map(s=>s===mySchool?'#C8342E':'#10B981'),
            borderWidth:SCHOOLS.map(s=>s===mySchool?3:0),
            borderColor:'#000'
          }]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            title:{display:true,text:`Class 12 ${mySubject} - School Comparison`,font:{size:16,weight:'bold'}},
            legend:{display:false}
          },
          scales:{y:{beginAtZero:true}}
        }
      });
    }

    // Chart 5: Tests Comparison - All Schools
    if(chart5Ref.current){
      const ctx=chart5Ref.current.getContext('2d');
      chartInstances.current.chart5=new Chart(ctx,{
        type:'bar',
        data:{
          labels:SCHOOLS,
          datasets:[
            {
              label:'Class 11 Tests',
              data:SCHOOLS.map(s=>allSchoolsData[s][11].testsCompleted),
              backgroundColor:'#3B82F6'
            },
            {
              label:'Class 12 Tests',
              data:SCHOOLS.map(s=>allSchoolsData[s][12].testsCompleted),
              backgroundColor:'#8B5CF6'
            }
          ]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            title:{display:true,text:`${mySubject} Tests Completed - School Comparison`,font:{size:16,weight:'bold'}},
            legend:{position:'bottom'}
          },
          scales:{y:{beginAtZero:true}}
        }
      });
    }

    return()=>{
      Object.values(chartInstances.current).forEach(c=>c&&c.destroy());
    };
  },[myData,allSchoolsData,mySchool,mySubject]);

  const handleExport=()=>{
    const exportData=[
      {
        Grade:'Class 11',
        'Total Chapters':myData[11].total,
        'Completed':myData[11].completed,
        'Tests Completed':myData[11].testsCompleted,
        'Tests Pending':myData[11].testsPending,
        'Completion %':myData[11].total?Math.round((myData[11].completed/myData[11].total)*100):0
      },
      {
        Grade:'Class 12',
        'Total Chapters':myData[12].total,
        'Completed':myData[12].completed,
        'Tests Completed':myData[12].testsCompleted,
        'Tests Pending':myData[12].testsPending,
        'Completion %':myData[12].total?Math.round((myData[12].completed/myData[12].total)*100):0
      }
    ];
    exportToExcel(exportData,`${mySubject}_analytics_${mySchool}`);
  };

  return(
    <div className="space-y-6">
      <div className="flex justify-between items-center">
        <h2 className="text-3xl font-bold">My Analytics - {mySubject}</h2>
        <button onClick={handleExport} className="px-6 py-3 bg-green-600 text-white rounded-xl font-semibold">
          üìä Export to Excel
        </button>
      </div>

      <div className="grid grid-cols-2 md:grid-cols-5 gap-4">
        <div className="stat-card">
          <div className="text-sm text-gray-600">Avg Days per Chapter</div>
          <div className="text-4xl font-bold">{myData.avgDays}</div>
        </div>
        <div className="stat-card bg-green-500 text-white">
          <div className="text-sm opacity-90">Class 11 Completed</div>
          <div className="text-4xl font-bold">{myData[11].completed}/{myData[11].total}</div>
          <div className="text-sm opacity-90">
            {myData[11].total?Math.round((myData[11].completed/myData[11].total)*100):0}%
          </div>
        </div>
        <div className="stat-card bg-green-500 text-white">
          <div className="text-sm opacity-90">Class 12 Completed</div>
          <div className="text-4xl font-bold">{myData[12].completed}/{myData[12].total}</div>
          <div className="text-sm opacity-90">
            {myData[12].total?Math.round((myData[12].completed/myData[12].total)*100):0}%
          </div>
        </div>
        <div className="stat-card bg-blue-500 text-white">
          <div className="text-sm opacity-90">Tests Completed</div>
          <div className="text-4xl font-bold">
            {myData[11].testsCompleted+myData[12].testsCompleted}
          </div>
        </div>
        <div className="stat-card bg-red-500 text-white">
          <div className="text-sm opacity-90">Tests Pending</div>
          <div className="text-4xl font-bold">
            {myData[11].testsPending+myData[12].testsPending}
          </div>
        </div>
      </div>

      <div className="grid md:grid-cols-2 gap-6">
        <div className="bg-white p-6 rounded-2xl shadow-lg" style={{height:'400px'}}>
          <canvas ref={chart1Ref}></canvas>
        </div>
        <div className="bg-white p-6 rounded-2xl shadow-lg" style={{height:'400px'}}>
          <canvas ref={chart2Ref}></canvas>
        </div>
      </div>

      <div className="bg-white p-6 rounded-2xl shadow-lg" style={{height:'400px'}}>
        <canvas ref={chart5Ref}></canvas>
      </div>

      <div className="grid md:grid-cols-2 gap-6">
        <div className="bg-white p-6 rounded-2xl shadow-lg" style={{height:'400px'}}>
          <canvas ref={chart3Ref}></canvas>
        </div>
        <div className="bg-white p-6 rounded-2xl shadow-lg" style={{height:'400px'}}>
          <canvas ref={chart4Ref}></canvas>
        </div>
      </div>
    </div>
  );
}
function TeacherCurriculum({grade,currentUser,curriculum,chapterProgress,updateChapterProgress}){
  const[expandedChapters,setExpandedChapters]=useState({});
  const mySchool=currentUser.school;
  const mySubject=currentUser.subject;
  const docId=`${mySchool}_${mySubject}_${grade}`;
  const chapters=curriculum[docId]?.chapters||[];

  const handleCompletedChange=(chapterId,value)=>{
  updateChapterProgress(mySchool,chapterId,'completed',value);
};

  return(
    <div className="space-y-6">
      <h2 className="text-3xl font-bold">Class {grade} - {mySubject}</h2>
      {chapters.length===0?
        <div className="bg-white p-8 rounded-2xl text-center">
          <p className="text-gray-600">No chapters available. Contact admin.</p>
        </div>
      :
        <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
          {chapters.map(chapter=>{
            const progressId=`${mySchool}_${chapter.id}`;
            const prog=chapterProgress[progressId]||{};
            const completedTopics=prog.completedTopics||[];
            const allTopics=chapter.topics||[];
            const progress=allTopics.length?Math.round((completedTopics.length/allTopics.length)*100):0;
            const isExpanded=expandedChapters[chapter.id];
            const status=getChapterStatus(chapter,prog);

            return(
              <div className={`chapter-card ${status.color} rounded-2xl shadow-lg p-5`}>
  <div className="flex justify-between items-start mb-3">
    <div className="flex-1">
      <h3 className="text-xl font-bold mb-2">{chapter.name}</h3>
      <div>
        {(chapter.priority==='high'||!chapter.priority)&&(
          <span className="priority-badge priority-high text-xs">
            üü¢ High Priority
          </span>
        )}
        {chapter.priority==='medium'&&(
          <span className="priority-badge priority-medium text-xs">
            üü° Medium Priority
          </span>
        )}
        {chapter.priority==='low'&&(
          <span className="priority-badge priority-low text-xs">
            üî¥ Low Priority
          </span>
        )}
      </div>
    </div>
    <button 
      onClick={(e)=>{
        e.preventDefault();
        e.stopPropagation();
        setExpandedChapters(prev=>({...prev,[chapter.id]:!prev[chapter.id]}));
      }} 
      className="text-sm px-3 py-1 bg-white rounded-lg font-semibold flex-shrink-0"
    >
      {isExpanded?'‚ñ≤':'‚ñº'}
    </button>
  </div>

                <div className={`status-badge ${status.class} mb-3`}>{status.label}</div>

                <div className="space-y-3">
                  <div>
                    <div className="flex justify-between text-sm mb-1">
                      <span className="font-semibold">Topics</span>
                      <span className="font-bold">{completedTopics.length}/{allTopics.length}</span>
                    </div>
                    <div className="h-2 bg-gray-200 rounded-full">
                      <div className="h-2 avanti-gradient rounded-full transition-all" style={{width:`${progress}%`}}/>
                    </div>
                  </div>

                  {isExpanded&&(
                    <>
                      <div className="space-y-2 max-h-40 overflow-y-auto bg-white p-2 rounded-lg">
                        {allTopics.map((topic,idx)=>{
                          const checked=completedTopics.includes(topic);
                          return(
                            <label 
  key={idx} 
  className="flex items-center gap-2 cursor-pointer p-2 hover:bg-gray-50 rounded"
  onClick={(e)=>e.stopPropagation()}
>
  <input 
    type="checkbox" 
    checked={checked}
    onClick={(e)=>e.stopPropagation()}
    onChange={(e)=>{
      e.stopPropagation();
      const updated=e.target.checked?[...completedTopics,topic]:completedTopics.filter(t=>t!==topic);
      updateChapterProgress(mySchool,chapter.id,'completedTopics',updated);
    }}
  />
                              <span className={`text-sm ${checked?'line-through text-gray-500':'font-medium'}`}>
                                {topic}
                              </span>
                            </label>
                          );
                        })}
                      </div>
                      <div className="bg-white p-3 rounded-lg">
      <label className="block text-sm font-bold mb-1">Chapter Priority</label>
      <div>
        {(chapter.priority==='high'||!chapter.priority)&&(
          <span className="priority-badge priority-high text-sm">üü¢ High Priority</span>
        )}
        {chapter.priority==='medium'&&(
          <span className="priority-badge priority-medium text-sm">üü° Medium Priority</span>
        )}
        {chapter.priority==='low'&&(
          <span className="priority-badge priority-low text-sm">üî¥ Low Priority</span>
        )}
      </div>
    </div>

                      <div className="bg-white p-3 rounded-lg">
                        <label className="block text-sm font-bold mb-1">Target Date</label>
                        <div className="text-sm">{chapter.targetDate||'‚Äî'}</div>
                      </div>

                      <div className="bg-white p-3 rounded-lg">
                        <label className="block text-sm font-bold mb-1">Completion Date *</label>
                        <input 
  type="date" 
  value={prog.completionDate||''} 
  onClick={(e)=>e.stopPropagation()}
  onChange={(e)=>{
    e.stopPropagation();
    updateChapterProgress(mySchool,chapter.id,'completionDate',e.target.value);
  }}
  className="w-full border-2 px-3 py-2 rounded-lg cursor-pointer"
/>
                      </div>

                      <div className="bg-white p-3 rounded-lg">
                        <label className="block text-sm font-bold mb-1">Test Conducted? *</label>
                        <select 
  value={prog.testConducted||'No'} 
  onClick={(e)=>e.stopPropagation()}
  onChange={(e)=>{
    e.stopPropagation();
    updateChapterProgress(mySchool,chapter.id,'testConducted',e.target.value);
  }}
  className="w-full border-2 px-3 py-2 rounded-lg cursor-pointer"
>
                          <option value="No">No</option>
                          <option value="Yes">Yes</option>
                        </select>
                      </div>

                      <div className="bg-white p-3 rounded-lg">
                        <label className="block text-sm font-bold mb-1">Chapter Completed? *</label>
                        <select 
  value={prog.completed||'No'} 
  onClick={(e)=>e.stopPropagation()}
  onChange={(e)=>{
    e.stopPropagation();
    handleCompletedChange(chapter.id,e.target.value);
  }}
  className="w-full border-2 px-3 py-2 rounded-lg cursor-pointer"
>
                          <option value="No">No</option>
                          <option value="Yes">Yes</option>
                        </select>
                      </div>

                      <div className="bg-white p-3 rounded-lg">
                        <label className="block text-sm font-bold mb-1">Notes</label>
                        <textarea 
  value={prog.notes||''} 
  onClick={(e)=>e.stopPropagation()}
  onChange={(e)=>{
    e.stopPropagation();
    updateChapterProgress(mySchool,chapter.id,'notes',e.target.value);
  }}
  className="w-full border-2 px-3 py-2 rounded-lg cursor-text" 
  rows="2" 
  placeholder="Add notes..."
/>
                      </div>
                    </>
                  )}
                </div>
              </div>
            );
          })}
        </div>
      }
    </div>
  );
}

function BirthdaysPage({teachers}){const todayBirthdays=useMemo(()=>getBirthdays(teachers,'today'),[teachers]);const weekBirthdays=useMemo(()=>getBirthdays(teachers,'week'),[teachers]);const monthBirthdays=useMemo(()=>getBirthdays(teachers,'month'),[teachers]);const todayAnniversaries=useMemo(()=>getAnniversaries(teachers,'today'),[teachers]);const weekAnniversaries=useMemo(()=>getAnniversaries(teachers,'week'),[teachers]);return(<div className="space-y-6"><h2 className="text-3xl font-bold">üéâ Celebrations</h2><div className="grid md:grid-cols-2 gap-6"><>{todayBirthdays.length>0&&<div className="birthday-card p-6 rounded-2xl"><h3 className="text-2xl font-bold text-white mb-4">üéÇ Today's Birthdays</h3>{todayBirthdays.map(t=><div key={t.id} className="bg-white p-4 rounded-lg mb-2"><div className="font-bold text-lg">{t.name}</div><div className="text-sm text-gray-600">{t.school}</div></div>)}</div>}{todayAnniversaries.length>0&&<div className="birthday-card p-6 rounded-2xl"><h3 className="text-2xl font-bold text-white mb-4">üéâ Today's Anniversaries</h3>{todayAnniversaries.map(t=>{const years=new Date().getFullYear()-new Date(t.joiningDate).getFullYear();return(<div key={t.id} className="bg-white p-4 rounded-lg mb-2"><div className="font-bold text-lg">{t.name}</div><div className="text-sm text-gray-600">{years} Years at Avanti</div></div>)})}</div>}</></div><div className="grid md:grid-cols-2 gap-6"><div className="bg-white p-6 rounded-2xl shadow-lg"><h3 className="text-xl font-bold mb-4">This Week's Birthdays</h3>{weekBirthdays.length===0?<p className="text-gray-500">No birthdays this week</p>:<div className="space-y-2">{weekBirthdays.map(t=><div key={t.id} className="p-3 bg-gray-50 rounded-lg"><div className="font-semibold">{t.name}</div><div className="text-sm text-gray-600">{new Date(t.dob).toLocaleDateString(undefined,{month:'short',day:'numeric'})}</div></div>)}</div>}</div><div className="bg-white p-6 rounded-2xl shadow-lg"><h3 className="text-xl font-bold mb-4">This Month's Birthdays</h3>{monthBirthdays.length===0?<p className="text-gray-500">No birthdays this month</p>:<div className="space-y-2 max-h-96 overflow-y-auto">{monthBirthdays.map(t=><div key={t.id} className="p-3 bg-gray-50 rounded-lg"><div className="font-semibold">{t.name}</div><div className="text-sm text-gray-600">{new Date(t.dob).toLocaleDateString(undefined,{month:'short',day:'numeric'})}</div></div>)}</div>}</div></div></div>)}

function TeacherManagement({teachers}){const[showModal,setShowModal]=useState(false);const[editingTeacher,setEditingTeacher]=useState(null);const[form,setForm]=useState({name:'',afid:'',email:'',password:'',dob:'',joiningDate:'',subject:'',school:'',phone:''});const openAddModal=()=>{setEditingTeacher(null);setForm({name:'',afid:'',email:'',password:'',dob:'',joiningDate:'',subject:'',school:'',phone:''});setShowModal(true)};const openEditModal=teacher=>{setEditingTeacher(teacher);setForm({...teacher,password:''});setShowModal(true)};const handleSave=async()=>{if(!form.afid||!form.name||!form.email||!form.subject||!form.school){alert('Please fill all required fields (AFID, Name, Email, Subject, School)');return}try{await db.collection('teachers').doc(form.afid).set({afid:form.afid,name:form.name,email:form.email.toLowerCase(),subject:form.subject,school:form.school,dob:form.dob||null,joiningDate:form.joiningDate||null,phone:form.phone||null});if(!editingTeacher&&form.password){alert(`Teacher added!\n\nCREATE FIREBASE AUTH:\n1. Firebase Console ‚Üí Authentication\n2. Add User\n3. Email: ${form.email}\n4. Password: ${form.password}`)}else{alert('Teacher updated!')}setShowModal(false)}catch(e){alert('Failed: '+e.message)}};const handleDelete=async teacher=>{if(!confirm(`Delete ${teacher.name}?`))return;try{await db.collection('teachers').doc(teacher.afid).delete();alert('Teacher deleted!')}catch(e){alert('Failed: '+e.message)}};return(<div className="space-y-6"><div className="flex justify-between items-center"><h2 className="text-3xl font-bold">Teacher Management</h2><button onClick={openAddModal} className="px-6 py-3 bg-blue-600 text-white rounded-xl font-semibold">+ Add Teacher</button></div><div className="bg-white p-6 rounded-2xl shadow-lg overflow-x-auto"><table className="w-full"><thead className="avanti-gradient-light"><tr><th className="p-3 text-left">AFID</th><th className="p-3 text-left">Name</th><th className="p-3 text-left">Email</th><th className="p-3 text-left">Subject</th><th className="p-3 text-left">School</th><th className="p-3 text-left">Actions</th></tr></thead><tbody>{teachers.map(t=><tr key={t.id} className="border-b hover:bg-gray-50"><td className="p-3 font-mono">{t.afid}</td><td className="p-3">{t.name}</td><td className="p-3 text-sm">{t.email}</td><td className="p-3">{t.subject}</td><td className="p-3">{t.school}</td><td className="p-3"><div className="flex gap-2"><button onClick={()=>openEditModal(t)} className="px-3 py-1 bg-yellow-400 rounded-lg">Edit</button><button onClick={()=>handleDelete(t)} className="px-3 py-1 bg-red-500 text-white rounded-lg">Delete</button></div></td></tr>)}</tbody></table></div>{showModal&&<div className="modal-overlay" onClick={()=>setShowModal(false)}><div className="modal-content" onClick={e=>e.stopPropagation()}><h3 className="text-2xl font-bold mb-4">{editingTeacher?'Edit Teacher':'Add New Teacher'}</h3><div className="space-y-4"><div><label className="block text-sm font-bold mb-1">AFID *</label><input type="text" value={form.afid} onChange={e=>setForm({...form,afid:e.target.value})} disabled={!!editingTeacher} className="w-full border-2 px-3 py-2 rounded-lg"/></div><div><label className="block text-sm font-bold mb-1">Name *</label><input type="text" value={form.name} onChange={e=>setForm({...form,name:e.target.value})} className="w-full border-2 px-3 py-2 rounded-lg"/></div><div><label className="block text-sm font-bold mb-1">Email *</label><input type="email" value={form.email} onChange={e=>setForm({...form,email:e.target.value})} className="w-full border-2 px-3 py-2 rounded-lg"/></div>{!editingTeacher&&<div><label className="block text-sm font-bold mb-1">Password *</label><input type="password" value={form.password} onChange={e=>setForm({...form,password:e.target.value})} className="w-full border-2 px-3 py-2 rounded-lg"/></div>}<div className="grid grid-cols-2 gap-4"><div><label className="block text-sm font-bold mb-1">Subject *</label><select value={form.subject} onChange={e=>setForm({...form,subject:e.target.value})} className="w-full border-2 px-3 py-2 rounded-lg"><option value="">Select</option>{SUBJECTS.map(s=><option key={s} value={s}>{s}</option>)}</select></div><div><label className="block text-sm font-bold mb-1">School *</label><select value={form.school} onChange={e=>setForm({...form,school:e.target.value})} className="w-full border-2 px-3 py-2 rounded-lg"><option value="">Select</option>{SCHOOLS.map(s=><option key={s} value={s}>{s}</option>)}</select></div></div><div className="grid grid-cols-2 gap-4"><div><label className="block text-sm font-bold mb-1">Date of Birth</label><input type="date" value={form.dob} onChange={e=>setForm({...form,dob:e.target.value})} className="w-full border-2 px-3 py-2 rounded-lg"/></div><div><label className="block text-sm font-bold mb-1">Joining Date</label><input type="date" value={form.joiningDate} onChange={e=>setForm({...form,joiningDate:e.target.value})} className="w-full border-2 px-3 py-2 rounded-lg"/></div></div><div><label className="block text-sm font-bold mb-1">Phone</label><input type="text" value={form.phone} onChange={e=>setForm({...form,phone:e.target.value})} className="w-full border-2 px-3 py-2 rounded-lg"/></div><div className="flex gap-3"><button onClick={handleSave} className="flex-1 avanti-gradient text-white py-3 rounded-xl font-semibold">Save</button><button onClick={()=>setShowModal(false)} className="flex-1 bg-gray-300 py-3 rounded-xl font-semibold">Cancel</button></div></div></div></div>}</div>)}

function AdminCurriculum({curriculum,addChapter,updateChapter,deleteChapter}){const[selectedSchool,setSelectedSchool]=useState(SCHOOLS[0]);const[selectedSubject,setSelectedSubject]=useState(SUBJECTS[0]);const[selectedGrade,setSelectedGrade]=useState('11');const[showAddForm,setShowAddForm]=useState(false);const[editingChapter,setEditingChapter]=useState(null);const[chapterForm,setChapterForm]=useState({name:'',topics:[],targetDate:'',priority:'medium'});const[newTopic,setNewTopic]=useState('');const fileInputRef=useRef(null);const docId=`${selectedSchool}_${selectedSubject}_${selectedGrade}`;const chapters=curriculum[docId]?.chapters||[];const handleSaveChapter=()=>{if(!chapterForm.name){alert('Chapter name is required');return}if(editingChapter){updateChapter(selectedSchool,selectedSubject,selectedGrade,editingChapter.id,chapterForm);setEditingChapter(null)}else{addChapter(selectedSchool,selectedSubject,selectedGrade,chapterForm)}setChapterForm({name:'',topics:[],targetDate:'',priority:'medium'});setShowAddForm(false)};const handleEditChapter=chapter=>{setEditingChapter(chapter);setChapterForm({
  name:chapter.name,
  topics:chapter.topics||[],
  targetDate:chapter.targetDate||'',
  priority:chapter.priority||'medium'
});setShowAddForm(true)};const handleAddTopic=()=>{if(!newTopic.trim())return;setChapterForm({...chapterForm,topics:[...chapterForm.topics,newTopic.trim()]});setNewTopic('')};const handleCSVImport=e=>{
  const file=e.target.files[0];
  if(!file)return;

  Papa.parse(file,{
    complete:async results=>{
      try{
        const rows=results.data;
        if(rows.length<2){
          alert('CSV file is empty');
          return;
        }

        let currentChapter=null;
        const chaptersToAdd=[];

        rows.forEach((row,index)=>{
          if(index===0)return; // Skip header

          const chapterName=row[0]?row[0].trim():'';
          const topicName=row[1]?row[1].trim():'';
          const targetDate=row[2]?row[2].trim():''; // Column C for target date

          if(chapterName){
            if(currentChapter){
              chaptersToAdd.push(currentChapter);
            }
            currentChapter={
  name:chapterName,
  topics:topicName?[topicName]:[],
  targetDate:targetDate||'',
  priority:'medium'  // ADD THIS LINE
};
          }else if(topicName&&currentChapter){
            currentChapter.topics.push(topicName);
          }
        });

        if(currentChapter){
          chaptersToAdd.push(currentChapter);
        }

        if(chaptersToAdd.length===0){
          alert('No valid chapters found in CSV');
          return;
        }

        for(const chapter of chaptersToAdd){
          await addChapter(selectedSchool,selectedSubject,selectedGrade,chapter);
        }

        alert(`Imported ${chaptersToAdd.length} chapters with target dates!`);
        if(fileInputRef.current)fileInputRef.current.value='';
      }catch(e){
        alert('Import failed: '+e.message);
      }
    },
    error:()=>alert('Failed to parse CSV')
  });
};return(<div className="space-y-6"><h2 className="text-3xl font-bold">Curriculum Management</h2><div className="bg-white p-6 rounded-2xl shadow-lg"><div className="grid md:grid-cols-3 gap-4 mb-4"><div><label className="block text-sm font-bold mb-2">School</label><select value={selectedSchool} onChange={e=>setSelectedSchool(e.target.value)} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed">{SCHOOLS.map(s=><option key={s} value={s}>{s}</option>)}</select></div><div><label className="block text-sm font-bold mb-2">Subject</label><select value={selectedSubject} onChange={e=>setSelectedSubject(e.target.value)} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed">{SUBJECTS.map(s=><option key={s} value={s}>{s}</option>)}</select></div><div><label className="block text-sm font-bold mb-2">Grade</label><select value={selectedGrade} onChange={e=>setSelectedGrade(e.target.value)} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"><option value="11">Class 11</option><option value="12">Class 12</option></select></div></div><div className="flex gap-3"><button onClick={()=>{setEditingChapter(null);setChapterForm({name:'',topics:[],targetDate:'',priority:'medium'});setShowAddForm(!showAddForm)}} className="px-6 py-3 bg-blue-600 text-white rounded-xl font-semibold">{showAddForm?'Cancel':'+ Add Chapter'}</button><label className="px-6 py-3 bg-green-600 text-white rounded-xl font-semibold cursor-pointer">üì§ Import CSV<input ref={fileInputRef} type="file" accept=".csv" onChange={handleCSVImport} className="hidden"/></label></div></div>{showAddForm&&<div className="bg-white p-6 rounded-2xl shadow-lg"><h4 className="text-xl font-bold mb-4">{editingChapter?'Edit Chapter':'Add New Chapter'}</h4><div className="space-y-4"><div><label className="block text-sm font-bold mb-2">Chapter Name *</label><input type="text" value={chapterForm.name} onChange={e=>setChapterForm({...chapterForm,name:e.target.value})} className="w-full border-2 px-4 py-3 rounded-xl"/></div><div><label className="block text-sm font-bold mb-2">Target Date</label><input type="date" value={chapterForm.targetDate} onChange={e=>setChapterForm({...chapterForm,targetDate:e.target.value})} className="w-full border-2 px-4 py-3 rounded-xl"/></div><div>
  <label className="block text-sm font-bold mb-2">Priority Level</label>
  <select 
    value={chapterForm.priority||'medium'} 
    onChange={e=>setChapterForm({...chapterForm,priority:e.target.value})} 
    className="w-full border-2 px-4 py-3 rounded-xl"
  >
    <option value="high">üü¢ High Priority</option>
    <option value="medium">üü° Medium Priority</option>
    <option value="low">üî¥ Low Priority</option>
  </select>
</div><div><label className="block text-sm font-bold mb-2">Topics</label><div className="flex gap-2 mb-3"><input type="text" value={newTopic} onChange={e=>setNewTopic(e.target.value)} onKeyPress={e=>e.key==='Enter'&&handleAddTopic()} className="flex-1 border-2 px-4 py-3 rounded-xl" placeholder="Enter topic"/><button onClick={handleAddTopic} className="px-6 py-3 bg-blue-600 text-white rounded-xl">Add</button></div><div className="space-y-2">{chapterForm.topics.map((topic,idx)=><div key={idx} className="flex justify-between items-center p-3 bg-gray-50 rounded-lg"><span>{topic}</span><button onClick={()=>{const updated=chapterForm.topics.filter((_,i)=>i!==idx);setChapterForm({...chapterForm,topics:updated})}} className="px-3 py-1 bg-red-500 text-white rounded-lg">Remove</button></div>)}</div></div><button onClick={handleSaveChapter} className="px-6 py-3 avanti-gradient text-white rounded-xl font-semibold">{editingChapter?'Update Chapter':'Save Chapter'}</button></div></div>}<div className="bg-white p-6 rounded-2xl shadow-lg"><h4 className="text-xl font-bold mb-4">{selectedSchool} - {selectedSubject} - Class {selectedGrade} ({chapters.length} chapters)</h4>{chapters.length===0?<p className="text-gray-500 text-center py-8">No chapters yet</p>:<div className="space-y-3">{chapters.map(ch=><div key={ch.id} className="border-2 rounded-xl p-4 hover:bg-gray-50"><div className="flex justify-between items-start"><div className="flex-1"><h5 className="font-bold text-lg">{ch.name}</h5><p className="text-sm text-gray-600">Target: {ch.targetDate||'Not set'} | Topics: {ch.topics?.length||0}</p><div className="mt-2">
    {(ch.priority==='high'||!ch.priority)&&(
      <span className="priority-badge priority-high text-xs">üü¢ High Priority</span>
    )}
    {ch.priority==='medium'&&(
      <span className="priority-badge priority-medium text-xs">üü° Medium Priority</span>
    )}
    {ch.priority==='low'&&(
      <span className="priority-badge priority-low text-xs">üî¥ Low Priority</span>
    )}
  </div>{ch.topics&&ch.topics.length>0&&<ul className="text-xs text-gray-600 ml-4 mt-2">{ch.topics.map((t,i)=><li key={i}>‚Ä¢ {t}</li>)}</ul>}</div><div className="flex gap-2"><button onClick={()=>handleEditChapter(ch)} className="px-3 py-1 bg-yellow-400 rounded-lg">Edit</button><button onClick={()=>deleteChapter(selectedSchool,selectedSubject,selectedGrade,ch.id)} className="px-3 py-1 bg-red-500 text-white rounded-lg">Delete</button></div></div></div>)}</div>}</div></div>)}
function AdminAnalytics({teachers,curriculum,chapterProgress}){
  const[filterSchool,setFilterSchool]=useState('All');
  const[filterGrade,setFilterGrade]=useState('All');
  const[filterTeacher,setFilterTeacher]=useState('All');

  const chart1Ref=useRef(null);
  const chart2Ref=useRef(null);
  const chart3Ref=useRef(null);
  const chart4Ref=useRef(null);
  const chart5Ref=useRef(null);
  const chart6Ref=useRef(null);
  const chart7Ref=useRef(null);
  const chart8Ref=useRef(null);

  const chartInstances=useRef({});

  const filteredData=useMemo(()=>{
  const data={
    totalChapters:0,
    completedChapters:0,
    delayedChapters:0,
    aheadChapters:0,
    testsCompleted:0,
    testsPending:0,
    schoolData:{},
    subjectData:{},
    gradeData:{},
    teacherData:{},
    statusData:{ahead:0,ontrack:0,delayed:0,pending:0},
    testData:{completed:0,pending:0}
  };

  const schoolsToProcess=filterSchool==='All'?SCHOOLS:[filterSchool];
  const gradesToProcess=filterGrade==='All'?['11','12']:[filterGrade];
  const teachersFiltered=filterTeacher==='All'?teachers:teachers.filter(t=>t.afid===filterTeacher);

  schoolsToProcess.forEach(school=>{
    if(!data.schoolData[school]){
      data.schoolData[school]={total:0,completed:0,delayed:0,ahead:0,tests:0,testsPending:0};
    }

    SUBJECTS.forEach(subject=>{
      if(!data.subjectData[subject]){
        data.subjectData[subject]={total:0,completed:0,testsCompleted:0,testsPending:0};
      }

      gradesToProcess.forEach(grade=>{
        if(!data.gradeData[grade]){
          data.gradeData[grade]={total:0,completed:0,testsCompleted:0,testsPending:0};
        }

        const docId=`${school}_${subject}_${grade}`;
        const chapters=curriculum[docId]?.chapters||[];

        const relevantTeachers=teachersFiltered.filter(t=>t.school===school&&t.subject===subject);
        if(filterTeacher!=='All'&&relevantTeachers.length===0)return;

        chapters.forEach(ch=>{
          data.totalChapters++;
          data.schoolData[school].total++;
          data.subjectData[subject].total++;
          data.gradeData[grade].total++;

          const progressId=`${school}_${ch.id}`;
          const prog=chapterProgress[progressId]||{};
          const status=getChapterStatus(ch,prog);

          if(prog.completed==='Yes'){
            data.completedChapters++;
            data.schoolData[school].completed++;
            data.subjectData[subject].completed++;
            data.gradeData[grade].completed++;

            if(prog.testConducted==='Yes'){
              data.testsCompleted++;
              data.schoolData[school].tests++;
              data.subjectData[subject].testsCompleted++;
              data.gradeData[grade].testsCompleted++;
              data.testData.completed++;
            }else{
              data.testsPending++;
              data.schoolData[school].testsPending++;
              data.subjectData[subject].testsPending++;
              data.gradeData[grade].testsPending++;
              data.testData.pending++;
            }

            if(status.class==='status-ahead'){
              data.aheadChapters++;
              data.schoolData[school].ahead++;
              data.statusData.ahead++;
            }else if(status.class==='status-ontrack'){
              data.statusData.ontrack++;
            }
          }

          if(status.label.includes('Delayed')){
            data.delayedChapters++;
            data.schoolData[school].delayed++;
            data.statusData.delayed++;
          }

          if(status.label==='Pending'){
            data.statusData.pending++;
          }
        });
      });
    });
  });

  teachersFiltered.forEach(teacher=>{
    if(!data.teacherData[teacher.afid]){
      data.teacherData[teacher.afid]={name:teacher.name,total:0,completed:0};
    }
  });

  return data;
},[curriculum,chapterProgress,teachers,filterSchool,filterGrade,filterTeacher]);

  useEffect(()=>{
    Object.values(chartInstances.current).forEach(chart=>{
      if(chart)chart.destroy();
    });
    chartInstances.current={};

    if(chart1Ref.current){
      const ctx=chart1Ref.current.getContext('2d');
      const schools=Object.keys(filteredData.schoolData);
      chartInstances.current.chart1=new Chart(ctx,{
        type:'bar',
        data:{
          labels:schools,
          datasets:[{
            label:'Completion %',
            data:schools.map(s=>{
              const d=filteredData.schoolData[s];
              return d.total?Math.round((d.completed/d.total)*100):0;
            }),
            backgroundColor:'#C8342E',
            borderRadius:8
          }]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            title:{display:true,text:'School-wise Completion %',font:{size:16,weight:'bold'}},
            legend:{display:false}
          },
          scales:{y:{beginAtZero:true,max:100,ticks:{callback:v=>v+'%'}}}
        }
      });
    }

    if(chart2Ref.current){
      const ctx=chart2Ref.current.getContext('2d');
      const subjects=Object.keys(filteredData.subjectData);
      chartInstances.current.chart2=new Chart(ctx,{
        type:'pie',
        data:{
          labels:subjects,
          datasets:[{
            data:subjects.map(s=>filteredData.subjectData[s].completed),
            backgroundColor:['#F4B41A','#3B82F6','#10B981','#EF4444'],
            borderWidth:2
          }]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            title:{display:true,text:'Completed Chapters by Subject',font:{size:16,weight:'bold'}},
            legend:{position:'bottom'}
          }
        }
      });
    }

    if(chart3Ref.current){
      const ctx=chart3Ref.current.getContext('2d');
      const grades=Object.keys(filteredData.gradeData);
      chartInstances.current.chart3=new Chart(ctx,{
        type:'bar',
        data:{
          labels:grades.map(g=>`Class ${g}`),
          datasets:[
            {
              label:'Completed',
              data:grades.map(g=>filteredData.gradeData[g].completed),
              backgroundColor:'#10B981'
            },
            {
              label:'Pending',
              data:grades.map(g=>filteredData.gradeData[g].total-filteredData.gradeData[g].completed),
              backgroundColor:'#F59E0B'
            }
          ]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            title:{display:true,text:'Grade-wise Progress',font:{size:16,weight:'bold'}},
            legend:{position:'bottom'}
          },
          scales:{x:{stacked:true},y:{stacked:true,beginAtZero:true}}
        }
      });
    }

    if(chart4Ref.current){
      const ctx=chart4Ref.current.getContext('2d');
      chartInstances.current.chart4=new Chart(ctx,{
        type:'doughnut',
        data:{
          labels:['Completed','Pending','Delayed'],
          datasets:[{
            data:[
              filteredData.completedChapters,
              filteredData.totalChapters-filteredData.completedChapters-filteredData.delayedChapters,
              filteredData.delayedChapters
            ],
            backgroundColor:['#10B981','#F59E0B','#EF4444'],
            borderWidth:0
          }]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            title:{display:true,text:'Overall Chapter Status',font:{size:16,weight:'bold'}},
            legend:{position:'bottom'}
          }
        }
      });
    }

    if(chart5Ref.current){
      const ctx=chart5Ref.current.getContext('2d');
      chartInstances.current.chart5=new Chart(ctx,{
        type:'pie',
        data:{
          labels:['Tests Completed','Tests Pending'],
          datasets:[{
            data:[filteredData.testsCompleted,filteredData.testsPending],
            backgroundColor:['#3B82F6','#F97316'],
            borderWidth:2
          }]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            title:{display:true,text:'Chapter Tests Status',font:{size:16,weight:'bold'}},
            legend:{position:'bottom'}
          }
        }
      });
    }

    if(chart6Ref.current){
      const ctx=chart6Ref.current.getContext('2d');
      chartInstances.current.chart6=new Chart(ctx,{
        type:'bar',
        data:{
          labels:['Ahead','On Track','Delayed','Pending'],
          datasets:[{
            label:'Chapters',
            data:[
              filteredData.statusData.ahead,
              filteredData.statusData.ontrack,
              filteredData.statusData.delayed,
              filteredData.statusData.pending
            ],
            backgroundColor:['#10B981','#3B82F6','#F97316','#EF4444'],
            borderRadius:8
          }]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            title:{display:true,text:'Performance Status Distribution',font:{size:16,weight:'bold'}},
            legend:{display:false}
          },
          scales:{y:{beginAtZero:true}}
        }
      });
    }

    if(chart7Ref.current){
      const ctx=chart7Ref.current.getContext('2d');
      const schools=Object.keys(filteredData.schoolData);
      chartInstances.current.chart7=new Chart(ctx,{
        type:'bar',
        data:{
          labels:schools,
          datasets:[{
            label:'Delayed Chapters',
            data:schools.map(s=>filteredData.schoolData[s].delayed),
            backgroundColor:'#EF4444',
            borderRadius:6
          }]
        },
        options:{
          indexAxis:'y',
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            title:{display:true,text:'Delayed Chapters by School',font:{size:16,weight:'bold'}},
            legend:{display:false}
          },
          scales:{x:{beginAtZero:true}}
        }
      });
    }

    if(chart8Ref.current){
      const ctx=chart8Ref.current.getContext('2d');
      const subjects=Object.keys(filteredData.subjectData);
      chartInstances.current.chart8=new Chart(ctx,{
        type:'doughnut',
        data:{
          labels:subjects.map(s=>`${s} - ${filteredData.subjectData[s].total?Math.round((filteredData.subjectData[s].completed/filteredData.subjectData[s].total)*100):0}%`),
          datasets:[{
            data:subjects.map(s=>filteredData.subjectData[s].completed),
            backgroundColor:['#F4B41A','#3B82F6','#10B981','#EF4444'],
            borderWidth:2
          }]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            title:{display:true,text:'Subject-wise Completion Rate',font:{size:16,weight:'bold'}},
            legend:{position:'bottom'}
          }
        }
      });
    }

    return()=>{
      Object.values(chartInstances.current).forEach(chart=>{
        if(chart)chart.destroy();
      });
    };
  },[filteredData]);

  const handleExport=()=>{
    const exportData=Object.keys(filteredData.schoolData).map(school=>({
      School:school,
      'Total Chapters':filteredData.schoolData[school].total,
      'Completed':filteredData.schoolData[school].completed,
      'Delayed':filteredData.schoolData[school].delayed,
      'Ahead':filteredData.schoolData[school].ahead,
      'Tests Completed':filteredData.schoolData[school].tests,
      'Completion %':filteredData.schoolData[school].total?Math.round((filteredData.schoolData[school].completed/filteredData.schoolData[school].total)*100):0
    }));
    exportToExcel(exportData,'admin_analytics_filtered');
  };

  return(
    <div className="space-y-6">
      <div className="flex justify-between items-center">
        <h2 className="text-3xl font-bold">üìä Analytics Dashboard</h2>
        <button onClick={handleExport} className="px-6 py-3 bg-green-600 text-white rounded-xl font-semibold">
          üì• Export Filtered Data
        </button>
      </div>

      <div className="bg-white p-6 rounded-2xl shadow-lg">
        <h3 className="text-xl font-bold mb-4">üîç Filters (Apply to All Charts)</h3>
        <div className="grid md:grid-cols-3 gap-4">
          <div>
            <label className="block text-sm font-bold mb-2">School</label>
            <select 
              value={filterSchool} 
              onChange={e=>setFilterSchool(e.target.value)}
              disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"
            >
              <option value="All">All Schools</option>
              {SCHOOLS.map(s=><option key={s} value={s}>{s}</option>)}
            </select>
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">Grade</label>
            <select 
              value={filterGrade} 
              onChange={e=>setFilterGrade(e.target.value)}
              disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"
            >
              <option value="All">All Grades</option>
              <option value="11">Class 11</option>
              <option value="12">Class 12</option>
            </select>
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">Teacher</label>
            <select 
              value={filterTeacher} 
              onChange={e=>setFilterTeacher(e.target.value)}
              disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"
            >
              <option value="All">All Teachers</option>
              {teachers.map(t=><option key={t.afid} value={t.afid}>{t.name} ({t.afid})</option>)}
            </select>
          </div>
        </div>
      </div>

      <div className="bg-white p-6 rounded-2xl shadow-lg">
        <h3 className="text-xl font-bold mb-4">üìä Overall Progress Summary</h3>
        <div className="grid grid-cols-2 md:grid-cols-5 gap-4">
          <div className="stat-card avanti-gradient text-white">
            <div className="text-sm opacity-90">Total Chapters</div>
            <div className="text-4xl font-bold">{filteredData.totalChapters}</div>
          </div>
          <div className="stat-card bg-green-500 text-white">
            <div className="text-sm opacity-90">Completed</div>
            <div className="text-3xl font-bold">{filteredData.completedChapters}/{filteredData.totalChapters}</div>
            <div className="text-lg font-semibold mt-1">
              {filteredData.totalChapters?Math.round((filteredData.completedChapters/filteredData.totalChapters)*100):0}%
            </div>
          </div>
          <div className="stat-card bg-blue-500 text-white">
            <div className="text-sm opacity-90">Tests Completed</div>
            <div className="text-3xl font-bold">{filteredData.testsCompleted}/{filteredData.completedChapters}</div>
            <div className="text-lg font-semibold mt-1">
              {filteredData.completedChapters?Math.round((filteredData.testsCompleted/filteredData.completedChapters)*100):0}%
            </div>
          </div>
          <div className="stat-card bg-purple-500 text-white">
            <div className="text-sm opacity-90">Tests Pending</div>
            <div className="text-4xl font-bold">{filteredData.testsPending}</div>
          </div>
          <div className="stat-card bg-orange-500 text-white">
            <div className="text-sm opacity-90">Delayed</div>
            <div className="text-3xl font-bold">{filteredData.delayedChapters}</div>
          </div>
        </div>
      </div>

      <div className="bg-white p-6 rounded-2xl shadow-lg">
        <h3 className="text-xl font-bold mb-4">üìö Grade-wise Breakdown</h3>
        <div className="grid md:grid-cols-2 gap-6">
          <div className="border-4 border-green-500 rounded-2xl p-6 bg-gradient-to-br from-green-50 to-emerald-50">
            <h4 className="text-2xl font-bold text-green-800 mb-4">üìó Class 11</h4>
            <div className="space-y-3">
              <div className="flex justify-between items-center p-3 bg-white rounded-lg shadow">
                <span className="font-semibold">Total Chapters:</span>
                <span className="text-2xl font-bold text-gray-800">{filteredData.gradeData['11']?.total||0}</span>
              </div>
              <div className="flex justify-between items-center p-3 bg-white rounded-lg shadow">
                <span className="font-semibold">Completed:</span>
                <span className="text-2xl font-bold text-green-600">{filteredData.gradeData['11']?.completed||0}</span>
              </div>
              <div className="flex justify-between items-center p-3 bg-white rounded-lg shadow">
                <span className="font-semibold">Tests Completed:</span>
                <span className="text-2xl font-bold text-blue-600">{filteredData.gradeData['11']?.testsCompleted||0}</span>
              </div>
              <div className="flex justify-between items-center p-3 bg-white rounded-lg shadow">
                <span className="font-semibold">Tests Pending:</span>
                <span className="text-2xl font-bold text-red-600">{filteredData.gradeData['11']?.testsPending||0}</span>
              </div>
              <div className="mt-4 p-4 bg-green-600 text-white rounded-xl text-center">
                <div className="text-sm opacity-90">Completion Rate</div>
                <div className="text-4xl font-bold">
                  {filteredData.gradeData['11']?.total?Math.round((filteredData.gradeData['11'].completed/filteredData.gradeData['11'].total)*100):0}%
                </div>
              </div>
            </div>
          </div>

          <div className="border-4 border-blue-500 rounded-2xl p-6 bg-gradient-to-br from-blue-50 to-cyan-50">
            <h4 className="text-2xl font-bold text-blue-800 mb-4">üìò Class 12</h4>
            <div className="space-y-3">
              <div className="flex justify-between items-center p-3 bg-white rounded-lg shadow">
                <span className="font-semibold">Total Chapters:</span>
                <span className="text-2xl font-bold text-gray-800">{filteredData.gradeData['12']?.total||0}</span>
              </div>
              <div className="flex justify-between items-center p-3 bg-white rounded-lg shadow">
                <span className="font-semibold">Completed:</span>
                <span className="text-2xl font-bold text-green-600">{filteredData.gradeData['12']?.completed||0}</span>
              </div>
              <div className="flex justify-between items-center p-3 bg-white rounded-lg shadow">
                <span className="font-semibold">Tests Completed:</span>
                <span className="text-2xl font-bold text-blue-600">{filteredData.gradeData['12']?.testsCompleted||0}</span>
              </div>
              <div className="flex justify-between items-center p-3 bg-white rounded-lg shadow">
                <span className="font-semibold">Tests Pending:</span>
                <span className="text-2xl font-bold text-red-600">{filteredData.gradeData['12']?.testsPending||0}</span>
              </div>
              <div className="mt-4 p-4 bg-blue-600 text-white rounded-xl text-center">
                <div className="text-sm opacity-90">Completion Rate</div>
                <div className="text-4xl font-bold">
                  {filteredData.gradeData['12']?.total?Math.round((filteredData.gradeData['12'].completed/filteredData.gradeData['12'].total)*100):0}%
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div className="grid md:grid-cols-2 lg:grid-cols-2 gap-6">
        <div className="bg-white p-6 rounded-2xl shadow-lg" style={{height:'350px'}}>
          <canvas ref={chart1Ref}></canvas>
        </div>
        <div className="bg-white p-6 rounded-2xl shadow-lg" style={{height:'350px'}}>
          <canvas ref={chart2Ref}></canvas>
        </div>
        <div className="bg-white p-6 rounded-2xl shadow-lg" style={{height:'350px'}}>
          <canvas ref={chart3Ref}></canvas>
        </div>
        <div className="bg-white p-6 rounded-2xl shadow-lg" style={{height:'350px'}}>
          <canvas ref={chart4Ref}></canvas>
        </div>
        <div className="bg-white p-6 rounded-2xl shadow-lg" style={{height:'350px'}}>
          <canvas ref={chart5Ref}></canvas>
        </div>
        <div className="bg-white p-6 rounded-2xl shadow-lg" style={{height:'350px'}}>
          <canvas ref={chart6Ref}></canvas>
        </div>
        <div className="bg-white p-6 rounded-2xl shadow-lg" style={{height:'350px'}}>
          <canvas ref={chart7Ref}></canvas>
        </div>
        <div className="bg-white p-6 rounded-2xl shadow-lg" style={{height:'350px'}}>
          <canvas ref={chart8Ref}></canvas>
        </div>
      </div>
    </div>
  );
}

function AdminChapterDetails({curriculum,chapterProgress}){const[filterSchool,setFilterSchool]=useState('All');const[filterSubject,setFilterSubject]=useState('All');const[filterGrade,setFilterGrade]=useState('All');const chapterDetails=useMemo(()=>{const details=[];const schoolsToProcess=filterSchool==='All'?SCHOOLS:[filterSchool];const subjectsToProcess=filterSubject==='All'?SUBJECTS:[filterSubject];const gradesToProcess=filterGrade==='All'?['11','12']:[filterGrade];schoolsToProcess.forEach(school=>{subjectsToProcess.forEach(subject=>{gradesToProcess.forEach(grade=>{const docId=`${school}_${subject}_${grade}`;const chapters=curriculum[docId]?.chapters||[];chapters.forEach(ch=>{const progressId=`${school}_${ch.id}`;const prog=chapterProgress[progressId]||{};details.push({school,subject,grade:`Class ${grade}`,chapterName:ch.name,targetDate:ch.targetDate||'‚Äî',completed:prog.completed||'No',completionDate:prog.completionDate||'‚Äî',testConducted:prog.testConducted||'No',notes:prog.notes||'‚Äî'})})})})});return details},[curriculum,chapterProgress,filterSchool,filterSubject,filterGrade]);const handleExport=()=>{exportToExcel(chapterDetails,'chapter_details')};return(<div className="space-y-6"><div className="flex justify-between items-center"><h2 className="text-3xl font-bold">Chapter Details</h2><button onClick={handleExport} className="px-6 py-3 bg-green-600 text-white rounded-xl font-semibold">üìä Export to Excel</button></div><div className="bg-white p-6 rounded-2xl shadow-lg"><h3 className="font-bold mb-4">Filters</h3><div className="grid md:grid-cols-3 gap-4"><div><label className="block text-sm font-bold mb-2">School</label><select value={filterSchool} onChange={e=>setFilterSchool(e.target.value)} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"><option value="All">All Schools</option>{SCHOOLS.map(s=><option key={s} value={s}>{s}</option>)}</select></div><div><label className="block text-sm font-bold mb-2">Subject</label><select value={filterSubject} onChange={e=>setFilterSubject(e.target.value)} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"><option value="All">All Subjects</option>{SUBJECTS.map(s=><option key={s} value={s}>{s}</option>)}</select></div><div><label className="block text-sm font-bold mb-2">Grade</label><select value={filterGrade} onChange={e=>setFilterGrade(e.target.value)} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"><option value="All">All Grades</option><option value="11">Class 11</option><option value="12">Class 12</option></select></div></div></div><div className="bg-white p-6 rounded-2xl shadow-lg overflow-x-auto"><h3 className="font-bold mb-4">All Chapters ({chapterDetails.length})</h3><table className="w-full"><thead className="avanti-gradient-light"><tr><th className="p-3 text-left">School</th><th className="p-3 text-left">Subject</th><th className="p-3 text-left">Grade</th><th className="p-3 text-left">Chapter Name</th><th className="p-3 text-left">Target Date</th><th className="p-3 text-left">Completed</th><th className="p-3 text-left">Completion Date</th><th className="p-3 text-left">Test Conducted</th><th className="p-3 text-left">Notes</th></tr></thead><tbody>{chapterDetails.length===0?<tr><td colSpan="9" className="p-8 text-center text-gray-500">No chapters found</td></tr>:chapterDetails.map((ch,idx)=><tr key={idx} className="border-b hover:bg-gray-50"><td className="p-3">{ch.school}</td><td className="p-3">{ch.subject}</td><td className="p-3">{ch.grade}</td><td className="p-3 font-semibold">{ch.chapterName}</td><td className="p-3 text-sm">{ch.targetDate}</td><td className="p-3"><span className={`px-2 py-1 rounded-full text-xs font-bold ${ch.completed==='Yes'?'bg-green-100 text-green-700':'bg-gray-100'}`}>{ch.completed}</span></td><td className="p-3 text-sm">{ch.completionDate}</td><td className="p-3"><span className={`px-2 py-1 rounded-full text-xs font-bold ${ch.testConducted==='Yes'?'bg-blue-100 text-blue-700':'bg-orange-100 text-orange-700'}`}>{ch.testConducted}</span></td><td className="p-3 text-sm">{ch.notes}</td></tr>)}</tbody></table></div></div>)}
// ========================================
// ADMIN STUDENT PROFILES VIEW
// ========================================
function AdminStudentProfiles(){
  const[studentProfiles,setStudentProfiles]=useState([]);
  const[filterSchool,setFilterSchool]=useState('All');
  const[filterGrade,setFilterGrade]=useState('All');

  useEffect(()=>{
    const fetchData=async()=>{
      const profilesSnap=await db.collection('studentProfiles').get();
      setStudentProfiles(profilesSnap.docs.map(d=>({...d.data(),id:d.id})));
    };
    fetchData();
  },[]);

  const filteredProfiles=studentProfiles.filter(p=>{
    if(filterSchool!=='All'&&p.school!==filterSchool)return false;
    if(filterGrade!=='All'&&p.grade!==filterGrade)return false;
    return true;
  });

  const handleExport=()=>{
    const exportData=filteredProfiles.map(p=>({
      'Student ID':p.studentId,
      'First Name':p.firstName,
      'Last Name':p.lastName,
      'Email':p.email,
      'Phone':p.phone,
      'DOB':p.dob,
      'Grade':p.grade,
      'Category':p.category,
      'Stream':p.stream,
      'School':p.school,
      'Father Name':p.fatherName,
      'Father Occupation':p.fatherOccupation,
      'Father Education':p.fatherEducation,
      'Mother Name':p.motherName,
      'Mother Occupation':p.motherOccupation,
      'Mother Education':p.motherEducation,
      'Family Income':p.familyIncome,
      'Address':p.address,
      'State':p.state,
      'District':p.district,
      'Pincode':p.pincode,
      'WhatsApp':p.whatsappNumber,
      '10th %':p.percentage10th,
      '11th %':p.percentage11th||'N/A'
    }));
    exportToExcel(exportData,'student_profiles');
  };

  return(
    <div className="space-y-6">
      <div className="flex justify-between items-center">
        <h2 className="text-3xl font-bold">üë®‚Äçüéì Student Profiles ({filteredProfiles.length})</h2>
        <button onClick={handleExport} className="px-6 py-3 bg-green-600 text-white rounded-xl font-semibold">
          üì• Export to Excel
        </button>
      </div>

      <div className="bg-white p-6 rounded-2xl shadow-lg">
        <h3 className="text-xl font-bold mb-4">üîç Filters</h3>
        <div className="grid md:grid-cols-2 gap-4">
          <div>
            <label className="block text-sm font-bold mb-2">School</label>
            <select value={filterSchool} onChange={e=>setFilterSchool(e.target.value)} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed">
              <option value="All">All Schools</option>
              {SCHOOLS.map(s=><option key={s} value={s}>{s}</option>)}
            </select>
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">Grade</label>
            <select value={filterGrade} onChange={e=>setFilterGrade(e.target.value)} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed">
              <option value="All">All Grades</option>
              <option value="11">Class 11</option>
              <option value="12">Class 12</option>
            </select>
          </div>
        </div>
      </div>

      <div className="bg-white p-6 rounded-2xl shadow-lg overflow-x-auto">
        <table className="w-full">
          <thead className="avanti-gradient-light">
            <tr>
              <th className="p-3 text-left">Student ID</th>
              <th className="p-3 text-left">Name</th>
              <th className="p-3 text-left">Grade</th>
              <th className="p-3 text-left">School</th>
              <th className="p-3 text-left">Stream</th>
              <th className="p-3 text-left">Category</th>
              <th className="p-3 text-left">10th %</th>
              <th className="p-3 text-left">Contact</th>
            </tr>
          </thead>
          <tbody>
            {filteredProfiles.length===0?(
              <tr><td colSpan="8" className="p-8 text-center text-gray-500">No student profiles found</td></tr>
            ):filteredProfiles.map(profile=>
              <tr key={profile.id} className="border-b hover:bg-gray-50">
                <td className="p-3 font-mono">{profile.studentId}</td>
                <td className="p-3 font-semibold">{profile.firstName} {profile.lastName}</td>
                <td className="p-3">{profile.grade}th</td>
                <td className="p-3">{profile.school}</td>
                <td className="p-3">{profile.stream}</td>
                <td className="p-3">{profile.category}</td>
                <td className="p-3">{profile.percentage10th}%</td>
                <td className="p-3 text-sm">{profile.phone}</td>
              </tr>
            )}
          </tbody>
        </table>
      </div>
    </div>
  );
}
function AdminBirthdays({teachers}){const todayBirthdays=useMemo(()=>getBirthdays(teachers,'today'),[teachers]);const weekBirthdays=useMemo(()=>getBirthdays(teachers,'week'),[teachers]);const monthBirthdays=useMemo(()=>getBirthdays(teachers,'month'),[teachers]);const todayAnniversaries=useMemo(()=>getAnniversaries(teachers,'today'),[teachers]);const weekAnniversaries=useMemo(()=>getAnniversaries(teachers,'week'),[teachers]);const monthAnniversaries=useMemo(()=>getAnniversaries(teachers,'month'),[teachers]);return(<div className="space-y-6"><h2 className="text-3xl font-bold">üéâ Celebrations</h2><div className="grid md:grid-cols-2 gap-6"><>{todayBirthdays.length>0&&<div className="birthday-card p-6 rounded-2xl"><h3 className="text-2xl font-bold text-white mb-4">üéÇ Today's Birthdays</h3>{todayBirthdays.map(t=><div key={t.id} className="bg-white p-4 rounded-lg mb-2"><div className="font-bold text-lg">{t.name}</div><div className="text-sm text-gray-600">{t.school} - {t.subject}</div></div>)}</div>}{todayAnniversaries.length>0&&<div className="birthday-card p-6 rounded-2xl"><h3 className="text-2xl font-bold text-white mb-4">üéâ Today's Work Anniversaries</h3>{todayAnniversaries.map(t=>{const years=new Date().getFullYear()-new Date(t.joiningDate).getFullYear();return(<div key={t.id} className="bg-white p-4 rounded-lg mb-2"><div className="font-bold text-lg">{t.name}</div><div className="text-sm text-gray-600">{years} Years - {t.school}</div></div>)})}</div>}</></div><div className="grid md:grid-cols-3 gap-6"><div className="bg-white p-6 rounded-2xl shadow-lg"><h3 className="text-xl font-bold mb-4">This Week</h3>{weekBirthdays.length===0&&weekAnniversaries.length===0?<p className="text-gray-500">No celebrations</p>:<div className="space-y-2"><>{weekBirthdays.map(t=><div key={t.id} className="p-3 bg-blue-50 rounded-lg"><div className="font-semibold">üéÇ {t.name}</div><div className="text-sm text-gray-600">{new Date(t.dob).toLocaleDateString(undefined,{month:'short',day:'numeric'})}</div></div>)}{weekAnniversaries.map(t=><div key={t.id} className="p-3 bg-green-50 rounded-lg"><div className="font-semibold">üéâ {t.name}</div><div className="text-sm text-gray-600">Work Anniversary</div></div>)}</></div>}</div><div className="bg-white p-6 rounded-2xl shadow-lg"><h3 className="text-xl font-bold mb-4">This Month - Birthdays</h3>{monthBirthdays.length===0?<p className="text-gray-500">No birthdays</p>:<div className="space-y-2 max-h-96 overflow-y-auto">{monthBirthdays.map(t=><div key={t.id} className="p-3 bg-gray-50 rounded-lg"><div className="font-semibold">{t.name}</div><div className="text-sm text-gray-600">{new Date(t.dob).toLocaleDateString(undefined,{month:'short',day:'numeric'})}</div></div>)}</div>}</div><div className="bg-white p-6 rounded-2xl shadow-lg"><h3 className="text-xl font-bold mb-4">This Month - Anniversaries</h3>{monthAnniversaries.length===0?<p className="text-gray-500">No anniversaries</p>:<div className="space-y-2 max-h-96 overflow-y-auto">{monthAnniversaries.map(t=>{const years=new Date().getFullYear()-new Date(t.joiningDate).getFullYear();return(<div key={t.id} className="p-3 bg-gray-50 rounded-lg"><div className="font-semibold">{t.name}</div><div className="text-sm text-gray-600">{years} Years</div></div>)})}</div>}</div></div></div>)}

// ========================================
// STUDENT MANAGEMENT COMPONENT
// ========================================
function StudentManagement({students}){
  const[showModal,setShowModal]=useState(false);
  const[editingStudent,setEditingStudent]=useState(null);
  const[form,setForm]=useState({school:'',grade:'',name:'',gender:'',id:''});
  const[selectedStudents,setSelectedStudents]=useState([]);
  const[filterSchool,setFilterSchool]=useState('All');
  const[filterGrade,setFilterGrade]=useState('All');
  const[selectAll,setSelectAll]=useState(false);
  const fileInputRef=useRef(null);
  const updateIdFileRef=useRef(null);

  const filteredStudents=students
  .filter(s=>{
    if(filterSchool!=='All'&&s.school!==filterSchool)return false;
    if(filterGrade!=='All'&&s.grade!==filterGrade)return false;
    return true;
  })
  .sort((a,b)=>a.name.localeCompare(b.name));

  const handleSave=async()=>{
  if(!form.school||!form.grade||!form.name||!form.gender||!form.id){
    alert('‚ö†Ô∏è Please fill all required fields:\n\n‚Ä¢ School\n‚Ä¢ Student ID\n‚Ä¢ Grade\n‚Ä¢ Name\n‚Ä¢ Gender');
    return;
  }
  
  try{
    const newDocId = `${form.school.replace(/\s+/g,'_')}_${form.id}`;
    
    if(editingStudent){
      // ============ EDITING EXISTING STUDENT ============
      const oldDocId = `${editingStudent.school.replace(/\s+/g,'_')}_${editingStudent.id}`;
      
      console.log('üìù Editing student:');
      console.log('  Old Doc ID:', oldDocId);
      console.log('  New Doc ID:', newDocId);
      
      // Check if student ID or school changed
      if(newDocId !== oldDocId){
        console.log('üîÑ ID or School changed - need to delete old doc');
        
        // Check if new ID already exists
        const existingDoc = await db.collection('students').doc(newDocId).get();
        if(existingDoc.exists){
          alert('‚ùå This Student ID already exists in this school!\n\nPlease use a different Student ID.');
          return;
        }
        
        // Delete old document
        console.log('üóëÔ∏è Deleting old document:', oldDocId);
        await db.collection('students').doc(oldDocId).delete();
      }
      
      // Save with new/same document ID
      console.log('üíæ Saving to:', newDocId);
      await db.collection('students').doc(newDocId).set({
        school: form.school,
        grade: form.grade,
        name: form.name,
        gender: form.gender,
        id: form.id,
        updatedAt: new Date().toISOString()
      });
      
      alert('‚úÖ Student updated successfully!');
      
    } else {
      // ============ ADDING NEW STUDENT ============
      console.log('‚ûï Adding new student:', newDocId);
      
      // Check if student already exists
      const existingDoc = await db.collection('students').doc(newDocId).get();
      if(existingDoc.exists){
        alert('‚ùå This Student ID already exists!\n\nStudent ID: ' + form.id + '\nSchool: ' + form.school);
        return;
      }
      
      // Create new student
      await db.collection('students').doc(newDocId).set({
        school: form.school,
        grade: form.grade,
        name: form.name,
        gender: form.gender,
        id: form.id,
        createdAt: new Date().toISOString()
      });
      
      alert('‚úÖ Student added successfully!\n\nüìù Login Details:\nStudent ID: ' + form.id + '\nPassword: pass123');
    }
    
    // Close modal and reset form
    setShowModal(false);
    setEditingStudent(null);
    setForm({school:'',grade:'',name:'',gender:'',id:''});
    
    // Reload to show changes
    console.log('üîÑ Reloading page...');
    setTimeout(() => window.location.reload(), 500);
    
  } catch(e) {
    console.error('‚ùå Save error:', e);
    alert('Failed to save student:\n\n' + e.message);
  }
};

  const openAddModal=()=>{
    setEditingStudent(null);
    setForm({school:'',grade:'',name:'',gender:'',id:''});
    setShowModal(true);
  };

  const openEditModal=(student)=>{
  console.log('Editing student:', student); // ‚úÖ Debug log
  
  setEditingStudent(student); // ‚úÖ Store entire student object
  setForm({
    school:student.school,
    grade:student.grade,
    name:student.name,
    gender:student.gender,
    id:student.id
  });
  setShowModal(true);
};

  const handleSelectAll=()=>{
    if(selectAll){
      setSelectedStudents([]);
      setSelectAll(false);
    }else{
      setSelectedStudents(filteredStudents.map(s=>s.id));
      setSelectAll(true);
    }
  };

  const handleSelectStudent=(studentId)=>{
    if(selectedStudents.includes(studentId)){
      setSelectedStudents(selectedStudents.filter(id=>id!==studentId));
    }else{
      setSelectedStudents([...selectedStudents,studentId]);
    }
  };

  const handleBulkDelete=async()=>{
    if(selectedStudents.length===0){
      alert('Please select students to delete');
      return;
    }
    if(!confirm(`Delete ${selectedStudents.length} selected students?`))return;
    
    try{
      const batch=db.batch();
      selectedStudents.forEach(id=>{
        batch.delete(db.collection('students').doc(id));
      });
      await batch.commit();
      alert(`${selectedStudents.length} students deleted!`);
      setSelectedStudents([]);
      setSelectAll(false);
    }catch(e){
      alert('Failed: '+e.message);
    }
  };

  const handleBulkUpdateSchool=async()=>{
    if(selectedStudents.length===0){
      alert('Please select students first');
      return;
    }
    const newSchool=prompt('Enter new school name:');
    if(!newSchool||!SCHOOLS.includes(newSchool)){
      alert('Invalid school name');
      return;
    }
    if(!confirm(`Update school to "${newSchool}" for ${selectedStudents.length} students?`))return;

    try{
      const batch=db.batch();
      selectedStudents.forEach(id=>{
        batch.update(db.collection('students').doc(id),{school:newSchool,updatedAt:new Date().toISOString()});
      });
      await batch.commit();
      alert(`${selectedStudents.length} students updated!`);
      setSelectedStudents([]);
      setSelectAll(false);
    }catch(e){
      alert('Failed: '+e.message);
    }
  };

  const handleBulkUpdateGrade=async()=>{
    if(selectedStudents.length===0){
      alert('Please select students first');
      return;
    }
    const newGrade=prompt('Enter new grade (11 or 12):');
    if(!newGrade||!['11','12'].includes(newGrade)){
      alert('Invalid grade. Must be 11 or 12');
      return;
    }
    if(!confirm(`Update grade to "${newGrade}" for ${selectedStudents.length} students?`))return;

    try{
      const batch=db.batch();
      selectedStudents.forEach(id=>{
        batch.update(db.collection('students').doc(id),{grade:newGrade,updatedAt:new Date().toISOString()});
      });
      await batch.commit();
      alert(`${selectedStudents.length} students updated!`);
      setSelectedStudents([]);
      setSelectAll(false);
    }catch(e){
      alert('Failed: '+e.message);
    }
  };

  const handleCSVImport=e=>{
    const file=e.target.files[0];
    if(!file)return;

    Papa.parse(file,{
      complete:async results=>{
        try{
          const rows=results.data;
          if(rows.length<2){
            alert('CSV file is empty');
            return;
          }

          let imported=0;
          let skipped=0;
          const errors=[];
          
          for(let i=1;i<rows.length;i++){
            const row=rows[i];
            const school=row[0]?row[0].trim():'';
            const studentId=row[1]?row[1].trim():'';
            const grade=row[2]?row[2].trim():'';
            const name=row[3]?row[3].trim():'';
            const gender=row[4]?row[4].trim():'';

            if(!school||!studentId||!grade||!name||!gender){
              errors.push(`Row ${i+1}: Missing required fields`);
              skipped++;
              continue;
            }

            // Check if student ID already exists
            const existingSnap=await db.collection('students').where('id','==',studentId).limit(1).get();
            if(!existingSnap.empty){
              errors.push(`Row ${i+1}: Student ID "${studentId}" already exists`);
              skipped++;
              continue;
            }

            // ‚úÖ Use compound key instead of .add()
const docId = `${school.replace(/\s+/g, '_')}_${studentId}`;
await db.collection('students').doc(docId).set({
  school,
  grade,
  name,
  gender,
  id: studentId,
  createdAt: new Date().toISOString()
});
            imported++;
          }

          let message=`‚úÖ Imported ${imported} students!`;
          if(skipped>0){
            message+=`\n‚ö†Ô∏è Skipped ${skipped} students`;
            if(errors.length>0){
              message+='\n\nErrors:\n'+errors.slice(0,5).join('\n');
              if(errors.length>5)message+=`\n... and ${errors.length-5} more`;
            }
          }
          message+='\n\nüìù Students can login with:\nStudent ID + Password: pass123';
          alert(message);
          
          if(fileInputRef.current)fileInputRef.current.value='';
        }catch(e){
          alert('Import failed: '+e.message);
        }
      },
      error:()=>alert('Failed to parse CSV')
    });
  };

  // ‚úÖ NEW: Bulk Update Student IDs
  const handleBulkUpdateIDs=e=>{
    const file=e.target.files[0];
    if(!file)return;

    Papa.parse(file,{
      complete:async results=>{
        try{
          const rows=results.data;
          if(rows.length<2){
            alert('CSV file is empty');
            return;
          }

          let updated=0;
          let notFound=0;
          const errors=[];
          const updateLog=[];
          
          for(let i=1;i<rows.length;i++){
            const row=rows[i];
            const schoolName=row[0]?row[0].trim():'';
            const studentName=row[1]?row[1].trim():'';
            const grade=row[2]?row[2].trim():'';
            const newStudentId=row[3]?row[3].trim():'';

            if(!schoolName||!studentName||!grade||!newStudentId){
              errors.push(`Row ${i+1}: Missing required fields (School, Name, Grade, Student ID)`);
              notFound++;
              continue;
            }

            // Find student by School + Name + Grade (exact match)
            const querySnap=await db.collection('students')
              .where('school','==',schoolName)
              .where('name','==',studentName)
              .where('grade','==',grade)
              .limit(1)
              .get();

            if(querySnap.empty){
              errors.push(`Row ${i+1}: Student "${studentName}" not found in ${schoolName}, Grade ${grade}`);
              notFound++;
              continue;
            }

            // Update the student ID
            const studentDoc=querySnap.docs[0];
            const oldId=studentDoc.data().id||'(blank)';
            
            await studentDoc.ref.update({
              id: newStudentId,
              updatedAt: new Date().toISOString()
            });
            
            updated++;
            updateLog.push(`‚úÖ ${studentName} (${schoolName}): ${oldId} ‚Üí ${newStudentId}`);
          }

          let message=`‚úÖ Updated ${updated} Student IDs!`;
          if(notFound>0){
            message+=`\n‚ö†Ô∏è ${notFound} students not found`;
          }
          
          if(updateLog.length>0){
            message+='\n\nüìù Updates:\n'+updateLog.slice(0,10).join('\n');
            if(updateLog.length>10)message+=`\n... and ${updateLog.length-10} more`;
          }
          
          if(errors.length>0){
            message+='\n\n‚ùå Errors:\n'+errors.slice(0,5).join('\n');
            if(errors.length>5)message+=`\n... and ${errors.length-5} more`;
          }
          
          alert(message);
          
          if(updateIdFileRef.current)updateIdFileRef.current.value='';
          window.location.reload(); // Refresh to show updated IDs
        }catch(e){
          alert('Update failed: '+e.message);
        }
      },
      error:()=>alert('Failed to parse CSV')
    });
  };

  const handleDelete = async (student) => {
  if (!confirm(`‚ö†Ô∏è Delete ${student.name}?\n\nStudent ID: ${student.id}\nSchool: ${student.school}\n\nThis action cannot be undone!`)) return;
  
  try {
    console.log('=== DELETE ATTEMPT ===');
    console.log('Student object:', student);
    
    // Try multiple document ID formats
    const formats = [
      `${student.school.replace(/\s+/g, '_')}_${student.id}`,
      `${student.school}_${student.id}`,
      student.docId
    ];
    
    console.log('Trying document IDs:', formats);
    
    let deleted = false;
    
    for (const docId of formats) {
      if (!docId) continue;
      
      const docRef = db.collection('students').doc(docId);
      const docSnap = await docRef.get();
      
      if (docSnap.exists) {
        console.log('‚úÖ Found document:', docId);
        await docRef.delete();
        deleted = true;
        break;
      } else {
        console.log('‚ùå Not found:', docId);
      }
    }
    
    if (deleted) {
      alert('‚úÖ Student deleted successfully!');
      window.location.reload();
    } else {
      alert('‚ùå Error: Could not find student document.\n\nPlease contact support.');
      console.error('Tried formats:', formats);
    }
    
  } catch (e) {
    console.error('Delete error:', e);
    alert('Failed to delete:\n\n' + e.message);
  }
};

  const handleExport=()=>{
    const exportData=students.map(s=>({
      School:s.school,
      'Student ID':s.id,
      Grade:s.grade,
      Name:s.name,
      Gender:s.gender
    }));
    exportToExcel(exportData,'students_list');
  };

  return(
    <div className="space-y-6">
      <div className="flex justify-between items-center">
        <h2 className="text-3xl font-bold">Student Management</h2>
        <div className="flex gap-3">
          <button onClick={openAddModal} className="px-6 py-3 bg-blue-600 text-white rounded-xl font-semibold">
            + Add Student
          </button>
          <label className="px-6 py-3 bg-green-600 text-white rounded-xl font-semibold cursor-pointer">
            üì§ Import CSV
            <input ref={fileInputRef} type="file" accept=".csv" onChange={handleCSVImport} className="hidden"/>
          </label>
          <label className="px-6 py-3 bg-orange-600 text-white rounded-xl font-semibold cursor-pointer">
            üîÑ Update Student IDs
            <input ref={updateIdFileRef} type="file" accept=".csv" onChange={handleBulkUpdateIDs} className="hidden"/>
          </label>
          <button onClick={handleExport} className="px-6 py-3 bg-purple-600 text-white rounded-xl font-semibold">
            üì• Export
          </button>
        </div>
      </div>

      {selectedStudents.length>0&&(
        <div className="bg-blue-50 border-2 border-blue-300 p-4 rounded-xl">
          <div className="flex justify-between items-center">
            <div className="font-bold text-blue-800">
              {selectedStudents.length} student(s) selected
            </div>
            <div className="flex gap-2">
              <button onClick={handleBulkUpdateSchool} className="px-4 py-2 bg-blue-600 text-white rounded-lg font-semibold">
                üè´ Change School
              </button>
              <button onClick={handleBulkUpdateGrade} className="px-4 py-2 bg-green-600 text-white rounded-lg font-semibold">
                üìö Change Grade
              </button>
              <button onClick={handleBulkDelete} className="px-4 py-2 bg-red-600 text-white rounded-lg font-semibold">
                üóëÔ∏è Delete Selected
              </button>
              <button onClick={()=>{setSelectedStudents([]);setSelectAll(false)}} className="px-4 py-2 bg-gray-400 text-white rounded-lg font-semibold">
                Cancel
              </button>
            </div>
          </div>
        </div>
      )}

      <div className="bg-white p-6 rounded-2xl shadow-lg">
        <h3 className="text-xl font-bold mb-4">üîç Filters</h3>
        <div className="grid md:grid-cols-2 gap-4">
          <div>
            <label className="block text-sm font-bold mb-2">School</label>
            <select value={filterSchool} onChange={e=>{setFilterSchool(e.target.value);setSelectedStudents([]);setSelectAll(false)}} className="w-full border-2 px-4 py-3 rounded-xl">
              <option value="All">All Schools</option>
              {SCHOOLS.map(s=><option key={s} value={s}>{s}</option>)}
            </select>
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">Grade</label>
            <select value={filterGrade} onChange={e=>{setFilterGrade(e.target.value);setSelectedStudents([]);setSelectAll(false)}} className="w-full border-2 px-4 py-3 rounded-xl">
              <option value="All">All Grades</option>
              <option value="11">Class 11</option>
              <option value="12">Class 12</option>
            </select>
          </div>
        </div>
      </div>

      <div className="bg-white p-4 rounded-xl border-2 border-gray-200">
        <p className="text-sm text-gray-600">
          <strong>üìã Import New Students CSV Format (5 columns):</strong>
          <br/>School Name, Student ID, Grade, Student Name, Gender
          <br/><br/>
          <strong>‚úÖ Example Row:</strong>
          <br/>CoE Barwani, STU001, 11, Raj Kumar, Male
          <br/><br/>
          <strong>üîê Login Info:</strong> Students use their Student ID + Password: <span className="font-mono bg-yellow-100 px-2 py-1 rounded">pass123</span>
        </p>
      </div>

      <div className="bg-orange-50 p-4 rounded-xl border-2 border-orange-300">
        <p className="text-sm text-gray-600">
          <strong>üîÑ Update Student IDs CSV Format (4 columns):</strong>
          <br/>School Name, Student Name, Grade, Student ID
          <br/><br/>
          <strong>‚úÖ Example Row:</strong>
          <br/>CoE Bundi, Aaditya Raj Dhawan, Class 12, 2754059028
          <br/><br/>
          <strong>‚ö° How it works:</strong> System finds existing student by matching School + Name + Grade, then updates only the Student ID field.
        </p>
      </div>

      <div className="bg-white p-6 rounded-2xl shadow-lg overflow-x-auto">
        <h3 className="font-bold mb-4">
          Showing {filteredStudents.length} of {students.length} Students
        </h3>
        <table className="w-full">
          <thead className="avanti-gradient-light">
            <tr>
              <th className="p-3">
                <input 
                  type="checkbox" 
                  checked={selectAll&&filteredStudents.length>0} 
                  onChange={handleSelectAll}
                  className="cursor-pointer"
                />
              </th>
              <th className="p-3 text-left">School</th>
              <th className="p-3 text-left">Student ID</th>
              <th className="p-3 text-left">Grade</th>
              <th className="p-3 text-left">Name</th>
              <th className="p-3 text-left">Gender</th>
              <th className="p-3 text-left">Actions</th>
            </tr>
          </thead>
          <tbody>
            {filteredStudents.length===0?(
              <tr>
                <td colSpan="7" className="p-8 text-center text-gray-500">
                  No students found
                </td>
              </tr>
            ):(
              filteredStudents.map(s=>
                <tr key={s.id} className={`border-b hover:bg-gray-50 ${selectedStudents.includes(s.id)?'bg-blue-50':''}`}>
                  <td className="p-3">
                    <input 
                      type="checkbox" 
                      checked={selectedStudents.includes(s.id)}
                      onChange={()=>handleSelectStudent(s.id)}
                      className="cursor-pointer"
                    />
                  </td>
                  <td className="p-3">{s.school}</td>
                  <td className="p-3">
                    <span className="font-mono bg-blue-100 px-2 py-1 rounded font-bold">
                      {s.id}
                    </span>
                  </td>
                  <td className="p-3">Class {s.grade}</td>
                  <td className="p-3 font-semibold">{s.name}</td>
                  <td className="p-3">{s.gender}</td>
                  <td className="p-3">
                    <div className="flex gap-2">
                      <button onClick={()=>openEditModal(s)} className="px-3 py-1 bg-yellow-400 rounded-lg font-semibold">
                        Edit
                      </button>
                      <button onClick={()=>handleDelete(s)} className="px-3 py-1 bg-red-500 text-white rounded-lg font-semibold">
                        Delete
                      </button>
                    </div>
                  </td>
                </tr>
              )
            )}
          </tbody>
        </table>
      </div>

      {showModal&&(
        <div className="modal-overlay" onClick={()=>{setShowModal(false);setEditingStudent(null)}}>
          <div className="modal-content" onClick={e=>e.stopPropagation()}>
            <h3 className="text-2xl font-bold mb-4">{editingStudent?'Edit Student':'Add New Student'}</h3>
            <div className="space-y-4">
              <div>
                <label className="block text-sm font-bold mb-1">School *</label>
                <select value={form.school} onChange={e=>setForm({...form,school:e.target.value})} className="w-full border-2 px-3 py-2 rounded-lg">
                  <option value="">Select</option>
                  {SCHOOLS.map(s=><option key={s} value={s}>{s}</option>)}
                </select>
              </div>
              <div>
                <label className="block text-sm font-bold mb-1">Student ID * (For Login)</label>
                <input 
                  type="text" 
                  value={form.id} 
                  onChange={e=>setForm({...form,id:e.target.value})} 
                  placeholder="e.g., STU001"
                  className="w-full border-2 px-3 py-2 rounded-lg"
                />
                <p className="text-xs text-gray-600 mt-1">This will be used for student login</p>
              </div>
              <div>
                <label className="block text-sm font-bold mb-1">Grade *</label>
                <select value={form.grade} onChange={e=>setForm({...form,grade:e.target.value})} className="w-full border-2 px-3 py-2 rounded-lg">
                  <option value="">Select</option>
                  <option value="11">Class 11</option>
                  <option value="12">Class 12</option>
                </select>
              </div>
              <div>
                <label className="block text-sm font-bold mb-1">Name *</label>
                <input type="text" value={form.name} onChange={e=>setForm({...form,name:e.target.value})} className="w-full border-2 px-3 py-2 rounded-lg"/>
              </div>
              <div>
                <label className="block text-sm font-bold mb-1">Gender *</label>
                <select value={form.gender} onChange={e=>setForm({...form,gender:e.target.value})} className="w-full border-2 px-3 py-2 rounded-lg">
                  <option value="">Select</option>
                  {GENDERS.map(g=><option key={g} value={g}>{g}</option>)}
                </select>
              </div>
              {!editingStudent&&(
                <div className="bg-blue-50 border-2 border-blue-300 p-3 rounded-lg">
                  <p className="text-sm text-blue-800">
                    <strong>üîê Login Credentials:</strong>
                    <br/>Student ID: <span className="font-mono">{form.id||'(will be generated)'}</span>
                    <br/>Password: <span className="font-mono bg-yellow-100 px-2 py-1 rounded">pass123</span>
                  </p>
                </div>
              )}
              <div className="flex gap-3">
                <button onClick={handleSave} className="flex-1 avanti-gradient text-white py-3 rounded-xl font-semibold">
                  Save
                </button>
                <button onClick={()=>{setShowModal(false);setEditingStudent(null);setForm({school:'',grade:'',name:'',gender:'',id:''})}} className="flex-1 bg-gray-300 py-3 rounded-xl font-semibold">
                  Cancel
                </button>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

// ========================================
// TEACHER ATTENDANCE DASHBOARD
// ========================================
function TeacherAttendanceDashboard({currentUser,students,teachers,studentAttendance,teacherAttendance}){
  const[filterGrade,setFilterGrade]=useState('All');
  const[filterSubject,setFilterSubject]=useState('All');
  const today = getTodayDate();
  const[startDate,setStartDate]=useState(today);
  const[endDate,setEndDate]=useState(today);

  const mySchool=currentUser.school;

  const chart1Ref=useRef(null);
  const chart2Ref=useRef(null);
  const chart3Ref=useRef(null);
  const chartInstances=useRef({});

  const filteredStudentAttendance=useMemo(()=>{
    return studentAttendance.filter(a=>{
      if(a.school!==mySchool)return false;
      if(filterGrade!=='All'&&a.grade!==filterGrade)return false;
      if(a.date<startDate||a.date>endDate)return false;
      return true;
    });
  },[studentAttendance,mySchool,filterGrade,startDate,endDate]);

  const filteredTeacherAttendance=useMemo(()=>{
    return teacherAttendance.filter(a=>{
      if(a.school!==mySchool)return false;
      if(filterSubject!=='All'){
        const teacher=teachers.find(t=>t.afid===a.teacherId);
        if(!teacher||teacher.subject!==filterSubject)return false;
      }
      if(a.date<startDate||a.date>endDate)return false;
      return true;
    });
  },[teacherAttendance,mySchool,teachers,filterSubject,startDate,endDate]);

  const dailyStats=useMemo(()=>{
    const stats={};
    filteredStudentAttendance.forEach(a=>{
      if(!stats[a.date]){
        stats[a.date]={present:0,absent:0};
      }
      if(a.status==='Present'){
        stats[a.date].present++;
      }else{
        stats[a.date].absent++;
      }
    });
    return stats;
  },[filteredStudentAttendance]);

  const gradeStats=useMemo(()=>{
    const stats={'11':{present:0,absent:0},'12':{present:0,absent:0}};
    filteredStudentAttendance.forEach(a=>{
      if(stats[a.grade]){
        if(a.status==='Present'){
          stats[a.grade].present++;
        }else{
          stats[a.grade].absent++;
        }
      }
    });
    return stats;
  },[filteredStudentAttendance]);

  const teacherStats=useMemo(()=>{
    const present=filteredTeacherAttendance.filter(a=>a.status==='Present').length;
    const onLeave=filteredTeacherAttendance.filter(a=>a.status==='On Leave').length;
    return{present,onLeave};
  },[filteredTeacherAttendance]);

  useEffect(()=>{
    Object.values(chartInstances.current).forEach(chart=>{
      if(chart)chart.destroy();
    });
    chartInstances.current={};

    if(chart1Ref.current){
      const ctx=chart1Ref.current.getContext('2d');
      const dates=Object.keys(dailyStats).sort();
      chartInstances.current.chart1=new Chart(ctx,{
        type:'line',
        data:{
          labels:dates.map(d=>new Date(d).getDate()+'/'+String(new Date(d).getMonth()+1)),
          datasets:[
            {
              label:'Present',
              data:dates.map(d=>dailyStats[d].present),
              borderColor:'#10B981',
              backgroundColor:'rgba(16,185,129,0.1)',
              tension:0.4,
              fill:true
            },
            {
              label:'Absent',
              data:dates.map(d=>dailyStats[d].absent),
              borderColor:'#EF4444',
              backgroundColor:'rgba(239,68,68,0.1)',
              tension:0.4,
              fill:true
            }
          ]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            title:{display:true,text:'Daily Student Attendance Trend',font:{size:16,weight:'bold'}},
            legend:{position:'bottom'}
          },
          scales:{y:{beginAtZero:true}}
        }
      });
    }

    if(chart2Ref.current){
      const ctx=chart2Ref.current.getContext('2d');
      chartInstances.current.chart2=new Chart(ctx,{
        type:'bar',
        data:{
          labels:['Class 11','Class 12'],
          datasets:[
            {
              label:'Present',
              data:[gradeStats['11'].present,gradeStats['12'].present],
              backgroundColor:'#10B981'
            },
            {
              label:'Absent',
              data:[gradeStats['11'].absent,gradeStats['12'].absent],
              backgroundColor:'#EF4444'
            }
          ]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            title:{display:true,text:'Grade-wise Attendance',font:{size:16,weight:'bold'}},
            legend:{position:'bottom'}
          },
          scales:{y:{beginAtZero:true}}
        }
      });
    }

    if(chart3Ref.current){
      const ctx=chart3Ref.current.getContext('2d');
      chartInstances.current.chart3=new Chart(ctx,{
        type:'pie',
        data:{
          labels:['Present','On Leave'],
          datasets:[{
            data:[teacherStats.present,teacherStats.onLeave],
            backgroundColor:['#10B981','#F59E0B'],
            borderWidth:2
          }]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            title:{display:true,text:'Teacher Attendance',font:{size:16,weight:'bold'}},
            legend:{position:'bottom'}
          }
        }
      });
    }

    return()=>{
      Object.values(chartInstances.current).forEach(chart=>{
        if(chart)chart.destroy();
      });
    };
  },[dailyStats,gradeStats,teacherStats]);

  const handleExportStudents=()=>{
    const exportData=filteredStudentAttendance.map(a=>({
      Date:a.date,
      Grade:a.grade,
      'Student Name':a.studentName,
      Status:a.status,
      Remarks:a.remarks||'',
      'Marked By':a.markedBy
    }));
    exportToExcel(exportData,`student_attendance_${mySchool}_${startDate}_to_${endDate}`);
  };

  const handleExportTeachers=()=>{
    const exportData=filteredTeacherAttendance.map(a=>({
      Date:a.date,
      'Teacher Name':a.teacherName,
      'Punch-In Time':a.punchInTime||'Not recorded',
      Status:a.status,
      Reason:a.reason,
      Location:a.location
    }));
    exportToExcel(exportData,`teacher_attendance_${mySchool}_${startDate}_to_${endDate}`);
  };

  return(
    <div className="space-y-6">
      <div className="flex justify-between items-center">
        <h2 className="text-3xl font-bold">üìä Attendance Dashboard - {mySchool}</h2>
      </div>

      <div className="bg-white p-6 rounded-2xl shadow-lg">
        <h3 className="text-xl font-bold mb-4">üîç Filters</h3>
        <div className="grid md:grid-cols-4 gap-4">
          <div>
            <label className="block text-sm font-bold mb-2">Student Grade</label>
            <select value={filterGrade} onChange={e=>setFilterGrade(e.target.value)} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed">
              <option value="All">All Grades</option>
              <option value="11">Class 11</option>
              <option value="12">Class 12</option>
            </select>
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">Teacher Subject</label>
            <select value={filterSubject} onChange={e=>setFilterSubject(e.target.value)} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed">
              <option value="All">All Subjects</option>
              {SUBJECTS.map(s=><option key={s} value={s}>{s}</option>)}
            </select>
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">Start Date</label>
            <input type="date" value={startDate} onChange={e=>setStartDate(e.target.value)} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"/>
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">End Date</label>
            <input type="date" value={endDate} onChange={e=>setEndDate(e.target.value)} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"/>
          </div>
        </div>
        <div className="flex gap-3 mt-4">
          <button onClick={handleExportStudents} className="px-6 py-3 bg-green-600 text-white rounded-xl font-semibold">
            üì• Export Student Attendance
          </button>
          <button onClick={handleExportTeachers} className="px-6 py-3 bg-blue-600 text-white rounded-xl font-semibold">
            üì• Export Teacher Attendance
          </button>
        </div>
      </div>

      <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div className="stat-card bg-green-500 text-white">
          <div className="text-sm opacity-90">Students Present</div>
          <div className="text-4xl font-bold">{filteredStudentAttendance.filter(a=>a.status==='Present').length}</div>
        </div>
        <div className="stat-card bg-red-500 text-white">
          <div className="text-sm opacity-90">Students Absent</div>
          <div className="text-4xl font-bold">{filteredStudentAttendance.filter(a=>a.status==='Absent').length}</div>
        </div>
        <div className="stat-card bg-blue-500 text-white">
          <div className="text-sm opacity-90">Teachers Present</div>
          <div className="text-4xl font-bold">{teacherStats.present}</div>
        </div>
        <div className="stat-card bg-orange-500 text-white">
          <div className="text-sm opacity-90">Teachers on Leave</div>
          <div className="text-4xl font-bold">{teacherStats.onLeave}</div>
        </div>
      </div>

      <div className="grid md:grid-cols-2 gap-6">
        <div className="bg-white p-6 rounded-2xl shadow-lg" style={{height:'350px'}}>
          <canvas ref={chart1Ref}></canvas>
        </div>
        <div className="bg-white p-6 rounded-2xl shadow-lg" style={{height:'350px'}}>
          <canvas ref={chart2Ref}></canvas>
        </div>
      </div>

      <div className="bg-white p-6 rounded-2xl shadow-lg" style={{height:'350px'}}>
        <canvas ref={chart3Ref}></canvas>
      </div>

      <div className="grid md:grid-cols-2 gap-6">
        <div className="bg-white p-6 rounded-2xl shadow-lg">
          <h3 className="text-xl font-bold mb-4">üìã Recent Student Attendance</h3>
          <div className="overflow-x-auto max-h-96">
            <table className="w-full">
              <thead className="avanti-gradient-light sticky top-0">
                <tr>
                  <th className="p-3 text-left">Date</th>
                  <th className="p-3 text-left">Grade</th>
                  <th className="p-3 text-left">Student</th>
                  <th className="p-3 text-left">Status</th>
                </tr>
              </thead>
              <tbody>
                {filteredStudentAttendance.slice(0,50).map((a,idx)=>
                  <tr key={idx} className="border-b hover:bg-gray-50">
                    <td className="p-3 text-sm">{a.date}</td>
                    <td className="p-3">{a.grade}</td>
                    <td className="p-3 font-semibold">{a.studentName}</td>
                    <td className="p-3">
                      <span className={`px-2 py-1 rounded-full text-xs font-bold ${a.status==='Present'?'bg-green-100 text-green-700':'bg-red-100 text-red-700'}`}>
                        {a.status}
                      </span>
                    </td>
                  </tr>
                )}
              </tbody>
            </table>
          </div>
        </div>

        <div className="bg-white p-6 rounded-2xl shadow-lg">
          <h3 className="text-xl font-bold mb-4">üë• Teacher Attendance Records</h3>
          <div className="overflow-x-auto max-h-96">
            <table className="w-full">
              <thead className="avanti-gradient-light sticky top-0">
                <tr>
                  <th className="p-3 text-left">Date</th>
                  <th className="p-3 text-left">Teacher</th>
                  <th className="p-3 text-left">Punch-In</th>
                  <th className="p-3 text-left">Status</th>
                  <th className="p-3 text-left">Reason</th>
                </tr>
              </thead>
              <tbody>
                {filteredTeacherAttendance.slice(0,50).map((a,idx)=>
                  <tr key={idx} className="border-b hover:bg-gray-50">
                    <td className="p-3 text-sm">{a.date}</td>
                    <td className="p-3 font-semibold">{a.teacherName}</td>
                    <td className="p-3">
                      <span className="font-mono font-bold text-blue-600">
                        ‚è∞ {a.punchInTime||'--:--'}
                      </span>
                    </td>
                    <td className="p-3">
                      <span className={`px-2 py-1 rounded-full text-xs font-bold ${a.status==='Present'?'bg-green-100 text-green-700':'bg-orange-100 text-orange-700'}`}>
                        {a.status}
                      </span>
                    </td>
                    <td className="p-3 text-sm">{a.reason}</td>
                  </tr>
                )}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  );
}
// ========================================
// REMARKS MODAL FOR ABSENT STUDENTS
// ========================================
function RemarksModal({student,onSave,onClose}){
  const[selectedRemark,setSelectedRemark]=useState('Sick Leave');
  const[customRemark,setCustomRemark]=useState('');

  const ABSENCE_REASONS=[
    'Sick Leave',
    'Went Home for Festival',
    'Family Emergency',
    'Medical Appointment',
    'Personal Reason',
    'Others'
  ];

  const handleSave=()=>{
    const finalRemark=selectedRemark==='Others'?customRemark:selectedRemark;
    if(selectedRemark==='Others'&&!customRemark.trim()){
      alert('Please enter a custom reason');
      return;
    }
    onSave(finalRemark);
  };

  return(
    <div className="modal-overlay" onClick={onClose}>
      <div className="modal-content" onClick={e=>e.stopPropagation()}>
        <h3 className="text-2xl font-bold mb-4">üìù Absence Remarks</h3>
        <p className="text-gray-600 mb-4">Student: <strong>{student.name}</strong></p>
        
        <div className="space-y-4">
          <div>
            <label className="block text-sm font-bold mb-2">Reason for Absence *</label>
            <select 
              value={selectedRemark} 
              onChange={e=>setSelectedRemark(e.target.value)} 
              disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"
            >
              {ABSENCE_REASONS.map(reason=>
                <option key={reason} value={reason}>{reason}</option>
              )}
            </select>
          </div>

          {selectedRemark==='Others'&&(
            <div>
              <label className="block text-sm font-bold mb-2">Please Specify *</label>
              <textarea
                value={customRemark}
                onChange={e=>setCustomRemark(e.target.value)}
                className="w-full border-2 px-4 py-3 rounded-xl"
                rows="3"
                placeholder="Enter custom reason..."
              />
            </div>
          )}

          <div className="flex gap-3 mt-6">
            <button 
              onClick={handleSave} 
              className="flex-1 bg-red-500 text-white py-3 rounded-xl font-semibold"
            >
              Mark Absent
            </button>
            <button 
              onClick={onClose} 
              className="flex-1 bg-gray-300 py-3 rounded-xl font-semibold"
            >
              Cancel
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}    
// ========================================
// STUDENT ATTENDANCE VIEW (FOR TEACHERS)
// ========================================
function StudentAttendanceView({currentUser,students,studentAttendance}){
  const[selectedGrade,setSelectedGrade]=useState('11');
  const[selectedDate,setSelectedDate]=useState(getTodayDate());
  const[attendanceMap,setAttendanceMap]=useState({});
  const[showRemarksModal,setShowRemarksModal]=useState(false);
  const[selectedStudent,setSelectedStudent]=useState(null);
  const[isLocked,setIsLocked]=useState(false);
  const[lockInfo,setLockInfo]=useState(null);
  const[isLoading,setIsLoading]=useState(false);

  const mySchool=currentUser.school;
  const filteredStudents=students
  .filter(s=>s.school===mySchool&&s.grade===selectedGrade)
  .sort((a,b)=>a.name.localeCompare(b.name));

  console.log('StudentAttendanceView Debug:',{
    mySchool,
    selectedGrade,
    totalStudents:students.length,
    filteredCount:filteredStudents.length,
    allSchools:Array.from(new Set(students.map(s=>s.school))),
    allGrades:Array.from(new Set(students.map(s=>s.grade)))
  });

  useEffect(()=>{
    const map={};
    studentAttendance
      .filter(a=>a.date===selectedDate&&a.school===mySchool&&a.grade===selectedGrade)
      .forEach(a=>{
        map[a.studentId]=a.status;
      });
    setAttendanceMap(map);
    
    // ‚úÖ Check if attendance is locked for this date
    checkAttendanceLock();
  }, [selectedDate, mySchool, selectedGrade, studentAttendance]);
  
  const checkAttendanceLock=async()=>{
    try{
      const lockId=`${mySchool}_${selectedGrade}_${selectedDate}`;
      const lockDoc=await db.collection('attendanceLocks').doc(lockId).get();
      
      if(lockDoc.exists){
        const lockData=lockDoc.data();
        setIsLocked(true);
        setLockInfo(lockData);
      }else{
        setIsLocked(false);
        setLockInfo(null);
      }
    }catch(e){
      console.error('Error checking lock:',e);
      setIsLocked(false);
      setLockInfo(null);
    }
  };
  
  const lockAttendance=async()=>{
    const confirmation=confirm('Are you sure you want to lock attendance for this date?\n\nOnce locked:\n- No teacher can mark or change attendance\n- Only admins can unlock it\n\nThis prevents duplicate entries.');
    
    if(!confirmation)return;
    
    try{
      setIsLoading(true);
      const lockId=`${mySchool}_${selectedGrade}_${selectedDate}`;
      
      await db.collection('attendanceLocks').doc(lockId).set({
        school:mySchool,
        grade:selectedGrade,
        date:selectedDate,
        lockedBy:currentUser.afid,
        lockedAt:new Date().toISOString(),
        lockedByName:currentUser.name||currentUser.afid
      });
      
      alert('‚úÖ Attendance locked successfully!\n\nNo one can modify attendance for this date now.');
      checkAttendanceLock();
    }catch(e){
      alert('Failed to lock: '+e.message);
    }finally{
      setIsLoading(false);
    }
  };
  
  const unlockAttendance=async()=>{
    if(currentUser.role!=='admin'){
      alert('Only admins can unlock attendance.');
      return;
    }
    
    const confirmation=confirm('Are you sure you want to unlock attendance for this date?\n\nTeachers will be able to mark/modify attendance again.');
    
    if(!confirmation)return;
    
    try{
      setIsLoading(true);
      const lockId=`${mySchool}_${selectedGrade}_${selectedDate}`;
      await db.collection('attendanceLocks').doc(lockId).delete();
      
      alert('‚úÖ Attendance unlocked successfully!');
      checkAttendanceLock();
    }catch(e){
      alert('Failed to unlock: '+e.message);
    }finally{
      setIsLoading(false);
    }
  };
  const handleAttendanceChange=async(studentId,status,remarks='')=>{
    // ‚úÖ CHECK IF LOCKED
        if (isLocked) {
      const lockedBy = lockInfo?.lockedByName || 'Unknown';
      const lockedAt = lockInfo?.lockedAt
        ? new Date(lockInfo.lockedAt).toLocaleString()
        : 'Unknown time';

      alert(
        '‚ùå Attendance is locked for this date!\n\n' +
        `Locked by: ${lockedBy}\n` +
        `Locked at: ${lockedAt}\n\n` +
        'Contact admin to unlock.'
      );
      return;
    }
    
    try{
      // ‚úÖ UPDATE UI FIRST (Optimistic update)
      setAttendanceMap(prev=>({...prev,[studentId]:status}));
      
      // ‚úÖ THEN save to database
      const docId=`${mySchool}_${selectedGrade}_${studentId}_${selectedDate}`;
      await db.collection('studentAttendance').doc(docId).set({
        school:mySchool,
        grade:selectedGrade,
        studentId,
        studentName:filteredStudents.find(s=>s.id===studentId)?.name||'',
        date:selectedDate,
        status,
        remarks:status==='Absent'?remarks:'',
        markedBy:currentUser.afid,
        markedAt:new Date().toISOString()
      });
    }catch(e){
      // ‚úÖ Rollback UI if save fails
      setAttendanceMap(prev=>({...prev,[studentId]:prev[studentId]||''}));
      alert('Failed: '+e.message);
    }
  };

  const handleSelectAll=async()=>{
    // ‚úÖ CHECK IF LOCKED
        if (isLocked) {
      const lockedBy = lockInfo?.lockedByName || 'Unknown';
      const lockedAt = lockInfo?.lockedAt
        ? new Date(lockInfo.lockedAt).toLocaleString()
        : 'Unknown time';

      alert(
        '‚ùå Attendance is locked for this date!\n\n' +
        `Locked by: ${lockedBy}\n` +
        `Locked at: ${lockedAt}\n\n` +
        'Contact admin to unlock.'
      );
      return;
    }
    
    try{
      for(const student of filteredStudents){
        const docId=`${mySchool}_${selectedGrade}_${student.id}_${selectedDate}`;
        await db.collection('studentAttendance').doc(docId).set({
          school:mySchool,
          grade:selectedGrade,
          studentId:student.id,
          studentName:student.name,
          date:selectedDate,
          status:'Present',
          markedBy:currentUser.afid,
          markedAt:new Date().toISOString()
        });
      }
      const newMap={};
      filteredStudents.forEach(s=>newMap[s.id]='Present');
      setAttendanceMap(newMap);
      alert('All students marked present!');
    }catch(e){
      alert('Failed: '+e.message);
    }
  };

  return(
    <div className="space-y-6">
      <h2 className="text-3xl font-bold">Student Attendance - {mySchool}</h2>

      {/* ‚úÖ LOCK STATUS BANNER */}
      {isLocked&&(
        <div className="bg-red-100 border-2 border-red-500 p-4 rounded-xl">
          <div className="flex items-center justify-between">
            <div>
              <div className="font-bold text-red-800">üîí Attendance is LOCKED for this date</div>
              <div className="text-sm text-red-700 mt-1">
                Locked by: <strong>{lockInfo?.lockedByName || 'Unknown'}</strong> on {lockInfo?.lockedAt ? new Date(lockInfo.lockedAt).toLocaleString() : 'Unknown date'}
              </div>
              <div className="text-sm text-red-700">No changes can be made to attendance for this date.</div>
            </div>
            {currentUser.role==='admin'&&(
              <button 
                onClick={unlockAttendance} 
                disabled={isLoading}
                className="px-6 py-3 bg-yellow-600 hover:bg-yellow-700 text-white rounded-xl font-semibold disabled:opacity-50">
                {isLoading?'Unlocking...':'üîì Unlock (Admin)'}
              </button>
            )}
          </div>
        </div>
      )}

      {/* ‚úÖ SUCCESS BANNER WHEN UNLOCKED */}
      {!isLocked&&selectedDate===getTodayDate()&&(
        <div className="bg-green-100 border-2 border-green-500 p-4 rounded-xl">
          <div className="flex items-center justify-between">
            <div>
              <div className="font-bold text-green-800">‚úÖ Attendance is UNLOCKED</div>
              <div className="text-sm text-green-700 mt-1">
                You can mark/modify attendance. Remember to lock it after completion to prevent duplicates.
              </div>
            </div>
            <button 
              onClick={lockAttendance} 
              disabled={isLoading}
              className="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-semibold disabled:opacity-50">
              {isLoading?'Locking...':'üîí Lock Attendance'}
            </button>
          </div>
        </div>
      )}

      <div className="bg-white p-6 rounded-2xl shadow-lg">
        <div className="grid md:grid-cols-3 gap-4 mb-4">
          <div>
            <label className="block text-sm font-bold mb-2">Grade</label>
            <select value={selectedGrade} onChange={e=>setSelectedGrade(e.target.value)} disabled={isLocked} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed">
              <option value="11">Class 11</option>
              <option value="12">Class 12</option>
            </select>
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">Date</label>
            <input type="date" value={selectedDate} onChange={e=>setSelectedDate(e.target.value)} className="w-full border-2 px-4 py-3 rounded-xl"/>
          </div>
          <div className="flex items-end">
            <button 
              onClick={handleSelectAll} 
              disabled={isLocked}
              className="w-full px-6 py-3 bg-green-600 text-white rounded-xl font-semibold disabled:opacity-50 disabled:cursor-not-allowed">
              ‚úÖ Mark All Present
            </button>
          </div>
        </div>
      </div>

      <div className="bg-white p-6 rounded-2xl shadow-lg">
        <h3 className="font-bold mb-4">Students ({filteredStudents.length})</h3>
        {filteredStudents.length===0?
          <p className="text-gray-500 text-center py-8">No students found</p>
        :
          <div className="space-y-2">
            {filteredStudents.map(student=>
              <div key={student.id} className="flex items-center justify-between p-4 border-2 rounded-xl hover:bg-gray-50">
                <div className="flex-1">
                  <div className="font-semibold text-lg">{student.name}</div>
                  <div className="text-sm text-gray-600">{student.gender}</div>
                  {attendanceMap[student.id]==='Absent'&&(
                    <div className="text-xs text-red-600 mt-1">
                      üìù {studentAttendance.find(a=>a.studentId===student.id&&a.date===selectedDate)?.remarks||'No reason provided'}
                    </div>
                  )}
                </div>
                <div className="flex gap-2">
                  <button 
                    onClick={()=>handleAttendanceChange(student.id,'Present')}
                    disabled={isLocked}
                    className={`px-6 py-2 rounded-lg font-semibold disabled:opacity-50 disabled:cursor-not-allowed ${attendanceMap[student.id]==='Present'?'bg-green-500 text-white':'bg-gray-200'}`}
                  >
                    ‚úì Present
                  </button>
                  <button 
                    onClick={()=>{
                      if(!isLocked){
                        setSelectedStudent(student);
                        setShowRemarksModal(true);
                      }
                    }}
                    disabled={isLocked}
                    className={`px-6 py-2 rounded-lg font-semibold disabled:opacity-50 disabled:cursor-not-allowed ${attendanceMap[student.id]==='Absent'?'bg-red-500 text-white':'bg-gray-200'}`}
                  >
                    ‚úó Absent
                  </button>
                </div>
              </div>
            )}
          </div>
        }
      </div>

      {showRemarksModal&&selectedStudent&&(
        <RemarksModal
          student={selectedStudent}
          onSave={(remarks)=>{
            handleAttendanceChange(selectedStudent.id,'Absent',remarks);
            setShowRemarksModal(false);
            setSelectedStudent(null);
          }}
          onClose={()=>{
            setShowRemarksModal(false);
            setSelectedStudent(null);
          }}
        />
      )}
    </div>
  );
}

// ========================================
// TEACHER ATTENDANCE VIEW
// ========================================
function TeacherAttendanceView({currentUser,teacherAttendance}){
  const[selectedDate,setSelectedDate]=useState(getTodayDate());
  const[status,setStatus]=useState('Present');
  const[reason,setReason]=useState('Present');
  const[location,setLocation]=useState('');
  const[fetchingLocation,setFetchingLocation]=useState(false);

  const todayRecord=teacherAttendance.find(a=>a.teacherId===currentUser.afid&&a.date===selectedDate);

  useEffect(()=>{
    if(todayRecord){
      setStatus(todayRecord.status);
      setReason(todayRecord.reason||'Present');
      setLocation(todayRecord.location||'');
    }
  },[todayRecord]);

  const getLocation=()=>{
    setFetchingLocation(true);
    if(navigator.geolocation){
      navigator.geolocation.getCurrentPosition(
        position=>{
          const loc=`${position.coords.latitude.toFixed(6)}, ${position.coords.longitude.toFixed(6)}`;
          setLocation(loc);
          setFetchingLocation(false);
        },
        ()=>{
          alert('Unable to fetch location');
          setFetchingLocation(false);
        }
      );
    }else{
      alert('Geolocation not supported');
      setFetchingLocation(false);
    }
  };

  const handleSubmit=async()=>{
    if(status!=='Present'&&!reason){
      alert('Please select a reason');
      return;
    }
    try{
      const now=new Date();
      const punchInTime=now.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:true});
      
      const docId=`${currentUser.afid}_${selectedDate}`;
      await db.collection('teacherAttendance').doc(docId).set({
        teacherId:currentUser.afid,
        teacherName:currentUser.name,
        school:currentUser.school,
        date:selectedDate,
        status,
        reason:status==='Present'?'Present':reason,
        location:location||'Not provided',
        punchInTime:punchInTime,
        markedAt:new Date().toISOString()
      });
      alert(`Attendance marked! ‚úì\nPunch-in time: ${punchInTime}`);
    }catch(e){
      alert('Failed: '+e.message);
    }
  };

  return(
    <div className="space-y-6">
      <h2 className="text-3xl font-bold">My Attendance</h2>

      <div className="bg-white p-6 rounded-2xl shadow-lg max-w-2xl mx-auto">
        <div className="space-y-4">
          <div>
            <label className="block text-sm font-bold mb-2">Date</label>
            <input type="date" value={selectedDate} onChange={e=>setSelectedDate(e.target.value)} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"/>
          </div>

          <div>
            <label className="block text-sm font-bold mb-2">Status *</label>
            <div className="flex gap-3">
              <button 
                onClick={()=>{setStatus('Present');setReason('Present')}}
                className={`flex-1 py-3 rounded-xl font-semibold ${status==='Present'?'bg-green-500 text-white':'bg-gray-200'}`}
              >
                ‚úì Present
              </button>
              <button 
                onClick={()=>setStatus('On Leave')}
                className={`flex-1 py-3 rounded-xl font-semibold ${status==='On Leave'?'bg-orange-500 text-white':'bg-gray-200'}`}
              >
                üìÖ On Leave
              </button>
            </div>
          </div>

          {status==='On Leave'&&(
            <div>
              <label className="block text-sm font-bold mb-2">Reason *</label>
              <select value={reason} onChange={e=>setReason(e.target.value)} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed">
                {LEAVE_REASONS.filter(r=>r!=='Present').map(r=><option key={r} value={r}>{r}</option>)}
              </select>
            </div>
          )}

          <div>
            <label className="block text-sm font-bold mb-2">Location</label>
            <div className="flex gap-2">
              <input type="text" value={location} onChange={e=>setLocation(e.target.value)} className="flex-1 border-2 px-4 py-3 rounded-xl" placeholder="Enter location or fetch GPS"/>
              <button onClick={getLocation} disabled={fetchingLocation} className="px-6 py-3 bg-blue-600 text-white rounded-xl font-semibold disabled:opacity-50">
                {fetchingLocation?'üìç Fetching...':'üìç Get GPS'}
              </button>
            </div>
            {location&&<p className="text-sm text-gray-600 mt-2">üìç {location}</p>}
          </div>

          <button onClick={handleSubmit} className="w-full avanti-gradient text-white py-4 rounded-xl font-bold text-lg">
            Submit Attendance
          </button>

          {todayRecord&&(
            <div className="mt-6 p-4 bg-green-50 border-2 border-green-200 rounded-xl">
              <h4 className="font-bold text-green-800 mb-2">‚úì Already Marked for {selectedDate}</h4>
              <p><strong>Status:</strong> {todayRecord.status}</p>
              <p><strong>Reason:</strong> {todayRecord.reason}</p>
              <p><strong>Punch-in Time:</strong> ‚è∞ {todayRecord.punchInTime||'Not recorded'}</p>
              <p><strong>Location:</strong> {todayRecord.location}</p>
            </div>
          )}
        </div>
      </div>
    </div>
  );
}

// ========================================
// ADMIN ATTENDANCE ANALYTICS
// ========================================
function AdminAttendanceAnalytics({students,teachers,studentAttendance,teacherAttendance}){
  const[filterSchool,setFilterSchool]=useState('All');
  const[filterGrade,setFilterGrade]=useState('All');
  const[startDate,setStartDate]=useState(getTodayDate().slice(0,7)+'-01');
  const[endDate,setEndDate]=useState(getTodayDate());
  const[selectedDate,setSelectedDate]=useState(getTodayDate());

  const chart1Ref=useRef(null);
  const chart2Ref=useRef(null);
  const chart3Ref=useRef(null);
  const chart4Ref=useRef(null);

  const chartInstances=useRef({});

  const filteredStudentAttendance=useMemo(()=>{
    return studentAttendance.filter(a=>{
      if(filterSchool!=='All'&&a.school!==filterSchool)return false;
      if(filterGrade!=='All'&&a.grade!==filterGrade)return false;
      if(a.date<startDate||a.date>endDate)return false;
      return true;
    });
  },[studentAttendance,filterSchool,filterGrade,startDate,endDate]);

  const filteredTeacherAttendance=useMemo(()=>{
    return teacherAttendance.filter(a=>{
      if(filterSchool!=='All'&&a.school!==filterSchool)return false;
      if(a.date<startDate||a.date>endDate)return false;
      return true;
    });
  },[teacherAttendance,filterSchool,startDate,endDate]);

  const todayStats=useMemo(()=>{
  const studentRecords=studentAttendance.filter(a=>{
    if(a.date!==selectedDate)return false;
    if(filterSchool!=='All'&&a.school!==filterSchool)return false;
    if(filterGrade!=='All'&&a.grade!==filterGrade)return false;
    return true;
  });
  const teacherRecords=teacherAttendance.filter(a=>{
    if(a.date!==selectedDate)return false;
    if(filterSchool!=='All'&&a.school!==filterSchool)return false;
    return true;
  });
  return{
    studentPresent:studentRecords.filter(r=>r.status==='Present').length,
    studentAbsent:studentRecords.filter(r=>r.status==='Absent').length,
    teacherPresent:teacherRecords.filter(r=>r.status==='Present').length,
    teacherAbsent:teacherRecords.filter(r=>r.status==='On Leave').length
  };
},[studentAttendance,teacherAttendance,selectedDate,filterSchool,filterGrade]);

  const genderStats=useMemo(()=>{
    const stats={Male:{present:0,absent:0},Female:{present:0,absent:0},Other:{present:0,absent:0}};
    filteredStudentAttendance.forEach(a=>{
      const student=students.find(s=>s.id===a.studentId);
      if(student&&stats[student.gender]){
        if(a.status==='Present'){
          stats[student.gender].present++;
        }else{
          stats[student.gender].absent++;
        }
      }
    });
    return stats;
  },[filteredStudentAttendance,students]);

  const monthlyDayStats=useMemo(()=>{
    const stats={};
    filteredStudentAttendance.forEach(a=>{
      if(!stats[a.date]){
        stats[a.date]={present:0,absent:0};
      }
      if(a.status==='Present'){
        stats[a.date].present++;
      }else{
        stats[a.date].absent++;
      }
    });
    return stats;
  },[filteredStudentAttendance]);

  useEffect(()=>{
    Object.values(chartInstances.current).forEach(chart=>{
      if(chart)chart.destroy();
    });
    chartInstances.current={};

    // Chart 1: Daily Student Attendance (Line)
    if(chart1Ref.current){
      const ctx=chart1Ref.current.getContext('2d');
      const dates=Object.keys(monthlyDayStats).sort();
      chartInstances.current.chart1=new Chart(ctx,{
        type:'line',
        data:{
          labels:dates.map(d=>new Date(d).getDate()),
          datasets:[
            {
              label:'Present',
              data:dates.map(d=>monthlyDayStats[d].present),
              borderColor:'#10B981',
              backgroundColor:'rgba(16,185,129,0.1)',
              tension:0.4,
              fill:true
            },
            {
              label:'Absent',
              data:dates.map(d=>monthlyDayStats[d].absent),
              borderColor:'#EF4444',
              backgroundColor:'rgba(239,68,68,0.1)',
              tension:0.4,
              fill:true
            }
          ]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            title:{display:true,text:'Daily Student Attendance (Month)',font:{size:16,weight:'bold'}},
            legend:{position:'bottom'}
          },
          scales:{
            y:{beginAtZero:true}
          }
        }
      });
    }

    // Chart 2: Gender-wise Attendance (Bar)
    if(chart2Ref.current){
      const ctx=chart2Ref.current.getContext('2d');
      const genders=Object.keys(genderStats);
      chartInstances.current.chart2=new Chart(ctx,{
        type:'bar',
        data:{
          labels:genders,
          datasets:[
            {
              label:'Present',
              data:genders.map(g=>genderStats[g].present),
              backgroundColor:'#10B981'
            },
            {
              label:'Absent',
              data:genders.map(g=>genderStats[g].absent),
              backgroundColor:'#EF4444'
            }
          ]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            title:{display:true,text:'Gender-wise Student Attendance',font:{size:16,weight:'bold'}},
            legend:{position:'bottom'}
          },
          scales:{
            y:{beginAtZero:true}
          }
        }
      });
    }

    // Chart 3: Teacher Attendance Status (Pie)
    if(chart3Ref.current){
      const ctx=chart3Ref.current.getContext('2d');
      const present=filteredTeacherAttendance.filter(a=>a.status==='Present').length;
      const onLeave=filteredTeacherAttendance.filter(a=>a.status==='On Leave').length;
      chartInstances.current.chart3=new Chart(ctx,{
        type:'pie',
        data:{
          labels:['Present','On Leave'],
          datasets:[{
            data:[present,onLeave],
            backgroundColor:['#10B981','#F59E0B'],
            borderWidth:2
          }]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            title:{display:true,text:'Teacher Attendance Status (Month)',font:{size:16,weight:'bold'}},
            legend:{position:'bottom'}
          }
        }
      });
    }

    // Chart 4: Overall Student Attendance (Doughnut)
    if(chart4Ref.current){
      const ctx=chart4Ref.current.getContext('2d');
      const present=filteredStudentAttendance.filter(a=>a.status==='Present').length;
      const absent=filteredStudentAttendance.filter(a=>a.status==='Absent').length;
      chartInstances.current.chart4=new Chart(ctx,{
        type:'doughnut',
        data:{
          labels:['Present','Absent'],
          datasets:[{
            data:[present,absent],
            backgroundColor:['#3B82F6','#EF4444'],
            borderWidth:0
          }]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            title:{display:true,text:'Overall Student Attendance (Month)',font:{size:16,weight:'bold'}},
            legend:{position:'bottom'}
          }
        }
      });
    }
    
    return()=>{
      Object.values(chartInstances.current).forEach(chart=>{
        if(chart)chart.destroy();
      });
    };
  },[monthlyDayStats,genderStats,filteredTeacherAttendance,filteredStudentAttendance]);

  const handleExportStudents=()=>{
    const exportData=filteredStudentAttendance.map(a=>({
      Date:a.date,
      School:a.school,
      Grade:a.grade,
      'Student Name':a.studentName,
      Status:a.status,
      Remarks:a.remarks||'',
      'Marked By':a.markedBy
    }));
    exportToExcel(exportData,`student_attendance_${startDate}_to_${endDate}`);
  };

  const handleExportTeachers=()=>{
    const exportData=filteredTeacherAttendance.map(a=>({
      Date:a.date,
      'Teacher Name':a.teacherName,
      School:a.school,
      'Punch-In Time':a.punchInTime||'Not recorded',
      Status:a.status,
      Reason:a.reason,
      Location:a.location
    }));
    exportToExcel(exportData,`teacher_attendance_${startDate}_to_${endDate}`);
  };

  return(
    <div className="space-y-6">
      <div className="flex justify-between items-center">
        <h2 className="text-3xl font-bold">üìä Attendance Analytics</h2>
        <div className="flex gap-2">
          <button onClick={handleExportStudents} className="px-4 py-2 bg-green-600 text-white rounded-xl font-semibold">
            üì• Export Students
          </button>
          <button onClick={handleExportTeachers} className="px-4 py-2 bg-blue-600 text-white rounded-xl font-semibold">
            üì• Export Teachers
          </button>
        </div>
      </div>

      <div className="bg-white p-6 rounded-2xl shadow-lg">
        <h3 className="text-xl font-bold mb-4">üîç Filters</h3>
        <div className="grid md:grid-cols-5 gap-4">
          <div>
            <label className="block text-sm font-bold mb-2">School</label>
            <select value={filterSchool} onChange={e=>setFilterSchool(e.target.value)} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed">
              <option value="All">All Schools</option>
              {SCHOOLS.map(s=><option key={s} value={s}>{s}</option>)}
            </select>
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">Grade</label>
            <select value={filterGrade} onChange={e=>setFilterGrade(e.target.value)} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed">
              <option value="All">All Grades</option>
              <option value="11">Class 11</option>
              <option value="12">Class 12</option>
            </select>
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">Start Date</label>
            <input type="date" value={startDate} onChange={e=>setStartDate(e.target.value)} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"/>
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">End Date</label>
            <input type="date" value={endDate} onChange={e=>setEndDate(e.target.value)} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"/>
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">Today's View</label>
            <input type="date" value={selectedDate} onChange={e=>setSelectedDate(e.target.value)} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"/>
          </div>
        </div>
      </div>

      <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div className="stat-card bg-green-500 text-white">
          <div className="text-sm opacity-90">Students Present Today</div>
          <div className="text-4xl font-bold">{todayStats.studentPresent}</div>
        </div>
        <div className="stat-card bg-red-500 text-white">
          <div className="text-sm opacity-90">Students Absent Today</div>
          <div className="text-4xl font-bold">{todayStats.studentAbsent}</div>
        </div>
        <div className="stat-card bg-blue-500 text-white">
          <div className="text-sm opacity-90">Teachers Present Today</div>
          <div className="text-4xl font-bold">{todayStats.teacherPresent}</div>
        </div>
        <div className="stat-card bg-orange-500 text-white">
          <div className="text-sm opacity-90">Teachers on Leave Today</div>
          <div className="text-4xl font-bold">{todayStats.teacherAbsent}</div>
        </div>
      </div>

      <div className="grid md:grid-cols-2 gap-6">
        <div className="bg-white p-6 rounded-2xl shadow-lg" style={{height:'350px'}}>
          <canvas ref={chart1Ref}></canvas>
        </div>
        <div className="bg-white p-6 rounded-2xl shadow-lg" style={{height:'350px'}}>
          <canvas ref={chart2Ref}></canvas>
        </div>
        <div className="bg-white p-6 rounded-2xl shadow-lg" style={{height:'350px'}}>
          <canvas ref={chart3Ref}></canvas>
        </div>
        <div className="bg-white p-6 rounded-2xl shadow-lg" style={{height:'350px'}}>
          <canvas ref={chart4Ref}></canvas>
        </div>
      </div>

      <div className="bg-white p-6 rounded-2xl shadow-lg">
        <h3 className="text-xl font-bold mb-4">üìã Detailed Teacher Attendance</h3>
        <div className="overflow-x-auto">
          <table className="w-full">
            <thead className="avanti-gradient-light">
                <tr>
                  <th className="p-3 text-left">Date</th>
                  <th className="p-3 text-left">Teacher</th>
                  <th className="p-3 text-left">School</th>
                  <th className="p-3 text-left">Punch-In Time</th>
                  <th className="p-3 text-left">Status</th>
                  <th className="p-3 text-left">Reason</th>
                  <th className="p-3 text-left">Location</th>
                </tr>
              </thead>
            <tbody>
              {filteredTeacherAttendance.length===0?
                <tr><td colSpan="7" className="p-8 text-center text-gray-500">No records found</td></tr>
              :
                filteredTeacherAttendance.slice(0,50).map((a,idx)=>
                  <tr key={idx} className="border-b hover:bg-gray-50">
                    <td className="p-3 text-sm">{a.date}</td>
                    <td className="p-3 font-semibold">{a.teacherName}</td>
                    <td className="p-3">{a.school}</td>
                    <td className="p-3">
                      <span className="font-mono font-bold text-blue-600 text-lg">
                        ‚è∞ {a.punchInTime||'--:--'}
                      </span>
                    </td>
                    <td className="p-3">
                      <span className={`px-2 py-1 rounded-full text-xs font-bold ${a.status==='Present'?'bg-green-100 text-green-700':'bg-orange-100 text-orange-700'}`}>
                        {a.status}
                      </span>
                    </td>
                    <td className="p-3 text-sm">{a.reason}</td>
                    <td className="p-3 text-sm">üìç {a.location}</td>
                  </tr>
                )
              }
            </tbody>
          </table>
        </div>
      </div>
    </div>
  );
}
// ========================================
// SCHOOL INFO VIEW (FOR TEACHERS)
// ========================================
function SchoolInfoView({currentUser,schoolInfo}){
  const mySchool=currentUser.school;
  const existingInfo=schoolInfo.find(info=>info.school===mySchool);
  const[isEditing,setIsEditing]=useState(false);
  
  const[formData,setFormData]=useState({
    // Principal Info
    principalName:'',
    principalPhone:'',
    principalEmail:'',
    // Vice Principal Info
    vicePrincipalName:'',
    vicePrincipalPhone:'',
    vicePrincipalEmail:'',
    // Avanti Coordinator
    coordinatorName:'',
    coordinatorPhone:'',
    coordinatorEmail:'',
    // WiFi Info
    wifiInClassroom:'No',
    wifiInstalledBy:'',
    wifiWorking:'No',
    wifiMonthlyBill:'',
    wifiConnectionType:'',
    wifiNetworkName:'',
    bothClassesWifi:'No',
    // Modules - Class 11
    modules11Received:'',
    modules11Distributed:'',
    modules11Stock:'',
    // Modules - Class 12
    modules12Received:'',
    modules12Distributed:'',
    modules12Stock:'',
    // Reference Books
    referenceBooks:[],
    // Chromebooks - Class 11
    chromebooks11Distributed:'No',
    chromebooks11Count:'',
    chromebooks11Working:'',
    chromebooks11Brand:'',
    chromebooks11DistributedDate:'',
    chromebooks11TestMethod:'',
    chromebooks11JNVLabAccess:'',
    chromebooks11JNVCount:'',
    // Chromebooks - Class 12
    chromebooks12Distributed:'No',
    chromebooks12Count:'',
    chromebooks12Working:'',
    chromebooks12Brand:'',
    chromebooks12DistributedDate:'',
    chromebooks12TestMethod:'',
    chromebooks12JNVLabAccess:'',
    chromebooks12JNVCount:'',
    // Printer
    printerAvailable:'No',
    printerWorking:'No',
    printerBrand:'',
    printerIssuedDate:'',
    // Other Assets
    otherAssets:[]
  });

  useEffect(()=>{
    if(existingInfo){
      setFormData({...existingInfo});
      setIsEditing(false);
    }else{
      setIsEditing(true);
    }
  },[existingInfo]);

  const handleAddBook=()=>{
    setFormData({
      ...formData,
      referenceBooks:[...formData.referenceBooks,{
        bookName:'',
        publisher:'',
        author:'',
        price:'',
        inStock:'',
        distributed:''
      }]
    });
  };

  const handleRemoveBook=(index)=>{
    const updated=[...formData.referenceBooks];
    updated.splice(index,1);
    setFormData({...formData,referenceBooks:updated});
  };

  const handleBookChange=(index,field,value)=>{
    const updated=[...formData.referenceBooks];
    updated[index][field]=value;
    setFormData({...formData,referenceBooks:updated});
  };

  const handleAddAsset=()=>{
    setFormData({
      ...formData,
      otherAssets:[...formData.otherAssets,{
        assetName:'',
        assetQuantity:'',
        assetCondition:'',
        assetNotes:''
      }]
    });
  };

  const handleRemoveAsset=(index)=>{
    const updated=[...formData.otherAssets];
    updated.splice(index,1);
    setFormData({...formData,otherAssets:updated});
  };

  const handleAssetChange=(index,field,value)=>{
    const updated=[...formData.otherAssets];
    updated[index][field]=value;
    setFormData({...formData,otherAssets:updated});
  };

  const handleSubmit = async () => {
  try {
    const docId = mySchool.replace(/\s+/g, '_');
    const now = new Date().toISOString();

    const historyEntry = {
      updatedBy: currentUser.afid,
      updatedByName: currentUser.name,
      updatedAt: now
    };

    await db.collection('schoolInfo').doc(docId).set({
      ...formData,
      school: mySchool,
      // latest info
      updatedBy: currentUser.afid,
      updatedByName: currentUser.name,
      updatedAt: now,
      // full history
      updateHistory: firebase.firestore.FieldValue.arrayUnion(historyEntry)
    }, { merge: true });

    setIsEditing(false);
    alert('School information saved successfully!');
  } catch (e) {
    alert('Failed to save: ' + e.message);
  }
};


  // Generate month/year options
  const generateMonthYearOptions=()=>{
    const options=[];
    for(let year=2022;year<=2025;year++){
      for(let month=1;month<=12;month++){
        const monthName=new Date(year,month-1).toLocaleString('default',{month:'long'});
        options.push(`${monthName} ${year}`);
      }
    }
    return options;
  };

  return(
  <div className="space-y-6">
    <div className="flex justify-between items-center">
      <h2 className="text-3xl font-bold">üè´ School Information - {mySchool}</h2>
      {!isEditing && existingInfo && (
        <button onClick={()=>setIsEditing(true)} className="px-6 py-3 bg-blue-600 text-white rounded-xl font-semibold hover:bg-blue-700">
          ‚úèÔ∏è Edit Information
        </button>
      )}
      {isEditing && existingInfo && (
        <button onClick={()=>{setFormData({...existingInfo});setIsEditing(false);}} className="px-6 py-3 bg-gray-600 text-white rounded-xl font-semibold hover:bg-gray-700">
          ‚ùå Cancel
        </button>
      )}
    </div>

    {existingInfo && (
      <div className="bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded-xl text-sm">
        <div>
          Last updated:{' '}
          {existingInfo.updatedAt
            ? new Date(existingInfo.updatedAt).toLocaleString()
            : 'Not filled yet'}
          {existingInfo.updatedByName && (
            <> by <span className="font-semibold">{existingInfo.updatedByName}</span></>
          )}
        </div>

        {existingInfo.updateHistory && existingInfo.updateHistory.length > 0 && (
          <div className="mt-2">
            <div className="font-semibold mb-1">Edit History (Newest First)</div>
            <ul className="max-h-32 overflow-y-auto space-y-1">
              {existingInfo.updateHistory
                .slice()
                .sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt))
                .map((entry, idx) => (
                  <li key={idx}>
                    {new Date(entry.updatedAt).toLocaleString()} ‚Äî {entry.updatedByName || entry.updatedBy}
                  </li>
                ))}
            </ul>
          </div>
        )}
      </div>
    )}

    <div className="bg-white p-6 rounded-2xl shadow-lg space-y-6">

        
        {/* Principal Information */}
        <div className="border-4 border-blue-500 rounded-2xl p-6 bg-blue-50">
          <h3 className="text-2xl font-bold mb-4 text-blue-800">üë®‚Äçüíº Principal Information</h3>
          <div className="grid md:grid-cols-3 gap-4">
            <div>
              <label className="block text-sm font-bold mb-2">Principal Name *</label>
              <input type="text" value={formData.principalName} onChange={e=>setFormData({...formData,principalName:e.target.value})} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"/>
            </div>
            <div>
              <label className="block text-sm font-bold mb-2">Phone Number *</label>
              <input type="tel" value={formData.principalPhone} onChange={e=>setFormData({...formData,principalPhone:e.target.value})} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"/>
            </div>
            <div>
              <label className="block text-sm font-bold mb-2">Email ID *</label>
              <input type="email" value={formData.principalEmail} onChange={e=>setFormData({...formData,principalEmail:e.target.value})} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"/>
            </div>
          </div>
        </div>

        {/* Vice Principal Information */}
        <div className="border-4 border-green-500 rounded-2xl p-6 bg-green-50">
          <h3 className="text-2xl font-bold mb-4 text-green-800">üë®‚Äçüíº Vice Principal Information</h3>
          <div className="grid md:grid-cols-3 gap-4">
            <div>
              <label className="block text-sm font-bold mb-2">Vice Principal Name *</label>
              <input type="text" value={formData.vicePrincipalName} onChange={e=>setFormData({...formData,vicePrincipalName:e.target.value})} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"/>
            </div>
            <div>
              <label className="block text-sm font-bold mb-2">Phone Number *</label>
              <input type="tel" value={formData.vicePrincipalPhone} onChange={e=>setFormData({...formData,vicePrincipalPhone:e.target.value})} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"/>
            </div>
            <div>
              <label className="block text-sm font-bold mb-2">Email ID *</label>
              <input type="email" value={formData.vicePrincipalEmail} onChange={e=>setFormData({...formData,vicePrincipalEmail:e.target.value})} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"/>
            </div>
          </div>
        </div>

        {/* Avanti Coordinator Information */}
        <div className="border-4 border-orange-500 rounded-2xl p-6 bg-orange-50">
          <h3 className="text-2xl font-bold mb-4 text-orange-800">üë®‚Äçüíº Avanti Coordinator Information</h3>
          <div className="grid md:grid-cols-3 gap-4">
            <div>
              <label className="block text-sm font-bold mb-2">Coordinator Name *</label>
              <input type="text" value={formData.coordinatorName} onChange={e=>setFormData({...formData,coordinatorName:e.target.value})} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"/>
            </div>
            <div>
              <label className="block text-sm font-bold mb-2">Phone Number *</label>
              <input type="tel" value={formData.coordinatorPhone} onChange={e=>setFormData({...formData,coordinatorPhone:e.target.value})} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"/>
            </div>
            <div>
              <label className="block text-sm font-bold mb-2">Email ID *</label>
              <input type="email" value={formData.coordinatorEmail} onChange={e=>setFormData({...formData,coordinatorEmail:e.target.value})} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"/>
            </div>
          </div>
        </div>

        {/* WiFi Information */}
        <div className="border-4 border-purple-500 rounded-2xl p-6 bg-purple-50">
          <h3 className="text-2xl font-bold mb-4 text-purple-800">üì∂ WiFi Connection Details</h3>
          <div className="grid md:grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-bold mb-2">WiFi in Classroom? *</label>
              <select value={formData.wifiInClassroom} onChange={e=>setFormData({...formData,wifiInClassroom:e.target.value})} className="w-full border-2 px-4 py-3 rounded-xl">
                <option value="No">No</option>
                <option value="Yes">Yes</option>
              </select>
            </div>
            {formData.wifiInClassroom==='Yes'&&(
              <>
                <div>
                  <label className="block text-sm font-bold mb-2">Installed By *</label>
                  <select value={formData.wifiInstalledBy} onChange={e=>setFormData({...formData,wifiInstalledBy:e.target.value})} className="w-full border-2 px-4 py-3 rounded-xl">
                    <option value="">Select</option>
                    <option value="Avanti">Avanti</option>
                    <option value="JNV">JNV</option>
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-bold mb-2">Working Condition? *</label>
                  <select value={formData.wifiWorking} onChange={e=>setFormData({...formData,wifiWorking:e.target.value})} className="w-full border-2 px-4 py-3 rounded-xl">
                    <option value="No">No</option>
                    <option value="Yes">Yes</option>
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-bold mb-2">Monthly Bill Amount *</label>
                  <input type="text" value={formData.wifiMonthlyBill} onChange={e=>setFormData({...formData,wifiMonthlyBill:e.target.value})} placeholder="‚Çπ Amount" className="w-full border-2 px-4 py-3 rounded-xl"/>
                </div>
                <div>
                  <label className="block text-sm font-bold mb-2">Connection Type *</label>
                  <select value={formData.wifiConnectionType} onChange={e=>setFormData({...formData,wifiConnectionType:e.target.value})} className="w-full border-2 px-4 py-3 rounded-xl">
                    <option value="">Select</option>
                    <option value="Postpaid">Postpaid</option>
                    <option value="Prepaid">Prepaid</option>
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-bold mb-2">Network Name *</label>
                  <select value={formData.wifiNetworkName} onChange={e=>setFormData({...formData,wifiNetworkName:e.target.value})} className="w-full border-2 px-4 py-3 rounded-xl">
                    <option value="">Select</option>
                    <option value="Airtel">Airtel</option>
                    <option value="Jio">Jio</option>
                    <option value="Local">Local</option>
                    <option value="BSNL">BSNL</option>
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-bold mb-2">Both 11th & 12th have WiFi? *</label>
                  <select value={formData.bothClassesWifi} onChange={e=>setFormData({...formData,bothClassesWifi:e.target.value})} className="w-full border-2 px-4 py-3 rounded-xl">
                    <option value="No">No</option>
                    <option value="Yes">Yes</option>
                  </select>
                </div>
              </>
            )}
          </div>
        </div>

        {/* Modules - Class 11 */}
        <div className="border-4 border-green-500 rounded-2xl p-6 bg-green-50">
          <h3 className="text-2xl font-bold mb-4 text-green-800">üìö Modules - Class 11th</h3>
          <div className="grid md:grid-cols-3 gap-4">
            <div>
              <label className="block text-sm font-bold mb-2">Modules Received (AY 2025-26) *</label>
              <input type="number" value={formData.modules11Received} onChange={e=>setFormData({...formData,modules11Received:e.target.value})} className="w-full border-2 px-4 py-3 rounded-xl"/>
            </div>
            <div>
              <label className="block text-sm font-bold mb-2">Modules Distributed to 11th *</label>
              <input type="number" value={formData.modules11Distributed} onChange={e=>setFormData({...formData,modules11Distributed:e.target.value})} className="w-full border-2 px-4 py-3 rounded-xl"/>
            </div>
            <div>
              <label className="block text-sm font-bold mb-2">Modules in Stock (11th) *</label>
              <input type="number" value={formData.modules11Stock} onChange={e=>setFormData({...formData,modules11Stock:e.target.value})} className="w-full border-2 px-4 py-3 rounded-xl"/>
            </div>
          </div>
        </div>

        {/* Modules - Class 12 */}
        <div className="border-4 border-blue-500 rounded-2xl p-6 bg-blue-50">
          <h3 className="text-2xl font-bold mb-4 text-blue-800">üìö Modules - Class 12th</h3>
          <div className="grid md:grid-cols-3 gap-4">
            <div>
              <label className="block text-sm font-bold mb-2">Modules Received (AY 2025-26) *</label>
              <input type="number" value={formData.modules12Received} onChange={e=>setFormData({...formData,modules12Received:e.target.value})} className="w-full border-2 px-4 py-3 rounded-xl"/>
            </div>
            <div>
              <label className="block text-sm font-bold mb-2">Modules Distributed to 12th *</label>
              <input type="number" value={formData.modules12Distributed} onChange={e=>setFormData({...formData,modules12Distributed:e.target.value})} className="w-full border-2 px-4 py-3 rounded-xl"/>
            </div>
            <div>
              <label className="block text-sm font-bold mb-2">Modules in Stock (12th) *</label>
              <input type="number" value={formData.modules12Stock} onChange={e=>setFormData({...formData,modules12Stock:e.target.value})} className="w-full border-2 px-4 py-3 rounded-xl"/>
            </div>
          </div>
        </div>

        {/* Reference Books */}
        <div className="border-4 border-yellow-500 rounded-2xl p-6 bg-yellow-50">
          <div className="flex justify-between items-center mb-4">
            <h3 className="text-2xl font-bold text-yellow-800">üìñ Other Reference Books (AY 2025-26)</h3>
            <button onClick={handleAddBook} className="px-6 py-3 bg-yellow-600 text-white rounded-xl font-semibold">
              + Add Book
            </button>
          </div>
          {formData.referenceBooks.map((book,idx)=>
            <div key={idx} className="bg-white p-4 rounded-xl mb-4 border-2 border-yellow-300">
              <div className="flex justify-between items-center mb-3">
                <h4 className="font-bold text-lg">Book {idx+1}</h4>
                {isEditing && (
                    <button onClick={()=>handleRemoveBook(idx)} className="px-4 py-2 bg-red-500 text-white rounded-lg">
                      Remove
                    </button>
                  )}
              </div>
              <div className="grid md:grid-cols-3 gap-4">
                <div>
                  <label className="block text-sm font-bold mb-2">Book Name *</label>
                  <input type="text" value={book.bookName} onChange={e=>handleBookChange(idx,'bookName',e.target.value)} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"/>
                </div>
                <div>
                  <label className="block text-sm font-bold mb-2">Publisher Name *</label>
                  <input type="text" value={book.publisher} onChange={e=>handleBookChange(idx,'publisher',e.target.value)} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"/>
                </div>
                <div>
                  <label className="block text-sm font-bold mb-2">Author Name *</label>
                  <input type="text" value={book.author} onChange={e=>handleBookChange(idx,'author',e.target.value)} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"/>
                </div>
                <div>
                  <label className="block text-sm font-bold mb-2">Price *</label>
                  <input type="text" value={book.price} onChange={e=>handleBookChange(idx,'price',e.target.value)} placeholder="‚Çπ Amount" disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"/>
                </div>
                <div>
                  <label className="block text-sm font-bold mb-2">In Stock *</label>
                  <input type="number" value={book.inStock} onChange={e=>handleBookChange(idx,'inStock',e.target.value)} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"/>
                </div>
                <div>
                  <label className="block text-sm font-bold mb-2">Distributed *</label>
                  <input type="number" value={book.distributed} onChange={e=>handleBookChange(idx,'distributed',e.target.value)} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"/>
                </div>
              </div>
            </div>
          )}
        </div>

        {/* Chromebooks - Class 11 */}
        <div className="border-4 border-indigo-500 rounded-2xl p-6 bg-indigo-50">
          <h3 className="text-2xl font-bold mb-4 text-indigo-800">üíª Chromebooks/Laptops - Class 11th</h3>
          <div className="grid md:grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-bold mb-2">Distributed from Avanti? *</label>
              <select value={formData.chromebooks11Distributed} onChange={e=>setFormData({...formData,chromebooks11Distributed:e.target.value})} className="w-full border-2 px-4 py-3 rounded-xl">
                <option value="No">No</option>
                <option value="Yes">Yes</option>
              </select>
            </div>
            {formData.chromebooks11Distributed==='Yes'?(
              <>
                <div>
                  <label className="block text-sm font-bold mb-2">Number Distributed *</label>
                  <input type="number" value={formData.chromebooks11Count} onChange={e=>setFormData({...formData,chromebooks11Count:e.target.value})} className="w-full border-2 px-4 py-3 rounded-xl"/>
                </div>
                <div>
                  <label className="block text-sm font-bold mb-2">Working Condition *</label>
                  <input type="number" value={formData.chromebooks11Working} onChange={e=>setFormData({...formData,chromebooks11Working:e.target.value})} className="w-full border-2 px-4 py-3 rounded-xl"/>
                </div>
                <div>
                  <label className="block text-sm font-bold mb-2">Brand Name *</label>
                  <input type="text" value={formData.chromebooks11Brand} onChange={e=>setFormData({...formData,chromebooks11Brand:e.target.value})} className="w-full border-2 px-4 py-3 rounded-xl"/>
                </div>
                <div className="md:col-span-2">
                  <label className="block text-sm font-bold mb-2">When Distributed? *</label>
                  <select value={formData.chromebooks11DistributedDate} onChange={e=>setFormData({...formData,chromebooks11DistributedDate:e.target.value})} className="w-full border-2 px-4 py-3 rounded-xl">
                    <option value="">Select Month & Year</option>
                    {generateMonthYearOptions().map(opt=><option key={opt} value={opt}>{opt}</option>)}
                  </select>
                </div>
              </>
            ):(
              <>
                <div className="md:col-span-2">
                  <label className="block text-sm font-bold mb-2">How do you conduct tests? *</label>
                  <textarea value={formData.chromebooks11TestMethod} onChange={e=>setFormData({...formData,chromebooks11TestMethod:e.target.value})} rows="3" className="w-full border-2 px-4 py-3 rounded-xl"/>
                </div>
                <div>
                  <label className="block text-sm font-bold mb-2">JNV Computer Lab/Tablets Accessible? *</label>
                  <input type="text" value={formData.chromebooks11JNVLabAccess} onChange={e=>setFormData({...formData,chromebooks11JNVLabAccess:e.target.value})} className="w-full border-2 px-4 py-3 rounded-xl"/>
                </div>
                <div>
                  <label className="block text-sm font-bold mb-2">How many tabs/computers in JNV? *</label>
                  <input type="number" value={formData.chromebooks11JNVCount} onChange={e=>setFormData({...formData,chromebooks11JNVCount:e.target.value})} className="w-full border-2 px-4 py-3 rounded-xl"/>
                </div>
              </>
            )}
          </div>
        </div>

        {/* Chromebooks - Class 12 */}
        <div className="border-4 border-pink-500 rounded-2xl p-6 bg-pink-50">
          <h3 className="text-2xl font-bold mb-4 text-pink-800">üíª Chromebooks/Laptops - Class 12th</h3>
          <div className="grid md:grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-bold mb-2">Distributed from Avanti? *</label>
              <select value={formData.chromebooks12Distributed} onChange={e=>setFormData({...formData,chromebooks12Distributed:e.target.value})} className="w-full border-2 px-4 py-3 rounded-xl">
                <option value="No">No</option>
                <option value="Yes">Yes</option>
              </select>
            </div>
            {formData.chromebooks12Distributed==='Yes'?(
              <>
                <div>
                  <label className="block text-sm font-bold mb-2">Number Distributed *</label>
                  <input type="number" value={formData.chromebooks12Count} onChange={e=>setFormData({...formData,chromebooks12Count:e.target.value})} className="w-full border-2 px-4 py-3 rounded-xl"/>
                </div>
                <div>
                  <label className="block text-sm font-bold mb-2">Working Condition *</label>
                  <input type="number" value={formData.chromebooks12Working} onChange={e=>setFormData({...formData,chromebooks12Working:e.target.value})} className="w-full border-2 px-4 py-3 rounded-xl"/>
                </div>
                <div>
                  <label className="block text-sm font-bold mb-2">Brand Name *</label>
                  <input type="text" value={formData.chromebooks12Brand} onChange={e=>setFormData({...formData,chromebooks12Brand:e.target.value})} className="w-full border-2 px-4 py-3 rounded-xl"/>
                </div>
                <div className="md:col-span-2">
                  <label className="block text-sm font-bold mb-2">When Distributed? *</label>
                  <select value={formData.chromebooks12DistributedDate} onChange={e=>setFormData({...formData,chromebooks12DistributedDate:e.target.value})} className="w-full border-2 px-4 py-3 rounded-xl">
                    <option value="">Select Month & Year</option>
                    {generateMonthYearOptions().map(opt=><option key={opt} value={opt}>{opt}</option>)}
                  </select>
                </div>
              </>
            ):(
              <>
                <div className="md:col-span-2">
                  <label className="block text-sm font-bold mb-2">How do you conduct tests? *</label>
                  <textarea value={formData.chromebooks12TestMethod} onChange={e=>setFormData({...formData,chromebooks12TestMethod:e.target.value})} rows="3" className="w-full border-2 px-4 py-3 rounded-xl"/>
                </div>
                <div>
                  <label className="block text-sm font-bold mb-2">JNV Computer Lab/Tablets Accessible? *</label>
                  <input type="text" value={formData.chromebooks12JNVLabAccess} onChange={e=>setFormData({...formData,chromebooks12JNVLabAccess:e.target.value})} className="w-full border-2 px-4 py-3 rounded-xl"/>
                </div>
                <div>
                  <label className="block text-sm font-bold mb-2">How many tabs/computers in JNV? *</label>
                  <input type="number" value={formData.chromebooks12JNVCount} onChange={e=>setFormData({...formData,chromebooks12JNVCount:e.target.value})} className="w-full border-2 px-4 py-3 rounded-xl"/>
                </div>
              </>
            )}
          </div>
        </div>

        {/* Printer Information */}
        <div className="border-4 border-cyan-500 rounded-2xl p-6 bg-cyan-50">
          <h3 className="text-2xl font-bold mb-4 text-cyan-800">üñ®Ô∏è Printer Information</h3>
          <div className="grid md:grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-bold mb-2">Printer Available? *</label>
              <select value={formData.printerAvailable} onChange={e=>setFormData({...formData,printerAvailable:e.target.value})} className="w-full border-2 px-4 py-3 rounded-xl">
                <option value="No">No</option>
                <option value="Yes">Yes</option>
              </select>
            </div>
            {formData.printerAvailable==='Yes'&&(
              <>
                <div>
                  <label className="block text-sm font-bold mb-2">Working Condition? *</label>
                  <select value={formData.printerWorking} onChange={e=>setFormData({...formData,printerWorking:e.target.value})} className="w-full border-2 px-4 py-3 rounded-xl">
                    <option value="No">No</option>
                    <option value="Yes">Yes</option>
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-bold mb-2">Printer Brand *</label>
                  <input type="text" value={formData.printerBrand} onChange={e=>setFormData({...formData,printerBrand:e.target.value})} placeholder="e.g., HP, Canon, Epson" className="w-full border-2 px-4 py-3 rounded-xl"/>
                </div>
                <div>
                  <label className="block text-sm font-bold mb-2">When Issued? *</label>
                  <select value={formData.printerIssuedDate} onChange={e=>setFormData({...formData,printerIssuedDate:e.target.value})} className="w-full border-2 px-4 py-3 rounded-xl">
                    <option value="">Select Month & Year</option>
                    {generateMonthYearOptions().map(opt=><option key={opt} value={opt}>{opt}</option>)}
                  </select>
                </div>
              </>
            )}
          </div>
        </div>

        {/* Other Assets */}
        <div className="border-4 border-teal-500 rounded-2xl p-6 bg-teal-50">
          <div className="flex justify-between items-center mb-4">
            <h3 className="text-2xl font-bold text-teal-800">üì¶ Other Assets</h3>
            {isEditing && (
              <button onClick={handleAddAsset} className="px-6 py-3 bg-teal-600 text-white rounded-xl font-semibold">
                + Add Asset
              </button>
            )}
          </div>
          {formData.otherAssets.length===0?(
            <p className="text-gray-600 text-center py-4">No other assets added yet. Click "+ Add Asset" to add.</p>
          ):(
            formData.otherAssets.map((asset,idx)=>
              <div key={idx} className="bg-white p-4 rounded-xl mb-4 border-2 border-teal-300">
                <div className="flex justify-between items-center mb-3">
                  <h4 className="font-bold text-lg">Asset {idx+1}</h4>
                  {isEditing && (
                    <button onClick={()=>handleRemoveAsset(idx)} className="px-4 py-2 bg-red-500 text-white rounded-lg">
                      Remove
                    </button>
                  )}
                </div>
                <div className="grid md:grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-bold mb-2">Asset Name *</label>
                    <input type="text" value={asset.assetName} onChange={e=>handleAssetChange(idx,'assetName',e.target.value)} placeholder="e.g., Projector, Whiteboard" disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"/>
                  </div>
                  <div>
                    <label className="block text-sm font-bold mb-2">Quantity *</label>
                    <input type="number" value={asset.assetQuantity} onChange={e=>handleAssetChange(idx,'assetQuantity',e.target.value)} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"/>
                  </div>
                  <div>
                    <label className="block text-sm font-bold mb-2">Condition *</label>
                    <select value={asset.assetCondition} onChange={e=>handleAssetChange(idx,'assetCondition',e.target.value)} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed">
                      <option value="">Select</option>
                      <option value="Working">Working</option>
                      <option value="Not Working">Not Working</option>
                      <option value="Needs Repair">Needs Repair</option>
                    </select>
                  </div>
                  <div>
                    <label className="block text-sm font-bold mb-2">Notes</label>
                    <input type="text" value={asset.assetNotes} onChange={e=>handleAssetChange(idx,'assetNotes',e.target.value)} placeholder="Additional details" disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"/>
                  </div>
                </div>
              </div>
            )
          )}
        </div>

        {isEditing && (
        <button onClick={handleSubmit} className="w-full avanti-gradient text-white py-4 rounded-xl font-bold text-xl">
          üíæ Save School Information
        </button>
      )}
      </div>
    </div>
  );
}

// ========================================
// ADMIN SCHOOL INFO VIEW
// ========================================
function AdminSchoolInfo({schoolInfo}){
  const handleExport=()=>{
    const exportData=schoolInfo.map(info=>({
      School:info.school,
      'Principal Name':info.principalName,
      'Principal Phone':info.principalPhone,
      'Principal Email':info.principalEmail,
      'Vice Principal Name':info.vicePrincipalName,
      'Vice Principal Phone':info.vicePrincipalPhone,
      'Vice Principal Email':info.vicePrincipalEmail,
      'Coordinator Name':info.coordinatorName,
      'Coordinator Phone':info.coordinatorPhone,
      'Coordinator Email':info.coordinatorEmail,
      'WiFi in Classroom':info.wifiInClassroom,
      'WiFi Installed By':info.wifiInstalledBy,
      'WiFi Working':info.wifiWorking,
      'WiFi Monthly Bill':info.wifiMonthlyBill,
      'WiFi Connection Type':info.wifiConnectionType,
      'WiFi Network Name':info.wifiNetworkName,
      'Both Classes WiFi':info.bothClassesWifi,
      'Modules 11 Received':info.modules11Received,
      'Modules 11 Distributed':info.modules11Distributed,
      'Modules 11 Stock':info.modules11Stock,
      'Modules 12 Received':info.modules12Received,
      'Modules 12 Distributed':info.modules12Distributed,
      'Modules 12 Stock':info.modules12Stock,
      'Chromebooks 11 Distributed':info.chromebooks11Distributed,
      'Chromebooks 11 Count':info.chromebooks11Count,
      'Chromebooks 11 Working':info.chromebooks11Working,
      'Chromebooks 11 Brand':info.chromebooks11Brand,
      'Chromebooks 11 Date':info.chromebooks11DistributedDate,
      'Chromebooks 12 Distributed':info.chromebooks12Distributed,
      'Chromebooks 12 Count':info.chromebooks12Count,
      'Chromebooks 12 Working':info.chromebooks12Working,
      'Chromebooks 12 Brand':info.chromebooks12Brand,
      'Chromebooks 12 Date':info.chromebooks12DistributedDate,
      'Printer Available':info.printerAvailable,
      'Printer Working':info.printerWorking,
      'Printer Brand':info.printerBrand,
      'Printer Issued Date':info.printerIssuedDate,
      'Other Assets Count':info.otherAssets?info.otherAssets.length:0,
      'Last Updated':info.updatedAt?new Date(info.updatedAt).toLocaleString():''
    }));
    exportToExcel(exportData,'school_information');
  };

  return(
    <div className="space-y-6">
      <div className="flex justify-between items-center">
        <h2 className="text-3xl font-bold">üè´ School Information</h2>
        <button onClick={handleExport} className="px-6 py-3 bg-green-600 text-white rounded-xl font-semibold">
          üì• Export to Excel
        </button>
      </div>

      {schoolInfo.length===0?(
        <div className="bg-white p-8 rounded-2xl text-center">
          <p className="text-gray-600">No school information available yet. Teachers need to fill the forms.</p>
        </div>
      ):(
        <div className="space-y-6">
          {schoolInfo.map(info=>
            <div key={info.id} className="bg-white p-6 rounded-2xl shadow-lg">
              <div className="flex justify-between items-center mb-2">
  <h3 className="text-2xl font-bold">{info.school}</h3>
  <div className="text-right text-sm text-gray-600">
    <div>
      Last updated:{' '}
      {info.updatedAt ? new Date(info.updatedAt).toLocaleString() : 'N/A'}
    </div>
    {info.updatedByName && (
      <div>By: {info.updatedByName} ({info.updatedBy})</div>
    )}
  </div>
</div>

{info.updateHistory && info.updateHistory.length > 0 && (
  <div className="mb-4 bg-yellow-50 border-l-4 border-yellow-400 p-3 rounded">
    <div className="font-semibold mb-1">Edit history</div>
    <ul className="text-xs max-h-32 overflow-y-auto space-y-1">
      {info.updateHistory
        .slice()
        .sort((a, b) => new Date(a.updatedAt) - new Date(b.updatedAt))
        .map((entry, idx) => (
          <li key={idx}>
            {new Date(entry.updatedAt).toLocaleString()} ‚Äî {entry.updatedByName || entry.updatedBy}
          </li>
        ))}
    </ul>
  </div>
)}

              {/* Principal Info */}
              <div className="border-2 border-blue-300 rounded-xl p-4 mb-4 bg-blue-50">
                <h4 className="font-bold text-lg mb-3 text-blue-800">üë®‚Äçüíº Principal</h4>
                <div className="grid md:grid-cols-3 gap-3 text-sm">
                  <div><strong>Name:</strong> {info.principalName||'‚Äî'}</div>
                  <div><strong>Phone:</strong> {info.principalPhone||'‚Äî'}</div>
                  <div><strong>Email:</strong> {info.principalEmail||'‚Äî'}</div>
                </div>
              </div>

              {/* Vice Principal Info */}
              <div className="border-2 border-green-300 rounded-xl p-4 mb-4 bg-green-50">
                <h4 className="font-bold text-lg mb-3 text-green-800">üë®‚Äçüíº Vice Principal</h4>
                <div className="grid md:grid-cols-3 gap-3 text-sm">
                  <div><strong>Name:</strong> {info.vicePrincipalName||'‚Äî'}</div>
                  <div><strong>Phone:</strong> {info.vicePrincipalPhone||'‚Äî'}</div>
                  <div><strong>Email:</strong> {info.vicePrincipalEmail||'‚Äî'}</div>
                </div>
              </div>

              {/* Avanti Coordinator Info */}
              <div className="border-2 border-orange-300 rounded-xl p-4 mb-4 bg-orange-50">
                <h4 className="font-bold text-lg mb-3 text-orange-800">üë®‚Äçüíº Avanti Coordinator</h4>
                <div className="grid md:grid-cols-3 gap-3 text-sm">
                  <div><strong>Name:</strong> {info.coordinatorName||'‚Äî'}</div>
                  <div><strong>Phone:</strong> {info.coordinatorPhone||'‚Äî'}</div>
                  <div><strong>Email:</strong> {info.coordinatorEmail||'‚Äî'}</div>
                </div>
              </div>

              {/* WiFi Info */}
              <div className="border-2 border-purple-300 rounded-xl p-4 mb-4 bg-purple-50">
                <h4 className="font-bold text-lg mb-3 text-purple-800">üì∂ WiFi Connection</h4>
                <div className="grid md:grid-cols-3 gap-3 text-sm">
                  <div><strong>WiFi Available:</strong> {info.wifiInClassroom||'‚Äî'}</div>
                  {info.wifiInClassroom==='Yes'&&(
                    <>
                      <div><strong>Installed By:</strong> {info.wifiInstalledBy||'‚Äî'}</div>
                      <div><strong>Working:</strong> {info.wifiWorking||'‚Äî'}</div>
                      <div><strong>Monthly Bill:</strong> ‚Çπ{info.wifiMonthlyBill||'‚Äî'}</div>
                      <div><strong>Connection Type:</strong> {info.wifiConnectionType||'‚Äî'}</div>
                      <div><strong>Network:</strong> {info.wifiNetworkName||'‚Äî'}</div>
                      <div><strong>Both Classes WiFi:</strong> {info.bothClassesWifi||'‚Äî'}</div>
                    </>
                  )}
                </div>
              </div>

              {/* Modules Info */}
              <div className="grid md:grid-cols-2 gap-4 mb-4">
                <div className="border-2 border-green-300 rounded-xl p-4 bg-green-50">
                  <h4 className="font-bold text-lg mb-3 text-green-800">üìö Modules - Class 11</h4>
                  <div className="space-y-2 text-sm">
                    <div><strong>Received:</strong> {info.modules11Received||'‚Äî'}</div>
                    <div><strong>Distributed:</strong> {info.modules11Distributed||'‚Äî'}</div>
                    <div><strong>In Stock:</strong> {info.modules11Stock||'‚Äî'}</div>
                  </div>
                </div>
                <div className="border-2 border-blue-300 rounded-xl p-4 bg-blue-50">
                  <h4 className="font-bold text-lg mb-3 text-blue-800">üìö Modules - Class 12</h4>
                  <div className="space-y-2 text-sm">
                    <div><strong>Received:</strong> {info.modules12Received||'‚Äî'}</div>
                    <div><strong>Distributed:</strong> {info.modules12Distributed||'‚Äî'}</div>
                    <div><strong>In Stock:</strong> {info.modules12Stock||'‚Äî'}</div>
                  </div>
                </div>
              </div>

              {/* Reference Books */}
              {info.referenceBooks&&info.referenceBooks.length>0&&(
                <div className="border-2 border-yellow-300 rounded-xl p-4 mb-4 bg-yellow-50">
                  <h4 className="font-bold text-lg mb-3 text-yellow-800">üìñ Reference Books</h4>
                  <div className="overflow-x-auto">
                    <table className="w-full text-sm">
                      <thead className="bg-yellow-200">
                        <tr>
                          <th className="p-2 text-left">Book Name</th>
                          <th className="p-2 text-left">Publisher</th>
                          <th className="p-2 text-left">Author</th>
                          <th className="p-2 text-left">Price</th>
                          <th className="p-2 text-left">In Stock</th>
                          <th className="p-2 text-left">Distributed</th>
                        </tr>
                      </thead>
                      <tbody>
                        {info.referenceBooks.map((book,idx)=>
                          <tr key={idx} className="border-b border-yellow-200">
                            <td className="p-2">{book.bookName||'‚Äî'}</td>
                            <td className="p-2">{book.publisher||'‚Äî'}</td>
                            <td className="p-2">{book.author||'‚Äî'}</td>
                            <td className="p-2">‚Çπ{book.price||'‚Äî'}</td>
                            <td className="p-2">{book.inStock||'‚Äî'}</td>
                            <td className="p-2">{book.distributed||'‚Äî'}</td>
                          </tr>
                        )}
                      </tbody>
                    </table>
                  </div>
                </div>
              )}

              {/* Chromebooks Info */}
              <div className="grid md:grid-cols-2 gap-4 mb-4">
                <div className="border-2 border-indigo-300 rounded-xl p-4 bg-indigo-50">
                  <h4 className="font-bold text-lg mb-3 text-indigo-800">üíª Chromebooks - Class 11</h4>
                  <div className="space-y-2 text-sm">
                    <div><strong>Distributed from Avanti:</strong> {info.chromebooks11Distributed||'‚Äî'}</div>
                    {info.chromebooks11Distributed==='Yes'?(
                      <>
                        <div><strong>Count:</strong> {info.chromebooks11Count||'‚Äî'}</div>
                        <div><strong>Working:</strong> {info.chromebooks11Working||'‚Äî'}</div>
                        <div><strong>Brand:</strong> {info.chromebooks11Brand||'‚Äî'}</div>
                        <div><strong>Distributed:</strong> {info.chromebooks11DistributedDate||'‚Äî'}</div>
                      </>
                    ):(
                      <>
                        <div><strong>Test Method:</strong> {info.chromebooks11TestMethod||'‚Äî'}</div>
                        <div><strong>JNV Lab Access:</strong> {info.chromebooks11JNVLabAccess||'‚Äî'}</div>
                        <div><strong>JNV Devices:</strong> {info.chromebooks11JNVCount||'‚Äî'}</div>
                      </>
                    )}
                  </div>
                </div>
                <div className="border-2 border-pink-300 rounded-xl p-4 bg-pink-50">
                  <h4 className="font-bold text-lg mb-3 text-pink-800">üíª Chromebooks - Class 12</h4>
                  <div className="space-y-2 text-sm">
                    <div><strong>Distributed from Avanti:</strong> {info.chromebooks12Distributed||'‚Äî'}</div>
                    {info.chromebooks12Distributed==='Yes'?(
                      <>
                        <div><strong>Count:</strong> {info.chromebooks12Count||'‚Äî'}</div>
                        <div><strong>Working:</strong> {info.chromebooks12Working||'‚Äî'}</div>
                        <div><strong>Brand:</strong> {info.chromebooks12Brand||'‚Äî'}</div>
                        <div><strong>Distributed:</strong> {info.chromebooks12DistributedDate||'‚Äî'}</div>
                      </>
                    ):(
                      <>
                        <div><strong>Test Method:</strong> {info.chromebooks12TestMethod||'‚Äî'}</div>
                        <div><strong>JNV Lab Access:</strong> {info.chromebooks12JNVLabAccess||'‚Äî'}</div>
                        <div><strong>JNV Devices:</strong> {info.chromebooks12JNVCount||'‚Äî'}</div>
                      </>
                    )}
                  </div>
                </div>
              </div>

              {/* Printer Info */}
              <div className="border-2 border-cyan-300 rounded-xl p-4 mb-4 bg-cyan-50">
                <h4 className="font-bold text-lg mb-3 text-cyan-800">üñ®Ô∏è Printer</h4>
                <div className="grid md:grid-cols-2 gap-3 text-sm">
                  <div><strong>Printer Available:</strong> {info.printerAvailable||'‚Äî'}</div>
                  {info.printerAvailable==='Yes'&&(
                    <>
                      <div><strong>Working:</strong> {info.printerWorking||'‚Äî'}</div>
                      <div><strong>Brand:</strong> {info.printerBrand||'‚Äî'}</div>
                      <div><strong>Issued:</strong> {info.printerIssuedDate||'‚Äî'}</div>
                    </>
                  )}
                </div>
              </div>

              {/* Other Assets */}
              {info.otherAssets&&info.otherAssets.length>0&&(
                <div className="border-2 border-teal-300 rounded-xl p-4 mb-4 bg-teal-50">
                  <h4 className="font-bold text-lg mb-3 text-teal-800">üì¶ Other Assets ({info.otherAssets.length})</h4>
                  <div className="overflow-x-auto">
                    <table className="w-full text-sm">
                      <thead className="bg-teal-200">
                        <tr>
                          <th className="p-2 text-left">Asset Name</th>
                          <th className="p-2 text-left">Quantity</th>
                          <th className="p-2 text-left">Condition</th>
                          <th className="p-2 text-left">Notes</th>
                        </tr>
                      </thead>
                      <tbody>
                        {info.otherAssets.map((asset,idx)=>
                          <tr key={idx} className="border-b border-teal-200">
                            <td className="p-2 font-semibold">{asset.assetName||'‚Äî'}</td>
                            <td className="p-2">{asset.assetQuantity||'‚Äî'}</td>
                            <td className="p-2">
                              <span className={`px-2 py-1 rounded-full text-xs font-bold ${
                                asset.assetCondition==='Working'?'bg-green-100 text-green-700':
                                asset.assetCondition==='Not Working'?'bg-red-100 text-red-700':
                                'bg-yellow-100 text-yellow-700'
                              }`}>
                                {asset.assetCondition||'‚Äî'}
                              </span>
                            </td>
                            <td className="p-2">{asset.assetNotes||'‚Äî'}</td>
                          </tr>
                        )}
                      </tbody>
                    </table>
                  </div>
                </div>
              )}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
// ========================================
// TEACHER DIRECTORY
// ========================================
function TeacherDirectory({ teachers, currentUser }) {
  const [searchTerm, setSearchTerm] = useState('');
  const [filterSchool, setFilterSchool] = useState('All');
  const [filterSubject, setFilterSubject] = useState('All');
  const [selectedTeacher, setSelectedTeacher] = useState(null);

  // Get unique schools
  const schools = ['All', ...new Set(teachers.map(t => t.school))];

  // Filter teachers
  const filteredTeachers = teachers.filter(teacher => {
    const matchesSearch = teacher.name?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                         teacher.email?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                         teacher.phone?.includes(searchTerm);
    const matchesSchool = filterSchool === 'All' || teacher.school === filterSchool;
    const matchesSubject = filterSubject === 'All' || teacher.subject === filterSubject;
    return matchesSearch && matchesSchool && matchesSubject;
  });

  // Get subject icon
  const getSubjectIcon = (subject) => {
    const icons = {
      'Physics': '‚öõÔ∏è',
      'Chemistry': 'üß™',
      'Mathematics': 'üìê',
      'Biology': 'üß¨'
    };
    return icons[subject] || 'üìö';
  };

  // Get school color
  const getSchoolColor = (school) => {
    const colors = {
      'CoE Barwani': 'from-blue-500 to-blue-600',
      'CoE Cuttak': 'from-green-500 to-green-600',
      'CoE Bundi': 'from-purple-500 to-purple-600',
      'CoE Mahisagar': 'from-orange-500 to-orange-600',
      'EMRS Bhopal': 'from-pink-500 to-pink-600',
      'JNV Bharuch': 'from-red-500 to-red-600'
    };
    return colors[school] || 'from-gray-500 to-gray-600';
  };

  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <h2 className="text-3xl font-bold">üìñ Teacher Directory</h2>
        <div className="text-lg font-semibold text-gray-600">
          {filteredTeachers.length} {filteredTeachers.length === 1 ? 'Teacher' : 'Teachers'}
        </div>
      </div>

      {/* Search and Filters */}
      <div className="bg-white p-6 rounded-2xl shadow-lg">
        <div className="grid md:grid-cols-3 gap-4">
          {/* Search */}
          <div>
            <label className="block text-sm font-semibold mb-2">üîç Search</label>
            <input
              type="text"
              placeholder="Name, email, or phone..."
              value={searchTerm}
              onChange={(e) => setSearchTerm(e.target.value)}
              className="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-yellow-500"
            />
          </div>

          {/* School Filter */}
          <div>
            <label className="block text-sm font-semibold mb-2">üè´ School</label>
            <select
              value={filterSchool}
              onChange={(e) => setFilterSchool(e.target.value)}
              className="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-yellow-500"
            >
              {schools.map(school => (
                <option key={school} value={school}>{school}</option>
              ))}
            </select>
          </div>

          {/* Subject Filter */}
          <div>
            <label className="block text-sm font-semibold mb-2">üìö Subject</label>
            <select
              value={filterSubject}
              onChange={(e) => setFilterSubject(e.target.value)}
              className="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-yellow-500"
            >
              <option value="All">All Subjects</option>
              {SUBJECTS.map(subject => (
                <option key={subject} value={subject}>{subject}</option>
              ))}
            </select>
          </div>
        </div>
      </div>

      {/* Teacher Cards Grid */}
      {filteredTeachers.length === 0 ? (
        <div className="bg-white p-12 rounded-2xl shadow-lg text-center">
          <div className="text-6xl mb-4">üîç</div>
          <div className="text-xl font-semibold text-gray-600">No teachers found</div>
          <div className="text-gray-500 mt-2">Try adjusting your search filters</div>
        </div>
      ) : (
        <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
          {filteredTeachers.map((teacher) => (
            <div
              key={teacher.docId}
              className="bg-white rounded-2xl shadow-lg hover:shadow-2xl transition-all duration-300 overflow-hidden cursor-pointer transform hover:-translate-y-1"
              onClick={() => setSelectedTeacher(teacher)}
            >
              {/* Header with gradient */}
              <div className={`bg-gradient-to-r ${getSchoolColor(teacher.school)} p-4 text-white`}>
                <div className="flex items-start justify-between">
                  <div className="flex-1">
                    <div className="text-xs font-semibold opacity-90 mb-1">{teacher.school}</div>
                    <div className="text-sm opacity-90">{teacher.grade || 'Class 11 & 12'}</div>
                  </div>
                  <div className="text-3xl">
                    {getSubjectIcon(teacher.subject)}
                  </div>
                </div>
              </div>

              {/* Profile Photo */}
              <div className="flex justify-center -mt-10 mb-4">
                {teacher.profilePhoto ? (
                  <img
                    src={teacher.profilePhoto}
                    alt={teacher.name}
                    className="w-20 h-20 rounded-full border-4 border-white shadow-lg object-cover"
                  />
                ) : (
                  <div className="w-20 h-20 rounded-full border-4 border-white shadow-lg bg-gradient-to-br from-gray-300 to-gray-400 flex items-center justify-center text-3xl font-bold text-white">
                    {teacher.name?.charAt(0) || '?'}
                  </div>
                )}
              </div>

              {/* Teacher Info */}
              <div className="px-4 pb-4 space-y-3">
                {/* Name */}
                <div className="text-center">
                  <div className="text-xl font-bold text-gray-800">{teacher.name}</div>
                  <div className="text-sm font-semibold text-gray-600">{teacher.subject}</div>
                </div>

                {/* Contact Info */}
                <div className="space-y-2 text-sm">
                  {teacher.phone && (
                    <div className="flex items-center gap-2 text-gray-700">
                      <span className="text-lg">üì±</span>
                      <span className="font-medium">{teacher.phone}</span>
                    </div>
                  )}
                  
                  {teacher.whatsapp && (
                    <div className="flex items-center gap-2 text-gray-700">
                      <span className="text-lg">üí¨</span>
                      <span className="font-medium">{teacher.whatsapp}</span>
                    </div>
                  )}
                  
                  {teacher.email && (
                    <div className="flex items-center gap-2 text-gray-700">
                      <span className="text-lg">üìß</span>
                      <span className="font-medium text-xs break-all">{teacher.email}</span>
                    </div>
                  )}
                </div>

                {/* Dates */}
                <div className="grid grid-cols-2 gap-2 pt-2 border-t">
                  {teacher.dateOfJoining && (
                    <div className="text-center">
                      <div className="text-xs text-gray-500">Joined</div>
                      <div className="text-sm font-semibold text-gray-700">
                        {new Date(teacher.dateOfJoining).toLocaleDateString('en-IN', { day: 'numeric', month: 'short', year: 'numeric' })}
                      </div>
                    </div>
                  )}
                  {teacher.dateOfBirth && (
                    <div className="text-center">
                      <div className="text-xs text-gray-500">Birthday</div>
                      <div className="text-sm font-semibold text-gray-700">
                        {new Date(teacher.dateOfBirth).toLocaleDateString('en-IN', { day: 'numeric', month: 'short' })}
                      </div>
                    </div>
                  )}
                </div>

                {/* Click for more */}
                <div className="text-center pt-2">
                  <button className="text-xs text-blue-600 font-semibold hover:text-blue-800">
                    Click for full details ‚Üí
                  </button>
                </div>
              </div>
            </div>
          ))}
        </div>
      )}

      {/* Teacher Detail Modal */}
      {selectedTeacher && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setSelectedTeacher(null)}>
          <div className="bg-white rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto" onClick={(e) => e.stopPropagation()}>
            {/* Header */}
            <div className={`bg-gradient-to-r ${getSchoolColor(selectedTeacher.school)} p-6 text-white relative`}>
              <button
                onClick={() => setSelectedTeacher(null)}
                className="absolute top-4 right-4 text-white text-2xl hover:text-gray-200 w-10 h-10 flex items-center justify-center rounded-full hover:bg-white/20"
              >
                √ó
              </button>
              <div className="flex items-center gap-4">
                {selectedTeacher.profilePhoto ? (
                  <img
                    src={selectedTeacher.profilePhoto}
                    alt={selectedTeacher.name}
                    className="w-24 h-24 rounded-full border-4 border-white shadow-lg object-cover"
                  />
                ) : (
                  <div className="w-24 h-24 rounded-full border-4 border-white shadow-lg bg-white/30 flex items-center justify-center text-4xl font-bold">
                    {selectedTeacher.name?.charAt(0) || '?'}
                  </div>
                )}
                <div className="flex-1">
                  <div className="text-2xl font-bold">{selectedTeacher.name}</div>
                  <div className="text-lg opacity-90">{selectedTeacher.subject}</div>
                  <div className="text-sm opacity-80 mt-1">{selectedTeacher.school}</div>
                </div>
              </div>
            </div>

            {/* Content */}
            <div className="p-6 space-y-6">
              {/* Contact Information */}
              <div>
                <div className="text-lg font-bold mb-3 flex items-center gap-2">
                  <span>üìû</span> Contact Information
                </div>
                <div className="bg-gray-50 rounded-xl p-4 space-y-3">
                  {selectedTeacher.phone && (
                    <div className="flex items-center justify-between">
                      <span className="text-gray-600 font-medium">Phone:</span>
                      <a href={`tel:${selectedTeacher.phone}`} className="text-blue-600 font-semibold hover:underline">
                        {selectedTeacher.phone}
                      </a>
                    </div>
                  )}
                  {selectedTeacher.whatsapp && (
                    <div className="flex items-center justify-between">
                      <span className="text-gray-600 font-medium">WhatsApp:</span>
                      <a href={`https://wa.me/${selectedTeacher.whatsapp.replace(/[^0-9]/g, '')}`} target="_blank" rel="noopener noreferrer" className="text-green-600 font-semibold hover:underline">
                        {selectedTeacher.whatsapp}
                      </a>
                    </div>
                  )}
                  {selectedTeacher.email && (
                    <div className="flex items-start justify-between">
                      <span className="text-gray-600 font-medium">Email:</span>
                      <a href={`mailto:${selectedTeacher.email}`} className="text-blue-600 font-semibold hover:underline text-right break-all">
                        {selectedTeacher.email}
                      </a>
                    </div>
                  )}
                </div>
              </div>

              {/* Personal Information */}
              <div>
                <div className="text-lg font-bold mb-3 flex items-center gap-2">
                  <span>üë§</span> Personal Information
                </div>
                <div className="bg-gray-50 rounded-xl p-4 space-y-3">
                  <div className="flex items-center justify-between">
                    <span className="text-gray-600 font-medium">Class:</span>
                    <span className="font-semibold">{selectedTeacher.grade || 'Class 11 & 12'}</span>
                  </div>
                  {selectedTeacher.dateOfBirth && (
                    <div className="flex items-center justify-between">
                      <span className="text-gray-600 font-medium">Date of Birth:</span>
                      <span className="font-semibold">
                        {new Date(selectedTeacher.dateOfBirth).toLocaleDateString('en-IN', { day: 'numeric', month: 'long', year: 'numeric' })}
                      </span>
                    </div>
                  )}
                  {selectedTeacher.dateOfJoining && (
                    <div className="flex items-center justify-between">
                      <span className="text-gray-600 font-medium">Date of Joining:</span>
                      <span className="font-semibold">
                        {new Date(selectedTeacher.dateOfJoining).toLocaleDateString('en-IN', { day: 'numeric', month: 'long', year: 'numeric' })}
                      </span>
                    </div>
                  )}
                  {selectedTeacher.anniversary && (
                    <div className="flex items-center justify-between">
                      <span className="text-gray-600 font-medium">Anniversary:</span>
                      <span className="font-semibold">
                        {new Date(selectedTeacher.anniversary).toLocaleDateString('en-IN', { day: 'numeric', month: 'long' })}
                      </span>
                    </div>
                  )}
                </div>
              </div>

              {/* Additional Details */}
              {(selectedTeacher.additionalDetails || selectedTeacher.qualification || selectedTeacher.experience) && (
                <div>
                  <div className="text-lg font-bold mb-3 flex items-center gap-2">
                    <span>üìù</span> Additional Information
                  </div>
                  <div className="bg-gray-50 rounded-xl p-4 space-y-3">
                    {selectedTeacher.qualification && (
                      <div>
                        <span className="text-gray-600 font-medium">Qualification:</span>
                        <div className="font-semibold mt-1">{selectedTeacher.qualification}</div>
                      </div>
                    )}
                    {selectedTeacher.experience && (
                      <div>
                        <span className="text-gray-600 font-medium">Experience:</span>
                        <div className="font-semibold mt-1">{selectedTeacher.experience}</div>
                      </div>
                    )}
                    {selectedTeacher.additionalDetails && (
                      <div>
                        <span className="text-gray-600 font-medium">Notes:</span>
                        <div className="font-semibold mt-1">{selectedTeacher.additionalDetails}</div>
                      </div>
                    )}
                  </div>
                </div>
              )}

              {/* Action Buttons */}
              <div className="grid grid-cols-2 gap-3 pt-4">
                {selectedTeacher.phone && (
                  <a
                    href={`tel:${selectedTeacher.phone}`}
                    className="bg-blue-500 text-white px-4 py-3 rounded-xl font-semibold text-center hover:bg-blue-600 transition-colors"
                  >
                    üì± Call
                  </a>
                )}
                {selectedTeacher.whatsapp && (
                  <a
                    href={`https://wa.me/${selectedTeacher.whatsapp.replace(/[^0-9]/g, '')}`}
                    target="_blank"
                    rel="noopener noreferrer"
                    className="bg-green-500 text-white px-4 py-3 rounded-xl font-semibold text-center hover:bg-green-600 transition-colors"
                  >
                    üí¨ WhatsApp
                  </a>
                )}
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
// ========================================
// TEACHER EXAM STATISTICS
// ========================================
function TeacherExamStats({ currentUser }) {
  const [examRegistrations, setExamRegistrations] = useState([]);
  const [students, setStudents] = useState([]);
  const [filterGrade, setFilterGrade] = useState('All');
  const [filterGender, setFilterGender] = useState('All');
  const [filterStatus, setFilterStatus] = useState('All');   // Completed / Partial / NotDone / NeedHelp
  const [filterExam, setFilterExam] = useState('All');

  useEffect(() => {
    const fetchData = async () => {
      // All exam registrations
      const regsSnap = await db.collection('studentExamRegistrations').get();
      setExamRegistrations(regsSnap.docs.map(d => ({ ...d.data(), id: d.id })));

      // Students of this school ‚Äì be sure `id` is the student ID
      const stuSnap = await db.collection('students')
        .where('school', '==', currentUser.school)
        .get();

      const studentsData = stuSnap.docs.map(d => {
        const data = d.data();
        let studentId = data.id;
        if (!studentId) {
          const parts = d.id.split('_');      // e.g. JNV_Barwani_1234
          studentId = parts[parts.length - 1];
        }
        return { ...data, id: studentId, docId: d.id };
      });

      setStudents(studentsData);
    };
    fetchData();
  }, [currentUser.school]);

  // Options for filters
  const gradeOptions = Array.from(new Set(students.map(s => s.grade).filter(Boolean))).sort();
  const genderOptions = Array.from(new Set(students.map(s => s.gender).filter(Boolean))).sort();
  const examOptions = Array.from(
    new Set(
      examRegistrations.flatMap(r => (r.exams || []).map(e => e.examName)).filter(Boolean)
    )
  ).sort();

  // Students in this school after basic filters
  const filteredStudents = students.filter(s => {
    if (filterGrade !== 'All' && s.grade !== filterGrade) return false;
    if (filterGender !== 'All' && (s.gender || '') !== filterGender) return false;
    return true;
  });

  // Flatten exam registrations ‚Üí one row per student+exam, with all filters applied
  const detailRows = [];
  examRegistrations.forEach(reg => {
    const student = filteredStudents.find(s => s.id === reg.studentId);
    if (!student) return;
    (reg.exams || []).forEach(exam => {
      if (filterExam !== 'All' && exam.examName !== filterExam) return;

      if (filterStatus === 'Completed' && exam.registrationStatus !== 'Yes') return;
      if (filterStatus === 'Partial' && exam.registrationStatus !== 'Partially') return;
      if (filterStatus === 'NotDone' && exam.registrationStatus !== 'No') return;
      if (filterStatus === 'NeedHelp' && exam.needSupport !== 'Yes') return;

      detailRows.push({ student, reg, exam });
    });
  });

  const totalStudents = filteredStudents.length;
  const studentsWithRegs = new Set(detailRows.map(r => r.reg.studentId)).size;
  const pendingStudents = totalStudents - studentsWithRegs;

  // Exam-wise stats from filtered rows
  const examStats = {};
  detailRows.forEach(({ exam }) => {
    const name = exam.examName || 'Other';
    if (!examStats[name]) {
      examStats[name] = { completed: 0, partial: 0, notCompleted: 0, needSupport: 0 };
    }
    if (exam.registrationStatus === 'Yes') examStats[name].completed++;
    if (exam.registrationStatus === 'Partially') examStats[name].partial++;
    if (exam.registrationStatus === 'No') examStats[name].notCompleted++;
    if (exam.needSupport === 'Yes') examStats[name].needSupport++;
  });

  return (
    <div className="space-y-6">
      <h2 className="text-3xl font-bold">üìä Exam Statistics - {currentUser.school}</h2>

      {/* Summary cards */}
      <div className="grid md:grid-cols-3 gap-4">
        <div className="stat-card bg-blue-500 text-white">
          <div className="text-sm opacity-90">Total Students</div>
          <div className="text-5xl font-bold">{totalStudents}</div>
        </div>
        <div className="stat-card bg-green-500 text-white">
          <div className="text-sm opacity-90">Registered</div>
          <div className="text-5xl font-bold">{studentsWithRegs}</div>
        </div>
        <div className="stat-card bg-orange-500 text-white">
          <div className="text-sm opacity-90">Pending</div>
          <div className="text-5xl font-bold">{pendingStudents}</div>
        </div>
      </div>

      {/* Filters */}
      <div className="bg-white p-6 rounded-2xl shadow-lg">
        <h3 className="text-xl font-bold mb-4">üîç Filters</h3>
        <div className="grid md:grid-cols-4 gap-4">
          <div>
            <label className="block text-sm font-bold mb-2">Grade</label>
            <select
              value={filterGrade}
              onChange={e => setFilterGrade(e.target.value)}
              disabled={!isEditing}
              className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"
            >
              <option value="All">All Grades</option>
              {gradeOptions.map(g => (
                <option key={g} value={g}>Class {g}</option>
              ))}
            </select>
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">Gender</label>
            <select
              value={filterGender}
              onChange={e => setFilterGender(e.target.value)}
              disabled={!isEditing}
              className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"
            >
              <option value="All">All</option>
              {genderOptions.map(g => (
                <option key={g} value={g}>{g}</option>
              ))}
            </select>
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">Exam Name</label>
            <select
              value={filterExam}
              onChange={e => setFilterExam(e.target.value)}
              disabled={!isEditing}
              className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"
            >
              <option value="All">All Exams</option>
              {examOptions.map(name => (
                <option key={name} value={name}>{name}</option>
              ))}
            </select>
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">Status</label>
            <select
              value={filterStatus}
              onChange={e => setFilterStatus(e.target.value)}
              disabled={!isEditing}
              className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"
            >
              <option value="All">All</option>
              <option value="Completed">Completed</option>
              <option value="Partial">Partial</option>
              <option value="NotDone">Not Done</option>
              <option value="NeedHelp">Need Help</option>
            </select>
          </div>
        </div>
      </div>

      {/* Exam-wise status table */}
      <div className="bg-white p-6 rounded-2xl shadow-lg">
        <h3 className="text-xl font-bold mb-4">üìã Exam-wise Status</h3>
        <div className="overflow-x-auto">
          <table className="w-full">
            <thead className="avanti-gradient-light">
              <tr>
                <th className="p-3 text-left">Exam</th>
                <th className="p-3 text-center">‚úì Done</th>
                <th className="p-3 text-center">‚ö† Partial</th>
                <th className="p-3 text-center">‚úó Not Done</th>
                <th className="p-3 text-center">üÜò Need Help</th>
              </tr>
            </thead>
            <tbody>
              {Object.keys(examStats).length === 0 ? (
                <tr>
                  <td colSpan="5" className="p-8 text-center text-gray-500">
                    No registrations yet
                  </td>
                </tr>
              ) : (
                Object.entries(examStats).map(([examName, stats]) => (
                  <tr key={examName} className="border-b hover:bg-gray-50">
                    <td className="p-3 font-semibold">{examName}</td>
                    <td className="p-3 text-center">
                      <span className="px-3 py-1 rounded-full bg-green-100 text-green-700 font-bold">
                        {stats.completed}
                      </span>
                    </td>
                    <td className="p-3 text-center">
                      <span className="px-3 py-1 rounded-full bg-yellow-100 text-yellow-700 font-bold">
                        {stats.partial}
                      </span>
                    </td>
                    <td className="p-3 text-center">
                      <span className="px-3 py-1 rounded-full bg-red-100 text-red-700 font-bold">
                        {stats.notCompleted}
                      </span>
                    </td>
                    <td className="p-3 text-center">
                      <span className="px-3 py-1 rounded-full bg-orange-100 text-orange-700 font-bold">
                        {stats.needSupport}
                      </span>
                    </td>
                  </tr>
                ))
              )}
            </tbody>
          </table>
        </div>
      </div>

      {/* NEW: Student-wise detail table */}
      <div className="bg-white p-6 rounded-2xl shadow-lg">
        <h3 className="text-xl font-bold mb-4">üßë‚Äçüéì Student-wise Exam Registrations</h3>
        <div className="overflow-x-auto">
          <table className="w-full text-sm">
            <thead className="bg-gray-100">
              <tr>
                <th className="p-3 text-left">Student ID</th>
                <th className="p-3 text-left">Name</th>
                <th className="p-3 text-left">Grade</th>
                <th className="p-3 text-left">Gender</th>
                <th className="p-3 text-left">Exam</th>
                <th className="p-3 text-left">Status</th>
                <th className="p-3 text-left">Need Help</th>
                <th className="p-3 text-left">Reg. No.</th>
                <th className="p-3 text-left">Email</th>
                <th className="p-3 text-left">Phone</th>
              </tr>
            </thead>
            <tbody>
              {detailRows.length === 0 ? (
                <tr>
                  <td colSpan="10" className="p-6 text-center text-gray-500">
                    No exam registrations found with current filters.
                  </td>
                </tr>
              ) : (
                detailRows.map((row, idx) => {
                  const status = row.exam.registrationStatus || 'No';
                  const needHelp = row.exam.needSupport === 'Yes';
                  return (
                    <tr key={idx} className="border-b hover:bg-gray-50">
                      <td className="p-3">{row.student.id}</td>
                      <td className="p-3">{row.student.name}</td>
                      <td className="p-3">{row.student.grade}</td>
                      <td className="p-3">{row.student.gender || '‚Äî'}</td>
                      <td className="p-3">{row.exam.examName}</td>
                      <td className="p-3">
                        {status === 'Yes' && <span className="px-3 py-1 rounded-full bg-green-100 text-green-700 font-semibold">Completed</span>}
                        {status === 'Partially' && <span className="px-3 py-1 rounded-full bg-yellow-100 text-yellow-700 font-semibold">Partial</span>}
                        {status === 'No' && <span className="px-3 py-1 rounded-full bg-red-100 text-red-700 font-semibold">Not Done</span>}
                      </td>
                      <td className="p-3">
                        {needHelp ? (
                          <span className="px-3 py-1 rounded-full bg-orange-100 text-orange-700 font-semibold">Yes</span>
                        ) : (
                          'No'
                        )}
                      </td>
                      <td className="p-3">{row.exam.registrationNumber || '‚Äî'}</td>
                      <td className="p-3">{row.exam.emailUsed || '‚Äî'}</td>
                      <td className="p-3">{row.exam.phoneUsed || '‚Äî'}</td>
                    </tr>
                  );
                })
              )}
            </tbody>
          </table>
        </div>
      </div>

      <footer className="bg-gray-800 text-white text-center py-4 mt-auto">
        <p>Made by Anand with ‚ù§Ô∏è</p>
      </footer>
    </div>
  );
}

// ========================================
// STUDENT FEEDBACK VIEW (ADMIN)
// ========================================
function StudentFeedbackView() {
  const [feedbackList, setFeedbackList] = useState([]);
  const [students, setStudents] = useState([]);
  const [teachers, setTeachers] = useState([]);
  const [loading, setLoading] = useState(true);
  
  // Filters
  const [filterSchool, setFilterSchool] = useState('All');
  const [filterGrade, setFilterGrade] = useState('All');
  const [filterTeacher, setFilterTeacher] = useState('All');
  const [searchQuery, setSearchQuery] = useState('');
  const [dateFrom, setDateFrom] = useState('');
  const [dateTo, setDateTo] = useState('');

  // Fetch all data
  useEffect(() => {
    const fetchData = async () => {
      try {
        setLoading(true);
        
        // Fetch feedback
const feedbackSnap = await db.collection('teacherFeedback').get();
const feedbackData = feedbackSnap.docs.map(doc => {
  const data = doc.data();

  // Handle all possible date formats
  let submittedAt = new Date(); // default now

  if (data.submittedAt) {
    if (typeof data.submittedAt.toDate === 'function') {
      // Firestore Timestamp
      submittedAt = data.submittedAt.toDate();
    } else {
      // ISO string / JS Date stored as plain value
      submittedAt = new Date(data.submittedAt);
    }
  } else if (data.completedAt) {
    // Fallback if only completedAt exists
    submittedAt = new Date(data.completedAt);
  }

  return {
    id: doc.id,
    ...data,
    submittedAt,
    // use averageRating if simple rating is missing
    rating: data.rating || data.averageRating || 0,
  };
});


        
        // Fetch students
        const studentsSnap = await db.collection('students').get();
        const studentsData = studentsSnap.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));
        
        // Fetch teachers
        const teachersSnap = await db.collection('teachers').get();
        const teachersData = teachersSnap.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));
        
        setFeedbackList(feedbackData);
        setStudents(studentsData);
        setTeachers(teachersData);
      } catch (error) {
        console.error('Error fetching data:', error);
        alert('Error loading feedback data');
      } finally {
        setLoading(false);
      }
    };
    
    fetchData();
  }, []);

  // Get student details
  const getStudentDetails = (studentId) => {
    return students.find(s => s.id === studentId) || {};
  };

  // Get teacher name
  const getTeacherName = (teacherId) => {
    const teacher = teachers.find(t => t.id === teacherId);
    return teacher ? teacher.name : 'Unknown Teacher';
  };

  // Filter feedback
  const filteredFeedback = feedbackList.filter(feedback => {
    const student = getStudentDetails(feedback.studentId);
    const teacherName = getTeacherName(feedback.teacherId);
    
    // School filter
    if (filterSchool !== 'All' && student.school !== filterSchool) return false;
    
    // Grade filter
    if (filterGrade !== 'All' && student.grade !== filterGrade) return false;
    
    // Teacher filter
    if (filterTeacher !== 'All' && teacherName !== filterTeacher) return false;
    
    // Search query (student name or ID)
    if (searchQuery) {
      const query = searchQuery.toLowerCase();
      const matchesName = student.name?.toLowerCase().includes(query);
      const matchesId = student.studentId?.toLowerCase().includes(query);
      if (!matchesName && !matchesId) return false;
    }
    
    // Date range filter
    if (dateFrom) {
      const fromDate = new Date(dateFrom);
      fromDate.setHours(0, 0, 0, 0);
      if (feedback.submittedAt < fromDate) return false;
    }
    
    if (dateTo) {
      const toDate = new Date(dateTo);
      toDate.setHours(23, 59, 59, 999);
      if (feedback.submittedAt > toDate) return false;
    }
    
    return true;
  });

  // Get unique schools, grades, and teachers for filters
  const uniqueSchools = [...new Set(students.map(s => s.school))].filter(Boolean).sort();
  const uniqueGrades = [...new Set(students.map(s => s.grade))].filter(Boolean).sort();
  const uniqueTeachers = [...new Set(feedbackList.map(f => getTeacherName(f.teacherId)))].filter(Boolean).sort();

  // Export to CSV
  const exportToCSV = () => {
    if (filteredFeedback.length === 0) {
      alert('No feedback to export');
      return;
    }

    const csvData = filteredFeedback.map(feedback => {
      const student = getStudentDetails(feedback.studentId);
      const teacherName = getTeacherName(feedback.teacherId);
      
      return {
        'Date': feedback.submittedAt.toLocaleDateString('en-IN'),
        'Time': feedback.submittedAt.toLocaleTimeString('en-IN'),
        'School': student.school || 'N/A',
        'Student ID': student.studentId || 'N/A',
        'Student Name': student.name || 'N/A',
        'Grade': student.grade || 'N/A',
        'Teacher Name': teacherName,
        'Subject': feedback.subject || 'N/A',
        'Rating': feedback.rating || 0,
        'Explanation Quality': feedback.explanationQuality || 'N/A',
        'Doubt Resolution': feedback.doubtResolution || 'N/A',
        'Teaching Pace': feedback.teachingPace || 'N/A',
        'Comments': feedback.comments || ''
      };
    });

    // Convert to CSV
    const headers = Object.keys(csvData[0]);
    const csvContent = [
      headers.join(','),
      ...csvData.map(row => 
        headers.map(header => {
          const value = row[header]?.toString() || '';
          // Escape quotes and wrap in quotes if contains comma
          return value.includes(',') || value.includes('"') 
            ? `"${value.replace(/"/g, '""')}"` 
            : value;
        }).join(',')
      )
    ].join('\n');

    // Download
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `student_feedback_${new Date().toISOString().split('T')[0]}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  // Get rating badge
  const getRatingBadge = (rating) => {
    if (rating >= 4.5) return { text: 'Excellent', class: 'rating-excellent' };
    if (rating >= 3.5) return { text: 'Good', class: 'rating-good' };
    if (rating >= 2.5) return { text: 'Average', class: 'rating-average' };
    return { text: 'Needs Improvement', class: 'rating-poor' };
  };

  // Statistics
  const stats = {
    total: filteredFeedback.length,
    avgRating: filteredFeedback.length > 0 
      ? (filteredFeedback.reduce((sum, f) => sum + (f.rating || 0), 0) / filteredFeedback.length).toFixed(1)
      : 0,
    excellent: filteredFeedback.filter(f => f.rating >= 4.5).length,
    good: filteredFeedback.filter(f => f.rating >= 3.5 && f.rating < 4.5).length,
    average: filteredFeedback.filter(f => f.rating >= 2.5 && f.rating < 3.5).length,
    poor: filteredFeedback.filter(f => f.rating < 2.5).length
  };

  if (loading) {
    return (
      <div className="flex items-center justify-center min-h-screen">
        <div className="text-2xl font-bold">Loading feedback data...</div>
      </div>
    );
  }

  return (
    <div className="space-y-6 p-6">
      {/* Header */}
      <div className="flex flex-wrap items-center justify-between gap-4">
        <h2 className="text-3xl font-bold">üí¨ Student Feedback</h2>
        <button
          onClick={exportToCSV}
          disabled={filteredFeedback.length === 0}
          className="px-6 py-3 avanti-gradient text-white rounded-xl font-semibold hover:opacity-90 disabled:opacity-50 disabled:cursor-not-allowed"
        >
          üì• Export to CSV
        </button>
      </div>

      {/* Statistics Cards */}
      <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
        <div className="stat-card bg-blue-500 text-white">
          <div className="text-sm opacity-90">Total Feedback</div>
          <div className="text-3xl font-bold">{stats.total}</div>
        </div>
        <div className="stat-card bg-purple-500 text-white">
          <div className="text-sm opacity-90">Avg Rating</div>
          <div className="text-3xl font-bold">‚≠ê {stats.avgRating}</div>
        </div>
        <div className="stat-card bg-green-500 text-white">
          <div className="text-sm opacity-90">Excellent</div>
          <div className="text-3xl font-bold">{stats.excellent}</div>
        </div>
        <div className="stat-card bg-blue-400 text-white">
          <div className="text-sm opacity-90">Good</div>
          <div className="text-3xl font-bold">{stats.good}</div>
        </div>
        <div className="stat-card bg-yellow-500 text-white">
          <div className="text-sm opacity-90">Average</div>
          <div className="text-3xl font-bold">{stats.average}</div>
        </div>
        <div className="stat-card bg-red-500 text-white">
          <div className="text-sm opacity-90">Poor</div>
          <div className="text-3xl font-bold">{stats.poor}</div>
        </div>
      </div>

      {/* Filters */}
      <div className="bg-white p-6 rounded-2xl shadow-lg space-y-4">
        <h3 className="text-xl font-bold mb-4">üîç Filters</h3>
        
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          {/* School Filter */}
          <div>
            <label className="block text-sm font-semibold mb-2">School</label>
            <select
              value={filterSchool}
              onChange={(e) => setFilterSchool(e.target.value)}
              className="w-full p-3 border-2 rounded-xl"
            >
              <option value="All">All Schools</option>
              {uniqueSchools.map(school => (
                <option key={school} value={school}>{school}</option>
              ))}
            </select>
          </div>

          {/* Grade Filter */}
          <div>
            <label className="block text-sm font-semibold mb-2">Grade</label>
            <select
              value={filterGrade}
              onChange={(e) => setFilterGrade(e.target.value)}
              className="w-full p-3 border-2 rounded-xl"
            >
              <option value="All">All Grades</option>
              {uniqueGrades.map(grade => (
                <option key={grade} value={grade}>{grade}</option>
              ))}
            </select>
          </div>

          {/* Teacher Filter */}
          <div>
            <label className="block text-sm font-semibold mb-2">Teacher</label>
            <select
              value={filterTeacher}
              onChange={(e) => setFilterTeacher(e.target.value)}
              className="w-full p-3 border-2 rounded-xl"
            >
              <option value="All">All Teachers</option>
              {uniqueTeachers.map(teacher => (
                <option key={teacher} value={teacher}>{teacher}</option>
              ))}
            </select>
          </div>

          {/* Search */}
          <div>
            <label className="block text-sm font-semibold mb-2">Search Student</label>
            <input
              type="text"
              value={searchQuery}
              onChange={(e) => setSearchQuery(e.target.value)}
              placeholder="Name or ID..."
              className="w-full p-3 border-2 rounded-xl"
            />
          </div>

          {/* Date From */}
          <div>
            <label className="block text-sm font-semibold mb-2">From Date</label>
            <input
              type="date"
              value={dateFrom}
              onChange={(e) => setDateFrom(e.target.value)}
              className="w-full p-3 border-2 rounded-xl"
            />
          </div>

          {/* Date To */}
          <div>
            <label className="block text-sm font-semibold mb-2">To Date</label>
            <input
              type="date"
              value={dateTo}
              onChange={(e) => setDateTo(e.target.value)}
              className="w-full p-3 border-2 rounded-xl"
            />
          </div>
        </div>

        {/* Clear Filters */}
        <button
          onClick={() => {
            setFilterSchool('All');
            setFilterGrade('All');
            setFilterTeacher('All');
            setSearchQuery('');
            setDateFrom('');
            setDateTo('');
          }}
          className="mt-4 px-6 py-2 bg-gray-500 text-white rounded-xl font-semibold hover:bg-gray-600"
        >
          Clear All Filters
        </button>
      </div>

      {/* Feedback Table */}
      <div className="bg-white p-6 rounded-2xl shadow-lg">
        <h3 className="text-xl font-bold mb-4">
          üìã Feedback List ({filteredFeedback.length} {filteredFeedback.length === 1 ? 'entry' : 'entries'})
        </h3>
        
        <div className="overflow-x-auto">
          {filteredFeedback.length === 0 ? (
            <div className="text-center py-12 text-gray-500">
              <div className="text-6xl mb-4">üì≠</div>
              <div className="text-xl font-semibold">No feedback found</div>
              <div className="text-sm mt-2">Try adjusting your filters</div>
            </div>
          ) : (
            <table className="w-full">
              <thead className="avanti-gradient-light">
                <tr>
                  <th className="p-3 text-left">Date</th>
                  <th className="p-3 text-left">School</th>
                  <th className="p-3 text-left">Student ID</th>
                  <th className="p-3 text-left">Student Name</th>
                  <th className="p-3 text-left">Grade</th>
                  <th className="p-3 text-left">Teacher</th>
                  <th className="p-3 text-left">Subject</th>
                  <th className="p-3 text-left">Rating</th>
                  <th className="p-3 text-left">Explanation</th>
                  <th className="p-3 text-left">Doubt Help</th>
                  <th className="p-3 text-left">Pace</th>
                  <th className="p-3 text-left">Comments</th>
                </tr>
              </thead>
              <tbody>
                {filteredFeedback.map(feedback => {
                  const student = getStudentDetails(feedback.studentId);
                  const teacherName = getTeacherName(feedback.teacherId);
                  const ratingBadge = getRatingBadge(feedback.rating);
                  
                  return (
                    <tr key={feedback.id} className="border-b hover:bg-gray-50">
                      <td className="p-3">
                        <div className="text-sm font-semibold">
                          {feedback.submittedAt.toLocaleDateString('en-IN')}
                        </div>
                        <div className="text-xs text-gray-500">
                          {feedback.submittedAt.toLocaleTimeString('en-IN')}
                        </div>
                      </td>
                      <td className="p-3 font-semibold">{student.school || 'N/A'}</td>
                      <td className="p-3">{student.studentId || 'N/A'}</td>
                      <td className="p-3 font-semibold">{student.name || 'N/A'}</td>
                      <td className="p-3">{student.grade || 'N/A'}</td>
                      <td className="p-3 font-semibold">{teacherName}</td>
                      <td className="p-3">{feedback.subject || 'N/A'}</td>
                      <td className="p-3">
                        <div className={`rating-badge ${ratingBadge.class}`}>
                          ‚≠ê {feedback.rating?.toFixed(1) || 0}
                        </div>
                      </td>
                      <td className="p-3">
                        <span className={`px-3 py-1 rounded-full text-sm font-semibold ${
                          feedback.explanationQuality === 'Excellent' ? 'bg-green-100 text-green-700' :
                          feedback.explanationQuality === 'Good' ? 'bg-blue-100 text-blue-700' :
                          feedback.explanationQuality === 'Average' ? 'bg-yellow-100 text-yellow-700' :
                          'bg-red-100 text-red-700'
                        }`}>
                          {feedback.explanationQuality || 'N/A'}
                        </span>
                      </td>
                      <td className="p-3">
                        <span className={`px-3 py-1 rounded-full text-sm font-semibold ${
                          feedback.doubtResolution === 'Always' ? 'bg-green-100 text-green-700' :
                          feedback.doubtResolution === 'Sometimes' ? 'bg-yellow-100 text-yellow-700' :
                          'bg-red-100 text-red-700'
                        }`}>
                          {feedback.doubtResolution || 'N/A'}
                        </span>
                      </td>
                      <td className="p-3">
                        <span className={`px-3 py-1 rounded-full text-sm font-semibold ${
                          feedback.teachingPace === 'Just Right' ? 'bg-green-100 text-green-700' :
                          feedback.teachingPace === 'Too Fast' ? 'bg-orange-100 text-orange-700' :
                          'bg-blue-100 text-blue-700'
                        }`}>
                          {feedback.teachingPace || 'N/A'}
                        </span>
                      </td>
                      <td className="p-3">
                        <div className="max-w-xs truncate" title={feedback.comments}>
                          {feedback.comments || '-'}
                        </div>
                      </td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
          )}
        </div>
      </div>
    </div>
  );
}

ReactDOM.render(<App/>,document.getElementById('root'));
  </script>
  <script>
  // ========================================
  // FORCE UPDATE MECHANISM FOR PWA
  // ========================================
  // Version management - UPDATE THIS WITH EACH DEPLOYMENT
  const CURRENT_VERSION = '2.4.0'; // Change this version number with every update (e.g., 2.4.1, 2.5.0, etc.)

  // Check and prompt for updates
  function checkForUpdates() {
      const storedVersion = localStorage.getItem('appVersion');
      
      if (storedVersion !== CURRENT_VERSION) {
          // New version detected
          if (storedVersion) {
              // Show update notification to existing users
              if (confirm('üéâ A new version of the app is available!\n\nCurrent Version: ' + storedVersion + '\nNew Version: ' + CURRENT_VERSION + '\n\nClick OK to update now.')) {
                  updateApp();
              } else {
                  // User declined, but show reminder
                  setTimeout(() => {
                      if (confirm('‚ö†Ô∏è Please update to get the latest features and fixes.\n\nUpdate now?')) {
                          updateApp();
                      }
                  }, 300000); // Remind after 5 minutes
              }
          } else {
              // First time install
              localStorage.setItem('appVersion', CURRENT_VERSION);
              console.log('‚úÖ App version set to:', CURRENT_VERSION);
          }
      } else {
          console.log('‚úÖ App is up to date. Version:', CURRENT_VERSION);
      }
  }

  // Force update the app
  function updateApp() {
      console.log('üîÑ Starting app update process...');
      
      // Show loading message
      const originalBody = document.body.innerHTML;
      document.body.innerHTML = `
          <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; background: linear-gradient(135deg, #F4B41A 0%, #E8B039 50%, #C8342E 100%); color: white; font-family: Arial, sans-serif;">
              <div style="text-align: center;">
                  <div style="font-size: 4rem; margin-bottom: 1rem;">üîÑ</div>
                  <h1 style="font-size: 2rem; margin-bottom: 1rem;">Updating App...</h1>
                  <p style="font-size: 1.2rem; opacity: 0.9;">Please wait while we install the latest version</p>
                  <div style="margin-top: 2rem;">
                      <div style="width: 200px; height: 4px; background: rgba(255,255,255,0.3); border-radius: 2px; overflow: hidden;">
                          <div style="width: 100%; height: 100%; background: white; animation: progress 2s ease-in-out infinite;"></div>
                      </div>
                  </div>
              </div>
          </div>
          <style>
              @keyframes progress {
                  0% { transform: translateX(-100%); }
                  100% { transform: translateX(100%); }
              }
          </style>
      `;
      
      // Clear all caches
      if ('caches' in window) {
          caches.keys().then(names => {
              names.forEach(name => {
                  caches.delete(name);
                  console.log('üóëÔ∏è Deleted cache:', name);
              });
          });
      }
      
      // Unregister all service workers
      if ('serviceWorker' in navigator) {
          navigator.serviceWorker.getRegistrations().then(registrations => {
              registrations.forEach(registration => {
                  registration.unregister();
                  console.log('üóëÔ∏è Unregistered service worker');
              });
          });
      }
      
      // Clear local storage except critical user data
      const authToken = localStorage.getItem('authToken');
      const userEmail = localStorage.getItem('userEmail');
      const userRole = localStorage.getItem('userRole');
      const userSchool = localStorage.getItem('userSchool');
      
      // Clear all localStorage
      localStorage.clear();
      console.log('üóëÔ∏è Cleared localStorage');
      
      // Restore critical user data
      if (authToken) localStorage.setItem('authToken', authToken);
      if (userEmail) localStorage.setItem('userEmail', userEmail);
      if (userRole) localStorage.setItem('userRole', userRole);
      if (userSchool) localStorage.setItem('userSchool', userSchool);
      
      // Set new version
      localStorage.setItem('appVersion', CURRENT_VERSION);
      console.log('‚úÖ Updated to version:', CURRENT_VERSION);
      
      // Clear session storage
      sessionStorage.clear();
      
      // Reload the page with cache bypass
      setTimeout(() => {
          window.location.reload(true);
      }, 1000);
  }

  // Manual update function (can be called from UI)
  window.forceUpdate = function() {
      if (confirm('üîÑ This will update the app to the latest version.\n\nYour login information will be preserved.\n\nContinue?')) {
          updateApp();
      }
  };

  // Service Worker registration with update detection
  if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
          navigator.serviceWorker.register('/sw.js')
              .then(registration => {
                  console.log('‚úÖ Service Worker registered successfully');
                  
                  // Check for updates every hour
                  setInterval(() => {
                      registration.update();
                      console.log('üîç Checking for service worker updates...');
                  }, 3600000); // 1 hour
                  
                  // Listen for service worker updates
                  registration.addEventListener('updatefound', () => {
                      const newWorker = registration.installing;
                      console.log('üÜï New service worker found!');
                      
                      newWorker.addEventListener('statechange', () => {
                          if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                              // New service worker is ready
                              console.log('‚úÖ New service worker installed');
                              if (confirm('üéâ App update is ready!\n\nClick OK to activate the new version.')) {
                                  newWorker.postMessage({ action: 'skipWaiting' });
                              }
                          }
                      });
                  });
              })
              .catch(err => {
                  console.error('‚ùå Service Worker registration failed:', err);
              });
          
          // Reload when new service worker takes control
          navigator.serviceWorker.addEventListener('controllerchange', () => {
              console.log('üîÑ New service worker activated, reloading...');
              window.location.reload(true);
          });
      });
  }

  // Check for version updates on page load
  window.addEventListener('load', () => {
      // Small delay to ensure everything is loaded
      setTimeout(checkForUpdates, 1000);
  });

  // Also check when app comes back to foreground (for mobile)
  document.addEventListener('visibilitychange', () => {
      if (!document.hidden) {
          checkForUpdates();
      }
  });

  // Log version info on console
  console.log('%cüì± Curriculum Tracker App', 'color: #F4B41A; font-size: 20px; font-weight: bold;');
  console.log('%cVersion: ' + CURRENT_VERSION, 'color: #666; font-size: 14px;');
  console.log('%cTo manually update, type: forceUpdate()', 'color: #666; font-size: 12px;');
</script>
  <script>
  window.va = window.va || function () { (window.vaq = window.vaq || []).push(arguments); };
</script>
<script defer src="/_vercel/insights/script.js"></script>
</body>
</html>
