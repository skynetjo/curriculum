<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Curriculum Tracker - Educational Progress Management</title>
  <meta name="description" content="Track and manage curriculum progress across schools, teachers, and subjects with comprehensive analytics." />

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

  <!-- React -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    * { box-sizing: border-box; }
    
    body { 
      font-family: 'Inter', system-ui, -apple-system, sans-serif; 
      margin: 0; 
      padding: 0;
    }

    /* Animations */
    @keyframes gradient-shift {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }

    @keyframes pulse-glow {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    @keyframes slide-up {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    @keyframes scale-in {
      from { transform: scale(0.95); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }

    @keyframes count-up {
      from { transform: translateY(10px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .animate-gradient { 
      background-size: 300% 300%;
      animation: gradient-shift 20s ease infinite; 
    }

    .animate-pulse-glow { animation: pulse-glow 2s ease-in-out infinite; }
    .animate-slide-up { animation: slide-up 0.5s ease-out; }
    .animate-scale-in { animation: scale-in 0.3s ease-out; }
    .animate-count-up { animation: count-up 0.5s ease-out; }

    /* Card flip animation */
    .flip-card {
      perspective: 1000px;
      cursor: pointer;
    }

    .flip-card-inner {
      position: relative;
      width: 100%;
      height: 100%;
      transition: transform 0.6s;
      transform-style: preserve-3d;
    }

    .flip-card.flipped .flip-card-inner {
      transform: rotateY(180deg);
    }

    .flip-card-front, .flip-card-back {
      position: absolute;
      width: 100%;
      height: 100%;
      backface-visibility: hidden;
      border-radius: 12px;
    }

    .flip-card-back {
      transform: rotateY(180deg);
    }

    /* Dark mode styles */
    .dark {
      background-color: #0f172a;
      color: #f1f5f9;
    }

    .dark .bg-white { background-color: #1e293b; }
    .dark .text-gray-800 { color: #f1f5f9; }
    .dark .text-gray-600 { color: #cbd5e1; }
    .dark .text-gray-500 { color: #94a3b8; }
    .dark .border-gray-200 { border-color: #334155; }
    .dark .bg-gray-50 { background-color: #1e293b; }
    .dark .bg-gray-100 { background-color: #334155; }

    /* Custom scrollbar */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: #f1f5f9; }
    ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #64748b; }

    .dark ::-webkit-scrollbar-track { background: #1e293b; }
    .dark ::-webkit-scrollbar-thumb { background: #475569; }

    select:focus { 
      outline: none; 
      box-shadow: 0 0 0 3px rgba(99,102,241,0.3); 
      border-color: rgb(99 102 241); 
    }

    /* Gradient background */
    .gradient-bg {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .dark .gradient-bg {
      background: linear-gradient(135deg, #4338ca 0%, #6b21a8 100%);
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
  const { useState, useEffect, useRef } = React;

  // ---------- Replace with your Firebase config ----------
  const firebaseConfig = {
    apiKey: "AIzaSyDyyGAHNJvhuint86USW36eBJKfw_u3AcA",
    authDomain: "curriculum-dbb10.firebaseapp.com",
    projectId: "curriculum-dbb10",
    storageBucket: "curriculum-dbb10.firebasestorage.app",
    messagingSenderId: "706387632109",
    appId: "1:706387632109:web:06c78a304fdbdc12f391e4"
  };
  // ------------------------------------------------------

  if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  function App(){
    const [currentUser, setCurrentUser] = useState(null);
    const [isAdmin, setIsAdmin] = useState(false);
    const [activeTab, setActiveTab] = useState('overview');
    const [loginForm, setLoginForm] = useState({ afid: '', password: '' });
    const [loading, setLoading] = useState(false);
    const [teachers, setTeachers] = useState([]);
    const [curriculum, setCurriculum] = useState({});
    const [chapterProgress, setChapterProgress] = useState({});
    const [showConfetti, setShowConfetti] = useState(false);
    const [analyticsData, setAnalyticsData] = useState(null);
    const [darkMode, setDarkMode] = useState(false);
    const [flippedCards, setFlippedCards] = useState({});

    // Chart refs & instances
    const pieRef = useRef(null), barRef = useRef(null), schoolRef = useRef(null), 
          trendRef = useRef(null), subjectRef = useRef(null), testRef = useRef(null);
    const chartInst = useRef({ pie: null, bar: null, school: null, trend: null, subject: null, test: null });

    // seed data
    const TEACHERS_SEED = [
      { afid: 'AF248', name: 'Vivek Bansal', subject: 'Physics', school: 'CoE Barwani', dob: '1990-03-15', email:'vivek@example.com', phone:'9876543210', password:'pass123' },
      { afid: 'AF464', name: 'Sandeep Dixit', subject: 'Chemistry', school: 'CoE Barwani', dob: '1988-07-22', email:'sandeep@example.com', phone:'9876543211', password:'pass123' },
      { afid: 'AF853', name: 'Dayanand Kumar', subject: 'Maths', school: 'CoE Barwani', dob: '1992-11-08', email:'dayanand@example.com', phone:'9876543212', password:'pass123' },
      { afid: 'AF723', name: 'Ranjesh', subject: 'Biology', school: 'JNV Bharuch', dob: '1990-05-05', email:'ranjesh@example.com', phone:'9876543228', password:'pass123' }
    ];

    const CURRICULUM_SEED = {
      Physics: { 
        11: [
          { id:'P11-1', name:'Physical World', topics:['Units','Dimensions','Motion'], targetDate:'2025-11-15' }, 
          { id:'P11-2', name:'Kinematics', topics:['Displacement','Velocity'], targetDate:'2025-11-30' }
        ], 
        12:[{ id:'P12-1', name:'Electric Charges', topics:['Charge','Coulomb'], targetDate:'2025-12-15' }] 
      },
      Chemistry: { 
        11:[{ id:'C11-1', name:'Basic Concepts', topics:['Matter','Atoms'], targetDate:'2025-11-20' }], 
        12:[{ id:'C12-1', name:'Solutions', topics:['Concentration'], targetDate:'2025-12-05' }] 
      },
      Maths: { 
        11:[{ id:'M11-1', name:'Sets', topics:['Theory'], targetDate:'2025-11-25' }], 
        12:[{ id:'M12-1', name:'Functions', topics:['Types'], targetDate:'2025-12-10' }] 
      },
      Biology: { 
        11:[{ id:'B11-1', name:'Living World', topics:['Diversity'], targetDate:'2025-11-18' }], 
        12:[{ id:'B12-1', name:'Reproduction', topics:['Asexual'], targetDate:'2025-12-12' }] 
      }
    };

    // Dark mode initialization
    useEffect(() => {
      const savedTheme = localStorage.getItem('theme');
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      const initialTheme = savedTheme === 'dark' || (!savedTheme && prefersDark);
      setDarkMode(initialTheme);
      if (initialTheme) document.documentElement.classList.add('dark');
    }, []);

    const toggleDarkMode = () => {
      setDarkMode(!darkMode);
      document.documentElement.classList.toggle('dark');
      localStorage.setItem('theme', !darkMode ? 'dark' : 'light');
    };

    // Initialize DB & listeners
    useEffect(() => {
      const init = async () => {
        try {
          const initDoc = await db.collection('system').doc('initialized').get();
          if (!initDoc.exists) {
            for (const t of TEACHERS_SEED) {
              await db.collection('teachers').doc(t.afid).set(t);
            }
            await db.collection('meta').doc('curriculum').set(CURRICULUM_SEED);
            await db.collection('system').doc('initialized').set({ date: new Date().toISOString() });
            console.log('Seeded DB with initial data');
          }
        } catch (e) { console.error('init error', e); }
      };

      const unsubProgress = db.collection('chapterProgress').onSnapshot(snap => {
        const map = {};
        snap.docs.forEach(d => map[d.id] = d.data());
        setChapterProgress(map);
      });

      const unsubTeachers = db.collection('teachers').onSnapshot(snap => {
        const arr = snap.docs.map(d => d.data());
        setTeachers(arr);
      });

      const unsubCurr = db.collection('meta').doc('curriculum').onSnapshot(doc => {
        if (doc.exists) setCurriculum(doc.data());
        else setCurriculum(CURRICULUM_SEED);
      });

      init();
      return () => { unsubProgress(); unsubTeachers(); unsubCurr(); };
    }, []);

    // Analytics computation
    useEffect(() => {
      if (!curriculum || !Object.keys(curriculum).length) return;
      
      const compute = () => {
        const schoolStatus = {};
        const teacherMap = {};
        const subjectStats = {};
        let totalChapters = 0, totalCompleted = 0, totalTests = 0, testsCompleted = 0;
        let delayedCount = 0, onTrackCount = 0, aheadCount = 0;

        Object.keys(curriculum).forEach(subject => {
          subjectStats[subject] = { total: 0, completed: 0 };
          
          Object.keys(curriculum[subject]).forEach(grade => {
            (curriculum[subject][grade] || []).forEach(ch => {
              totalChapters++;
              subjectStats[subject].total++;
              totalTests++;
              
              const prog = chapterProgress[ch.id] || {};
              const st = computeChapterStatus(ch, prog);
              
              if (st.key === 'completed') {
                totalCompleted++;
                subjectStats[subject].completed++;
              }
              if (prog.testConducted === 'Yes') testsCompleted++;
              if (st.key === 'delayed') delayedCount++;
              if (st.key === 'ontrack') onTrackCount++;
              if (st.key === 'ahead') aheadCount++;

              teachers.forEach(t => {
                if (t.subject === subject) {
                  teacherMap[t.afid] = teacherMap[t.afid] || { 
                    afid: t.afid, name: t.name, school: t.school, 
                    completed: 0, total: 0, tests: 0 
                  };
                  teacherMap[t.afid].total++;
                  if (st.key === 'completed') teacherMap[t.afid].completed++;
                  if (prog.testConducted === 'Yes') teacherMap[t.afid].tests++;
                }

                schoolStatus[t.school] = schoolStatus[t.school] || { 
                  delayed: 0, ontrack: 0, total: 0, completed: 0 
                };
                schoolStatus[t.school].total++;
                if (st.key === 'delayed') schoolStatus[t.school].delayed++;
                else if (['ontrack','ahead','completed'].includes(st.key)) {
                  schoolStatus[t.school].ontrack++;
                  if (st.key === 'completed') schoolStatus[t.school].completed++;
                }
              });
            });
          });
        });

        const teacherArr = Object.values(teacherMap).map(t => ({ 
          ...t, 
          percent: t.total ? Math.round((t.completed / t.total) * 100) : 0 
        }));
        teacherArr.sort((a,b) => b.percent - a.percent);

        setAnalyticsData({ 
          totalChapters, totalCompleted, totalTests, testsCompleted,
          delayedCount, onTrackCount, aheadCount,
          teacherArr, schoolStatus, subjectStats 
        });
      };

      compute();
    }, [curriculum, chapterProgress, teachers]);

    // Enhanced Chart rendering
    useEffect(() => {
      if (!analyticsData) {
        destroyAllCharts();
        return;
      }

      const chartColors = {
        primary: '#6366F1',
        success: '#10B981',
        warning: '#F59E0B',
        danger: '#EF4444',
        info: '#3B82F6'
      };

      // Completion Status Pie Chart
      if (pieRef.current) {
        if (chartInst.current.pie) chartInst.current.pie.destroy();
        const completed = analyticsData.totalCompleted || 0;
        const onTrack = analyticsData.onTrackCount || 0;
        const delayed = analyticsData.delayedCount || 0;
        const pending = Math.max(0, analyticsData.totalChapters - completed - onTrack - delayed);
        
        chartInst.current.pie = new Chart(pieRef.current.getContext('2d'), {
          type: 'doughnut',
          data: { 
            labels: ['Completed', 'On Track', 'Delayed', 'Pending'], 
            datasets: [{ 
              label: 'Chapters',
              data: [completed, onTrack, delayed, pending], 
              backgroundColor: [chartColors.success, chartColors.primary, chartColors.danger, chartColors.warning] 
            }] 
          },
          options: { 
            responsive: true,
            maintainAspectRatio: false,
            plugins: { 
              legend: { position: 'bottom', labels: { padding: 12, font: { size: 12 } } } 
            }, 
            cutout: '65%' 
          }
        });
      }

      // School Performance Bar Chart
      if (schoolRef.current) {
        if (chartInst.current.school) chartInst.current.school.destroy();
        const schools = Object.keys(analyticsData.schoolStatus || {});
        const ontrack = schools.map(s => analyticsData.schoolStatus[s].ontrack || 0);
        const delayed = schools.map(s => analyticsData.schoolStatus[s].delayed || 0);
        
        chartInst.current.school = new Chart(schoolRef.current.getContext('2d'), {
          type: 'bar',
          data: { 
            labels: schools, 
            datasets: [
              { label: 'On Track', data: ontrack, backgroundColor: chartColors.success }, 
              { label: 'Delayed', data: delayed, backgroundColor: chartColors.danger }
            ] 
          },
          options: { 
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'bottom' } }, 
            scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true } } 
          }
        });
      }

      // Teacher Performance Bar Chart
      if (barRef.current) {
        if (chartInst.current.bar) chartInst.current.bar.destroy();
        const top = (analyticsData.teacherArr || []).slice(0, 8);
        
        chartInst.current.bar = new Chart(barRef.current.getContext('2d'), {
          type: 'bar',
          data: { 
            labels: top.map(t => `${t.name} (${t.afid})`), 
            datasets: [{ 
              label: 'Completion %', 
              data: top.map(t => t.percent), 
              backgroundColor: chartColors.primary 
            }] 
          },
          options: { 
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y', 
            plugins: { legend: { display: false } }, 
            scales: { x: { min: 0, max: 100, ticks: { callback: v => v + '%' } } } 
          }
        });
      }

      // Subject Breakdown Chart
      if (subjectRef.current) {
        if (chartInst.current.subject) chartInst.current.subject.destroy();
        const subjects = Object.keys(analyticsData.subjectStats || {});
        
        chartInst.current.subject = new Chart(subjectRef.current.getContext('2d'), {
          type: 'bar',
          data: {
            labels: subjects,
            datasets: [{
              label: 'Completion %',
              data: subjects.map(s => {
                const stats = analyticsData.subjectStats[s];
                return stats.total ? Math.round((stats.completed / stats.total) * 100) : 0;
              }),
              backgroundColor: [chartColors.primary, chartColors.success, chartColors.warning, chartColors.info]
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true, max: 100, ticks: { callback: v => v + '%' } } }
          }
        });
      }

      // Test Completion Chart
      if (testRef.current) {
        if (chartInst.current.test) chartInst.current.test.destroy();
        
        chartInst.current.test = new Chart(testRef.current.getContext('2d'), {
          type: 'doughnut',
          data: {
            labels: ['Tests Completed', 'Tests Pending'],
            datasets: [{
              label: 'Tests',
              data: [analyticsData.testsCompleted || 0, (analyticsData.totalTests || 0) - (analyticsData.testsCompleted || 0)],
              backgroundColor: [chartColors.success, chartColors.warning]
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'bottom' } },
            cutout: '65%'
          }
        });
      }

    }, [analyticsData]);

    function destroyAllCharts(){
      Object.values(chartInst.current).forEach(c => { if (c && c.destroy) c.destroy(); });
      chartInst.current = { pie: null, bar: null, school: null, trend: null, subject: null, test: null };
    }

    function computeChapterStatus(chapter = {}, progress = {}){
      const defaultRes = { label:'No target', key:'no-target', color:'bg-gray-100' };
      if (!chapter || !chapter.targetDate) return defaultRes;

      const target = new Date(chapter.targetDate);
      const compDate = progress.completionDate ? new Date(progress.completionDate) : null;
      const topicsDone = (progress.completedTopics || []).length;
      const topicsTotal = (chapter.topics || []).length;

      if (progress.completed === 'Yes' && progress.testConducted !== 'Yes') {
        return { label: 'Partially completed', key: 'partial', color: 'bg-orange-100' };
      }

      if (progress.completed !== 'Yes') {
        const today = new Date();
        if (today > target) return { label: 'Delayed', key:'delayed', color:'bg-red-100' };
        if (topicsDone > 0 && topicsDone < topicsTotal) return { label: 'Partially done', key:'partial-topics', color:'bg-orange-100' };
        return { label: 'Pending', key:'pending', color:'bg-yellow-100' };
      }

      if (compDate) {
        if (compDate > target) return { label:'Delayed', key:'delayed', color:'bg-red-100' };
        if (compDate.toDateString() === target.toDateString()) return { label:'On Track', key:'ontrack', color:'bg-green-100' };
        if (compDate < target) return { label:'Ahead — Good job', key:'ahead', color:'bg-green-100' };
        return { label:'Completed', key:'completed', color:'bg-green-100' };
      }

      return { label:'Completed', key:'completed', color:'bg-green-100' };
    }

    const handleLogin = async () => {
      setLoading(true);
      try {
        const afid = (loginForm.afid || '').trim().toUpperCase();
        if (!afid) { alert('Enter AFID'); setLoading(false); return; }
        
        if (afid === 'ADMIN' && loginForm.password === 'admin123') {
          setIsAdmin(true);
          setCurrentUser({ name:'Administrator', afid:'ADMIN' });
          setActiveTab('admin');
          setLoading(false);
          return;
        }
        
        const doc = await db.collection('teachers').doc(afid).get();
        if (!doc.exists) { alert('Invalid AFID or password'); setLoading(false); return; }
        
        const t = doc.data();
        if (t.password === loginForm.password) {
          setCurrentUser(t);
          setIsAdmin(false);
          setActiveTab('overview');
        } else {
          alert('Invalid AFID or password');
        }
      } catch (e) { 
        console.error('login err', e); 
        alert('Login failed'); 
      }
      setLoading(false);
    };

    const updateChapterProgress = async (chapterId, field, value) => {
      try {
        const updateObj = { [field]: value };
        await db.collection('chapterProgress').doc(chapterId).set(updateObj, { merge: true });
        setChapterProgress(prev => {
          const copied = { ...prev };
          copied[chapterId] = { ...(copied[chapterId] || {}), ...updateObj };
          return copied;
        });
      } catch (e) {
        console.error('update error', e);
        alert('Failed to update. Check connection and rules.');
      }
    };

    const exportCSV = () => {
      if (!analyticsData) return alert('No analytics data');
      const rows = [['AFID','Name','School','Completed','Total','Percent','Tests']];
      analyticsData.teacherArr.forEach(t => rows.push([
        t.afid, t.name, t.school, t.completed, t.total, t.percent + '%', t.tests || 0
      ]));
      const csv = rows.map(r => r.map(cell => `"${String(cell).replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); 
      a.href = url; 
      a.download = `analytics_${new Date().toISOString().slice(0,10)}.csv`; 
      document.body.appendChild(a); 
      a.click(); 
      a.remove(); 
      URL.revokeObjectURL(url);
    };

    // Login Screen
    if (!currentUser) {
      return (
        <div className="min-h-screen gradient-bg flex items-center justify-center p-4 animate-gradient">
          {/* Animated background elements */}
          <div className="fixed inset-0 pointer-events-none overflow-hidden">
            <div className="absolute top-1/4 left-1/4 w-96 h-96 bg-purple-500/20 rounded-full blur-3xl animate-pulse-glow"></div>
            <div className="absolute bottom-1/4 right-1/4 w-96 h-96 bg-pink-500/20 rounded-full blur-3xl animate-pulse-glow" style={{animationDelay: '1s'}}></div>
          </div>

          <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-8 w-full max-w-md animate-scale-in relative z-10">
            <div className="text-center mb-8">
              <div className="text-6xl mb-4">📚</div>
              <h1 className="text-3xl font-bold text-gray-800 dark:text-white">Curriculum Tracker</h1>
              <p className="text-gray-600 dark:text-gray-400 mt-2">Login with AFID and password</p>
            </div>
            <div className="space-y-4">
              <input 
                className="w-full px-4 py-3 border-2 border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 dark:text-white" 
                value={loginForm.afid} 
                onChange={e=>setLoginForm({...loginForm, afid:e.target.value})} 
                placeholder="AFID (e.g. AF248 or ADMIN)"
              />
              <input 
                type="password" 
                className="w-full px-4 py-3 border-2 border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 dark:text-white" 
                value={loginForm.password} 
                onChange={e=>setLoginForm({...loginForm, password:e.target.value})} 
                placeholder="Password"
              />
              <button 
                onClick={handleLogin} 
                disabled={loading} 
                className="w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white py-3 rounded-lg font-semibold hover:from-purple-700 hover:to-pink-700 transition-all"
              >
                {loading ? 'Logging in...' : 'Login'}
              </button>
            </div>
            <div className="mt-6 text-xs text-gray-500 dark:text-gray-400 text-center">
              <p>Admin: <strong>ADMIN</strong> / admin123</p>
              <p>Teacher: <strong>AF248</strong> / pass123</p>
            </div>
          </div>
        </div>
      );
    }

    // Admin Analytics Dashboard
    if (isAdmin) {
      const stats = analyticsData || {};
      const completionRate = stats.totalChapters ? Math.round((stats.totalCompleted / stats.totalChapters) * 100) : 0;
      const testRate = stats.totalTests ? Math.round((stats.testsCompleted / stats.totalTests) * 100) : 0;
      
      return (
        <div className="min-h-screen bg-gray-50 dark:bg-gray-900">
          {/* Animated background */}
          <div className="fixed inset-0 pointer-events-none overflow-hidden">
            <div className="absolute top-0 left-0 w-full h-full bg-gradient-to-br from-purple-500/5 via-transparent to-pink-500/5 animate-gradient bg-[length:300%_300%]"></div>
            <div className="absolute top-1/4 left-1/4 w-96 h-96 bg-purple-500/10 rounded-full blur-3xl animate-pulse-glow"></div>
            <div className="absolute bottom-1/4 right-1/4 w-96 h-96 bg-pink-500/10 rounded-full blur-3xl animate-pulse-glow" style={{animationDelay: '1s'}}></div>
          </div>

          {/* Header */}
          <header className="sticky top-0 z-50 bg-white/80 dark:bg-gray-800/80 backdrop-blur-lg border-b border-gray-200 dark:border-gray-700">
            <div className="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className="p-2 rounded-lg bg-purple-100 dark:bg-purple-900">
                  <span className="text-2xl">🎓</span>
                </div>
                <div>
                  <h1 className="text-xl font-bold text-gray-800 dark:text-white">Curriculum Tracker</h1>
                  <p className="text-sm text-gray-600 dark:text-gray-400">Admin Dashboard</p>
                </div>
              </div>
              <div className="flex items-center gap-3">
                <button 
                  onClick={toggleDarkMode}
                  className="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
                >
                  {darkMode ? '☀️' : '🌙'}
                </button>
                <button 
                  onClick={() => setCurrentUser(null)}
                  className="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors"
                >
                  Logout
                </button>
              </div>
            </div>
          </header>

          <main className="max-w-7xl mx-auto px-4 py-8 relative z-10">
            {/* Stats Cards */}
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
              <div className="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg hover:shadow-xl transition-all animate-slide-up">
                <div className="flex items-start justify-between">
                  <div>
                    <p className="text-sm font-medium text-gray-600 dark:text-gray-400">Total Chapters</p>
                    <p className="text-3xl font-bold mt-2 font-mono animate-count-up">{stats.totalChapters || 0}</p>
                    <p className="text-xs text-gray-500 mt-1">Across all subjects</p>
                  </div>
                  <div className="p-3 rounded-lg bg-purple-100 dark:bg-purple-900">
                    <span className="text-2xl">📚</span>
                  </div>
                </div>
              </div>

              <div className="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg hover:shadow-xl transition-all animate-slide-up" style={{animationDelay: '0.1s'}}>
                <div className="flex items-start justify-between">
                  <div>
                    <p className="text-sm font-medium text-gray-600 dark:text-gray-400">Completed</p>
                    <p className="text-3xl font-bold mt-2 font-mono animate-count-up">{stats.totalCompleted || 0}</p>
                    <p className="text-xs text-green-600 dark:text-green-400 mt-1">{completionRate}% completion rate</p>
                  </div>
                  <div className="p-3 rounded-lg bg-green-100 dark:bg-green-900">
                    <span className="text-2xl">✅</span>
                  </div>
                </div>
              </div>

              <div className="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg hover:shadow-xl transition-all animate-slide-up" style={{animationDelay: '0.2s'}}>
                <div className="flex items-start justify-between">
                  <div>
                    <p className="text-sm font-medium text-gray-600 dark:text-gray-400">Tests Completed</p>
                    <p className="text-3xl font-bold mt-2 font-mono animate-count-up">{stats.testsCompleted || 0}</p>
                    <p className="text-xs text-blue-600 dark:text-blue-400 mt-1">{testRate}% test completion</p>
                  </div>
                  <div className="p-3 rounded-lg bg-blue-100 dark:bg-blue-900">
                    <span className="text-2xl">📝</span>
                  </div>
                </div>
              </div>

              <div className="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg hover:shadow-xl transition-all animate-slide-up" style={{animationDelay: '0.3s'}}>
                <div className="flex items-start justify-between">
                  <div>
                    <p className="text-sm font-medium text-gray-600 dark:text-gray-400">Performance</p>
                    <p className="text-3xl font-bold mt-2 font-mono animate-count-up">{completionRate}%</p>
                    <p className="text-xs text-purple-600 dark:text-purple-400 mt-1">Overall progress</p>
                  </div>
                  <div className="p-3 rounded-lg bg-purple-100 dark:bg-purple-900">
                    <span className="text-2xl">📈</span>
                  </div>
                </div>
              </div>
            </div>

            {/* Charts Grid */}
            <div className="space-y-6">
              {/* Row 1: Pie Charts */}
              <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div className="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg animate-slide-up">
                  <h3 className="text-lg font-semibold mb-4 text-gray-800 dark:text-white">Completion Status</h3>
                  <div style={{height: '300px'}}>
                    <canvas ref={pieRef}></canvas>
                  </div>
                </div>

                <div className="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg animate-slide-up">
                  <h3 className="text-lg font-semibold mb-4 text-gray-800 dark:text-white">Test Completion</h3>
                  <div style={{height: '300px'}}>
                    <canvas ref={testRef}></canvas>
                  </div>
                </div>
              </div>

              {/* Row 2: Bar Charts */}
              <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div className="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg animate-slide-up">
                  <h3 className="text-lg font-semibold mb-4 text-gray-800 dark:text-white">School Performance Comparison</h3>
                  <div style={{height: '300px'}}>
                    <canvas ref={schoolRef}></canvas>
                  </div>
                </div>

                <div className="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg animate-slide-up">
                  <h3 className="text-lg font-semibold mb-4 text-gray-800 dark:text-white">Subject-wise Progress</h3>
                  <div style={{height: '300px'}}>
                    <canvas ref={subjectRef}></canvas>
                  </div>
                </div>
              </div>

              {/* Row 3: Teacher Performance */}
              <div className="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg animate-slide-up">
                <div className="flex items-center justify-between mb-4">
                  <h3 className="text-lg font-semibold text-gray-800 dark:text-white">Teacher Performance Rankings</h3>
                  <button 
                    onClick={exportCSV}
                    className="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors text-sm"
                  >
                    Export CSV
                  </button>
                </div>
                <div style={{height: '400px'}}>
                  <canvas ref={barRef}></canvas>
                </div>
              </div>

              {/* Detailed Table */}
              <div className="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg animate-slide-up">
                <h3 className="text-lg font-semibold mb-4 text-gray-800 dark:text-white">School Comparison Details</h3>
                <div className="overflow-x-auto">
                  <table className="w-full">
                    <thead>
                      <tr className="border-b dark:border-gray-700">
                        <th className="text-left py-3 px-4 text-sm font-medium text-gray-600 dark:text-gray-400">School</th>
                        <th className="text-center py-3 px-4 text-sm font-medium text-gray-600 dark:text-gray-400">Total</th>
                        <th className="text-center py-3 px-4 text-sm font-medium text-gray-600 dark:text-gray-400">Completed</th>
                        <th className="text-center py-3 px-4 text-sm font-medium text-gray-600 dark:text-gray-400">On Track</th>
                        <th className="text-center py-3 px-4 text-sm font-medium text-gray-600 dark:text-gray-400">Delayed</th>
                        <th className="text-center py-3 px-4 text-sm font-medium text-gray-600 dark:text-gray-400">Rate</th>
                        <th className="text-center py-3 px-4 text-sm font-medium text-gray-600 dark:text-gray-400">Status</th>
                      </tr>
                    </thead>
                    <tbody>
                      {Object.keys(stats.schoolStatus || {}).map(school => {
                        const s = stats.schoolStatus[school];
                        const rate = s.total ? Math.round((s.completed / s.total) * 100) : 0;
                        const status = rate >= 80 ? { label: 'Excellent', color: 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300' } :
                                      rate >= 60 ? { label: 'Good', color: 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300' } :
                                      rate >= 40 ? { label: 'Average', color: 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300' } :
                                      { label: 'Needs Attention', color: 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300' };
                        
                        return (
                          <tr key={school} className="border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                            <td className="py-3 px-4 font-medium text-gray-800 dark:text-white">{school}</td>
                            <td className="text-center py-3 px-4 text-gray-600 dark:text-gray-400">{s.total}</td>
                            <td className="text-center py-3 px-4 text-gray-600 dark:text-gray-400">{s.completed}</td>
                            <td className="text-center py-3 px-4 text-gray-600 dark:text-gray-400">{s.ontrack}</td>
                            <td className="text-center py-3 px-4 text-gray-600 dark:text-gray-400">{s.delayed}</td>
                            <td className="text-center py-3 px-4 font-mono font-semibold text-gray-800 dark:text-white">{rate}%</td>
                            <td className="text-center py-3 px-4">
                              <span className={`inline-block px-3 py-1 rounded-full text-xs font-medium ${status.color}`}>
                                {status.label}
                              </span>
                            </td>
                          </tr>
                        );
                      })}
                    </tbody>
                  </table>
                </div>
              </div>

              {/* Insights */}
              <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div className="bg-gradient-to-br from-green-500 to-green-600 p-6 rounded-xl text-white animate-slide-up">
                  <h4 className="font-semibold mb-2">✨ Best Performing</h4>
                  <p className="text-2xl font-bold">{stats.teacherArr?.[0]?.name || 'N/A'}</p>
                  <p className="text-sm opacity-90 mt-1">{stats.teacherArr?.[0]?.percent || 0}% completion rate</p>
                </div>

                <div className="bg-gradient-to-br from-blue-500 to-blue-600 p-6 rounded-xl text-white animate-slide-up" style={{animationDelay: '0.1s'}}>
                  <h4 className="font-semibold mb-2">🎯 On Track</h4>
                  <p className="text-2xl font-bold">{stats.onTrackCount || 0}</p>
                  <p className="text-sm opacity-90 mt-1">Chapters progressing well</p>
                </div>

                <div className="bg-gradient-to-br from-red-500 to-red-600 p-6 rounded-xl text-white animate-slide-up" style={{animationDelay: '0.2s'}}>
                  <h4 className="font-semibold mb-2">⚠️ Needs Attention</h4>
                  <p className="text-2xl font-bold">{stats.delayedCount || 0}</p>
                  <p className="text-sm opacity-90 mt-1">Delayed chapters</p>
                </div>
              </div>
            </div>
          </main>
        </div>
      );
    }

    // Teacher View (simplified - keeping your original structure)
    const [selectedGrade, setSelectedGrade] = useState(11);
    const subj = currentUser.subject;
    const chapters = (curriculum[subj] && curriculum[subj][selectedGrade]) || [];

    return (
      <div className="min-h-screen bg-gray-50 dark:bg-gray-900">
        {/* Animated background */}
        <div className="fixed inset-0 pointer-events-none overflow-hidden">
          <div className="absolute top-0 left-0 w-full h-full bg-gradient-to-br from-purple-500/5 via-transparent to-pink-500/5"></div>
        </div>

        {/* Header */}
        <header className="sticky top-0 z-50 bg-white/80 dark:bg-gray-800/80 backdrop-blur-lg border-b border-gray-200 dark:border-gray-700">
          <div className="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
            <div className="flex items-center gap-3">
              <div className="p-2 rounded-lg bg-purple-100 dark:bg-purple-900">
                <span className="text-2xl">👨‍🏫</span>
              </div>
              <div>
                <h1 className="text-xl font-bold text-gray-800 dark:text-white">{currentUser.name}</h1>
                <p className="text-sm text-gray-600 dark:text-gray-400">{currentUser.subject} - {currentUser.school}</p>
              </div>
            </div>
            <div className="flex items-center gap-3">
              <button 
                onClick={toggleDarkMode}
                className="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
              >
                {darkMode ? '☀️' : '🌙'}
              </button>
              <button 
                onClick={() => setCurrentUser(null)}
                className="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors"
              >
                Logout
              </button>
            </div>
          </div>
        </header>

        <main className="max-w-7xl mx-auto px-4 py-8 relative z-10">
          <div className="flex gap-3 mb-6">
            <button 
              onClick={() => setSelectedGrade(11)} 
              className={`px-6 py-2 rounded-lg font-medium transition-all ${selectedGrade === 11 ? 'bg-purple-600 text-white shadow-lg' : 'bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700'}`}
            >
              Class 11th
            </button>
            <button 
              onClick={() => setSelectedGrade(12)} 
              className={`px-6 py-2 rounded-lg font-medium transition-all ${selectedGrade === 12 ? 'bg-purple-600 text-white shadow-lg' : 'bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700'}`}
            >
              Class 12th
            </button>
          </div>

          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {chapters.map(ch => {
              const prog = chapterProgress[ch.id] || {};
              const status = computeChapterStatus(ch, prog);
              const isFlipped = flippedCards[ch.id];
              const completedTopics = prog.completedTopics || [];
              
              const colorClass = status.key === 'delayed' ? 'border-red-400 bg-red-50 dark:bg-red-900/20' : 
                                status.key === 'partial' || status.key === 'partial-topics' ? 'border-orange-400 bg-orange-50 dark:bg-orange-900/20' : 
                                (['ontrack','ahead','completed'].includes(status.key) ? 'border-green-400 bg-green-50 dark:bg-green-900/20' : 'border-gray-200 bg-white dark:bg-gray-800');

              return (
                <div 
                  key={ch.id} 
                  className={`flip-card ${isFlipped ? 'flipped' : ''} h-80 animate-slide-up`}
                  onClick={() => setFlippedCards({...flippedCards, [ch.id]: !isFlipped})}
                >
                  <div className="flip-card-inner">
                    {/* Front */}
                    <div className={`flip-card-front border-2 ${colorClass} p-5 shadow-lg hover:shadow-xl transition-all`}>
                      <div className="flex justify-between items-start mb-3">
                        <div className="flex-1">
                          <h3 className="text-lg font-semibold text-gray-800 dark:text-white mb-2">{ch.name}</h3>
                          <span className="inline-block px-3 py-1 bg-purple-100 dark:bg-purple-900 text-purple-800 dark:text-purple-300 rounded-full text-xs font-medium">
                            {currentUser.subject}
                          </span>
                        </div>
                        <div className="text-2xl">
                          {status.key === 'completed' || status.key === 'ahead' ? '✅' :
                           status.key === 'delayed' ? '⚠️' : '⏳'}
                        </div>
                      </div>
                      
                      <div className="space-y-3">
                        <div className="text-sm text-gray-600 dark:text-gray-400">
                          <span className="font-medium">Target:</span> {new Date(ch.targetDate).toLocaleDateString()}
                        </div>
                        
                        <div className={`px-3 py-2 rounded-lg text-sm font-medium border-2 ${
                          status.key === 'completed' || status.key === 'ahead' ? 'bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-300 border-green-300' :
                          status.key === 'delayed' ? 'bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-300 border-red-300' :
                          status.key === 'partial' ? 'bg-orange-100 dark:bg-orange-900/30 text-orange-800 dark:text-orange-300 border-orange-300' :
                          'bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-300 border-gray-300'
                        }`}>
                          {status.label}
                        </div>

                        <div>
                          <div className="flex justify-between text-sm mb-1">
                            <span className="text-gray-600 dark:text-gray-400">Topics Progress</span>
                            <span className="font-mono font-semibold text-gray-800 dark:text-white">
                              {completedTopics.length}/{(ch.topics || []).length}
                            </span>
                          </div>
                          <div className="h-2 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
                            <div 
                              className="h-full bg-purple-600 transition-all duration-500"
                              style={{width: `${((completedTopics.length / (ch.topics || []).length) * 100) || 0}%`}}
                            ></div>
                          </div>
                        </div>

                        <div className="text-xs text-center text-gray-500 dark:text-gray-400 mt-4">
                          Click to see details →
                        </div>
                      </div>
                    </div>

                    {/* Back */}
                    <div className="flip-card-back bg-white dark:bg-gray-800 border-2 border-purple-400 p-5 shadow-lg">
                      <h3 className="text-lg font-semibold mb-4 text-gray-800 dark:text-white">Chapter Progress</h3>
                      
                      <div className="space-y-4 overflow-y-auto max-h-60">
                        {/* Test Status */}
                        <div>
                          <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                            Chapter Test
                          </label>
                          <select 
                            value={prog.testConducted || 'No'} 
                            onChange={e => {
                              e.stopPropagation();
                              updateChapterProgress(ch.id, 'testConducted', e.target.value);
                            }}
                            onClick={e => e.stopPropagation()}
                            className="w-full border dark:border-gray-600 bg-white dark:bg-gray-700 px-3 py-2 rounded-lg text-gray-800 dark:text-white"
                          >
                            <option>No</option>
                            <option>Yes</option>
                          </select>
                        </div>

                        {/* Completion Status */}
                        <div>
                          <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                            Completed
                          </label>
                          <select 
                            value={prog.completed || 'No'} 
                            onChange={e => {
                              e.stopPropagation();
                              const val = e.target.value;
                              if (val === 'No') {
                                updateChapterProgress(ch.id, 'completed', 'No');
                                updateChapterProgress(ch.id, 'completionDate', null);
                              } else {
                                updateChapterProgress(ch.id, 'completed', 'Yes');
                                updateChapterProgress(ch.id, 'completionDate', new Date().toISOString().split('T')[0]);
                              }
                            }}
                            onClick={e => e.stopPropagation()}
                            className="w-full border dark:border-gray-600 bg-white dark:bg-gray-700 px-3 py-2 rounded-lg text-gray-800 dark:text-white"
                          >
                            <option>No</option>
                            <option>Yes</option>
                          </select>
                        </div>

                        {/* Topics */}
                        <div>
                          <p className="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                            Topics ({(ch.topics || []).length})
                          </p>
                          <div className="space-y-1 max-h-28 overflow-y-auto">
                            {(ch.topics || []).map((topic, idx) => (
                              <div key={idx} className="flex items-center gap-2 text-sm">
                                <div className={`w-2 h-2 rounded-full ${completedTopics.includes(topic) ? 'bg-green-500' : 'bg-gray-300 dark:bg-gray-600'}`}></div>
                                <span className={completedTopics.includes(topic) ? 'text-gray-800 dark:text-white' : 'text-gray-500 dark:text-gray-400'}>
                                  {topic}
                                </span>
                              </div>
                            ))}
                          </div>
                        </div>
                      </div>

                      <div className="text-xs text-center text-gray-500 dark:text-gray-400 mt-4">
                        ← Click to go back
                      </div>
                    </div>
                  </div>
                </div>
              );
            })}
          </div>
        </main>
      </div>
    );
  }

  ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
