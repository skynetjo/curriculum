<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Curriculum Tracker - Avanti Fellows</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
  <style>
    :root{--avanti-yellow:#F4B41A;--avanti-orange:#E8B039;--avanti-red:#C8342E}
    *{box-sizing:border-box}
    @keyframes confetti-fall{0%{transform:translateY(-100vh) rotate(0) scale(1);opacity:1}100%{transform:translateY(100vh) rotate(720deg) scale(.5);opacity:0}}
    .confetti-piece{position:fixed;pointer-events:none;z-index:9999;animation:confetti-fall 4s cubic-bezier(.25,.46,.45,.94) forwards}
    .chapter-card{transition:all .3s ease;position:relative;overflow:hidden}
    .chapter-card:hover{transform:translateY(-4px);box-shadow:0 20px 40px -12px rgba(0,0,0,.2)}
    .chapter-card.completed{background:linear-gradient(135deg,#d1fae5,#a7f3d0);border:3px solid #10b981}
    .chapter-card.delayed{background:linear-gradient(135deg,#fed7aa,#fdba74);border:3px solid #f97316}
    .chapter-card.pending{background:linear-gradient(135deg,#fecaca,#fca5a5);border:3px solid #ef4444}
    input:focus,select:focus,textarea:focus{outline:none;box-shadow:0 0 0 4px rgba(244,180,26,.2);border-color:var(--avanti-yellow)}
    .avanti-gradient{background:linear-gradient(135deg,var(--avanti-yellow) 0%,var(--avanti-orange) 50%,var(--avanti-red) 100%)}
    .avanti-gradient-light{background:linear-gradient(135deg,rgba(244,180,26,.1) 0%,rgba(232,176,57,.1) 50%,rgba(200,52,46,.1) 100%)}
    .stat-card{background:white;border-radius:1rem;padding:1.5rem;box-shadow:0 4px 6px -1px rgba(0,0,0,.1);transition:all .3s}
    .stat-card:hover{transform:translateY(-4px);box-shadow:0 10px 15px -3px rgba(0,0,0,.1)}
    input[type="checkbox"]{appearance:none;width:20px;height:20px;border:2px solid var(--avanti-red);border-radius:4px;cursor:pointer;position:relative;flex-shrink:0}
    input[type="checkbox"]:checked{background:var(--avanti-red)}
    input[type="checkbox"]:checked::after{content:'✓';position:absolute;color:white;font-size:14px;top:50%;left:50%;transform:translate(-50%,-50%)}
    .birthday-card{background:linear-gradient(135deg,#FFD700,#FFA500);border:3px solid #FF6347;animation:pulse 2s infinite}
    @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
    .modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:9998}
    .modal-content{background:white;border-radius:1rem;padding:2rem;max-width:600px;width:90%;max-height:90vh;overflow-y:auto}
    .status-badge{padding:.5rem 1rem;border-radius:.5rem;font-weight:bold;text-align:center;font-size:.875rem}
    .status-ahead{background:#10b981;color:white}
    .status-ontrack{background:#3b82f6;color:white}
    .status-delayed{background:#f97316;color:white}
    .ranking-card{background:white;border-radius:1rem;padding:1.5rem;box-shadow:0 4px 6px rgba(0,0,0,.1)}
    .ranking-1{border-left:4px solid #fbbf24}
    .ranking-2{border-left:4px solid #c0c0c0}
    .ranking-3{border-left:4px solid #cd7f32}
    .chapter-details{position:relative;z-index:10;pointer-events:auto!important}
.chapter-details input,.chapter-details select,.chapter-details textarea,.chapter-details button,.chapter-details label{position:relative;z-index:20;pointer-events:auto!important;cursor:pointer}
.chapter-details input[type="checkbox"]{cursor:pointer}
.chapter-details select{cursor:pointer;background-color:white}
.chapter-details input[type="date"]{cursor:pointer;background-color:white}
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
const {useState,useEffect,useRef,useCallback,useMemo}=React;
const firebaseConfig={apiKey:"AIzaSyDyyGAHNJvhuint86USW36eBJKfw_u3AcA",authDomain:"curriculum-dbb10.firebaseapp.com",projectId:"curriculum-dbb10",storageBucket:"curriculum-dbb10.firebasestorage.app",messagingSenderId:"706387632109",appId:"1:706387632109:web:06c78a304fdbdc12f391e4"};
if(!firebase.apps.length){firebase.initializeApp(firebaseConfig)}
const db=firebase.firestore();
const auth=firebase.auth();
const SUBJECTS=['Physics','Chemistry','Maths','Biology'];
const SCHOOLS=['CoE Barwani','CoE Cuttak','CoE Bundi','CoE Mahisagar','EMRS Bhopal','JNV Bharuch'];
const LEAVE_REASONS=['Present','Personal Leave','Sick Leave','Weekly Off','Public Holiday','Organization Holiday','School Holiday','Emergency Leave'];
const GENDERS=['Male','Female','Other'];    
const AVANTI_LOGO = 'data:image/png;base64,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';
const exportToExcel=(data,filename)=>{const ws=XLSX.utils.json_to_sheet(data);const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,"Data");XLSX.writeFile(wb,`${filename}_${new Date().toISOString().slice(0,10)}.xlsx`)};
const getBirthdays=(teachers,period='week')=>{const now=new Date();return teachers.filter(t=>{if(!t.dob)return false;const d=new Date(t.dob);const thisYear=new Date(now.getFullYear(),d.getMonth(),d.getDate());const diff=Math.ceil((thisYear-now)/(1000*60*60*24));if(period==='today'){return d.getDate()===now.getDate()&&d.getMonth()===now.getMonth()}else if(period==='week'){return diff>=0&&diff<=7}else if(period==='month'){return d.getMonth()===now.getMonth()}return false})};
const getAnniversaries=(teachers,period='week')=>{const now=new Date();return teachers.filter(t=>{if(!t.joiningDate)return false;const j=new Date(t.joiningDate);if(j.getFullYear()>=now.getFullYear())return false;const thisYear=new Date(now.getFullYear(),j.getMonth(),j.getDate());const diff=Math.ceil((thisYear-now)/(1000*60*60*24));if(period==='today'){return j.getDate()===now.getDate()&&j.getMonth()===now.getMonth()}else if(period==='week'){return diff>=0&&diff<=7}else if(period==='month'){return j.getMonth()===now.getMonth()}return false})};
const getTodayDate=()=>{
const today=new Date();
  return today.toISOString().split('T')[0];
};

const getMonthYear=(date)=>{
  const d=new Date(date);
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
};

const getAttendanceStats=(attendanceRecords,filterDate=null)=>{
  if(filterDate){
    const filtered=attendanceRecords.filter(r=>r.date===filterDate);
    const present=filtered.filter(r=>r.status==='Present').length;
    return{total:filtered.length,present,absent:filtered.length-present};
  }
  const present=attendanceRecords.filter(r=>r.status==='Present').length;
  return{total:attendanceRecords.length,present,absent:attendanceRecords.length-present};
};

const getMonthlyAttendanceStats=(attendanceRecords,month)=>{
  const filtered=attendanceRecords.filter(r=>getMonthYear(r.date)===month);
  const dayStats={};
  filtered.forEach(record=>{
    if(!dayStats[record.date]){
      dayStats[record.date]={present:0,absent:0};
    }
    if(record.status==='Present'){
      dayStats[record.date].present++;
    }else{
      dayStats[record.date].absent++;
    }
  });
  return dayStats;
};
const getChapterStatus=(chapter,progress)=>{if(!chapter.targetDate){return{label:'No Target',color:'pending',class:'status-delayed'}}const targetDate=new Date(chapter.targetDate);const today=new Date();const completionDate=progress.completionDate?new Date(progress.completionDate):null;if(progress.completed==='Yes'&&progress.testConducted==='Yes'){if(completionDate){if(completionDate<targetDate){return{label:'Ahead - Good Job! 🎉',color:'completed',class:'status-ahead'}}else if(completionDate.toDateString()===targetDate.toDateString()){return{label:'On Track ✓',color:'completed',class:'status-ontrack'}}else{return{label:'Completed (Late)',color:'delayed',class:'status-delayed'}}}return{label:'Completed ✓',color:'completed',class:'status-ahead'}}if(today>targetDate){return{label:'Delayed ⚠️',color:'delayed',class:'status-delayed'}}return{label:'Pending',color:'pending',class:'status-delayed'}};

function App(){const[currentUser,setCurrentUser]=useState(null);const[isAdmin,setIsAdmin]=useState(false);const[activeTab,setActiveTab]=useState('overview');const[loginForm,setLoginForm]=useState({email:'',password:''});const[loading,setLoading]=useState(true);const[authLoading,setAuthLoading]=useState(false);const[teachers,setTeachers]=useState([]);const[curriculum,setCurriculum]=useState({});const[chapterProgress,setChapterProgress]=useState({});const[students,setStudents]=useState([]);
const[studentAttendance,setStudentAttendance]=useState([]);
const[teacherAttendance,setTeacherAttendance]=useState([]);const[showConfetti,setShowConfetti]=useState(false);const[celebrationMessage,setCelebrationMessage]=useState('');
useEffect(()=>{const unsubscribe=auth.onAuthStateChanged(async(user)=>{if(user){if(user.email==='admin@avantifellows.org'){setIsAdmin(true);setCurrentUser({name:'Administrator',email:user.email,afid:'ADMIN',school:'Admin'});setActiveTab('teachers')}else{const teacherSnapshot=await db.collection('teachers').where('email','==',user.email).limit(1).get();if(!teacherSnapshot.empty){const teacherData=teacherSnapshot.docs[0].data();setCurrentUser(teacherData);setIsAdmin(false);setActiveTab('overview');if(teacherData.dob){const d=new Date(teacherData.dob);const now=new Date();if(d.getMonth()===now.getMonth()&&d.getDate()===now.getDate()){setShowConfetti(true);setCelebrationMessage(`🎂 Happy Birthday, ${teacherData.name}!`);setTimeout(()=>{setShowConfetti(false);setCelebrationMessage('')},8000)}}if(teacherData.joiningDate){const j=new Date(teacherData.joiningDate);const now=new Date();if(j.getMonth()===now.getMonth()&&j.getDate()===now.getDate()&&j.getFullYear()<now.getFullYear()){const years=now.getFullYear()-j.getFullYear();setShowConfetti(true);setCelebrationMessage(`🎉 Happy ${years} Year Work Anniversary, ${teacherData.name}!`);setTimeout(()=>{setShowConfetti(false);setCelebrationMessage('')},8000)}}}else{alert('Teacher profile not found. Please contact admin.');await auth.signOut()}}}else{setCurrentUser(null);setIsAdmin(false)}setLoading(false)});return()=>unsubscribe()},[]);
useEffect(() => {
  const unsubProgress = db.collection('chapterProgress').onSnapshot(snap => {
    const map = {};
    snap.docs.forEach(d => map[d.id] = d.data());
    setChapterProgress(map);
  });

  const unsubTeachers = db.collection('teachers').onSnapshot(snap => {
    setTeachers(snap.docs.map(d => ({ ...d.data(), id: d.id })));
  });

  const unsubCurriculum = db.collection('curriculum').onSnapshot(snap => {
    const currMap = {};
    snap.docs.forEach(doc => { currMap[doc.id] = doc.data() });
    setCurriculum(currMap);
  });

  // ✅ Add these 3 new subscriptions here:

  const unsubStudents = db.collection('students').onSnapshot(snap => {
    setStudents(snap.docs.map(d => ({ ...d.data(), id: d.id })));
  });

  const unsubStudentAttendance = db.collection('studentAttendance').onSnapshot(snap => {
    setStudentAttendance(snap.docs.map(d => ({ ...d.data(), id: d.id })));
  });

  const unsubTeacherAttendance = db.collection('teacherAttendance').onSnapshot(snap => {
    setTeacherAttendance(snap.docs.map(d => ({ ...d.data(), id: d.id })));
  });

  return () => {
    unsubProgress();
    unsubTeachers();
    unsubCurriculum();
    // ✅ Cleanup the new ones too
    unsubStudents();
    unsubStudentAttendance();
    unsubTeacherAttendance();
  };
}, []);
const handleLogin=async()=>{setAuthLoading(true);try{const email=(loginForm.email||'').trim().toLowerCase();const password=loginForm.password;if(!email||!password){alert('Please enter email and password');setAuthLoading(false);return}await auth.signInWithEmailAndPassword(email,password)}catch(e){console.error('login error',e);alert('Login failed: '+e.message)}setAuthLoading(false)};
const handleLogout=async()=>{try{await auth.signOut();setActiveTab('overview')}catch(e){console.error('logout error',e)}};
const updateChapterProgress=useCallback(async(school,chapterId,field,value)=>{try{const docId=`${school}_${chapterId}`;await db.collection('chapterProgress').doc(docId).set({[field]:value},{merge:true});if(field==='completed'&&value==='Yes'){const testStatus=chapterProgress[docId]?.testConducted;if(testStatus==='Yes'){setShowConfetti(true);setCelebrationMessage('🎉 Chapter Completed Successfully!');setTimeout(()=>{setShowConfetti(false);setCelebrationMessage('')},5000)}}}catch(e){console.error('Update error',e);alert('Failed to update: '+e.message)}},[chapterProgress]);
const addChapter=async(school,subject,grade,chapter)=>{try{const docId=`${school}_${subject}_${grade}`;const doc=await db.collection('curriculum').doc(docId).get();const existing=doc.exists?(doc.data().chapters||[]):[];chapter.id=`${subject.charAt(0)}${grade}-${existing.length+1}-${Date.now().toString().slice(-4)}`;const updated=[...existing,chapter];await db.collection('curriculum').doc(docId).set({chapters:updated});alert('Chapter added successfully!')}catch(e){console.error('Add error',e);alert('Failed to add: '+e.message)}};
const updateChapter=async(school,subject,grade,chapterId,updates)=>{try{const docId=`${school}_${subject}_${grade}`;const doc=await db.collection('curriculum').doc(docId).get();const existing=doc.exists?(doc.data().chapters||[]):[];const index=existing.findIndex(ch=>ch.id===chapterId);if(index===-1){alert('Chapter not found');return}existing[index]={...existing[index],...updates};await db.collection('curriculum').doc(docId).set({chapters:existing});alert('Chapter updated successfully!')}catch(e){console.error('Update error',e);alert('Failed to update: '+e.message)}};
const deleteChapter=async(school,subject,grade,chapterId)=>{if(!confirm('Delete this chapter?'))return;try{const docId=`${school}_${subject}_${grade}`;const doc=await db.collection('curriculum').doc(docId).get();const existing=doc.exists?(doc.data().chapters||[]):[];const updated=existing.filter(ch=>ch.id!==chapterId);await db.collection('curriculum').doc(docId).set({chapters:updated});alert('Chapter deleted successfully')}catch(e){console.error('Delete error',e);alert('Failed to delete: '+e.message)}};
function Confetti(){const shapes=['●','■','▲','★','♦','♥','✦','✧'];const colors=['#F4B41A','#E8B039','#C8342E','#FFA07A','#98D8C8','#F7DC6F'];return(<div className="fixed inset-0 pointer-events-none z-[9999]">{Array.from({length:60}).map((_,i)=>{const shape=shapes[Math.floor(Math.random()*shapes.length)];const color=colors[Math.floor(Math.random()*colors.length)];const size=12+Math.random()*20;const left=Math.random()*100;const delay=Math.random()*2;return(<div key={i} className="confetti-piece" style={{left:`${left}%`,top:'-50px',color:color,fontSize:`${size}px`,animationDelay:`${delay}s`}}>{shape}</div>)})}</div>)}
if(loading){return(<div className="min-h-screen avanti-gradient flex items-center justify-center"><div className="text-center"><img src={AVANTI_LOGO} alt="Avanti Fellows" className="w-20 h-20 mx-auto mb-4 animate-bounce"/><div className="text-white text-2xl font-bold">Loading...</div></div></div>)}
if(!currentUser){return(<div className="min-h-screen avanti-gradient flex items-center justify-center p-4"><div className="bg-white rounded-3xl shadow-2xl p-10 w-full max-w-md"><div className="text-center mb-8"><img src={AVANTI_LOGO} alt="Avanti Fellows" className="w-20 h-20 mx-auto mb-4"/><h1 className="text-4xl font-bold text-gray-800 mb-2">Curriculum Tracker</h1><p className="text-gray-600 mt-3">Avanti Fellows</p></div><div className="space-y-5"><input type="email" className="w-full px-5 py-4 border-2 border-gray-300 rounded-xl text-lg" value={loginForm.email} onChange={e=>setLoginForm({...loginForm,email:e.target.value})} placeholder="Email"/><input type="password" className="w-full px-5 py-4 border-2 border-gray-300 rounded-xl text-lg" value={loginForm.password} onChange={e=>setLoginForm({...loginForm,password:e.target.value})} placeholder="Password" onKeyPress={e=>e.key==='Enter'&&handleLogin()}/><button onClick={handleLogin} disabled={authLoading} className="w-full avanti-gradient text-white py-4 rounded-xl font-bold text-lg disabled:opacity-50">{authLoading?'Logging in...':'Login'}</button></div></div></div>)}

return isAdmin?<AdminView currentUser={currentUser} handleLogout={handleLogout} teachers={teachers} students={students} curriculum={curriculum} chapterProgress={chapterProgress} studentAttendance={studentAttendance} teacherAttendance={teacherAttendance} addChapter={addChapter} updateChapter={updateChapter} deleteChapter={deleteChapter}/>:<TeacherView currentUser={currentUser} handleLogout={handleLogout} showConfetti={showConfetti} Confetti={Confetti} celebrationMessage={celebrationMessage} teachers={teachers} students={students} curriculum={curriculum} chapterProgress={chapterProgress} studentAttendance={studentAttendance} teacherAttendance={teacherAttendance} updateChapterProgress={updateChapterProgress} activeTab={activeTab} setActiveTab={setActiveTab}/>;
}

function TeacherView({currentUser,handleLogout,showConfetti,Confetti,celebrationMessage,teachers,students,curriculum,chapterProgress,studentAttendance,teacherAttendance,updateChapterProgress,activeTab,setActiveTab}){return(<div className="min-h-screen bg-gray-50 flex flex-col">{showConfetti&&<Confetti/>}<nav className="avanti-gradient shadow-lg sticky top-0 z-50"><div className="max-w-7xl mx-auto px-4 py-4"><div className="flex justify-between items-center"><div className="flex items-center gap-3"><img src={AVANTI_LOGO} alt="Avanti" className="w-12 h-12"/><div><h1 className="text-2xl font-bold text-white">Curriculum Tracker</h1><p className="text-sm text-white opacity-90">Avanti Fellows</p></div></div><div className="flex items-center gap-4"><div className="text-right hidden sm:block"><p className="text-white font-semibold">{currentUser.name}</p><p className="text-sm text-white opacity-90">{currentUser.school}</p></div><button onClick={handleLogout} className="px-4 py-2 bg-white text-gray-800 rounded-xl font-semibold">Logout</button></div></div></div></nav>{celebrationMessage&&<div className="avanti-gradient text-white text-center py-4 text-xl font-bold">{celebrationMessage}</div>}<div className="flex-1 max-w-7xl mx-auto px-4 py-6 w-full"><div className="flex gap-3 mb-6 overflow-x-auto pb-2">{['overview','analytics','class11','class12','attendance','attendancedash','myattendance','birthdays'].map(tab=><button key={tab} onClick={()=>setActiveTab(tab)} className={`px-6 py-3 rounded-xl font-semibold whitespace-nowrap ${activeTab===tab?'avanti-gradient text-white':'bg-white'}`}>{tab==='overview'&&'📊 Overview'}
{tab==='analytics'&&'📈 Analytics'}
{tab==='class11'&&'📚 Class 11'}
{tab==='class12'&&'📖 Class 12'}
{tab==='attendance'&&'✅ Mark Attendance'}
{tab==='attendancedash'&&'📊 Attendance Dashboard'}
{tab==='myattendance'&&'👤 My Attendance'}
{tab==='birthdays'&&'🎂 Celebrations'}</button>)}</div>{activeTab==='overview'&&<TeacherOverview currentUser={currentUser} curriculum={curriculum} chapterProgress={chapterProgress} teachers={teachers} teacherAttendance={teacherAttendance} studentAttendance={studentAttendance}/>}{activeTab==='analytics'&&<TeacherAnalytics currentUser={currentUser} curriculum={curriculum} chapterProgress={chapterProgress}/>}{activeTab==='class11'&&<TeacherCurriculum grade="11" currentUser={currentUser} curriculum={curriculum} chapterProgress={chapterProgress} updateChapterProgress={updateChapterProgress}/>}{activeTab==='class12'&&<TeacherCurriculum grade="12" currentUser={currentUser} curriculum={curriculum} chapterProgress={chapterProgress} updateChapterProgress={updateChapterProgress}/>}{activeTab==='birthdays'&&<BirthdaysPage teachers={teachers} currentUser={currentUser}/>}{activeTab==='attendance'&&<StudentAttendanceView currentUser={currentUser} students={students} studentAttendance={studentAttendance}/>}
{activeTab==='attendancedash'&&<TeacherAttendanceDashboard currentUser={currentUser} students={students} teachers={teachers} studentAttendance={studentAttendance} teacherAttendance={teacherAttendance}/>}
{activeTab==='myattendance'&&<TeacherAttendanceView currentUser={currentUser} teacherAttendance={teacherAttendance}/>}</div><footer className="bg-gray-800 text-white text-center py-4 mt-auto"><p>Made by Anand with ❤️</p></footer></div>)}

function AdminView({currentUser,handleLogout,teachers,students,curriculum,chapterProgress,studentAttendance,teacherAttendance,addChapter,updateChapter,deleteChapter}){const[activeTab,setActiveTab]=useState('teachers');return(<div className="min-h-screen bg-gray-50 flex flex-col"><nav className="avanti-gradient shadow-lg sticky top-0 z-50"><div className="max-w-7xl mx-auto px-4 py-4"><div className="flex justify-between items-center"><div className="flex items-center gap-3"><img src={AVANTI_LOGO} alt="Avanti" className="w-12 h-12"/><h1 className="text-2xl font-bold text-white">Admin Dashboard</h1></div><button onClick={handleLogout} className="px-4 py-2 bg-white text-gray-800 rounded-xl font-semibold">Logout</button></div></div></nav><div className="flex-1 max-w-7xl mx-auto px-4 py-6 w-full"><div className="flex gap-3 mb-6 overflow-x-auto pb-2">{['teachers','students','curriculum','analytics','chapter-details','attendance','birthdays'].map(tab=><button key={tab} onClick={()=>setActiveTab(tab)} className={`px-6 py-3 rounded-xl font-semibold whitespace-nowrap ${activeTab===tab?'avanti-gradient text-white':'bg-white'}`}>{tab==='teachers'&&'👥 Teachers'}
{tab==='students'&&'👨‍🎓 Students'}
{tab==='curriculum'&&'📚 Curriculum'}
{tab==='analytics'&&'📊 Analytics'}
{tab==='chapter-details'&&'📋 Chapter Details'}
{tab==='attendance'&&'📊 Attendance Analytics'}
{tab==='birthdays'&&'🎂 Celebrations'}</button>)}</div>{activeTab==='teachers'&&<TeacherManagement teachers={teachers}/>}{activeTab==='curriculum'&&<AdminCurriculum curriculum={curriculum} addChapter={addChapter} updateChapter={updateChapter} deleteChapter={deleteChapter}/>}{activeTab==='analytics'&&<AdminAnalytics teachers={teachers} curriculum={curriculum} chapterProgress={chapterProgress}/>}{activeTab==='chapter-details'&&<AdminChapterDetails curriculum={curriculum} chapterProgress={chapterProgress} teachers={teachers}/>}{activeTab==='birthdays'&&<AdminBirthdays teachers={teachers}/>}{activeTab==='students'&&<StudentManagement students={students}/>}
{activeTab==='attendance'&&<AdminAttendanceAnalytics students={students} teachers={teachers} studentAttendance={studentAttendance} teacherAttendance={teacherAttendance}/>}</div><footer className="bg-gray-800 text-white text-center py-4 mt-auto"><p>Made by Anand with ❤️</p></footer></div>)}
function TeacherOverview({currentUser,curriculum,chapterProgress,teachers,teacherAttendance,studentAttendance}){const mySchool=currentUser.school;const mySubject=currentUser.subject;const schoolRankings=useMemo(()=>{const rankings=SCHOOLS.map(school=>{let total=0,completed=0;SUBJECTS.forEach(subject=>{['11','12'].forEach(grade=>{const docId=`${school}_${subject}_${grade}`;const chapters=curriculum[docId]?.chapters||[];chapters.forEach(ch=>{total++;const progressId=`${school}_${ch.id}`;const prog=chapterProgress[progressId]||{};if(prog.completed==='Yes'&&prog.testConducted==='Yes'){completed++}})})});return{school,total,completed,percentage:total?Math.round((completed/total)*100):0}});rankings.sort((a,b)=>b.percentage-a.percentage);return rankings},[curriculum,chapterProgress]);const subjectRankings=useMemo(()=>{
  const rankings=SUBJECTS.map(subject=>{
    let total=0,completed=0;
    ['11','12'].forEach(grade=>{
      const docId=`${mySchool}_${subject}_${grade}`;
      const chapters=curriculum[docId]?.chapters||[];
      chapters.forEach(ch=>{
        total++;
        const progressId=`${mySchool}_${ch.id}`;
        const prog=chapterProgress[progressId]||{};
        if(prog.completed==='Yes'&&prog.testConducted==='Yes'){
          completed++
        }
      })
    });
    return{subject,total,completed,percentage:total?Math.round((completed/total)*100):0}
  })
  .filter(rank=>rank.total>0); // ⭐ ADD THIS LINE - Filter out subjects with no chapters

  rankings.sort((a,b)=>b.percentage-a.percentage);
  return rankings
},[curriculum,chapterProgress,mySchool]);const mySchoolRank=schoolRankings.findIndex(r=>r.school===mySchool)+1;const laggingSubject=subjectRankings[subjectRankings.length-1];return(<div className="space-y-6"><h2 className="text-3xl font-bold">Dashboard Overview</h2><div className="grid md:grid-cols-4 gap-4"><div className="stat-card avanti-gradient text-white"><div className="text-sm opacity-90">Your School Rank</div><div className="text-5xl font-bold">#{mySchoolRank}</div><div className="text-sm mt-2">Out of {SCHOOLS.length} schools</div></div><div className="stat-card bg-gradient-to-br from-green-500 to-emerald-600 text-white"><div className="text-sm opacity-90">Best Performing School</div><div className="text-2xl font-bold mt-2">{schoolRankings[0]?.school}</div><div className="text-sm mt-2">{schoolRankings[0]?.percentage}% completed</div></div><div className="stat-card bg-gradient-to-br from-orange-500 to-red-600 text-white"><div className="text-sm opacity-90">Lagging Subject (Your School)</div><div className="text-2xl font-bold mt-2">{laggingSubject?.subject}</div><div className="text-sm mt-2">{laggingSubject?.percentage}% completed</div></div></div><div className="bg-white p-6 rounded-2xl shadow-lg"><h3 className="text-2xl font-bold mb-4">🏆 School Rankings</h3><div className="space-y-3">{schoolRankings.map((rank,index)=><div key={rank.school} className={`ranking-card ${index===0?'ranking-1':index===1?'ranking-2':index===2?'ranking-3':''} ${rank.school===mySchool?'bg-yellow-50':''}`}><div className="flex justify-between items-center"><div className="flex items-center gap-4"><div className="text-2xl font-bold text-gray-400">#{index+1}</div><div><div className="font-bold text-lg">{rank.school} {rank.school===mySchool&&'⭐'}</div><div className="text-sm text-gray-600">{rank.completed} / {rank.total} chapters completed</div></div></div><div className="text-3xl font-bold" style={{color:'var(--avanti-red)'}}>{rank.percentage}%</div></div></div>)}</div></div><div className="bg-white p-6 rounded-2xl shadow-lg"><h3 className="text-2xl font-bold mb-4">📚 Subject Performance in {mySchool}</h3><div className="grid md:grid-cols-2 gap-4">{subjectRankings.map(rank=><div key={rank.subject} className="border-2 rounded-xl p-4"><div className="flex justify-between items-center mb-2"><div className="font-bold text-lg">{rank.subject}</div><div className="text-2xl font-bold" style={{color:'var(--avanti-red)'}}>{rank.percentage}%</div></div><div className="h-2 bg-gray-200 rounded-full"><div className="h-2 avanti-gradient rounded-full" style={{width:`${rank.percentage}%`}}/></div><div className="text-sm text-gray-600 mt-2">{rank.completed} / {rank.total} chapters</div></div>)}</div></div><div className="stat-card bg-gradient-to-br from-purple-500 to-pink-600 text-white">
  <div className="text-sm opacity-90">My Attendance (This Month)</div>
  <div className="text-2xl font-bold mt-2">
    {teacherAttendance.filter(a=>a.teacherId===currentUser.afid&&getMonthYear(a.date)===getMonthYear(getTodayDate())).length} days
  </div>
  <div className="text-sm mt-2">Marked this month</div>
  <div className="bg-white p-6 rounded-2xl shadow-lg">
  <h3 className="text-2xl font-bold mb-4">📊 Quick Attendance Overview</h3>
  <div className="grid md:grid-cols-2 gap-4">
    <div className="border-2 rounded-xl p-4">
      <h4 className="font-bold mb-2">Today's Student Attendance</h4>
      <p className="text-sm text-gray-600">
        Present: <strong className="text-green-600">
          {studentAttendance.filter(a=>a.date===getTodayDate()&&a.school===currentUser.school&&a.status==='Present').length}
        </strong>
      </p>
      <p className="text-sm text-gray-600">
        Absent: <strong className="text-red-600">
          {studentAttendance.filter(a=>a.date===getTodayDate()&&a.school===currentUser.school&&a.status==='Absent').length}
        </strong>
      </p>
    </div>
    <div className="border-2 rounded-xl p-4">
      <h4 className="font-bold mb-2">My Attendance Status</h4>
      {teacherAttendance.find(a=>a.teacherId===currentUser.afid&&a.date===getTodayDate())?
        <div className="text-sm">
          <p className="text-green-600 font-bold">✓ Marked for today</p>
          <p className="text-gray-600">
            Status: {teacherAttendance.find(a=>a.teacherId===currentUser.afid&&a.date===getTodayDate()).status}
          </p>
        </div>
      :
        <p className="text-orange-600 font-bold">⚠️ Not marked yet</p>
      }
    </div>
  </div>
</div>
</div></div>)}
function TeacherAnalytics({currentUser,curriculum,chapterProgress}){const chartRef=useRef(null);const chartInstance=useRef(null);const mySchool=currentUser.school;const mySubject=currentUser.subject;const analyticsData=useMemo(()=>{const data={11:{total:0,completed:0},12:{total:0,completed:0}};let totalDays=0;let chaptersWithDates=0;['11','12'].forEach(grade=>{const docId=`${mySchool}_${mySubject}_${grade}`;const chapters=curriculum[docId]?.chapters||[];chapters.forEach(ch=>{data[grade].total++;const progressId=`${mySchool}_${ch.id}`;const prog=chapterProgress[progressId]||{};if(prog.completed==='Yes'&&prog.testConducted==='Yes'){data[grade].completed++;if(prog.completionDate&&ch.targetDate){const target=new Date(ch.targetDate);const completion=new Date(prog.completionDate);const days=Math.abs(Math.ceil((completion-target)/(1000*60*60*24)));totalDays+=days;chaptersWithDates++}}})});const avgDays=chaptersWithDates?Math.round(totalDays/chaptersWithDates):0;return{...data,avgDays}},[curriculum,chapterProgress,mySchool,mySubject]);useEffect(()=>{if(chartRef.current){if(chartInstance.current){chartInstance.current.destroy()}const ctx=chartRef.current.getContext('2d');chartInstance.current=new Chart(ctx,{type:'bar',data:{labels:['Class 11','Class 12'],datasets:[{label:'Completed',data:[analyticsData[11].completed,analyticsData[12].completed],backgroundColor:'#10B981'},{label:'Pending',data:[analyticsData[11].total-analyticsData[11].completed,analyticsData[12].total-analyticsData[12].completed],backgroundColor:'#F59E0B'}]},options:{responsive:true,maintainAspectRatio:false,scales:{x:{stacked:true},y:{stacked:true}}}})}return()=>{if(chartInstance.current){chartInstance.current.destroy()}}},[analyticsData]);const handleExport=()=>{const exportData=[{Grade:'Class 11','Total Chapters':analyticsData[11].total,'Completed':analyticsData[11].completed,'Pending':analyticsData[11].total-analyticsData[11].completed,'Completion %':analyticsData[11].total?Math.round((analyticsData[11].completed/analyticsData[11].total)*100):0},{Grade:'Class 12','Total Chapters':analyticsData[12].total,'Completed':analyticsData[12].completed,'Pending':analyticsData[12].total-analyticsData[12].completed,'Completion %':analyticsData[12].total?Math.round((analyticsData[12].completed/analyticsData[12].total)*100):0}];exportToExcel(exportData,'my_analytics')};return(<div className="space-y-6"><div className="flex justify-between items-center"><h2 className="text-3xl font-bold">My Analytics</h2><button onClick={handleExport} className="px-6 py-3 bg-green-600 text-white rounded-xl font-semibold">📊 Export to Excel</button></div><div className="grid grid-cols-3 gap-4"><div className="stat-card"><div className="text-sm text-gray-600">Avg Days per Chapter</div><div className="text-4xl font-bold">{analyticsData.avgDays}</div></div><div className="stat-card"><div className="text-sm text-gray-600">Class 11 Progress</div><div className="text-4xl font-bold">{analyticsData[11].total?Math.round((analyticsData[11].completed/analyticsData[11].total)*100):0}%</div></div><div className="stat-card"><div className="text-sm text-gray-600">Class 12 Progress</div><div className="text-4xl font-bold">{analyticsData[12].total?Math.round((analyticsData[12].completed/analyticsData[12].total)*100):0}%</div></div></div><div className="bg-white p-6 rounded-2xl shadow-lg" style={{height:'400px'}}><canvas ref={chartRef}></canvas></div></div>)}
function TeacherCurriculum({grade,currentUser,curriculum,chapterProgress,updateChapterProgress}){
  const[expandedChapters,setExpandedChapters]=useState({});
  const mySchool=currentUser.school;
  const mySubject=currentUser.subject;
  const docId=`${mySchool}_${mySubject}_${grade}`;
  const chapters=curriculum[docId]?.chapters||[];

  const handleCompletedChange=(chapterId,value)=>{
    const progressId=`${mySchool}_${chapterId}`;
    const prog=chapterProgress[progressId]||{};
    if(value==='Yes'&&prog.testConducted!=='Yes'){
      alert('⚠️ Please conduct the chapter test before marking as completed!');
      return;
    }
    updateChapterProgress(mySchool,chapterId,'completed',value);
  };

  return(
    <div className="space-y-6">
      <h2 className="text-3xl font-bold">Class {grade} - {mySubject}</h2>
      {chapters.length===0?
        <div className="bg-white p-8 rounded-2xl text-center">
          <p className="text-gray-600">No chapters available. Contact admin.</p>
        </div>
      :
        <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
          {chapters.map(chapter=>{
            const progressId=`${mySchool}_${chapter.id}`;
            const prog=chapterProgress[progressId]||{};
            const completedTopics=prog.completedTopics||[];
            const allTopics=chapter.topics||[];
            const progress=allTopics.length?Math.round((completedTopics.length/allTopics.length)*100):0;
            const isExpanded=expandedChapters[chapter.id];
            const status=getChapterStatus(chapter,prog);

            return(
              <div key={chapter.id} className={`chapter-card ${status.color} rounded-2xl shadow-lg p-5`}>
                <div className="flex justify-between items-start mb-3">
                  <h3 className="text-xl font-bold pr-2">{chapter.name}</h3>
                  <button 
                    onClick={(e)=>{
                      e.preventDefault();
                      e.stopPropagation();
                      setExpandedChapters(prev=>({...prev,[chapter.id]:!prev[chapter.id]}));
                    }} 
                    className="text-sm px-3 py-1 bg-white rounded-lg font-semibold"
                  >
                    {isExpanded?'▲':'▼'}
                  </button>
                </div>

                <div className={`status-badge ${status.class} mb-3`}>{status.label}</div>

                <div className="space-y-3">
                  <div>
                    <div className="flex justify-between text-sm mb-1">
                      <span className="font-semibold">Topics</span>
                      <span className="font-bold">{completedTopics.length}/{allTopics.length}</span>
                    </div>
                    <div className="h-2 bg-gray-200 rounded-full">
                      <div className="h-2 avanti-gradient rounded-full transition-all" style={{width:`${progress}%`}}/>
                    </div>
                  </div>

                  {isExpanded&&(
                    <>
                      <div className="space-y-2 max-h-40 overflow-y-auto bg-white p-2 rounded-lg">
                        {allTopics.map((topic,idx)=>{
                          const checked=completedTopics.includes(topic);
                          return(
                            <label 
  key={idx} 
  className="flex items-center gap-2 cursor-pointer p-2 hover:bg-gray-50 rounded"
  onClick={(e)=>e.stopPropagation()}
>
  <input 
    type="checkbox" 
    checked={checked}
    onClick={(e)=>e.stopPropagation()}
    onChange={(e)=>{
      e.stopPropagation();
      const updated=e.target.checked?[...completedTopics,topic]:completedTopics.filter(t=>t!==topic);
      updateChapterProgress(mySchool,chapter.id,'completedTopics',updated);
    }}
  />
                              <span className={`text-sm ${checked?'line-through text-gray-500':'font-medium'}`}>
                                {topic}
                              </span>
                            </label>
                          );
                        })}
                      </div>

                      <div className="bg-white p-3 rounded-lg">
                        <label className="block text-sm font-bold mb-1">Target Date</label>
                        <div className="text-sm">{chapter.targetDate||'—'}</div>
                      </div>

                      <div className="bg-white p-3 rounded-lg">
                        <label className="block text-sm font-bold mb-1">Completion Date *</label>
                        <input 
  type="date" 
  value={prog.completionDate||''} 
  onClick={(e)=>e.stopPropagation()}
  onChange={(e)=>{
    e.stopPropagation();
    updateChapterProgress(mySchool,chapter.id,'completionDate',e.target.value);
  }}
  className="w-full border-2 px-3 py-2 rounded-lg cursor-pointer"
/>
                      </div>

                      <div className="bg-white p-3 rounded-lg">
                        <label className="block text-sm font-bold mb-1">Test Conducted? *</label>
                        <select 
  value={prog.testConducted||'No'} 
  onClick={(e)=>e.stopPropagation()}
  onChange={(e)=>{
    e.stopPropagation();
    updateChapterProgress(mySchool,chapter.id,'testConducted',e.target.value);
  }}
  className="w-full border-2 px-3 py-2 rounded-lg cursor-pointer"
>
                          <option value="No">No</option>
                          <option value="Yes">Yes</option>
                        </select>
                      </div>

                      <div className="bg-white p-3 rounded-lg">
                        <label className="block text-sm font-bold mb-1">Chapter Completed? *</label>
                        <select 
  value={prog.completed||'No'} 
  onClick={(e)=>e.stopPropagation()}
  onChange={(e)=>{
    e.stopPropagation();
    handleCompletedChange(chapter.id,e.target.value);
  }}
  className="w-full border-2 px-3 py-2 rounded-lg cursor-pointer"
>
                          <option value="No">No</option>
                          <option value="Yes">Yes</option>
                        </select>
                      </div>

                      <div className="bg-white p-3 rounded-lg">
                        <label className="block text-sm font-bold mb-1">Notes</label>
                        <textarea 
  value={prog.notes||''} 
  onClick={(e)=>e.stopPropagation()}
  onChange={(e)=>{
    e.stopPropagation();
    updateChapterProgress(mySchool,chapter.id,'notes',e.target.value);
  }}
  className="w-full border-2 px-3 py-2 rounded-lg cursor-text" 
  rows="2" 
  placeholder="Add notes..."
/>
                      </div>
                    </>
                  )}
                </div>
              </div>
            );
          })}
        </div>
      }
    </div>
  );
}

function BirthdaysPage({teachers}){const todayBirthdays=useMemo(()=>getBirthdays(teachers,'today'),[teachers]);const weekBirthdays=useMemo(()=>getBirthdays(teachers,'week'),[teachers]);const monthBirthdays=useMemo(()=>getBirthdays(teachers,'month'),[teachers]);const todayAnniversaries=useMemo(()=>getAnniversaries(teachers,'today'),[teachers]);const weekAnniversaries=useMemo(()=>getAnniversaries(teachers,'week'),[teachers]);return(<div className="space-y-6"><h2 className="text-3xl font-bold">🎉 Celebrations</h2><div className="grid md:grid-cols-2 gap-6">{todayBirthdays.length>0&&<div className="birthday-card p-6 rounded-2xl"><h3 className="text-2xl font-bold text-white mb-4">🎂 Today's Birthdays</h3>{todayBirthdays.map(t=><div key={t.id} className="bg-white p-4 rounded-lg mb-2"><div className="font-bold text-lg">{t.name}</div><div className="text-sm text-gray-600">{t.school}</div></div>)}</div>}{todayAnniversaries.length>0&&<div className="birthday-card p-6 rounded-2xl"><h3 className="text-2xl font-bold text-white mb-4">🎉 Today's Anniversaries</h3>{todayAnniversaries.map(t=>{const years=new Date().getFullYear()-new Date(t.joiningDate).getFullYear();return(<div key={t.id} className="bg-white p-4 rounded-lg mb-2"><div className="font-bold text-lg">{t.name}</div><div className="text-sm text-gray-600">{years} Years at Avanti</div></div>)})}</div>}</div><div className="grid md:grid-cols-2 gap-6"><div className="bg-white p-6 rounded-2xl shadow-lg"><h3 className="text-xl font-bold mb-4">This Week's Birthdays</h3>{weekBirthdays.length===0?<p className="text-gray-500">No birthdays this week</p>:<div className="space-y-2">{weekBirthdays.map(t=><div key={t.id} className="p-3 bg-gray-50 rounded-lg"><div className="font-semibold">{t.name}</div><div className="text-sm text-gray-600">{new Date(t.dob).toLocaleDateString(undefined,{month:'short',day:'numeric'})}</div></div>)}</div>}</div><div className="bg-white p-6 rounded-2xl shadow-lg"><h3 className="text-xl font-bold mb-4">This Month's Birthdays</h3>{monthBirthdays.length===0?<p className="text-gray-500">No birthdays this month</p>:<div className="space-y-2 max-h-96 overflow-y-auto">{monthBirthdays.map(t=><div key={t.id} className="p-3 bg-gray-50 rounded-lg"><div className="font-semibold">{t.name}</div><div className="text-sm text-gray-600">{new Date(t.dob).toLocaleDateString(undefined,{month:'short',day:'numeric'})}</div></div>)}</div>}</div></div></div>)}

function TeacherManagement({teachers}){const[showModal,setShowModal]=useState(false);const[editingTeacher,setEditingTeacher]=useState(null);const[form,setForm]=useState({name:'',afid:'',email:'',password:'',dob:'',joiningDate:'',subject:'',school:'',phone:''});const openAddModal=()=>{setEditingTeacher(null);setForm({name:'',afid:'',email:'',password:'',dob:'',joiningDate:'',subject:'',school:'',phone:''});setShowModal(true)};const openEditModal=teacher=>{setEditingTeacher(teacher);setForm({...teacher,password:''});setShowModal(true)};const handleSave=async()=>{if(!form.afid||!form.name||!form.email||!form.subject||!form.school){alert('Please fill all required fields (AFID, Name, Email, Subject, School)');return}try{await db.collection('teachers').doc(form.afid).set({afid:form.afid,name:form.name,email:form.email.toLowerCase(),subject:form.subject,school:form.school,dob:form.dob||null,joiningDate:form.joiningDate||null,phone:form.phone||null});if(!editingTeacher&&form.password){alert(`Teacher added!\n\nCREATE FIREBASE AUTH:\n1. Firebase Console → Authentication\n2. Add User\n3. Email: ${form.email}\n4. Password: ${form.password}`)}else{alert('Teacher updated!')}setShowModal(false)}catch(e){alert('Failed: '+e.message)}};const handleDelete=async teacher=>{if(!confirm(`Delete ${teacher.name}?`))return;try{await db.collection('teachers').doc(teacher.afid).delete();alert('Teacher deleted!')}catch(e){alert('Failed: '+e.message)}};return(<div className="space-y-6"><div className="flex justify-between items-center"><h2 className="text-3xl font-bold">Teacher Management</h2><button onClick={openAddModal} className="px-6 py-3 bg-blue-600 text-white rounded-xl font-semibold">+ Add Teacher</button></div><div className="bg-white p-6 rounded-2xl shadow-lg overflow-x-auto"><table className="w-full"><thead className="avanti-gradient-light"><tr><th className="p-3 text-left">AFID</th><th className="p-3 text-left">Name</th><th className="p-3 text-left">Email</th><th className="p-3 text-left">Subject</th><th className="p-3 text-left">School</th><th className="p-3 text-left">Actions</th></tr></thead><tbody>{teachers.map(t=><tr key={t.id} className="border-b hover:bg-gray-50"><td className="p-3 font-mono">{t.afid}</td><td className="p-3">{t.name}</td><td className="p-3 text-sm">{t.email}</td><td className="p-3">{t.subject}</td><td className="p-3">{t.school}</td><td className="p-3"><div className="flex gap-2"><button onClick={()=>openEditModal(t)} className="px-3 py-1 bg-yellow-400 rounded-lg">Edit</button><button onClick={()=>handleDelete(t)} className="px-3 py-1 bg-red-500 text-white rounded-lg">Delete</button></div></td></tr>)}</tbody></table></div>{showModal&&<div className="modal-overlay" onClick={()=>setShowModal(false)}><div className="modal-content" onClick={e=>e.stopPropagation()}><h3 className="text-2xl font-bold mb-4">{editingTeacher?'Edit Teacher':'Add New Teacher'}</h3><div className="space-y-4"><div><label className="block text-sm font-bold mb-1">AFID *</label><input type="text" value={form.afid} onChange={e=>setForm({...form,afid:e.target.value})} disabled={!!editingTeacher} className="w-full border-2 px-3 py-2 rounded-lg"/></div><div><label className="block text-sm font-bold mb-1">Name *</label><input type="text" value={form.name} onChange={e=>setForm({...form,name:e.target.value})} className="w-full border-2 px-3 py-2 rounded-lg"/></div><div><label className="block text-sm font-bold mb-1">Email *</label><input type="email" value={form.email} onChange={e=>setForm({...form,email:e.target.value})} className="w-full border-2 px-3 py-2 rounded-lg"/></div>{!editingTeacher&&<div><label className="block text-sm font-bold mb-1">Password *</label><input type="password" value={form.password} onChange={e=>setForm({...form,password:e.target.value})} className="w-full border-2 px-3 py-2 rounded-lg"/></div>}<div className="grid grid-cols-2 gap-4"><div><label className="block text-sm font-bold mb-1">Subject *</label><select value={form.subject} onChange={e=>setForm({...form,subject:e.target.value})} className="w-full border-2 px-3 py-2 rounded-lg"><option value="">Select</option>{SUBJECTS.map(s=><option key={s} value={s}>{s}</option>)}</select></div><div><label className="block text-sm font-bold mb-1">School *</label><select value={form.school} onChange={e=>setForm({...form,school:e.target.value})} className="w-full border-2 px-3 py-2 rounded-lg"><option value="">Select</option>{SCHOOLS.map(s=><option key={s} value={s}>{s}</option>)}</select></div></div><div className="grid grid-cols-2 gap-4"><div><label className="block text-sm font-bold mb-1">Date of Birth</label><input type="date" value={form.dob} onChange={e=>setForm({...form,dob:e.target.value})} className="w-full border-2 px-3 py-2 rounded-lg"/></div><div><label className="block text-sm font-bold mb-1">Joining Date</label><input type="date" value={form.joiningDate} onChange={e=>setForm({...form,joiningDate:e.target.value})} className="w-full border-2 px-3 py-2 rounded-lg"/></div></div><div><label className="block text-sm font-bold mb-1">Phone</label><input type="text" value={form.phone} onChange={e=>setForm({...form,phone:e.target.value})} className="w-full border-2 px-3 py-2 rounded-lg"/></div><div className="flex gap-3"><button onClick={handleSave} className="flex-1 avanti-gradient text-white py-3 rounded-xl font-semibold">Save</button><button onClick={()=>setShowModal(false)} className="flex-1 bg-gray-300 py-3 rounded-xl font-semibold">Cancel</button></div></div></div></div>}</div>)}

function AdminCurriculum({curriculum,addChapter,updateChapter,deleteChapter}){const[selectedSchool,setSelectedSchool]=useState(SCHOOLS[0]);const[selectedSubject,setSelectedSubject]=useState(SUBJECTS[0]);const[selectedGrade,setSelectedGrade]=useState('11');const[showAddForm,setShowAddForm]=useState(false);const[editingChapter,setEditingChapter]=useState(null);const[chapterForm,setChapterForm]=useState({name:'',topics:[],targetDate:''});const[newTopic,setNewTopic]=useState('');const fileInputRef=useRef(null);const docId=`${selectedSchool}_${selectedSubject}_${selectedGrade}`;const chapters=curriculum[docId]?.chapters||[];const handleSaveChapter=()=>{if(!chapterForm.name){alert('Chapter name is required');return}if(editingChapter){updateChapter(selectedSchool,selectedSubject,selectedGrade,editingChapter.id,chapterForm);setEditingChapter(null)}else{addChapter(selectedSchool,selectedSubject,selectedGrade,chapterForm)}setChapterForm({name:'',topics:[],targetDate:''});setShowAddForm(false)};const handleEditChapter=chapter=>{setEditingChapter(chapter);setChapterForm({name:chapter.name,topics:chapter.topics||[],targetDate:chapter.targetDate||''});setShowAddForm(true)};const handleAddTopic=()=>{if(!newTopic.trim())return;setChapterForm({...chapterForm,topics:[...chapterForm.topics,newTopic.trim()]});setNewTopic('')};const handleCSVImport=e=>{
  const file=e.target.files[0];
  if(!file)return;

  Papa.parse(file,{
    complete:async results=>{
      try{
        const rows=results.data;
        if(rows.length<2){
          alert('CSV file is empty');
          return;
        }

        let currentChapter=null;
        const chaptersToAdd=[];

        rows.forEach((row,index)=>{
          if(index===0)return; // Skip header

          const chapterName=row[0]?row[0].trim():'';
          const topicName=row[1]?row[1].trim():'';
          const targetDate=row[2]?row[2].trim():''; // Column C for target date

          if(chapterName){
            if(currentChapter){
              chaptersToAdd.push(currentChapter);
            }
            currentChapter={
              name:chapterName,
              topics:topicName?[topicName]:[],
              targetDate:targetDate||''
            };
          }else if(topicName&&currentChapter){
            currentChapter.topics.push(topicName);
          }
        });

        if(currentChapter){
          chaptersToAdd.push(currentChapter);
        }

        if(chaptersToAdd.length===0){
          alert('No valid chapters found in CSV');
          return;
        }

        for(const chapter of chaptersToAdd){
          await addChapter(selectedSchool,selectedSubject,selectedGrade,chapter);
        }

        alert(`Imported ${chaptersToAdd.length} chapters with target dates!`);
        if(fileInputRef.current)fileInputRef.current.value='';
      }catch(e){
        alert('Import failed: '+e.message);
      }
    },
    error:()=>alert('Failed to parse CSV')
  });
};return(<div className="space-y-6"><h2 className="text-3xl font-bold">Curriculum Management</h2><div className="bg-white p-6 rounded-2xl shadow-lg"><div className="grid md:grid-cols-3 gap-4 mb-4"><div><label className="block text-sm font-bold mb-2">School</label><select value={selectedSchool} onChange={e=>setSelectedSchool(e.target.value)} className="w-full border-2 px-4 py-3 rounded-xl">{SCHOOLS.map(s=><option key={s} value={s}>{s}</option>)}</select></div><div><label className="block text-sm font-bold mb-2">Subject</label><select value={selectedSubject} onChange={e=>setSelectedSubject(e.target.value)} className="w-full border-2 px-4 py-3 rounded-xl">{SUBJECTS.map(s=><option key={s} value={s}>{s}</option>)}</select></div><div><label className="block text-sm font-bold mb-2">Grade</label><select value={selectedGrade} onChange={e=>setSelectedGrade(e.target.value)} className="w-full border-2 px-4 py-3 rounded-xl"><option value="11">Class 11</option><option value="12">Class 12</option></select></div></div><div className="flex gap-3"><button onClick={()=>{setEditingChapter(null);setChapterForm({name:'',topics:[],targetDate:''});setShowAddForm(!showAddForm)}} className="px-6 py-3 bg-blue-600 text-white rounded-xl font-semibold">{showAddForm?'Cancel':'+ Add Chapter'}</button><label className="px-6 py-3 bg-green-600 text-white rounded-xl font-semibold cursor-pointer">📤 Import CSV<input ref={fileInputRef} type="file" accept=".csv" onChange={handleCSVImport} className="hidden"/></label></div></div>{showAddForm&&<div className="bg-white p-6 rounded-2xl shadow-lg"><h4 className="text-xl font-bold mb-4">{editingChapter?'Edit Chapter':'Add New Chapter'}</h4><div className="space-y-4"><div><label className="block text-sm font-bold mb-2">Chapter Name *</label><input type="text" value={chapterForm.name} onChange={e=>setChapterForm({...chapterForm,name:e.target.value})} className="w-full border-2 px-4 py-3 rounded-xl"/></div><div><label className="block text-sm font-bold mb-2">Target Date</label><input type="date" value={chapterForm.targetDate} onChange={e=>setChapterForm({...chapterForm,targetDate:e.target.value})} className="w-full border-2 px-4 py-3 rounded-xl"/></div><div><label className="block text-sm font-bold mb-2">Topics</label><div className="flex gap-2 mb-3"><input type="text" value={newTopic} onChange={e=>setNewTopic(e.target.value)} onKeyPress={e=>e.key==='Enter'&&handleAddTopic()} className="flex-1 border-2 px-4 py-3 rounded-xl" placeholder="Enter topic"/><button onClick={handleAddTopic} className="px-6 py-3 bg-blue-600 text-white rounded-xl">Add</button></div><div className="space-y-2">{chapterForm.topics.map((topic,idx)=><div key={idx} className="flex justify-between items-center p-3 bg-gray-50 rounded-lg"><span>{topic}</span><button onClick={()=>{const updated=chapterForm.topics.filter((_,i)=>i!==idx);setChapterForm({...chapterForm,topics:updated})}} className="px-3 py-1 bg-red-500 text-white rounded-lg">Remove</button></div>)}</div></div><button onClick={handleSaveChapter} className="px-6 py-3 avanti-gradient text-white rounded-xl font-semibold">{editingChapter?'Update Chapter':'Save Chapter'}</button></div></div>}<div className="bg-white p-6 rounded-2xl shadow-lg"><h4 className="text-xl font-bold mb-4">{selectedSchool} - {selectedSubject} - Class {selectedGrade} ({chapters.length} chapters)</h4>{chapters.length===0?<p className="text-gray-500 text-center py-8">No chapters yet</p>:<div className="space-y-3">{chapters.map(ch=><div key={ch.id} className="border-2 rounded-xl p-4 hover:bg-gray-50"><div className="flex justify-between items-start"><div className="flex-1"><h5 className="font-bold text-lg">{ch.name}</h5><p className="text-sm text-gray-600">Target: {ch.targetDate||'Not set'} | Topics: {ch.topics?.length||0}</p>{ch.topics&&ch.topics.length>0&&<ul className="text-xs text-gray-600 ml-4 mt-2">{ch.topics.map((t,i)=><li key={i}>• {t}</li>)}</ul>}</div><div className="flex gap-2"><button onClick={()=>handleEditChapter(ch)} className="px-3 py-1 bg-yellow-400 rounded-lg">Edit</button><button onClick={()=>deleteChapter(selectedSchool,selectedSubject,selectedGrade,ch.id)} className="px-3 py-1 bg-red-500 text-white rounded-lg">Delete</button></div></div></div>)}</div>}</div></div>)}
function AdminAnalytics({teachers,curriculum,chapterProgress}){
  const[filterSchool,setFilterSchool]=useState('All');
  const[filterGrade,setFilterGrade]=useState('All');
  const[filterTeacher,setFilterTeacher]=useState('All');

  const chart1Ref=useRef(null);
  const chart2Ref=useRef(null);
  const chart3Ref=useRef(null);
  const chart4Ref=useRef(null);
  const chart5Ref=useRef(null);
  const chart6Ref=useRef(null);
  const chart7Ref=useRef(null);
  const chart8Ref=useRef(null);

  const chartInstances=useRef({});

  const filteredData=useMemo(()=>{
    const data={
      totalChapters:0,
      completedChapters:0,
      delayedChapters:0,
      aheadChapters:0,
      testsCompleted:0,
      testsPending:0,
      schoolData:{},
      subjectData:{},
      gradeData:{},
      teacherData:{},
      statusData:{ahead:0,ontrack:0,delayed:0,pending:0}
    };

    const schoolsToProcess=filterSchool==='All'?SCHOOLS:[filterSchool];
    const gradesToProcess=filterGrade==='All'?['11','12']:[filterGrade];
    const teachersFiltered=filterTeacher==='All'?teachers:teachers.filter(t=>t.afid===filterTeacher);

    schoolsToProcess.forEach(school=>{
      if(!data.schoolData[school]){
        data.schoolData[school]={total:0,completed:0,delayed:0,ahead:0,tests:0};
      }

      SUBJECTS.forEach(subject=>{
        if(!data.subjectData[subject]){
          data.subjectData[subject]={total:0,completed:0};
        }

        gradesToProcess.forEach(grade=>{
          if(!data.gradeData[grade]){
            data.gradeData[grade]={total:0,completed:0};
          }

          const docId=`${school}_${subject}_${grade}`;
          const chapters=curriculum[docId]?.chapters||[];

          const relevantTeachers=teachersFiltered.filter(t=>t.school===school&&t.subject===subject);
          if(filterTeacher!=='All'&&relevantTeachers.length===0)return;

          chapters.forEach(ch=>{
            data.totalChapters++;
            data.schoolData[school].total++;
            data.subjectData[subject].total++;
            data.gradeData[grade].total++;

            const progressId=`${school}_${ch.id}`;
            const prog=chapterProgress[progressId]||{};
            const status=getChapterStatus(ch,prog);

            if(prog.completed==='Yes'&&prog.testConducted==='Yes'){
              data.completedChapters++;
              data.schoolData[school].completed++;
              data.subjectData[subject].completed++;
              data.gradeData[grade].completed++;

              if(status.class==='status-ahead'){
                data.aheadChapters++;
                data.schoolData[school].ahead++;
                data.statusData.ahead++;
              }else if(status.class==='status-ontrack'){
                data.statusData.ontrack++;
              }
            }

            if(prog.testConducted==='Yes'){
              data.testsCompleted++;
              data.schoolData[school].tests++;
            }else if(prog.completed==='Yes'){
              data.testsPending++;
            }

            if(status.label.includes('Delayed')){
              data.delayedChapters++;
              data.schoolData[school].delayed++;
              data.statusData.delayed++;
            }

            if(status.label==='Pending'){
              data.statusData.pending++;
            }
          });
        });
      });
    });

    teachersFiltered.forEach(teacher=>{
      if(!data.teacherData[teacher.afid]){
        data.teacherData[teacher.afid]={name:teacher.name,total:0,completed:0};
      }
    });

    return data;
  },[curriculum,chapterProgress,teachers,filterSchool,filterGrade,filterTeacher]);

  useEffect(()=>{
    Object.values(chartInstances.current).forEach(chart=>{
      if(chart)chart.destroy();
    });
    chartInstances.current={};

    // Chart 1: School Completion Rate (Bar)
    if(chart1Ref.current){
      const ctx=chart1Ref.current.getContext('2d');
      const schools=Object.keys(filteredData.schoolData);
      chartInstances.current.chart1=new Chart(ctx,{
        type:'bar',
        data:{
          labels:schools,
          datasets:[{
            label:'Completion %',
            data:schools.map(s=>{
              const d=filteredData.schoolData[s];
              return d.total?Math.round((d.completed/d.total)*100):0;
            }),
            backgroundColor:'#C8342E',
            borderRadius:8
          }]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            title:{display:true,text:'School-wise Completion %',font:{size:16,weight:'bold'}},
            legend:{display:false}
          },
          scales:{y:{beginAtZero:true,max:100,ticks:{callback:v=>v+'%'}}}
        }
      });
    }

    // Chart 2: Subject Distribution (Pie)
    if(chart2Ref.current){
      const ctx=chart2Ref.current.getContext('2d');
      const subjects=Object.keys(filteredData.subjectData);
      chartInstances.current.chart2=new Chart(ctx,{
        type:'pie',
        data:{
          labels:subjects,
          datasets:[{
            data:subjects.map(s=>filteredData.subjectData[s].completed),
            backgroundColor:['#F4B41A','#3B82F6','#10B981','#EF4444'],
            borderWidth:2
          }]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            title:{display:true,text:'Completed Chapters by Subject',font:{size:16,weight:'bold'}},
            legend:{position:'bottom'}
          }
        }
      });
    }

    // Chart 3: Grade Comparison (Bar)
    if(chart3Ref.current){
      const ctx=chart3Ref.current.getContext('2d');
      const grades=Object.keys(filteredData.gradeData);
      chartInstances.current.chart3=new Chart(ctx,{
        type:'bar',
        data:{
          labels:grades.map(g=>`Class ${g}`),
          datasets:[
            {
              label:'Completed',
              data:grades.map(g=>filteredData.gradeData[g].completed),
              backgroundColor:'#10B981'
            },
            {
              label:'Pending',
              data:grades.map(g=>filteredData.gradeData[g].total-filteredData.gradeData[g].completed),
              backgroundColor:'#F59E0B'
            }
          ]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            title:{display:true,text:'Grade-wise Progress',font:{size:16,weight:'bold'}},
            legend:{position:'bottom'}
          },
          scales:{x:{stacked:true},y:{stacked:true,beginAtZero:true}}
        }
      });
    }

    // Chart 4: Overall Status (Doughnut)
    if(chart4Ref.current){
      const ctx=chart4Ref.current.getContext('2d');
      chartInstances.current.chart4=new Chart(ctx,{
        type:'doughnut',
        data:{
          labels:['Completed','Pending','Delayed'],
          datasets:[{
            data:[
              filteredData.completedChapters,
              filteredData.totalChapters-filteredData.completedChapters-filteredData.delayedChapters,
              filteredData.delayedChapters
            ],
            backgroundColor:['#10B981','#F59E0B','#EF4444'],
            borderWidth:0
          }]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            title:{display:true,text:'Overall Chapter Status',font:{size:16,weight:'bold'}},
            legend:{position:'bottom'}
          }
        }
      });
    }

    // Chart 5: Tests Status (Pie)
    if(chart5Ref.current){
      const ctx=chart5Ref.current.getContext('2d');
      chartInstances.current.chart5=new Chart(ctx,{
        type:'pie',
        data:{
          labels:['Tests Completed','Tests Pending'],
          datasets:[{
            data:[filteredData.testsCompleted,filteredData.testsPending],
            backgroundColor:['#3B82F6','#F97316'],
            borderWidth:2
          }]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            title:{display:true,text:'Chapter Tests Status',font:{size:16,weight:'bold'}},
            legend:{position:'bottom'}
          }
        }
      });
    }

    // Chart 6: Performance Status (Bar)
    if(chart6Ref.current){
      const ctx=chart6Ref.current.getContext('2d');
      chartInstances.current.chart6=new Chart(ctx,{
        type:'bar',
        data:{
          labels:['Ahead','On Track','Delayed','Pending'],
          datasets:[{
            label:'Chapters',
            data:[
              filteredData.statusData.ahead,
              filteredData.statusData.ontrack,
              filteredData.statusData.delayed,
              filteredData.statusData.pending
            ],
            backgroundColor:['#10B981','#3B82F6','#F97316','#EF4444'],
            borderRadius:8
          }]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            title:{display:true,text:'Performance Status Distribution',font:{size:16,weight:'bold'}},
            legend:{display:false}
          },
          scales:{y:{beginAtZero:true}}
        }
      });
    }

    // Chart 7: School Delayed Chapters (Horizontal Bar)
    if(chart7Ref.current){
      const ctx=chart7Ref.current.getContext('2d');
      const schools=Object.keys(filteredData.schoolData);
      chartInstances.current.chart7=new Chart(ctx,{
        type:'bar',
        data:{
          labels:schools,
          datasets:[{
            label:'Delayed Chapters',
            data:schools.map(s=>filteredData.schoolData[s].delayed),
            backgroundColor:'#EF4444',
            borderRadius:6
          }]
        },
        options:{
          indexAxis:'y',
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            title:{display:true,text:'Delayed Chapters by School',font:{size:16,weight:'bold'}},
            legend:{display:false}
          },
          scales:{x:{beginAtZero:true}}
        }
      });
    }

    // Chart 8: Subject Completion Rate (Doughnut)
    if(chart8Ref.current){
      const ctx=chart8Ref.current.getContext('2d');
      const subjects=Object.keys(filteredData.subjectData);
      chartInstances.current.chart8=new Chart(ctx,{
        type:'doughnut',
        data:{
          labels:subjects.map(s=>`${s} - ${filteredData.subjectData[s].total?Math.round((filteredData.subjectData[s].completed/filteredData.subjectData[s].total)*100):0}%`),
          datasets:[{
            data:subjects.map(s=>filteredData.subjectData[s].completed),
            backgroundColor:['#F4B41A','#3B82F6','#10B981','#EF4444'],
            borderWidth:2
          }]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            title:{display:true,text:'Subject-wise Completion Rate',font:{size:16,weight:'bold'}},
            legend:{position:'bottom'}
          }
        }
      });
    }

    return()=>{
      Object.values(chartInstances.current).forEach(chart=>{
        if(chart)chart.destroy();
      });
    };
  },[filteredData]);

  const handleExport=()=>{
    const exportData=Object.keys(filteredData.schoolData).map(school=>({
      School:school,
      'Total Chapters':filteredData.schoolData[school].total,
      'Completed':filteredData.schoolData[school].completed,
      'Delayed':filteredData.schoolData[school].delayed,
      'Ahead':filteredData.schoolData[school].ahead,
      'Tests Completed':filteredData.schoolData[school].tests,
      'Completion %':filteredData.schoolData[school].total?Math.round((filteredData.schoolData[school].completed/filteredData.schoolData[school].total)*100):0
    }));
    exportToExcel(exportData,'admin_analytics_filtered');
  };

  return(
    <div className="space-y-6">
      <div className="flex justify-between items-center">
        <h2 className="text-3xl font-bold">📊 Analytics Dashboard</h2>
        <button onClick={handleExport} className="px-6 py-3 bg-green-600 text-white rounded-xl font-semibold">
          📥 Export Filtered Data
        </button>
      </div>

      <div className="bg-white p-6 rounded-2xl shadow-lg">
        <h3 className="text-xl font-bold mb-4">🔍 Filters (Apply to All Charts)</h3>
        <div className="grid md:grid-cols-3 gap-4">
          <div>
            <label className="block text-sm font-bold mb-2">School</label>
            <select 
              value={filterSchool} 
              onChange={e=>setFilterSchool(e.target.value)}
              className="w-full border-2 px-4 py-3 rounded-xl"
            >
              <option value="All">All Schools</option>
              {SCHOOLS.map(s=><option key={s} value={s}>{s}</option>)}
            </select>
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">Grade</label>
            <select 
              value={filterGrade} 
              onChange={e=>setFilterGrade(e.target.value)}
              className="w-full border-2 px-4 py-3 rounded-xl"
            >
              <option value="All">All Grades</option>
              <option value="11">Class 11</option>
              <option value="12">Class 12</option>
            </select>
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">Teacher</label>
            <select 
              value={filterTeacher} 
              onChange={e=>setFilterTeacher(e.target.value)}
              className="w-full border-2 px-4 py-3 rounded-xl"
            >
              <option value="All">All Teachers</option>
              {teachers.map(t=><option key={t.afid} value={t.afid}>{t.name} ({t.afid})</option>)}
            </select>
          </div>
        </div>
      </div>

      <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div className="stat-card avanti-gradient text-white">
          <div className="text-sm opacity-90">Total Chapters</div>
          <div className="text-4xl font-bold">{filteredData.totalChapters}</div>
        </div>
        <div className="stat-card bg-green-500 text-white">
          <div className="text-sm opacity-90">Completed</div>
          <div className="text-4xl font-bold">{filteredData.completedChapters}</div>
        </div>
        <div className="stat-card bg-blue-500 text-white">
          <div className="text-sm opacity-90">Ahead Schedule</div>
          <div className="text-4xl font-bold">{filteredData.aheadChapters}</div>
        </div>
        <div className="stat-card bg-orange-500 text-white">
          <div className="text-sm opacity-90">Delayed</div>
          <div className="text-4xl font-bold">{filteredData.delayedChapters}</div>
        </div>
      </div>

      <div className="grid md:grid-cols-2 lg:grid-cols-2 gap-6">
        <div className="bg-white p-6 rounded-2xl shadow-lg" style={{height:'350px'}}>
          <canvas ref={chart1Ref}></canvas>
        </div>
        <div className="bg-white p-6 rounded-2xl shadow-lg" style={{height:'350px'}}>
          <canvas ref={chart2Ref}></canvas>
        </div>
        <div className="bg-white p-6 rounded-2xl shadow-lg" style={{height:'350px'}}>
          <canvas ref={chart3Ref}></canvas>
        </div>
        <div className="bg-white p-6 rounded-2xl shadow-lg" style={{height:'350px'}}>
          <canvas ref={chart4Ref}></canvas>
        </div>
        <div className="bg-white p-6 rounded-2xl shadow-lg" style={{height:'350px'}}>
          <canvas ref={chart5Ref}></canvas>
        </div>
        <div className="bg-white p-6 rounded-2xl shadow-lg" style={{height:'350px'}}>
          <canvas ref={chart6Ref}></canvas>
        </div>
        <div className="bg-white p-6 rounded-2xl shadow-lg" style={{height:'350px'}}>
          <canvas ref={chart7Ref}></canvas>
        </div>
        <div className="bg-white p-6 rounded-2xl shadow-lg" style={{height:'350px'}}>
          <canvas ref={chart8Ref}></canvas>
        </div>
      </div>
    </div>
  );
}

function AdminChapterDetails({curriculum,chapterProgress}){const[filterSchool,setFilterSchool]=useState('All');const[filterSubject,setFilterSubject]=useState('All');const[filterGrade,setFilterGrade]=useState('All');const chapterDetails=useMemo(()=>{const details=[];const schoolsToProcess=filterSchool==='All'?SCHOOLS:[filterSchool];const subjectsToProcess=filterSubject==='All'?SUBJECTS:[filterSubject];const gradesToProcess=filterGrade==='All'?['11','12']:[filterGrade];schoolsToProcess.forEach(school=>{subjectsToProcess.forEach(subject=>{gradesToProcess.forEach(grade=>{const docId=`${school}_${subject}_${grade}`;const chapters=curriculum[docId]?.chapters||[];chapters.forEach(ch=>{const progressId=`${school}_${ch.id}`;const prog=chapterProgress[progressId]||{};details.push({school,subject,grade:`Class ${grade}`,chapterName:ch.name,targetDate:ch.targetDate||'—',completed:prog.completed||'No',completionDate:prog.completionDate||'—',testConducted:prog.testConducted||'No',notes:prog.notes||'—'})})})})});return details},[curriculum,chapterProgress,filterSchool,filterSubject,filterGrade]);const handleExport=()=>{exportToExcel(chapterDetails,'chapter_details')};return(<div className="space-y-6"><div className="flex justify-between items-center"><h2 className="text-3xl font-bold">Chapter Details</h2><button onClick={handleExport} className="px-6 py-3 bg-green-600 text-white rounded-xl font-semibold">📊 Export to Excel</button></div><div className="bg-white p-6 rounded-2xl shadow-lg"><h3 className="font-bold mb-4">Filters</h3><div className="grid md:grid-cols-3 gap-4"><div><label className="block text-sm font-bold mb-2">School</label><select value={filterSchool} onChange={e=>setFilterSchool(e.target.value)} className="w-full border-2 px-4 py-3 rounded-xl"><option value="All">All Schools</option>{SCHOOLS.map(s=><option key={s} value={s}>{s}</option>)}</select></div><div><label className="block text-sm font-bold mb-2">Subject</label><select value={filterSubject} onChange={e=>setFilterSubject(e.target.value)} className="w-full border-2 px-4 py-3 rounded-xl"><option value="All">All Subjects</option>{SUBJECTS.map(s=><option key={s} value={s}>{s}</option>)}</select></div><div><label className="block text-sm font-bold mb-2">Grade</label><select value={filterGrade} onChange={e=>setFilterGrade(e.target.value)} className="w-full border-2 px-4 py-3 rounded-xl"><option value="All">All Grades</option><option value="11">Class 11</option><option value="12">Class 12</option></select></div></div></div><div className="bg-white p-6 rounded-2xl shadow-lg overflow-x-auto"><h3 className="font-bold mb-4">All Chapters ({chapterDetails.length})</h3><table className="w-full"><thead className="avanti-gradient-light"><tr><th className="p-3 text-left">School</th><th className="p-3 text-left">Subject</th><th className="p-3 text-left">Grade</th><th className="p-3 text-left">Chapter Name</th><th className="p-3 text-left">Target Date</th><th className="p-3 text-left">Completed</th><th className="p-3 text-left">Completion Date</th><th className="p-3 text-left">Test Conducted</th><th className="p-3 text-left">Notes</th></tr></thead><tbody>{chapterDetails.length===0?<tr><td colSpan="9" className="p-8 text-center text-gray-500">No chapters found</td></tr>:chapterDetails.map((ch,idx)=><tr key={idx} className="border-b hover:bg-gray-50"><td className="p-3">{ch.school}</td><td className="p-3">{ch.subject}</td><td className="p-3">{ch.grade}</td><td className="p-3 font-semibold">{ch.chapterName}</td><td className="p-3 text-sm">{ch.targetDate}</td><td className="p-3"><span className={`px-2 py-1 rounded-full text-xs font-bold ${ch.completed==='Yes'?'bg-green-100 text-green-700':'bg-gray-100'}`}>{ch.completed}</span></td><td className="p-3 text-sm">{ch.completionDate}</td><td className="p-3"><span className={`px-2 py-1 rounded-full text-xs font-bold ${ch.testConducted==='Yes'?'bg-blue-100 text-blue-700':'bg-orange-100 text-orange-700'}`}>{ch.testConducted}</span></td><td className="p-3 text-sm">{ch.notes}</td></tr>)}</tbody></table></div></div>)}

function AdminBirthdays({teachers}){const todayBirthdays=useMemo(()=>getBirthdays(teachers,'today'),[teachers]);const weekBirthdays=useMemo(()=>getBirthdays(teachers,'week'),[teachers]);const monthBirthdays=useMemo(()=>getBirthdays(teachers,'month'),[teachers]);const todayAnniversaries=useMemo(()=>getAnniversaries(teachers,'today'),[teachers]);const weekAnniversaries=useMemo(()=>getAnniversaries(teachers,'week'),[teachers]);const monthAnniversaries=useMemo(()=>getAnniversaries(teachers,'month'),[teachers]);return(<div className="space-y-6"><h2 className="text-3xl font-bold">🎉 Celebrations</h2><div className="grid md:grid-cols-2 gap-6">{todayBirthdays.length>0&&<div className="birthday-card p-6 rounded-2xl"><h3 className="text-2xl font-bold text-white mb-4">🎂 Today's Birthdays</h3>{todayBirthdays.map(t=><div key={t.id} className="bg-white p-4 rounded-lg mb-2"><div className="font-bold text-lg">{t.name}</div><div className="text-sm text-gray-600">{t.school} - {t.subject}</div></div>)}</div>}{todayAnniversaries.length>0&&<div className="birthday-card p-6 rounded-2xl"><h3 className="text-2xl font-bold text-white mb-4">🎉 Today's Work Anniversaries</h3>{todayAnniversaries.map(t=>{const years=new Date().getFullYear()-new Date(t.joiningDate).getFullYear();return(<div key={t.id} className="bg-white p-4 rounded-lg mb-2"><div className="font-bold text-lg">{t.name}</div><div className="text-sm text-gray-600">{years} Years - {t.school}</div></div>)})}</div>}</div><div className="grid md:grid-cols-3 gap-6"><div className="bg-white p-6 rounded-2xl shadow-lg"><h3 className="text-xl font-bold mb-4">This Week</h3>{weekBirthdays.length===0&&weekAnniversaries.length===0?<p className="text-gray-500">No celebrations</p>:<div className="space-y-2">{weekBirthdays.map(t=><div key={t.id} className="p-3 bg-blue-50 rounded-lg"><div className="font-semibold">🎂 {t.name}</div><div className="text-sm text-gray-600">{new Date(t.dob).toLocaleDateString(undefined,{month:'short',day:'numeric'})}</div></div>)}{weekAnniversaries.map(t=><div key={t.id} className="p-3 bg-green-50 rounded-lg"><div className="font-semibold">🎉 {t.name}</div><div className="text-sm text-gray-600">Work Anniversary</div></div>)}</div>}</div><div className="bg-white p-6 rounded-2xl shadow-lg"><h3 className="text-xl font-bold mb-4">This Month - Birthdays</h3>{monthBirthdays.length===0?<p className="text-gray-500">No birthdays</p>:<div className="space-y-2 max-h-96 overflow-y-auto">{monthBirthdays.map(t=><div key={t.id} className="p-3 bg-gray-50 rounded-lg"><div className="font-semibold">{t.name}</div><div className="text-sm text-gray-600">{new Date(t.dob).toLocaleDateString(undefined,{month:'short',day:'numeric'})}</div></div>)}</div>}</div><div className="bg-white p-6 rounded-2xl shadow-lg"><h3 className="text-xl font-bold mb-4">This Month - Anniversaries</h3>{monthAnniversaries.length===0?<p className="text-gray-500">No anniversaries</p>:<div className="space-y-2 max-h-96 overflow-y-auto">{monthAnniversaries.map(t=>{const years=new Date().getFullYear()-new Date(t.joiningDate).getFullYear();return(<div key={t.id} className="p-3 bg-gray-50 rounded-lg"><div className="font-semibold">{t.name}</div><div className="text-sm text-gray-600">{years} Years</div></div>)})}</div>}</div></div></div>)}

// ========================================
// STUDENT MANAGEMENT COMPONENT
// ========================================
function StudentManagement({students}){
  const[showModal,setShowModal]=useState(false);
  const[editingStudent,setEditingStudent]=useState(null);
  const[form,setForm]=useState({school:'',grade:'',name:'',gender:''});
  const[selectedStudents,setSelectedStudents]=useState([]);
  const[filterSchool,setFilterSchool]=useState('All');
  const[filterGrade,setFilterGrade]=useState('All');
  const[selectAll,setSelectAll]=useState(false);
  const fileInputRef=useRef(null);

  const filteredStudents=students.filter(s=>{
    if(filterSchool!=='All'&&s.school!==filterSchool)return false;
    if(filterGrade!=='All'&&s.grade!==filterGrade)return false;
    return true;
  });

  const handleSave=async()=>{
    if(!form.school||!form.grade||!form.name||!form.gender){
      alert('Please fill all fields');
      return;
    }
    try{
      if(editingStudent){
        await db.collection('students').doc(editingStudent.id).update({
          school:form.school,
          grade:form.grade,
          name:form.name,
          gender:form.gender,
          updatedAt:new Date().toISOString()
        });
        alert('Student updated!');
      }else{
        await db.collection('students').add({
          school:form.school,
          grade:form.grade,
          name:form.name,
          gender:form.gender,
          createdAt:new Date().toISOString()
        });
        alert('Student added!');
      }
      setShowModal(false);
      setEditingStudent(null);
      setForm({school:'',grade:'',name:'',gender:''});
    }catch(e){
      alert('Failed: '+e.message);
    }
  };
  const openAddModal=()=>{
    setEditingStudent(null);
    setForm({school:'',grade:'',name:'',gender:''});
    setShowModal(true);
  };

  const openEditModal=(student)=>{
    setEditingStudent(student);
    setForm({
      school:student.school,
      grade:student.grade,
      name:student.name,
      gender:student.gender
    });
    setShowModal(true);
  };

  const handleSelectAll=()=>{
    if(selectAll){
      setSelectedStudents([]);
      setSelectAll(false);
    }else{
      setSelectedStudents(filteredStudents.map(s=>s.id));
      setSelectAll(true);
    }
  };

  const handleSelectStudent=(studentId)=>{
    if(selectedStudents.includes(studentId)){
      setSelectedStudents(selectedStudents.filter(id=>id!==studentId));
    }else{
      setSelectedStudents([...selectedStudents,studentId]);
    }
  };

  const handleBulkDelete=async()=>{
    if(selectedStudents.length===0){
      alert('Please select students to delete');
      return;
    }
    if(!confirm(`Delete ${selectedStudents.length} selected students?`))return;
    
    try{
      const batch=db.batch();
      selectedStudents.forEach(id=>{
        batch.delete(db.collection('students').doc(id));
      });
      await batch.commit();
      alert(`${selectedStudents.length} students deleted!`);
      setSelectedStudents([]);
      setSelectAll(false);
    }catch(e){
      alert('Failed: '+e.message);
    }
  };

  const handleBulkUpdateSchool=async()=>{
    if(selectedStudents.length===0){
      alert('Please select students first');
      return;
    }
    const newSchool=prompt('Enter new school name:');
    if(!newSchool||!SCHOOLS.includes(newSchool)){
      alert('Invalid school name');
      return;
    }
    if(!confirm(`Update school to "${newSchool}" for ${selectedStudents.length} students?`))return;

    try{
      const batch=db.batch();
      selectedStudents.forEach(id=>{
        batch.update(db.collection('students').doc(id),{school:newSchool,updatedAt:new Date().toISOString()});
      });
      await batch.commit();
      alert(`${selectedStudents.length} students updated!`);
      setSelectedStudents([]);
      setSelectAll(false);
    }catch(e){
      alert('Failed: '+e.message);
    }
  };

  const handleBulkUpdateGrade=async()=>{
    if(selectedStudents.length===0){
      alert('Please select students first');
      return;
    }
    const newGrade=prompt('Enter new grade (11 or 12):');
    if(!newGrade||!['11','12'].includes(newGrade)){
      alert('Invalid grade. Must be 11 or 12');
      return;
    }
    if(!confirm(`Update grade to "${newGrade}" for ${selectedStudents.length} students?`))return;

    try{
      const batch=db.batch();
      selectedStudents.forEach(id=>{
        batch.update(db.collection('students').doc(id),{grade:newGrade,updatedAt:new Date().toISOString()});
      });
      await batch.commit();
      alert(`${selectedStudents.length} students updated!`);
      setSelectedStudents([]);
      setSelectAll(false);
    }catch(e){
      alert('Failed: '+e.message);
    }
  };

  const handleCSVImport=e=>{
    const file=e.target.files[0];
    if(!file)return;

    Papa.parse(file,{
      complete:async results=>{
        try{
          const rows=results.data;
          if(rows.length<2){
            alert('CSV file is empty');
            return;
          }

          let imported=0;
          for(let i=1;i<rows.length;i++){
            const row=rows[i];
            const school=row[0]?row[0].trim():'';
            const grade=row[1]?row[1].trim():'';
            const name=row[2]?row[2].trim():'';
            const gender=row[3]?row[3].trim():'';

            if(school&&grade&&name&&gender){
              await db.collection('students').add({
                school,
                grade,
                name,
                gender,
                createdAt:new Date().toISOString()
              });
              imported++;
            }
          }

          alert(`Imported ${imported} students!`);
          if(fileInputRef.current)fileInputRef.current.value='';
        }catch(e){
          alert('Import failed: '+e.message);
        }
      },
      error:()=>alert('Failed to parse CSV')
    });
  };

  const handleDelete=async student=>{
    if(!confirm(`Delete ${student.name}?`))return;
    try{
      await db.collection('students').doc(student.id).delete();
      alert('Student deleted!');
    }catch(e){
      alert('Failed: '+e.message);
    }
  };

  const handleExport=()=>{
    const exportData=students.map(s=>({
      School:s.school,
      Grade:s.grade,
      Name:s.name,
      Gender:s.gender
    }));
    exportToExcel(exportData,'students_list');
  };

  return(
    <div className="space-y-6">
      <div className="flex justify-between items-center">
        <h2 className="text-3xl font-bold">Student Management</h2>
        <div className="flex gap-3">
          <button onClick={openAddModal} className="px-6 py-3 bg-blue-600 text-white rounded-xl font-semibold">
            + Add Student
          </button>
          <label className="px-6 py-3 bg-green-600 text-white rounded-xl font-semibold cursor-pointer">
            📤 Import CSV
            <input ref={fileInputRef} type="file" accept=".csv" onChange={handleCSVImport} className="hidden"/>
          </label>
          <button onClick={handleExport} className="px-6 py-3 bg-purple-600 text-white rounded-xl font-semibold">
            📥 Export
          </button>
        </div>
      </div>

      {selectedStudents.length>0&&(
        <div className="bg-blue-50 border-2 border-blue-300 p-4 rounded-xl">
          <div className="flex justify-between items-center">
            <div className="font-bold text-blue-800">
              {selectedStudents.length} student(s) selected
            </div>
            <div className="flex gap-2">
              <button onClick={handleBulkUpdateSchool} className="px-4 py-2 bg-blue-600 text-white rounded-lg font-semibold">
                🏫 Change School
              </button>
              <button onClick={handleBulkUpdateGrade} className="px-4 py-2 bg-green-600 text-white rounded-lg font-semibold">
                📚 Change Grade
              </button>
              <button onClick={handleBulkDelete} className="px-4 py-2 bg-red-600 text-white rounded-lg font-semibold">
                🗑️ Delete Selected
              </button>
              <button onClick={()=>{setSelectedStudents([]);setSelectAll(false)}} className="px-4 py-2 bg-gray-400 text-white rounded-lg font-semibold">
                Cancel
              </button>
            </div>
          </div>
        </div>
      )}

      <div className="bg-white p-6 rounded-2xl shadow-lg">
        <h3 className="text-xl font-bold mb-4">🔍 Filters</h3>
        <div className="grid md:grid-cols-2 gap-4">
          <div>
            <label className="block text-sm font-bold mb-2">School</label>
            <select value={filterSchool} onChange={e=>{setFilterSchool(e.target.value);setSelectedStudents([]);setSelectAll(false)}} className="w-full border-2 px-4 py-3 rounded-xl">
              <option value="All">All Schools</option>
              {SCHOOLS.map(s=><option key={s} value={s}>{s}</option>)}
            </select>
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">Grade</label>
            <select value={filterGrade} onChange={e=>{setFilterGrade(e.target.value);setSelectedStudents([]);setSelectAll(false)}} className="w-full border-2 px-4 py-3 rounded-xl">
              <option value="All">All Grades</option>
              <option value="11">Class 11</option>
              <option value="12">Class 12</option>
            </select>
          </div>
        </div>
      </div>

      <div className="bg-white p-4 rounded-xl border-2 border-gray-200">
        <p className="text-sm text-gray-600">
          <strong>CSV Format:</strong> School, Grade, Student Name, Gender
          <br/>
          <strong>Example:</strong> CoE Barwani, 11, Raj Kumar, Male
        </p>
      </div>

      <div className="bg-white p-6 rounded-2xl shadow-lg overflow-x-auto">
        <h3 className="font-bold mb-4">
          Showing {filteredStudents.length} of {students.length} Students
        </h3>
        <table className="w-full">
          <thead className="avanti-gradient-light">
            <tr>
              <th className="p-3">
                <input 
                  type="checkbox" 
                  checked={selectAll&&filteredStudents.length>0} 
                  onChange={handleSelectAll}
                  className="cursor-pointer"
                />
              </th>
              <th className="p-3 text-left">School</th>
              <th className="p-3 text-left">Grade</th>
              <th className="p-3 text-left">Name</th>
              <th className="p-3 text-left">Gender</th>
              <th className="p-3 text-left">Actions</th>
            </tr>
          </thead>
          <tbody>
            {filteredStudents.length===0?(
              <tr>
                <td colSpan="6" className="p-8 text-center text-gray-500">
                  No students found
                </td>
              </tr>
            ):(
              filteredStudents.map(s=>
                <tr key={s.id} className={`border-b hover:bg-gray-50 ${selectedStudents.includes(s.id)?'bg-blue-50':''}`}>
                  <td className="p-3">
                    <input 
                      type="checkbox" 
                      checked={selectedStudents.includes(s.id)}
                      onChange={()=>handleSelectStudent(s.id)}
                      className="cursor-pointer"
                    />
                  </td>
                  <td className="p-3">{s.school}</td>
                  <td className="p-3">Class {s.grade}</td>
                  <td className="p-3 font-semibold">{s.name}</td>
                  <td className="p-3">{s.gender}</td>
                  <td className="p-3">
                    <div className="flex gap-2">
                      <button onClick={()=>openEditModal(s)} className="px-3 py-1 bg-yellow-400 rounded-lg font-semibold">
                        Edit
                      </button>
                      <button onClick={()=>handleDelete(s)} className="px-3 py-1 bg-red-500 text-white rounded-lg font-semibold">
                        Delete
                      </button>
                    </div>
                  </td>
                </tr>
              )
            )}
          </tbody>
        </table>
      </div>

      {showModal&&(
        <div className="modal-overlay" onClick={()=>{setShowModal(false);setEditingStudent(null)}}>
          <div className="modal-content" onClick={e=>e.stopPropagation()}>
            <h3 className="text-2xl font-bold mb-4">{editingStudent?'Edit Student':'Add New Student'}</h3>
            <div className="space-y-4">
              <div>
                <label className="block text-sm font-bold mb-1">School *</label>
                <select value={form.school} onChange={e=>setForm({...form,school:e.target.value})} className="w-full border-2 px-3 py-2 rounded-lg">
                  <option value="">Select</option>
                  {SCHOOLS.map(s=><option key={s} value={s}>{s}</option>)}
                </select>
              </div>
              <div>
                <label className="block text-sm font-bold mb-1">Grade *</label>
                <select value={form.grade} onChange={e=>setForm({...form,grade:e.target.value})} className="w-full border-2 px-3 py-2 rounded-lg">
                  <option value="">Select</option>
                  <option value="11">Class 11</option>
                  <option value="12">Class 12</option>
                </select>
              </div>
              <div>
                <label className="block text-sm font-bold mb-1">Name *</label>
                <input type="text" value={form.name} onChange={e=>setForm({...form,name:e.target.value})} className="w-full border-2 px-3 py-2 rounded-lg"/>
              </div>
              <div>
                <label className="block text-sm font-bold mb-1">Gender *</label>
                <select value={form.gender} onChange={e=>setForm({...form,gender:e.target.value})} className="w-full border-2 px-3 py-2 rounded-lg">
                  <option value="">Select</option>
                  {GENDERS.map(g=><option key={g} value={g}>{g}</option>)}
                </select>
              </div>
              <div className="flex gap-3">
                <button onClick={handleSave} className="flex-1 avanti-gradient text-white py-3 rounded-xl font-semibold">
                  Save
                </button>
                <button onClick={()=>{setShowModal(false);setEditingStudent(null);setForm({school:'',grade:'',name:'',gender:''})}} className="flex-1 bg-gray-300 py-3 rounded-xl font-semibold">
                  Cancel
                </button>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

// ========================================
// TEACHER ATTENDANCE DASHBOARD
// ========================================
function TeacherAttendanceDashboard({currentUser,students,teachers,studentAttendance,teacherAttendance}){
  const[filterGrade,setFilterGrade]=useState('All');
  const[filterSubject,setFilterSubject]=useState('All');
  const[startDate,setStartDate]=useState(getTodayDate().slice(0,7)+'-01');
  const[endDate,setEndDate]=useState(getTodayDate());

  const mySchool=currentUser.school;

  const chart1Ref=useRef(null);
  const chart2Ref=useRef(null);
  const chart3Ref=useRef(null);
  const chartInstances=useRef({});

  const filteredStudentAttendance=useMemo(()=>{
    return studentAttendance.filter(a=>{
      if(a.school!==mySchool)return false;
      if(filterGrade!=='All'&&a.grade!==filterGrade)return false;
      if(a.date<startDate||a.date>endDate)return false;
      return true;
    });
  },[studentAttendance,mySchool,filterGrade,startDate,endDate]);

  const filteredTeacherAttendance=useMemo(()=>{
    return teacherAttendance.filter(a=>{
      if(a.school!==mySchool)return false;
      if(filterSubject!=='All'){
        const teacher=teachers.find(t=>t.afid===a.teacherId);
        if(!teacher||teacher.subject!==filterSubject)return false;
      }
      if(a.date<startDate||a.date>endDate)return false;
      return true;
    });
  },[teacherAttendance,mySchool,teachers,filterSubject,startDate,endDate]);

  const dailyStats=useMemo(()=>{
    const stats={};
    filteredStudentAttendance.forEach(a=>{
      if(!stats[a.date]){
        stats[a.date]={present:0,absent:0};
      }
      if(a.status==='Present'){
        stats[a.date].present++;
      }else{
        stats[a.date].absent++;
      }
    });
    return stats;
  },[filteredStudentAttendance]);

  const gradeStats=useMemo(()=>{
    const stats={'11':{present:0,absent:0},'12':{present:0,absent:0}};
    filteredStudentAttendance.forEach(a=>{
      if(stats[a.grade]){
        if(a.status==='Present'){
          stats[a.grade].present++;
        }else{
          stats[a.grade].absent++;
        }
      }
    });
    return stats;
  },[filteredStudentAttendance]);

  const teacherStats=useMemo(()=>{
    const present=filteredTeacherAttendance.filter(a=>a.status==='Present').length;
    const onLeave=filteredTeacherAttendance.filter(a=>a.status==='On Leave').length;
    return{present,onLeave};
  },[filteredTeacherAttendance]);

  useEffect(()=>{
    Object.values(chartInstances.current).forEach(chart=>{
      if(chart)chart.destroy();
    });
    chartInstances.current={};

    if(chart1Ref.current){
      const ctx=chart1Ref.current.getContext('2d');
      const dates=Object.keys(dailyStats).sort();
      chartInstances.current.chart1=new Chart(ctx,{
        type:'line',
        data:{
          labels:dates.map(d=>new Date(d).getDate()+'/'+String(new Date(d).getMonth()+1)),
          datasets:[
            {
              label:'Present',
              data:dates.map(d=>dailyStats[d].present),
              borderColor:'#10B981',
              backgroundColor:'rgba(16,185,129,0.1)',
              tension:0.4,
              fill:true
            },
            {
              label:'Absent',
              data:dates.map(d=>dailyStats[d].absent),
              borderColor:'#EF4444',
              backgroundColor:'rgba(239,68,68,0.1)',
              tension:0.4,
              fill:true
            }
          ]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            title:{display:true,text:'Daily Student Attendance Trend',font:{size:16,weight:'bold'}},
            legend:{position:'bottom'}
          },
          scales:{y:{beginAtZero:true}}
        }
      });
    }

    if(chart2Ref.current){
      const ctx=chart2Ref.current.getContext('2d');
      chartInstances.current.chart2=new Chart(ctx,{
        type:'bar',
        data:{
          labels:['Class 11','Class 12'],
          datasets:[
            {
              label:'Present',
              data:[gradeStats['11'].present,gradeStats['12'].present],
              backgroundColor:'#10B981'
            },
            {
              label:'Absent',
              data:[gradeStats['11'].absent,gradeStats['12'].absent],
              backgroundColor:'#EF4444'
            }
          ]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            title:{display:true,text:'Grade-wise Attendance',font:{size:16,weight:'bold'}},
            legend:{position:'bottom'}
          },
          scales:{y:{beginAtZero:true}}
        }
      });
    }

    if(chart3Ref.current){
      const ctx=chart3Ref.current.getContext('2d');
      chartInstances.current.chart3=new Chart(ctx,{
        type:'pie',
        data:{
          labels:['Present','On Leave'],
          datasets:[{
            data:[teacherStats.present,teacherStats.onLeave],
            backgroundColor:['#10B981','#F59E0B'],
            borderWidth:2
          }]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            title:{display:true,text:'Teacher Attendance',font:{size:16,weight:'bold'}},
            legend:{position:'bottom'}
          }
        }
      });
    }

    return()=>{
      Object.values(chartInstances.current).forEach(chart=>{
        if(chart)chart.destroy();
      });
    };
  },[dailyStats,gradeStats,teacherStats]);

  const handleExportStudents=()=>{
    const exportData=filteredStudentAttendance.map(a=>({
      Date:a.date,
      Grade:a.grade,
      'Student Name':a.studentName,
      Status:a.status,
      Remarks:a.remarks||'',
      'Marked By':a.markedBy
    }));
    exportToExcel(exportData,`student_attendance_${mySchool}_${startDate}_to_${endDate}`);
  };

  const handleExportTeachers=()=>{
    const exportData=filteredTeacherAttendance.map(a=>({
      Date:a.date,
      'Teacher Name':a.teacherName,
      Status:a.status,
      Reason:a.reason,
      Location:a.location
    }));
    exportToExcel(exportData,`teacher_attendance_${mySchool}_${startDate}_to_${endDate}`);
  };

  return(
    <div className="space-y-6">
      <div className="flex justify-between items-center">
        <h2 className="text-3xl font-bold">📊 Attendance Dashboard - {mySchool}</h2>
      </div>

      <div className="bg-white p-6 rounded-2xl shadow-lg">
        <h3 className="text-xl font-bold mb-4">🔍 Filters</h3>
        <div className="grid md:grid-cols-4 gap-4">
          <div>
            <label className="block text-sm font-bold mb-2">Student Grade</label>
            <select value={filterGrade} onChange={e=>setFilterGrade(e.target.value)} className="w-full border-2 px-4 py-3 rounded-xl">
              <option value="All">All Grades</option>
              <option value="11">Class 11</option>
              <option value="12">Class 12</option>
            </select>
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">Teacher Subject</label>
            <select value={filterSubject} onChange={e=>setFilterSubject(e.target.value)} className="w-full border-2 px-4 py-3 rounded-xl">
              <option value="All">All Subjects</option>
              {SUBJECTS.map(s=><option key={s} value={s}>{s}</option>)}
            </select>
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">Start Date</label>
            <input type="date" value={startDate} onChange={e=>setStartDate(e.target.value)} className="w-full border-2 px-4 py-3 rounded-xl"/>
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">End Date</label>
            <input type="date" value={endDate} onChange={e=>setEndDate(e.target.value)} className="w-full border-2 px-4 py-3 rounded-xl"/>
          </div>
        </div>
        <div className="flex gap-3 mt-4">
          <button onClick={handleExportStudents} className="px-6 py-3 bg-green-600 text-white rounded-xl font-semibold">
            📥 Export Student Attendance
          </button>
          <button onClick={handleExportTeachers} className="px-6 py-3 bg-blue-600 text-white rounded-xl font-semibold">
            📥 Export Teacher Attendance
          </button>
        </div>
      </div>

      <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div className="stat-card bg-green-500 text-white">
          <div className="text-sm opacity-90">Students Present</div>
          <div className="text-4xl font-bold">{filteredStudentAttendance.filter(a=>a.status==='Present').length}</div>
        </div>
        <div className="stat-card bg-red-500 text-white">
          <div className="text-sm opacity-90">Students Absent</div>
          <div className="text-4xl font-bold">{filteredStudentAttendance.filter(a=>a.status==='Absent').length}</div>
        </div>
        <div className="stat-card bg-blue-500 text-white">
          <div className="text-sm opacity-90">Teachers Present</div>
          <div className="text-4xl font-bold">{teacherStats.present}</div>
        </div>
        <div className="stat-card bg-orange-500 text-white">
          <div className="text-sm opacity-90">Teachers on Leave</div>
          <div className="text-4xl font-bold">{teacherStats.onLeave}</div>
        </div>
      </div>

      <div className="grid md:grid-cols-2 gap-6">
        <div className="bg-white p-6 rounded-2xl shadow-lg" style={{height:'350px'}}>
          <canvas ref={chart1Ref}></canvas>
        </div>
        <div className="bg-white p-6 rounded-2xl shadow-lg" style={{height:'350px'}}>
          <canvas ref={chart2Ref}></canvas>
        </div>
      </div>

      <div className="bg-white p-6 rounded-2xl shadow-lg" style={{height:'350px'}}>
        <canvas ref={chart3Ref}></canvas>
      </div>

      <div className="grid md:grid-cols-2 gap-6">
        <div className="bg-white p-6 rounded-2xl shadow-lg">
          <h3 className="text-xl font-bold mb-4">📋 Recent Student Attendance</h3>
          <div className="overflow-x-auto max-h-96">
            <table className="w-full">
              <thead className="avanti-gradient-light sticky top-0">
                <tr>
                  <th className="p-3 text-left">Date</th>
                  <th className="p-3 text-left">Grade</th>
                  <th className="p-3 text-left">Student</th>
                  <th className="p-3 text-left">Status</th>
                </tr>
              </thead>
              <tbody>
                {filteredStudentAttendance.slice(0,50).map((a,idx)=>
                  <tr key={idx} className="border-b hover:bg-gray-50">
                    <td className="p-3 text-sm">{a.date}</td>
                    <td className="p-3">{a.grade}</td>
                    <td className="p-3 font-semibold">{a.studentName}</td>
                    <td className="p-3">
                      <span className={`px-2 py-1 rounded-full text-xs font-bold ${a.status==='Present'?'bg-green-100 text-green-700':'bg-red-100 text-red-700'}`}>
                        {a.status}
                      </span>
                    </td>
                  </tr>
                )}
              </tbody>
            </table>
          </div>
        </div>

        <div className="bg-white p-6 rounded-2xl shadow-lg">
          <h3 className="text-xl font-bold mb-4">👥 Teacher Attendance Records</h3>
          <div className="overflow-x-auto max-h-96">
            <table className="w-full">
              <thead className="avanti-gradient-light sticky top-0">
                <tr>
                  <th className="p-3 text-left">Date</th>
                  <th className="p-3 text-left">Teacher</th>
                  <th className="p-3 text-left">Status</th>
                  <th className="p-3 text-left">Reason</th>
                </tr>
              </thead>
              <tbody>
                {filteredTeacherAttendance.slice(0,50).map((a,idx)=>
                  <tr key={idx} className="border-b hover:bg-gray-50">
                    <td className="p-3 text-sm">{a.date}</td>
                    <td className="p-3 font-semibold">{a.teacherName}</td>
                    <td className="p-3">
                      <span className={`px-2 py-1 rounded-full text-xs font-bold ${a.status==='Present'?'bg-green-100 text-green-700':'bg-orange-100 text-orange-700'}`}>
                        {a.status}
                      </span>
                    </td>
                    <td className="p-3 text-sm">{a.reason}</td>
                  </tr>
                )}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  );
}
// ========================================
// REMARKS MODAL FOR ABSENT STUDENTS
// ========================================
function RemarksModal({student,onSave,onClose}){
  const[selectedRemark,setSelectedRemark]=useState('Sick Leave');
  const[customRemark,setCustomRemark]=useState('');

  const ABSENCE_REASONS=[
    'Sick Leave',
    'Went Home for Festival',
    'Family Emergency',
    'Medical Appointment',
    'Personal Reason',
    'Others'
  ];

  const handleSave=()=>{
    const finalRemark=selectedRemark==='Others'?customRemark:selectedRemark;
    if(selectedRemark==='Others'&&!customRemark.trim()){
      alert('Please enter a custom reason');
      return;
    }
    onSave(finalRemark);
  };

  return(
    <div className="modal-overlay" onClick={onClose}>
      <div className="modal-content" onClick={e=>e.stopPropagation()}>
        <h3 className="text-2xl font-bold mb-4">📝 Absence Remarks</h3>
        <p className="text-gray-600 mb-4">Student: <strong>{student.name}</strong></p>
        
        <div className="space-y-4">
          <div>
            <label className="block text-sm font-bold mb-2">Reason for Absence *</label>
            <select 
              value={selectedRemark} 
              onChange={e=>setSelectedRemark(e.target.value)} 
              className="w-full border-2 px-4 py-3 rounded-xl"
            >
              {ABSENCE_REASONS.map(reason=>
                <option key={reason} value={reason}>{reason}</option>
              )}
            </select>
          </div>

          {selectedRemark==='Others'&&(
            <div>
              <label className="block text-sm font-bold mb-2">Please Specify *</label>
              <textarea
                value={customRemark}
                onChange={e=>setCustomRemark(e.target.value)}
                className="w-full border-2 px-4 py-3 rounded-xl"
                rows="3"
                placeholder="Enter custom reason..."
              />
            </div>
          )}

          <div className="flex gap-3 mt-6">
            <button 
              onClick={handleSave} 
              className="flex-1 bg-red-500 text-white py-3 rounded-xl font-semibold"
            >
              Mark Absent
            </button>
            <button 
              onClick={onClose} 
              className="flex-1 bg-gray-300 py-3 rounded-xl font-semibold"
            >
              Cancel
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}    
// ========================================
// STUDENT ATTENDANCE VIEW (FOR TEACHERS)
// ========================================
function StudentAttendanceView({currentUser,students,studentAttendance}){
  const[selectedGrade,setSelectedGrade]=useState('11');
  const[selectedDate,setSelectedDate]=useState(getTodayDate());
  const[attendanceMap,setAttendanceMap]=useState({});
  const[showRemarksModal,setShowRemarksModal]=useState(false);
  const[selectedStudent,setSelectedStudent]=useState(null);

  const mySchool=currentUser.school;
  const filteredStudents=students.filter(s=>s.school===mySchool&&s.grade===selectedGrade);

  console.log('StudentAttendanceView Debug:',{
    mySchool,
    selectedGrade,
    totalStudents:students.length,
    filteredCount:filteredStudents.length,
    allSchools:Array.from(new Set(students.map(s=>s.school))),
    allGrades:Array.from(new Set(students.map(s=>s.grade)))
  });

  useEffect(()=>{
    const map={};
    studentAttendance
      .filter(a=>a.date===selectedDate&&a.school===mySchool&&a.grade===selectedGrade)
      .forEach(a=>{
        map[a.studentId]=a.status;
      });
    setAttendanceMap(map);
  },[selectedDate,mySchool,selectedGrade]);
  const handleAttendanceChange=async(studentId,status,remarks='')=>{
    try{
      const docId=`${mySchool}_${selectedGrade}_${studentId}_${selectedDate}`;
      await db.collection('studentAttendance').doc(docId).set({
        school:mySchool,
        grade:selectedGrade,
        studentId,
        studentName:filteredStudents.find(s=>s.id===studentId)?.name||'',
        date:selectedDate,
        status,
        remarks:status==='Absent'?remarks:'',
        markedBy:currentUser.afid,
        markedAt:new Date().toISOString()
      });
      setAttendanceMap(prev=>({...prev,[studentId]:status}));
    }catch(e){
      alert('Failed: '+e.message);
    }
  };

  const handleSelectAll=async()=>{
    try{
      for(const student of filteredStudents){
        const docId=`${mySchool}_${selectedGrade}_${student.id}_${selectedDate}`;
        await db.collection('studentAttendance').doc(docId).set({
          school:mySchool,
          grade:selectedGrade,
          studentId:student.id,
          studentName:student.name,
          date:selectedDate,
          status:'Present',
          markedBy:currentUser.afid,
          markedAt:new Date().toISOString()
        });
      }
      const newMap={};
      filteredStudents.forEach(s=>newMap[s.id]='Present');
      setAttendanceMap(newMap);
      alert('All students marked present!');
    }catch(e){
      alert('Failed: '+e.message);
    }
  };

  return(
    <div className="space-y-6">
      <h2 className="text-3xl font-bold">Student Attendance - {mySchool}</h2>

      <div className="bg-white p-6 rounded-2xl shadow-lg">
        <div className="grid md:grid-cols-3 gap-4 mb-4">
          <div>
            <label className="block text-sm font-bold mb-2">Grade</label>
            <select value={selectedGrade} onChange={e=>setSelectedGrade(e.target.value)} className="w-full border-2 px-4 py-3 rounded-xl">
              <option value="11">Class 11</option>
              <option value="12">Class 12</option>
            </select>
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">Date</label>
            <input type="date" value={selectedDate} onChange={e=>setSelectedDate(e.target.value)} className="w-full border-2 px-4 py-3 rounded-xl"/>
          </div>
          <div className="flex items-end">
            <button onClick={handleSelectAll} className="w-full px-6 py-3 bg-green-600 text-white rounded-xl font-semibold">
              ✅ Mark All Present
            </button>
          </div>
        </div>
      </div>

      <div className="bg-white p-6 rounded-2xl shadow-lg">
        <h3 className="font-bold mb-4">Students ({filteredStudents.length})</h3>
        {filteredStudents.length===0?
          <p className="text-gray-500 text-center py-8">No students found</p>
        :
          <div className="space-y-2">
            {filteredStudents.map(student=>
              <div key={student.id} className="flex items-center justify-between p-4 border-2 rounded-xl hover:bg-gray-50">
                <div className="flex-1">
                  <div className="font-semibold text-lg">{student.name}</div>
                  <div className="text-sm text-gray-600">{student.gender}</div>
                  {attendanceMap[student.id]==='Absent'&&(
                    <div className="text-xs text-red-600 mt-1">
                      📝 {studentAttendance.find(a=>a.studentId===student.id&&a.date===selectedDate)?.remarks||'No reason provided'}
                    </div>
                  )}
                </div>
                <div className="flex gap-2">
                  <button 
                    onClick={()=>handleAttendanceChange(student.id,'Present')}
                    className={`px-6 py-2 rounded-lg font-semibold ${attendanceMap[student.id]==='Present'?'bg-green-500 text-white':'bg-gray-200'}`}
                  >
                    ✓ Present
                  </button>
                  <button 
                    onClick={()=>{
                      setSelectedStudent(student);
                      setShowRemarksModal(true);
                    }}
                    className={`px-6 py-2 rounded-lg font-semibold ${attendanceMap[student.id]==='Absent'?'bg-red-500 text-white':'bg-gray-200'}`}
                  >
                    ✗ Absent
                  </button>
                </div>
              </div>
            )}
          </div>
        }
      </div>

      {showRemarksModal&&selectedStudent&&(
        <RemarksModal
          student={selectedStudent}
          onSave={(remarks)=>{
            handleAttendanceChange(selectedStudent.id,'Absent',remarks);
            setShowRemarksModal(false);
            setSelectedStudent(null);
          }}
          onClose={()=>{
            setShowRemarksModal(false);
            setSelectedStudent(null);
          }}
        />
      )}
    </div>
  );
}

// ========================================
// TEACHER ATTENDANCE VIEW
// ========================================
function TeacherAttendanceView({currentUser,teacherAttendance}){
  const[selectedDate,setSelectedDate]=useState(getTodayDate());
  const[status,setStatus]=useState('Present');
  const[reason,setReason]=useState('Present');
  const[location,setLocation]=useState('');
  const[fetchingLocation,setFetchingLocation]=useState(false);

  const todayRecord=teacherAttendance.find(a=>a.teacherId===currentUser.afid&&a.date===selectedDate);

  useEffect(()=>{
    if(todayRecord){
      setStatus(todayRecord.status);
      setReason(todayRecord.reason||'Present');
      setLocation(todayRecord.location||'');
    }
  },[todayRecord]);

  const getLocation=()=>{
    setFetchingLocation(true);
    if(navigator.geolocation){
      navigator.geolocation.getCurrentPosition(
        position=>{
          const loc=`${position.coords.latitude.toFixed(6)}, ${position.coords.longitude.toFixed(6)}`;
          setLocation(loc);
          setFetchingLocation(false);
        },
        ()=>{
          alert('Unable to fetch location');
          setFetchingLocation(false);
        }
      );
    }else{
      alert('Geolocation not supported');
      setFetchingLocation(false);
    }
  };

  const handleSubmit=async()=>{
    if(status!=='Present'&&!reason){
      alert('Please select a reason');
      return;
    }
    try{
      const docId=`${currentUser.afid}_${selectedDate}`;
      await db.collection('teacherAttendance').doc(docId).set({
        teacherId:currentUser.afid,
        teacherName:currentUser.name,
        school:currentUser.school,
        date:selectedDate,
        status,
        reason:status==='Present'?'Present':reason,
        location:location||'Not provided',
        markedAt:new Date().toISOString()
      });
      alert('Attendance marked!');
    }catch(e){
      alert('Failed: '+e.message);
    }
  };

  return(
    <div className="space-y-6">
      <h2 className="text-3xl font-bold">My Attendance</h2>

      <div className="bg-white p-6 rounded-2xl shadow-lg max-w-2xl mx-auto">
        <div className="space-y-4">
          <div>
            <label className="block text-sm font-bold mb-2">Date</label>
            <input type="date" value={selectedDate} onChange={e=>setSelectedDate(e.target.value)} className="w-full border-2 px-4 py-3 rounded-xl"/>
          </div>

          <div>
            <label className="block text-sm font-bold mb-2">Status *</label>
            <div className="flex gap-3">
              <button 
                onClick={()=>{setStatus('Present');setReason('Present')}}
                className={`flex-1 py-3 rounded-xl font-semibold ${status==='Present'?'bg-green-500 text-white':'bg-gray-200'}`}
              >
                ✓ Present
              </button>
              <button 
                onClick={()=>setStatus('On Leave')}
                className={`flex-1 py-3 rounded-xl font-semibold ${status==='On Leave'?'bg-orange-500 text-white':'bg-gray-200'}`}
              >
                📅 On Leave
              </button>
            </div>
          </div>

          {status==='On Leave'&&(
            <div>
              <label className="block text-sm font-bold mb-2">Reason *</label>
              <select value={reason} onChange={e=>setReason(e.target.value)} className="w-full border-2 px-4 py-3 rounded-xl">
                {LEAVE_REASONS.filter(r=>r!=='Present').map(r=><option key={r} value={r}>{r}</option>)}
              </select>
            </div>
          )}

          <div>
            <label className="block text-sm font-bold mb-2">Location</label>
            <div className="flex gap-2">
              <input type="text" value={location} onChange={e=>setLocation(e.target.value)} className="flex-1 border-2 px-4 py-3 rounded-xl" placeholder="Enter location or fetch GPS"/>
              <button onClick={getLocation} disabled={fetchingLocation} className="px-6 py-3 bg-blue-600 text-white rounded-xl font-semibold disabled:opacity-50">
                {fetchingLocation?'📍 Fetching...':'📍 Get GPS'}
              </button>
            </div>
            {location&&<p className="text-sm text-gray-600 mt-2">📍 {location}</p>}
          </div>

          <button onClick={handleSubmit} className="w-full avanti-gradient text-white py-4 rounded-xl font-bold text-lg">
            Submit Attendance
          </button>

          {todayRecord&&(
            <div className="mt-6 p-4 bg-green-50 border-2 border-green-200 rounded-xl">
              <h4 className="font-bold text-green-800 mb-2">✓ Already Marked for {selectedDate}</h4>
              <p><strong>Status:</strong> {todayRecord.status}</p>
              <p><strong>Reason:</strong> {todayRecord.reason}</p>
              <p><strong>Location:</strong> {todayRecord.location}</p>
            </div>
          )}
        </div>
      </div>
    </div>
  );
}

// ========================================
// ADMIN ATTENDANCE ANALYTICS
// ========================================
function AdminAttendanceAnalytics({students,teachers,studentAttendance,teacherAttendance}){
  const[filterSchool,setFilterSchool]=useState('All');
  const[filterGrade,setFilterGrade]=useState('All');
  const[startDate,setStartDate]=useState(getTodayDate().slice(0,7)+'-01');
  const[endDate,setEndDate]=useState(getTodayDate());
  const[selectedDate,setSelectedDate]=useState(getTodayDate());

  const chart1Ref=useRef(null);
  const chart2Ref=useRef(null);
  const chart3Ref=useRef(null);
  const chart4Ref=useRef(null);

  const chartInstances=useRef({});

  const filteredStudentAttendance=useMemo(()=>{
    return studentAttendance.filter(a=>{
      if(filterSchool!=='All'&&a.school!==filterSchool)return false;
      if(filterGrade!=='All'&&a.grade!==filterGrade)return false;
      if(a.date<startDate||a.date>endDate)return false;
      return true;
    });
  },[studentAttendance,filterSchool,filterGrade,startDate,endDate]);

  const filteredTeacherAttendance=useMemo(()=>{
    return teacherAttendance.filter(a=>{
      if(filterSchool!=='All'&&a.school!==filterSchool)return false;
      if(a.date<startDate||a.date>endDate)return false;
      return true;
    });
  },[teacherAttendance,filterSchool,startDate,endDate]);

  const todayStats=useMemo(()=>{
  const studentRecords=studentAttendance.filter(a=>{
    if(a.date!==selectedDate)return false;
    if(filterSchool!=='All'&&a.school!==filterSchool)return false;
    if(filterGrade!=='All'&&a.grade!==filterGrade)return false;
    return true;
  });
  const teacherRecords=teacherAttendance.filter(a=>{
    if(a.date!==selectedDate)return false;
    if(filterSchool!=='All'&&a.school!==filterSchool)return false;
    return true;
  });
  return{
    studentPresent:studentRecords.filter(r=>r.status==='Present').length,
    studentAbsent:studentRecords.filter(r=>r.status==='Absent').length,
    teacherPresent:teacherRecords.filter(r=>r.status==='Present').length,
    teacherAbsent:teacherRecords.filter(r=>r.status==='On Leave').length
  };
},[studentAttendance,teacherAttendance,selectedDate,filterSchool,filterGrade]);

  const genderStats=useMemo(()=>{
    const stats={Male:{present:0,absent:0},Female:{present:0,absent:0},Other:{present:0,absent:0}};
    filteredStudentAttendance.forEach(a=>{
      const student=students.find(s=>s.id===a.studentId);
      if(student&&stats[student.gender]){
        if(a.status==='Present'){
          stats[student.gender].present++;
        }else{
          stats[student.gender].absent++;
        }
      }
    });
    return stats;
  },[filteredStudentAttendance,students]);

  const monthlyDayStats=useMemo(()=>{
    const stats={};
    filteredStudentAttendance.forEach(a=>{
      if(!stats[a.date]){
        stats[a.date]={present:0,absent:0};
      }
      if(a.status==='Present'){
        stats[a.date].present++;
      }else{
        stats[a.date].absent++;
      }
    });
    return stats;
  },[filteredStudentAttendance]);

  useEffect(()=>{
    Object.values(chartInstances.current).forEach(chart=>{
      if(chart)chart.destroy();
    });
    chartInstances.current={};

    // Chart 1: Daily Student Attendance (Line)
    if(chart1Ref.current){
      const ctx=chart1Ref.current.getContext('2d');
      const dates=Object.keys(monthlyDayStats).sort();
      chartInstances.current.chart1=new Chart(ctx,{
        type:'line',
        data:{
          labels:dates.map(d=>new Date(d).getDate()),
          datasets:[
            {
              label:'Present',
              data:dates.map(d=>monthlyDayStats[d].present),
              borderColor:'#10B981',
              backgroundColor:'rgba(16,185,129,0.1)',
              tension:0.4,
              fill:true
            },
            {
              label:'Absent',
              data:dates.map(d=>monthlyDayStats[d].absent),
              borderColor:'#EF4444',
              backgroundColor:'rgba(239,68,68,0.1)',
              tension:0.4,
              fill:true
            }
          ]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            title:{display:true,text:'Daily Student Attendance (Month)',font:{size:16,weight:'bold'}},
            legend:{position:'bottom'}
          },
          scales:{
            y:{beginAtZero:true}
          }
        }
      });
    }

    // Chart 2: Gender-wise Attendance (Bar)
    if(chart2Ref.current){
      const ctx=chart2Ref.current.getContext('2d');
      const genders=Object.keys(genderStats);
      chartInstances.current.chart2=new Chart(ctx,{
        type:'bar',
        data:{
          labels:genders,
          datasets:[
            {
              label:'Present',
              data:genders.map(g=>genderStats[g].present),
              backgroundColor:'#10B981'
            },
            {
              label:'Absent',
              data:genders.map(g=>genderStats[g].absent),
              backgroundColor:'#EF4444'
            }
          ]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            title:{display:true,text:'Gender-wise Student Attendance',font:{size:16,weight:'bold'}},
            legend:{position:'bottom'}
          },
          scales:{
            y:{beginAtZero:true}
          }
        }
      });
    }

    // Chart 3: Teacher Attendance Status (Pie)
    if(chart3Ref.current){
      const ctx=chart3Ref.current.getContext('2d');
      const present=filteredTeacherAttendance.filter(a=>a.status==='Present').length;
      const onLeave=filteredTeacherAttendance.filter(a=>a.status==='On Leave').length;
      chartInstances.current.chart3=new Chart(ctx,{
        type:'pie',
        data:{
          labels:['Present','On Leave'],
          datasets:[{
            data:[present,onLeave],
            backgroundColor:['#10B981','#F59E0B'],
            borderWidth:2
          }]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            title:{display:true,text:'Teacher Attendance Status (Month)',font:{size:16,weight:'bold'}},
            legend:{position:'bottom'}
          }
        }
      });
    }

    // Chart 4: Overall Student Attendance (Doughnut)
    if(chart4Ref.current){
      const ctx=chart4Ref.current.getContext('2d');
      const present=filteredStudentAttendance.filter(a=>a.status==='Present').length;
      const absent=filteredStudentAttendance.filter(a=>a.status==='Absent').length;
      chartInstances.current.chart4=new Chart(ctx,{
        type:'doughnut',
        data:{
          labels:['Present','Absent'],
          datasets:[{
            data:[present,absent],
            backgroundColor:['#3B82F6','#EF4444'],
            borderWidth:0
          }]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            title:{display:true,text:'Overall Student Attendance (Month)',font:{size:16,weight:'bold'}},
            legend:{position:'bottom'}
          }
        }
      });
    }

    return()=>{
      Object.values(chartInstances.current).forEach(chart=>{
        if(chart)chart.destroy();
      });
    };
  },[monthlyDayStats,genderStats,filteredTeacherAttendance,filteredStudentAttendance]);

  const handleExportStudents=()=>{
    const exportData=filteredStudentAttendance.map(a=>({
      Date:a.date,
      School:a.school,
      Grade:a.grade,
      'Student Name':a.studentName,
      Status:a.status,
      Remarks:a.remarks||'',
      'Marked By':a.markedBy
    }));
    exportToExcel(exportData,`student_attendance_${startDate}_to_${endDate}`);
  };

  const handleExportTeachers=()=>{
    const exportData=filteredTeacherAttendance.map(a=>({
      Date:a.date,
      'Teacher Name':a.teacherName,
      School:a.school,
      Status:a.status,
      Reason:a.reason,
      Location:a.location
    }));
    exportToExcel(exportData,`teacher_attendance_${startDate}_to_${endDate}`);
  };

  return(
    <div className="space-y-6">
      <div className="flex justify-between items-center">
        <h2 className="text-3xl font-bold">📊 Attendance Analytics</h2>
        <div className="flex gap-2">
          <button onClick={handleExportStudents} className="px-4 py-2 bg-green-600 text-white rounded-xl font-semibold">
            📥 Export Students
          </button>
          <button onClick={handleExportTeachers} className="px-4 py-2 bg-blue-600 text-white rounded-xl font-semibold">
            📥 Export Teachers
          </button>
        </div>
      </div>

      <div className="bg-white p-6 rounded-2xl shadow-lg">
        <h3 className="text-xl font-bold mb-4">🔍 Filters</h3>
        <div className="grid md:grid-cols-5 gap-4">
          <div>
            <label className="block text-sm font-bold mb-2">School</label>
            <select value={filterSchool} onChange={e=>setFilterSchool(e.target.value)} className="w-full border-2 px-4 py-3 rounded-xl">
              <option value="All">All Schools</option>
              {SCHOOLS.map(s=><option key={s} value={s}>{s}</option>)}
            </select>
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">Grade</label>
            <select value={filterGrade} onChange={e=>setFilterGrade(e.target.value)} className="w-full border-2 px-4 py-3 rounded-xl">
              <option value="All">All Grades</option>
              <option value="11">Class 11</option>
              <option value="12">Class 12</option>
            </select>
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">Start Date</label>
            <input type="date" value={startDate} onChange={e=>setStartDate(e.target.value)} className="w-full border-2 px-4 py-3 rounded-xl"/>
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">End Date</label>
            <input type="date" value={endDate} onChange={e=>setEndDate(e.target.value)} className="w-full border-2 px-4 py-3 rounded-xl"/>
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">Today's View</label>
            <input type="date" value={selectedDate} onChange={e=>setSelectedDate(e.target.value)} className="w-full border-2 px-4 py-3 rounded-xl"/>
          </div>
        </div>
      </div>

      <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div className="stat-card bg-green-500 text-white">
          <div className="text-sm opacity-90">Students Present Today</div>
          <div className="text-4xl font-bold">{todayStats.studentPresent}</div>
        </div>
        <div className="stat-card bg-red-500 text-white">
          <div className="text-sm opacity-90">Students Absent Today</div>
          <div className="text-4xl font-bold">{todayStats.studentAbsent}</div>
        </div>
        <div className="stat-card bg-blue-500 text-white">
          <div className="text-sm opacity-90">Teachers Present Today</div>
          <div className="text-4xl font-bold">{todayStats.teacherPresent}</div>
        </div>
        <div className="stat-card bg-orange-500 text-white">
          <div className="text-sm opacity-90">Teachers on Leave Today</div>
          <div className="text-4xl font-bold">{todayStats.teacherAbsent}</div>
        </div>
      </div>

      <div className="grid md:grid-cols-2 gap-6">
        <div className="bg-white p-6 rounded-2xl shadow-lg" style={{height:'350px'}}>
          <canvas ref={chart1Ref}></canvas>
        </div>
        <div className="bg-white p-6 rounded-2xl shadow-lg" style={{height:'350px'}}>
          <canvas ref={chart2Ref}></canvas>
        </div>
        <div className="bg-white p-6 rounded-2xl shadow-lg" style={{height:'350px'}}>
          <canvas ref={chart3Ref}></canvas>
        </div>
        <div className="bg-white p-6 rounded-2xl shadow-lg" style={{height:'350px'}}>
          <canvas ref={chart4Ref}></canvas>
        </div>
      </div>

      <div className="bg-white p-6 rounded-2xl shadow-lg">
        <h3 className="text-xl font-bold mb-4">📋 Detailed Teacher Attendance</h3>
        <div className="overflow-x-auto">
          <table className="w-full">
            <thead className="avanti-gradient-light">
                <tr>
                  <th className="p-3 text-left">Date</th>
                  <th className="p-3 text-left">School</th>
                  <th className="p-3 text-left">Grade</th>
                  <th className="p-3 text-left">Student</th>
                  <th className="p-3 text-left">Status</th>
                  <th className="p-3 text-left">Remarks</th>
                </tr>
              </thead>
            <tbody>
              {filteredTeacherAttendance.length===0?
                <tr><td colSpan="6" className="p-8 text-center text-gray-500">No records found</td></tr>
              :
                filteredTeacherAttendance.slice(0,50).map((a,idx)=>
                  <tr key={idx} className="border-b hover:bg-gray-50">
                    <td className="p-3">{a.date}</td>
                    <td className="p-3 font-semibold">{a.teacherName}</td>
                    <td className="p-3">{a.school}</td>
                    <td className="p-3">
                      <span className={`px-2 py-1 rounded-full text-xs font-bold ${a.status==='Present'?'bg-green-100 text-green-700':'bg-orange-100 text-orange-700'}`}>
                        {a.status}
                      </span>
                    </td>
                    <td className="p-3">{a.reason}</td>
                    <td className="p-3 text-sm">📍 {a.location}</td>
                  </tr>
                )
              }
            </tbody>
          </table>
        </div>
      </div>
    </div>
  );
}
ReactDOM.render(<App/>,document.getElementById('root'));
  </script>
</body>
</html>
