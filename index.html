<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Curriculum Tracker - Avanti Fellows</title>
  
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-messaging-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
  
  <!-- React -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- ‚úÖ FIX: Chart.js v3.9.1 (specific stable version) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#F4B41A">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Curriculum Tracker">
  <link rel="apple-touch-icon" href="/icon-192.png">

  <!-- CSV & Excel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
  
  <!-- 2FA Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/otpauth/9.2.2/otpauth.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
    /* Priority Badge Gradients */
.priority-badge {
  display: inline-block;
  padding: 0.4rem 0.8rem;
  border-radius: 0.4rem;
  font-size: 0.75rem;
  font-weight: 600;
  color: white;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.12);
  text-align: center;
  min-width: 100px;
  letter-spacing: 0.02em;
}

.priority-high {
  background: linear-gradient(90deg, #10B981 0%, #34D399 100%);
}

.priority-medium {
  background: linear-gradient(90deg, #F59E0B 0%, #FBBF24 100%);
}

.priority-low {
  background: linear-gradient(90deg, #EF4444 0%, #F87171 100%);
}
    :root{--avanti-yellow:#F4B41A;--avanti-orange:#E8B039;--avanti-red:#C8342E}
    *{box-sizing:border-box}
    
    /* Enhanced Mobile Sidebar Styles */
    .mobile-sidebar-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 998;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }
    
    .mobile-sidebar-overlay.active {
      opacity: 1;
      visibility: visible;
    }
    
    .mobile-sidebar {
      position: fixed;
      top: 0;
      left: 0;
      bottom: 0;
      width: 280px;
      max-width: 85vw;
      background: white;
      z-index: 999;
      transform: translateX(-100%);
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 2px 0 12px rgba(0, 0, 0, 0.15);
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    
    .mobile-sidebar.active {
      transform: translateX(0);
    }
    
    /* Desktop sidebar adjustments */
    @media (min-width: 768px) {
      .mobile-sidebar {
        position: relative;
        transform: translateX(0) !important;
        width: 16rem;
        max-width: none;
        box-shadow: none;
      }
      
      .mobile-sidebar-overlay {
        display: none;
      }
    }
    
    /* Responsive card improvements */
    @media (max-width: 768px) {
      .stat-card {
        padding: 1rem;
        margin-bottom: 0.75rem;
      }
      
      .chapter-card {
        padding: 1rem;
        margin-bottom: 0.75rem;
      }
      
      .modal-content {
        width: 95%;
        padding: 1.25rem;
        margin: 10px;
      }
      
      .ranking-card {
        padding: 1rem;
        margin-bottom: 0.75rem;
      }
      
      /* Better table responsiveness */
      table {
        font-size: 0.875rem;
      }
      
      th, td {
        padding: 0.5rem !important;
      }
    }
    
    /* Touch-friendly buttons */
    button, .button {
      min-height: 44px;
      touch-action: manipulation;
    }
    
    /* Better spacing for mobile */
    @media (max-width: 768px) {
      .p-6 {
        padding: 1rem !important;
      }
      
      .p-8 {
        padding: 1.5rem !important;
      }
      
      .gap-6 {
        gap: 1rem !important;
      }
      
      .space-y-6 > * + * {
        margin-top: 1rem !important;
      }
      
      /* Responsive grid adjustments */
      .grid-cols-2, .grid-cols-3, .grid-cols-4 {
        grid-template-columns: repeat(1, minmax(0, 1fr)) !important;
      }
      
      .md\:grid-cols-2, .md\:grid-cols-3 {
        grid-template-columns: repeat(1, minmax(0, 1fr)) !important;
      }
    }
    
    /* Small screens - 2 columns for some grids */
    @media (min-width: 480px) and (max-width: 768px) {
      .grid-cols-2 {
        grid-template-columns: repeat(2, minmax(0, 1fr)) !important;
      }
    }
    @keyframes confetti-fall{0%{transform:translateY(-100vh) rotate(0) scale(1);opacity:1}100%{transform:translateY(100vh) rotate(720deg) scale(.5);opacity:0}}
    @keyframes spin{to{transform:rotate(360deg)}}
    .confetti-piece{position:fixed;pointer-events:none;z-index:9999;animation:confetti-fall 4s cubic-bezier(.25,.46,.45,.94) forwards}
    .chapter-card{transition:all .3s ease;position:relative;overflow:hidden}
    .chapter-card h3{word-break:break-word;overflow-wrap:break-word}
    .break-words{word-break:break-word;overflow-wrap:break-word}
    .chapter-card:hover{transform:translateY(-4px);box-shadow:0 20px 40px -12px rgba(0,0,0,.2)}
    .chapter-card.completed{background:linear-gradient(135deg,#d1fae5,#a7f3d0);border:3px solid #10b981}
    .chapter-card.delayed{background:linear-gradient(135deg,#fed7aa,#fdba74);border:3px solid #f97316}
    .chapter-card.pending{background:linear-gradient(135deg,#fecaca,#fca5a5);border:3px solid #ef4444}
    input:focus,select:focus,textarea:focus{outline:none;box-shadow:0 0 0 4px rgba(244,180,26,.2);border-color:var(--avanti-yellow)}
    .avanti-gradient{background:linear-gradient(135deg,var(--avanti-yellow) 0%,var(--avanti-orange) 50%,var(--avanti-red) 100%)}
    .avanti-gradient-light{background:linear-gradient(135deg,rgba(244,180,26,.1) 0%,rgba(232,176,57,.1) 50%,rgba(200,52,46,.1) 100%)}
    .stat-card{background:white;border-radius:1rem;padding:1.5rem;box-shadow:0 4px 6px -1px rgba(0,0,0,.1);transition:all .3s}
    .stat-card:hover{transform:translateY(-4px);box-shadow:0 10px 15px -3px rgba(0,0,0,.1)}
    input[type="checkbox"]{appearance:none;width:20px;height:20px;border:2px solid var(--avanti-red);border-radius:4px;cursor:pointer;position:relative;flex-shrink:0}
    input[type="checkbox"]:checked{background:var(--avanti-red)}
    input[type="checkbox"]:checked::after{content:'‚úì';position:absolute;color:white;font-size:14px;top:50%;left:50%;transform:translate(-50%,-50%)}
    .birthday-card{background:linear-gradient(135deg,#FFD700,#FFA500);border:3px solid #FF6347;animation:pulse 2s infinite}
    @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
    .modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:9998}
    .modal-content{background:white;border-radius:1rem;padding:2rem;max-width:600px;width:90%;max-height:90vh;overflow-y:auto}
    .status-badge{padding:.5rem 1rem;border-radius:.5rem;font-weight:bold;text-align:center;font-size:.875rem}
    .status-ahead{background:#10b981;color:white}
    .status-ontrack{background:#3b82f6;color:white}
    .status-delayed{background:#f97316;color:white}
    .ranking-card{background:white;border-radius:1rem;padding:1.5rem;box-shadow:0 4px 6px rgba(0,0,0,.1)}
    .ranking-1{border-left:4px solid #fbbf24}
    .ranking-2{border-left:4px solid #c0c0c0}
    .ranking-3{border-left:4px solid #cd7f32}
    .chapter-details{position:relative;z-index:10;pointer-events:auto!important}
.chapter-details input,.chapter-details select,.chapter-details textarea,.chapter-details button,.chapter-details label{position:relative;z-index:20;pointer-events:auto!important;cursor:pointer}
.chapter-details input[type="checkbox"]{cursor:pointer}
.chapter-details select{cursor:pointer;background-color:white}
.chapter-details input[type="date"]{cursor:pointer;background-color:white}

/* Teacher Feedback Styles */
.star-rating {
  display: inline-flex;
  gap: 8px;
  font-size: 32px;
  cursor: pointer;
}
.star {
  color: #d1d5db;
  transition: color 0.2s;
  cursor: pointer;
}
.star.filled {
  color: #F4B41A;
}
.star:hover, .star.hover {
  color: #E8B039;
}
.feedback-modal {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.6);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10000;
  overflow-y: auto;
}
.feedback-content {
  background: white;
  border-radius: 1rem;
  max-width: 600px;
  width: 95%;
  max-height: 90vh;
  overflow-y: auto;
  margin: 20px;
}
.rating-badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 14px;
  font-weight: bold;
}
.rating-excellent {
  background: #10b981;
  color: white;
}
.rating-good {
  background: #3b82f6;
  color: white;
}
.rating-average {
  background: #f59e0b;
  color: white;
}
.rating-poor {
  background: #ef4444;
  color: white;
}
.teacher-card {
  transition: all 0.3s ease;
  cursor: pointer;
}
.teacher-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 10px 20px rgba(0,0,0,0.1);
}
.feedback-notification {
  position: fixed;
  top: 80px;
  right: 20px;
  background: linear-gradient(135deg, #F4B41A, #E8B039);
  color: white;
  padding: 16px 24px;
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  z-index: 9999;
  animation: slideIn 0.5s ease;
}
@keyframes slideIn {
  from {
    transform: translateX(400px);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

/* ========================================
   VERTICAL SIDEBAR STYLES
   ======================================== */
.sidebar {
  position: fixed;
  top: 0;
  left: 0;
  height: 100vh;
  background: linear-gradient(180deg, #F4B41A 0%, #E8B039 50%, #C8342E 100%);
  box-shadow: 2px 0 10px rgba(0,0,0,0.1);
  transition: all 0.3s ease;
  z-index: 1000;
  overflow-y: auto;
}

.sidebar.collapsed {
  width: 70px;
}

.sidebar.expanded {
  width: 260px;
}

.sidebar-header {
  padding: 1.5rem;
  border-bottom: 1px solid rgba(255,255,255,0.2);
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.sidebar-toggle {
  background: rgba(255,255,255,0.2);
  border: none;
  color: white;
  padding: 0.5rem;
  border-radius: 0.5rem;
  cursor: pointer;
  transition: all 0.3s;
  font-size: 1.25rem;
}

.sidebar-toggle:hover {
  background: rgba(255,255,255,0.3);
}

.sidebar-nav {
  padding: 1rem 0;
}

.sidebar-item {
  display: flex;
  align-items: center;
  padding: 1rem 1.5rem;
  color: white;
  cursor: pointer;
  transition: all 0.2s;
  border-left: 4px solid transparent;
  gap: 1rem;
  text-decoration: none;
}

.sidebar-item:hover {
  background: rgba(255,255,255,0.1);
  border-left-color: white;
}

.sidebar-item.active {
  background: rgba(255,255,255,0.2);
  border-left-color: white;
  font-weight: bold;
}

.sidebar-icon {
  font-size: 1.5rem;
  min-width: 1.5rem;
  text-align: center;
}

.sidebar-label {
  white-space: nowrap;
  overflow: hidden;
  transition: opacity 0.3s;
}

.sidebar.collapsed .sidebar-label {
  opacity: 0;
  width: 0;
}

.sidebar.collapsed .sidebar-header h1 {
  opacity: 0;
  width: 0;
}

.main-content {
  transition: margin-left 0.3s ease;
}

.main-content.sidebar-expanded {
  margin-left: 260px;
}

.main-content.sidebar-collapsed {
  margin-left: 70px;
}

/* Mobile responsive */
@media (max-width: 768px) {
  .main-content.sidebar-expanded,
  .main-content.sidebar-collapsed {
    margin-left: 0 !important;
    padding-top: 70px;
    width: 100%;
  }
  
  .sidebar-toggle {
    display: none;
  }
}

/* Scrollbar styling for sidebar */
.sidebar::-webkit-scrollbar {
  width: 6px;
}

.sidebar::-webkit-scrollbar-track {
  background: rgba(255,255,255,0.1);
}

.sidebar::-webkit-scrollbar-thumb {
  background: rgba(255,255,255,0.3);
  border-radius: 3px;
}

.sidebar::-webkit-scrollbar-thumb:hover {
  background: rgba(255,255,255,0.5);
}
  </style>
</head>
<body>
  <div id="root"></div>
  <script>
  // Register Chart.js datalabels plugin safely
if (typeof ChartDataLabels !== 'undefined' && typeof Chart !== 'undefined') {
  try {
    Chart.register(ChartDataLabels);
    
    if (Chart.defaults && Chart.defaults.plugins) {
      Chart.defaults.plugins.datalabels = {
        anchor: 'end',
        align: 'end',
        offset: 4,
        formatter: (value, ctx) => {
          const type = ctx.chart.config.type;
          if (type === 'pie' || type === 'doughnut') {
            const sum = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0) || 1;
            return Math.round((value / sum) * 100) + '%';
          }
          return value;
        },
        color: '#333',
        font: { weight: '600', size: 11 }
      };
    }
  } catch (e) {
    console.warn('ChartDataLabels plugin registration failed:', e);
  }
}

// Optional overrides per chart type
if (typeof Chart !== 'undefined' && Chart.overrides) {
  Chart.overrides.bar = Chart.overrides.bar || {};
  Chart.overrides.bar.plugins = Chart.overrides.bar.plugins || {};
  Chart.overrides.bar.plugins.datalabels = {
    color: '#007bff',
    font: { weight: '700', size: 12 },
    align: 'end',
    anchor: 'end'
  };

  Chart.overrides.pie = Chart.overrides.pie || {};
  Chart.overrides.pie.plugins = Chart.overrides.pie.plugins || {};
  Chart.overrides.pie.plugins.datalabels = {
    color: '#fff',
    font: { weight: '600', size: 14 }
  };
}
</script>
  <script type="text/babel">
const {useState,useEffect,useRef,useCallback,useMemo}=React;
const firebaseConfig={apiKey:"AIzaSyDyyGAHNJvhuint86USW36eBJKfw_u3AcA",authDomain:"curriculum-dbb10.firebaseapp.com",projectId:"curriculum-dbb10",storageBucket:"curriculum-dbb10.firebasestorage.app",messagingSenderId:"706387632109",appId:"1:706387632109:web:06c78a304fdbdc12f391e4"};
if(!firebase.apps.length){firebase.initializeApp(firebaseConfig)}
const db=firebase.firestore();
const auth=firebase.auth();
const SUBJECTS=['Physics','Chemistry','Maths','Biology'];

// Default schools - will be overridden by dynamic schools from Firebase
let SCHOOLS=['CoE Barwani','CoE Cuttak','CoE Bundi','CoE Mahisagar','EMRS Bhopal','JNV Bharuch'];

// ========================================
// HIERARCHY ROLE CONSTANTS (4-Level)
// ========================================
const MANAGER_ROLES = {
  SUPER_ADMIN: 'super_admin',     // Full access to everything
  APH: 'aph',                     // Program Head - sees all reportees' schools
  PM: 'pm',                       // Program Manager - sees their schools + APM schools
  APM: 'apm'                      // Associate Program Manager - sees only assigned schools
};

const ROLE_LABELS = {
  'super_admin': 'Super Admin',
  'aph': 'Program Head',
  'pm': 'Program Manager',
  'apm': 'Associate Program Manager'
};

const ROLE_COLORS = {
  'super_admin': { bg: 'bg-purple-100', text: 'text-purple-700', border: 'border-purple-200' },
  'aph': { bg: 'bg-blue-100', text: 'text-blue-700', border: 'border-blue-200' },
  'pm': { bg: 'bg-green-100', text: 'text-green-700', border: 'border-green-200' },
  'apm': { bg: 'bg-orange-100', text: 'text-orange-700', border: 'border-orange-200' }
};

// ========================================
// ACADEMIC YEAR CONFIGURATION
// ========================================
const getCurrentAcademicYear = () => {
  const now = new Date();
  const year = now.getFullYear();
  const month = now.getMonth(); // 0-indexed
  // Academic year starts in April (month 3)
  if (month >= 3) { // April onwards
    return `${year}-${year + 1}`;
  } else { // Jan-March
    return `${year - 1}-${year}`;
  }
};

const CURRENT_ACADEMIC_YEAR = getCurrentAcademicYear();

const LEAVE_REASONS=['Present','Personal Leave','Sick Leave','Weekly Off','Public Holiday','Organization Holiday','School Holiday','Emergency Leave','Maternity Leave','Paternity Leave'];

// Leave entitlements per year
const LEAVE_ENTITLEMENTS = {
  'Personal Leave': 35,
  'Sick Leave': 35,
  'Emergency Leave': 35,
  'Maternity Leave': 180,
  'Paternity Leave': 15
};

// Leave categories that count against entitlement
const ENTITLED_LEAVE_TYPES = ['Personal Leave', 'Sick Leave', 'Emergency Leave'];
const MATERNITY_LEAVE_TYPES = ['Maternity Leave'];
const PATERNITY_LEAVE_TYPES = ['Paternity Leave'];

// ========================================
// CLASSROOM OBSERVATION PARAMETERS
// ========================================
const CLASSROOM_OBSERVATION_PARAMETERS = [
  {
    id: 'teacherStartedOnTime',
    type: 'minor',
    text: 'Teacher started the class on time',
    maxScore: 1,
    options: [
      { label: 'Yes', value: 1 },
      { label: 'No', value: 0 }
    ]
  },
  {
    id: 'hygiene',
    type: 'minor',
    text: 'Hygiene Parameter: Teacher Grooming - The teacher is formally dressed with proper grooming',
    maxScore: 1,
    options: [
      { label: 'Yes', value: 1 },
      { label: 'No', value: 0 }
    ]
  },
  {
    id: 'startNote',
    type: 'minor',
    text: 'Start Note of the Class: Greetings to the students along with general discussion to gather the attention of all students',
    maxScore: 1,
    options: [
      { label: 'Yes', value: 1 },
      { label: 'No', value: 0 }
    ]
  },
  {
    id: 'preTask',
    type: 'minor',
    text: 'Class structure - Pre-task/Check for HW: The teacher is discussing any previous task assigned',
    maxScore: 1,
    options: [
      { label: 'Yes', value: 1 },
      { label: 'No', value: 0 }
    ]
  },
  {
    id: 'recall',
    type: 'major',
    text: 'Class structure - Recall/Recall test: The session recall needs to be done with two-side communication with simple questions if possible',
    maxScore: 2,
    options: [
      { label: 'Recall done - with questions / students interaction within time', value: 2 },
      { label: 'Recall done - without questions / Taking more than allotted time', value: 1 },
      { label: 'Recall is not done', value: 0 }
    ]
  },
  {
    id: 'learningObjective',
    type: 'major',
    text: 'Learning Objective Setting - Agenda of the class: The teacher needs to set the learning outcome or index for the present class',
    maxScore: 1,
    options: [
      { label: 'Agenda clearly given', value: 1 },
      { label: 'Agenda not given/not clear', value: 0 }
    ]
  },
  {
    id: 'curiosityIntro',
    type: 'major',
    text: 'Curiosity-Introduction: Introduction with practical examples',
    maxScore: 1,
    options: [
      { label: 'Yes', value: 1 },
      { label: 'No', value: 0 }
    ]
  },
  {
    id: 'teachingCompetence',
    type: 'major',
    text: 'Concept-Teaching competence',
    maxScore: 4,
    inputType: 'checkbox',
    checkboxItems: [
      { id: 'conceptClear', label: 'Concept clearly explained' },
      { id: 'cfuPresent', label: 'CFU-Check for understanding present' },
      { id: 'physicalTools', label: 'Used physical teaching tools' },
      { id: 'wellPrepared', label: 'Teacher was well-prepared' }
    ],
    options: [
      { label: 'All 4 parameters met', value: 4 },
      { label: 'Any 3 parameters met', value: 3 },
      { label: 'Any 2 parameters met', value: 2 },
      { label: 'Any 1 parameter met', value: 1 },
      { label: 'None', value: 0 }
    ]
  },
  {
    id: 'notesTaking',
    type: 'major',
    text: 'Concept-Notes Taking: Teacher provides notes and checks students are noting down',
    maxScore: 3,
    options: [
      { label: 'Notes given & checked + mind maps/tricks/mnemonics provided', value: 3 },
      { label: 'Notes given and ensured all students are noting down by checking', value: 2 },
      { label: 'Notes given but not checked with students', value: 1 },
      { label: 'Notes were not given', value: 0 }
    ]
  },
  {
    id: 'problemSolving',
    type: 'major',
    text: 'Concept-Problem solving: Problems solved with student interaction and PYQs',
    maxScore: 4,
    options: [
      { label: 'Problem solved step by step + student opportunity + PYQ given & solved', value: 4 },
      { label: 'Problem solved step by step + giving opportunity for students to solve', value: 3 },
      { label: 'Problem solved step by step with student interaction', value: 2 },
      { label: 'Problem solved without mistakes', value: 1 },
      { label: 'No problems solved or solved with mistakes', value: 0 }
    ]
  },
  {
    id: 'doubtSolving',
    type: 'major',
    text: 'Concept-Doubt solving: Doubts solved correctly with good time management',
    maxScore: 2,
    options: [
      { label: 'Doubt solved correctly with good time management', value: 2 },
      { label: 'Doubt solved correctly but time management not good', value: 1 },
      { label: 'No doubt asked & teacher did not encourage / doubt solved wrong', value: 0 }
    ]
  },
  {
    id: 'boardPresentation',
    type: 'major',
    text: 'Communication-Board Presentation',
    maxScore: 3,
    inputType: 'checkbox',
    checkboxItems: [
      { id: 'boardUsage', label: 'Usage of board' },
      { id: 'writingClear', label: 'Writing is clear' },
      { id: 'boardRepresentation', label: 'Board representation clear/highlighting formulae' }
    ],
    options: [
      { label: 'All 3 parameters met', value: 3 },
      { label: 'Any 2 parameters met', value: 2 },
      { label: 'Any 1 parameter met', value: 1 },
      { label: 'None', value: 0 }
    ]
  },
  {
    id: 'interaction',
    type: 'major',
    text: 'Communication-Interaction: Engaging all students vs limited engagement',
    maxScore: 2,
    options: [
      { label: 'Putting efforts for engaging all the students', value: 2 },
      { label: 'Student engagement is limited to few students', value: 1 },
      { label: 'One way teaching / No engagement with students', value: 0 }
    ]
  },
  {
    id: 'bodyLanguage',
    type: 'major',
    text: 'Communication-Body Language & Energy & Voice',
    maxScore: 6,
    inputType: 'checkbox',
    checkboxItems: [
      { id: 'voiceClear', label: 'Voice clear' },
      { id: 'voiceModulations', label: 'Voice modulations' },
      { id: 'movementAroundClass', label: 'Movement around class' },
      { id: 'eyeContact', label: 'Eye contact' },
      { id: 'handGestures', label: 'Hand gestures' },
      { id: 'adaptiveLanguage', label: 'Adaptive language & fluency' }
    ],
    options: [
      { label: 'All 6 parameters met', value: 6 },
      { label: 'Any 5 parameters', value: 5 },
      { label: 'Any 4 parameters', value: 4 },
      { label: 'Any 3 parameters', value: 3 },
      { label: 'Any 2 parameters', value: 2 },
      { label: 'Any 1 parameter', value: 1 },
      { label: 'None', value: 0 }
    ]
  },
  {
    id: 'conclusion',
    type: 'minor',
    text: 'Class structure-Conclusion: Summary, homework, and next class preview',
    maxScore: 3,
    options: [
      { label: 'Class summary + HW given + Idea about next class', value: 3 },
      { label: 'Both Class summary and HW given', value: 2 },
      { label: 'Either HW or class summary given, not both', value: 1 },
      { label: 'No Summary and no home work given', value: 0 }
    ]
  },
  {
    id: 'paceOfTeaching',
    type: 'major',
    text: 'Class structure-Pace of teaching: Appropriate pace maintained throughout',
    maxScore: 2,
    options: [
      { label: 'Pace of teaching is as per class level', value: 2 },
      { label: 'Pace of teaching is good but not followed throughout', value: 1 },
      { label: 'Pace of teaching is not good', value: 0 }
    ]
  },
  {
    id: 'timeManagement',
    type: 'major',
    text: 'Class structure-Time management: Completed the learning objectives in the stipulated time',
    maxScore: 3,
    options: [
      { label: 'Agenda completed within time', value: 3 },
      { label: 'Agenda is completed but rushed towards the end', value: 2 },
      { label: 'Agenda could not be completed', value: 1 }
    ]
  },
  {
    id: 'classroomManagement',
    type: 'major',
    text: 'Class structure-Classroom management: Teacher set class rules, able to manage entire class well',
    maxScore: 2,
    options: [
      { label: 'Teacher is able to manage the class', value: 2 },
      { label: 'Teacher mostly able to manage with some disruption', value: 1 },
      { label: 'Teacher was unable to manage the class', value: 0 }
    ]
  },
  {
    id: 'genderSensitivity',
    type: 'major',
    text: 'Gender Sensitivity: 1) Avoids gender-biased remarks, 2) Uses gender-neutral language, 3) Represents diversity in examples, 4) Encourages balanced participation, 5) Addresses gender topics sensitively',
    maxScore: 3,
    options: [
      { label: 'No violations + any 2 positive indicators', value: 3 },
      { label: 'No violations + any 1 positive indicator', value: 2 },
      { label: 'Violation occurred once but teacher corrected it', value: 1 },
      { label: 'Violation occurred more than once', value: 0 }
    ]
  }
];

// Maximum total score for classroom observation
const MAX_OBSERVATION_SCORE = CLASSROOM_OBSERVATION_PARAMETERS.reduce((sum, p) => sum + p.maxScore, 0); // = 45

// Helper function to calculate leave balance for a teacher
// Now includes manual adjustments from leaveAdjustments collection
function calculateLeaveBalance(teacherAttendance, teacherId, leaveAdjustments = {}) {
  const teacherLeaves = teacherAttendance.filter(a => 
    a.teacherId === teacherId && a.status === 'On Leave'
  );
  
  // Calculate days used for each category from attendance records
  let entitledUsed = 0;
  let maternityUsed = 0;
  let paternityUsed = 0;
  
  teacherLeaves.forEach(leave => {
    if (ENTITLED_LEAVE_TYPES.includes(leave.reason)) {
      entitledUsed++;
    } else if (MATERNITY_LEAVE_TYPES.includes(leave.reason)) {
      maternityUsed++;
    } else if (PATERNITY_LEAVE_TYPES.includes(leave.reason)) {
      paternityUsed++;
    }
  });
  
  // Get manual adjustments for this teacher (leaves taken before system was implemented)
  const adjustment = leaveAdjustments[teacherId] || { entitled: 0, maternity: 0, paternity: 0 };
  
  // Add adjustments to used count
  entitledUsed += (adjustment.entitled || 0);
  maternityUsed += (adjustment.maternity || 0);
  paternityUsed += (adjustment.paternity || 0);
  
  return {
    entitled: {
      total: 35,
      used: entitledUsed,
      remaining: Math.max(0, 35 - entitledUsed),
      adjustment: adjustment.entitled || 0
    },
    maternity: {
      total: 180,
      used: maternityUsed,
      remaining: Math.max(0, 180 - maternityUsed),
      adjustment: adjustment.maternity || 0
    },
    paternity: {
      total: 15,
      used: paternityUsed,
      remaining: Math.max(0, 15 - paternityUsed),
      adjustment: adjustment.paternity || 0
    }
  };
}
const GENDERS=['Male','Female','Other'];
const isEditing = true;   // keep all admin filters enabled

// ========================================
// CLASSROOM OBSERVATION COMPONENTS
// ========================================

// Classroom Observation Form Component
function ClassroomObservationForm({ teacher, observerInfo, onClose, onSubmitSuccess }) {
  const [grade, setGrade] = useState('11');
  const [observationDate, setObservationDate] = useState(getTodayDate());
  const [observationTime, setObservationTime] = useState(new Date().toTimeString().slice(0,5));
  const [chapterName, setChapterName] = useState('');
  const [topicName, setTopicName] = useState('');
  const [responses, setResponses] = useState({});
  const [checkboxSelections, setCheckboxSelections] = useState({}); // For checkbox-type parameters
  const [remarks, setRemarks] = useState({});
  const [strengths, setStrengths] = useState('');
  const [improvements, setImprovements] = useState('');
  const [mediaLinks, setMediaLinks] = useState(['']);
  const [submitting, setSubmitting] = useState(false);
  const [currentStep, setCurrentStep] = useState(0); // 0 = parameters, 1 = summary

  // Handle checkbox toggle for checkbox-type parameters
  const handleCheckboxToggle = (paramId, itemId) => {
    setCheckboxSelections(prev => {
      const current = prev[paramId] || {};
      const newSelection = { ...current, [itemId]: !current[itemId] };
      
      // Count checked items
      const checkedCount = Object.values(newSelection).filter(Boolean).length;
      
      // Auto-update the score based on checked count
      handleResponseChange(paramId, checkedCount);
      
      return { ...prev, [paramId]: newSelection };
    });
  };

  // Calculate total score
  const totalScore = useMemo(() => {
    return Object.values(responses).reduce((sum, val) => sum + (val || 0), 0);
  }, [responses]);

  const percentageScore = ((totalScore / MAX_OBSERVATION_SCORE) * 100).toFixed(1);

  // Count flagged items (items not at max score)
  const flaggedCount = useMemo(() => {
    return CLASSROOM_OBSERVATION_PARAMETERS.filter(p => {
      const score = responses[p.id];
      return score !== undefined && score < p.maxScore;
    }).length;
  }, [responses]);

  const handleResponseChange = (paramId, value) => {
    setResponses(prev => ({ ...prev, [paramId]: value }));
  };

  const handleRemarkChange = (paramId, value) => {
    setRemarks(prev => ({ ...prev, [paramId]: value }));
  };

  const addMediaLink = () => {
    setMediaLinks(prev => [...prev, '']);
  };

  const updateMediaLink = (index, value) => {
    setMediaLinks(prev => {
      const updated = [...prev];
      updated[index] = value;
      return updated;
    });
  };

  const removeMediaLink = (index) => {
    setMediaLinks(prev => prev.filter((_, i) => i !== index));
  };

  const handleSubmit = async () => {
    // Validate all required fields
    const unanswered = CLASSROOM_OBSERVATION_PARAMETERS.filter(p => responses[p.id] === undefined);
    if (unanswered.length > 0) {
      alert(`Please answer all observation parameters. ${unanswered.length} unanswered.`);
      return;
    }

    setSubmitting(true);
    try {
      const observationData = {
        teacherId: teacher.afid || teacher.docId,
        teacherName: teacher.name,
        teacherAfCode: teacher.afCode || null,
        teacherSubject: teacher.subject,
        school: teacher.school,
        grade: grade,
        chapterName: chapterName || null,
        topicName: topicName || null,
        observationDate: observationDate,
        observationTime: observationTime,
        responses: responses,
        checkboxSelections: checkboxSelections,
        remarks: remarks,
        strengths: strengths,
        improvements: improvements,
        mediaLinks: mediaLinks.filter(link => link.trim() !== ''),
        totalScore: totalScore,
        maxScore: MAX_OBSERVATION_SCORE,
        percentageScore: parseFloat(percentageScore),
        flaggedCount: flaggedCount,
        observerId: observerInfo.id,
        observerName: observerInfo.name,
        observerPosition: observerInfo.position || 'Manager',
        submittedAt: firebase.firestore.FieldValue.serverTimestamp(),
        submittedAtISO: new Date().toISOString()
      };

      await db.collection('classroomObservations').add(observationData);
      alert('‚úÖ Classroom observation submitted successfully!');
      onSubmitSuccess && onSubmitSuccess();
      onClose();
    } catch (error) {
      console.error('Error submitting observation:', error);
      alert('‚ùå Failed to submit observation: ' + error.message);
    } finally {
      setSubmitting(false);
    }
  };

  // Get score color
  const getScoreColor = (score, max) => {
    const pct = (score / max) * 100;
    if (pct >= 80) return 'bg-green-100 text-green-700 border-green-300';
    if (pct >= 60) return 'bg-yellow-100 text-yellow-700 border-yellow-300';
    return 'bg-red-100 text-red-700 border-red-300';
  };

  return (
    <div className="modal-overlay" onClick={onClose}>
      <div className="modal-content max-w-4xl max-h-[95vh] overflow-y-auto" onClick={e => e.stopPropagation()}>
        <div className="p-6">
          {/* Header */}
          <div className="flex justify-between items-start mb-6">
            <div>
              <h2 className="text-2xl font-bold">üìã Classroom Observation</h2>
              <p className="text-gray-600 mt-1">Teacher: <strong>{teacher.name}</strong> ({teacher.subject})</p>
              <p className="text-gray-500 text-sm">School: {teacher.school}</p>
            </div>
            <button onClick={onClose} className="text-3xl font-bold text-gray-400 hover:text-gray-600">√ó</button>
          </div>

          {/* Progress indicator */}
          <div className="mb-6 bg-gray-100 rounded-full h-2">
            <div 
              className="avanti-gradient h-2 rounded-full transition-all"
              style={{ width: `${(Object.keys(responses).length / CLASSROOM_OBSERVATION_PARAMETERS.length) * 100}%` }}
            />
          </div>

          {/* Basic Info */}
          <div className="grid md:grid-cols-3 gap-4 mb-6 bg-gray-50 p-4 rounded-xl">
            <div>
              <label className="block text-sm font-bold mb-2">Grade *</label>
              <select value={grade} onChange={e => setGrade(e.target.value)} className="w-full border-2 px-4 py-3 rounded-xl">
                <option value="11">Class 11</option>
                <option value="12">Class 12</option>
              </select>
            </div>
            <div>
              <label className="block text-sm font-bold mb-2">Date *</label>
              <input type="date" value={observationDate} onChange={e => setObservationDate(e.target.value)} className="w-full border-2 px-4 py-3 rounded-xl"/>
            </div>
            <div>
              <label className="block text-sm font-bold mb-2">Time *</label>
              <input type="time" value={observationTime} onChange={e => setObservationTime(e.target.value)} className="w-full border-2 px-4 py-3 rounded-xl"/>
            </div>
          </div>

          {/* Chapter/Topic Info (Optional) */}
          <div className="grid md:grid-cols-2 gap-4 mb-6 bg-blue-50 p-4 rounded-xl">
            <div>
              <label className="block text-sm font-bold mb-2">Chapter Name (Optional)</label>
              <input 
                type="text" 
                value={chapterName} 
                onChange={e => setChapterName(e.target.value)} 
                placeholder="e.g., Kinematics, Chemical Bonding" 
                className="w-full border-2 px-4 py-3 rounded-xl"
              />
            </div>
            <div>
              <label className="block text-sm font-bold mb-2">Topic Name (Optional)</label>
              <input 
                type="text" 
                value={topicName} 
                onChange={e => setTopicName(e.target.value)} 
                placeholder="e.g., Projectile Motion, Hybridization" 
                className="w-full border-2 px-4 py-3 rounded-xl"
              />
            </div>
          </div>

          {/* Score Summary Card */}
          <div className={`p-4 rounded-xl mb-6 border-2 ${getScoreColor(totalScore, MAX_OBSERVATION_SCORE)}`}>
            <div className="flex justify-between items-center">
              <div>
                <span className="text-2xl font-bold">{totalScore}/{MAX_OBSERVATION_SCORE}</span>
                <span className="ml-2 text-lg">({percentageScore}%)</span>
              </div>
              <div className="text-right">
                <span className="px-3 py-1 bg-red-100 text-red-700 rounded-full text-sm font-semibold">
                  {flaggedCount} flagged items
                </span>
              </div>
            </div>
          </div>

          {/* Parameters */}
          <div className="space-y-4 mb-6">
            <h3 className="text-xl font-bold border-b pb-2">Observation Parameters</h3>
            
            {CLASSROOM_OBSERVATION_PARAMETERS.map((param, idx) => (
              <div key={param.id} className={`p-4 rounded-xl border-2 ${
                responses[param.id] !== undefined 
                  ? responses[param.id] === param.maxScore 
                    ? 'bg-green-50 border-green-200' 
                    : 'bg-red-50 border-red-200'
                  : 'bg-white border-gray-200'
              }`}>
                <div className="flex justify-between items-start mb-3">
                  <div className="flex-1">
                    <span className={`inline-block px-2 py-1 text-xs font-bold rounded mb-2 ${
                      param.type === 'major' ? 'bg-purple-100 text-purple-700' : 'bg-blue-100 text-blue-700'
                    }`}>
                      {param.type === 'major' ? '‚≠ê Major' : 'üìå Minor'} ({param.maxScore} pts)
                    </span>
                    <p className="font-semibold text-gray-800">{idx + 1}. {param.text}</p>
                  </div>
                </div>
                
                {/* Checkbox-based parameters */}
                {param.inputType === 'checkbox' && param.checkboxItems ? (
                  <div className="mb-3">
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-2 mb-3 p-3 bg-gray-50 rounded-xl">
                      {param.checkboxItems.map(item => {
                        const isChecked = checkboxSelections[param.id]?.[item.id] || false;
                        return (
                          <label 
                            key={item.id} 
                            className={`flex items-center gap-2 p-2 rounded-lg cursor-pointer transition-all ${
                              isChecked ? 'bg-green-100 border border-green-300' : 'bg-white border border-gray-200 hover:bg-gray-100'
                            }`}
                          >
                            <input 
                              type="checkbox"
                              checked={isChecked}
                              onChange={() => handleCheckboxToggle(param.id, item.id)}
                              className="cursor-pointer"
                            />
                            <span className={`text-sm ${isChecked ? 'text-green-700 font-semibold' : 'text-gray-700'}`}>
                              {item.label}
                            </span>
                          </label>
                        );
                      })}
                    </div>
                    <div className="flex items-center gap-2 text-sm">
                      <span className="font-semibold">Score:</span>
                      <span className={`px-3 py-1 rounded-full font-bold ${
                        responses[param.id] === param.maxScore ? 'bg-green-100 text-green-700' :
                        responses[param.id] > 0 ? 'bg-yellow-100 text-yellow-700' : 'bg-gray-100 text-gray-600'
                      }`}>
                        {responses[param.id] ?? 0} / {param.maxScore}
                      </span>
                      <span className="text-gray-500">
                        ({Object.values(checkboxSelections[param.id] || {}).filter(Boolean).length} items selected)
                      </span>
                    </div>
                  </div>
                ) : (
                  /* Standard dropdown for other parameters */
                  <select
                    value={responses[param.id] ?? ''}
                    onChange={e => handleResponseChange(param.id, e.target.value === '' ? undefined : parseInt(e.target.value))}
                    className="w-full border-2 px-4 py-3 rounded-xl mb-2"
                  >
                    <option value="">-- Select --</option>
                    {param.options.map((opt, optIdx) => (
                      <option key={optIdx} value={opt.value}>
                        {opt.label} ({opt.value})
                      </option>
                    ))}
                  </select>
                )}

                {/* Show remarks field if not full score */}
                {responses[param.id] !== undefined && responses[param.id] < param.maxScore && (
                  <div className="mt-2">
                    <label className="block text-sm font-semibold text-red-600 mb-1">
                      üìù Remarks (why not full marks?)
                    </label>
                    <textarea
                      value={remarks[param.id] || ''}
                      onChange={e => handleRemarkChange(param.id, e.target.value)}
                      placeholder="Please provide remarks for improvement..."
                      className="w-full border-2 border-red-200 px-4 py-2 rounded-xl text-sm"
                      rows="2"
                    />
                  </div>
                )}
              </div>
            ))}
          </div>

          {/* Observer Summary */}
          <div className="space-y-4 mb-6 bg-blue-50 p-4 rounded-xl">
            <h3 className="text-xl font-bold text-blue-800">üìù Observer Summary</h3>
            
            <div>
              <label className="block text-sm font-bold mb-2">Strengths Observed</label>
              <textarea
                value={strengths}
                onChange={e => setStrengths(e.target.value)}
                placeholder="What did the teacher do well?"
                className="w-full border-2 px-4 py-3 rounded-xl"
                rows="3"
              />
            </div>
            
            <div>
              <label className="block text-sm font-bold mb-2">Points of Improvement</label>
              <textarea
                value={improvements}
                onChange={e => setImprovements(e.target.value)}
                placeholder="What recommendations do you have to improve teaching?"
                className="w-full border-2 px-4 py-3 rounded-xl"
                rows="3"
              />
            </div>
          </div>

          {/* Media Links */}
          <div className="space-y-4 mb-6 bg-gray-50 p-4 rounded-xl">
            <div className="flex justify-between items-center">
              <h3 className="text-xl font-bold">üì∏ Media (Google Drive Links)</h3>
              <button onClick={addMediaLink} className="px-4 py-2 bg-blue-600 text-white rounded-xl text-sm font-semibold">
                + Add Link
              </button>
            </div>
            
            {mediaLinks.map((link, idx) => (
              <div key={idx} className="flex gap-2">
                <input
                  type="url"
                  value={link}
                  onChange={e => updateMediaLink(idx, e.target.value)}
                  placeholder="https://drive.google.com/..."
                  className="flex-1 border-2 px-4 py-2 rounded-xl"
                />
                {mediaLinks.length > 1 && (
                  <button onClick={() => removeMediaLink(idx)} className="px-3 py-2 bg-red-500 text-white rounded-xl">
                    ‚úï
                  </button>
                )}
              </div>
            ))}
          </div>

          {/* Observer Info (Auto-filled) */}
          <div className="bg-gray-100 p-4 rounded-xl mb-6">
            <h4 className="font-bold mb-2">Observer Information (Auto-filled)</h4>
            <div className="grid md:grid-cols-3 gap-4 text-sm">
              <div><strong>Name:</strong> {observerInfo.name}</div>
              <div><strong>Position:</strong> {observerInfo.position || 'Manager'}</div>
              <div><strong>Date/Time:</strong> {new Date().toLocaleString('en-IN')}</div>
            </div>
          </div>

          {/* Submit Button */}
          <div className="flex gap-4">
            <button
              onClick={handleSubmit}
              disabled={submitting}
              className="flex-1 avanti-gradient text-white py-4 rounded-xl font-bold text-lg hover:opacity-90 disabled:opacity-50"
            >
              {submitting ? '‚è≥ Submitting...' : '‚úÖ Submit Observation'}
            </button>
            <button onClick={onClose} className="px-8 py-4 bg-gray-300 rounded-xl font-bold">
              Cancel
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}

// Teacher Profile View Component (shows observations and feedback)
function TeacherProfileView({ teacher, onClose, currentUser }) {
  const [observations, setObservations] = useState([]);
  const [feedbackData, setFeedbackData] = useState([]);
  const [loading, setLoading] = useState(true);
  const [selectedMonth, setSelectedMonth] = useState('All');
  const [selectedObservation, setSelectedObservation] = useState(null);
  const chartRef = useRef(null);
  const chartInstance = useRef(null);

  // Fetch observations and feedback for this teacher
  useEffect(() => {
    const fetchData = async () => {
      try {
        setLoading(true);
        
        // Fetch observations
        const obsSnap = await db.collection('classroomObservations')
          .where('teacherId', '==', teacher.afid || teacher.docId)
          .orderBy('submittedAt', 'desc')
          .get();
        
        const obsData = obsSnap.docs.map(doc => ({
          id: doc.id,
          ...doc.data(),
          submittedAt: doc.data().submittedAt?.toDate() || new Date(doc.data().submittedAtISO)
        }));
        setObservations(obsData);

        // Fetch ALL feedback and filter client-side (avoids Firebase index requirement)
        const feedbackSnap = await db.collection('teacherFeedback').get();
        
        // Create list of all possible identifiers for this teacher
        const teacherIdentifiers = [
          teacher.afid,
          teacher.docId, 
          teacher.id,
          teacher.name
        ].filter(Boolean).map(id => String(id).toLowerCase());
        
        const fbData = feedbackSnap.docs
          .filter(doc => {
            const data = doc.data();
            // Check all possible ID fields in the feedback document
            const feedbackTeacherId = String(data.teacherId || '').toLowerCase();
            const feedbackTeacherAfid = String(data.teacherAfid || '').toLowerCase();
            const feedbackTeacherDocId = String(data.teacherDocId || '').toLowerCase();
            const feedbackTeacherName = String(data.teacherName || '').toLowerCase();
            
            return teacherIdentifiers.includes(feedbackTeacherId) ||
                   teacherIdentifiers.includes(feedbackTeacherAfid) ||
                   teacherIdentifiers.includes(feedbackTeacherDocId) ||
                   teacherIdentifiers.includes(feedbackTeacherName);
          })
          .map(doc => {
            const data = doc.data();
            return {
              id: doc.id,
              ...data,
              submittedAt: data.submittedAt?.toDate ? data.submittedAt.toDate() : new Date(data.submittedAt || data.completedAt)
            };
          });
        
        console.log('Found feedback for teacher:', teacher.name, ':', fbData.length, 'responses');
        setFeedbackData(fbData);

      } catch (error) {
        console.error('Error fetching teacher profile data:', error);
      } finally {
        setLoading(false);
      }
    };

    fetchData();
  }, [teacher]);

  // Get unique months from observations
  const availableMonths = useMemo(() => {
    const months = new Set();
    observations.forEach(obs => {
      const date = new Date(obs.observationDate || obs.submittedAt);
      months.add(`${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`);
    });
    return Array.from(months).sort().reverse();
  }, [observations]);

  // Filter observations by month
  const filteredObservations = useMemo(() => {
    if (selectedMonth === 'All') return observations;
    return observations.filter(obs => {
      const date = new Date(obs.observationDate || obs.submittedAt);
      const month = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
      return month === selectedMonth;
    });
  }, [observations, selectedMonth]);

  // Calculate average feedback scores
  const feedbackAverages = useMemo(() => {
    if (feedbackData.length === 0) return null;
    
    const questionAverages = {};
    const questionLabels = {
      q1: 'Punctuality',
      q2: 'Academic Level', 
      q3: 'Problem Solving',
      q4: 'Explanation Clarity',
      q5: 'Handwriting & Voice',
      q6: 'Time Management',
      q7: 'Guidance & Motivation',
      q8: 'Student Participation',
      q9: 'Equal Attention',
      
      
      
      
      
      
    };

    Object.keys(questionLabels).forEach(qId => {
      const ratings = feedbackData
        .map(fb => fb.responses?.[qId]?.rating)
        .filter(r => r !== undefined && r !== null);
      
      if (ratings.length > 0) {
        questionAverages[qId] = {
          label: questionLabels[qId],
          average: (ratings.reduce((a, b) => a + b, 0) / ratings.length).toFixed(1),
          count: ratings.length
        };
      }
    });

    return questionAverages;
  }, [feedbackData]);

  // Overall average rating
  const overallRating = useMemo(() => {
    if (!feedbackAverages) return null;
    const values = Object.values(feedbackAverages).map(v => parseFloat(v.average));
    if (values.length === 0) return null;
    return (values.reduce((a, b) => a + b, 0) / values.length).toFixed(1);
  }, [feedbackAverages]);

  // Chart for observation trends
  useEffect(() => {
    if (chartInstance.current) {
      chartInstance.current.destroy();
    }

    if (chartRef.current && observations.length > 0) {
      const ctx = chartRef.current.getContext('2d');
      
      // Group by month
      const monthlyData = {};
      observations.forEach(obs => {
        const date = new Date(obs.observationDate || obs.submittedAt);
        const month = date.toLocaleDateString('en-IN', { month: 'short', year: '2-digit' });
        if (!monthlyData[month]) {
          monthlyData[month] = [];
        }
        monthlyData[month].push(obs.percentageScore);
      });

      const labels = Object.keys(monthlyData);
      const avgScores = labels.map(month => {
        const scores = monthlyData[month];
        return (scores.reduce((a, b) => a + b, 0) / scores.length).toFixed(1);
      });

      chartInstance.current = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Observation Score %',
            data: avgScores,
            borderColor: '#F4B41A',
            backgroundColor: 'rgba(244, 180, 26, 0.1)',
            tension: 0.4,
            fill: true,
            pointBackgroundColor: '#F4B41A',
            pointRadius: 6
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: { display: true, text: 'Observation Score Trend', font: { size: 16, weight: 'bold' } },
            legend: { display: false }
          },
          scales: {
            y: { beginAtZero: true, max: 100, title: { display: true, text: 'Score %' } }
          }
        }
      });
    }

    return () => {
      if (chartInstance.current) {
        chartInstance.current.destroy();
      }
    };
  }, [observations]);

  // Generate PDF Report
  const generatePDF = async (observation) => {
    // Create a printable HTML for the observation
    const printWindow = window.open('', '_blank');
    
    const parameterRows = CLASSROOM_OBSERVATION_PARAMETERS.map(param => {
      const score = observation.responses?.[param.id] ?? 'N/A';
      const remark = observation.remarks?.[param.id] || '';
      const isFlagged = score !== param.maxScore;
      return `
        <tr style="border-bottom: 1px solid #eee; ${isFlagged ? 'background-color: #FEE2E2;' : ''}">
          <td style="padding: 8px; font-size: 12px;">${param.type === 'major' ? '‚≠ê' : 'üìå'} ${param.text}</td>
          <td style="padding: 8px; text-align: center; font-weight: bold; ${isFlagged ? 'color: #DC2626;' : 'color: #059669;'}">${score}/${param.maxScore}</td>
          <td style="padding: 8px; font-size: 11px; color: #666;">${remark}</td>
        </tr>
      `;
    }).join('');

    const mediaSection = observation.mediaLinks?.length > 0 ? `
      <div style="margin-top: 20px;">
        <h3 style="color: #1F2937; border-bottom: 2px solid #F4B41A; padding-bottom: 5px;">üì∏ Media Links</h3>
        <ul style="font-size: 12px;">
          ${observation.mediaLinks.map((link, i) => `<li><a href="${link}" target="_blank">Media ${i + 1}</a></li>`).join('')}
        </ul>
      </div>
    ` : '';

    printWindow.document.write(`
      <!DOCTYPE html>
      <html>
      <head>
        <title>Classroom Observation - ${observation.teacherName}</title>
        <style>
          @media print {
            @page { margin: 1cm; size: A4; }
            body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
          }
          body { font-family: Arial, sans-serif; padding: 20px; color: #333; }
          .header { display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 3px solid #F4B41A; padding-bottom: 15px; margin-bottom: 20px; }
          .logo { font-size: 24px; font-weight: bold; color: #F4B41A; }
          .score-box { background: linear-gradient(135deg, #F4B41A, #E8B039); color: white; padding: 15px 25px; border-radius: 10px; text-align: center; }
          .score-box .score { font-size: 32px; font-weight: bold; }
          .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
          .info-item { padding: 10px; background: #F9FAFB; border-radius: 8px; }
          .info-item label { font-size: 11px; color: #6B7280; text-transform: uppercase; }
          .info-item span { display: block; font-weight: bold; color: #1F2937; }
          table { width: 100%; border-collapse: collapse; margin-top: 15px; }
          th { background: #F4B41A; color: white; padding: 10px; text-align: left; }
          .flagged { background: #FEF2F2; }
          .footer { position: fixed; bottom: 0; left: 0; right: 0; padding: 10px 20px; font-size: 10px; border-top: 1px solid #ddd; display: flex; justify-content: space-between; }
        </style>
      </head>
      <body>
        <div class="header">
          <div>
            <div class="logo">‡§Ö‡§µ‡§Ç‡§§‡•Ä Avanti Fellows</div>
            <h1 style="margin: 10px 0 5px; font-size: 20px;">Classroom Observation Report</h1>
            <p style="margin: 0; color: #666;">Teacher: ${observation.teacherName} | ${observation.teacherSubject}</p>
          </div>
          <div class="score-box">
            <div class="score">${observation.totalScore}/${observation.maxScore}</div>
            <div style="font-size: 14px;">${observation.percentageScore}%</div>
            <div style="font-size: 12px; margin-top: 5px;">${observation.flaggedCount} flagged</div>
          </div>
        </div>

        <div class="info-grid">
          <div class="info-item">
            <label>School</label>
            <span>${observation.school}</span>
          </div>
          <div class="info-item">
            <label>Grade</label>
            <span>Class ${observation.grade}</span>
          </div>
          <div class="info-item">
            <label>Observation Date</label>
            <span>${new Date(observation.observationDate).toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' })} ${observation.observationTime}</span>
          </div>
          <div class="info-item">
            <label>Observer</label>
            <span>${observation.observerName} (${observation.observerPosition})</span>
          </div>
        </div>

        <h3 style="color: #1F2937; border-bottom: 2px solid #F4B41A; padding-bottom: 5px;">Observation Parameters</h3>
        <table>
          <thead>
            <tr>
              <th style="width: 60%;">Parameter</th>
              <th style="width: 15%;">Score</th>
              <th style="width: 25%;">Remarks</th>
            </tr>
          </thead>
          <tbody>
            ${parameterRows}
          </tbody>
        </table>

        ${observation.strengths ? `
          <div style="margin-top: 20px; background: #ECFDF5; padding: 15px; border-radius: 8px;">
            <h4 style="color: #059669; margin: 0 0 10px;">‚úÖ Strengths Observed</h4>
            <p style="margin: 0; font-size: 13px;">${observation.strengths}</p>
          </div>
        ` : ''}

        ${observation.improvements ? `
          <div style="margin-top: 15px; background: #FEF3C7; padding: 15px; border-radius: 8px;">
            <h4 style="color: #D97706; margin: 0 0 10px;">üí° Points of Improvement</h4>
            <p style="margin: 0; font-size: 13px;">${observation.improvements}</p>
          </div>
        ` : ''}

        ${mediaSection}

        <div class="footer">
          <span>Private & Confidential</span>
          <span>Page 1</span>
        </div>
      </body>
      </html>
    `);

    printWindow.document.close();
    setTimeout(() => {
      printWindow.print();
    }, 500);
  };

  if (loading) {
    return (
      <div className="modal-overlay" onClick={onClose}>
        <div className="modal-content" onClick={e => e.stopPropagation()}>
          <div className="p-12 text-center">
            <div className="text-4xl mb-4">‚è≥</div>
            <p>Loading teacher profile...</p>
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className="modal-overlay" onClick={onClose}>
      <div className="modal-content max-w-5xl max-h-[95vh] overflow-y-auto" onClick={e => e.stopPropagation()}>
        <div className="p-6">
          {/* Header */}
          <div className="flex justify-between items-start mb-6">
            <div>
              <h2 className="text-2xl font-bold">üë§ Teacher Profile</h2>
              <p className="text-xl text-gray-700 mt-1">{teacher.name}</p>
              <p className="text-gray-500">{teacher.subject} | {teacher.school}</p>
              <div className="flex gap-3 mt-2">
                <span className="px-3 py-1 bg-gray-100 text-gray-700 rounded-lg text-sm font-mono">AFID: {teacher.afid}</span>
                {teacher.afCode && <span className="px-3 py-1 bg-blue-100 text-blue-700 rounded-lg text-sm font-mono">AF Code: {teacher.afCode}</span>}
              </div>
            </div>
            <button onClick={onClose} className="text-3xl font-bold text-gray-400 hover:text-gray-600">√ó</button>
          </div>

          {/* Overall Stats Cards */}
          <div className="grid md:grid-cols-3 gap-4 mb-6">
            <div className="bg-gradient-to-r from-yellow-400 to-orange-500 text-white p-4 rounded-xl">
              <div className="text-sm opacity-90">Total Observations</div>
              <div className="text-3xl font-bold">{observations.length}</div>
            </div>
            <div className="bg-gradient-to-r from-green-400 to-green-600 text-white p-4 rounded-xl">
              <div className="text-sm opacity-90">Avg Observation Score</div>
              <div className="text-3xl font-bold">
                {observations.length > 0 
                  ? (observations.reduce((sum, o) => sum + o.percentageScore, 0) / observations.length).toFixed(1) + '%'
                  : 'N/A'}
              </div>
            </div>
            <div className="bg-gradient-to-r from-blue-400 to-blue-600 text-white p-4 rounded-xl">
              <div className="text-sm opacity-90">Student Feedback Rating</div>
              <div className="text-3xl font-bold">{overallRating || 'N/A'}/5</div>
              <div className="text-xs opacity-75">{feedbackData.length} responses</div>
            </div>
          </div>

          {/* Observation Trend Chart */}
          {observations.length > 0 && (
            <div className="bg-white p-4 rounded-xl shadow mb-6">
              <div style={{ height: '250px' }}>
                <canvas ref={chartRef}></canvas>
              </div>
            </div>
          )}

          {/* Classroom Observations Section */}
          <div className="bg-white p-6 rounded-xl shadow mb-6">
            <div className="flex justify-between items-center mb-4">
              <h3 className="text-xl font-bold">üìã Classroom Observations</h3>
              <select 
                value={selectedMonth} 
                onChange={e => setSelectedMonth(e.target.value)}
                className="border-2 px-4 py-2 rounded-xl"
              >
                <option value="All">All Months</option>
                {availableMonths.map(month => (
                  <option key={month} value={month}>
                    {new Date(month + '-01').toLocaleDateString('en-IN', { month: 'long', year: 'numeric' })}
                  </option>
                ))}
              </select>
            </div>

            {filteredObservations.length === 0 ? (
              <div className="text-center py-8 text-gray-500">
                <div className="text-4xl mb-2">üìã</div>
                <p>No classroom observations recorded yet</p>
              </div>
            ) : (
              <div className="space-y-3">
                {filteredObservations.map(obs => (
                  <div key={obs.id} className="border-2 rounded-xl p-4 hover:border-yellow-400 cursor-pointer transition" onClick={() => setSelectedObservation(obs)}>
                    <div className="flex justify-between items-center">
                      <div>
                        <div className="font-bold">
                          {new Date(obs.observationDate || obs.submittedAt).toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' })}
                          <span className="text-gray-500 font-normal ml-2">Class {obs.grade}</span>
                        </div>
                        <div className="text-sm text-gray-500">Observer: {obs.observerName}</div>
                      </div>
                      <div className="text-right">
                        <div className={`text-2xl font-bold ${
                          obs.percentageScore >= 80 ? 'text-green-600' : 
                          obs.percentageScore >= 60 ? 'text-yellow-600' : 'text-red-600'
                        }`}>
                          {obs.percentageScore}%
                        </div>
                        <div className="text-sm text-gray-500">{obs.totalScore}/{obs.maxScore}</div>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>

          {/* Student Feedback Summary */}
          <div className="bg-white p-6 rounded-xl shadow">
            <h3 className="text-xl font-bold mb-4">üí¨ Student Feedback Summary</h3>
            
            {!feedbackAverages ? (
              <div className="text-center py-8 text-gray-500">
                <div className="text-4xl mb-2">üí¨</div>
                <p>No student feedback received yet</p>
              </div>
            ) : (
              <div className="grid md:grid-cols-3 gap-4">
                {Object.entries(feedbackAverages).map(([qId, data]) => (
                  <div key={qId} className="bg-gray-50 p-3 rounded-lg">
                    <div className="text-sm text-gray-600 mb-1">{data.label}</div>
                    <div className="flex items-center justify-between">
                      <span className={`text-xl font-bold ${
                        parseFloat(data.average) >= 8 ? 'text-green-600' :
                        parseFloat(data.average) >= 6 ? 'text-yellow-600' : 'text-red-600'
                      }`}>
                        {data.average}/5
                      </span>
                      <span className="text-xs text-gray-400">({data.count} ratings)</span>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>
        </div>
      </div>

      {/* Observation Detail Modal */}
      {selectedObservation && (
        <div className="modal-overlay" style={{ zIndex: 1001 }} onClick={() => setSelectedObservation(null)}>
          <div className="modal-content max-w-3xl max-h-[90vh] overflow-y-auto" onClick={e => e.stopPropagation()}>
            <div className="p-6">
              <div className="flex justify-between items-start mb-4">
                <div>
                  <h3 className="text-xl font-bold">Observation Details</h3>
                  <p className="text-gray-500">
                    {new Date(selectedObservation.observationDate).toLocaleDateString('en-IN', { weekday: 'long', day: '2-digit', month: 'long', year: 'numeric' })}
                  </p>
                </div>
                <div className="flex gap-2">
                  <button onClick={() => generatePDF(selectedObservation)} className="px-4 py-2 bg-blue-600 text-white rounded-lg font-semibold">
                    üìÑ Download PDF
                  </button>
                  <button onClick={() => setSelectedObservation(null)} className="text-2xl font-bold text-gray-400">√ó</button>
                </div>
              </div>

              <div className={`p-4 rounded-xl mb-4 ${
                selectedObservation.percentageScore >= 80 ? 'bg-green-100' :
                selectedObservation.percentageScore >= 60 ? 'bg-yellow-100' : 'bg-red-100'
              }`}>
                <div className="text-center">
                  <div className="text-3xl font-bold">{selectedObservation.totalScore}/{selectedObservation.maxScore}</div>
                  <div className="text-xl">{selectedObservation.percentageScore}%</div>
                  <div className="text-sm text-gray-600">{selectedObservation.flaggedCount} items flagged</div>
                </div>
              </div>

              <div className="space-y-2 mb-4">
                {CLASSROOM_OBSERVATION_PARAMETERS.map(param => {
                  const score = selectedObservation.responses?.[param.id];
                  const remark = selectedObservation.remarks?.[param.id];
                  const isFlagged = score !== undefined && score < param.maxScore;
                  
                  return (
                    <div key={param.id} className={`p-3 rounded-lg ${isFlagged ? 'bg-red-50' : 'bg-green-50'}`}>
                      <div className="flex justify-between items-start">
                        <div className="flex-1 text-sm">{param.text}</div>
                        <div className={`font-bold ml-2 ${isFlagged ? 'text-red-600' : 'text-green-600'}`}>
                          {score ?? 'N/A'}/{param.maxScore}
                        </div>
                      </div>
                      {remark && <div className="text-xs text-red-600 mt-1">üìù {remark}</div>}
                    </div>
                  );
                })}
              </div>

              {selectedObservation.strengths && (
                <div className="bg-green-50 p-4 rounded-xl mb-3">
                  <h4 className="font-bold text-green-700 mb-2">‚úÖ Strengths</h4>
                  <p className="text-sm">{selectedObservation.strengths}</p>
                </div>
              )}

              {selectedObservation.improvements && (
                <div className="bg-yellow-50 p-4 rounded-xl mb-3">
                  <h4 className="font-bold text-yellow-700 mb-2">üí° Improvements</h4>
                  <p className="text-sm">{selectedObservation.improvements}</p>
                </div>
              )}

              <div className="text-sm text-gray-500 mt-4">
                Observer: {selectedObservation.observerName} ({selectedObservation.observerPosition}) | 
                Submitted: {new Date(selectedObservation.submittedAt).toLocaleString('en-IN')}
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}


// ========================================
// TEACHER FEEDBACK COMPONENTS
// ========================================

// Star Rating Component
function StarRating({ value, onChange, readonly = false }) {
  const [hoverValue, setHoverValue] = useState(0);
  
  return (
    <div className="star-rating">
      {[1, 2, 3, 4, 5, 6, 7, 8, 9, 10].map(star => (
        <span
          key={star}
          className={`star ${(hoverValue || value) >= star ? 'filled' : ''}`}
          onClick={() => !readonly && onChange(star)}
          onMouseEnter={() => !readonly && setHoverValue(star)}
          onMouseLeave={() => !readonly && setHoverValue(0)}
        >
          ‚òÖ
        </span>
      ))}
    </div>
  );
}

// Teacher Profile Modal  
function TeacherProfileModal({ teacher, onClose, onGiveFeedback, averageRating }) {
  return (
    <div className="modal-overlay" onClick={onClose}>
      <div className="modal-content max-w-md" onClick={e => e.stopPropagation()}>
        <div className="p-6">
          <div className="flex justify-between items-start mb-4">
            <div className="flex items-center gap-4">
              {teacher.profilePhoto ? (
                <img src={teacher.profilePhoto} alt={teacher.name} className="w-16 h-16 rounded-full object-cover border-2 border-yellow-400"/>
              ) : (
                <div className="w-16 h-16 rounded-full bg-gradient-to-br from-yellow-400 to-orange-500 flex items-center justify-center text-2xl font-bold text-white">
                  {teacher.name?.charAt(0) || '?'}
                </div>
              )}
              <div>
                <h2 className="text-xl font-bold">{teacher.name}</h2>
                <p className="text-gray-600">{teacher.subject}</p>
              </div>
            </div>
            <button onClick={onClose} className="text-2xl font-bold text-gray-500 hover:text-gray-700">
              √ó
            </button>
          </div>
          
          <div className="space-y-3">
            <div className="bg-gray-50 p-3 rounded-lg">
              <div className="text-sm text-gray-500">Education Qualification</div>
              <div className="font-semibold">{teacher.qualification || 'Not specified'}</div>
            </div>
            
            <div className="bg-gray-50 p-3 rounded-lg">
              <div className="text-sm text-gray-500">Experience</div>
              <div className="font-semibold">{teacher.experience || 'Not specified'}</div>
            </div>

            {teacher.whatsapp && (
              <div className="bg-gray-50 p-3 rounded-lg">
                <div className="text-sm text-gray-500">WhatsApp</div>
                <a href={`https://wa.me/${teacher.whatsapp.replace(/[^0-9]/g, '')}`} target="_blank" rel="noopener noreferrer" className="font-semibold text-green-600 hover:underline">
                  üí¨ {teacher.whatsapp}
                </a>
              </div>
            )}

            {teacher.bio && (
              <div className="bg-gray-50 p-3 rounded-lg">
                <div className="text-sm text-gray-500">About</div>
                <div className="font-semibold text-sm">{teacher.bio}</div>
              </div>
            )}
            
            <div className="bg-yellow-50 p-3 rounded-lg border border-yellow-200">
              <div className="text-sm text-gray-500 mb-1">Average Rating</div>
              <div className="flex items-center gap-3">
                <span className="text-2xl font-bold text-yellow-500">
                  {averageRating ? averageRating.toFixed(1) : 'N/A'}
                </span>
                <span className="text-gray-600">/ 5</span>
                {averageRating && (
                  <span className={`px-2 py-1 rounded-full text-xs font-bold ${
                    averageRating >= 4.5 ? 'bg-green-100 text-green-700' :
                    averageRating >= 3.5 ? 'bg-blue-100 text-blue-700' :
                    averageRating >= 2.5 ? 'bg-yellow-100 text-yellow-700' : 'bg-red-100 text-red-700'
                  }`}>
                    {averageRating >= 4.5 ? '‚≠ê Excellent' :
                     averageRating >= 3.5 ? 'üëç Good' :
                     averageRating >= 2.5 ? 'üòê Average' : 'üëé Needs Improvement'}
                  </span>
                )}
              </div>
            </div>
            
            <button
              onClick={onGiveFeedback}
              className="w-full avanti-gradient text-white py-3 rounded-xl font-bold text-lg hover:opacity-90"
            >
              üìù Give Feedback
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}

// ========================================
// MONTHLY FEEDBACK TREND GRAPH
// Simple line chart showing monthly average ratings
// ========================================
function MonthlyFeedbackTrendGraph({ feedbackData = [] }) {
  const chartRef = useRef(null);
  const chartInstance = useRef(null);

  // Calculate monthly average ratings
  const monthlyData = useMemo(() => {
    const now = new Date();
    const months = [];
    
    // Get last 6 months
    for (let i = 5; i >= 0; i--) {
      const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
      months.push({
        key: `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`,
        label: date.toLocaleDateString('en-IN', { month: 'short', year: '2-digit' }),
        totalRating: 0,
        count: 0,
        avgRating: 0
      });
    }

    // Calculate feedback ratings by month
    feedbackData.forEach(fb => {
      if (fb.submittedAt) {
        const date = fb.submittedAt instanceof Date ? fb.submittedAt : new Date(fb.submittedAt);
        const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
        const monthData = months.find(m => m.key === monthKey);
        
        if (monthData) {
          // Use the rating field directly (1-5 scale)
          const rating = fb.rating || fb.averageRating || 0;
          if (rating > 0) {
            monthData.totalRating += rating;
            monthData.count++;
          }
        }
      }
    });

    // Calculate averages
    months.forEach(month => {
      if (month.count > 0) {
        month.avgRating = (month.totalRating / month.count).toFixed(1);
      }
    });

    return months;
  }, [feedbackData]);

  // Create/update chart
  useEffect(() => {
    if (chartInstance.current) {
      chartInstance.current.destroy();
    }

    if (chartRef.current && monthlyData.length > 0) {
      const ctx = chartRef.current.getContext('2d');
      
      chartInstance.current = new Chart(ctx, {
        type: 'line',
        data: {
          labels: monthlyData.map(m => m.label),
          datasets: [
            {
              label: 'Avg Rating (out of 5)',
              data: monthlyData.map(m => m.avgRating > 0 ? parseFloat(m.avgRating) : null),
              borderColor: '#8B5CF6',
              backgroundColor: 'rgba(139, 92, 246, 0.1)',
              tension: 0.4,
              fill: true,
              pointBackgroundColor: '#8B5CF6',
              pointRadius: 6,
              pointHoverRadius: 8,
              spanGaps: true,
              borderWidth: 3
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            mode: 'index',
            intersect: false
          },
          plugins: {
            title: { 
              display: true, 
              text: 'üìà Monthly Average Feedback Rating', 
              font: { size: 16, weight: 'bold' },
              padding: { bottom: 20 }
            },
            legend: { 
              display: false
            },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              titleFont: { size: 14 },
              bodyFont: { size: 13 },
              padding: 12,
              callbacks: {
                label: function(context) {
                  const monthData = monthlyData[context.dataIndex];
                  return [
                    `Average Rating: ${context.raw}/5`,
                    `Total Responses: ${monthData.count}`
                  ];
                }
              }
            },
            datalabels: {
              display: true,
              anchor: 'end',
              align: 'top',
              color: '#8B5CF6',
              font: { weight: 'bold', size: 12 },
              formatter: function(value) {
                return value ? value : '';
              }
            }
          },
          scales: {
            y: { 
              beginAtZero: true, 
              max: 5,
              title: { 
                display: true, 
                text: 'Average Rating',
                font: { weight: 'bold' }
              },
              ticks: {
                stepSize: 1
              }
            },
            x: {
              title: { 
                display: true, 
                text: 'Month',
                font: { weight: 'bold' }
              }
            }
          }
        },
        plugins: [ChartDataLabels]
      });
    }

    return () => {
      if (chartInstance.current) {
        chartInstance.current.destroy();
      }
    };
  }, [monthlyData]);

  // Calculate summary stats
  const totalResponses = monthlyData.reduce((sum, m) => sum + m.count, 0);
  const monthsWithData = monthlyData.filter(m => m.count > 0);
  const overallAvg = monthsWithData.length > 0 
    ? (monthsWithData.reduce((sum, m) => sum + parseFloat(m.avgRating), 0) / monthsWithData.length).toFixed(1)
    : 'N/A';

  if (feedbackData.length === 0) {
    return null;
  }

  return (
    <div className="bg-white p-6 rounded-2xl shadow-lg">
      <div style={{ height: '280px' }}>
        <canvas ref={chartRef}></canvas>
      </div>
      <div className="grid grid-cols-3 gap-4 mt-4 pt-4 border-t">
        <div className="text-center">
          <div className="text-2xl font-bold text-purple-600">{overallAvg}</div>
          <div className="text-xs text-gray-600">6-Month Avg Rating</div>
        </div>
        <div className="text-center">
          <div className="text-2xl font-bold text-blue-600">{totalResponses}</div>
          <div className="text-xs text-gray-600">Total Responses</div>
        </div>
        <div className="text-center">
          <div className="text-2xl font-bold text-green-600">
            {monthlyData[monthlyData.length - 1]?.count || 0}
          </div>
          <div className="text-xs text-gray-600">This Month</div>
        </div>
      </div>
    </div>
  );
}

// Teacher Feedback Form Modal
function TeacherFeedbackForm({ teacher, studentId, studentInfo, onClose, onSubmitSuccess }) {
  const [currentQuestion, setCurrentQuestion] = useState(0);
  const [feedback, setFeedback] = useState({
    teacherId: teacher.afid || teacher.docId,
    teacherDocId: teacher.docId,
    teacherAfid: teacher.afid,
    teacherName: teacher.name,
    subject: teacher.subject,
    school: teacher.school,
    grade: studentInfo?.grade || '',
    studentId: studentId,
    studentName: studentInfo?.name || '',
    submittedAt: new Date().toISOString(),
    responses: {}
  });
  const [showExplanation, setShowExplanation] = useState(false);

  const questions = [
    { 
      id: 'q1', 
      text: 'Does the teacher start and end the class on time?', 
      type: 'mcq',
      options: [
        { value: 'a', text: 'The teacher is always on time and ends the class on time.', rating: 5 },
        { value: 'b', text: 'The teacher is sometimes late or does not end the class on time.', rating: 3 },
        { value: 'c', text: 'The teacher is mostly late / early and ends class early / late.', rating: 1 },
        { value: 'other', text: 'Other (please specify)', rating: null }
      ]
    },
    { 
      id: 'q2', 
      text: 'What is the academic / content level of the teacher?', 
      type: 'mcq',
      options: [
        { value: 'a', text: 'The teacher can teach concepts up to the JEE Advanced curriculum.', rating: 5 },
        { value: 'b', text: 'The teacher can teach concepts up to the JEE Mains/NEET curriculum.', rating: 3 },
        { value: 'c', text: 'The teacher can teach concepts up to the CBSE curriculum.', rating: 1 },
        { value: 'other', text: 'Other (please specify)', rating: null }
      ]
    },
    { 
      id: 'q3', 
      text: 'How effectively does the teacher solve problems and clear doubts in class?', 
      type: 'mcq',
      options: [
        { value: 'a', text: 'The teacher regularly solves mock tests/PYQs in class and clears all doubts.', rating: 5 },
        { value: 'b', text: 'The teacher sometimes solves questions and clears some doubts.', rating: 3 },
        { value: 'c', text: 'The teacher rarely solves questions or clears doubts.', rating: 1 },
        { value: 'other', text: 'Other (please specify)', rating: null }
      ]
    },
    { 
      id: 'q4', 
      text: 'How clear and easy is the teacher\'s explanation and use of language during class?', 
      type: 'mcq',
      options: [
        { value: 'a', text: 'The teacher speaks clearly and explains concepts in an easy-to-understand way.', rating: 5 },
        { value: 'b', text: 'The teacher is clear sometimes and a bit confusing.', rating: 3 },
        { value: 'c', text: 'It\'s hard to understand the teacher\'s language or explanation.', rating: 1 },
        { value: 'other', text: 'Other (please specify)', rating: null }
      ]
    },
    { 
      id: 'q5', 
      text: 'Is the teacher\'s handwriting clear and voice clearly audible during the session?', 
      type: 'mcq',
      options: [
        { value: 'a', text: 'The teacher\'s writing is always clear and voice is always audible.', rating: 5 },
        { value: 'b', text: 'The writing or voice is unclear sometimes.', rating: 3 },
        { value: 'c', text: 'It\'s hard to read the writing and hear the teacher properly.', rating: 1 },
        { value: 'other', text: 'Other (please specify)', rating: null }
      ]
    },
    { 
      id: 'q6', 
      text: 'Does the teacher manage time well and teach at an appropriate speed?', 
      type: 'mcq',
      options: [
        { value: 'a', text: 'The teacher finishes the topic on time and teaches at a good pace.', rating: 5 },
        { value: 'b', text: 'The speed varies to a small extent.', rating: 3 },
        { value: 'c', text: 'The speed is too fast or too slow, so it\'s hard to understand.', rating: 1 },
        { value: 'other', text: 'Other (please specify)', rating: null }
      ]
    },
    { 
      id: 'q7', 
      text: 'Does the teacher provide guidance and motivation related to exams and careers?', 
      type: 'mcq',
      options: [
        { value: 'a', text: 'The teacher gives useful exam/career guidance and motivates the class often.', rating: 5 },
        { value: 'b', text: 'The teacher sometimes gives guidance and motivation.', rating: 3 },
        { value: 'c', text: 'The teacher doesn\'t guide the class and demotivates the students.', rating: 1 },
        { value: 'other', text: 'Other (please specify)', rating: null }
      ]
    },
    { 
      id: 'q8', 
      text: 'How well does the teacher encourage students to participate and ask questions in class?', 
      type: 'mcq',
      options: [
        { value: 'a', text: 'The teacher always encourages us to ask questions and take part in class.', rating: 5 },
        { value: 'b', text: 'The teacher sometimes asks us to participate or share doubts.', rating: 3 },
        { value: 'c', text: 'The teacher doesn\'t ask us to participate or think deeply.', rating: 1 },
        { value: 'other', text: 'Other (please specify)', rating: null }
      ]
    },
    { 
      id: 'q9', 
      text: 'Does the teacher give equal attention to all students?', 
      type: 'mcq',
      options: [
        { value: 'a', text: 'The teacher gives equal attention to everyone in class.', rating: 5 },
        { value: 'b', text: 'The teacher gives attention to some students more than others.', rating: 3 },
        { value: 'c', text: 'The teacher is often biased and does not give equal attention to everyone.', rating: 1 },
        { value: 'other', text: 'Other (please specify)', rating: null }
      ]
    },
    { id: 'q10', text: `What did you like most about the class or ${teacher.name}?`, type: 'opentext' },
    { id: 'q11', text: `What can be improved about the class or ${teacher.name}?`, type: 'opentext' }
  ];

  const currentQ = questions[currentQuestion];

  const handleRatingChange = (value) => {
    setFeedback({
      ...feedback,
      responses: {
        ...feedback.responses,
        [currentQ.id]: { rating: value }
      }
    });
    setShowExplanation(value < 3);
  };

  const handleMCQChange = (option) => {
    const newResponse = {
      selectedOption: option.value,
      selectedText: option.text,
      rating: option.rating // null if 'other' selected
    };
    
    setFeedback({
      ...feedback,
      responses: {
        ...feedback.responses,
        [currentQ.id]: newResponse
      }
    });
    
    // Show explanation field if 'other' is selected
    setShowExplanation(option.value === 'other');
  };

  const handleOtherTextChange = (text) => {
    setFeedback({
      ...feedback,
      responses: {
        ...feedback.responses,
        [currentQ.id]: {
          ...feedback.responses[currentQ.id],
          otherText: text
        }
      }
    });
  };

  const handleYesNoChange = (value) => {
    setFeedback({
      ...feedback,
      responses: {
        ...feedback.responses,
        [currentQ.id]: { answer: value }
      }
    });
    setShowExplanation(value === 'No');
  };

  const handleOpenTextChange = (text) => {
    setFeedback({
      ...feedback,
      responses: {
        ...feedback.responses,
        [currentQ.id]: { text: text }
      }
    });
  };

  const handleExplanationChange = (text) => {
    setFeedback({
      ...feedback,
      responses: {
        ...feedback.responses,
        [currentQ.id]: {
          ...feedback.responses[currentQ.id],
          explanation: text
        }
      }
    });
  };

  const canProceed = () => {
    const response = feedback.responses[currentQ.id];
    if (!response) return false;
    
    if (currentQ.type === 'mcq') {
      if (!response.selectedOption) return false;
      // If 'other' is selected, require the otherText field
      if (response.selectedOption === 'other' && (!response.otherText || response.otherText.trim() === '')) return false;
    } else if (currentQ.type === 'rating') {
      if (!response.rating) return false;
      if (response.rating < 3 && !response.explanation) return false;
    } else if (currentQ.type === 'yesno') {
      if (!response.answer) return false;
      if (response.answer === 'No' && !response.explanation) return false;
    } else if (currentQ.type === 'opentext') {
      if (!response.text || response.text.trim() === '') return false;
    }
    return true;
  };

  const handleNext = () => {
    if (currentQuestion < questions.length - 1) {
      setCurrentQuestion(currentQuestion + 1);
      const nextQ = questions[currentQuestion + 1];
      const nextResponse = feedback.responses[nextQ.id];
      if (nextQ.type === 'mcq') {
        setShowExplanation(nextResponse?.selectedOption === 'other');
      } else if (nextQ.type === 'rating') {
        setShowExplanation(nextResponse?.rating < 3);
      } else if (nextQ.type === 'yesno') {
        setShowExplanation(nextResponse?.answer === 'No');
      } else if (nextQ.type === 'opentext') {
        setShowExplanation(false);
      }
    }
  };

  const handlePrevious = () => {
    if (currentQuestion > 0) {
      setCurrentQuestion(currentQuestion - 1);
      const prevQ = questions[currentQuestion - 1];
      const prevResponse = feedback.responses[prevQ.id];
      if (prevQ.type === 'mcq') {
        setShowExplanation(prevResponse?.selectedOption === 'other');
      } else if (prevQ.type === 'rating') {
        setShowExplanation(prevResponse?.rating < 3);
      } else if (prevQ.type === 'yesno') {
        setShowExplanation(prevResponse?.answer === 'No');
      } else if (prevQ.type === 'opentext') {
        setShowExplanation(false);
      }
    }
  };

  const handleSubmit = async () => {
    try {
      let totalRating = 0;
      let ratingCount = 0;
      
      // Calculate average from MCQ responses (only those with valid ratings, not 'other')
      Object.values(feedback.responses).forEach(response => {
        // For MCQ questions, use the rating from the selected option (if not 'other')
        if (response.rating !== null && response.rating !== undefined) {
          totalRating += response.rating;
          ratingCount++;
        }
      });
      
      const averageRating = ratingCount > 0 ? totalRating / ratingCount : 0;

      const feedbackData = {
        ...feedback,
        averageRating: averageRating, // Now on 1-5 scale
        maxRating: 5, // Store max rating for reference
        completedAt: new Date().toISOString()
      };

      await db.collection('teacherFeedback').add(feedbackData);
      
      await db.collection('studentProfiles').doc(studentId).set({
        lastFeedbackDate: new Date().toISOString()
      }, { merge: true });

      alert('Feedback submitted successfully! Thank you for your input.');
      onSubmitSuccess();
      onClose();
    } catch (error) {
      console.error('Error submitting feedback:', error);
      alert('Failed to submit feedback. Please try again.');
    }
  };

  return (
    <div className="feedback-modal" onClick={onClose}>
      <div className="feedback-content" onClick={e => e.stopPropagation()}>
        <div className="p-6">
          <div className="flex justify-between items-start mb-4">
            <div>
              <h2 className="text-2xl font-bold">Feedback for {teacher.name}</h2>
              <p className="text-gray-600">{teacher.subject}</p>
            </div>
            <button onClick={onClose} className="text-2xl font-bold text-gray-500 hover:text-gray-700">
              √ó
            </button>
          </div>

          <div className="mb-6">
            <div className="flex justify-between items-center mb-2">
              <span className="text-sm font-semibold text-gray-600">
                Question {currentQuestion + 1} of {questions.length}
              </span>
              <span className="text-sm text-gray-500">
                {Math.round(((currentQuestion + 1) / questions.length) * 100)}% Complete
              </span>
            </div>
            <div className="w-full bg-gray-200 rounded-full h-2">
              <div 
                className="avanti-gradient h-2 rounded-full transition-all duration-300"
                style={{ width: `${((currentQuestion + 1) / questions.length) * 100}%` }}
              ></div>
            </div>
          </div>

          <div className="space-y-6">
            <div>
              <h3 className="text-lg font-semibold mb-4">{currentQ.text}</h3>
              
              {currentQ.type === 'rating' && (
                <div className="flex flex-col items-center gap-4">
                  <StarRating
                    value={feedback.responses[currentQ.id]?.rating || 0}
                    onChange={handleRatingChange}
                  />
                  <div className="text-center text-sm text-gray-600">
                    {feedback.responses[currentQ.id]?.rating || 0} / 5
                  </div>
                </div>
              )}

              {currentQ.type === 'mcq' && (
                <div className="space-y-3">
                  {currentQ.options.map((option, idx) => (
                    <button
                      key={option.value}
                      onClick={() => handleMCQChange(option)}
                      className={`w-full text-left p-4 rounded-xl border-2 transition-all ${
                        feedback.responses[currentQ.id]?.selectedOption === option.value
                          ? 'border-yellow-500 bg-yellow-50 shadow-md'
                          : 'border-gray-200 bg-white hover:border-yellow-300 hover:bg-yellow-25'
                      }`}
                    >
                      <div className="flex items-start gap-3">
                        <div className={`w-6 h-6 rounded-full border-2 flex items-center justify-center flex-shrink-0 mt-0.5 ${
                          feedback.responses[currentQ.id]?.selectedOption === option.value
                            ? 'border-yellow-500 bg-yellow-500'
                            : 'border-gray-300'
                        }`}>
                          {feedback.responses[currentQ.id]?.selectedOption === option.value && (
                            <span className="text-white text-sm">‚úì</span>
                          )}
                        </div>
                        <span className={`text-base ${
                          feedback.responses[currentQ.id]?.selectedOption === option.value
                            ? 'font-semibold text-gray-800'
                            : 'text-gray-700'
                        }`}>
                          {option.text}
                        </span>
                      </div>
                    </button>
                  ))}
                  
                  {/* Show text input when 'Other' is selected */}
                  {feedback.responses[currentQ.id]?.selectedOption === 'other' && (
                    <div className="mt-4">
                      <label className="block text-sm font-semibold mb-2 text-gray-700">
                        Please specify:
                      </label>
                      <textarea
                        value={feedback.responses[currentQ.id]?.otherText || ''}
                        onChange={(e) => handleOtherTextChange(e.target.value)}
                        className="w-full border-2 px-4 py-3 rounded-xl min-h-[80px] focus:border-yellow-500 focus:ring-2 focus:ring-yellow-200"
                        placeholder="Please describe your answer..."
                      />
                    </div>
                  )}
                </div>
              )}

              {currentQ.type === 'yesno' && (
                <div className="flex gap-4 justify-center">
                  <button
                    onClick={() => handleYesNoChange('Yes')}
                    className={`px-8 py-3 rounded-xl font-bold text-lg ${
                      feedback.responses[currentQ.id]?.answer === 'Yes'
                        ? 'bg-green-500 text-white'
                        : 'bg-gray-200 text-gray-700'
                    }`}
                  >
                    ‚úÖ Yes
                  </button>
                  <button
                    onClick={() => handleYesNoChange('No')}
                    className={`px-8 py-3 rounded-xl font-bold text-lg ${
                      feedback.responses[currentQ.id]?.answer === 'No'
                        ? 'bg-red-500 text-white'
                        : 'bg-gray-200 text-gray-700'
                    }`}
                  >
                    ‚ùå No
                  </button>
                </div>
              )}

              {currentQ.type === 'opentext' && (
                <div className="mt-2">
                  <textarea
                    value={feedback.responses[currentQ.id]?.text || ''}
                    onChange={(e) => handleOpenTextChange(e.target.value)}
                    className="w-full border-2 px-4 py-3 rounded-xl min-h-[120px] focus:border-yellow-500 focus:ring-2 focus:ring-yellow-200"
                    placeholder="Please share your thoughts here..."
                  />
                  <p className="text-sm text-gray-500 mt-2">Your feedback helps us improve!</p>
                </div>
              )}

              {showExplanation && currentQ.type !== 'mcq' && (
                <div className="mt-4">
                  <label className="block text-sm font-semibold mb-2 text-gray-700">
                    {currentQ.type === 'rating' 
                      ? 'Why do you feel it\'s low?' 
                      : 'Can you please explain why?'}
                  </label>
                  <textarea
                    value={feedback.responses[currentQ.id]?.explanation || ''}
                    onChange={(e) => handleExplanationChange(e.target.value)}
                    className="w-full border-2 px-4 py-3 rounded-xl min-h-[100px]"
                    placeholder="Please provide your explanation..."
                  />
                </div>
              )}
            </div>

            <div className="flex justify-between gap-3">
              <button
                onClick={handlePrevious}
                disabled={currentQuestion === 0}
                className="px-6 py-3 bg-gray-300 text-gray-700 rounded-xl font-semibold disabled:opacity-50 disabled:cursor-not-allowed"
              >
                ‚Üê Previous
              </button>
              
              {currentQuestion < questions.length - 1 ? (
                <button
                  onClick={handleNext}
                  disabled={!canProceed()}
                  className="px-6 py-3 avanti-gradient text-white rounded-xl font-semibold disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  Next ‚Üí
                </button>
              ) : (
                <button
                  onClick={handleSubmit}
                  disabled={!canProceed()}
                  className="px-6 py-3 bg-green-600 text-white rounded-xl font-semibold disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  ‚úì Submit Feedback
                </button>
              )}
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}

// Feedback Notification Component
function FeedbackNotification({ onClose, onGiveFeedback }) {
  return (
    <div className="feedback-notification">
      <div className="flex items-start gap-3">
        <div className="text-2xl">üìù</div>
        <div className="flex-1">
          <div className="font-bold text-lg mb-1">Time for Teacher Feedback!</div>
          <p className="text-sm mb-3">
            It\'s been 2 months since your last feedback. Please share your thoughts about your teachers.
          </p>
          <div className="flex gap-2">
            <button
              onClick={onGiveFeedback}
              className="px-4 py-2 bg-white text-gray-800 rounded-lg font-semibold text-sm hover:bg-gray-100"
            >
              Give Feedback Now
            </button>
            <button
              onClick={onClose}
              className="px-4 py-2 bg-transparent border-2 border-white text-white rounded-lg font-semibold text-sm hover:bg-white hover:text-gray-800"
            >
              Remind Later
            </button>
          </div>
        </div>
        <button onClick={onClose} className="text-xl font-bold text-white hover:text-gray-200">
          √ó
        </button>
      </div>
    </div>
  );
}


// ========================================
// STUDENT SYSTEM CONSTANTS (ADD THIS)
// ========================================
const CATEGORIES=['General','General EWS','OBC','SC','ST','PWD'];
const STREAMS=['JEE','NEET'];
const OCCUPATIONS=['Government Job','Private Job','Business','Farmer','Doctor','Engineer','Teacher','Self-Employed','Unemployed','Retired','Daily Wage Worker','Homemaker','Others'];
const EDUCATION_LEVELS=['1st to 5th Standard','6th to 10th Standard','11th to 12th Standard','Graduation - B.A.','Graduation - B.Sc.','Graduation - B.Com','Post Graduation - M.A.','Post Graduation - M.Sc.','Post Graduation - M.Com','Engineering - B.Tech/B.E.','Ph.D','Diploma','ITI','Others'];
const INCOME_RANGES=['Below ‚Çπ1 Lakh','‚Çπ1 - ‚Çπ2.5 Lakh','‚Çπ2.5 - ‚Çπ5 Lakh','‚Çπ5 - ‚Çπ10 Lakh','‚Çπ10 - ‚Çπ15 Lakh','‚Çπ15 - ‚Çπ25 Lakh','Above ‚Çπ25 Lakh'];
const EXAMS_12TH=['JEE Mains Session 1','JEE Mains Session 2','JEE Advanced','NEET UG','NDA','BITSAT','VITEEE','COMEDK','MHT CET','TS EAMCET','AP EAMCET','KCET','WBJEE'];
const EXAMS_11TH=['JEE Mains','JEE Advanced','NEET UG','KVPY','NTSE','Olympiads','BITSAT','VITEEE'];
const INDIAN_STATES=['Andhra Pradesh','Arunachal Pradesh','Assam','Bihar','Chhattisgarh','Goa','Gujarat','Haryana','Himachal Pradesh','Jharkhand','Karnataka','Kerala','Madhya Pradesh','Maharashtra','Manipur','Meghalaya','Mizoram','Nagaland','Odisha','Punjab','Rajasthan','Sikkim','Tamil Nadu','Telangana','Tripura','Uttar Pradesh','Uttarakhand','West Bengal'];
const STATE_DISTRICTS={
  'Andhra Pradesh':['Anantapur','Chittoor','East Godavari','Guntur','Krishna','Kurnool','Prakasam','Srikakulam','Visakhapatnam','Vizianagaram','West Godavari','YSR Kadapa'],
  'Madhya Pradesh':['Agar Malwa','Alirajpur','Anuppur','Ashoknagar','Balaghat','Barwani','Betul','Bhind','Bhopal','Burhanpur','Chhatarpur','Chhindwara','Damoh','Datia','Dewas','Dhar','Dindori','Guna','Gwalior','Harda','Hoshangabad','Indore','Jabalpur','Jhabua','Katni','Khandwa','Khargone','Mandla','Mandsaur','Morena','Narsinghpur','Neemuch','Panna','Raisen','Rajgarh','Ratlam','Rewa','Sagar','Satna','Sehore','Seoni','Shahdol','Shajapur','Sheopur','Shivpuri','Sidhi','Singrauli','Tikamgarh','Ujjain','Umaria','Vidisha'],
  'Maharashtra':['Ahmednagar','Akola','Amravati','Aurangabad','Beed','Bhandara','Buldhana','Chandrapur','Dhule','Gadchiroli','Gondia','Hingoli','Jalgaon','Jalna','Kolhapur','Latur','Mumbai City','Mumbai Suburban','Nagpur','Nanded','Nandurbar','Nashik','Osmanabad','Palghar','Parbhani','Pune','Raigad','Ratnagiri','Sangli','Satara','Sindhudurg','Solapur','Thane','Wardha','Washim','Yavatmal'],
  'Gujarat':['Ahmedabad','Amreli','Anand','Aravalli','Banaskantha','Bharuch','Bhavnagar','Botad','Chhota Udaipur','Dahod','Dang','Devbhoomi Dwarka','Gandhinagar','Gir Somnath','Jamnagar','Junagadh','Kheda','Kutch','Mahisagar','Mehsana','Morbi','Narmada','Navsari','Panchmahal','Patan','Porbandar','Rajkot','Sabarkantha','Surat','Surendranagar','Tapi','Vadodara','Valsad'],
  'Rajasthan':['Ajmer','Alwar','Banswara','Baran','Barmer','Bharatpur','Bhilwara','Bikaner','Bundi','Chittorgarh','Churu','Dausa','Dholpur','Dungarpur','Hanumangarh','Jaipur','Jaisalmer','Jalore','Jhalawar','Jhunjhunu','Jodhpur','Karauli','Kota','Nagaur','Pali','Pratapgarh','Rajsamand','Sawai Madhopur','Sikar','Sirohi','Sri Ganganagar','Tonk','Udaipur'],
  'Karnataka':['Bagalkot','Ballari','Belagavi','Bengaluru Rural','Bengaluru Urban','Bidar','Chamarajanagar','Chikkaballapur','Chikkamagaluru','Chitradurga','Dakshina Kannada','Davanagere','Dharwad','Gadag','Hassan','Haveri','Kalaburagi','Kodagu','Kolar','Koppal','Mandya','Mysuru','Raichur','Ramanagara','Shivamogga','Tumakuru','Udupi','Uttara Kannada','Vijayapura','Yadgir'],
  'Odisha':['Angul','Balangir','Balasore','Bargarh','Bhadrak','Boudh','Cuttack','Deogarh','Dhenkanal','Gajapati','Ganjam','Jagatsinghpur','Jajpur','Jharsuguda','Kalahandi','Kandhamal','Kendrapara','Kendujhar','Khordha','Koraput','Malkangiri','Mayurbhanj','Nabarangpur','Nayagarh','Nuapada','Puri','Rayagada','Sambalpur','Subarnapur','Sundargarh']
};
const AVANTI_LOGO = 'data:image/png;base64,UklGRkpLAABXRUJQVlA4WAoAAAAwAAAA2QIA+QAASUNDUMgBAAAAAAHIAAAAAAQwAABtbnRyUkdCIFhZWiAH4AABAAEAAAAAAABhY3NwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAA9tYAAQAAAADTLQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAlkZXNjAAAA8AAAACRyWFlaAAABFAAAABRnWFlaAAABKAAAABRiWFlaAAABPAAAABR3dHB0AAABUAAAABRyVFJDAAABZAAAAChnVFJDAAABZAAAAChiVFJDAAABZAAAAChjcHJ0AAABjAAAADxtbHVjAAAAAAAAAAEAAAAMZW5VUwAAAAgAAAAcAHMAUgBHAEJYWVogAAAAAAAAb6IAADj1AAADkFhZWiAAAAAAAABimQAAt4UAABjaWFlaIAAAAAAAACSgAAAPhAAAts9YWVogAAAAAAAA9tYAAQAAAADTLXBhcmEAAAAAAAQAAAACZmYAAPKnAAANWQAAE9AAAApbAAAAAAAAAABtbHVjAAAAAAAAAAEAAAAMZW5VUwAAACAAAAAcAEcAbwBvAGcAbABlACAASQBuAGMALgAgADIAMAAxADZBTFBI6R0AAAHwhu3/Iyf9/z1nd9MbGBJ6E6RJ70Uw0qTXhbdgeSN2DVWk+OYNKiBEVEAMKFUE6b33wFvjGwh9gSC9VyGkt9153JjZmdnXvGbG3VsRMQEUGOxoMWz+rosPs925D9N3zB5ciQLFg/utzoTai1PqBoKVmHQf2qb0EQK87COeQPuTnQO6ah2Db7dUCNwakA1fZ74TqDXKAwaXRQRkjQSbZysFYLV3M4K7jQKuYu6B2ay2gVZzwXBOQmBV5SKWkNs6oGou2H7yYgBV6FNNMjZPeatbu3ZdBo6ek5KhArfKB045ob54TXsHKbU1n+xShCMhAVOL1e2uQRo2/jlfAZaaFyG+cbch46bPX70j5eiJM64zJ9IeZVxbN2vSh31aVXL4426qKR4pkLZlZhd5w4cmJL594pwdF/PgS/ftw4vH93re5k+Lh8qivqR9jT3e8uubirJ9vt51H+zmpM4dWtfmJ+uo5k3y6ZBncrgQYRZqffjbLegxc+/El4L9YB+qmEc+rnZCDskmwN77u4O3oOfsbcOe93d9pexsmK8o9Dc58RWjqzj8IHh4M+0NwZ/1k6Kc2uR7YaoMrkUaWbnRx0RwM+O7pv6rXxWNIybHyuB7wwp/Y78HnL34eXk/1Voll4LZoNEyxfWNqV5yBnjs3tnL7o9arWQwsTpNgj8E43G89jv4fXP8c/6nxQruBzEjLJHg30YT9ekN8D13fnV/0w8KfiR2g1MldyIMJW7qU/Dfva6Rf2m8gr4MUZk7ADDZQErPzIExilua+ZMGeRNLsUQvuwHklDOKktNyYJziphf9Ry29pRPbkwFgnjGEjHkKY/X8Ut5fFOH2sokx+1EAhVWMoN8VGG/O5DD/EJ33MpMxqp0PYAn/6uyDMd9w+od+8fIZazQeQHENzoVPL4Jh763uD3rLy9vMBZ0HsJJrUZMyYeR54xz+n3Ki3EDmKEEEPHU5FnMbRn+8vt+Hzsj1YY/WA1jJr063YfyFE+3+nv/K9dBBHTfgrsGpsLkiTGHqC36emnJv64CWAVjCpxddMItisn+HTspM0sPzRUBRFR4NzYWJdIX7dT6WWaAHWgQgmT9hS2Auz9b050TnSHbpoloxkBvLmyqnYDYze/lxaIHEpQtaBuBzziQ8hvn0TBT8N7U9AJ7po5YHuBvMlfeKYEpXhfltaBMAxOuCtgJ4kyO272FWj5b227SUvKmPdgCO8SN0Hczr1Rr+GtoNYLU+KA1AQ16U+B/M7OPm/prGIvDUoY+3AczlROlTMLfZHf00tBZAO32EPQGehnGh4iWY3YLefprqOUCSPugHAIN4UPkqzG9RP/8MDQEu2/TRHMBmDlS+ATNc5PTP0G9AP33QJSA/UncVr8EcF/X2z0RdxnmHPmYC6KO3Mpdglgu7+mWoaSFG6eMVAD/qrOQZmOfcNn4ZGo2cGroIKwJO6Ss8FWb6WX2/jLADpyP1QKeBwiA92TfBXN+p5I+h+HvYEayHbQAq6ykZZvtcjCEIdd5J3nX88s2792//lbrqK2f5f3qovQc7I3XwK4C6+rGtgPne6+Be2SGrH0H1xVkvCf/o0FTgTC32lgGooJ+DMOPzuGZr+eUJERpf/U+cT6om6vb7tWvXrl2ZqMuf1q5duyiR6Slr1/6ayPzEtWsnJPJw+PZVP3ye6Mvv1srPS1R8FMhL9G1LX9TIMWV4n1uOLksewaf5c8v7IDoL/8RP9UHUeZjzwtZ8avnTI/g+d1qkZvSjf0FYB7N+tzSHeh8Do7d7aVZb9CuMgnnfb+dNxC4wvKykRrTPn9CiyMRhKW/s6Szhzssa9fYjRF+FqR/FGRrEFIrHCJrYr/sPVsDci1U5YzvHFLAmXAsa5zcYCLP/G2eoP2M4Gq9FbJ6foNwT04d/cUY4pd2dbTMTB/cbODjxq6WpWd6QXkEDWuIn2Azz/yiOL9RLmyerhlQhxY6mX16Ww+WyGjT2DwyGFVzDGeGYuqcLOgeRhjbnDRm4SqijlWnaXlBzN03lrdzc3NysNF0+zM3NfZym+LiaW2mqL+fmZqQxfyE391waP7NUZKYpPp0rez9N4XU1p9O0/EiL2EeWAD35Ql1UiHtfCyWtI9bK4GCQOq2bqfmC+B2sZhSZzwMq9pCPh6iJI0YXwxrejOQLpSrJm/0C+VJYK4M5/oi2okXATM508FYwpyz5OOaBjNjT/2A/BatYVJsvdEjGvagi+X68DB4853f4BNZxL2faSnbWJRYrymGhv6HEYwuBHnyhfbjVhxi9Iueu72eYCSt5wcGXVquiiNVtcljvX6hcYCnwAV9YXuTFU82vsATW8m6YQSV7QZI/obbbYuAzg1rs7ZbgR1gFq/kowpi2ekNj/0Ftt+XAWGO6oGCs/2A1rOfDMCOK8SjY4DdoCyv6iRH1h8KL/oIK+ZbkusOA1ikpFPwEJYstCQYYT+ViJXjOTzAW1jTVeJZAcUX/gP2mRUFTo2njUVbZP9ALVnWxwcRchvJY/8Auy5Jb0lAc26E8z+YXqOyxLEg0EvtyqDxDfoH/wrqeMJDQDVA73y8gXLUwqG8YFY9BdX+/QBtY2W+MYuATqM4ONxD7c1UaJvR6bciHoydMnPTltMH/JPxoabJshlBlEzRcQAYQ0WTg+J93nLrvhsqcuH8O7A8tDUYZQMmkPGjoeZFzQv2Rq9Ld0HrGPwevwNre5V78tGfQdAXxzJYw/wF8mhVrbI5afRInTmf9Bq9+tDh3BK5FJywtgLa5VTgW//lV+HyKgYW/uSED+ueHcMfioBmvynT5fN1lEZqPJW7Ff58DBp+VMKrYbzLBRX40htX9kj9Cdee0Xffh21QHr4LGZYLNScYkfPwMnOTHJMtzgiuOhkNmHc6E7zMqE6dqHwerT6KNKH4/uMmPPy2PWJonoZfB5uvEKWcW2J1gQC9eg+mIKbY8eJ0n1FFkYhlxapgHDD+ONJxGT2A++sD6LuUK/cpCaiinEsH2Z0ZT52+YkNkW6DpbkUNb+Sjub9+llSA+9fQw9iDcWGKvwIycskCozI6QsDQ7N8xH9LbPtscQn6o8Besj9VKrax899j0NM1LCY4XeYGcZgD/J10KKjzxNiVN74UPPzQMLvhw+uEtC66ZtB49P3nbmmeRuqC5qnoAp5EVnWOFkdlYBWO0zqlngG1wvxacB0PrRb8Nbh5Fq4fmBSfuefKKH0KuwEpMt0XF2JgFY5DuarJ37OgAcDOaRPV2buzNa20l7IVYP/4KluGKJikKZ6QLgFwZC0jVyL68VewMAVggc6gUt9/RwELPsfM+V/NP7Nm9i9xGPusMaN2UmshDYyAC9LGqR8V01ImpWAAA/CIzELGdopwa/tySW2VnGjwdfN7cT0wd41MoivccMHQb+ZIEWqfIcGBJBsh9KMEtgotsdsFOySFXGvwXi0lxeiF+HEOtc6mSRfmRnDPCYidiHinK2fVyBFC6XYEWw70oshXpfDILatCrEODtjOZHVj9jn0giLlMJOdQCxLNDrcgWuNaNbBpPyiLMSpFX3Vfc7YGq+mk1hxKuX+fBXHTIHCyzSQ3boHPAqEzT03Td6t6xsJy1rZEqQNdzui/oboKkvTqhY7yBuhWXzYGsMmYTDFgkl2ZkGTGLDpx/IAKd6CBoJHbd6wJgtV9mfIcQvWsWB9QKZhbtWqRk7zYC9unNckANODI3QoOakv6C5D8pD8ZPyxLMe+rtVgsxChGiVBrEj3ERemN6ovzcga8M7dWzebFUHzkmHL33QRNkQ4prtiu76kmmoA6s8gR1KAjrpzpYOIPeJRJrj2rZ84cIVe1y58LUPOik6LvCNRmo350PN1ytLJfPwqmWaz1AjYJbu6D0AmH3YC8M+6KmoN3Eu4qFmnUnz/yrrbiLes0zbGaJ0XBd0F5kJoPDFL93c6Kvkho13NIa9qYpu2U3EJMt0gqXJQGPd0QIA2EcJd3jRXcl04l74beYmKppNJiLZMt1hqSYwTX+dJOhGpbZzIkFJa/7RW8wNV9TVTKyzTEUCQ3QC1wTdBT2VHCUS3rrFhfoKcoMMwJbGWn9FpczEQcuEaJbGAC/pjjZK8CoRhY15yIFSCo6QAVALD2NNlDwgM3HSOlViqUwxftLfCJntJI0Yfl13lO3tF0OgZMYiPAqOmYpr1qkBS7QZT8N010rGU01CZO+xuUiLu/OHs3PM2xRjiLnHFl1SsMdUPLJO7ZnqBbyhu2hRgq/liKjU+7vylLjTV49sJFAzdhZ6G2UM1I+x5Qq2mIoc6zSNKcc9HNYd3ZG5IXgjorCOkxb/nDx93NBudUJIlqGh3j40CFrJ1kcKtpsJwWOd0pii6RBr6u6IDNoq0pKh6t4+MIpSD5iqoWCfmXDAOnvimKrixizdbZb7jhd0ycsIo6BeIkt0w1uamQi1UKnBTNEWZETobYXcZW4keflKL03Zo3lM/ejtmpmIsFB7ie1OwAd6WySH6rxo6GWJPkImF+kg7BxLHb3lCyYi3ELtZky4iLN6W+LlPV7Qcbkjumh7AaqZoHo5DAU99oIyJiLEQm1jjD4BOulslZcV3BgqlxfKXuxCEfqgwQzRPG9tTITDQm1kLfwxDutsi5dL3Ai+I4POrDmGP4GWjNAchl7y9r6JILd1WsEafQm009fvXsSSvKBP5JYy1ukctGXFsYsd4S8vc81EsXWaz1x8Hvbp64YXtONG8BWZnHiWam2E1qxQ1GlmaJyXIyaiNKzz18zRfKCznuzF3t7nBvWUwWx26qzyQG9U/jIzZQrl8kPMQ0ePdfqYvSqFOGXTUTV4/44ftFHG3YKR1ms88CE7VOEyK7RSDm3NA52wTh3ZowXAv3XUX8F6jpR5LMHtsgyEvpUG3zJEZdO8NfVRay+TTMRe61RaB1UK8aCEfmYqOMoR6i5KkF7RR0K7nzPga5YobKHcWcFHlCb3h4lYaZ1IjwuAefo5ruAWT2iGDJ68LmgX3HnOTTDIFFGH/wO4XY98/ZqcO9Y8zPpHo2IePC31UsajIJsr9p0ywKmh0VqEvjR2axbYZIzohb4dQsnnjhsyeMM8jLdMHl3QDOCvCJ0kQmkQTyjqpByQf2Cys14pQSJE1Wj/xhdrXIVglzlGE+U2m4c3LVOePkr8DczTSZqiklyhspe8yLuzn2Tki2CfT2EPZPKjTEOCZXqoDxoFiH100QKK4/lCFa8q0y2faJwMhpiGapbJpZPgdCCzph42KCvPGSqfbloiH8scNA1BxVZpg06oI4BzUew1E5WV5Q3FperhiCHQWBnP82aBrlilEXqhNQD2BrNmS4Xyktyh0BXMFU8KM4aIhxJMNw27rVIZ3VTIBrBCYGwYlHts/CEaUcjWniYUbAw0XOZhiFmYZZVIvx8DwAIbU3XzVNwjHlHjCwz9rx2RYQRfleAts/CeRSrUke0QAPxqZyj2MlT+yScKmVLAyLFuJDUKGiRz0iy0tkj3dETVcwFgexQzEalQu5BTRNU3iQykdCZ5wxCOS/CKSYj0WKPdeqJPJHBVZSQiBao/4BZR8y0e3+QtbkTeDYM6yewxCXTRGr2jK2GLBBmDmIg7AvW1OUb0QtIDzcTD75cgpcZBeyRoYhJWWqNgXVHsbQmwsrTvmt6A+uvENSJ7+x8uafBk0/vlSKWBNPJINpuEEZaomHT+crEMno0M8o1jfCE0/IZ30jK9J638/+1sAGJm+r457zawkXoDoQUSsYk5aGmJ7uqNEuWA6x+H+ODl09BSrGUEXm2hoQJpbiRxGQCwwxyEFFqh1bqjn70A95NqaWPrsg/a7iYD8a2R0AgJ2pkCSrdCDfTn2OENwOlpL4WqcLSefg1at7FgQecl/xdMwVELJBIHI44qAVB8ZvmU9/t0fql1B+fIOfszof16smDUSYL+puCMBXrIA4o9o4zZZ+UtGW2SXA0xAUKWBVrBBSp9Xg+DyJo9nwsAY01A0NAM61OZDxR3kr0fyKLRWElmWeMjOm55ioiXJVJY2+SwbI4TALDCDPS0PKe4QcG/sLU1hCwbNSoCILYzASRanQH8IBpZxNDSILJwNBUAXEEm4IbFEYmrra+zUvwpMWlhQs4DwKcmYITFucoXil4qMnGpJVk8au4GkFXe+MjivMsZolcu+K5wehhZPpoBAGtMwDVLIxJ/He/f8Y1n9QvErKUJPQ8AXYzvDUtznkNEIe+e1y4ruRYxbGmoWTGA6xGGR24r05lLRNTyx9taZK4fFE5MWxuaCgDfG9+fFqaQ+C00GrnmfKG3x2nLx7RyEOsWJ/g0AHczw6tuYTZxTNZWpkHLdi3rVwsnfVocalAI4FyI0dEz6xLJO71bHRoPAEmG91/LcovMbaUHhmE/ZUz2VADu1mxsZatVNlPksSq9TQ6V3mUUFDLXkKh6NoAr0UzErGWKapxiaq9FySPTK4wpNAiifk+NiN4DgDVMEH2YzxKFJrMUaVG+Nj9Ejf8yCqpyxIhoCwC8zwbVT2eJqN9TduiCJXGTKY5cahQUlCQaUPxDAAVt2KDIZUxR1SPs1LQka8wR0eBMgyDq+sh4qIcI4EElNojezGaJgpJEVuiWBRHtZomeP2IUVC7FeGg+APxVjhGqdYYlom6PWGlsQbaTeQ6a7jEIsn/hNpyIiwCQXpkRCk1misqlMEJ3LIfoMFFE7e8aBFHCXaOhpkUA8PjtMDaIBjxjiexfutloZjm2krmO22YUFLfDaGiCBMmhrFDVIywRJdxlgq5aDI/dZJEwfIJBkDA20WDsh4CMfsRw0MzdLFH8biYqW4yfyXw7jILIYTBUKeNIVWK7GlNks7NARyxFIfkTGwWR4YeJVuITv4Ip/MlC/E0Bh3nWoWHgQR/L8AcFIF6wCG57IEK4aA0SKSDxP5bgOgUo3rYAYlSgQqxo/j6jgMXPTN9lCmC8YPLcIYEMjiJz15sCGl8xdRsowHGeiXtEAY+XTJs7OvDBXmDWOlIAZE3RnE2jgMhBpuwwBUjONmH3KGDyoOnKcwRO0CWT5S5FgZR/myqxPgVUOnLMVAcKsIwsME8DyGj7OqVVNHjV6XQ6K6vo5HQ6nXHq6jilr2rTw+l0OnsLSl5wOp1Ou4JaTk3rKXA4nU5ngm9qONW+qKi0U21HZd2cTmcvrao4nU5ndR+VdH6z/sChrXPff0GDik6n09leQWen0+ls4q200+l0NlMT1nPGhpSDWxaObuPQCT1XZJaGktE2hexSDRYDwE/K4ooAZEeq2w+pu6wm9yF9T8lIAAhTMAGaJimIBIDfffMZ1E5R1AVqTym7AeCpVm8DwAifNF9fCO8n3rKrqQcAGTYvYQUA8Lu3TwFguLKIKRnw/mSCTiiuyBx9Qob7vVxWuLr2kkcORcMAYBGpLueWwRgfZFayFtFLRCg/WVeFcB8A6nlpD2lesJftkmqKXrgExd/qhUoVmqF3yHDt9+QwWJ3tNgB0UnRM0lrdaMif8QH2CVaicjrkPW455PZQRiskH3iZIoPmco5MAOdJaakbUN5KNxSTb34Gk/F2BHD7OoBd6ugbyUIltQAgndQfB/A7ADTwAT7SrNtC+VTJ7wvl+7O3a5bCburSZikcw4ey1yBNea28IJQffFiCgpeVDZH86uV3uRFyLQEgSdFCAMie2rJcpYaD5927I+iHQjJNjtiVDHgJgMWzAbjLqmsg+TtIwVTJZ+pqAfA0EgF8q1U2gOyqWnn/SPI+qWdmMGksM4O01o39MABkDySvr+UAwIN4RRUlV+TCC4EnAFbJTZC0VRJdACCvAck76pGe7fdMjacpGXBYJgBnAgCMVkcuAOjiTbgOoLiMuq8ApNFRAPfsGk0rBpBiswofAUD+S6SwbQEALFREFwGgjEwnAEsA3JDbC+CJQ0l7AFhBvDxlYgrKkRE7ARTG2B8AOKXBeMkSby8DwGZSLVwB8AWNAYBXNUpcDADDLELIPcloUvyZpKiioh8l/WS+BtBdBFBeEpwLYAUpHSCZzw1aa1oeB5MhbwKwh+gHAKinrpIHwNNgLwslvdS1BICGVNEDYIVG4yrmAcitbg0GAcD1IGVB1wHgc0V9JN/J/Al4oq4C6C9pBwCvKeokuVuSGzTRpBwnYy5ZAGAoUQvJTHV0CAB6yIU+A3Dfoe4HABeJKAVAbpQ2k2gqAPzPZgnWSyaSyomSVEUl3AD+L4ksAs7SRgDfSiYDKC6hqGQRAJxpwg3q4DYj88mg3wVQUIKILgG4a1f3nuRXuYEAkESqHQ8BfEFE7wLAv7WZRlF3AWCUQc0to9DBg4eSJmoaSwrsSugIgMIwIuoCIJkmAEiVHAKQQsp/kUDcMyCcE1TiqekQ+5FRpwDYTEQ0GQA6qytZAOBZqMxWSS11XQCgFhGVyAewX5skosGSvBpENJxPxzd5n6CB4nociAWA4iA1QcUAUEnRVABoS0RJAAZSBwD5IURhBQA+VRF3TQIge9krfCA6bDIyy5JRV/AAeE1SXQSwXB1tBIDekrgiAH+Q+uUATpJ0PQBPRU2+JRIOAUCKQDSMT0o3866e5C6pviepryhBMo6IjgKeUhTlBtCSqD0A1FRBldLkAKS14wMNMxX7ybg/A5AdLqH/A8iJVNdfskqSCABD1YVnAxgr0xcAxmsyi4hqFwLA20QfmrzmkqvqbkkaKArJBbCZKLoYOElEpwAMI5oM4BKpDh792AvEGTYuUKVnpkEcSgZ+CsDGErLjAeAtdaEZALLDiegIgOxIda8BEOuXkMZnAjivyWwioimSB9H0jvHcT1NYnQP1JI/UZUqqKqLdAB4QdQXwLRElA1hOtB/A9+qIQt/cVSQDJPGBaItJuB9LBl4Hqvepo4UA0JeoqghgManfBtVNtJgjCTkPAN/QYD5NbOq9ugYzSGudxErEGDXxAFAcpGwMAFShaQC6EdHrAC6QIxtAey2IqOTQEzKehpyghEIzMIsMfZo6T3l1CZLlROMAoI262CJ1szWjFm4A+RV78mkwacwjug8A3dT0k5wk5Q0lA+kwUBRFRFUBeCKbAngWpBGR8FY+AMziBdFBw/u7Mhm6cE0dxqqz3QLwxEFHAVwU1H0E9Q8dmtG3ALDwZbO3SrJczRrJNyqERwBmBuUCqSS9C6BNIoA15MNEyRF+ULtcQxOTyODbAEDadK9rJC51lAQAbSuIAMaS+t8BiN9O9/oQALprF/YXgKKuZq+vpLC6sheKJQ1U0CoAKY0BTJFZD+CT5QDe9EW85ApHiJYY2KVoMvpkSV/yGpMPAI3V1ZdM+xBAcRl1VUQAR8j7LMlq7aidB8Aqs+e4CgCHHErshwFgD6l9F0DmhwDay4wC8PMFwF3KF+UkZ7lCcVcNKr8PGX7QYwBZYd5ovWSWOjoL4OhmAFtI/QQA+FRBM0lejHY0F4Db7JFTgt+CvAX9CgBFdVVVAYAUID9UpgWAs27gD1Ld2K5gnGQ5X4i6ZhuQmEwmsDsArCSF/SQPHOrGAXDnAuitgQuAWEkBXQKAd3wQeQ3yxvJdpNIgVZkNlcar+qahwvqK6DcJjreVa3UU0pGk/jJkD5BscB5kx6sS7l2eWEsm7NNiSTfeEE0qNpqDDjKDv0n6KgnNAIBu6ip6IPsgSF0DADhCSr+QHPIBdRSNSPkHqpSPVaU4T1nYIQlw7qfxY5NdkJ1JGs6X+48c/U+urqpGAPDg4OrVh7IgPSDwh2iBx0jOxJIpjMgBkBWmhBZLVqmjFLlvSH2S5FNFNSRiFR/QAitAYStllBYMIy2dcq28zJC5Tqo/lyi9EE9ctq3yGMW5CmQSXweAlaS4gyQvWt27crXU2W4CECspouMA8B9fxNy2AkT/uqFsz4uk6XMeSVaQl14yc9VNcisSV5Qkbi8sNoKT5ck0zna5XK6uyux/uFwuV3d1Jc64XC7XWlJf3+VyudaR8vdcLpdrg6IUl8s1Xgl1dUlDNPiXy+VyOTUId7lcrl9987bL5XJ116qNS/UARXtdaocq6eNSe1wVOQZs+FvG40qqT1pvcLlcrgXkNc4lTVBHlccezJYRL8+tT1yfmMM5z44w8hsLFVp1bFc3knhoq9yiY0LDEsT/V29yLHsaBfpGbS3iknihOQUE97ws8uZpEgUQj7/LkeyVURRoPPKahwd/L4mhwOR2B7J1VXR+JAU024amZhbrofDSjCgKiK42bueNQmbcGbc39aMA6/DuX287/7hA1K742fXDP79bkQK5Y9oOmTBr+Y6DqcdOnjl9PO3w7g2Lpg/rVpkCVwEAVlA4IGorAAAQvgCdASraAvoAPlEokUYjoqGhIzQY+HAKCU3bHWGkMHFp9R1ThkjSg/rW6tcxnKv9N/ADN5N2vAH7Of2TPBNgP1u+ED8ANwLR39P/mH4MfsB/meAA9ET8E/2x/2NrgZfp+u/hL7OSIyw/zvXwW97R/Yv2j/xX7ffL5WP7t/XP1l/afb13W+Jf4TzgPHf0j/Uf4H/H/sH82P796lf0T/0P7H8AX6ef7X/Df4T9hfrL/Wv9H7C/2u9QX9U/yH/Q/xv7//LB/fv+X/fPch/Zv8v/wf8b8AH9G/uP/L9az2D/3K9gL+b/4v/q+zp/r//h/nP9n///ov/Zv/3f6j9//oU/oP9y/8P5//IB/1/UA/9PqAenf1y/u34r/sn9IPHP9f9YHd9fNtCrKX2Va7Xenn37FeAF4w3mMAX1p82b7nzJ8QDgPvxHqD/zj+/+sf/w+QP9j9RX+Yf1/rF/vT7Kf69q/0FPbMAkmNKntmASTGlT2zAI/b1eFq85sPbL/kd3KVysZ3zApf6IHmIXgILhUwBhlioK+qgGNz/twxLYN/oKe2YBJMaVPbMAkp5dy9i5rkCAHZBKH03esz5mDM8/Vw+hjxIpv9vWwt8aO6qGAPWoN+pS94ayZkDRSaPFv+m+nixJMaVPbMAkmNKntlXdKXD1q+0qsq/pYZQoDlOF/oYEPA5pIO9WPBUkNnY1FoTCQ1M6CUd1O8YEm5vkO3Dms4D1w5unN7hgmmVb7bd9tu+23fbOHHYUEjoDXpDSvqB+TX6EEngaEJEAlw23CzoLxrLWKwCKl8oHSgEUu4LQ2CTDY1oTw5RcDpgXs2g1aYMrpMQ/N8cfDGuUYBU7mv2e4FYGx8DP7GuJYK2hWtPrOSVzNfyYQNxQfemfLhx2PYKvYMUCQjRS9WchyqK2FLO+qcJSl0pbRrmm/S4blY+PEoGq86KF2Y6kCLzmhRErEmNKqGRQ60w+LPbFZPGHWqDWAoYq2ZHCVxx8pOlMxcQ1hENcEDp1p2WaBBq+5bLyssW6AdPD/9rH2wCAWzGgJHqvO63eQmGKOl3P0qu5QFBgO/irACkL3yqhLMcfGkpvnckWjoQcMUyCqnGwrNlN4I6maptnSqK4RDoRq6uxuGsMKSQXPb7eeYrz0JlvP7Sr1YSOsZ/73+8mqrJP8t1TjfUu2bisb/hgGXH/Ot21jXGwJlfr1XgwXFEmVlOfvHMb38BRzTKyxo+lbVG4CluYpquesdlA/ELur4kVGua6jA2fCIB1oSW+Vuhk+AKh//T7EalmLEc7LZH3aBi9/8R/TS27Vf7wOPoB0xqKi93lnHlPpcdlJBjRBaRHN59v3eqoI1mI6y0L/l+POPlSwWlLTHYIkGno8cKFj1vAUcAiHhUBO5/1bHdAoy4ZovrzoRchN+ffUX+7qJv0bl2HLaTvQqP7/UsjX6kRfG7fPn5g/cWQUnK3tXcIeMN1DRJhOh6GZyj4oDdCX8i+a/56EbccldqJycwYiZMQMgNnNc1j4bmCXDociW7Z9gDq2UuMt2dOpiMjVKDNNrtAXebTk/MNLUWYAYn0pyKTAiLlrqPXbTdguhWxIZNtgapvPpDeCURibSdUhGGRvoHR043hxDcGEjOqegZRX+5+JVqULgigtkX+YNvXQ8UOSVSWjjD1Gyc4RKGpMFPOI20MKZlH7Q1CecCHQgZEtdEK3FnNxwy4Uzd5LYssl/VAe+zAJJrR3NthHbnaFsFCvuOVK4pSGajqqYL+Z0NtflJYiCVxx0ydMRUFlpUdnWLOvwSjGnt/TNXFY8qH7qM5SXq6tFdvQrJd2gRLE8A4PMQcuSsnX0Upc5J8x590G9b1lRgfjc3QzsBDvBE+usC+6YzVPFf6f7DhT7WXG1cLxk//FiQU9l+rGu4zGTQoOHuqMGgKCLwmqS6Aq3YaMB4kUM+XdBvYh05FrMYtBeyN82BJ1vSy2sABtzDnkJepnqzUz+9HCD4rWjY/TOzNBocc12L+mnx2SNOPvhKX3xO49U/0+EF5g2IAOwcHquDrNMxAJ94du8OvgAD+nyUAAAdgON/WOpxxVjAYj30ctRK3DM72dhtViVqlxbS+QJPKDkrV5/8G+7QLmopM23DFJJbutON4d4l8JNFMJN0JwrP02sUWSzNQfr7fQEkN4mwAvyzXbzMDv6tmjnWIPJgKLLxcfF4ip4GhaWfJGWuv583kGkjqs/lpgxlVldebQ3wirQ/WHdCfijjetbipruC5WPHJ+lhAWbTxy13SKG8zGHGAFn4r3SSuisNfo6/ZYm3UaUuzprm5XhikC9qqJJTky0AMElaeQO/nc9oPZsV2joGHH2tlR7TCDfPjOUivdgaLRE18f7Uk2ybRRmIS6xTpcdLxILVsi1W2JCr+WCpBqCH7l4WZ5hCQcGBIodsX7nzqyS2Rmv9dQNVk8Z0Ik1zDAzeUJ1fIDSqv+JEsB9H4hU7FBbSfyDdX79v2TtdF6JTJjEUIunJVN9OJSY8eoMTXZx3Qbl9dvv7+c3yXdUP+vV8YfjUgRiAJAKPtan1/Q8nX8s6xXafN1sUzSa5atMao95AnvFgIQqYfJZVIhX4yKaCWV8XhG4pKCM9Yk6Svux0Dvu/qhBC6Kd7kvAABPUzpUWCSFwXB09OGs2KK3guS83Hf67rQoxUqig9q/RDr4rXPlGIbQocsxaLaOAAoiwd0opfYAMxUMsB7w6fR6tXLtS5XuJXXSlQ5JnSmRlXFJ5414+vOf7I31BzYW9CjhIkMQf1wf4RgIM1uU4uD0HhHAhjuxlZkGiCYfd/MdZ8R86quFXsZkTpXN9DEC8yglKSbpEl+ug2Af/YisWFli6v5WuRFqTx0kj1GgUgDtJ5aYhRCjYnIGAk1JpvII7m0bLB4S7T2tzArPNsfxTH/IaILJiRk0LvAPA7LpyTt7/r4Nl+oXsnU3DyOxmS2iY97zEWBIloW/7PVBLyCPhrHWxHURLePLBt7Y39ploSb9tyyznEPmeFOIPkL+bzEHIFXkUzoHUg31kFTOWrEkzSL/AtXPnaLm3hDz8bEYmgOTKVJTzE7YMEueO6SeY1bvSNO19sRnsEehp1Q2OwS3uG/fxRXDR0OZUesRSuPpvzSuDzQHNH+FtbsEFIb/G50EAThXO0C3KQJuys7513slrmCZFzeyzVELaeaFZYDOpiy2FVS7LCem3UF+jMJN/hzI9GBZRDxvo79AASk1uIFHFPmezW7PjX4mBrDxmKXfq4iXoupt20OoYHth+eAtCawf2JsmAf0RsokSIkKez7fuVbpG9CRT1FICYORftHK9ZFMeWTBK2V+FGTdmjMJ2kp8dArhmTWa6u5CNd+msGJ0IO1I9bm212V1ZWth5hd9QNXXTskF+obkrHFcWimr+Cpz/mIufcY6ZaqOi54bbbsb5QlGQw64+8NF+IF+4XlRLvQqFrRYMBlqY/DPuQaCBOJ59MbSgFFn+xhGP1hxdrFoSGtfsOwZTrZSWRt1kMBZCNqGfDzvtQf/3t+i4OulFm/0JyT8l0o4x5qLV1/xe4Wi2bwG87T4/AHJ3pZjTc8/F2ZUGP2hviG0nWnpEvV1pHjtUWFDiD1IxGWnJPHzGW077BeZSstiPeJe4M1P0oASGtV+ZrF4DlWalLjFnGbnm8VrKjP0R3zkgC3ot0dl91wJBYx1C+7rFUa9+HCJXjz4YI0ocXlwO6B5lyY9GMH6NytKOH7JwLs1KzT/ZMH6QwCOdxlKTH2pvu9/C45Sf3SGMJNjieJFJjEUKCqmlhJJ0XlSEeRkdFtA7n4SDQT5yshZ4A1BlHa+HDYbK9ChogJxuz/L3J0+F/ZLma/ILw97wtCdeTjAabvmAobPAImGtb8Azb8trCyQperGZbiwWMgZEX+KleFkAFkI6rX4me23pw4ynW8AsrJSXANfxF3fr2nmhz//+JyF9TA/FLzNXggGmCL+kd+87MafDI4gyr0IKkjvpe6rly0ReVtKj2+MwmCYRHFvamA8Fh80lCvTq74yzv60dWcHyiwHIzkNOEr+w9GmTHwyu/+YSmGrSm8ua8vWNjbQZnMt8Tj1atNKKE+oj68VijG6ZAvFIc9rbbjg7b/EkTk/oyxmoP0hhJyRp4v7x/QGHY/zLv83fdrpRZzU8/t4dDr9hFzxymjZeOx58/qfILN645MzEeuUb1C1mipuiWcuuCGCQmwQkzFlUru64TthqYw7sFfGDrTCCn0oQEczLBSMH/lfBR85Dr+2XKuMlFJCAOLe4yzAUYD5SfuSQaZtdBi6dfUQECeru1kIYuurrXg1TccCpX4C6vJunlJvJiLvNAuztcE3lrIE72Vk2dMLIg4g4ww5oyUHIyE4KT8v6nO0UA6xoA7YTT/Pxk4wn9ZFN/6/1sFYr48yAPU+rz19i9e1033/67rAkG/hH75ogbxsS9gDeAj/clCiJqAyRPBUP9qoW515pitxhV5GTmJIX9j3ZDkiXtDfy1wGQhPrivCOpntTdeJFkCVr5tx0kPv3NKvClfMPV3jYFJ33FNUWZhPu212YmQWWym+kNNVddAqOph8Ly2RL0udZeNyeKwZRStmfqlLKtMA0BCZwY3pEPkiFVEYpn4HAFl4u5NJawAMvUe9tH1RF/QrzMqg7X71VZdTIoMAHuv+Qvndzq+PCvkGtGTO0sxBy5NAk7FyJ17LS+YXtt9+k2rpIbFdiKFvZzJ7DLi18RVaRMB9zdYg8R+kZ9RokpEMlXAhiJtoznlLDT9M9mx8TCHuiHpNxH+W85h7Quo8c/g8+kAk/nmAjYULBQoBROKp/PAEsoyyHqMInjGqZ/tL6x0tTn85VM5FH3EMXVZijPy40CgIya4EoGUyYn0OvduD8+gv8TX58T/t+66KUyRrrNeOMVfTaKHxEeDIvh3zGf8psLrZadV2Ar2bnm3PRqsaRke0cw2rFAWsEz8J9rh54NIbeDw7xidKoReafF6+G6taaoiRSbrg3HcoKXSQoKg03pZvW2jDQeA/wi1kHj2Q+zoD2ldip4bb0tvgVij6FNRs+Rh8/IlNKohbPYdRkCrcD5oK+3WH0feuxv50e394v0nb2Cd7vq46T7M3J9w4G7Kj3J6fwo0lv6FCp7ZvrxhAwUX6gYASXHsENsty5r5jcaOnOLoO+pJ3aZ56/5eB2QE9b1eDGPY4swYIy84s/t5bqGZstpmrmzzGFAbBFwO2Pk0xsZhB5iFzshc9nRbeI3B1fkJRzdgo0sVvqx7pgeXfPNOl9JmmRG8awDQcP0c6ya6mSM4aKL9ywTKn/sdm8RR4NPZYuiJ7UtOXJzUVcMVRByCi7zJ5bPW0UblqSKtI0i9nS2Mu4PE0HiLTyNyXfhi+NsrH0XU21ubCkHPEh6pHf6qqVbEPuZc+YXRS7WEKdr0r8RnQXiG0O8vUMtRPoHCSM8oq/yo+hFxNmmZSSWWCeXrq25i8El8sFMp1KFIAAU+F9XweJGC87eYdbkGx8ZEt4GPZtD23EJezWnYUtPHDP9iZZszUPVAHFr3sxTN8PZI3wIBMCb/5H5LgJEHWnIBCdrLxLNKB7248BDXOReH3EFLmlLFQc3xuPNycKejYWE6KNFa6Ty1/bpGtNH5PlC/lJym9Pa2jmOtqCCo0+7CMX1P4OBKir7bXZATz0+rtAMeNw9EAFde0lwHEwbrKPBcY7SP1jqN+RBLpwIqAAnB0dslv5Iq/88Xkq+j2IpNS/OP8uQaoraUn/5/x1SeqGuIDjYUaNAjiGsMYyvkeIKvUBhegpjif9vFqXXgnD+JPPinkjSCZD0o0SkjmhrKWK2DYvie7UIpZYvvPeeENeIqOllq2ZlJ3M+1ZFrB5o+acdDez/Ub4rvWEoFp2p/MnRP2xVGATMXZ33fFjpYunGLSxe8QD8xQhocco37H/BkHhTbs++5+0rdu9A8KbSdnAS4SsdPUFMadAYtVVSOgK98obTgkVmmKQ6d+Nxsy/1vvhZfA6Slzns7lFaNw5s7q4GUnWsvbJJbsWse/xJEAaoJBhG7wFORDeRBWXe0LJ+vQlB2YhXwA98Qs2dB+ZdKb9k10e/zQKossDpJyH2PAHeLHiDRcN24549IkBA9w2lgwo6YS7lhdwrAm1tKhKhUr9CVZxaU0a74Z9IC8qJ26P5BLghXvuGraRUGqUcTp4y1U7M1eqfkiN8XMJpNVpN+cPjxqYMUvrcKHlPy++AZuWaSF5bYgKPLFCOIzLOTqO7VNbf6a0xgBQ/UKzgqAgm4uARYcu//8Elcqx/nGr/QwavFuliYvbQlvOQWSHxqlJPTQeTAKAtQ3YPTZGtXprdUbrMjmCQ9goLwfbJIRfO5/hJaMPYGuD9HF8PLq8vM89q8zkIs/c7xi+KtsYUXzbwDiBLZ0qzP1xwk7P5OgxmhLSY+M0Rbc5gg8965uQYO25k8aAoeb9YJUq8IyHbBQ5H3ye4DR8GeWGGn5JJ0m/x6AS+VK65aB4BAM7mBmo7QJaFeyO7mI8IXONiCh78Dp/nzxBJP/fs/3MWAamom7himbWYemoif+TxxFocnD8ecuezbspa9kuj1BlN/UlvPfzm2rcZIx/7Pc+YsGPxcT/Ng8H5QPivzwB+9if5GLzjJXw17Y8Yvh3fUaP14H4GkEme2jvgSrDIgu9pPcTQhfDXUiVUO/4LA75NDpyNlzgstXYOWGVLDJ9SsoFie2Vkf5AYeZ5aqTRJfpR961P4klQBLvKXMGnluWnNdjy7OW0UARPn40vq+DBdXPHMpPybiBSR2kNhsntHWWwlbES3yipZ2G01Ky+Y6NYV7R1OXnxg+lHnvqkkKouVWyILK4g6LPbVWt2tiM6vZ/6ITrs4y8FR/Mvh0nE+4UdgdgewzsU2iRPXeKXDLTpQ7o/vEx6kud6WFrdQR4vPoXQwxdsUBaEJzi9zV/wmsqbwFdWDHbmXMGZRo3vhX2nlpmvQUQfhtuW+zH1Fsfdw6EaXRewKhH4l6Qr6lHsTjlmwFOQMAuPKAcEnk+kwncEXpqQpYgyGJOd3Eq3paYnsgggfd/b69iqbTw786h6/DSWXDd47cAiXbjl9fwGbY9LHzXpFHUmUE9agO0SZIUjo3yYzeFTPS25n8StmDO4kZLuyRT0eKbfahYJ4iP+mL4sF6/BCEn6Q4vz03VL2AByC98EcQphsV07SWL9enyacVU08DfRJ+ewNy3BTw2z+75AHlQ2yYJI9XXI3gZ8ICuMz7L/7iHexlA4wzWwnr6ObVF0Ar/HbzPhjb5GhPPrICFQgja1nfxROgpCSVZame1PzjnVoc2qFhCyRTOc//2yRegYcONXChEeTCISo0+Yy8jnEOeS9/ZNZ9Wy7bhuJJItqdsT6qGIT8CunD+QZsdsuvJwRhbkVZpQLD6VBrDj0TdYHPtrhc3jbWBwkHrescLJkvZBRft1M3zFCwo0V0cfiF7lFvqnmG43SCW1sXqWH4Yyd2il0HNDQYs582hQRbT6qII2ThZGxD/GdginW6kHRZ0IGiIIVayhMb+KtFXZUhDv1L5x4R03KMwMQmWkmMfoZlGnL5LpjAS+NxMDO1csfDi0/UZksbqnXttXoOLRiJWKWgoPentAuWHl/jsBGlw9vNHaqKIG9PD/PXtJYI2+bYhLjYw+ab5vd3cftD/HWhgBTRCtHbNNRZOdQ8XwslGKYTGaMYWuzYu9PH6sb6u8fJRW/HM2mpd1ENRg47vpzXhTfhFjfWma+3PHoVVSohsAOZrWtvpYO4pzctgp+xaejSlmRP54fkNLqZw8JCvF2ubKwLcjRvJsgXP6mioDsYFHoKZ0J9hDCDkc/sJo6/5TOQsck8IQz6I1fQ5B8iJTraR9P/ybsdtkxYDm9eGEAdl2jY3/U+CKdesKgSRwciwodJmc0eV/pxBlPnaAMcYwLv9iAXFGN4//eTP0+3zgT0XDEyA2vk8ltT89jh2eyA5LxL2R/vhziJ3HZTk+iMmElnflLoBKZAGYcmrmfhdx5sZsj+5OsZjL1hPdcFwz2f00KMHJ8fvNtUlKEj2jqc2InP2eXXlhaiqiXgfjRmyoodyDwjPAD8DmSgLrLTsQD3fx0kPeVcWXYEgVI89RKKYo2Hl+YBwqIpLqT2u+eIkoWe7YsN6hxt9YZ78BDglgIGO+mFupxwOIx1IUKgIn2wpE4wTseGz6Es3ZJW61PZgJ5zT8ODC0GRWWuH7hM8LdsBycXZ39JC2jA7Kzw580PcSvglqiXBJKiYPx/Le6kDm0PUGe1se31EzfFqozT4QxmaeTXCB253JSqzVscWaA4kFEoOtK1ZaUoRVc2rGNLnuE7CbZoX0MIpS/oTbPOBio20D5nw9WLjBlb1MqdYRRVTddZ35mwkJLPbYVtXeGt2ErOeImPps316KL/T+nLKhHLqX2+DZbFAh77n4RcOxAELS9xbhHSuptMBU3lYii+qwCGmSP8dr6DnFuEXjdDxgqyFYcMavRkbQgosvlzf2MrI5So98n8s0RVAXaGQXUFAnf9IImKu7N5zjk0IneOcG3uwgp3wfpEOU7foSPxpBbbRy+/4OOhY9YAqLCeP7F+s5XIWF8oSJ6b8/LvaU4V5YT5IhpWrChWEfGopB/hxtEMTZ748iVr3fMPjlwBgB/XNv6Fi4m01embX4my3USjpBH9IBnAMSH5cd0Zf553HnK2hl3RAnGPP+Pufjbsy8evt5Q7e14ytYxbTKUyc4P9u/TajsBWEiANS9RDSs7WZFjuJXA1HRxO42C8nLXp5OeQHBUow82DyepmPye8Jhkyt1oFFkoRD/b3qyK+SLr8Qq7GkzYTPCHhXfkENAUaE4Hvyn9kAQ1nqF/zEEytjx0NnDG4wf48wQ15rUBEZRU+9IdZo/hJw8G5uYe0mqtts30Le68QM0F1Pv3cRVNShl2oHpVrcWzPy7W0pbccsqfXSdtlzl6Uu7PCSAETOJM/HnPAzJNQBkv1EtiVRD3BRTmyYIBwq+3Auy6jj0jiB47opjzBf0wlPyciUQh7ZHuCt/ze6oth5r7loW7X3luImMBsP2xDAOtbyfWsvHXmQyvG+fthaakAngVVDWSoT297BffWFzas7p1v+RwvPmkgWoCeHEtIdlE8pm+ZPnaN4SHY3wTDN2LuOpCEXRt4hdIJfVz71Jz4/XeiecMXmql2DJcmZPjkiyWo1Wj2kyR8ajJWeel7VxQ96dv+4IimJKLwlRqFsrGkNwGBy78NEsAURdtOhudFB9yat8SV3jDIMzv10EUFBseFlZ6a8mx7YnGrde8t1HWayx/CVmAOGnwlsG52b4Wf/J8oRKhBHPsGpfGsmGC/4ZwbwwVRzBhoB8Le0BKc4vzUgjJucUlaH4kO9aEGYz6MeiiOe7N5Dyd2fFJsYYAZYOzsJ44VJTp/R39gF4S3Ls09VdcQHdjOrD904UC5UjByXvgICDtOqR3zcVUQZYFSRX/q+5HQrcScCHHQcGdIBWh1FGtq6ZhJvbhogtCQcmGdfk+b0bvWbZgdxSbVzzyd1ivjB9LLcmq2OqUI+/ER7083xFtEgEMzZPkA6Bz4zIVid4KXjVjlmThZ7HHQt6/8yJ7AR0AYE69ZypnfVxyVrb43dpnpCGvkqde2BEChSGf94YCYK58QERV4MhhCG3OEILIIUygB8wx6cV2w1BSoIO5deDEr2aV3jNLmfWTSb/PRM5Na7jPOvFl2iq3pxzN54KBhR33dL3dqjBLyt3L5liF4QYhpJsz39xdtbzMgpKtlGGQnegIzIdc2kdkcmeEL531tPeKm4Bq60UV1mKi5DqG2wajQ+Un7aEwTiA5vRODMLuvRuKD9B5l7ZTW1gXjix9TUxtKra8jIg0HyXTfW4LnUWYjfV7pyMrhDVnrXisqyePykrgX/mcBOAQM2jiZZ3+fjlidlSF7rFINVFTYItED3uKoQ8ioJ1Wl9r7oGwY0S/FUtfiGp0DA8BmBNJ9kmoCDhka0rLx3kxMZgF+b7h3sLJFZbix6bF4bKVNE5gvW/Z/r+bPJY1fwdgZRVdyQiTneRn4JxZYp5+xXngO4PX/8JgDBzhxS9VB8rNhdCMJ0xhdBsVHFPi6mS6nD5EnT4+m83QHxjOkTA565z5f2qU0tuz33G/uVG50zBbCTdgXYbvdX1VNsxBJH2r31gOfhgVajmZhDgdtuZIlQzh62itQQFMVtguLtve+nzI7+/E2qaw899hLHPNw2RKqp/TSGfqb3U0BrBDQ99jwrr/dMIRClqntrExStVzE950nwz5mGXw4JV328kzkal/V2wpyFoGIGQCl6Ko+hfUZtSMKFKocp4xXhYiHP6A+l96/Wpn+SEy2jpCcDBIkydx7+y0Ah2lV7dvP32g1hY9FjCG/Cv28zr53wzECV8TCogpTK1t0uSn8WkR7dbEvrL+ET76zLlySsjgqLJHzxR3YkCl6scsxLUrclktS56ikqwm+LGwANMAFwXlpJiekOmMLSx0dX9nIS58NLbUGNfzL9VShCrrWssQES+t5Xc/SzaJ9iLXt8w24cURZJwOdCgK/QwJL3KwthosGoXJOa1pnWdobDTgBq1GxPATLFw0UvqmZBIie+mmPNaHSBTGp46bML7m8/GpzVpRvaSY0vadBH+v2p5v88My2VSBjDEAVbpec4MMIgbSihPiPTC8kSHzNN36DtbS4uN/0dnuyxkNarhPsuI8m9P/6G1SGLIr1XhrsUsC0QeGrdFr68MSPhKSeeIpRz3wIvofxpxvqXdMEqwCJERFuC9Ua9H0eIF4sOp5vD8ivzNbLONu+Q41PiueNjlVTU3NW5MgX4nzH/ucfRYx898FgTwjLZgKiJezXE8MMRp0kkpySsKfTMek6UCljbH9BF3j8c8ksDlLu1DKfIS/1pjthmTeSMSwtxVbCJO8Q8ghNP9vOfTap1XFvfcuOD3J+20nP36l82bGaihwmjFpjDVkNxcFsvZ+xryRGoFDX2gXveHFxBHO5W5dBx1fKzQ0TlJYkxEZ9676e5aCD9MYAC6FLeW13Fd8a1RC99CPZ/MmBDFens+hHO9I1T6YNj6x8ExRMZF/ptGhRLLys5K14wlxQRMg73c/A7fo3rBZicJhpzgBeyuVlOetkFalxYgmRLpPxispIeR1UTIx3WvRU+DTwtonCb3oc1HqPJClA5XX8u23Zs5KKPTEXd+2faHmiorZUcCkIOuMCwEOwjix1cvpPXWkSsfcXtRR1OiXw3wy/rAS4zJaM6AQ88axzhtMoQ9wGikGovukVe9Q735/Vonx0ru2RaK/ja8JrJu3ZkceBKPq0NTQRhXsvnozUMDrHy7B//Pz2dabkrVt+qf7GjZghkaLvvu9ENWX3TLPccm3avFePq4kdWM9X64xbSZM9EFDOyAZrz/8m3rvFDg5BpMI/FBdHKa+SV834e9J+0Um1uYjHR5M+WfV9P+PPYo92snIr1FVy4goZAV83SJbW4LUSWRcl6oFjbrUrEu3Uoutx8W3BF/G9gSZqufmBm1KcsHDr/dU5r0B49jptUAJRePvGcbt4TA6b+lcbe0cEInWBfiZdZP/0Cb9wLPDmWDsYQN1VMunlAl8mSmxrxI77Z9FItxUF+I4TK/knn9nP3yACSz4Dnf50f4eOijEBbIROs0xflAMuLnagJd6pmQtl6nHumY484E8sLPrLc1eV1ESdQehsrYxmLQRbk61tQjsTiQaRO8aIDuFrNLOYTiUWZjkzSz79/i/rrueSEiFmGXsGQY6Z3n8s24kgSYOHQla1dL1DUqmqCXCOoSLFNulAZAtG9DkhCkF9T/cP+xnnjOOhlyvNRCdfJ/aiTCJW9pkZEbB6JW3qUPU4fBnMW7VTM0bzZQAhX/ik4WpQcaJxaxtjF9x07NezfvTbYaimSdb97p3SKJCw1NpsA75k/betGkhgKXo1538METrCKyzKMi1dXNRf1OQ18QfNLm7xe9vnPuOLCi9qw0Sq6S8XKy9Xf6pHT8rGtHwhT52sXsr87pksZ7lfdMXNRby+ehAZyJwgsEn/9ozrcVVNuwXcHKDEer/LbqF/fOiqFusv8Lez5ZHf8fehAFUKnsWnuogBVVT/J5sL/HRKD8FU21dag6quT6D8ifxHCvA/EEm38Y9ETXGoRXK+Ag1fQW7ySY/LhVajKTNEw4YujkTwCbH4Mt2+IoyFzS1fmoifL/JZR2feEZSAzWyUqyl8Vy4VGfrmVMjSkVWVA2wVgR0CTFBkbyug+qIvfhwXf+k4j1ivdROSasn/rw7x+gtnBeLjFQplmU0Dzv1aryIXwQCK4Mu0kyhcsAqxWoYNu+cTehCGqgwy5WuT+KTwBxN0AUCnYsFd++apmlHIKGXtHQQlNprYooKdZHrbIK9cjmr6wNHTA1IKLGHn50B8cwLZYgywy1HyJrv4uEWbSr2FnqNAQ0FWaPZ2bqyDIbA3ORpqBmrqVe7zhf+qkznrtz7TvNeM8v84XIDSzvIQ81WoZupjMLNObpviKgfc5bm7eA1n/RIGU1UcTQoCuUgacj4Op6dUleviSZy56+nIR1ZoFYsw0sxieRyHGumzyV/fjXH3Q1W9xUsD5saEwcebgNdsmalMgO6bnlGhSiwG2s7v1iC7bx2ZJ1E2OHRbTJQu9Cx6r6xDhWY8ZjKbIfVyZt/4SgCaR31M6Ip9/T2ZPSR/iXsyHYlxt6DVwn3N5xQRWzkZcz9H5qf5KsBzVWV3GjqLJA1XysJsSOHJ6Cj9+ZT+4qvUZMv9jUw5Kg9VpCho8T3Aiw7tOzS2dlxYAyZvje+LoGQtsZstNSoq9KvBx2R+Gzi9WR6xUxibF5Vce3SVEmfAsYSGC2SSYgxNxdap7JYjifwoP/SIcrcmmnecRSxPOk1DP+QzK+JFUgCX8MmJyystRm0peCWQvLXKRfoE43zDgoSSwDcB1KYbp1BlledSWMnaqE4P/1V6PxJQFVP9KP0tMkS1XwRABLbf3TUt2MAyfwAEkL45UqETihhUaMVDpRyBvWbKM2PrPAXGbNVkgU25AzpBwCWCGK2/hmm2LLhwU36wwiSu5eO2De4u1EXsVTBvFA23jhK1AdzZEOiVlqobX8L6IA6UZ+vgeEUWKC7UjgKQ5ji2jQIHugI6RYQw3pOxOLccC9ZNv6mnosMlVbEKJ6wTGJRfMvL/2TuSD6pFlhZ++gqj15AbM/JEP56lvCbJ6YtkUrtxopujr4cvOnBTKvm2enpymcW/aZcuZBgAAAAIR2mzbIchwjtvo0xqY2qjc1vqnTTruHWfjNZNu21TmAcl29LAOInWdFw/tW58VL1bMqTiuKFf+f15MzbtxSYDQCdxpTIoGCFiDNF3Vv/kpOCp2S0AAJkj9XfYloxpvdzrUSRNJfyCQ1+alNIjNjgm8RxcYSn//SjLRT+zckdL5fVy7O++BP+Xf5Ahaf9sQ4lZvLZnn/4C/y+td/bQ8YNHrf0MMXGBZiDqkojp9cm3oQhDUG6UHPqYfU3lxjmYZrGN1Ky+C205CKRIO9Tox3LX62W/YmDt6UUFRdqC+hUtN2880bvy0GFqrSe9LU4WkxIZNEsMdJm4k3VIesVf1OpppvZBdlkQcLfjTnANFiR46MZ0dkcak7FCXn0BwpmAlVLFqJchwsQMeXYqvKFQ+U12gXXleUmhub4fWFMXv9vqpbl9Y9MTpJ/hzroSRIzTtDI1CdG9+AxczsMwIblo9eZpf7VfXBO8dPMCsoB2rv6hVwGCzMG6vcTODgEYP/DrzMJtjyDY7IAM7Bib0OsIAFAQc2kCBoinkZJKgc2FI5RK45wWEgE7l0VSP+1p3OzgA7sMdSWe5cDVKLjqwp1/BM9CQRgmq49XUNW84xRyGbovx62viCqI+2s6miLfXLL7Y1UQsNng0Q6rGs/4pT+zmD2YbStjLHk21r2u1XaA9bk9LpYM1fQgQxTWvAu0GjDCIgbpyRWPIr5Spg2jtADv+h10y7qtjD/Iz2vPJWrhKA6VaVP7DHUuoHYjq70XMwltAF+053AkK6byTQXcgb7mt2XnTk/eesPra2gLM8Op2TYZmfTclrH8G3g/pqn55sTtkd1LPHt9GxM1fBS/e/Ji5LTXK9GHK/KwAX5DFpynlPuAAWaCRORTQo3Md42oFal+xyhelbZ67Z363FdkSIYDMPq4iq2rRXjY+1tbES7ez6U5grWLhqhXpIh42tZ41bDzyMkV+91u89RWhbQoV8WMuv3W4Bu+sZqdiPLhzK/+jNRJmOdG1xM22/4IS99wYWYAWrMbfIxHW7k2g6qqmbQQQlpy2aF2M+QcldG2wHxDL0WY9yOdu3UYMTovaEwhSJJx28puVPjESgm3dHDa6NQGvr6xF4TDlxbFF9JFdWiOS/Q1dK+ogy30XN3Jax/GRyF+ExAk6hcPY2Tc4WW/oOk2Svq7bvI5ARfhfjiit1eMX0J7q3++wl3446YtZ63anpnnQGZSt6mc4qKCTLWvOh8NPrIpRF+7L1enfvPfkU7BhK9/xfT9nM5ScM3l/Xk0X/9fKw1tubw3tyMOsRPQnZIvibaK+8QZwj8FhRfjTjxbu/7NyGQEch5s0ckxfyucIDSaCOgbrzvne9KO9iX058CcxqDgz0H/MGrNRRrzRiuN5QPIpqBS+ddfjuy9MIQyJsdcouTnrXNtKlKpbGaUL9Od5Nr3GNwU5rxpkImisbTiFU9BNxTr20jKeOzdkfcr/tRZg675AE2KuIsFqcPO2ns/8cNkxnlUSya9/sOcDdz3TGgGJexZhrf+f2OrKvMmaay+L8nEoxDI/UKHpU7+q78dTo/8hkxE5zWyFnDWEw38+ZxcxB37Drc3LXPFQ1TDUxdxBVK0/2hIva01xhTyO/nSkRZvzkEr2hlrE5RYbThIAAAAAAAAAAAA==';
const exportToExcel=(data,filename)=>{const ws=XLSX.utils.json_to_sheet(data);const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,"Data");XLSX.writeFile(wb,`${filename}_${new Date().toISOString().slice(0,10)}.xlsx`)};
const getBirthdays=(teachers,period='week')=>{const now=new Date();return teachers.filter(t=>{if(!t.dob)return false;const d=new Date(t.dob);const thisYear=new Date(now.getFullYear(),d.getMonth(),d.getDate());const diff=Math.ceil((thisYear-now)/(1000*60*60*24));if(period==='today'){return d.getDate()===now.getDate()&&d.getMonth()===now.getMonth()}else if(period==='week'){return diff>=0&&diff<=7}else if(period==='month'){return d.getMonth()===now.getMonth()}return false})};
const getAnniversaries=(teachers,period='week')=>{const now=new Date();return teachers.filter(t=>{if(!t.joiningDate)return false;const j=new Date(t.joiningDate);if(j.getFullYear()>=now.getFullYear())return false;const thisYear=new Date(now.getFullYear(),j.getMonth(),j.getDate());const diff=Math.ceil((thisYear-now)/(1000*60*60*24));if(period==='today'){return j.getDate()===now.getDate()&&j.getMonth()===now.getMonth()}else if(period==='week'){return diff>=0&&diff<=7}else if(period==='month'){return j.getMonth()===now.getMonth()}return false})};
const getTodayDate=()=>{
const today=new Date();
  return today.toISOString().split('T')[0];
};

const getMonthYear=(date)=>{
  const d=new Date(date);
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
};

// ========================================
// MULTI-SELECT DROPDOWN COMPONENT
// ========================================
function MultiSelectDropdown({ options, selected, onChange, label, placeholder, disabled = false, getOptionLabel = (opt) => opt, getOptionValue = (opt) => opt }) {
  const [isOpen, setIsOpen] = useState(false);
  const dropdownRef = React.useRef(null);

  React.useEffect(() => {
    const handleClickOutside = (event) => {
      if (dropdownRef.current && !dropdownRef.current.contains(event.target)) {
        setIsOpen(false);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, []);

  const handleToggleOption = (optionValue) => {
    if (selected.includes(optionValue)) {
      onChange(selected.filter(v => v !== optionValue));
    } else {
      onChange([...selected, optionValue]);
    }
  };

  const handleSelectAll = () => {
    if (selected.length === options.length) {
      onChange([]);
    } else {
      onChange(options.map(opt => getOptionValue(opt)));
    }
  };

  const getDisplayText = () => {
    if (selected.length === 0) return placeholder || 'Select...';
    if (selected.length === options.length) return 'All Selected';
    if (selected.length === 1) {
      const selectedOption = options.find(opt => getOptionValue(opt) === selected[0]);
      return selectedOption ? getOptionLabel(selectedOption) : selected[0];
    }
    return `${selected.length} selected`;
  };

  return (
    <div className="relative" ref={dropdownRef}>
      <button
        type="button"
        onClick={() => !disabled && setIsOpen(!isOpen)}
        disabled={disabled}
        className={`w-full border-2 px-4 py-3 rounded-xl text-left flex justify-between items-center ${disabled ? 'bg-gray-100 cursor-not-allowed' : 'bg-white cursor-pointer hover:border-yellow-400'}`}
      >
        <span className={selected.length === 0 ? 'text-gray-400' : 'text-gray-800'}>
          {getDisplayText()}
        </span>
        <span className={`transform transition-transform ${isOpen ? 'rotate-180' : ''}`}>‚ñº</span>
      </button>
      
      {isOpen && !disabled && (
        <div className="absolute z-50 w-full mt-1 bg-white border-2 rounded-xl shadow-lg max-h-64 overflow-y-auto">
          <label className="flex items-center px-4 py-2 hover:bg-yellow-50 cursor-pointer border-b">
            <input
              type="checkbox"
              checked={selected.length === options.length}
              onChange={handleSelectAll}
              className="mr-3"
            />
            <span className="font-semibold">
              {selected.length === options.length ? 'Deselect All' : 'Select All'}
            </span>
          </label>
          
          {options.map((option, idx) => {
            const value = getOptionValue(option);
            const labelText = getOptionLabel(option);
            return (
              <label 
                key={idx} 
                className="flex items-center px-4 py-2 hover:bg-yellow-50 cursor-pointer"
              >
                <input
                  type="checkbox"
                  checked={selected.includes(value)}
                  onChange={() => handleToggleOption(value)}
                  className="mr-3"
                />
                <span>{labelText}</span>
              </label>
            );
          })}
        </div>
      )}
    </div>
  );
}

const getAttendanceStats=(attendanceRecords,filterDate=null)=>{
  if(filterDate){
    const filtered=attendanceRecords.filter(r=>r.date===filterDate);
    const present=filtered.filter(r=>r.status==='Present').length;
    return{total:filtered.length,present,absent:filtered.length-present};
  }
  const present=attendanceRecords.filter(r=>r.status==='Present').length;
  return{total:attendanceRecords.length,present,absent:attendanceRecords.length-present};
};

const getMonthlyAttendanceStats=(attendanceRecords,month)=>{
  const filtered=attendanceRecords.filter(r=>getMonthYear(r.date)===month);
  const dayStats={};
  filtered.forEach(record=>{
    if(!dayStats[record.date]){
      dayStats[record.date]={present:0,absent:0};
    }
    if(record.status==='Present'){
      dayStats[record.date].present++;
    }else{
      dayStats[record.date].absent++;
    }
  });
  return dayStats;
};
const getChapterStatus=(chapter,progress)=>{
  if(!chapter.targetDate){
    return{label:'No Target',color:'pending',class:'status-delayed'}
  }
  const targetDate=new Date(chapter.targetDate);
  const today=new Date();
  const completionDate=progress.completionDate?new Date(progress.completionDate):null;
  
  // ‚úÖ FIXED: Check if test is NOT 'Yes' (handles both 'No' and undefined)
  if(progress.completed==='Yes'&&progress.testConducted!=='Yes'){
    return{label:'‚ö†Ô∏è Test Pending',color:'delayed',class:'status-delayed'}
  }
  
  // Only show green when BOTH are Yes
  if(progress.completed==='Yes'&&progress.testConducted==='Yes'){
    if(completionDate){
      if(completionDate<targetDate){
        return{label:'Ahead - Good Job! üéâ',color:'completed',class:'status-ahead'}
      }else if(completionDate.toDateString()===targetDate.toDateString()){
        return{label:'On Track ‚úì',color:'completed',class:'status-ontrack'}
      }else{
        return{label:'Completed (Late)',color:'delayed',class:'status-delayed'}
      }
    }
    return{label:'Completed ‚úì',color:'completed',class:'status-ahead'}
  }
  
  if(today>targetDate){
    return{label:'Delayed ‚ö†Ô∏è',color:'delayed',class:'status-delayed'}
  }
  return{label:'Pending',color:'pending',class:'status-delayed'}
};
// ====================================
// INSTALL PROMPT COMPONENT (PWA)
// ====================================
function InstallPrompt(){
  const[deferredPrompt,setDeferredPrompt]=useState(null);
  const[showInstall,setShowInstall]=useState(false);

  useEffect(()=>{
    const handler=(e)=>{
      e.preventDefault();
      setDeferredPrompt(e);
      setShowInstall(true);
    };
    window.addEventListener('beforeinstallprompt',handler);
    
    // Check if already installed
    if(window.matchMedia('(display-mode: standalone)').matches){
      setShowInstall(false);
    }
    
    return()=>window.removeEventListener('beforeinstallprompt',handler);
  },[]);

  const handleInstall=async()=>{
    if(!deferredPrompt)return;
    deferredPrompt.prompt();
    const{outcome}=await deferredPrompt.userChoice;
    setDeferredPrompt(null);
    setShowInstall(false);
  };

  const handleDismiss=()=>{
    setShowInstall(false);
    localStorage.setItem('installDismissed','true');
  };

  // Don't show if dismissed
  if(localStorage.getItem('installDismissed')==='true')return null;
  if(!showInstall)return null;

  return(
    <div className="fixed bottom-4 left-4 right-4 bg-gradient-to-r from-blue-600 to-purple-600 text-white p-4 rounded-2xl shadow-2xl z-[9999] animate-bounce">
      <div className="flex items-center justify-between gap-3">
        <div className="flex-1">
          <p className="font-bold text-lg flex items-center gap-2">
            üì± Install Mobile App
          </p>
          <p className="text-sm opacity-90 mt-1">
            Use like a mobile app - faster & works offline!
          </p>
        </div>
        <div className="flex gap-2">
          <button 
            onClick={handleInstall}
            className="px-6 py-3 bg-white text-blue-600 rounded-xl font-bold hover:bg-gray-100 transition-all"
          >
            Install
          </button>
          <button 
            onClick={handleDismiss}
            className="px-3 py-3 bg-white/20 text-white rounded-xl hover:bg-white/30 transition-all"
          >
            ‚úï
          </button>
        </div>
      </div>
    </div>
  );
}
// ========================================
// STUDENT PROFILE FORM COMPONENT
// ========================================
function StudentProfileForm({ currentUser }) {
  const myId = currentUser.studentId || currentUser.id;

  const [profile, setProfile] = useState({
    firstName: '',
    lastName: '',
    email: '',
    phone: '',
    dob: '',
    grade: currentUser.grade || '',
    category: '',
    stream: '',
    school: currentUser.school || '',
    fatherName: '',
    motherName: '',
    fatherOccupation: '',
    fatherOccupationOther: '',
    motherOccupation: '',
    motherOccupationOther: '',
    fatherEducation: '',
    fatherEducationOther: '',
    motherEducation: '',
    motherEducationOther: '',
    familyIncome: '',
    address: '',
    state: '',
    stateOther: '',
    district: '',
    districtOther: '',
    pincode: '',
    whatsappNumber: '',
    percentage10th: '',
    percentage11th: ''
  });

  const [loading, setLoading] = useState(true);
  const [isEditing, setIsEditing] = useState(false);

  useEffect(() => {
    const fetchProfile = async () => {
      try {
        setLoading(true);
        const docSnap = await db.collection('studentProfiles').doc(myId).get();
        if (docSnap.exists) {
          setProfile(prev => ({ ...prev, ...docSnap.data() }));
        }
        setLoading(false);
      } catch (e) {
        console.error('Error fetching profile:', e);
        setLoading(false);
      }
    };
    fetchProfile();
  }, [myId]);

  const calculateCompletion = () => {
    const requiredFields = [
      'firstName', 'lastName', 'email', 'phone', 'dob', 'grade', 'category',
      'stream', 'school', 'fatherName', 'motherName', 'fatherOccupation',
      'motherOccupation', 'fatherEducation', 'motherEducation', 'familyIncome',
      'address', 'state', 'district', 'pincode', 'whatsappNumber', 'percentage10th'
    ];
    const filled = requiredFields.filter(
      field => profile[field] && String(profile[field]).trim() !== ''
    ).length;
    return Math.round((filled / requiredFields.length) * 100);
  };

  const handleSave = async () => {
    try {
      await db.collection('studentProfiles').doc(myId).set({
        ...profile,
        studentId: myId,
        updatedAt: new Date().toISOString()
      });
      alert('‚úÖ Profile saved successfully!');
      return true;
    } catch (error) {
      console.error('Error saving profile:', error);
      alert('‚ùå Error saving profile: ' + error.message);
      return false;
    }
  };

  const handleToggleEdit = async () => {
    if (isEditing) {
      // closing edit ‚Üí save
      const saved = await handleSave();
      if (saved) {
        setIsEditing(false);
      }
    } else {
      setIsEditing(true);
    }
  };

  const completion = calculateCompletion();

  const inputCls = (extra = '') =>
    `w-full border-2 px-4 py-3 rounded-xl ${extra} ${
      !isEditing ? 'bg-gray-100 cursor-not-allowed' : ''
    }`;

  const disabled = !isEditing;

  if (loading) {
    return <div className="text-center py-8">Loading profile...</div>;
  }

  return (
    <div className="space-y-6">
      {/* Header with Student ID */}
      <div className="bg-gradient-to-r from-blue-500 to-purple-600 text-white p-6 rounded-2xl shadow-lg">
        <div className="flex justify-between items-start flex-wrap gap-4">
          <div>
            <h2 className="text-3xl font-bold">üë§ My Profile</h2>
            <div className="flex flex-wrap gap-2 mt-3">
              <span className="px-3 py-1 bg-white/30 text-white rounded-lg text-sm font-mono">
                Student ID: {myId}
              </span>
              <span className="px-3 py-1 bg-white/30 text-white rounded-lg text-sm">
                {currentUser.school}
              </span>
              <span className="px-3 py-1 bg-white/30 text-white rounded-lg text-sm">
                Class {currentUser.grade}
              </span>
            </div>
          </div>
          <div className="flex items-center gap-4">
            <div className="text-right">
              <div className="text-sm opacity-90">Profile Completion</div>
              <div
                className="text-3xl font-bold"
                style={{
                  color:
                    completion >= 80
                      ? '#86EFAC'
                      : completion >= 50
                      ? '#FCD34D'
                      : '#FCA5A5'
                }}
              >
                {completion}%
              </div>
            </div>
            <button
              onClick={handleToggleEdit}
              className="px-4 py-2 bg-white text-blue-600 rounded-xl font-semibold hover:bg-blue-50"
            >
              {isEditing ? 'Save' : 'Edit'}
            </button>
          </div>
        </div>
      </div>

      {completion < 100 && (
        <div className="bg-orange-50 border-2 border-orange-300 p-4 rounded-xl">
          <p className="text-orange-800 font-semibold">
            ‚ö†Ô∏è Click Edit, complete your profile and then press Save.
          </p>
        </div>
      )}

      <div className="bg-white p-6 rounded-2xl shadow-lg space-y-6">
        {/* Personal Information */}
        <div className="border-4 border-blue-500 rounded-2xl p-6 bg-blue-50">
          <h3 className="text-2xl font-bold mb-4 text-blue-800">üìã Personal Information</h3>
          <div className="grid md:grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-bold mb-2">First Name *</label>
              <input
                type="text"
                value={profile.firstName}
                disabled={disabled}
                onChange={e => setProfile({ ...profile, firstName: e.target.value })}
                className={inputCls()}
              />
            </div>
            <div>
              <label className="block text-sm font-bold mb-2">Last Name *</label>
              <input
                type="text"
                value={profile.lastName}
                disabled={disabled}
                onChange={e => setProfile({ ...profile, lastName: e.target.value })}
                className={inputCls()}
              />
            </div>
            <div>
              <label className="block text-sm font-bold mb-2">Email ID *</label>
              <input
                type="email"
                value={profile.email}
                disabled={disabled}
                onChange={e => setProfile({ ...profile, email: e.target.value })}
                className={inputCls()}
              />
            </div>
            <div>
              <label className="block text-sm font-bold mb-2">Phone Number *</label>
              <input
                type="tel"
                value={profile.phone}
                disabled={disabled}
                onChange={e => setProfile({ ...profile, phone: e.target.value })}
                className={inputCls()}
              />
            </div>
            <div>
              <label className="block text-sm font-bold mb-2">Date of Birth *</label>
              <input
                type="date"
                value={profile.dob}
                disabled={disabled}
                onChange={e => setProfile({ ...profile, dob: e.target.value })}
                className={inputCls()}
              />
            </div>
            <div>
              <label className="block text-sm font-bold mb-2">Class *</label>
              <select
                value={profile.grade}
                disabled={disabled}
                onChange={e => setProfile({ ...profile, grade: e.target.value })}
                className={inputCls()}
              >
                <option value="">Select</option>
                <option value="11">11th</option>
                <option value="12">12th</option>
              </select>
            </div>
            <div>
              <label className="block text-sm font-bold mb-2">Category *</label>
              <select
                value={profile.category}
                disabled={disabled}
                onChange={e => setProfile({ ...profile, category: e.target.value })}
                className={inputCls()}
              >
                <option value="">Select</option>
                {CATEGORIES.map(c => (
                  <option key={c} value={c}>{c}</option>
                ))}
              </select>
            </div>
            <div>
              <label className="block text-sm font-bold mb-2">Stream *</label>
              <select
                value={profile.stream}
                disabled={disabled}
                onChange={e => setProfile({ ...profile, stream: e.target.value })}
                className={inputCls()}
              >
                <option value="">Select</option>
                {STREAMS.map(s => (
                  <option key={s} value={s}>{s}</option>
                ))}
              </select>
            </div>
            <div>
              <label className="block text-sm font-bold mb-2">School *</label>
              <select
                value={profile.school}
                disabled={disabled}
                onChange={e => setProfile({ ...profile, school: e.target.value })}
                className={inputCls()}
              >
                <option value="">Select</option>
                {SCHOOLS.map(s => (
                  <option key={s} value={s}>{s}</option>
                ))}
              </select>
            </div>
            <div>
              <label className="block text-sm font-bold mb-2">
                10th Overall Percentage *
              </label>
              <input
                type="number"
                step="0.01"
                value={profile.percentage10th}
                disabled={disabled}
                onChange={e => setProfile({ ...profile, percentage10th: e.target.value })}
                className={inputCls()}
                placeholder="e.g. 85.5"
              />
            </div>
            <div>
              <label className="block text-sm font-bold mb-2">
                11th Overall Percentage (Optional)
              </label>
              <input
                type="number"
                step="0.01"
                value={profile.percentage11th}
                disabled={disabled}
                onChange={e => setProfile({ ...profile, percentage11th: e.target.value })}
                className={inputCls()}
                placeholder="e.g. 80.0"
              />
            </div>
          </div>
        </div>

        {/* Parent Information */}
        <div className="border-4 border-purple-500 rounded-2xl p-6 bg-purple-50">
          <h3 className="text-2xl font-bold mb-4 text-purple-800">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Parent Information</h3>
          <div className="grid md:grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-bold mb-2">Father's Name *</label>
              <input
                type="text"
                value={profile.fatherName}
                disabled={disabled}
                onChange={e => setProfile({ ...profile, fatherName: e.target.value })}
                className={inputCls()}
              />
            </div>
            <div>
              <label className="block text-sm font-bold mb-2">Mother's Name *</label>
              <input
                type="text"
                value={profile.motherName}
                disabled={disabled}
                onChange={e => setProfile({ ...profile, motherName: e.target.value })}
                className={inputCls()}
              />
            </div>
            <div>
              <label className="block text-sm font-bold mb-2">Father's Occupation *</label>
              <select
                value={profile.fatherOccupation}
                disabled={disabled}
                onChange={e => setProfile({ ...profile, fatherOccupation: e.target.value, fatherOccupationOther: '' })}
                className={inputCls()}
              >
                <option value="">Select Occupation</option>
                {OCCUPATIONS.map(o => <option key={o} value={o}>{o}</option>)}
              </select>
              {profile.fatherOccupation === 'Others' && (
                <input
                  type="text"
                  placeholder="Please specify occupation"
                  value={profile.fatherOccupationOther}
                  disabled={disabled}
                  onChange={e => setProfile({ ...profile, fatherOccupationOther: e.target.value })}
                  className={inputCls('mt-2')}
                />
              )}
            </div>
            <div>
              <label className="block text-sm font-bold mb-2">Mother's Occupation *</label>
              <select
                value={profile.motherOccupation}
                disabled={disabled}
                onChange={e => setProfile({ ...profile, motherOccupation: e.target.value, motherOccupationOther: '' })}
                className={inputCls()}
              >
                <option value="">Select Occupation</option>
                {OCCUPATIONS.map(o => <option key={o} value={o}>{o}</option>)}
              </select>
              {profile.motherOccupation === 'Others' && (
                <input
                  type="text"
                  placeholder="Please specify occupation"
                  value={profile.motherOccupationOther}
                  disabled={disabled}
                  onChange={e => setProfile({ ...profile, motherOccupationOther: e.target.value })}
                  className={inputCls('mt-2')}
                />
              )}
            </div>
            <div>
              <label className="block text-sm font-bold mb-2">Father's Education *</label>
              <select
                value={profile.fatherEducation}
                disabled={disabled}
                onChange={e => setProfile({ ...profile, fatherEducation: e.target.value, fatherEducationOther: '' })}
                className={inputCls()}
              >
                <option value="">Select Education</option>
                {EDUCATION_LEVELS.map(e => <option key={e} value={e}>{e}</option>)}
              </select>
              {profile.fatherEducation === 'Others' && (
                <input
                  type="text"
                  placeholder="Please specify education"
                  value={profile.fatherEducationOther}
                  disabled={disabled}
                  onChange={e => setProfile({ ...profile, fatherEducationOther: e.target.value })}
                  className={inputCls('mt-2')}
                />
              )}
            </div>
            <div>
              <label className="block text-sm font-bold mb-2">Mother's Education *</label>
              <select
                value={profile.motherEducation}
                disabled={disabled}
                onChange={e => setProfile({ ...profile, motherEducation: e.target.value, motherEducationOther: '' })}
                className={inputCls()}
              >
                <option value="">Select Education</option>
                {EDUCATION_LEVELS.map(e => <option key={e} value={e}>{e}</option>)}
              </select>
              {profile.motherEducation === 'Others' && (
                <input
                  type="text"
                  placeholder="Please specify education"
                  value={profile.motherEducationOther}
                  disabled={disabled}
                  onChange={e => setProfile({ ...profile, motherEducationOther: e.target.value })}
                  className={inputCls('mt-2')}
                />
              )}
            </div>
            <div>
              <label className="block text-sm font-bold mb-2">Family Income *</label>
              <select
                value={profile.familyIncome}
                disabled={disabled}
                onChange={e => setProfile({ ...profile, familyIncome: e.target.value })}
                className={inputCls()}
              >
                <option value="">Select Income Range</option>
                {INCOME_RANGES.map(i => <option key={i} value={i}>{i}</option>)}
              </select>
            </div>
          </div>
        </div>

        {/* Contact Details */}
        <div className="border-4 border-green-500 rounded-2xl p-6 bg-green-50">
          <h3 className="text-2xl font-bold mb-4 text-green-800">üìÆ Contact Details</h3>
          <div className="grid md:grid-cols-2 gap-4">
            <div className="md:col-span-2">
              <label className="block text-sm font-bold mb-2">Address *</label>
              <input
                type="text"
                value={profile.address}
                disabled={disabled}
                onChange={e => setProfile({ ...profile, address: e.target.value })}
                className={inputCls()}
              />
            </div>
            <div>
              <label className="block text-sm font-bold mb-2">State *</label>
              <select
                value={profile.state}
                disabled={disabled}
                onChange={e => setProfile({ ...profile, state: e.target.value, district: '', districtOther: '' })}
                className={inputCls()}
              >
                <option value="">Select State</option>
                {INDIAN_STATES.map(s => <option key={s} value={s}>{s}</option>)}
                <option value="Others">Others</option>
              </select>
              {profile.state === 'Others' && (
                <input
                  type="text"
                  placeholder="Please specify state"
                  value={profile.stateOther}
                  disabled={disabled}
                  onChange={e => setProfile({ ...profile, stateOther: e.target.value })}
                  className={inputCls('mt-2')}
                />
              )}
            </div>
            <div>
              <label className="block text-sm font-bold mb-2">District *</label>
              <select
                value={profile.district}
                disabled={disabled || !profile.state || profile.state === 'Others'}
                onChange={e => setProfile({ ...profile, district: e.target.value, districtOther: '' })}
                className={inputCls()}
              >
                <option value="">Select District</option>
                {profile.state && profile.state !== 'Others' && STATE_DISTRICTS[profile.state] && 
                  STATE_DISTRICTS[profile.state].map(d => <option key={d} value={d}>{d}</option>)}
                <option value="Others">Others</option>
              </select>
              {profile.district === 'Others' && (
                <input
                  type="text"
                  placeholder="Please specify district"
                  value={profile.districtOther}
                  disabled={disabled}
                  onChange={e => setProfile({ ...profile, districtOther: e.target.value })}
                  className={inputCls('mt-2')}
                />
              )}
            </div>
            <div>
              <label className="block text-sm font-bold mb-2">Pincode *</label>
              <input
                type="text"
                value={profile.pincode}
                disabled={disabled}
                onChange={e => setProfile({ ...profile, pincode: e.target.value })}
                className={inputCls()}
              />
            </div>
            <div>
              <label className="block text-sm font-bold mb-2">WhatsApp Number *</label>
              <input
                type="text"
                value={profile.whatsappNumber}
                disabled={disabled}
                onChange={e => setProfile({ ...profile, whatsappNumber: e.target.value })}
                className={inputCls()}
              />
            </div>
          </div>
        </div>
      </div>
      {/* Academic Info (optional extras ‚Äì currently just shows percentages again if needed) */}
      <div className="border-4 border-indigo-500 rounded-2xl p-6 bg-indigo-50">
        <div className="flex justify-between items-center mb-4">
          <h3 className="text-2xl font-bold text-indigo-800">üéì Academic Information</h3>
          <button
            onClick={handleToggleEdit}
            className="px-4 py-2 rounded-xl font-semibold text-sm bg-indigo-600 text-white"
          >
            {isEditing ? 'Save' : 'Edit'}
          </button>
        </div>
        <p className="text-sm text-gray-600">
          You can update your marks / percentages here whenever results are updated.
        </p>
        <div className="grid md:grid-cols-2 gap-4 mt-4">
          <div>
            <label className="block text-sm font-bold mb-2">10th Percentage *</label>
            <input
              type="number"
              step="0.01"
              className={inputCls()}
              disabled={!isEditing}
              value={profile.percentage10th}
              onChange={e => setProfile({ ...profile, percentage10th: e.target.value })}
            />
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">11th Percentage (Optional)</label>
            <input
              type="number"
              step="0.01"
              className={inputCls()}
              disabled={!isEditing}
              value={profile.percentage11th}
              onChange={e => setProfile({ ...profile, percentage11th: e.target.value })}
            />
          </div>
        </div>
      </div>
    </div>
  );
}

// ========================================
// STUDENT EXAM REGISTRATION COMPONENT
// ========================================
function StudentExamRegistration({currentUser}) {
  const myId = currentUser.studentId || currentUser.id;
  const myGrade = currentUser.grade;
  const [exams, setExams] = useState([]);
  const [loading, setLoading] = useState(true);
  const [expandedExams, setExpandedExams] = useState(new Set());
  const [editingExams, setEditingExams] = useState(new Set());

  useEffect(() => {
    const fetchExams = async () => {
      try {
        const docSnap = await db.collection('studentExamRegistrations').doc(myId).get();
        if (docSnap.exists) {
          setExams(docSnap.data().exams || []);
        }
        setLoading(false);
      } catch (e) {
        console.error('Error fetching exam registrations:', e);
        setLoading(false);
      }
    };
    fetchExams();
  }, [myId]);

  const handleAddExam = () => {
    const newExams = [...exams, {
      examName: '',
      registrationStatus: 'No',
      registrationNumber: '',
      password: '',
      emailUsed: '',
      phoneUsed: '',
      reasonNotCompleted: '',
      needSupport: 'No',
      supportType: ''
    }];
    setExams(newExams);
    // Auto-expand and edit the new exam
    const newIndex = newExams.length - 1;
    setExpandedExams(new Set([...expandedExams, newIndex]));
    setEditingExams(new Set([...editingExams, newIndex]));
  };

  const handleRemoveExam = (index) => {
    const updated = [...exams];
    updated.splice(index, 1);
    setExams(updated);
    // Remove from expanded and editing sets
    const newExpanded = new Set(expandedExams);
    const newEditing = new Set(editingExams);
    newExpanded.delete(index);
    newEditing.delete(index);
    setExpandedExams(newExpanded);
    setEditingExams(newEditing);
  };

  const handleExamChange = (index, field, value) => {
    const updated = [...exams];
    updated[index][field] = value;
    setExams(updated);
  };

  const toggleExpand = (index) => {
    const newExpanded = new Set(expandedExams);
    if (newExpanded.has(index)) {
      newExpanded.delete(index);
    } else {
      newExpanded.add(index);
    }
    setExpandedExams(newExpanded);
  };

  const toggleEdit = (index) => {
  const newEditing = new Set(editingExams);
  const newExpanded = new Set(expandedExams);

  if (newEditing.has(index)) {
    // closing edit
    newEditing.delete(index);
  } else {
    // going into edit ‚Üí also expand this exam
    newEditing.add(index);
    newExpanded.add(index);
  }

  setEditingExams(newEditing);
  setExpandedExams(newExpanded);
};

  const handleSave = async () => {
    try {
      await db.collection('studentExamRegistrations').doc(myId).set({
        studentId: myId,
        studentName: currentUser.name,
        school: currentUser.school,
        grade: myGrade,
        exams,
        updatedAt: new Date().toISOString()
      });
      alert('‚úÖ Exam registrations saved successfully!');
      // Collapse all exams and exit edit mode
      setExpandedExams(new Set());
      setEditingExams(new Set());
    } catch (e) {
      alert('Failed to save: ' + e.message);
    }
  };

  const examList = myGrade === '12' ? EXAMS_12TH : EXAMS_11TH;

  if (loading) {
    return <div className="text-center py-8">Loading exam registrations...</div>;
  }

  return (
    <div className="space-y-6">
      <div className="flex justify-between items-center">
        <h2 className="text-3xl font-bold">üìù Exam Registration</h2>
        <button onClick={handleAddExam} className="px-6 py-3 bg-blue-600 text-white rounded-xl font-semibold">
          + Add Exam
        </button>
      </div>

      {myGrade === '11' && (
        <div className="bg-blue-50 border-2 border-blue-300 p-4 rounded-xl">
          <p className="font-semibold text-blue-800">
            üìå Class 11: Please list the competitive exams you're interested in appearing for in the future.
          </p>
        </div>
      )}

      {exams.length === 0 ? (
        <div className="bg-white p-8 rounded-2xl text-center">
          <p className="text-gray-600">No exam registrations added yet. Click "+ Add Exam" to start.</p>
        </div>
      ) : (
        exams.map((exam, index) => {
          const isExpanded = expandedExams.has(index);
          const isEditing = editingExams.has(index);
          
          return (
          <div key={index} className="bg-white p-6 rounded-2xl shadow-lg">
            <div className="flex justify-between items-center mb-4">
              <div className="flex items-center gap-3">
                <button 
                  onClick={() => toggleExpand(index)}
                  className="text-2xl"
                >
                  {isExpanded ? '‚ñº' : '‚ñ∂'}
                </button>
                <h3 className="text-xl font-bold">
                  {exam.examName || `Exam ${index + 1}`}
                </h3>
                {exam.registrationStatus === 'Yes' && (
                  <span className="px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm font-bold">
                    ‚úì Completed
                  </span>
                )}
              </div>
              <div className="flex gap-2">
                <button 
                  onClick={() => toggleEdit(index)} 
                  className="px-4 py-2 bg-blue-500 text-white rounded-lg"
                >
                  {isEditing ? 'üíæ Save' : '‚úèÔ∏è Edit'}
                </button>
                <button 
                  onClick={() => handleRemoveExam(index)} 
                  className="px-4 py-2 bg-red-500 text-white rounded-lg"
                >
                  Remove
                </button>
              </div>
            </div>

            {isExpanded && (
            <div className="grid md:grid-cols-2 gap-4">
              <div className="md:col-span-2">
                <label className="block text-sm font-bold mb-2">Exam Name *</label>
                <select value={exam.examName} onChange={e => handleExamChange(index, 'examName', e.target.value)} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed">
                  <option value="">Select Exam</option>
                  {examList.map(e => <option key={e} value={e}>{e}</option>)}
                </select>
              </div>

              {myGrade === '12' && (
                <>
                  <div className="md:col-span-2">
                    <label className="block text-sm font-bold mb-2">Registration Completed? *</label>
                    <select value={exam.registrationStatus} onChange={e => handleExamChange(index, 'registrationStatus', e.target.value)} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed">
                      <option value="No">No</option>
                      <option value="Partially">Partially Completed</option>
                      <option value="Yes">Yes - Fully Completed</option>
                    </select>
                  </div>

                  {exam.registrationStatus === 'Yes' && (
                    <>
                      <div>
                        <label className="block text-sm font-bold mb-2">Registration Number *</label>
                        <input type="text" value={exam.registrationNumber} onChange={e => handleExamChange(index, 'registrationNumber', e.target.value)} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed" />
                      </div>
                      <div>
                        <label className="block text-sm font-bold mb-2">Password *</label>
                        <input type="text" value={exam.password} onChange={e => handleExamChange(index, 'password', e.target.value)} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed" />
                      </div>
                      <div>
                        <label className="block text-sm font-bold mb-2">Email Used for Registration *</label>
                        <input type="email" value={exam.emailUsed} onChange={e => handleExamChange(index, 'emailUsed', e.target.value)} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed" />
                      </div>
                      <div>
                        <label className="block text-sm font-bold mb-2">Phone Number Used *</label>
                        <input type="tel" value={exam.phoneUsed} onChange={e => handleExamChange(index, 'phoneUsed', e.target.value)} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed" />
                      </div>
                    </>
                  )}

                  {exam.registrationStatus === 'No' && (
                    <div className="md:col-span-2">
                      <label className="block text-sm font-bold mb-2">Why is the registration not completed? *</label>
                      <textarea value={exam.reasonNotCompleted} onChange={e => handleExamChange(index, 'reasonNotCompleted', e.target.value)} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed" rows="3" />
                    </div>
                  )}

                  <div className="md:col-span-2">
                    <label className="block text-sm font-bold mb-2">Do you need help/support to complete this application? *</label>
                    <select value={exam.needSupport} onChange={e => handleExamChange(index, 'needSupport', e.target.value)} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed">
                      <option value="No">No</option>
                      <option value="Yes">Yes</option>
                    </select>
                  </div>

                  {exam.needSupport === 'Yes' && (
                    <div className="md:col-span-2">
                      <label className="block text-sm font-bold mb-2">What kind of help do you need? *</label>
                      <textarea value={exam.supportType} onChange={e => handleExamChange(index, 'supportType', e.target.value)} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed" rows="3" placeholder="Please describe the support you need..." />
                    </div>
                  )}
                </>
              )}
            </div>
            )}
          </div>
        );
        })
      )}

      <button onClick={handleSave} className="w-full avanti-gradient text-white py-4 rounded-xl font-bold text-xl">
        üíæ Save Exam Registrations
      </button>
    </div>
  );
}

// ========================================
// COMPLETE STUDENT DASHBOARD - REPLACE EXISTING
// ========================================
function StudentDashboard({currentUser, handleLogout}) {
  const [activeTab, setActiveTab] = useState('dashboard');
  const [loading, setLoading] = useState(true);  // ‚¨ÖÔ∏è ADD THIS LINE
  const [curriculum, setCurriculum] = useState({});
  const [chapterProgress, setChapterProgress] = useState({});
  const [studentAttendance, setStudentAttendance] = useState([]);
  const [teachers, setTeachers] = useState([]);
  const [studentProfile, setStudentProfile] = useState(null);
  const [examRegistrations, setExamRegistrations] = useState(null);
  const [teacherFeedbacks, setTeacherFeedbacks] = useState([]);
  const [selectedTeacher, setSelectedTeacher] = useState(null);
  const [showTeacherProfile, setShowTeacherProfile] = useState(false);
  const [showFeedbackForm, setShowFeedbackForm] = useState(false);
  const [showFeedbackNotification, setShowFeedbackNotification] = useState(false);
  
  const mySchool = currentUser.school;
  const myGrade = currentUser.grade;
  const myId = currentUser.studentId || currentUser.id;

useEffect(() => {
  const fetchData = async () => {
    try {
      // Curriculum
      const currMap = {};
      const currSnap = await db.collection('curriculum').get();
      currSnap.docs.forEach(doc => { currMap[doc.id] = doc.data(); });
      setCurriculum(currMap);

      // Chapter progress
      const progressMap = {};
      const progressSnap = await db.collection('chapterProgress').get();
      progressSnap.docs.forEach(d => { progressMap[d.id] = d.data(); });
      setChapterProgress(progressMap);

      // ‚úÖ ALL attendance records for this student (no date filter)
      const attSnap = await db.collection('studentAttendance')
        .where('studentId', '==', String(myId))
        .get();

      const attendanceData = attSnap.docs
        .map(d => ({ ...d.data(), docId: d.id }))
        .sort((a, b) => b.date.localeCompare(a.date));

      setStudentAttendance(attendanceData);

      // Teachers from this school
      const teacherSnap = await db.collection('teachers')
        .where('school', '==', mySchool)
        .get();
      setTeachers(teacherSnap.docs.map(d => ({ ...d.data(), docId: d.id })));

      // Exam registrations for this student
      const examSnap = await db.collection('studentExamRegistrations').doc(myId).get();
      if (examSnap.exists) {
        setExamRegistrations(examSnap.data());
      }

      setLoading(false);
    } catch (e) {
      console.error('Data fetch error:', e);
      setLoading(false);
    }
  };

  fetchData();
}, [mySchool, myGrade, myId]);


    // Calculate profile completion (same logic as Profile page)
  const calculateCompletion = () => {
    const baseProfile = studentProfile || {
      grade: myGrade,
      school: mySchool
    };

    const requiredFields = [
      'firstName', 'lastName', 'email', 'phone', 'dob', 'grade', 'category',
      'stream', 'school', 'fatherName', 'motherName', 'fatherOccupation',
      'motherOccupation', 'fatherEducation', 'motherEducation', 'familyIncome',
      'address', 'state', 'district', 'pincode', 'whatsappNumber', 'percentage10th'
    ];

    const filled = requiredFields.filter(
      field => baseProfile[field] && String(baseProfile[field]).trim() !== ''
    ).length;

    return Math.round((filled / requiredFields.length) * 100);
  };
    // üîÑ Keep student profile in sync so banner and card match
  useEffect(() => {
    if (!myId) return;

    const unsubscribe = db.collection('studentProfiles')
      .doc(myId)
      .onSnapshot(
        (doc) => {
          if (doc.exists) {
            setStudentProfile(doc.data());
          } else {
            setStudentProfile(null);
          }
        },
        (err) => {
          console.error('Profile listener error:', err);
        }
      );

    return () => unsubscribe();
  }, [myId]);

  // Fetch teacher feedbacks and check if notification needed
  useEffect(() => {
    const fetchFeedbackData = async () => {
      try {
        // Fetch all feedbacks for this student
        const feedbackSnap = await db.collection('teacherFeedback')
          .where('studentId', '==', myId)
          .get();
        setTeacherFeedbacks(feedbackSnap.docs.map(d => ({ ...d.data(), id: d.id })));

        // Check if 2 months have passed since last feedback
        if (studentProfile?.lastFeedbackDate) {
          const lastDate = new Date(studentProfile.lastFeedbackDate);
          const now = new Date();
          const diffMonths = (now.getFullYear() - lastDate.getFullYear()) * 12 + 
                            (now.getMonth() - lastDate.getMonth());
          
          if (diffMonths >= 2) {
            // Show notification after 2 seconds
            setTimeout(() => setShowFeedbackNotification(true), 2000);
          }
        } else {
          // No feedback ever given, show notification
          setTimeout(() => setShowFeedbackNotification(true), 2000);
        }
      } catch (error) {
        console.error('Error fetching feedback data:', error);
      }
    };

    if (myId && studentProfile) {
      fetchFeedbackData();
    }
  }, [myId, studentProfile]);

  // Calculate average rating for a teacher
  const getTeacherAverageRating = (teacherDocId) => {
    const teacherFeedbackList = teacherFeedbacks.filter(f => f.teacherId === teacherDocId);
    if (teacherFeedbackList.length === 0) return null;
    
    const sum = teacherFeedbackList.reduce((acc, f) => acc + (f.averageRating || 0), 0);
    return sum / teacherFeedbackList.length;
  };

  const handleTeacherClick = (teacher) => {
    setSelectedTeacher(teacher);
    setShowTeacherProfile(true);
  };

  const handleGiveFeedback = () => {
    setShowTeacherProfile(false);
    setShowFeedbackForm(true);
  };

  const handleFeedbackSubmitSuccess = () => {
    // Refresh feedback data
    const fetchFeedbackData = async () => {
      const feedbackSnap = await db.collection('teacherFeedback')
        .where('studentId', '==', myId)
        .get();
      setTeacherFeedbacks(feedbackSnap.docs.map(d => ({ ...d.data(), id: d.id })));
    };
    fetchFeedbackData();
  };

  const profileCompletion = calculateCompletion();
  
  // Debug logging
  console.log('=== STUDENT PROFILE DEBUG ===');
  console.log('üìä Profile Completion:', profileCompletion + '%');
  console.log('üë§ Student Data:', studentProfile);
  console.log('üî¢ Student ID:', myId);
  console.log('üè´ School:', mySchool);
  console.log('üìö Grade:', myGrade);
  console.log('============================');

  if (loading) {
    return <div className="text-center py-8">Loading profile...</div>;
  }
  return (
    <div className="min-h-screen bg-gray-50 flex flex-col">
      <nav className="avanti-gradient shadow-lg sticky top-0 z-50">
        <div className="max-w-7xl mx-auto px-4 py-4">
          <div className="flex justify-between items-center">
            <div className="flex items-center gap-3">
              <img src={AVANTI_LOGO} alt="Avanti" className="w-12 h-12"/>
              <div>
                <h1 className="text-2xl font-bold text-white">Student Dashboard</h1>
                <p className="text-sm text-white opacity-90">{mySchool}</p>
              </div>
            </div>
            <div className="flex items-center gap-4">
              <div className="text-right hidden sm:block">
                <p className="text-white font-semibold">{currentUser.name}</p>
                <p className="text-sm text-white opacity-90">Class {myGrade} ‚Ä¢ ID: {myId}</p>
              </div>
              <button onClick={handleLogout} className="px-4 py-2 bg-white text-gray-800 rounded-xl font-semibold">
                Logout
              </button>
            </div>
          </div>
        </div>
      </nav>

      {/* Profile Completion Warning */}
      {profileCompletion < 100 && (
        <div className="bg-red-500 text-white text-center py-3 px-4">
          <p className="font-bold">
            ‚ö†Ô∏è Your profile is {profileCompletion}% complete. Please complete your profile!
          </p>
        </div>
      )}

      <div className="flex-1 max-w-7xl mx-auto px-4 py-6 w-full">
        <div className="flex gap-3 mb-6 overflow-x-auto pb-2">
          {['dashboard', 'profile', 'curriculum', 'attendance', 'exams'].map(tab => (
            <button key={tab} onClick={() => setActiveTab(tab)} 
              className={`px-6 py-3 rounded-xl font-semibold whitespace-nowrap ${activeTab === tab ? 'avanti-gradient text-white' : 'bg-white'}`}>
              {tab === 'dashboard' && 'üìä Dashboard'}
              {tab === 'profile' && 'üë§ My Profile'}
              {tab === 'curriculum' && 'üìö Curriculum'}
              {tab === 'attendance' && '‚úÖ Attendance'}
              {tab === 'exams' && 'üìù Exam Registration'}
            </button>
          ))}
        </div>

                {/* Dashboard Tab */}
        {activeTab === 'dashboard' && (
          <div className="space-y-6">
            <h2 className="text-3xl font-bold">Welcome, {currentUser.name}! üëã</h2>

            {/* Top stats cards */}
            <div className="grid md:grid-cols-5 gap-4">
              <div className="stat-card bg-blue-500 text-white">
                <div className="text-sm opacity-90">My School</div>
                <div className="text-xl font-bold">{mySchool}</div>
              </div>

              <div className="stat-card bg-green-500 text-white">
                <div className="text-sm opacity-90">My Class</div>
                <div className="text-2xl font-bold">Class {myGrade}</div>
              </div>

              <div className="stat-card bg-purple-500 text-white">
                <div className="text-sm opacity-90">Profile Complete</div>
                <div className="text-2xl font-bold">{profileCompletion}%</div>
              </div>

              <div className="stat-card bg-green-500 text-white">
                <div className="text-sm opacity-90">Days Present</div>
                <div className="text-2xl font-bold">
                  {studentAttendance.filter(a => a.status === 'Present').length}
                </div>
              </div>

              <div className="stat-card bg-red-500 text-white">
                <div className="text-sm opacity-90">Days Absent</div>
                <div className="text-2xl font-bold">
                  {studentAttendance.filter(a => a.status === 'Absent').length}
                </div>
              </div>
            </div>

            {/* My Teachers */}
            <div className="bg-white p-6 rounded-2xl shadow-lg">
              <h3 className="text-2xl font-bold mb-4">üë®‚Äçüè´ My Teachers</h3>
              {teachers.length === 0 ? (
                <p className="text-gray-500 text-center py-4">No teachers found</p>
              ) : (
                <div className="grid md:grid-cols-2 gap-4">
                  {SUBJECTS.map(subject => {
                    // Find active (non-archived) teacher for this subject
                    const teacher = teachers.find(t => t.subject === subject && !t.isArchived);
                    const archivedTeacher = teachers.find(t => t.subject === subject && t.isArchived);
                    const averageRating = teacher ? getTeacherAverageRating(teacher.docId) : null;
                    
                    // Determine display status
                    const isVacant = !teacher;
                    const wasArchived = !teacher && archivedTeacher;
                    
                    return (
                      <div 
                        key={subject} 
                        className={`teacher-card border-2 rounded-xl p-4 ${
                          isVacant ? 'bg-yellow-50 border-yellow-300' : ''
                        }`}
                        onClick={() => teacher && !teacher.isArchived && handleTeacherClick(teacher)}
                      >
                        <div className="font-bold text-lg">{subject}</div>
                        <div className="flex items-center justify-between">
                          <div className={isVacant ? 'text-orange-600 font-medium' : 'text-gray-600'}>
                            {teacher ? teacher.name : (
                              <span>
                                üî∏ Vacant
                                {wasArchived && (
                                  <span className="text-xs text-gray-500 ml-1">(Previously: {archivedTeacher.name})</span>
                                )}
                              </span>
                            )}
                          </div>
                          {averageRating && (
                            <div className="flex items-center gap-2">
                              <span className="text-yellow-500 font-bold">‚òÖ</span>
                              <span className="font-semibold">{averageRating.toFixed(1)}</span>
                            </div>
                          )}
                        </div>
                        {teacher && !teacher.isArchived && (
                          <div className="text-sm text-blue-600 mt-2">Click to view profile ‚Üí</div>
                        )}
                        {isVacant && (
                          <div className="text-sm text-orange-500 mt-2">New teacher to be assigned</div>
                        )}
                      </div>
                    );
                  })}
                </div>
              )}
            </div>

            {/* Pending Chapters */}
            <div className="bg-white p-6 rounded-2xl shadow-lg">
              <h3 className="text-2xl font-bold mb-4">üìö Pending Chapters</h3>
              {SUBJECTS.map(subject => {
                const docId = `${mySchool}_${subject}_${myGrade}`;
                const chapters = curriculum[docId]?.chapters || [];
                const pendingChapters = chapters.filter(ch => {
                  const progressId = `${mySchool}_${ch.id}`;
                  const prog = chapterProgress[progressId] || {};
                  return prog.completed !== 'Yes';
                });

                if (pendingChapters.length === 0) return null;

                return (
                  <div key={subject} className="mb-4">
                    <h4 className="font-bold text-lg mb-2">{subject} ({pendingChapters.length} pending)</h4>
                    <ul className="list-disc list-inside space-y-1">
                      {pendingChapters.slice(0, 5).map(ch => (
                        <li key={ch.id} className="text-gray-700">{ch.name}</li>
                      ))}
                      {pendingChapters.length > 5 && (
                        <li className="text-gray-500 italic">...and {pendingChapters.length - 5} more</li>
                      )}
                    </ul>
                  </div>
                );
              })}
            </div>
          </div>
        )}

        {/* Profile Tab */}
{activeTab === 'profile' && (
  <StudentProfileForm
    currentUser={currentUser}
    onProfileUpdated={(updatedProfile) => setStudentProfile(updatedProfile)}
  />
)}


        {/* Curriculum Tab */}
        {activeTab === 'curriculum' && (
          <StudentCurriculumWithPriority 
            mySchool={mySchool}
            myGrade={myGrade}
            curriculum={curriculum}
            chapterProgress={chapterProgress}
          />
        )}

        {/* Attendance Tab */}
        {activeTab === 'attendance' && (
          <div className="space-y-6">
            <h2 className="text-3xl font-bold">‚úÖ My Attendance Record</h2>
            <div className="bg-white p-6 rounded-2xl shadow-lg">
              <div className="overflow-x-auto">
                <table className="w-full">
                  <thead className="avanti-gradient-light">
                    <tr>
                      <th className="p-3 text-left">Date</th>
                      <th className="p-3 text-left">Status</th>
                      <th className="p-3 text-left">Remarks</th>
                    </tr>
                  </thead>
                  <tbody>
                    {studentAttendance.length === 0 ? (
                      <tr><td colSpan="3" className="p-8 text-center text-gray-500">No attendance records</td></tr>
                    ) : (
                      studentAttendance.map((record, idx) => (
                        <tr key={idx} className="border-b hover:bg-gray-50">
                          <td className="p-3">{record.date}</td>
                          <td className="p-3">
                            <span className={`px-3 py-1 rounded-full text-sm font-bold ${
                              record.status === 'Present' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'
                            }`}>
                              {record.status}
                            </span>
                          </td>
                          <td className="p-3 text-sm">{record.remarks || '‚Äî'}</td>
                        </tr>
                      ))
                    )}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        )}

        {/* Exams Tab */}
        {activeTab === 'exams' && <StudentExamRegistration currentUser={currentUser} />}
      </div>

      {/* Teacher Profile Modal */}
      {showTeacherProfile && selectedTeacher && (
        <TeacherProfileModal
          teacher={selectedTeacher}
          onClose={() => setShowTeacherProfile(false)}
          onGiveFeedback={handleGiveFeedback}
          averageRating={getTeacherAverageRating(selectedTeacher.docId)}
        />
      )}

      {/* Teacher Feedback Form */}
      {showFeedbackForm && selectedTeacher && (
        <TeacherFeedbackForm
          teacher={selectedTeacher}
          studentId={myId}
          studentInfo={currentUser}
          onClose={() => setShowFeedbackForm(false)}
          onSubmitSuccess={handleFeedbackSubmitSuccess}
        />
      )}

      {/* Feedback Notification */}
      {showFeedbackNotification && (
        <FeedbackNotification
          onClose={() => setShowFeedbackNotification(false)}
          onGiveFeedback={() => {
            setShowFeedbackNotification(false);
            setActiveTab('dashboard');
          }}
        />
      )}

      <footer className="bg-gray-800 text-white text-center py-4 mt-auto">
        <p>Made by Anand with ‚ù§Ô∏è</p>
      </footer>
    </div>
  );
}

// ========================================
// 2FA (TWO-FACTOR AUTHENTICATION) HELPERS
// ========================================

// Generate a new TOTP secret for 2FA
function generate2FASecret(email) {
  const secret = new OTPAuth.Secret({ size: 20 });
  return secret.base32;
}

// Generate TOTP URI for QR code
function generate2FAURI(email, secret) {
  const totp = new OTPAuth.TOTP({
    issuer: 'Avanti Curriculum Tracker',
    label: email,
    algorithm: 'SHA1',
    digits: 6,
    period: 30,
    secret: OTPAuth.Secret.fromBase32(secret)
  });
  return totp.toString();
}

// Verify a TOTP code
function verify2FACode(secret, code) {
  try {
    const totp = new OTPAuth.TOTP({
      issuer: 'Avanti Curriculum Tracker',
      algorithm: 'SHA1',
      digits: 6,
      period: 30,
      secret: OTPAuth.Secret.fromBase32(secret)
    });
    // Allow 2 windows of time drift (60 seconds before/after) for users in remote areas with poor signal
    // This helps when phone clocks are slightly out of sync or network is slow
    const delta = totp.validate({ token: code, window: 2 });
    return delta !== null;
  } catch (e) {
    console.error('2FA verification error:', e);
    return false;
  }
}

// Generate backup codes
function generateBackupCodes(count = 8) {
  const codes = [];
  for (let i = 0; i < count; i++) {
    const code = Math.random().toString(36).substring(2, 6).toUpperCase() + 
                 '-' + 
                 Math.random().toString(36).substring(2, 6).toUpperCase();
    codes.push(code);
  }
  return codes;
}

// Hash a backup code for storage (simple hash for demo - in production use bcrypt)
function hashBackupCode(code) {
  let hash = 0;
  const str = code.replace('-', '').toUpperCase();
  for (let i = 0; i < str.length; i++) {
    const char = str.charCodeAt(i);
    hash = ((hash << 5) - hash) + char;
    hash = hash & hash;
  }
  return Math.abs(hash).toString(16);
}

// Verify a backup code
function verifyBackupCode(inputCode, hashedCodes) {
  const inputHash = hashBackupCode(inputCode);
  const index = hashedCodes.findIndex(h => h.hash === inputHash && !h.used);
  return index;
}

// ========================================
// DEVICE TRUST MANAGEMENT FOR 2FA
// ========================================

// Generate a unique device ID
function generateDeviceId() {
  const array = new Uint8Array(32);
  crypto.getRandomValues(array);
  return Array.from(array, byte => byte.toString(16).padStart(2, '0')).join('');
}

// Get or create device ID for this browser
function getDeviceId() {
  let deviceId = localStorage.getItem('avanti_device_id');
  if (!deviceId) {
    deviceId = generateDeviceId();
    localStorage.setItem('avanti_device_id', deviceId);
  }
  return deviceId;
}

// Check if current device is trusted for a user
async function isDeviceTrusted(userId) {
  try {
    const deviceId = getDeviceId();
    const trustedDevicesDoc = await db.collection('trustedDevices').doc(userId).get();
    
    if (!trustedDevicesDoc.exists) return false;
    
    const devices = trustedDevicesDoc.data().devices || [];
    const trustedDevice = devices.find(d => d.deviceId === deviceId && d.active);
    
    if (trustedDevice) {
      // Check if device trust has expired (30 days)
      const trustDate = new Date(trustedDevice.trustedAt);
      const now = new Date();
      const daysDiff = (now - trustDate) / (1000 * 60 * 60 * 24);
      
      if (daysDiff > 30) {
        // Trust expired, remove device
        await removeDeviceTrust(userId, deviceId);
        return false;
      }
      return true;
    }
    return false;
  } catch (e) {
    console.error('Error checking device trust:', e);
    return false;
  }
}

// Add current device as trusted for a user
async function addDeviceTrust(userId, userEmail) {
  try {
    const deviceId = getDeviceId();
    const deviceInfo = {
      deviceId: deviceId,
      trustedAt: new Date().toISOString(),
      userAgent: navigator.userAgent.substring(0, 200),
      active: true
    };
    
    const docRef = db.collection('trustedDevices').doc(userId);
    const doc = await docRef.get();
    
    if (doc.exists) {
      const devices = doc.data().devices || [];
      // Remove any existing entry for this device
      const filteredDevices = devices.filter(d => d.deviceId !== deviceId);
      // Add new trust (keep max 5 devices)
      const updatedDevices = [...filteredDevices.slice(-4), deviceInfo];
      await docRef.update({ devices: updatedDevices, userEmail: userEmail });
    } else {
      await docRef.set({ 
        devices: [deviceInfo], 
        userEmail: userEmail,
        createdAt: new Date().toISOString()
      });
    }
    
    console.log('‚úÖ Device trusted for user:', userId);
    return true;
  } catch (e) {
    console.error('Error adding device trust:', e);
    return false;
  }
}

// Remove device trust
async function removeDeviceTrust(userId, deviceId) {
  try {
    const docRef = db.collection('trustedDevices').doc(userId);
    const doc = await docRef.get();
    
    if (doc.exists) {
      const devices = doc.data().devices || [];
      const updatedDevices = devices.filter(d => d.deviceId !== deviceId);
      await docRef.update({ devices: updatedDevices });
    }
    return true;
  } catch (e) {
    console.error('Error removing device trust:', e);
    return false;
  }
}

// Remove all device trusts for a user (used when resetting 2FA)
async function removeAllDeviceTrusts(userId) {
  try {
    await db.collection('trustedDevices').doc(userId).delete();
    return true;
  } catch (e) {
    console.error('Error removing all device trusts:', e);
    return false;
  }
}

// 2FA Setup Modal Component
function TwoFactorSetupModal({ user, onClose, onSetupComplete }) {
  const [step, setStep] = useState(1); // 1: Show QR, 2: Verify code, 3: Show backup codes
  const [secret, setSecret] = useState('');
  const [qrUri, setQrUri] = useState('');
  const [verificationCode, setVerificationCode] = useState('');
  const [backupCodes, setBackupCodes] = useState([]);
  const [error, setError] = useState('');
  const [saving, setSaving] = useState(false);
  const qrRef = useRef(null);
  const qrInstance = useRef(null);

  useEffect(() => {
    // Generate secret on mount
    const newSecret = generate2FASecret(user.email);
    const uri = generate2FAURI(user.email, newSecret);
    setSecret(newSecret);
    setQrUri(uri);
  }, [user.email]);

  useEffect(() => {
    // Generate QR code
    if (qrRef.current && qrUri && step === 1) {
      // Clear previous QR code
      qrRef.current.innerHTML = '';
      qrInstance.current = new QRCode(qrRef.current, {
        text: qrUri,
        width: 200,
        height: 200,
        colorDark: '#000000',
        colorLight: '#ffffff',
        correctLevel: QRCode.CorrectLevel.H
      });
    }
  }, [qrUri, step]);

  const handleVerifyCode = () => {
    setError('');
    if (!verificationCode || verificationCode.length !== 6) {
      setError('Please enter a 6-digit code');
      return;
    }

    if (verify2FACode(secret, verificationCode)) {
      // Generate backup codes
      const codes = generateBackupCodes(8);
      setBackupCodes(codes);
      setStep(3);
    } else {
      setError('Invalid code. Please try again.');
    }
  };

  const handleComplete = async () => {
    setSaving(true);
    try {
      // Hash backup codes for storage
      const hashedBackupCodes = backupCodes.map(code => ({
        hash: hashBackupCode(code),
        used: false
      }));

      // Determine collection based on user type
      let collection = 'teachers';
      let docId = user.afid || user.docId;
      
      if (user.role) {
        collection = 'managers';
        docId = user.docId || user.uid;
      }

      // Save 2FA settings to Firestore
      await db.collection('twoFactorAuth').doc(docId).set({
        enabled: true,
        secret: secret, // In production, encrypt this!
        backupCodes: hashedBackupCodes,
        setupAt: new Date().toISOString(),
        userEmail: user.email,
        userType: user.role ? 'manager' : 'teacher'
      });

      // Update user's 2FA status
      await db.collection(collection).doc(docId).update({
        twoFactorEnabled: true,
        twoFactorSetupAt: new Date().toISOString()
      });

      onSetupComplete();
    } catch (e) {
      console.error('Error saving 2FA settings:', e);
      setError('Failed to save 2FA settings: ' + e.message);
    } finally {
      setSaving(false);
    }
  };

  return (
    <div className="modal-overlay" onClick={onClose}>
      <div className="modal-content max-w-lg" onClick={e => e.stopPropagation()}>
        <div className="flex justify-between items-center mb-4">
          <h3 className="text-2xl font-bold">üîê Setup Two-Factor Authentication</h3>
          <button onClick={onClose} className="text-2xl text-gray-400 hover:text-gray-600">√ó</button>
        </div>

        {step === 1 && (
          <div className="space-y-4">
            <div className="bg-blue-50 border-2 border-blue-200 p-4 rounded-xl">
              <p className="text-blue-800 font-semibold mb-2">Step 1: Scan QR Code</p>
              <p className="text-sm text-blue-600">
                Open your authenticator app (Google Authenticator, Microsoft Authenticator, Authy, etc.) and scan this QR code.
              </p>
            </div>

            <div className="flex justify-center p-4 bg-white rounded-xl border-2">
              <div ref={qrRef}></div>
            </div>

            <div className="bg-gray-50 p-4 rounded-xl">
              <p className="text-sm font-semibold mb-2">Can't scan? Enter this code manually:</p>
              <code className="block bg-white p-3 rounded-lg text-sm font-mono break-all border">
                {secret}
              </code>
            </div>

            <button
              onClick={() => setStep(2)}
              className="w-full py-3 bg-blue-600 text-white rounded-xl font-semibold hover:bg-blue-700"
            >
              Next: Verify Code ‚Üí
            </button>
          </div>
        )}

        {step === 2 && (
          <div className="space-y-4">
            <div className="bg-green-50 border-2 border-green-200 p-4 rounded-xl">
              <p className="text-green-800 font-semibold mb-2">Step 2: Verify Setup</p>
              <p className="text-sm text-green-600">
                Enter the 6-digit code from your authenticator app to confirm setup.
              </p>
            </div>

            <div>
              <label className="block text-sm font-bold mb-2">Verification Code</label>
              <input
                type="text"
                value={verificationCode}
                onChange={e => setVerificationCode(e.target.value.replace(/\D/g, '').slice(0, 6))}
                placeholder="Enter 6-digit code"
                className="w-full px-4 py-3 border-2 rounded-xl text-center text-2xl font-mono tracking-widest"
                maxLength={6}
                autoFocus
              />
            </div>

            {error && (
              <div className="bg-red-50 border-2 border-red-200 p-3 rounded-xl text-red-700 text-sm">
                {error}
              </div>
            )}

            <div className="flex gap-3">
              <button
                onClick={() => setStep(1)}
                className="flex-1 py-3 bg-gray-200 rounded-xl font-semibold hover:bg-gray-300"
              >
                ‚Üê Back
              </button>
              <button
                onClick={handleVerifyCode}
                className="flex-1 py-3 bg-green-600 text-white rounded-xl font-semibold hover:bg-green-700"
              >
                Verify Code
              </button>
            </div>
          </div>
        )}

        {step === 3 && (
          <div className="space-y-4">
            <div className="bg-yellow-50 border-2 border-yellow-200 p-4 rounded-xl">
              <p className="text-yellow-800 font-semibold mb-2">‚ö†Ô∏è Step 3: Save Backup Codes</p>
              <p className="text-sm text-yellow-700">
                Save these backup codes in a safe place. You can use them to login if you lose access to your authenticator app. Each code can only be used once.
              </p>
            </div>

            <div className="bg-white border-2 p-4 rounded-xl">
              <div className="grid grid-cols-2 gap-2">
                {backupCodes.map((code, i) => (
                  <div key={i} className="font-mono text-center py-2 bg-gray-100 rounded-lg">
                    {code}
                  </div>
                ))}
              </div>
            </div>

            <button
              onClick={() => {
                const codesText = backupCodes.join('\n');
                const blob = new Blob([`Avanti Curriculum Tracker - Backup Codes\n\nEmail: ${user.email}\nGenerated: ${new Date().toLocaleString()}\n\nBackup Codes:\n${codesText}\n\nKeep these codes safe! Each code can only be used once.`], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'avanti-2fa-backup-codes.txt';
                a.click();
              }}
              className="w-full py-3 bg-gray-200 rounded-xl font-semibold hover:bg-gray-300"
            >
              üì• Download Backup Codes
            </button>

            {error && (
              <div className="bg-red-50 border-2 border-red-200 p-3 rounded-xl text-red-700 text-sm">
                {error}
              </div>
            )}

            <button
              onClick={handleComplete}
              disabled={saving}
              className="w-full py-3 bg-green-600 text-white rounded-xl font-semibold hover:bg-green-700 disabled:opacity-50"
            >
              {saving ? 'Saving...' : '‚úì Complete Setup'}
            </button>
          </div>
        )}
      </div>
    </div>
  );
}

// 2FA Verification Modal (shown during login)
function TwoFactorVerifyModal({ user, onVerified, onCancel, onUseBackupCode }) {
  const [code, setCode] = useState('');
  const [error, setError] = useState('');
  const [verifying, setVerifying] = useState(false);
  const [showBackupInput, setShowBackupInput] = useState(false);
  const [backupCode, setBackupCode] = useState('');
  const [retryCount, setRetryCount] = useState(0);

  const handleVerify = async (inputCode) => {
    const codeToVerify = inputCode || code;
    setError('');
    if (!codeToVerify || codeToVerify.length !== 6) {
      setError('Please enter a 6-digit code');
      return;
    }

    setVerifying(true);
    try {
      // Get 2FA settings from Firestore
      const docId = user.afid || user.docId || user.uid || user.id;
      const twoFADoc = await db.collection('twoFactorAuth').doc(docId).get();
      
      if (!twoFADoc.exists) {
        setError('2FA not configured. Please contact admin.');
        return;
      }

      const twoFAData = twoFADoc.data();
      
      if (verify2FACode(twoFAData.secret, codeToVerify)) {
        onVerified();
      } else {
        setRetryCount(prev => prev + 1);
        if (retryCount >= 2) {
          setError('Code invalid. Tip: Wait for a new code to appear in your app, then enter it immediately.');
        } else {
          setError('Invalid code. Please check your authenticator app and try again.');
        }
        setCode(''); // Clear for retry
      }
    } catch (e) {
      console.error('2FA verification error:', e);
      if (e.message?.includes('network') || e.message?.includes('timeout')) {
        setError('Network issue. Please check your connection and try again.');
      } else {
        setError('Verification failed: ' + e.message);
      }
    } finally {
      setVerifying(false);
    }
  };

  // Auto-submit when 6 digits are entered
  const handleCodeChange = (e) => {
    const newCode = e.target.value.replace(/\D/g, '').slice(0, 6);
    setCode(newCode);
    if (newCode.length === 6) {
      // Small delay to show the full code before submitting
      setTimeout(() => handleVerify(newCode), 200);
    }
  };

  const handleBackupCodeVerify = async () => {
    setError('');
    if (!backupCode) {
      setError('Please enter a backup code');
      return;
    }

    setVerifying(true);
    try {
      const docId = user.afid || user.docId || user.uid || user.id;
      const twoFADoc = await db.collection('twoFactorAuth').doc(docId).get();
      
      if (!twoFADoc.exists) {
        setError('2FA not configured. Please contact admin.');
        return;
      }

      const twoFAData = twoFADoc.data();
      const backupCodes = twoFAData.backupCodes || [];
      
      const codeIndex = verifyBackupCode(backupCode, backupCodes);
      
      if (codeIndex >= 0) {
        // Mark the backup code as used
        backupCodes[codeIndex].used = true;
        await db.collection('twoFactorAuth').doc(docId).update({
          backupCodes: backupCodes
        });
        onVerified();
      } else {
        setError('Invalid or already used backup code.');
      }
    } catch (e) {
      console.error('Backup code verification error:', e);
      setError('Verification failed: ' + e.message);
    } finally {
      setVerifying(false);
    }
  };

  return (
    <div className="modal-overlay">
      <div className="modal-content max-w-md">
        <div className="text-center mb-6">
          <div className="text-5xl mb-3">üîê</div>
          <h3 className="text-2xl font-bold">Two-Factor Authentication</h3>
          <p className="text-gray-600 mt-2">Enter the code from your authenticator app</p>
        </div>

        {!showBackupInput ? (
          <div className="space-y-4">
            {/* Helpful tip for remote users */}
            <div className="bg-blue-50 border border-blue-200 p-3 rounded-xl text-sm text-blue-700">
              üí° <strong>Tip:</strong> Code changes every 30 seconds. Enter it as soon as you see it.
            </div>

            <input
              type="text"
              inputMode="numeric"
              pattern="[0-9]*"
              value={code}
              onChange={handleCodeChange}
              placeholder="000000"
              className="w-full px-4 py-4 border-2 rounded-xl text-center text-3xl font-mono tracking-widest"
              maxLength={6}
              autoFocus
              autoComplete="one-time-code"
              disabled={verifying}
            />

            {error && (
              <div className="bg-red-50 border-2 border-red-200 p-3 rounded-xl text-red-700 text-sm text-center">
                {error}
              </div>
            )}

            {verifying && (
              <div className="text-center text-gray-600">
                <div className="inline-block animate-spin mr-2">‚è≥</div>
                Verifying...
              </div>
            )}

            <button
              onClick={() => handleVerify()}
              disabled={verifying || code.length !== 6}
              className="w-full py-3 bg-blue-600 text-white rounded-xl font-semibold hover:bg-blue-700 disabled:opacity-50"
            >
              {verifying ? 'Verifying...' : 'Verify'}
            </button>

            <div className="text-center">
              <button
                onClick={() => setShowBackupInput(true)}
                className="text-blue-600 text-sm hover:underline"
              >
                Lost your phone? Use a backup code
              </button>
            </div>

            <button
              onClick={onCancel}
              className="w-full py-3 bg-gray-200 rounded-xl font-semibold hover:bg-gray-300"
            >
              Cancel Login
            </button>
          </div>
        ) : (
          <div className="space-y-4">
            <div className="bg-yellow-50 border-2 border-yellow-200 p-3 rounded-xl text-sm">
              <p className="text-yellow-800 font-semibold">Using Backup Code</p>
              <p className="text-yellow-700">Enter one of your saved backup codes. Each code can only be used once.</p>
            </div>

            <input
              type="text"
              value={backupCode}
              onChange={e => setBackupCode(e.target.value.toUpperCase())}
              placeholder="XXXX-XXXX"
              className="w-full px-4 py-4 border-2 rounded-xl text-center text-xl font-mono tracking-wider"
              autoFocus
              onKeyPress={e => e.key === 'Enter' && handleBackupCodeVerify()}
            />

            {error && (
              <div className="bg-red-50 border-2 border-red-200 p-3 rounded-xl text-red-700 text-sm text-center">
                {error}
              </div>
            )}

            <button
              onClick={handleBackupCodeVerify}
              disabled={verifying}
              className="w-full py-3 bg-green-600 text-white rounded-xl font-semibold hover:bg-green-700 disabled:opacity-50"
            >
              {verifying ? 'Verifying...' : 'Use Backup Code'}
            </button>

            <button
              onClick={() => {setShowBackupInput(false); setError('');}}
              className="w-full py-3 bg-gray-200 rounded-xl font-semibold hover:bg-gray-300"
            >
              ‚Üê Back to Code Entry
            </button>
          </div>
        )}
      </div>
    </div>
  );
}

// Admin 2FA Management Component (for Super Admin to reset 2FA)
function Admin2FAManagement({ teachers, managers }) {
  const [searchTerm, setSearchTerm] = useState('');
  const [filterType, setFilterType] = useState('All');
  const [twoFAUsers, setTwoFAUsers] = useState({});
  const [loading, setLoading] = useState(true);
  const [resetting, setResetting] = useState(null);

  useEffect(() => {
    const fetch2FAStatus = async () => {
      try {
        const twoFASnap = await db.collection('twoFactorAuth').get();
        const status = {};
        twoFASnap.docs.forEach(doc => {
          status[doc.id] = doc.data();
        });
        setTwoFAUsers(status);
      } catch (e) {
        console.error('Error fetching 2FA status:', e);
      } finally {
        setLoading(false);
      }
    };
    fetch2FAStatus();
  }, []);

  const allUsers = [
    ...teachers.map(t => ({ ...t, type: 'Teacher', docId: t.afid, twoFADocId: t.afid })),
    ...managers.map(m => ({ ...m, type: ROLE_LABELS[m.role] || 'Manager', docId: m.docId, twoFADocId: m.docId || m.uid || m.id }))
  ];

  const filteredUsers = allUsers.filter(user => {
    if (filterType !== 'All' && user.type !== filterType) return false;
    if (searchTerm && !user.name?.toLowerCase().includes(searchTerm.toLowerCase()) && 
        !user.email?.toLowerCase().includes(searchTerm.toLowerCase())) return false;
    return true;
  });

  const handleReset2FA = async (user) => {
    if (!confirm(`Reset 2FA for ${user.name}?\n\nThis will disable their 2FA and remove all trusted devices. They will need to set it up again on next login.`)) return;
    
    setResetting(user.docId);
    try {
      // Find the actual 2FA document ID by checking all possible IDs
      const possibleIds = [user.twoFADocId, user.docId, user.id, user.uid, user.afid].filter(Boolean);
      let actualTwoFADocId = null;
      
      for (const id of possibleIds) {
        const doc = await db.collection('twoFactorAuth').doc(id).get();
        if (doc.exists) {
          actualTwoFADocId = id;
          break;
        }
      }
      
      if (actualTwoFADocId) {
        // Delete 2FA document
        await db.collection('twoFactorAuth').doc(actualTwoFADocId).delete();
        // Remove all trusted devices for this user
        await removeAllDeviceTrusts(actualTwoFADocId);
      }
      
      // Update user's 2FA status
      const collection = user.type === 'Teacher' ? 'teachers' : 'managers';
      const userDocId = user.docId || user.afid;
      await db.collection(collection).doc(userDocId).update({
        twoFactorEnabled: false,
        twoFactorResetAt: new Date().toISOString()
      });

      // Update local state - remove all possible IDs
      setTwoFAUsers(prev => {
        const updated = { ...prev };
        possibleIds.forEach(id => { delete updated[id]; });
        return updated;
      });

      alert(`‚úÖ 2FA reset for ${user.name}. They will need to set up 2FA again on next login from any device.`);
    } catch (e) {
      console.error('Error resetting 2FA:', e);
      alert('Failed to reset 2FA: ' + e.message);
    } finally {
      setResetting(null);
    }
  };

  if (loading) {
    return (
      <div className="text-center py-8">
        <div className="text-4xl mb-4">‚è≥</div>
        <p>Loading 2FA status...</p>
      </div>
    );
  }

  // Calculate enabled count by checking multiple possible IDs for each user
  const enabledCount = allUsers.filter(user => {
    const possibleIds = [user.twoFADocId, user.docId, user.id, user.uid, user.afid].filter(Boolean);
    return possibleIds.some(id => twoFAUsers[id]?.enabled);
  }).length;
  const pendingCount = allUsers.length - enabledCount;

  return (
    <div className="space-y-6">
      <h2 className="text-3xl font-bold">üîê Two-Factor Authentication Management</h2>

      {/* Stats */}
      <div className="grid md:grid-cols-3 gap-4">
        <div className="bg-gradient-to-r from-green-500 to-green-600 text-white p-4 rounded-xl">
          <div className="text-sm opacity-90">2FA Enabled</div>
          <div className="text-3xl font-bold">{enabledCount}</div>
        </div>
        <div className="bg-gradient-to-r from-orange-500 to-orange-600 text-white p-4 rounded-xl">
          <div className="text-sm opacity-90">2FA Pending Setup</div>
          <div className="text-3xl font-bold">{pendingCount}</div>
        </div>
        <div className="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-4 rounded-xl">
          <div className="text-sm opacity-90">Total Users</div>
          <div className="text-3xl font-bold">{allUsers.length}</div>
        </div>
      </div>

      {/* Filters */}
      <div className="bg-white p-4 rounded-xl shadow">
        <div className="grid md:grid-cols-2 gap-4">
          <div>
            <label className="block text-sm font-bold mb-2">Search</label>
            <input
              type="text"
              value={searchTerm}
              onChange={e => setSearchTerm(e.target.value)}
              placeholder="Search by name or email..."
              className="w-full border-2 px-4 py-2 rounded-xl"
            />
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">User Type</label>
            <select
              value={filterType}
              onChange={e => setFilterType(e.target.value)}
              className="w-full border-2 px-4 py-2 rounded-xl"
            >
              <option value="All">All Users</option>
              <option value="Teacher">Teachers</option>
              <option value="Super Admin">Super Admins</option>
              <option value="Associate Program Head">Program Heads</option>
              <option value="Program Manager">Program Managers</option>
              <option value="Associate Program Manager">APMs</option>
            </select>
          </div>
        </div>
      </div>

      {/* Users Table */}
      <div className="bg-white p-6 rounded-xl shadow overflow-x-auto">
        <table className="w-full">
          <thead className="avanti-gradient-light">
            <tr>
              <th className="p-3 text-left">Name</th>
              <th className="p-3 text-left">Email</th>
              <th className="p-3 text-left">Type</th>
              <th className="p-3 text-center">2FA Status</th>
              <th className="p-3 text-left">Actions</th>
            </tr>
          </thead>
          <tbody>
            {filteredUsers.map(user => {
              // Try multiple possible IDs for 2FA status lookup
              const possibleIds = [user.twoFADocId, user.docId, user.id, user.uid, user.afid].filter(Boolean);
              const twoFA = possibleIds.map(id => twoFAUsers[id]).find(t => t) || null;
              const isEnabled = twoFA?.enabled;
              
              return (
                <tr key={user.docId} className="border-b hover:bg-gray-50">
                  <td className="p-3 font-semibold">{user.name}</td>
                  <td className="p-3 text-sm">{user.email}</td>
                  <td className="p-3">
                    <span className={`px-2 py-1 rounded-full text-xs font-bold ${
                      user.type === 'Teacher' ? 'bg-blue-100 text-blue-700' :
                      user.type === 'Super Admin' ? 'bg-purple-100 text-purple-700' :
                      'bg-green-100 text-green-700'
                    }`}>
                      {user.type}
                    </span>
                  </td>
                  <td className="p-3 text-center">
                    {isEnabled ? (
                      <span className="px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm font-bold">
                        ‚úì Enabled
                      </span>
                    ) : (
                      <span className="px-3 py-1 bg-yellow-100 text-yellow-700 rounded-full text-sm font-bold">
                        ‚è≥ Pending
                      </span>
                    )}
                  </td>
                  <td className="p-3">
                    {isEnabled && (
                      <button
                        onClick={() => handleReset2FA(user)}
                        disabled={resetting === user.docId}
                        className="px-4 py-2 bg-red-500 text-white rounded-lg text-sm font-semibold hover:bg-red-600 disabled:opacity-50"
                      >
                        {resetting === user.docId ? 'Resetting...' : 'üîÑ Reset 2FA'}
                      </button>
                    )}
                  </td>
                </tr>
              );
            })}
          </tbody>
        </table>
      </div>
    </div>
  );
}

function App(){const[currentUser,setCurrentUser]=useState(null);const[isAdmin,setIsAdmin]=useState(false);const[isSuperAdmin,setIsSuperAdmin]=useState(false);const[managerProfile,setManagerProfile]=useState(null);const[activeTab,setActiveTab]=useState('overview');const[loginForm,setLoginForm]=useState({email:'',password:'',studentId:'',loginType:'teacher'});const[loading,setLoading]=useState(true);const[authLoading,setAuthLoading]=useState(false);const[teachers,setTeachers]=useState([]);const[curriculum,setCurriculum]=useState({});const[chapterProgress,setChapterProgress]=useState({});const[students,setStudents]=useState([]);const[managers,setManagers]=useState([]);const[accessibleSchools,setAccessibleSchools]=useState([]);const[academicYearSettings,setAcademicYearSettings]=useState(null);
const[studentAttendance,setStudentAttendance]=useState([]);
const[teacherAttendance,setTeacherAttendance]=useState([]);
const[leaveAdjustments,setLeaveAdjustments]=useState({});
const[schoolInfo,setSchoolInfo]=useState([]);
const[isSidebarOpen,setIsSidebarOpen]=useState(false);               
const[showConfetti,setShowConfetti]=useState(false);const[celebrationMessage,setCelebrationMessage]=useState('');

// 2FA State
const[pending2FAUser,setPending2FAUser]=useState(null); // User waiting for 2FA verification
const[show2FAVerify,setShow2FAVerify]=useState(false); // Show 2FA verification modal
const[show2FASetup,setShow2FASetup]=useState(false); // Show 2FA setup modal for new users
const[needs2FASetup,setNeeds2FASetup]=useState(false); // Flag if user needs to set up 2FA

// Helper function to get accessible schools for a manager (supports 4-level hierarchy)
const getAccessibleSchools = useCallback((managerData, allManagers) => {
  if (!managerData) return [];
  
  let schools = [...(managerData.directSchools || [])];
  
  // Recursive function to get all reportees at all levels
  const getAllReportees = (managerId) => {
    const directReportees = allManagers.filter(m => m.reportsTo === managerId && m.status === 'active');
    let allReportees = [...directReportees];
    directReportees.forEach(reportee => {
      allReportees = [...allReportees, ...getAllReportees(reportee.id)];
    });
    return allReportees;
  };
  
  // If not APM, include schools from all reportees (recursive)
  if (managerData.role !== MANAGER_ROLES.APM) {
    const reportees = getAllReportees(managerData.id);
    reportees.forEach(reportee => {
      schools = [...schools, ...(reportee.directSchools || [])];
    });
  }
  
  // Remove duplicates
  return [...new Set(schools)];
}, []);

useEffect(()=>{const unsubscribe=auth.onAuthStateChanged(async(user)=>{if(user){
  // Check for Super Admin first
  if(user.email==='admin@avantifellows.org'){
    // Check 2FA for Super Admin
    const twoFADoc = await db.collection('twoFactorAuth').doc('SUPER_ADMIN').get();
    if (twoFADoc.exists && twoFADoc.data().enabled) {
      // 2FA is enabled - check if device is trusted
      const deviceTrusted = await isDeviceTrusted('SUPER_ADMIN');
      if (deviceTrusted) {
        // Device is trusted, skip 2FA verification
        console.log('‚úÖ Trusted device - skipping 2FA for Super Admin');
        setIsSuperAdmin(true);
        setIsAdmin(true);
        const allManagersSnap = await db.collection('managers').where('status','==','active').get();
        const allManagers = allManagersSnap.docs.map(d=>({...d.data(),id:d.id}));
        setManagers(allManagers);
        const aySnap = await db.collection('system').doc('academicYear').get();
        if(aySnap.exists) setAcademicYearSettings(aySnap.data());
        setAccessibleSchools([...SCHOOLS]);
        setCurrentUser({name:'Super Administrator',email:user.email,afid:'SUPER_ADMIN',school:'Admin',role:MANAGER_ROLES.SUPER_ADMIN});
        setActiveTab('managers');
        setLoading(false);
        return;
      }
      // Device not trusted, need to verify 2FA
      setPending2FAUser({
        name: 'Super Administrator',
        email: user.email,
        afid: 'SUPER_ADMIN',
        docId: 'SUPER_ADMIN',
        school: 'Admin',
        role: MANAGER_ROLES.SUPER_ADMIN,
        userType: 'superadmin'
      });
      setShow2FAVerify(true);
      setLoading(false);
      return;
    } else {
      // 2FA not set up yet - require setup
      setPending2FAUser({
        name: 'Super Administrator',
        email: user.email,
        afid: 'SUPER_ADMIN',
        docId: 'SUPER_ADMIN',
        school: 'Admin',
        role: MANAGER_ROLES.SUPER_ADMIN,
        userType: 'superadmin'
      });
      setShow2FASetup(true);
      setNeeds2FASetup(true);
      setLoading(false);
      return;
    }
  }else{
  // Check if user is a manager/APH/PM/APM
  const managerSnapshot=await db.collection('managers').where('email','==',user.email).where('status','==','active').limit(1).get();
  if(!managerSnapshot.empty){
    const managerData={...managerSnapshot.docs[0].data(),id:managerSnapshot.docs[0].id,docId:managerSnapshot.docs[0].id};
    
    // Check 2FA for manager
    const twoFADoc = await db.collection('twoFactorAuth').doc(managerData.id).get();
    if (twoFADoc.exists && twoFADoc.data().enabled) {
      // 2FA is enabled - check if device is trusted
      const deviceTrusted = await isDeviceTrusted(managerData.id);
      if (deviceTrusted) {
        // Device is trusted, skip 2FA verification
        console.log('‚úÖ Trusted device - skipping 2FA for manager:', managerData.name);
        setManagerProfile(managerData);
        const allManagersSnap = await db.collection('managers').where('status','==','active').get();
        const allManagers = allManagersSnap.docs.map(d=>({...d.data(),id:d.id}));
        setManagers(allManagers);
        const aySnap = await db.collection('system').doc('academicYear').get();
        if(aySnap.exists) setAcademicYearSettings(aySnap.data());
        const schools = getAccessibleSchools(managerData, allManagers);
        setAccessibleSchools(schools);
        setIsAdmin(true);
        setIsSuperAdmin(false);
        setCurrentUser({
          name: managerData.name,
          email: user.email,
          afid: managerData.id,
          docId: managerData.docId,
          school: schools[0] || 'Admin',
          role: managerData.role,
          directSchools: managerData.directSchools || []
        });
        setActiveTab('analytics');
        setLoading(false);
        return;
      }
      // Device not trusted, need to verify 2FA
      setPending2FAUser({
        ...managerData,
        userType: 'manager'
      });
      setShow2FAVerify(true);
      setLoading(false);
      return;
    } else {
      // 2FA not set up yet - require setup for managers
      setPending2FAUser({
        ...managerData,
        userType: 'manager'
      });
      setShow2FASetup(true);
      setNeeds2FASetup(true);
      setLoading(false);
      return;
    }
  } else {
    // Check if teacher
    const teacherSnapshot=await db.collection('teachers').where('email','==',user.email).limit(1).get();
    if(!teacherSnapshot.empty){
      const teacherData={...teacherSnapshot.docs[0].data(),docId:teacherSnapshot.docs[0].id};
      
      // Check 2FA for teacher
      const twoFADoc = await db.collection('twoFactorAuth').doc(teacherData.afid).get();
      if (twoFADoc.exists && twoFADoc.data().enabled) {
        // 2FA is enabled - check if device is trusted
        const deviceTrusted = await isDeviceTrusted(teacherData.afid);
        if (deviceTrusted) {
          // Device is trusted, skip 2FA verification
          console.log('‚úÖ Trusted device - skipping 2FA for teacher:', teacherData.name);
          setCurrentUser(teacherData);
          setIsAdmin(false);
          setActiveTab('overview');
          // Birthday/Anniversary celebrations
          if(teacherData.dob){
            const d = new Date(teacherData.dob);
            const now = new Date();
            if(d.getMonth() === now.getMonth() && d.getDate() === now.getDate()){
              setShowConfetti(true);
              setCelebrationMessage(`üéÇ Happy Birthday, ${teacherData.name}!`);
              setTimeout(() => {setShowConfetti(false);setCelebrationMessage('')}, 8000);
            }
          }
          if(teacherData.joiningDate){
            const j = new Date(teacherData.joiningDate);
            const now = new Date();
            if(j.getMonth() === now.getMonth() && j.getDate() === now.getDate() && j.getFullYear() < now.getFullYear()){
              const years = now.getFullYear() - j.getFullYear();
              setShowConfetti(true);
              setCelebrationMessage(`üéâ Happy ${years} Year Work Anniversary, ${teacherData.name}!`);
              setTimeout(() => {setShowConfetti(false);setCelebrationMessage('')}, 8000);
            }
          }
          setLoading(false);
          return;
        }
        // Device not trusted, need to verify 2FA
        setPending2FAUser({
          ...teacherData,
          userType: 'teacher'
        });
        setShow2FAVerify(true);
        setLoading(false);
        return;
      } else {
        // 2FA not set up yet - require setup for teachers
        setPending2FAUser({
          ...teacherData,
          userType: 'teacher'
        });
        setShow2FASetup(true);
        setNeeds2FASetup(true);
        setLoading(false);
        return;
      }
    }else{alert('User profile not found. Please contact admin.');await auth.signOut()}
  }
}}else{// Check for student session in localStorage
const studentSession=localStorage.getItem('studentSession');if(studentSession){try{const studentData=JSON.parse(studentSession);console.log('‚úÖ Restored student session:',studentData);setCurrentUser(studentData);setIsAdmin(false);setActiveTab('dashboard')}catch(e){console.error('Failed to restore student session:',e);localStorage.removeItem('studentSession')}}else{setCurrentUser(null);setIsAdmin(false)}}setLoading(false)});return()=>unsubscribe()},[getAccessibleSchools]);
  // ‚úÖ OPTIMIZED: Fetch data once on load, refresh only when needed
useEffect(() => {
  const fetchData = async () => {
    try {
      // ‚úÖ FETCH ALL DATA IN PARALLEL (MUCH FASTER!)
      const [progressSnap, teachersSnap, curriculumSnap, studentsSnap, studentAttSnap, teacherAttSnap, schoolInfoSnap, leaveAdjSnap, managersSnap, schoolsSnap, aySnap] = await Promise.all([
        db.collection('chapterProgress').get(),
        db.collection('teachers').get(),
        db.collection('curriculum').get(),
        db.collection('students').get(),
        db.collection('studentAttendance')
          .where('date', '>=', new Date(Date.now() - 30*24*60*60*1000).toISOString().split('T')[0])
          .get(),
        db.collection('teacherAttendance')
          .where('date', '>=', new Date(Date.now() - 30*24*60*60*1000).toISOString().split('T')[0])
          .get(),
        db.collection('schoolInfo').get(),
        db.collection('leaveAdjustments').get(),
        db.collection('managers').where('status','==','active').get(),
        db.collection('schoolsList').get(),
        db.collection('system').doc('academicYear').get()
      ]);

      // Process chapter progress
      const map = {};
      progressSnap.docs.forEach(d => map[d.id] = d.data());
      setChapterProgress(map);

      // Process teachers
      setTeachers(teachersSnap.docs.map(d => ({ ...d.data(), docId: d.id })));

      // Process curriculum
      const currMap = {};
      curriculumSnap.docs.forEach(doc => { currMap[doc.id] = doc.data() });
      setCurriculum(currMap);

      // Process students - make sure every student has a proper `id`
setStudents(
  studentsSnap.docs.map(d => {
    const data = d.data();
    // Older students may be missing `id` field ‚Äì fall back to docId suffix
    let studentId = data.id;
    if (!studentId) {
      const parts = d.id.split('_');       // e.g. "JNV_Bharuch_1234"
      studentId = parts[parts.length - 1]; // -> "1234"
    }
    return { ...data, id: studentId, docId: d.id };
  })
);

      // Process attendance
      setStudentAttendance(studentAttSnap.docs.map(d => ({ ...d.data(), docId: d.id })));
      setTeacherAttendance(teacherAttSnap.docs.map(d => ({ ...d.data(), docId: d.id })));
      // Process school info
      setSchoolInfo(schoolInfoSnap.docs.map(d => ({ ...d.data(), docId: d.id })));
      
      // Process leave adjustments (keyed by teacher AFID)
      const adjMap = {};
      leaveAdjSnap.docs.forEach(d => { adjMap[d.id] = d.data() });
      setLeaveAdjustments(adjMap);
      
      // Process managers
      setManagers(managersSnap.docs.map(d => ({ ...d.data(), id: d.id })));
      
      // Process dynamic schools list
      if (!schoolsSnap.empty) {
        const schoolsData = schoolsSnap.docs.map(d => d.data().name).filter(Boolean);
        if (schoolsData.length > 0) {
          SCHOOLS = schoolsData; // Update global SCHOOLS array
        }
      }
      
      // Process academic year settings
      if (aySnap.exists) {
        setAcademicYearSettings(aySnap.data());
      }

    } catch (e) {
      console.error('Data fetch error:', e);
    }
  };

  fetchData();

  // ‚úÖ Refresh data every 2 minutes (faster updates)
  const interval = setInterval(fetchData, 2 * 60 * 1000);
  return () => clearInterval(interval);
}, []);
const handleLogin=async()=>{
  setAuthLoading(true);
  try{
    const email=(loginForm.email||'').trim().toLowerCase();
    const password=loginForm.password;
    const studentId=(loginForm.studentId||'').trim();
    const loginType=loginForm.loginType||'teacher';
    
    if(loginType==='student'){
      // STUDENT LOGIN
      if(!studentId||!password){
        alert('Please enter Student ID and password');
        setAuthLoading(false);
        return;
      }
      if(password!=='pass123'){
        alert('Invalid password. Default password is: pass123');
        setAuthLoading(false);
        return;
      }
      
      try {
        // ‚úÖ Get all students and search for matching ID
        const allStudentsSnap = await db.collection('students').get();
        let foundStudent = null;
        
        allStudentsSnap.docs.forEach(doc => {
          const data = doc.data();
          if(data.id === studentId) {
            foundStudent = { ...data, docId: doc.id };
            console.log('‚úÖ Found student:', foundStudent);
          }
        });
        
        if(foundStudent){
          const studentUser = {
            ...foundStudent,
            userType:'student',
            studentId:studentId
          };
          // ‚úÖ Save to localStorage for session persistence
          localStorage.setItem('studentSession', JSON.stringify(studentUser));
          setCurrentUser(studentUser);
          setIsAdmin(false);
          setActiveTab('dashboard');
          setAuthLoading(false); // ‚¨ÖÔ∏è ADD THIS
        }else{
          alert('Student ID not found. Please contact your teacher.');
          setAuthLoading(false);
          return;
        }
      } catch(e) {
        console.error('Student login error:', e);
        alert('Login failed: ' + e.message);
        setAuthLoading(false);
        return;
      }
    }else{
      // TEACHER/ADMIN LOGIN (existing code)
      if(!email||!password){
        alert('Please enter email and password');
        setAuthLoading(false);
        return;
      }
      await auth.signInWithEmailAndPassword(email,password);
      setAuthLoading(false); // ‚¨ÖÔ∏è ADD THIS
    }
  }catch(e){
    console.error('login error',e);
    alert('Login failed: '+e.message);
    setAuthLoading(false); // ‚¨ÖÔ∏è MAKE SURE THIS EXISTS
  }
};
const handleLogout=async()=>{
  try{
    // Clear student session from localStorage
    localStorage.removeItem('studentSession');
    // Clear 2FA states
    setPending2FAUser(null);
    setShow2FAVerify(false);
    setShow2FASetup(false);
    setNeeds2FASetup(false);
    // For teachers/admins who use Firebase Auth
    if(auth.currentUser){
      await auth.signOut();
    }
    // Reset state for all users (including students)
    setCurrentUser(null);
    setIsAdmin(false);
    setActiveTab('overview');
    setLoginForm({loginType:'teacher',email:'',password:'',studentId:''});
  }catch(e){
    console.error('logout error',e);
  }
};

// Complete 2FA verification and finish login
const complete2FAVerification = async () => {
  if (!pending2FAUser) return;
  
  const user = pending2FAUser;
  
  // Add device trust after successful 2FA verification
  const userId = user.userType === 'superadmin' ? 'SUPER_ADMIN' : 
                 user.userType === 'manager' ? user.id : 
                 user.afid;
  await addDeviceTrust(userId, user.email);
  console.log('‚úÖ Device trusted after 2FA verification for:', user.email);
  
  if (user.userType === 'superadmin') {
    setIsSuperAdmin(true);
    setIsAdmin(true);
    // Fetch all managers
    const allManagersSnap = await db.collection('managers').where('status','==','active').get();
    const allManagers = allManagersSnap.docs.map(d=>({...d.data(),id:d.id}));
    setManagers(allManagers);
    // Fetch academic year settings
    const aySnap = await db.collection('system').doc('academicYear').get();
    if(aySnap.exists) setAcademicYearSettings(aySnap.data());
    // Super admin sees all schools
    setAccessibleSchools([...SCHOOLS]);
    setCurrentUser({name:'Super Administrator',email:user.email,afid:'SUPER_ADMIN',school:'Admin',role:MANAGER_ROLES.SUPER_ADMIN});
    setActiveTab('managers');
  } else if (user.userType === 'manager') {
    setManagerProfile(user);
    // Fetch all managers to calculate accessible schools
    const allManagersSnap = await db.collection('managers').where('status','==','active').get();
    const allManagers = allManagersSnap.docs.map(d=>({...d.data(),id:d.id}));
    setManagers(allManagers);
    // Fetch academic year settings
    const aySnap = await db.collection('system').doc('academicYear').get();
    if(aySnap.exists) setAcademicYearSettings(aySnap.data());
    const schools = getAccessibleSchools(user, allManagers);
    setAccessibleSchools(schools);
    setIsAdmin(true);
    setIsSuperAdmin(false);
    setCurrentUser({
      name: user.name,
      email: user.email,
      afid: user.id,
      docId: user.docId,
      school: schools[0] || 'Admin',
      role: user.role,
      directSchools: user.directSchools || []
    });
    setActiveTab('analytics');
  } else if (user.userType === 'teacher') {
    setCurrentUser(user);
    setIsAdmin(false);
    setActiveTab('overview');
    // Birthday/Anniversary celebrations
    if(user.dob){
      const d = new Date(user.dob);
      const now = new Date();
      if(d.getMonth() === now.getMonth() && d.getDate() === now.getDate()){
        setShowConfetti(true);
        setCelebrationMessage(`üéÇ Happy Birthday, ${user.name}!`);
        setTimeout(() => {setShowConfetti(false);setCelebrationMessage('')}, 8000);
      }
    }
    if(user.joiningDate){
      const j = new Date(user.joiningDate);
      const now = new Date();
      if(j.getMonth() === now.getMonth() && j.getDate() === now.getDate() && j.getFullYear() < now.getFullYear()){
        const years = now.getFullYear() - j.getFullYear();
        setShowConfetti(true);
        setCelebrationMessage(`üéâ Happy ${years} Year Work Anniversary, ${user.name}!`);
        setTimeout(() => {setShowConfetti(false);setCelebrationMessage('')}, 8000);
      }
    }
  }
  
  // Clear 2FA states
  setPending2FAUser(null);
  setShow2FAVerify(false);
  setShow2FASetup(false);
  setNeeds2FASetup(false);
};

// Handle 2FA setup completion
const handle2FASetupComplete = async () => {
  // Add device trust after successful 2FA setup
  if (pending2FAUser) {
    const userId = pending2FAUser.userType === 'superadmin' ? 'SUPER_ADMIN' : 
                   pending2FAUser.userType === 'manager' ? pending2FAUser.id : 
                   pending2FAUser.afid;
    await addDeviceTrust(userId, pending2FAUser.email);
    console.log('‚úÖ Device trusted after 2FA setup for:', pending2FAUser.email);
  }
  
  setShow2FASetup(false);
  setNeeds2FASetup(false);
  // After setup, complete the login
  complete2FAVerification();
};

// Cancel 2FA and logout
const cancel2FA = async () => {
  setPending2FAUser(null);
  setShow2FAVerify(false);
  setShow2FASetup(false);
  setNeeds2FASetup(false);
  if(auth.currentUser){
    await auth.signOut();
  }
  setCurrentUser(null);
  setIsAdmin(false);
};
const updateChapterProgress = useCallback(async (school, chapterId, field, value) => {
  try {
    const progressId = `${school}_${chapterId}`;
    const prev = chapterProgress[progressId] || {};

    const updated = {
      ...prev,
      [field]: value,
      school,
      chapterId,
      updatedAt: new Date().toISOString(),
    };

    // üîÑ Write to Firestore
    await db.collection('chapterProgress').doc(progressId).set(updated, { merge: true });

    // üîÑ Update local state so dropdowns/Yes‚ÄìNo change immediately
    setChapterProgress(prevMap => ({
      ...prevMap,
      [progressId]: updated,
    }));

    // üéâ Optional celebration when a chapter is marked completed
    if (
      (field === 'completed' && (value === 'Yes' || value === true)) ||
      updated.completed === 'Yes' || updated.completed === true
    ) {
      setCelebrationMessage('üéâ Chapter marked as completed!');
      setShowConfetti(true);
      setTimeout(() => {
        setShowConfetti(false);
        setCelebrationMessage('');
      }, 5000);
    }
  } catch (e) {
    console.error('Update error', e);
    alert('Failed to update: ' + e.message);
  }
}, [chapterProgress]);

const addChapter=async(school,subject,grade,chapter)=>{try{const docId=`${school}_${subject}_${grade}`;const doc=await db.collection('curriculum').doc(docId).get();const existing=doc.exists?(doc.data().chapters||[]):[];chapter.id=`${subject.charAt(0)}${grade}-${existing.length+1}-${Date.now().toString().slice(-4)}`;const updated=[...existing,chapter];await db.collection('curriculum').doc(docId).set({chapters:updated});alert('Chapter added successfully!')}catch(e){console.error('Add error',e);alert('Failed to add: '+e.message)}};
const updateChapter=async(school,subject,grade,chapterId,updates)=>{try{const docId=`${school}_${subject}_${grade}`;const doc=await db.collection('curriculum').doc(docId).get();const existing=doc.exists?(doc.data().chapters||[]):[];const index=existing.findIndex(ch=>ch.id===chapterId);if(index===-1){alert('Chapter not found');return}existing[index]={...existing[index],...updates};await db.collection('curriculum').doc(docId).set({chapters:existing});alert('Chapter updated successfully!')}catch(e){console.error('Update error',e);alert('Failed to update: '+e.message)}};
const deleteChapter=async(school,subject,grade,chapterId)=>{if(!confirm('Delete this chapter?'))return;try{const docId=`${school}_${subject}_${grade}`;const doc=await db.collection('curriculum').doc(docId).get();const existing=doc.exists?(doc.data().chapters||[]):[];const updated=existing.filter(ch=>ch.id!==chapterId);await db.collection('curriculum').doc(docId).set({chapters:updated});alert('Chapter deleted successfully')}catch(e){console.error('Delete error',e);alert('Failed to delete: '+e.message)}};
function Confetti() {
  const primary = ['#F97316', '#FACC15', '#22C55E', '#0EA5E9', '#6366F1', '#EC4899'];
  const secondary = ['#FDBA74', '#FDE68A', '#86EFAC', '#7DD3FC', '#A5B4FC', '#F9A8D4'];
  const pieces = 120;

  return (
    <div className="fixed inset-0 pointer-events-none z-[9999]">
      {Array.from({ length: pieces }).map((_, i) => {
        const colorIndex = Math.floor(Math.random() * primary.length);
        const left = Math.random() * 100;
        const size = 6 + Math.random() * 10;
        const delay = Math.random() * 1.2;
        const duration = 2.4 + Math.random() * 1.2;
        const isCircle = Math.random() > 0.6;

        return (
          <div
            key={i}
            className="confetti-piece"
            style={{
              left: `${left}%`,
              top: '-40px',
              width: `${size * 1.8}px`,
              height: `${size}px`,
              background: `linear-gradient(135deg, ${primary[colorIndex]}, ${secondary[colorIndex]})`,
              borderRadius: isCircle ? '999px' : '6px',
              boxShadow: '0 0 0 1px rgba(255,255,255,0.5)',
              animationDelay: `${delay}s`,
              animationDuration: `${duration}s`,
              opacity: 0.95,
            }}
          />
        );
      })}
    </div>
  );
}
if(loading){return(<div className="min-h-screen avanti-gradient flex items-center justify-center"><div className="text-center"><img src={AVANTI_LOGO} alt="Avanti Fellows" className="w-20 h-20 mx-auto mb-4 animate-bounce"/><div className="text-white text-2xl font-bold">Loading...</div></div></div>)}

// Show 2FA Setup Modal if needed
if(show2FASetup && pending2FAUser){
  return(
    <div className="min-h-screen avanti-gradient flex items-center justify-center p-4">
      <TwoFactorSetupModal
        user={pending2FAUser}
        onClose={cancel2FA}
        onSetupComplete={handle2FASetupComplete}
      />
    </div>
  );
}

// Show 2FA Verification Modal if needed
if(show2FAVerify && pending2FAUser){
  return(
    <div className="min-h-screen avanti-gradient flex items-center justify-center p-4">
      <TwoFactorVerifyModal
        user={pending2FAUser}
        onVerified={complete2FAVerification}
        onCancel={cancel2FA}
      />
    </div>
  );
}

if(!currentUser){
  return(
    <div className="min-h-screen avanti-gradient flex items-center justify-center p-4">
      <div className="bg-white rounded-3xl shadow-2xl p-10 w-full max-w-md">
        <div className="text-center mb-8">
          <img src={AVANTI_LOGO} alt="Avanti Fellows" className="w-20 h-20 mx-auto mb-4"/>
          <h1 className="text-4xl font-bold text-gray-800 mb-2">Curriculum Tracker</h1>
          <p className="text-gray-600 mt-3">Avanti Fellows</p>
        </div>
        
        {/* LOGIN TYPE SELECTOR - NEW */}
        <div className="flex gap-2 mb-6">
          <button
            onClick={()=>setLoginForm({...loginForm,loginType:'teacher'})}
            className={`flex-1 py-3 rounded-xl font-semibold ${loginForm.loginType==='teacher'?'bg-blue-600 text-white':'bg-gray-200'}`}
          >
            üë®‚Äçüè´ Teacher
          </button>
          <button
            onClick={()=>setLoginForm({...loginForm,loginType:'student'})}
            className={`flex-1 py-3 rounded-xl font-semibold ${loginForm.loginType==='student'?'bg-green-600 text-white':'bg-gray-200'}`}
          >
            üë®‚Äçüéì Student
          </button>
        </div>

        <div className="space-y-5">
          {loginForm.loginType==='student'?(
            <>
              <input type="text" className="w-full px-5 py-4 border-2 border-gray-300 rounded-xl text-lg" value={loginForm.studentId||''} onChange={e=>setLoginForm({...loginForm,studentId:e.target.value})} placeholder="Student ID"/>
              <input type="password" className="w-full px-5 py-4 border-2 border-gray-300 rounded-xl text-lg" value={loginForm.password} onChange={e=>setLoginForm({...loginForm,password:e.target.value})} placeholder="Password (pass123)" onKeyPress={e=>e.key==='Enter'&&handleLogin()}/>
              <p className="text-sm text-gray-600 text-center">Default password: <strong>pass123</strong></p>
            </>
          ):(
            <>
              <input type="email" className="w-full px-5 py-4 border-2 border-gray-300 rounded-xl text-lg" value={loginForm.email} onChange={e=>setLoginForm({...loginForm,email:e.target.value})} placeholder="Email"/>
              <input type="password" className="w-full px-5 py-4 border-2 border-gray-300 rounded-xl text-lg" value={loginForm.password} onChange={e=>setLoginForm({...loginForm,password:e.target.value})} placeholder="Password" onKeyPress={e=>e.key==='Enter'&&handleLogin()}/>
            </>
          )}
          <button onClick={handleLogin} disabled={authLoading} className="w-full avanti-gradient text-white py-4 rounded-xl font-bold text-lg disabled:opacity-50">
            {authLoading?'Logging in...':'Login'}
          </button>
        </div>
      </div>
    </div>
  );
}

// ‚úÖ Check if student is logged in
if(currentUser && currentUser.userType === 'student') {
  return <StudentDashboard currentUser={currentUser} handleLogout={handleLogout} />;
}

return isAdmin?<AdminView currentUser={currentUser} handleLogout={handleLogout} teachers={teachers} students={students} curriculum={curriculum} chapterProgress={chapterProgress} studentAttendance={studentAttendance} teacherAttendance={teacherAttendance} schoolInfo={schoolInfo} addChapter={addChapter} updateChapter={updateChapter} deleteChapter={deleteChapter} leaveAdjustments={leaveAdjustments} setLeaveAdjustments={setLeaveAdjustments} managers={managers} isSuperAdmin={isSuperAdmin} accessibleSchools={accessibleSchools} academicYearSettings={academicYearSettings}/>:<TeacherView currentUser={currentUser} handleLogout={handleLogout} showConfetti={showConfetti} Confetti={Confetti} celebrationMessage={celebrationMessage} teachers={teachers} students={students} curriculum={curriculum} chapterProgress={chapterProgress} studentAttendance={studentAttendance} teacherAttendance={teacherAttendance} schoolInfo={schoolInfo} setSchoolInfo={setSchoolInfo} updateChapterProgress={updateChapterProgress} activeTab={activeTab} setActiveTab={setActiveTab} leaveAdjustments={leaveAdjustments}/>;
}

// ========================================
// ADMIN STUDENT PROFILES VIEW
// ========================================
function AdminStudentProfiles({ accessibleSchools = SCHOOLS, isSuperAdmin = true }){
  const[studentProfiles,setStudentProfiles]=useState([]);
  const[filterSchool,setFilterSchool]=useState('All');
  const[filterGrade,setFilterGrade]=useState('All');
  const categoryChartRef = useRef(null);
  const genderChartRef = useRef(null);
  const streamChartRef = useRef(null);
  const schoolDistChartRef = useRef(null);
  const chartInstances = useRef({});
  
  // Filter schools based on access
  const availableSchools = isSuperAdmin ? SCHOOLS : accessibleSchools;

  useEffect(()=>{
    const fetchData=async()=>{
      const profilesSnap=await db.collection('studentProfiles').get();
      let profiles = profilesSnap.docs.map(d=>({...d.data(),id:d.id}));
      // Filter by accessible schools for managers
      if (!isSuperAdmin) {
        profiles = profiles.filter(p => accessibleSchools.includes(p.school));
      }
      setStudentProfiles(profiles);
    };
    fetchData();
  },[isSuperAdmin, accessibleSchools]);

  const filteredProfiles=studentProfiles.filter(p=>{
    if(filterSchool!=='All'&&p.school!==filterSchool)return false;
    if(filterGrade!=='All'&&p.grade!==filterGrade)return false;
    return true;
  });

  // Calculate statistics for graphs
  const stats = useMemo(() => {
    const categoryCount = {};
    const genderCount = { Male: 0, Female: 0, Other: 0 };
    const streamCount = { JEE: 0, NEET: 0, Other: 0 };
    const categoryByGender = {};
    const schoolCount = {};
    
    filteredProfiles.forEach(p => {
      // Category count
      const cat = p.category || 'Not Specified';
      categoryCount[cat] = (categoryCount[cat] || 0) + 1;
      
      // Gender count
      let gender = p.gender || 'Other';
      if (gender === 'Male' || gender === 'Female') {
        genderCount[gender]++;
      } else {
        genderCount.Other++;
      }
      
      // Stream count
      const stream = p.stream || 'Other';
      if (stream === 'JEE' || stream === 'NEET') {
        streamCount[stream]++;
      } else {
        streamCount.Other++;
      }
      
      // Category by gender breakdown
      if (!categoryByGender[cat]) {
        categoryByGender[cat] = { Male: 0, Female: 0, Other: 0 };
      }
      if (gender === 'Male' || gender === 'Female') {
        categoryByGender[cat][gender]++;
      } else {
        categoryByGender[cat].Other++;
      }
      
      // School count
      const school = p.school || 'Unknown';
      schoolCount[school] = (schoolCount[school] || 0) + 1;
    });
    
    return { categoryCount, genderCount, streamCount, categoryByGender, schoolCount };
  }, [filteredProfiles]);

  // Draw charts
  useEffect(() => {
    // Destroy existing charts
    Object.values(chartInstances.current).forEach(chart => {
      if (chart) chart.destroy();
    });
    chartInstances.current = {};

    // Category Distribution Pie Chart
    if (categoryChartRef.current && Object.keys(stats.categoryCount).length > 0) {
      const ctx = categoryChartRef.current.getContext('2d');
      const labels = Object.keys(stats.categoryCount);
      const data = Object.values(stats.categoryCount);
      const colors = ['#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', '#EC4899', '#14B8A6'];
      
      chartInstances.current.category = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: labels,
          datasets: [{
            data: data,
            backgroundColor: colors.slice(0, labels.length),
            borderWidth: 2,
            borderColor: '#fff'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: { display: true, text: 'Category Distribution', font: { size: 16, weight: 'bold' } },
            legend: { position: 'bottom', labels: { padding: 15 } }
          }
        }
      });
    }

    // Gender Distribution Pie Chart
    if (genderChartRef.current) {
      const ctx = genderChartRef.current.getContext('2d');
      chartInstances.current.gender = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['Male', 'Female', 'Other'],
          datasets: [{
            data: [stats.genderCount.Male, stats.genderCount.Female, stats.genderCount.Other],
            backgroundColor: ['#6366F1', '#EC4899', '#9CA3AF'],
            borderWidth: 2,
            borderColor: '#fff'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: { display: true, text: 'Gender Distribution', font: { size: 16, weight: 'bold' } },
            legend: { position: 'bottom', labels: { padding: 15 } }
          }
        }
      });
    }

    // Category by Gender Bar Chart
    if (streamChartRef.current && Object.keys(stats.categoryByGender).length > 0) {
      const ctx = streamChartRef.current.getContext('2d');
      const categories = Object.keys(stats.categoryByGender);
      
      chartInstances.current.stream = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: categories,
          datasets: [
            {
              label: 'Male',
              data: categories.map(cat => stats.categoryByGender[cat].Male),
              backgroundColor: '#6366F1',
              borderRadius: 4
            },
            {
              label: 'Female',
              data: categories.map(cat => stats.categoryByGender[cat].Female),
              backgroundColor: '#EC4899',
              borderRadius: 4
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: { display: true, text: 'Category-wise Gender Distribution', font: { size: 16, weight: 'bold' } },
            legend: { position: 'bottom' }
          },
          scales: {
            x: { stacked: false },
            y: { beginAtZero: true, ticks: { stepSize: 1 } }
          }
        }
      });
    }

    // School Distribution Bar Chart
    if (schoolDistChartRef.current && Object.keys(stats.schoolCount).length > 0) {
      const ctx = schoolDistChartRef.current.getContext('2d');
      const schools = Object.keys(stats.schoolCount);
      const counts = Object.values(stats.schoolCount);
      
      chartInstances.current.schoolDist = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: schools.map(s => s.replace('CoE ', '').replace('JNV ', '')),
          datasets: [{
            label: 'Students',
            data: counts,
            backgroundColor: '#F4B41A',
            borderRadius: 4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: { display: true, text: 'School-wise Distribution', font: { size: 16, weight: 'bold' } },
            legend: { display: false }
          },
          scales: {
            y: { beginAtZero: true, ticks: { stepSize: 1 } }
          }
        }
      });
    }

    return () => {
      Object.values(chartInstances.current).forEach(chart => {
        if (chart) chart.destroy();
      });
    };
  }, [stats]);

  const handleExport=()=>{
    const exportData=filteredProfiles.map(p=>({
      'Student ID':p.studentId,
      'First Name':p.firstName,
      'Last Name':p.lastName,
      'Email':p.email,
      'Phone':p.phone,
      'DOB':p.dob,
      'Grade':p.grade,
      'Category':p.category,
      'Stream':p.stream,
      'School':p.school,
      'Father Name':p.fatherName,
      'Father Occupation':p.fatherOccupation,
      'Father Education':p.fatherEducation,
      'Mother Name':p.motherName,
      'Mother Occupation':p.motherOccupation,
      'Mother Education':p.motherEducation,
      'Family Income':p.familyIncome,
      'Address':p.address,
      'State':p.state,
      'District':p.district,
      'Pincode':p.pincode,
      'WhatsApp':p.whatsappNumber,
      '10th %':p.percentage10th,
      '11th %':p.percentage11th||'N/A'
    }));
    exportToExcel(exportData,'student_profiles');
  };

  return(
    <div className="space-y-6">
      <div className="flex justify-between items-center flex-wrap gap-4">
        <div>
          <h2 className="text-3xl font-bold">üë®‚Äçüéì Student Profiles ({filteredProfiles.length})</h2>
          {!isSuperAdmin && (
            <p className="text-sm text-gray-500 mt-1">Showing profiles for your assigned schools</p>
          )}
        </div>
        <button onClick={handleExport} className="px-6 py-3 bg-green-600 text-white rounded-xl font-semibold">
          üì• Export to Excel
        </button>
      </div>

      <div className="bg-white p-6 rounded-2xl shadow-lg">
        <h3 className="text-xl font-bold mb-4">üîç Filters</h3>
        <div className="grid md:grid-cols-2 gap-4">
          <div>
            <label className="block text-sm font-bold mb-2">School</label>
            <select value={filterSchool} onChange={e=>setFilterSchool(e.target.value)} className="w-full border-2 px-4 py-3 rounded-xl">
              <option value="All">All Schools</option>
              {availableSchools.map(s=><option key={s} value={s}>{s}</option>)}
            </select>
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">Grade</label>
            <select value={filterGrade} onChange={e=>setFilterGrade(e.target.value)} className="w-full border-2 px-4 py-3 rounded-xl">
              <option value="All">All Grades</option>
              <option value="11">Class 11</option>
              <option value="12">Class 12</option>
            </select>
          </div>
        </div>
      </div>

      {/* Summary Statistics Cards */}
      <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div className="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-4 rounded-xl shadow-lg">
          <div className="text-sm opacity-90">Total Profiles</div>
          <div className="text-3xl font-bold">{filteredProfiles.length}</div>
        </div>
        <div className="bg-gradient-to-r from-indigo-500 to-purple-600 text-white p-4 rounded-xl shadow-lg">
          <div className="text-sm opacity-90">Male Students</div>
          <div className="text-3xl font-bold">{stats.genderCount.Male}</div>
          <div className="text-xs opacity-75">{filteredProfiles.length > 0 ? Math.round((stats.genderCount.Male / filteredProfiles.length) * 100) : 0}%</div>
        </div>
        <div className="bg-gradient-to-r from-pink-500 to-rose-600 text-white p-4 rounded-xl shadow-lg">
          <div className="text-sm opacity-90">Female Students</div>
          <div className="text-3xl font-bold">{stats.genderCount.Female}</div>
          <div className="text-xs opacity-75">{filteredProfiles.length > 0 ? Math.round((stats.genderCount.Female / filteredProfiles.length) * 100) : 0}%</div>
        </div>
        <div className="bg-gradient-to-r from-green-500 to-emerald-600 text-white p-4 rounded-xl shadow-lg">
          <div className="text-sm opacity-90">Categories</div>
          <div className="text-3xl font-bold">{Object.keys(stats.categoryCount).length}</div>
        </div>
      </div>

      {/* Charts Section */}
      {filteredProfiles.length > 0 && (
        <div className="grid md:grid-cols-2 gap-6">
          <div className="bg-white p-6 rounded-2xl shadow-lg">
            <div style={{ height: '300px' }}>
              <canvas ref={categoryChartRef}></canvas>
            </div>
          </div>
          <div className="bg-white p-6 rounded-2xl shadow-lg">
            <div style={{ height: '300px' }}>
              <canvas ref={genderChartRef}></canvas>
            </div>
          </div>
          <div className="bg-white p-6 rounded-2xl shadow-lg">
            <div style={{ height: '300px' }}>
              <canvas ref={streamChartRef}></canvas>
            </div>
          </div>
          <div className="bg-white p-6 rounded-2xl shadow-lg">
            <div style={{ height: '300px' }}>
              <canvas ref={schoolDistChartRef}></canvas>
            </div>
          </div>
        </div>
      )}

      {/* Category Breakdown Table */}
      <div className="bg-white p-6 rounded-2xl shadow-lg">
        <h3 className="text-xl font-bold mb-4">üìä Category-wise Breakdown</h3>
        <div className="overflow-x-auto">
          <table className="w-full">
            <thead className="avanti-gradient-light">
              <tr>
                <th className="p-3 text-left">Category</th>
                <th className="p-3 text-center">Male</th>
                <th className="p-3 text-center">Female</th>
                <th className="p-3 text-center">Total</th>
                <th className="p-3 text-center">%</th>
              </tr>
            </thead>
            <tbody>
              {Object.entries(stats.categoryByGender).map(([cat, counts]) => (
                <tr key={cat} className="border-b hover:bg-gray-50">
                  <td className="p-3 font-semibold">{cat}</td>
                  <td className="p-3 text-center text-indigo-600 font-bold">{counts.Male}</td>
                  <td className="p-3 text-center text-pink-600 font-bold">{counts.Female}</td>
                  <td className="p-3 text-center font-bold">{counts.Male + counts.Female + counts.Other}</td>
                  <td className="p-3 text-center">
                    {filteredProfiles.length > 0 
                      ? Math.round(((counts.Male + counts.Female + counts.Other) / filteredProfiles.length) * 100) 
                      : 0}%
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </div>

      <div className="bg-white p-6 rounded-2xl shadow-lg overflow-x-auto">
        <h3 className="text-xl font-bold mb-4">üìã Student Profiles List</h3>
        <table className="w-full">
          <thead className="avanti-gradient-light">
            <tr>
              <th className="p-3 text-left">Student ID</th>
              <th className="p-3 text-left">Name</th>
              <th className="p-3 text-left">Grade</th>
              <th className="p-3 text-left">School</th>
              <th className="p-3 text-left">Stream</th>
              <th className="p-3 text-left">Category</th>
              <th className="p-3 text-left">10th %</th>
              <th className="p-3 text-left">Contact</th>
            </tr>
          </thead>
          <tbody>
            {filteredProfiles.length===0?(
              <tr><td colSpan="8" className="p-8 text-center text-gray-500">No student profiles found</td></tr>
            ):filteredProfiles.map(profile=>
              <tr key={profile.id} className="border-b hover:bg-gray-50">
                <td className="p-3 font-mono">{profile.studentId}</td>
                <td className="p-3 font-semibold">{profile.firstName} {profile.lastName}</td>
                <td className="p-3">{profile.grade}th</td>
                <td className="p-3">{profile.school}</td>
                <td className="p-3">{profile.stream}</td>
                <td className="p-3">
                  <span className={`px-2 py-1 rounded text-xs font-semibold ${
                    profile.category === 'General' ? 'bg-blue-100 text-blue-700' :
                    profile.category === 'OBC' ? 'bg-green-100 text-green-700' :
                    profile.category === 'SC' ? 'bg-yellow-100 text-yellow-700' :
                    profile.category === 'ST' ? 'bg-orange-100 text-orange-700' :
                    profile.category === 'General EWS' ? 'bg-purple-100 text-purple-700' :
                    'bg-gray-100 text-gray-700'
                  }`}>
                    {profile.category || 'N/A'}
                  </span>
                </td>
                <td className="p-3">{profile.percentage10th}%</td>
                <td className="p-3 text-sm">{profile.phone}</td>
              </tr>
            )}
          </tbody>
        </table>
      </div>
    </div>
  );
}

function TeacherView({
  currentUser,
  handleLogout,
  showConfetti,
  Confetti,
  celebrationMessage,
  teachers,
  students,
  curriculum,
  chapterProgress,
  studentAttendance,
  teacherAttendance,
  schoolInfo,
  setSchoolInfo,
  updateChapterProgress,
  activeTab,
  setActiveTab,
  leaveAdjustments
}) {
  const teacherTabs = [
    { id: 'overview', label: 'Dashboard', icon: 'üìä' },
    { id: 'analytics', label: 'Analytics', icon: 'üìà' },
    { id: 'class11', label: 'Class 11', icon: 'üìö' },
    { id: 'class12', label: 'Class 12', icon: 'üìï' },
    { id: 'directory', label: 'Directory', icon: 'üìñ' },
    { id: 'attendance', label: 'Student Attendance', icon: '‚úÖ' },
    { id: 'attendancedash', label: 'Attendance Dashboard', icon: 'üìä' },
    { id: 'myattendance', label: 'My Attendance', icon: 'üïí' },
    { id: 'schoolinfo', label: 'School Info', icon: 'üè´' },
    { id: 'examstats', label: 'Exam Stats', icon: 'üìä' },
    { id: 'myprofile', label: 'My Profile', icon: 'üë§' }
  ];

  const [sidebarCollapsed, setSidebarCollapsed] = useState(false);
  const [isMobileSidebarOpen, setIsMobileSidebarOpen] = useState(false);
  
  // Handle navigation and auto-close on mobile
  const handleTabClick = (tabId) => {
    setActiveTab(tabId);
    // Close sidebar on mobile after navigation
    if (window.innerWidth < 768) {
      setIsMobileSidebarOpen(false);
    }
  };
  
  // Swipe gesture detection
  useEffect(() => {
    let touchStartX = 0;
    let touchEndX = 0;
    
    const handleTouchStart = (e) => {
      touchStartX = e.changedTouches[0].screenX;
    };
    
    const handleTouchEnd = (e) => {
      touchEndX = e.changedTouches[0].screenX;
      handleSwipe();
    };
    
    const handleSwipe = () => {
      const swipeThreshold = 50;
      if (touchEndX - touchStartX > swipeThreshold && touchStartX < 50) {
        // Swipe right from left edge - open sidebar
        setIsMobileSidebarOpen(true);
      } else if (touchStartX - touchEndX > swipeThreshold) {
        // Swipe left - close sidebar
        setIsMobileSidebarOpen(false);
      }
    };
    
    document.addEventListener('touchstart', handleTouchStart);
    document.addEventListener('touchend', handleTouchEnd);
    
    return () => {
      document.removeEventListener('touchstart', handleTouchStart);
      document.removeEventListener('touchend', handleTouchEnd);
    };
  }, []);

  return (
    <div className="min-h-screen bg-gray-50">
      {showConfetti && <Confetti />}

      {/* PWA install helper */}
      <InstallPrompt />
      
      {/* Mobile Menu Button */}
      <button
        onClick={() => setIsMobileSidebarOpen(!isMobileSidebarOpen)}
        className="md:hidden fixed top-4 left-4 z-[1000] bg-gradient-to-r from-yellow-400 to-orange-500 text-white p-3 rounded-lg shadow-lg"
      >
        {isMobileSidebarOpen ? '‚úï' : '‚ò∞'}
      </button>

      {/* Manual Install Button - always visible */}
      <div className="fixed bottom-20 right-4 z-[9998]">
        <button
          onClick={() => {
            if (window.matchMedia('(display-mode: standalone)').matches) {
              alert('App is already installed! ‚úì');
            } else {
              alert(
                'To install:\n\n' +
                  'üì± Mobile: Tap browser menu ‚Üí "Add to Home Screen"\n\n' +
                  'üíª Desktop: Look for install icon in address bar (‚äï or üì•)'
              );
            }
          }}
          className="bg-blue-600 text-white px-4 py-3 rounded-full shadow-2xl font-bold hover:bg-blue-700 transition-all flex items-center gap-2"
        >
          üì± Install App
        </button>
      </div>
      
      {/* Mobile Sidebar Overlay */}
      <div 
        className={`mobile-sidebar-overlay ${isMobileSidebarOpen ? 'active' : ''}`}
        onClick={() => setIsMobileSidebarOpen(false)}
      />

      {/* Vertical Sidebar */}
      <div className={`sidebar mobile-sidebar ${sidebarCollapsed ? 'collapsed' : 'expanded'} ${isMobileSidebarOpen ? 'active' : ''}`}>
        <div className="sidebar-header">
          <div className="flex items-center gap-3">
            <img src={AVANTI_LOGO} alt="Avanti" className="w-10 h-10" />
            <h1 className="text-lg font-bold text-white sidebar-label">Curriculum Tracker</h1>
          </div>
          <button
            onClick={() => setSidebarCollapsed(!sidebarCollapsed)}
            className="sidebar-toggle hidden md:block"
          >
            {sidebarCollapsed ? '‚Üí' : '‚Üê'}
          </button>
        </div>

        <div className="sidebar-nav">
          {teacherTabs.map((tab) => (
            <div
              key={tab.id}
              onClick={() => handleTabClick(tab.id)}
              className={`sidebar-item ${activeTab === tab.id ? 'active' : ''}`}
            >
              <span className="sidebar-icon">{tab.icon}</span>
              <span className="sidebar-label">{tab.label}</span>
            </div>
          ))}
        </div>

        {!sidebarCollapsed && (
          <div className="px-4 py-3 border-t border-white border-opacity-20 mt-auto">
            <div className="text-white text-sm mb-2">
              <p className="font-semibold">{currentUser.name}</p>
              <p className="text-xs opacity-90">{currentUser.school}</p>
            </div>
            <button
              onClick={handleLogout}
              className="w-full px-3 py-2 bg-white bg-opacity-20 text-white rounded-lg font-semibold hover:bg-opacity-30 transition"
            >
              Logout
            </button>
          </div>
        )}
      </div>

      {/* Main content */}
      <div className={`main-content ${sidebarCollapsed ? 'sidebar-collapsed' : 'sidebar-expanded'}`}>
        {celebrationMessage && (
          <div className="avanti-gradient text-white text-center py-4 text-xl font-bold">
            {celebrationMessage}
          </div>
        )}

        <div className="px-4 py-6">

        {/* Tab content */}
        {activeTab === 'overview' && (
          <TeacherOverview
            currentUser={currentUser}
            teachers={teachers}
            students={students}
            curriculum={curriculum}
            chapterProgress={chapterProgress}
            studentAttendance={studentAttendance}
            teacherAttendance={teacherAttendance}
            schoolInfo={schoolInfo}
          />
        )}

        {activeTab === 'analytics' && (
          <TeacherAnalytics
            currentUser={currentUser}
            curriculum={curriculum}
            chapterProgress={chapterProgress}
          />
        )}

        {activeTab === 'class11' && (
  <TeacherCurriculum
    grade="11"
    currentUser={currentUser}
    curriculum={curriculum}
    chapterProgress={chapterProgress}
    updateChapterProgress={updateChapterProgress}
  />
)}

        {activeTab === 'class12' && (
  <TeacherCurriculum
    grade="12"
    currentUser={currentUser}
    curriculum={curriculum}
    chapterProgress={chapterProgress}
    updateChapterProgress={updateChapterProgress}
  />
)}

        {activeTab === 'directory' && (
          <TeacherDirectory teachers={teachers} currentUser={currentUser} />
        )}

        {activeTab === 'myprofile' && (
          <TeacherSelfProfile currentUser={currentUser} teachers={teachers} />
        )}

        {activeTab === 'attendance' && (
          <StudentAttendanceView
            currentUser={currentUser}
            students={students}
            studentAttendance={studentAttendance}
          />
        )}

        {activeTab === 'attendancedash' && (
          <TeacherAttendanceDashboard
            currentUser={currentUser}
            students={students}
            teachers={teachers}
            studentAttendance={studentAttendance}
            teacherAttendance={teacherAttendance}
          />
        )}

        {activeTab === 'myattendance' && (
          <TeacherAttendanceView
            currentUser={currentUser}
            teacherAttendance={teacherAttendance}
            leaveAdjustments={leaveAdjustments}
          />
        )}

        {activeTab === 'schoolinfo' && (
          <SchoolInfoView currentUser={currentUser} schoolInfo={schoolInfo} setSchoolInfo={setSchoolInfo} />
        )}

        {activeTab === 'examstats' && <TeacherExamStats currentUser={currentUser} />}
        </div>
      </div>

      <footer className="bg-gray-800 text-white text-center py-4">
        <p>Made by Anand with ‚ù§Ô∏è</p>
      </footer>
    </div>
  );
}

// ========================================
// ADMIN EXAM REGISTRATION STATISTICS
// ========================================
function AdminExamStats({ accessibleSchools = [], isSuperAdmin = false }) {
  const [examRegistrations, setExamRegistrations] = useState([]);
  const [students, setStudents] = useState([]);

  const [filterSchool, setFilterSchool] = useState('All');
  const [filterGrade, setFilterGrade] = useState('All');
  const [filterGender, setFilterGender] = useState('All');
  const [filterStatus, setFilterStatus] = useState('All'); // Completed / Partial / NotDone / NeedHelp
  const [filterExam, setFilterExam] = useState('All');

  useEffect(() => {
    const fetchData = async () => {
      const regsSnap = await db.collection('studentExamRegistrations').get();
      setExamRegistrations(regsSnap.docs.map(d => ({ ...d.data(), id: d.id })));

      const stuSnap = await db.collection('students').get();
      const studentsData = stuSnap.docs.map(d => {
        const data = d.data();
        let studentId = data.id;
        if (!studentId) {
          const parts = d.id.split('_');
          studentId = parts[parts.length - 1];
        }
        return { ...data, id: studentId, docId: d.id };
      });
      setStudents(studentsData);
    };
    fetchData();
  }, []);

  // Use only accessible schools for dropdown
  const schoolOptions = isSuperAdmin ? SCHOOLS : accessibleSchools;
  
  // Filter students by accessible schools first
  const accessibleStudents = isSuperAdmin ? students : students.filter(s => accessibleSchools.includes(s.school));
  
  const gradeOptions = Array.from(new Set(accessibleStudents.map(s => s.grade).filter(Boolean))).sort();
  const genderOptions = Array.from(new Set(accessibleStudents.map(s => s.gender).filter(Boolean))).sort();
  const examOptions = Array.from(
    new Set(examRegistrations.flatMap(r => (r.exams || []).map(e => e.examName)).filter(Boolean))
  ).sort();

  const filteredStudents = accessibleStudents.filter(s => {
    if (filterSchool !== 'All' && s.school !== filterSchool) return false;
    if (filterGrade !== 'All' && s.grade !== filterGrade) return false;
    if (filterGender !== 'All' && (s.gender || '') !== filterGender) return false;
    return true;
  });

  // Get all student IDs who have at least one exam registration
  const studentsWithAnyReg = new Set();
  examRegistrations.forEach(reg => {
    const student = filteredStudents.find(s => s.id === reg.studentId);
    if (student && reg.exams && reg.exams.length > 0) {
      studentsWithAnyReg.add(reg.studentId);
    }
  });

  // Calculate pending students (those without any registration)
  const pendingStudentsList = filteredStudents.filter(s => !studentsWithAnyReg.has(s.id));

  const detailRows = [];
  
  // If Pending filter is selected, show students without registrations
  if (filterStatus === 'Pending') {
    pendingStudentsList.forEach(student => {
      detailRows.push({ 
        student, 
        reg: { studentId: student.id, studentName: student.name }, 
        exam: { examName: 'No Registration', registrationStatus: 'Pending', needSupport: 'No' },
        isPending: true
      });
    });
  } else {
    // Normal filtering for students with registrations
    examRegistrations.forEach(reg => {
      const student = filteredStudents.find(s => s.id === reg.studentId);
      if (!student) return;
      (reg.exams || []).forEach(exam => {
        if (filterExam !== 'All' && exam.examName !== filterExam) return;
        if (filterStatus === 'Completed' && exam.registrationStatus !== 'Yes') return;
        if (filterStatus === 'Partial' && exam.registrationStatus !== 'Partially') return;
        if (filterStatus === 'NotDone' && exam.registrationStatus !== 'No') return;
        if (filterStatus === 'NeedHelp' && exam.needSupport !== 'Yes') return;
        detailRows.push({ student, reg, exam, isPending: false });
      });
    });
  }

  const totalStudents = filteredStudents.length;
  const studentsWithRegs = studentsWithAnyReg.size;
  const pendingStudents = pendingStudentsList.length;

  const examStats = {};
  // Only calculate exam stats when not showing pending
  if (filterStatus !== 'Pending') {
    detailRows.forEach(({ exam }) => {
      const name = exam.examName || 'Other';
      if (!examStats[name]) {
        examStats[name] = { completed: 0, partial: 0, notCompleted: 0, needSupport: 0 };
      }
      if (exam.registrationStatus === 'Yes') examStats[name].completed++;
      if (exam.registrationStatus === 'Partially') examStats[name].partial++;
      if (exam.registrationStatus === 'No') examStats[name].notCompleted++;
      if (exam.needSupport === 'Yes') examStats[name].needSupport++;
    });
  }

  const handleExport = () => {
    const exportData = detailRows.map(({ student, reg, exam, isPending }) => ({
      'Student ID': reg.studentId || student.id,
      'Student Name': reg.studentName || student.name,
      'School': student.school,
      'Grade': student.grade,
      'Gender': student.gender || '-',
      'Exam Name': isPending ? 'No Registration' : exam.examName,
      'Registration Status': isPending ? 'Pending' : exam.registrationStatus,
      'Registration Number': isPending ? '-' : (exam.registrationNumber || '-'),
      'Password': isPending ? '-' : (exam.password || '-'),
      'Email Used': isPending ? '-' : (exam.emailUsed || '-'),
      'Phone Number Used': isPending ? '-' : (exam.phoneUsed || '-'),
      'Need Support': isPending ? '-' : exam.needSupport,
      'Support Type': isPending ? '-' : (exam.supportType || '-'),
      'Reason Not Completed': isPending ? '-' : (exam.reasonNotCompleted || '-'),
      'Last Updated': isPending ? '-' : (reg.updatedAt ? new Date(reg.updatedAt).toLocaleDateString() : '-')
    }));

    if (exportData.length === 0) {
      alert('No data to export!');
      return;
    }
    exportToExcel(exportData, 'exam_registrations_detailed');
  };

  return (
    <div className="space-y-6">
      <div className="flex justify-between items-center">
        <h2 className="text-3xl font-bold">üìä Exam Registration Statistics</h2>
        <button
          onClick={handleExport}
          className="px-6 py-3 bg-green-600 text-white rounded-xl font-semibold"
        >
          üì• Export
        </button>
      </div>

      {/* Filters */}
      <div className="bg-white p-6 rounded-2xl shadow-lg">
        <h3 className="text-xl font-bold mb-4">üîç Filters</h3>
        <div className="grid md:grid-cols-3 gap-4">
          <div>
            <label className="block text-sm font-bold mb-2">School</label>
            <select
              value={filterSchool}
              onChange={e => setFilterSchool(e.target.value)}
              disabled={!isEditing}
              className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"
            >
              <option value="All">All Schools</option>
              {schoolOptions.map(s => (
                <option key={s} value={s}>{s}</option>
              ))}
            </select>
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">Grade</label>
            <select
              value={filterGrade}
              onChange={e => setFilterGrade(e.target.value)}
              disabled={!isEditing}
              className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"
            >
              <option value="All">All Grades</option>
              <option value="11">Class 11</option>
              <option value="12">Class 12</option>
            </select>
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">Gender</label>
            <select
              value={filterGender}
              onChange={e => setFilterGender(e.target.value)}
              disabled={!isEditing}
              className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"
            >
              <option value="All">All</option>
              {genderOptions.map(g => (
                <option key={g} value={g}>{g}</option>
              ))}
            </select>
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">Exam Name</label>
            <select
              value={filterExam}
              onChange={e => setFilterExam(e.target.value)}
              disabled={!isEditing}
              className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"
            >
              <option value="All">All Exams</option>
              {examOptions.map(name => (
                <option key={name} value={name}>{name}</option>
              ))}
            </select>
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">Status</label>
            <select
              value={filterStatus}
              onChange={e => setFilterStatus(e.target.value)}
              disabled={!isEditing}
              className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"
            >
              <option value="All">All</option>
              <option value="Completed">Completed</option>
              <option value="Partial">Partial</option>
              <option value="NotDone">Not Done</option>
              <option value="NeedHelp">Need Help</option>
              <option value="Pending">Pending (No Registration)</option>
            </select>
          </div>
        </div>
      </div>

      {/* Summary cards */}
      <div className="grid md:grid-cols-3 gap-4">
        <div 
          className="stat-card bg-blue-500 text-white cursor-pointer hover:bg-blue-600 transition-colors"
          onClick={() => setFilterStatus('All')}
        >
          <div className="text-sm opacity-90">Total Students</div>
          <div className="text-5xl font-bold">{totalStudents}</div>
        </div>
        <div 
          className="stat-card bg-green-500 text-white cursor-pointer hover:bg-green-600 transition-colors"
          onClick={() => setFilterStatus('All')}
        >
          <div className="text-sm opacity-90">Registered for Exams</div>
          <div className="text-5xl font-bold">{studentsWithRegs}</div>
        </div>
        <div 
          className="stat-card bg-orange-500 text-white cursor-pointer hover:bg-orange-600 transition-colors"
          onClick={() => setFilterStatus('Pending')}
        >
          <div className="text-sm opacity-90">Pending Registration</div>
          <div className="text-5xl font-bold">{pendingStudents}</div>
          <div className="text-xs opacity-75 mt-1">Click to view list</div>
        </div>
      </div>

      {/* Exam-wise status */}
      <div className="bg-white p-6 rounded-2xl shadow-lg">
        <h3 className="text-xl font-bold mb-4">üìã Exam-wise Registration Status</h3>
        <div className="overflow-x-auto">
          <table className="w-full">
            <thead className="avanti-gradient-light">
              <tr>
                <th className="p-3 text-left">Exam</th>
                <th className="p-3 text-center">Completed</th>
                <th className="p-3 text-center">Partial</th>
                <th className="p-3 text-center">Not Started</th>
                <th className="p-3 text-center">Need Support</th>
              </tr>
            </thead>
            <tbody>
              {Object.keys(examStats).length === 0 ? (
                <tr>
                  <td colSpan="5" className="p-8 text-center text-gray-500">
                    No exam registrations yet
                  </td>
                </tr>
              ) : (
                Object.entries(examStats).map(([examName, stats]) => (
                  <tr key={examName} className="border-b hover:bg-gray-50">
                    <td className="p-3 font-semibold">{examName}</td>
                    <td className="p-3 text-center">
                      <span className="px-3 py-1 rounded-full bg-green-100 text-green-700 font-bold">
                        {stats.completed}
                      </span>
                    </td>
                    <td className="p-3 text-center">
                      <span className="px-3 py-1 rounded-full bg-yellow-100 text-yellow-700 font-bold">
                        {stats.partial}
                      </span>
                    </td>
                    <td className="p-3 text-center">
                      <span className="px-3 py-1 rounded-full bg-red-100 text-red-700 font-bold">
                        {stats.notCompleted}
                      </span>
                    </td>
                    <td className="p-3 text-center">
                      <span className="px-3 py-1 rounded-full bg-orange-100 text-orange-700 font-bold">
                        {stats.needSupport}
                      </span>
                    </td>
                  </tr>
                ))
              )}
            </tbody>
          </table>
        </div>
      </div>

      {/* Student-wise details */}
      <div className="bg-white p-6 rounded-2xl shadow-lg">
        <h3 className="text-xl font-bold mb-4">üßë‚Äçüéì Student-wise Exam Registrations</h3>
        <div className="overflow-x-auto">
          <table className="w-full text-sm">
            <thead className="bg-gray-100">
              <tr>
                <th className="p-3 text-left">Student ID</th>
                <th className="p-3 text-left">Name</th>
                <th className="p-3 text-left">School</th>
                <th className="p-3 text-left">Grade</th>
                <th className="p-3 text-left">Gender</th>
                <th className="p-3 text-left">Exam</th>
                <th className="p-3 text-left">Status</th>
                <th className="p-3 text-left">Need Help</th>
                <th className="p-3 text-left">Reg. No.</th>
                <th className="p-3 text-left">Email</th>
                <th className="p-3 text-left">Phone</th>
              </tr>
            </thead>
            <tbody>
              {detailRows.length === 0 ? (
                <tr>
                  <td colSpan="11" className="p-6 text-center text-gray-500">
                    No exam registrations with current filters.
                  </td>
                </tr>
              ) : (
                detailRows.map((row, idx) => {
                  const status = row.exam.registrationStatus || 'No';
                  const needHelp = row.exam.needSupport === 'Yes';
                  const isPending = row.isPending;
                  return (
                    <tr key={idx} className="border-b hover:bg-gray-50">
                      <td className="p-3">{row.student.id}</td>
                      <td className="p-3">{row.student.name}</td>
                      <td className="p-3">{row.student.school}</td>
                      <td className="p-3">{row.student.grade}</td>
                      <td className="p-3">{row.student.gender || '‚Äî'}</td>
                      <td className="p-3">{isPending ? '‚Äî' : row.exam.examName}</td>
                      <td className="p-3">
                        {isPending && <span className="px-3 py-1 rounded-full bg-gray-100 text-gray-700 font-semibold">Pending</span>}
                        {!isPending && status === 'Yes' && <span className="px-3 py-1 rounded-full bg-green-100 text-green-700 font-semibold">Completed</span>}
                        {!isPending && status === 'Partially' && <span className="px-3 py-1 rounded-full bg-yellow-100 text-yellow-700 font-semibold">Partial</span>}
                        {!isPending && status === 'No' && <span className="px-3 py-1 rounded-full bg-red-100 text-red-700 font-semibold">Not Done</span>}
                      </td>
                      <td className="p-3">
                        {isPending ? '‚Äî' : (needHelp ? (
                          <span className="px-3 py-1 rounded-full bg-orange-100 text-orange-700 font-semibold">Yes</span>
                        ) : (
                          'No'
                        ))}
                      </td>
                      <td className="p-3">{isPending ? '‚Äî' : (row.exam.registrationNumber || '‚Äî')}</td>
                      <td className="p-3">{isPending ? '‚Äî' : (row.exam.emailUsed || '‚Äî')}</td>
                      <td className="p-3">{isPending ? '‚Äî' : (row.exam.phoneUsed || '‚Äî')}</td>
                    </tr>
                  );
                })
              )}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  );
}

// ========================================
// MANAGER MANAGEMENT COMPONENT (4-Level Hierarchy)
// ========================================
function ManagerManagement({ managers, currentUser, isSuperAdmin }) {
  const [showModal, setShowModal] = useState(false);
  const [editingManager, setEditingManager] = useState(null);
  const [form, setForm] = useState({
    name: '',
    email: '',
    afCode: '',
    role: MANAGER_ROLES.APH,
    reportsTo: '',
    directSchools: [],
    phone: '',
    status: 'active'
  });
  const [filterRole, setFilterRole] = useState('All');
  const [searchQuery, setSearchQuery] = useState('');
  const [allSchools, setAllSchools] = useState([...SCHOOLS]);
  const [newSchoolName, setNewSchoolName] = useState('');
  const [showSchoolModal, setShowSchoolModal] = useState(false);

  // Fetch schools from Firebase
  useEffect(() => {
    const fetchSchools = async () => {
      const schoolsSnap = await db.collection('schoolsList').get();
      if (!schoolsSnap.empty) {
        const schoolsData = schoolsSnap.docs.map(d => d.data().name).filter(Boolean);
        if (schoolsData.length > 0) {
          setAllSchools(schoolsData);
        }
      }
    };
    fetchSchools();
  }, []);

  // Get managers by role for dropdown options
  const getManagersByRole = (role) => managers.filter(m => m.role === role && m.status === 'active');
  
  // Get valid "reports to" options based on selected role
  const getReportsToOptions = (role) => {
    switch(role) {
      case MANAGER_ROLES.APH: return []; // APH reports to Super Admin (no selection needed)
      case MANAGER_ROLES.PM: return getManagersByRole(MANAGER_ROLES.APH); // PM reports to APH
      case MANAGER_ROLES.APM: return getManagersByRole(MANAGER_ROLES.PM); // APM reports to PM
      default: return [];
    }
  };

  // Filter managers
  const filteredManagers = managers.filter(m => {
    if (filterRole !== 'All' && m.role !== filterRole) return false;
    if (searchQuery && !m.name?.toLowerCase().includes(searchQuery.toLowerCase()) && 
        !m.email?.toLowerCase().includes(searchQuery.toLowerCase())) return false;
    return true;
  });

  // Recursive function to get all reportees
  const getAllReportees = (managerId) => {
    const directReportees = managers.filter(m => m.reportsTo === managerId);
    let allReportees = [...directReportees];
    directReportees.forEach(r => {
      allReportees = [...allReportees, ...getAllReportees(r.id)];
    });
    return allReportees;
  };

  // Get direct reportees
  const getDirectReportees = (managerId) => {
    return managers.filter(m => m.reportsTo === managerId);
  };

  // Get manager name by ID
  const getManagerName = (managerId) => {
    const manager = managers.find(m => m.id === managerId);
    return manager ? manager.name : 'Super Admin';
  };

  // Calculate total schools for a manager (direct + all reportees)
  const getTotalSchools = (manager) => {
    let schools = [...(manager.directSchools || [])];
    const reportees = getAllReportees(manager.id);
    reportees.forEach(r => {
      schools = [...schools, ...(r.directSchools || [])];
    });
    return [...new Set(schools)];
  };

  const openAddModal = () => {
    setEditingManager(null);
    setForm({
      name: '',
      email: '',
      role: MANAGER_ROLES.APH,
      reportsTo: '',
      directSchools: [],
      phone: '',
      status: 'active'
    });
    setShowModal(true);
  };

  const openEditModal = (manager) => {
    setEditingManager(manager);
    setForm({
      name: manager.name || '',
      email: manager.email || '',
      role: manager.role || MANAGER_ROLES.APH,
      reportsTo: manager.reportsTo || '',
      directSchools: manager.directSchools || [],
      phone: manager.phone || '',
      status: manager.status || 'active'
    });
    setShowModal(true);
  };

  const handleSubmit = async () => {
    if (!form.name || !form.email) {
      alert('Please fill in required fields');
      return;
    }
    
    // Validate reports to for PM and APM
    if ((form.role === MANAGER_ROLES.PM || form.role === MANAGER_ROLES.APM) && !form.reportsTo) {
      alert('Please select who this person reports to');
      return;
    }

    try {
      const managerData = {
        name: form.name,
        email: form.email.toLowerCase(),
        afCode: form.afCode || null,
        role: form.role,
        reportsTo: form.role === MANAGER_ROLES.APH ? null : form.reportsTo,
        directSchools: form.directSchools,
        phone: form.phone,
        status: form.status,
        updatedAt: new Date().toISOString()
      };

      if (editingManager) {
        await db.collection('managers').doc(editingManager.id).update(managerData);
        alert('‚úÖ Updated successfully!');
      } else {
        managerData.createdAt = new Date().toISOString();
        await db.collection('managers').add(managerData);
        
        alert(`‚úÖ ${ROLE_LABELS[form.role]} added successfully!\n\n` +
              `üìß Email: ${form.email}\n\n` +
              `‚ö†Ô∏è IMPORTANT: Create Firebase Auth user:\n` +
              `1. Firebase Console ‚Üí Authentication ‚Üí Users\n` +
              `2. Click "Add user"\n` +
              `3. Enter: ${form.email}\n` +
              `4. Set password and share with them`);
      }
      
      setShowModal(false);
      window.location.reload();
    } catch (e) {
      alert('Failed: ' + e.message);
    }
  };

  const handleDeactivate = async (manager) => {
    if (!confirm(`Deactivate ${manager.name}?\n\nThey will lose access to the system.`)) return;
    
    try {
      await db.collection('managers').doc(manager.id).update({
        status: 'inactive',
        deactivatedAt: new Date().toISOString()
      });
      alert('‚úÖ Deactivated');
      window.location.reload();
    } catch (e) {
      alert('Failed: ' + e.message);
    }
  };

  const handleReactivate = async (manager) => {
    try {
      await db.collection('managers').doc(manager.id).update({
        status: 'active',
        reactivatedAt: new Date().toISOString()
      });
      alert('‚úÖ Reactivated');
      window.location.reload();
    } catch (e) {
      alert('Failed: ' + e.message);
    }
  };

  const handleAddSchool = async () => {
    if (!newSchoolName.trim()) {
      alert('Please enter a school name');
      return;
    }
    
    if (allSchools.includes(newSchoolName.trim())) {
      alert('This school already exists');
      return;
    }

    try {
      await db.collection('schoolsList').add({
        name: newSchoolName.trim(),
        createdAt: new Date().toISOString(),
        createdBy: currentUser.email
      });
      
      setAllSchools([...allSchools, newSchoolName.trim()]);
      setNewSchoolName('');
      alert('‚úÖ School added!');
    } catch (e) {
      alert('Failed: ' + e.message);
    }
  };

  const handleRemoveSchool = async (schoolName) => {
    if (!confirm(`Remove "${schoolName}"?\n\n‚ö†Ô∏è Existing data will NOT be deleted.`)) return;
    
    try {
      const schoolsSnap = await db.collection('schoolsList').where('name', '==', schoolName).get();
      if (!schoolsSnap.empty) {
        await schoolsSnap.docs[0].ref.delete();
      }
      setAllSchools(allSchools.filter(s => s !== schoolName));
      alert('‚úÖ School removed');
    } catch (e) {
      alert('Failed: ' + e.message);
    }
  };

  const toggleSchoolSelection = (school) => {
    if (form.directSchools.includes(school)) {
      setForm({ ...form, directSchools: form.directSchools.filter(s => s !== school) });
    } else {
      setForm({ ...form, directSchools: [...form.directSchools, school] });
    }
  };

  // Render hierarchy card recursively
  const renderManagerCard = (manager, level = 0) => {
    const colors = ROLE_COLORS[manager.role] || ROLE_COLORS['apm'];
    const reportees = getDirectReportees(manager.id);
    const totalSchools = getTotalSchools(manager);
    
    return (
      <div key={manager.id} className={`${level > 0 ? 'ml-4 md:ml-8 mt-2' : ''}`}>
        <div className={`border-2 ${colors.border} rounded-xl p-4 ${colors.bg}`}>
          <div className="flex items-start justify-between flex-wrap gap-2">
            <div className="flex-1 min-w-0">
              <div className="flex items-center gap-2 flex-wrap">
                <span className="text-2xl">{manager.role === MANAGER_ROLES.APH ? 'üëî' : manager.role === MANAGER_ROLES.PM ? 'üë®‚Äçüíº' : 'üë§'}</span>
                <span className="text-xl font-bold">{manager.name}</span>
                <span className={`px-3 py-1 ${colors.bg} ${colors.text} text-xs rounded-full font-bold border ${colors.border}`}>
                  {ROLE_LABELS[manager.role]}
                </span>
                {manager.status !== 'active' && (
                  <span className="px-3 py-1 bg-red-500 text-white text-xs rounded-full font-bold">INACTIVE</span>
                )}
              </div>
              <div className="text-sm text-gray-600 mt-1">üìß {manager.email}</div>
              {manager.reportsTo && (
                <div className="text-sm text-gray-500 mt-1">‚Ü≥ Reports to: {getManagerName(manager.reportsTo)}</div>
              )}
              <div className="mt-2">
                <span className="text-sm font-semibold">Direct Schools:</span>
                <div className="flex flex-wrap gap-2 mt-1">
                  {(manager.directSchools || []).map(school => (
                    <span key={school} className="px-2 py-1 bg-white text-sm rounded border">üè´ {school}</span>
                  ))}
                  {(!manager.directSchools || manager.directSchools.length === 0) && (
                    <span className="text-gray-400 text-sm">No schools assigned</span>
                  )}
                </div>
              </div>
              {reportees.length > 0 && (
                <div className="mt-2 text-sm text-green-600 font-semibold">
                  üìä Total Access: {totalSchools.length} schools (via {reportees.length} reportees)
                </div>
              )}
            </div>
            {isSuperAdmin && (
              <div className="flex gap-2">
                <button onClick={() => openEditModal(manager)} className="px-3 py-1 bg-yellow-400 rounded-lg font-semibold text-sm">Edit</button>
                {manager.status === 'active' ? (
                  <button onClick={() => handleDeactivate(manager)} className="px-3 py-1 bg-red-500 text-white rounded-lg font-semibold text-sm">Deactivate</button>
                ) : (
                  <button onClick={() => handleReactivate(manager)} className="px-3 py-1 bg-green-500 text-white rounded-lg font-semibold text-sm">Reactivate</button>
                )}
              </div>
            )}
          </div>
        </div>
        {/* Render reportees */}
        {reportees.map(reportee => renderManagerCard(reportee, level + 1))}
      </div>
    );
  };

  // Get top-level managers (APHs - report to no one)
  const topLevelManagers = managers.filter(m => m.role === MANAGER_ROLES.APH && m.status === 'active');
  
  // Get unassigned managers (PM/APM without valid reportsTo)
  const unassignedManagers = managers.filter(m => 
    (m.role === MANAGER_ROLES.PM || m.role === MANAGER_ROLES.APM) && 
    !m.reportsTo && 
    m.status === 'active'
  );

  return (
    <div className="space-y-6">
      <div className="flex justify-between items-center flex-wrap gap-4">
        <h2 className="text-3xl font-bold">üë• Manager & School Management</h2>
        <div className="flex gap-3">
          {isSuperAdmin && (
            <>
              <button onClick={() => setShowSchoolModal(true)} className="px-6 py-3 bg-green-600 text-white rounded-xl font-semibold">
                üè´ Manage Schools
              </button>
              <button onClick={openAddModal} className="px-6 py-3 bg-blue-600 text-white rounded-xl font-semibold">
                + Add Manager
              </button>
            </>
          )}
        </div>
      </div>

      {/* Role Legend */}
      <div className="bg-white p-4 rounded-xl shadow-lg">
        <h3 className="font-bold mb-3">üìã Role Hierarchy</h3>
        <div className="flex flex-wrap gap-3">
          <span className="px-3 py-2 bg-purple-100 text-purple-700 rounded-lg text-sm font-semibold border border-purple-200">üëë Super Admin</span>
          <span className="text-gray-400">‚Üí</span>
          <span className="px-3 py-2 bg-blue-100 text-blue-700 rounded-lg text-sm font-semibold border border-blue-200">üëî PH (Program Head)</span>
          <span className="text-gray-400">‚Üí</span>
          <span className="px-3 py-2 bg-green-100 text-green-700 rounded-lg text-sm font-semibold border border-green-200">üë®‚Äçüíº PM (Program Manager)</span>
          <span className="text-gray-400">‚Üí</span>
          <span className="px-3 py-2 bg-orange-100 text-orange-700 rounded-lg text-sm font-semibold border border-orange-200">üë§ APM (Associate Program Manager)</span>
        </div>
      </div>

      {/* Filters */}
      <div className="bg-white p-6 rounded-2xl shadow-lg">
        <h3 className="text-xl font-bold mb-4">üîç Filters</h3>
        <div className="grid md:grid-cols-2 gap-4">
          <div>
            <label className="block text-sm font-bold mb-2">Search</label>
            <input 
              type="text" 
              value={searchQuery} 
              onChange={e => setSearchQuery(e.target.value)}
              placeholder="Search by name or email..."
              className="w-full border-2 px-4 py-3 rounded-xl"
            />
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">Role</label>
            <select 
              value={filterRole} 
              onChange={e => setFilterRole(e.target.value)}
              className="w-full border-2 px-4 py-3 rounded-xl"
            >
              <option value="All">All Roles</option>
              <option value={MANAGER_ROLES.APH}>Program Head (PH)</option>
              <option value={MANAGER_ROLES.PM}>Program Manager (PM)</option>
              <option value={MANAGER_ROLES.APM}>Associate Program Manager (APM)</option>
            </select>
          </div>
        </div>
      </div>

      {/* Hierarchy View */}
      <div className="bg-white p-6 rounded-2xl shadow-lg">
        <h3 className="text-xl font-bold mb-4">üìä Organization Hierarchy</h3>
        <div className="space-y-4">
          {/* Super Admin Card */}
          <div className="border-2 border-purple-200 rounded-xl p-4 bg-purple-50">
            <div className="flex items-center gap-2">
              <span className="text-2xl">üëë</span>
              <span className="text-xl font-bold">Super Administrator</span>
              <span className="px-3 py-1 bg-purple-600 text-white text-xs rounded-full font-bold">SUPER ADMIN</span>
            </div>
            <div className="text-sm text-gray-600 mt-1">üìß admin@avantifellows.org</div>
            <div className="text-sm text-green-600 font-semibold mt-2">üìä Full Access: All Schools</div>
          </div>
          
          {/* APHs and their tree */}
          {topLevelManagers.map(manager => renderManagerCard(manager))}
          
          {/* Unassigned Managers Warning */}
          {unassignedManagers.length > 0 && (
            <div className="border-2 border-red-200 rounded-xl p-4 bg-red-50">
              <div className="text-lg font-bold text-red-700 mb-2">‚ö†Ô∏è Unassigned Managers ({unassignedManagers.length})</div>
              <p className="text-sm text-red-600 mb-3">These managers don't have anyone to report to. Please assign them.</p>
              {unassignedManagers.map(m => (
                <div key={m.id} className="border border-red-300 rounded-lg p-3 bg-white mb-2">
                  <div className="flex items-center gap-2">
                    <span className="font-bold">{m.name}</span>
                    <span className={`px-2 py-1 ${ROLE_COLORS[m.role]?.bg} ${ROLE_COLORS[m.role]?.text} text-xs rounded-full font-bold`}>
                      {ROLE_LABELS[m.role]}
                    </span>
                  </div>
                  <button onClick={() => openEditModal(m)} className="mt-2 px-3 py-1 bg-yellow-400 rounded-lg font-semibold text-sm">
                    Assign Manager
                  </button>
                </div>
              ))}
            </div>
          )}
          
          {topLevelManagers.length === 0 && (
            <div className="text-center py-8 text-gray-500">
              <p>No managers found. Click "+ Add Manager" to add your first Program Head.</p>
            </div>
          )}
        </div>
      </div>

      {/* Table View */}
      <div className="bg-white p-6 rounded-2xl shadow-lg overflow-x-auto">
        <h3 className="text-xl font-bold mb-4">üìã All Staff ({filteredManagers.length})</h3>
        <table className="w-full">
          <thead className="avanti-gradient-light">
            <tr>
              <th className="p-3 text-left">Name</th>
              <th className="p-3 text-left">Email</th>
              <th className="p-3 text-left">Role</th>
              <th className="p-3 text-left">Reports To</th>
              <th className="p-3 text-left">Direct Schools</th>
              <th className="p-3 text-left">Total Access</th>
              <th className="p-3 text-left">Status</th>
              {isSuperAdmin && <th className="p-3 text-left">Actions</th>}
            </tr>
          </thead>
          <tbody>
            {filteredManagers.length === 0 ? (
              <tr><td colSpan={isSuperAdmin ? 8 : 7} className="p-8 text-center text-gray-500">No managers found</td></tr>
            ) : (
              filteredManagers.map(manager => (
                <tr key={manager.id} className="border-b hover:bg-gray-50">
                  <td className="p-3 font-semibold">{manager.name}</td>
                  <td className="p-3 text-sm">{manager.email}</td>
                  <td className="p-3">
                    <span className={`px-3 py-1 rounded-full text-xs font-bold ${ROLE_COLORS[manager.role]?.bg} ${ROLE_COLORS[manager.role]?.text}`}>
                      {ROLE_LABELS[manager.role]}
                    </span>
                  </td>
                  <td className="p-3">{manager.reportsTo ? getManagerName(manager.reportsTo) : 'Super Admin'}</td>
                  <td className="p-3">
                    <div className="flex flex-wrap gap-1">
                      {(manager.directSchools || []).slice(0, 2).map(s => (
                        <span key={s} className="px-2 py-1 bg-gray-100 text-xs rounded">{s}</span>
                      ))}
                      {(manager.directSchools || []).length > 2 && (
                        <span className="px-2 py-1 bg-gray-200 text-xs rounded">+{manager.directSchools.length - 2}</span>
                      )}
                    </div>
                  </td>
                  <td className="p-3 font-bold">{getTotalSchools(manager).length}</td>
                  <td className="p-3">
                    <span className={`px-3 py-1 rounded-full text-xs font-bold ${
                      manager.status === 'active' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'
                    }`}>
                      {manager.status === 'active' ? 'Active' : 'Inactive'}
                    </span>
                  </td>
                  {isSuperAdmin && (
                    <td className="p-3">
                      <button onClick={() => openEditModal(manager)} className="px-3 py-1 bg-yellow-400 rounded-lg font-semibold text-sm">Edit</button>
                    </td>
                  )}
                </tr>
              ))
            )}
          </tbody>
        </table>
      </div>

      {/* Add/Edit Modal */}
      {showModal && (
        <div className="modal-overlay" onClick={() => setShowModal(false)}>
          <div className="modal-content max-w-2xl" onClick={e => e.stopPropagation()}>
            <h3 className="text-2xl font-bold mb-4">{editingManager ? 'Edit Staff Member' : 'Add New Staff Member'}</h3>
            <div className="space-y-4">
              <div className="grid md:grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-bold mb-1">Full Name *</label>
                  <input 
                    type="text" 
                    value={form.name} 
                    onChange={e => setForm({ ...form, name: e.target.value })}
                    className="w-full border-2 px-3 py-2 rounded-lg"
                    placeholder="e.g., Anand Joshi"
                  />
                </div>
                <div>
                  <label className="block text-sm font-bold mb-1">Email *</label>
                  <input 
                    type="email" 
                    value={form.email} 
                    onChange={e => setForm({ ...form, email: e.target.value })}
                    className="w-full border-2 px-3 py-2 rounded-lg"
                    placeholder="e.g., anand@avantifellows.org"
                  />
                </div>
              </div>

              <div className="grid md:grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-bold mb-1">AF Code (e.g. AF355)</label>
                  <input 
                    type="text" 
                    value={form.afCode || ''} 
                    onChange={e => setForm({ ...form, afCode: e.target.value })}
                    className="w-full border-2 px-3 py-2 rounded-lg"
                    placeholder="e.g., AF355"
                  />
                </div>
                <div>
                  <label className="block text-sm font-bold mb-1">Phone</label>
                  <input 
                    type="tel" 
                    value={form.phone} 
                    onChange={e => setForm({ ...form, phone: e.target.value })}
                    className="w-full border-2 px-3 py-2 rounded-lg"
                    placeholder="e.g., 9876543210"
                  />
                </div>
              </div>

              <div className="grid md:grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-bold mb-1">Role *</label>
                  <select 
                    value={form.role} 
                    onChange={e => setForm({ ...form, role: e.target.value, reportsTo: '' })}
                    className="w-full border-2 px-3 py-2 rounded-lg"
                  >
                    <option value={MANAGER_ROLES.APH}>Program Head (PH)</option>
                    <option value={MANAGER_ROLES.PM}>Program Manager (PM)</option>
                    <option value={MANAGER_ROLES.APM}>Associate Program Manager (APM)</option>
                  </select>
                </div>
              </div>

              {(form.role === MANAGER_ROLES.PM || form.role === MANAGER_ROLES.APM) && (
                <div>
                  <label className="block text-sm font-bold mb-1">
                    Reports To ({form.role === MANAGER_ROLES.PM ? 'PH' : 'PM'}) *
                  </label>
                  <select 
                    value={form.reportsTo} 
                    onChange={e => setForm({ ...form, reportsTo: e.target.value })}
                    className="w-full border-2 px-3 py-2 rounded-lg"
                  >
                    <option value="">Select {form.role === MANAGER_ROLES.PM ? 'Program Head' : 'Program Manager'}</option>
                    {getReportsToOptions(form.role).map(m => (
                      <option key={m.id} value={m.id}>{m.name} ({ROLE_LABELS[m.role]})</option>
                    ))}
                  </select>
                  <p className="text-xs text-gray-600 mt-1">
                    {form.role === MANAGER_ROLES.PM 
                      ? 'The PH will see all schools assigned to this PM and their APMs'
                      : 'The PM will see all schools assigned to this APM'}
                  </p>
                </div>
              )}

              <div>
                <label className="block text-sm font-bold mb-2">Assign Schools *</label>
                <div className="border-2 rounded-lg p-3 max-h-48 overflow-y-auto">
                  {allSchools.map(school => (
                    <label key={school} className="flex items-center gap-2 p-2 hover:bg-gray-50 cursor-pointer">
                      <input 
                        type="checkbox"
                        checked={form.directSchools.includes(school)}
                        onChange={() => toggleSchoolSelection(school)}
                        className="cursor-pointer"
                      />
                      <span>{school}</span>
                    </label>
                  ))}
                  {allSchools.length === 0 && (
                    <p className="text-gray-500 text-center py-4">No schools available. Add schools first.</p>
                  )}
                </div>
                <p className="text-xs text-gray-600 mt-1">Selected: {form.directSchools.length} school(s)</p>
              </div>

              <div className="flex gap-3">
                <button onClick={handleSubmit} className="flex-1 avanti-gradient text-white py-3 rounded-xl font-bold">
                  {editingManager ? 'Update' : 'Add Staff Member'}
                </button>
                <button onClick={() => setShowModal(false)} className="px-6 py-3 bg-gray-200 rounded-xl font-bold">Cancel</button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Manage Schools Modal */}
      {showSchoolModal && (
        <div className="modal-overlay" onClick={() => setShowSchoolModal(false)}>
          <div className="modal-content" onClick={e => e.stopPropagation()}>
            <h3 className="text-2xl font-bold mb-4">üè´ Manage Schools</h3>
            
            <div className="mb-4">
              <label className="block text-sm font-bold mb-2">Add New School</label>
              <div className="flex gap-2">
                <input 
                  type="text"
                  value={newSchoolName}
                  onChange={e => setNewSchoolName(e.target.value)}
                  placeholder="e.g., JNV Mumbai"
                  className="flex-1 border-2 px-3 py-2 rounded-lg"
                />
                <button onClick={handleAddSchool} className="px-4 py-2 bg-green-600 text-white rounded-lg font-semibold">Add</button>
              </div>
            </div>

            <div>
              <label className="block text-sm font-bold mb-2">Current Schools ({allSchools.length})</label>
              <div className="border-2 rounded-lg max-h-64 overflow-y-auto">
                {allSchools.map(school => (
                  <div key={school} className="flex items-center justify-between p-3 border-b hover:bg-gray-50">
                    <span className="font-medium">üè´ {school}</span>
                    <button onClick={() => handleRemoveSchool(school)} className="px-3 py-1 bg-red-100 text-red-600 rounded-lg text-sm font-semibold hover:bg-red-200">Remove</button>
                  </div>
                ))}
                {allSchools.length === 0 && <p className="text-gray-500 text-center py-4">No schools added yet.</p>}
              </div>
            </div>

            <button onClick={() => setShowSchoolModal(false)} className="w-full mt-4 px-6 py-3 bg-gray-200 rounded-xl font-bold">Close</button>
          </div>
        </div>
      )}
    </div>
  );
}

// ========================================
// ACADEMIC YEAR MANAGEMENT COMPONENT
// ========================================
function AcademicYearManagement({ teachers, students, curriculum, chapterProgress, studentAttendance, teacherAttendance, academicYearSettings }) {
  const [currentAY, setCurrentAY] = useState(academicYearSettings?.currentYear || CURRENT_ACADEMIC_YEAR);
  const [isTransitioning, setIsTransitioning] = useState(false);
  const [transitionProgress, setTransitionProgress] = useState(0);
  const [transitionLog, setTransitionLog] = useState([]);
  const [showConfirmModal, setShowConfirmModal] = useState(false);
  const [newAcademicYear, setNewAcademicYear] = useState('');
  const [archivedYears, setArchivedYears] = useState([]);

  useEffect(() => {
    // Fetch archived years
    const fetchArchived = async () => {
      const archiveSnap = await db.collection('archives').get();
      const years = [...new Set(archiveSnap.docs.map(d => d.data().academicYear))].filter(Boolean);
      setArchivedYears(years);
    };
    fetchArchived();
  }, []);

  // Calculate next academic year
  const getNextAcademicYear = () => {
    const parts = currentAY.split('-');
    const startYear = parseInt(parts[0]) + 1;
    return `${startYear}-${startYear + 1}`;
  };

  // Count students by grade
  const studentsByGrade = useMemo(() => {
    const counts = { '11': 0, '12': 0 };
    students.forEach(s => {
      if (s.grade === '11' || s.grade === 11) counts['11']++;
      if (s.grade === '12' || s.grade === 12) counts['12']++;
    });
    return counts;
  }, [students]);

  const addLog = (message) => {
    setTransitionLog(prev => [...prev, `${new Date().toLocaleTimeString()} - ${message}`]);
  };

  const startTransition = async () => {
    if (!newAcademicYear || !newAcademicYear.match(/^\d{4}-\d{4}$/)) {
      alert('Please enter a valid academic year (e.g., 2025-2026)');
      return;
    }

    setShowConfirmModal(false);
    setIsTransitioning(true);
    setTransitionProgress(0);
    setTransitionLog([]);

    try {
      addLog('üöÄ Starting academic year transition...');
      addLog(`üìÖ From: ${currentAY} ‚Üí To: ${newAcademicYear}`);

      // Step 1: Archive Curriculum Progress (10%)
      addLog('üìö Step 1: Archiving curriculum progress...');
      setTransitionProgress(5);
      
      const progressSnap = await db.collection('chapterProgress').get();
      const batch1 = db.batch();
      let progressCount = 0;
      
      progressSnap.docs.forEach(doc => {
        const archiveRef = db.collection('archives').doc(`chapterProgress_${currentAY}_${doc.id}`);
        batch1.set(archiveRef, {
          ...doc.data(),
          academicYear: currentAY,
          archivedAt: new Date().toISOString(),
          originalDocId: doc.id,
          type: 'chapterProgress'
        });
        progressCount++;
      });
      await batch1.commit();
      addLog(`‚úÖ Archived ${progressCount} curriculum progress records`);
      setTransitionProgress(15);

      // Step 2: Archive Student Attendance (20%)
      addLog('üìä Step 2: Archiving student attendance...');
      const studentAttSnap = await db.collection('studentAttendance').get();
      const batch2 = db.batch();
      let studentAttCount = 0;
      
      studentAttSnap.docs.forEach(doc => {
        const archiveRef = db.collection('archives').doc(`studentAttendance_${currentAY}_${doc.id}`);
        batch2.set(archiveRef, {
          ...doc.data(),
          academicYear: currentAY,
          archivedAt: new Date().toISOString(),
          originalDocId: doc.id,
          type: 'studentAttendance'
        });
        studentAttCount++;
      });
      await batch2.commit();
      addLog(`‚úÖ Archived ${studentAttCount} student attendance records`);
      setTransitionProgress(30);

      // Step 3: Archive Teacher Attendance (30%)
      addLog('üë• Step 3: Archiving teacher attendance...');
      const teacherAttSnap = await db.collection('teacherAttendance').get();
      const batch3 = db.batch();
      let teacherAttCount = 0;
      
      teacherAttSnap.docs.forEach(doc => {
        const archiveRef = db.collection('archives').doc(`teacherAttendance_${currentAY}_${doc.id}`);
        batch3.set(archiveRef, {
          ...doc.data(),
          academicYear: currentAY,
          archivedAt: new Date().toISOString(),
          originalDocId: doc.id,
          type: 'teacherAttendance'
        });
        teacherAttCount++;
      });
      await batch3.commit();
      addLog(`‚úÖ Archived ${teacherAttCount} teacher attendance records`);
      setTransitionProgress(40);

      // Step 4: Archive Student Feedback (40%)
      addLog('üí¨ Step 4: Archiving student feedback...');
      const feedbackSnap = await db.collection('teacherFeedback').get();
      const batch4 = db.batch();
      let feedbackCount = 0;
      
      feedbackSnap.docs.forEach(doc => {
        const archiveRef = db.collection('archives').doc(`teacherFeedback_${currentAY}_${doc.id}`);
        batch4.set(archiveRef, {
          ...doc.data(),
          academicYear: currentAY,
          archivedAt: new Date().toISOString(),
          originalDocId: doc.id,
          type: 'teacherFeedback'
        });
        feedbackCount++;
      });
      await batch4.commit();
      addLog(`‚úÖ Archived ${feedbackCount} feedback records`);
      setTransitionProgress(50);

      // Step 5: Archive Exam Registrations (50%)
      addLog('üìù Step 5: Archiving exam registrations...');
      const examSnap = await db.collection('studentExamRegistrations').get();
      const batch5 = db.batch();
      let examCount = 0;
      
      examSnap.docs.forEach(doc => {
        const archiveRef = db.collection('archives').doc(`examRegistrations_${currentAY}_${doc.id}`);
        batch5.set(archiveRef, {
          ...doc.data(),
          academicYear: currentAY,
          archivedAt: new Date().toISOString(),
          originalDocId: doc.id,
          type: 'examRegistrations'
        });
        examCount++;
      });
      await batch5.commit();
      addLog(`‚úÖ Archived ${examCount} exam registration records`);
      setTransitionProgress(60);

      // Step 6: Save Teacher History (60%)
      addLog('üìà Step 6: Saving teacher performance history...');
      const teachersSnap = await db.collection('teachers').get();
      const batch6 = db.batch();
      
      for (const teacherDoc of teachersSnap.docs) {
        const teacher = teacherDoc.data();
        
        // Calculate teacher metrics for this year
        const teacherProgress = progressSnap.docs.filter(p => {
          const data = p.data();
          return data.school === teacher.school && data.subject === teacher.subject;
        });
        
        const totalChapters = teacherProgress.length;
        const completedChapters = teacherProgress.filter(p => p.data().completed === 'Yes').length;
        const onTimeChapters = teacherProgress.filter(p => {
          const data = p.data();
          if (data.completed !== 'Yes') return false;
          const completed = new Date(data.completedDate);
          const expected = new Date(data.expectedDate);
          return completed <= expected;
        }).length;
        
        // Get feedback for this teacher
        const teacherFeedback = feedbackSnap.docs.filter(f => f.data().teacherAfid === teacher.afid);
        const avgRating = teacherFeedback.length > 0 
          ? teacherFeedback.reduce((sum, f) => sum + (f.data().rating || 0), 0) / teacherFeedback.length 
          : 0;
        
        // Get attendance
        const teacherAtt = teacherAttSnap.docs.filter(a => a.data().afid === teacher.afid);
        const presentDays = teacherAtt.filter(a => a.data().status === 'Present').length;
        const totalWorkDays = teacherAtt.length;
        
        const historyRef = db.collection('teacherHistory').doc(`${teacher.afid}_${currentAY}`);
        batch6.set(historyRef, {
          afid: teacher.afid,
          name: teacher.name,
          email: teacher.email,
          school: teacher.school,
          subject: teacher.subject,
          academicYear: currentAY,
          metrics: {
            totalChapters,
            completedChapters,
            completionRate: totalChapters > 0 ? Math.round((completedChapters / totalChapters) * 100) : 0,
            onTimeChapters,
            onTimeRate: completedChapters > 0 ? Math.round((onTimeChapters / completedChapters) * 100) : 0,
            delayedChapters: completedChapters - onTimeChapters,
            feedbackCount: teacherFeedback.length,
            avgFeedbackRating: Math.round(avgRating * 10) / 10,
            presentDays,
            totalWorkDays,
            attendanceRate: totalWorkDays > 0 ? Math.round((presentDays / totalWorkDays) * 100) : 0
          },
          savedAt: new Date().toISOString()
        });
      }
      await batch6.commit();
      addLog(`‚úÖ Saved history for ${teachersSnap.docs.length} teachers`);
      setTransitionProgress(70);

      // Step 7: Promote 11th ‚Üí 12th (70%)
      addLog('üéì Step 7: Promoting 11th grade to 12th...');
      const studentsSnap = await db.collection('students').get();
      const batch7 = db.batch();
      let promoted11to12 = 0;
      
      studentsSnap.docs.forEach(doc => {
        const student = doc.data();
        if (student.grade === '11' || student.grade === 11) {
          batch7.update(doc.ref, { 
            grade: '12',
            previousGrade: '11',
            promotedAt: new Date().toISOString(),
            promotedInYear: newAcademicYear
          });
          promoted11to12++;
        }
      });
      await batch7.commit();
      addLog(`‚úÖ Promoted ${promoted11to12} students from 11th to 12th`);
      setTransitionProgress(80);

      // Step 8: Move 12th ‚Üí Alumni (80%)
      addLog('üéì Step 8: Moving 12th grade to Alumni...');
      const batch8 = db.batch();
      let movedToAlumni = 0;
      
      studentsSnap.docs.forEach(doc => {
        const student = doc.data();
        if (student.grade === '12' || student.grade === 12) {
          // Create alumni record
          const alumniRef = db.collection('alumni').doc(doc.id);
          batch8.set(alumniRef, {
            ...student,
            grade: 'Alumni',
            graduatedYear: currentAY,
            movedToAlumniAt: new Date().toISOString(),
            status: 'alumni'
          });
          // Delete from active students
          batch8.delete(doc.ref);
          movedToAlumni++;
        }
      });
      await batch8.commit();
      addLog(`‚úÖ Moved ${movedToAlumni} students to Alumni`);
      setTransitionProgress(90);

      // Step 9: Clear current year data (90%)
      addLog('üßπ Step 9: Clearing current year operational data...');
      
      // Clear chapter progress for fresh start
      const batch9 = db.batch();
      progressSnap.docs.forEach(doc => {
        batch9.delete(doc.ref);
      });
      await batch9.commit();
      addLog('‚úÖ Cleared chapter progress for fresh start');
      
      // Clear attendance for new year
      const batch10 = db.batch();
      studentAttSnap.docs.forEach(doc => batch10.delete(doc.ref));
      teacherAttSnap.docs.forEach(doc => batch10.delete(doc.ref));
      await batch10.commit();
      addLog('‚úÖ Cleared attendance records');
      
      // Clear feedback
      const batch11 = db.batch();
      feedbackSnap.docs.forEach(doc => batch11.delete(doc.ref));
      await batch11.commit();
      addLog('‚úÖ Cleared feedback records');
      
      setTransitionProgress(95);

      // Step 10: Update system settings (100%)
      addLog('‚öôÔ∏è Step 10: Updating system settings...');
      await db.collection('system').doc('academicYear').set({
        currentYear: newAcademicYear,
        previousYear: currentAY,
        transitionDate: new Date().toISOString(),
        transitionBy: 'admin@avantifellows.org'
      });
      
      setTransitionProgress(100);
      addLog('üéâ Academic year transition completed successfully!');
      addLog(`üìÖ Current academic year is now: ${newAcademicYear}`);
      
      setTimeout(() => {
        alert(`‚úÖ Academic Year Transition Complete!\n\nFrom: ${currentAY}\nTo: ${newAcademicYear}\n\nSummary:\n‚Ä¢ ${progressCount} curriculum records archived\n‚Ä¢ ${studentAttCount + teacherAttCount} attendance records archived\n‚Ä¢ ${feedbackCount} feedback records archived\n‚Ä¢ ${promoted11to12} students promoted to 12th\n‚Ä¢ ${movedToAlumni} students moved to Alumni\n\nPlease refresh the page.`);
        window.location.reload();
      }, 2000);

    } catch (error) {
      console.error('Transition error:', error);
      addLog(`‚ùå Error: ${error.message}`);
      alert('Transition failed: ' + error.message);
    } finally {
      setIsTransitioning(false);
    }
  };

  return (
    <div className="space-y-6">
      <div className="flex justify-between items-center flex-wrap gap-4">
        <h2 className="text-3xl font-bold">üìÖ Academic Year Management</h2>
      </div>

      {/* Current Status */}
      <div className="bg-white p-6 rounded-2xl shadow-lg">
        <h3 className="text-xl font-bold mb-4">üìä Current Status</h3>
        <div className="grid md:grid-cols-4 gap-4">
          <div className="bg-blue-50 p-4 rounded-xl border-2 border-blue-200">
            <div className="text-3xl font-bold text-blue-600">{currentAY}</div>
            <div className="text-sm text-blue-700">Current Academic Year</div>
          </div>
          <div className="bg-green-50 p-4 rounded-xl border-2 border-green-200">
            <div className="text-3xl font-bold text-green-600">{studentsByGrade['11']}</div>
            <div className="text-sm text-green-700">11th Grade Students</div>
          </div>
          <div className="bg-orange-50 p-4 rounded-xl border-2 border-orange-200">
            <div className="text-3xl font-bold text-orange-600">{studentsByGrade['12']}</div>
            <div className="text-sm text-orange-700">12th Grade Students</div>
          </div>
          <div className="bg-purple-50 p-4 rounded-xl border-2 border-purple-200">
            <div className="text-3xl font-bold text-purple-600">{teachers.length}</div>
            <div className="text-sm text-purple-700">Active Teachers</div>
          </div>
        </div>
      </div>

      {/* Transition Section */}
      <div className="bg-white p-6 rounded-2xl shadow-lg">
        <h3 className="text-xl font-bold mb-4">üîÑ Start New Academic Year</h3>
        
        <div className="bg-yellow-50 border-2 border-yellow-200 rounded-xl p-4 mb-4">
          <div className="font-bold text-yellow-800 mb-2">‚ö†Ô∏è Important: This action will:</div>
          <ul className="text-sm text-yellow-700 space-y-1">
            <li>‚úÖ Archive all curriculum progress, attendance, feedback, and exam data</li>
            <li>‚úÖ Save teacher performance history for the current year</li>
            <li>‚úÖ Promote 11th grade students to 12th grade ({studentsByGrade['11']} students)</li>
            <li>‚úÖ Move 12th grade students to Alumni ({studentsByGrade['12']} students)</li>
            <li>‚úÖ Clear operational data for fresh start</li>
            <li>‚ùå Teachers and their profiles will remain unchanged</li>
          </ul>
        </div>

        <div className="flex items-end gap-4 flex-wrap">
          <div className="flex-1 min-w-64">
            <label className="block text-sm font-bold mb-2">New Academic Year *</label>
            <input 
              type="text"
              value={newAcademicYear}
              onChange={e => setNewAcademicYear(e.target.value)}
              placeholder={getNextAcademicYear()}
              className="w-full border-2 px-4 py-3 rounded-xl text-lg"
              disabled={isTransitioning}
            />
            <p className="text-xs text-gray-500 mt-1">Format: YYYY-YYYY (e.g., {getNextAcademicYear()})</p>
          </div>
          <button 
            onClick={() => setShowConfirmModal(true)}
            disabled={isTransitioning || !newAcademicYear}
            className={`px-8 py-3 rounded-xl font-bold text-white ${
              isTransitioning ? 'bg-gray-400' : 'bg-red-600 hover:bg-red-700'
            }`}
          >
            {isTransitioning ? '‚è≥ Processing...' : 'üöÄ Start Transition'}
          </button>
        </div>
      </div>

      {/* Progress Section */}
      {isTransitioning && (
        <div className="bg-white p-6 rounded-2xl shadow-lg">
          <h3 className="text-xl font-bold mb-4">üìà Transition Progress</h3>
          <div className="mb-4">
            <div className="flex justify-between mb-2">
              <span className="font-semibold">Progress</span>
              <span className="font-bold">{transitionProgress}%</span>
            </div>
            <div className="w-full bg-gray-200 rounded-full h-4">
              <div 
                className="bg-green-500 h-4 rounded-full transition-all duration-500"
                style={{ width: `${transitionProgress}%` }}
              ></div>
            </div>
          </div>
          <div className="bg-gray-900 text-green-400 p-4 rounded-xl font-mono text-sm max-h-64 overflow-y-auto">
            {transitionLog.map((log, i) => (
              <div key={i}>{log}</div>
            ))}
          </div>
        </div>
      )}

      {/* Archive History */}
      <div className="bg-white p-6 rounded-2xl shadow-lg">
        <h3 className="text-xl font-bold mb-4">üìö Archived Academic Years</h3>
        {archivedYears.length === 0 ? (
          <p className="text-gray-500">No archived years yet.</p>
        ) : (
          <div className="flex flex-wrap gap-3">
            {archivedYears.map(year => (
              <div key={year} className="px-4 py-2 bg-gray-100 rounded-xl font-semibold">
                üìÖ {year}
              </div>
            ))}
          </div>
        )}
      </div>

      {/* Confirm Modal */}
      {showConfirmModal && (
        <div className="modal-overlay" onClick={() => setShowConfirmModal(false)}>
          <div className="modal-content max-w-lg" onClick={e => e.stopPropagation()}>
            <h3 className="text-2xl font-bold mb-4 text-red-600">‚ö†Ô∏è Confirm Academic Year Transition</h3>
            <div className="space-y-4">
              <p className="font-semibold">You are about to transition from:</p>
              <div className="text-center text-2xl font-bold">
                {currentAY} ‚Üí {newAcademicYear}
              </div>
              
              <div className="bg-red-50 border border-red-200 rounded-lg p-4 text-sm">
                <div className="font-bold text-red-700 mb-2">This action cannot be undone!</div>
                <ul className="text-red-600 space-y-1">
                  <li>‚Ä¢ All current year data will be archived</li>
                  <li>‚Ä¢ {studentsByGrade['11']} students will be promoted to 12th</li>
                  <li>‚Ä¢ {studentsByGrade['12']} students will become alumni</li>
                  <li>‚Ä¢ Operational data will be cleared</li>
                </ul>
              </div>

              <div className="flex gap-3">
                <button 
                  onClick={startTransition}
                  className="flex-1 bg-red-600 text-white py-3 rounded-xl font-bold hover:bg-red-700"
                >
                  Yes, Start Transition
                </button>
                <button 
                  onClick={() => setShowConfirmModal(false)}
                  className="flex-1 bg-gray-200 py-3 rounded-xl font-bold"
                >
                  Cancel
                </button>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

// ========================================
// TEACHER HISTORY COMPONENT
// ========================================
function TeacherHistoryView({ teachers }) {
  const [selectedTeacher, setSelectedTeacher] = useState(null);
  const [teacherHistory, setTeacherHistory] = useState([]);
  const [loading, setLoading] = useState(false);
  const [searchQuery, setSearchQuery] = useState('');
  const [selectedSchool, setSelectedSchool] = useState('All');

  const filteredTeachers = teachers.filter(t => {
    if (selectedSchool !== 'All' && t.school !== selectedSchool) return false;
    if (searchQuery && !t.name?.toLowerCase().includes(searchQuery.toLowerCase())) return false;
    return true;
  });

  const loadTeacherHistory = async (teacher) => {
    setSelectedTeacher(teacher);
    setLoading(true);
    try {
      const historySnap = await db.collection('teacherHistory')
        .where('afid', '==', teacher.afid)
        .orderBy('academicYear', 'desc')
        .get();
      
      setTeacherHistory(historySnap.docs.map(d => d.data()));
    } catch (e) {
      console.error('Error loading history:', e);
      setTeacherHistory([]);
    }
    setLoading(false);
  };

  return (
    <div className="space-y-6">
      <h2 className="text-3xl font-bold">üìà Teacher Performance History</h2>

      {/* Filters */}
      <div className="bg-white p-6 rounded-2xl shadow-lg">
        <div className="grid md:grid-cols-2 gap-4">
          <div>
            <label className="block text-sm font-bold mb-2">Search Teacher</label>
            <input 
              type="text"
              value={searchQuery}
              onChange={e => setSearchQuery(e.target.value)}
              placeholder="Search by name..."
              className="w-full border-2 px-4 py-3 rounded-xl"
            />
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">School</label>
            <select 
              value={selectedSchool}
              onChange={e => setSelectedSchool(e.target.value)}
              className="w-full border-2 px-4 py-3 rounded-xl"
            >
              <option value="All">All Schools</option>
              {SCHOOLS.map(s => <option key={s} value={s}>{s}</option>)}
            </select>
          </div>
        </div>
      </div>

      <div className="grid md:grid-cols-3 gap-6">
        {/* Teacher List */}
        <div className="bg-white p-6 rounded-2xl shadow-lg">
          <h3 className="text-xl font-bold mb-4">üë• Teachers ({filteredTeachers.length})</h3>
          <div className="space-y-2 max-h-96 overflow-y-auto">
            {filteredTeachers.map(teacher => (
              <div 
                key={teacher.afid}
                onClick={() => loadTeacherHistory(teacher)}
                className={`p-3 rounded-xl cursor-pointer transition ${
                  selectedTeacher?.afid === teacher.afid 
                    ? 'bg-yellow-100 border-2 border-yellow-400' 
                    : 'bg-gray-50 hover:bg-gray-100 border-2 border-transparent'
                }`}
              >
                <div className="font-bold">{teacher.name}</div>
                <div className="text-sm text-gray-600">{teacher.school} ‚Ä¢ {teacher.subject}</div>
              </div>
            ))}
          </div>
        </div>

        {/* History Details */}
        <div className="md:col-span-2 bg-white p-6 rounded-2xl shadow-lg">
          <h3 className="text-xl font-bold mb-4">
            üìä Performance History 
            {selectedTeacher && <span className="text-gray-500 font-normal ml-2">- {selectedTeacher.name}</span>}
          </h3>
          
          {!selectedTeacher ? (
            <div className="text-center py-12 text-gray-500">
              <div className="text-4xl mb-4">üëÜ</div>
              <p>Select a teacher to view their performance history</p>
            </div>
          ) : loading ? (
            <div className="text-center py-12">
              <div className="animate-spin text-4xl">‚è≥</div>
              <p className="mt-4 text-gray-500">Loading history...</p>
            </div>
          ) : teacherHistory.length === 0 ? (
            <div className="text-center py-12 text-gray-500">
              <div className="text-4xl mb-4">üì≠</div>
              <p>No historical data available for this teacher.</p>
              <p className="text-sm mt-2">History will be saved when an academic year transition occurs.</p>
            </div>
          ) : (
            <div className="space-y-4">
              {teacherHistory.map(history => (
                <div key={history.academicYear} className="border-2 border-gray-200 rounded-xl p-4">
                  <div className="flex items-center justify-between mb-4">
                    <div className="text-xl font-bold text-blue-600">üìÖ {history.academicYear}</div>
                    <div className="text-sm text-gray-500">üè´ {history.school} ‚Ä¢ {history.subject}</div>
                  </div>
                  
                  <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div className="bg-green-50 p-3 rounded-lg text-center">
                      <div className="text-2xl font-bold text-green-600">{history.metrics?.completionRate || 0}%</div>
                      <div className="text-xs text-green-700">Curriculum Completion</div>
                    </div>
                    <div className="bg-blue-50 p-3 rounded-lg text-center">
                      <div className="text-2xl font-bold text-blue-600">{history.metrics?.onTimeRate || 0}%</div>
                      <div className="text-xs text-blue-700">On-Time Rate</div>
                    </div>
                    <div className="bg-yellow-50 p-3 rounded-lg text-center">
                      <div className="text-2xl font-bold text-yellow-600">{history.metrics?.avgFeedbackRating || '-'}</div>
                      <div className="text-xs text-yellow-700">Avg Feedback ({history.metrics?.feedbackCount || 0})</div>
                    </div>
                    <div className="bg-purple-50 p-3 rounded-lg text-center">
                      <div className="text-2xl font-bold text-purple-600">{history.metrics?.attendanceRate || 0}%</div>
                      <div className="text-xs text-purple-700">Attendance Rate</div>
                    </div>
                  </div>

                  <div className="mt-4 grid grid-cols-3 gap-4 text-sm">
                    <div>
                      <span className="text-gray-500">Chapters:</span>
                      <span className="font-semibold ml-2">{history.metrics?.completedChapters || 0}/{history.metrics?.totalChapters || 0}</span>
                    </div>
                    <div>
                      <span className="text-gray-500">On-Time:</span>
                      <span className="font-semibold ml-2 text-green-600">{history.metrics?.onTimeChapters || 0}</span>
                    </div>
                    <div>
                      <span className="text-gray-500">Delayed:</span>
                      <span className="font-semibold ml-2 text-red-600">{history.metrics?.delayedChapters || 0}</span>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>
      </div>
    </div>
  );
}

function AdminView({
  currentUser,
  handleLogout,
  teachers,
  students,
  curriculum,
  chapterProgress,
  studentAttendance,
  teacherAttendance,
  schoolInfo,
  addChapter,
  updateChapter,
  deleteChapter,
  leaveAdjustments,
  setLeaveAdjustments,
  managers,
  isSuperAdmin,
  accessibleSchools,
  academicYearSettings
}) {
  const [activeTab, setActiveTab] = useState(isSuperAdmin ? 'managers' : 'analytics');
  const [sidebarCollapsed, setSidebarCollapsed] = useState(false);
  const [isMobileSidebarOpen, setIsMobileSidebarOpen] = useState(false);

  // Filter data based on accessible schools for managers/APMs
  const filteredTeachers = isSuperAdmin ? teachers : teachers.filter(t => accessibleSchools.includes(t.school));
  const filteredStudents = isSuperAdmin ? students : students.filter(s => accessibleSchools.includes(s.school));
  const filteredStudentAttendance = isSuperAdmin ? studentAttendance : studentAttendance.filter(a => accessibleSchools.includes(a.school));
  const filteredTeacherAttendance = isSuperAdmin ? teacherAttendance : teacherAttendance.filter(a => accessibleSchools.includes(a.school));
  const filteredSchoolInfo = isSuperAdmin ? schoolInfo : schoolInfo.filter(s => accessibleSchools.includes(s.school));

  // Get available schools for dropdowns
  const availableSchools = isSuperAdmin ? SCHOOLS : accessibleSchools;

  const adminTabs = [
    ...(isSuperAdmin ? [
      { id: 'managers', label: 'Managers', icon: 'üëî' },
      { id: 'academicyear', label: 'Academic Year', icon: 'üìÖ' },
      { id: '2fa-management', label: '2FA Management', icon: 'üîê' },
      { id: 'settings', label: 'Settings', icon: '‚öôÔ∏è' },
    ] : []),
    { id: 'teachers', label: 'Teachers', icon: 'üë•' },
    { id: 'teacherhistory', label: 'Teacher History', icon: 'üìà' },
    // Students tab - Super Admin has full access, Managers have view-only access
    { id: 'students', label: 'Students', icon: 'üë®‚Äçüéì' },
    { id: 'directory', label: 'Directory', icon: 'üìñ' },
    { id: 'observations', label: 'Class Observations', icon: 'üìã' },
    // Curriculum Management - only for Super Admin (contains add/edit/delete chapters)
    ...(isSuperAdmin ? [
      { id: 'curriculum', label: 'Curriculum', icon: 'üìö' },
    ] : []),
    { id: 'analytics', label: 'Analytics', icon: 'üìä' },
    // Chapter Details - removed for non-Super Admin as requested
    ...(isSuperAdmin ? [
      { id: 'chapter-details', label: 'Chapter Details', icon: 'üìã' },
    ] : []),
    { id: 'attendance', label: 'Attendance Analytics', icon: 'üìä' },
    { id: 'schoolinfo', label: 'School Info', icon: 'üè´' },
    { id: 'birthdays', label: 'Celebrations', icon: 'üéÇ' },
    // Student Profiles - for viewing student demographics with graphs
    { id: 'studentprofiles', label: 'Student Profiles', icon: 'üë®‚Äçüéì' },
    { id: 'examstats', label: 'Exam Statistics', icon: 'üìä' },
    { id: 'studentfeedback', label: 'Student Feedback', icon: 'üí¨' }
  ];
  
  // Handle navigation and auto-close on mobile
  const handleTabClick = (tabId) => {
    setActiveTab(tabId);
    // Close sidebar on mobile after navigation
    if (window.innerWidth < 768) {
      setIsMobileSidebarOpen(false);
    }
  };
  
  // Swipe gesture detection
  useEffect(() => {
    let touchStartX = 0;
    let touchEndX = 0;
    
    const handleTouchStart = (e) => {
      touchStartX = e.changedTouches[0].screenX;
    };
    
    const handleTouchEnd = (e) => {
      touchEndX = e.changedTouches[0].screenX;
      handleSwipe();
    };
    
    const handleSwipe = () => {
      const swipeThreshold = 50;
      if (touchEndX - touchStartX > swipeThreshold && touchStartX < 50) {
        // Swipe right from left edge - open sidebar
        setIsMobileSidebarOpen(true);
      } else if (touchStartX - touchEndX > swipeThreshold) {
        // Swipe left - close sidebar
        setIsMobileSidebarOpen(false);
      }
    };
    
    document.addEventListener('touchstart', handleTouchStart);
    document.addEventListener('touchend', handleTouchEnd);
    
    return () => {
      document.removeEventListener('touchstart', handleTouchStart);
      document.removeEventListener('touchend', handleTouchEnd);
    };
  }, []);

  return (
    <div className="min-h-screen bg-gray-50">
      <InstallPrompt />
      
      {/* Mobile Menu Button */}
      <button
        onClick={() => setIsMobileSidebarOpen(!isMobileSidebarOpen)}
        className="md:hidden fixed top-4 left-4 z-[1000] bg-gradient-to-r from-yellow-400 to-orange-500 text-white p-3 rounded-lg shadow-lg"
      >
        {isMobileSidebarOpen ? '‚úï' : '‚ò∞'}
      </button>
      
      {/* Mobile Sidebar Overlay */}
      <div 
        className={`mobile-sidebar-overlay ${isMobileSidebarOpen ? 'active' : ''}`}
        onClick={() => setIsMobileSidebarOpen(false)}
      />

      {/* Vertical Sidebar */}
      <div className={`sidebar mobile-sidebar ${sidebarCollapsed ? 'collapsed' : 'expanded'} ${isMobileSidebarOpen ? 'active' : ''}`}>
        <div className="sidebar-header">
          <div className="flex items-center gap-3">
            <img src={AVANTI_LOGO} alt="Avanti" className="w-10 h-10" />
            <div className="sidebar-label">
              <h1 className="text-lg font-bold text-white">
                {isSuperAdmin ? 'Super Admin' : ROLE_LABELS[currentUser.role] || 'Admin'}
              </h1>
              <p className="text-xs text-white opacity-75">{currentUser.name}</p>
            </div>
          </div>
          <button
            onClick={() => setSidebarCollapsed(!sidebarCollapsed)}
            className="sidebar-toggle hidden md:block"
          >
            {sidebarCollapsed ? '‚Üí' : '‚Üê'}
          </button>
        </div>

        <div className="sidebar-nav">
          {adminTabs.map((tab) => (
            <div
              key={tab.id}
              onClick={() => handleTabClick(tab.id)}
              className={`sidebar-item ${activeTab === tab.id ? 'active' : ''}`}
            >
              <span className="sidebar-icon">{tab.icon}</span>
              <span className="sidebar-label">{tab.label}</span>
            </div>
          ))}
        </div>

        {!sidebarCollapsed && !isSuperAdmin && (
          <div className="px-4 py-2 border-t border-white border-opacity-20">
            <div className="text-xs text-white opacity-75">
              <span className="font-bold">üè´ Access: {availableSchools.length} Schools</span>
            </div>
          </div>
        )}

        {!sidebarCollapsed && (
          <div className="px-4 py-3 border-t border-white border-opacity-20 mt-auto">
            <button
              onClick={handleLogout}
              className="w-full px-3 py-2 bg-white bg-opacity-20 text-white rounded-lg font-semibold hover:bg-opacity-30 transition"
            >
              Logout
            </button>
          </div>
        )}
      </div>

      {/* Main content */}
      <div className={`main-content ${sidebarCollapsed ? 'sidebar-collapsed' : 'sidebar-expanded'}`}>
        <div className="px-4 py-6">

        {/* Tab Content */}
        {activeTab === 'managers' && isSuperAdmin && (
          <ManagerManagement managers={managers} currentUser={currentUser} isSuperAdmin={isSuperAdmin} />
        )}

        {activeTab === 'academicyear' && isSuperAdmin && (
          <AcademicYearManagement 
            teachers={teachers} 
            students={students} 
            curriculum={curriculum}
            chapterProgress={chapterProgress}
            studentAttendance={studentAttendance}
            teacherAttendance={teacherAttendance}
            academicYearSettings={academicYearSettings}
          />
        )}

        {activeTab === '2fa-management' && isSuperAdmin && (
          <Admin2FAManagement teachers={filteredTeachers} managers={managers} />
        )}

        {activeTab === 'teachers' && <TeacherManagement teachers={filteredTeachers} teacherAttendance={filteredTeacherAttendance} leaveAdjustments={leaveAdjustments} setLeaveAdjustments={setLeaveAdjustments} isSuperAdmin={isSuperAdmin} />}

        {activeTab === 'teacherhistory' && <TeacherHistoryView teachers={filteredTeachers} />}

        {activeTab === 'students' && <StudentManagement students={filteredStudents} isSuperAdmin={isSuperAdmin} accessibleSchools={availableSchools} />}

        {activeTab === 'directory' && (
          <TeacherDirectory teachers={filteredTeachers} currentUser={currentUser} />
        )}

        {activeTab === 'observations' && (
          <AdminClassroomObservations teachers={filteredTeachers} currentUser={currentUser} />
        )}

        {activeTab === 'curriculum' && (
          <AdminCurriculum
            curriculum={curriculum}
            addChapter={addChapter}
            updateChapter={updateChapter}
            deleteChapter={deleteChapter}
          />
        )}

        {activeTab === 'analytics' && (
          <AdminAnalytics
            teachers={filteredTeachers}
            curriculum={curriculum}
            chapterProgress={chapterProgress}
            accessibleSchools={availableSchools}
            isSuperAdmin={isSuperAdmin}
          />
        )}

        {activeTab === 'chapter-details' && (
          <AdminChapterDetails
            curriculum={curriculum}
            chapterProgress={chapterProgress}
            teachers={filteredTeachers}
          />
        )}

        {activeTab === 'attendance' && (
          <AdminAttendanceAnalytics
            students={filteredStudents}
            teachers={filteredTeachers}
            studentAttendance={filteredStudentAttendance}
            teacherAttendance={filteredTeacherAttendance}
            accessibleSchools={availableSchools}
            isSuperAdmin={isSuperAdmin}
          />
        )}

        {activeTab === 'schoolinfo' && (
          <AdminSchoolInfo schoolInfo={filteredSchoolInfo} />
        )}

        {activeTab === 'birthdays' && <AdminBirthdays teachers={filteredTeachers} />}

        {activeTab === 'studentprofiles' && <AdminStudentProfiles accessibleSchools={availableSchools} isSuperAdmin={isSuperAdmin} />}

        {activeTab === 'settings' && isSuperAdmin && <AdminSettings />}

        {activeTab === 'examstats' && <AdminExamStats accessibleSchools={availableSchools} isSuperAdmin={isSuperAdmin} />}
        
        {activeTab === 'studentfeedback' && <StudentFeedbackView accessibleSchools={availableSchools} isSuperAdmin={isSuperAdmin} />}
        </div>
      </div>

      <footer className="bg-gray-800 text-white text-center py-4">
        <p>Made by Anand with ‚ù§Ô∏è</p>
      </footer>
    </div>
  );
}
function TeacherOverview({currentUser,curriculum,chapterProgress,teachers,teacherAttendance,studentAttendance}){const mySchool=currentUser.school;const mySubject=currentUser.subject;const schoolRankings=useMemo(()=>{
  const rankings=SCHOOLS.map(school=>{
    let total=0,completed=0,testsCompleted=0,testsPending=0;
    SUBJECTS.forEach(subject=>{
      ['11','12'].forEach(grade=>{
        const docId=`${school}_${subject}_${grade}`;
        const chapters=curriculum[docId]?.chapters||[];
        chapters.forEach(ch=>{
          total++;
          const progressId=`${school}_${ch.id}`;
          const prog=chapterProgress[progressId]||{};
          // ‚úÖ Count when chapter is completed (not test)
          if(prog.completed==='Yes'){
            completed++;
            // Track tests separately
            if(prog.testConducted==='Yes'){
              testsCompleted++;
            }else{
              testsPending++;
            }
          }
        })
      })
    });
    return{school,total,completed,testsCompleted,testsPending,percentage:total?Math.round((completed/total)*100):0}
  });
  rankings.sort((a,b)=>b.percentage-a.percentage);
  return rankings
},[curriculum,chapterProgress]);                                                                                                  
  const subjectRankings=useMemo(()=>{
  const rankings=SUBJECTS.map(subject=>{
    let total=0,completed=0;
    ['11','12'].forEach(grade=>{
      const docId=`${mySchool}_${subject}_${grade}`;
      const chapters=curriculum[docId]?.chapters||[];
      chapters.forEach(ch=>{
        total++;
        const progressId=`${mySchool}_${ch.id}`;
        const prog=chapterProgress[progressId]||{};
        // ‚úÖ Count when chapter completed
        if(prog.completed==='Yes'){
          completed++
        }
      })
    });
    return{subject,total,completed,percentage:total?Math.round((completed/total)*100):0}
  })
  .filter(rank=>rank.total>0);
  rankings.sort((a,b)=>b.percentage-a.percentage);
  return rankings
},[curriculum,chapterProgress,mySchool]);const mySchoolRank=schoolRankings.findIndex(r=>r.school===mySchool)+1;const laggingSubject=subjectRankings[subjectRankings.length-1];return(<div className="space-y-6"><h2 className="text-3xl font-bold">Dashboard Overview</h2><div className="grid md:grid-cols-4 gap-4"><div className="stat-card avanti-gradient text-white"><div className="text-sm opacity-90">Your School Rank</div><div className="text-5xl font-bold">#{mySchoolRank}</div><div className="text-sm mt-2">Out of {SCHOOLS.length} schools</div></div><div className="stat-card bg-gradient-to-br from-green-500 to-emerald-600 text-white"><div className="text-sm opacity-90">Best Performing School</div><div className="text-2xl font-bold mt-2">{schoolRankings[0]?.school}</div><div className="text-sm mt-2">{schoolRankings[0]?.percentage}% completed</div></div><div className="stat-card bg-gradient-to-br from-orange-500 to-red-600 text-white"><div className="text-sm opacity-90">Lagging Subject (Your School)</div><div className="text-2xl font-bold mt-2">{laggingSubject?.subject}</div><div className="text-sm mt-2">{laggingSubject?.percentage}% completed</div></div></div><div className="bg-white p-6 rounded-2xl shadow-lg"><h3 className="text-2xl font-bold mb-4">üèÜ School Rankings</h3><div className="space-y-3">{schoolRankings.map((rank,index)=><div key={rank.school} className={`ranking-card ${index===0?'ranking-1':index===1?'ranking-2':index===2?'ranking-3':''} ${rank.school===mySchool?'bg-yellow-50':''}`}><div className="flex justify-between items-center"><div className="flex items-center gap-4"><div className="text-2xl font-bold text-gray-400">#{index+1}</div><div><div className="font-bold text-lg">{rank.school} {rank.school===mySchool&&'‚≠ê'}</div><div className="text-sm text-gray-600">{rank.completed} / {rank.total} chapters completed</div></div></div><div className="text-3xl font-bold" style={{color:'var(--avanti-red)'}}>{rank.percentage}%</div></div></div>)}</div></div><div className="bg-white p-6 rounded-2xl shadow-lg"><h3 className="text-2xl font-bold mb-4">üìö Subject Performance in {mySchool}</h3><div className="grid md:grid-cols-2 gap-4">{subjectRankings.map(rank=><div key={rank.subject} className="border-2 rounded-xl p-4"><div className="flex justify-between items-center mb-2"><div className="font-bold text-lg">{rank.subject}</div><div className="text-2xl font-bold" style={{color:'var(--avanti-red)'}}>{rank.percentage}%</div></div><div className="h-2 bg-gray-200 rounded-full"><div className="h-2 avanti-gradient rounded-full" style={{width:`${rank.percentage}%`}}/></div><div className="text-sm text-gray-600 mt-2">{rank.completed} / {rank.total} chapters</div></div>)}</div></div><div className="stat-card bg-gradient-to-br from-purple-500 to-pink-600 text-white">
  <div className="text-sm opacity-90">My Attendance (This Month)</div>
  <div className="text-2xl font-bold mt-2">
    {teacherAttendance.filter(a=>a.teacherId===currentUser.afid&&getMonthYear(a.date)===getMonthYear(getTodayDate())).length} days
  </div>
  <div className="text-sm mt-2">Marked this month</div>
  <div className="bg-white p-6 rounded-2xl shadow-lg">
  <h3 className="text-2xl font-bold mb-4">üìä Quick Attendance Overview</h3>
  <div className="grid md:grid-cols-2 gap-4">
    <div className="border-2 rounded-xl p-4">
      <h4 className="font-bold mb-2">Today's Student Attendance</h4>
      <p className="text-sm text-gray-600">
        Present: <strong className="text-green-600">
          {studentAttendance.filter(a=>a.date===getTodayDate()&&a.school===currentUser.school&&a.status==='Present').length}
        </strong>
      </p>
      <p className="text-sm text-gray-600">
        Absent: <strong className="text-red-600">
          {studentAttendance.filter(a=>a.date===getTodayDate()&&a.school===currentUser.school&&a.status==='Absent').length}
        </strong>
      </p>
    </div>
    <div className="border-2 rounded-xl p-4">
      <h4 className="font-bold mb-2">My Attendance Status</h4>
      {teacherAttendance.find(a=>a.teacherId===currentUser.afid&&a.date===getTodayDate())?
        <div className="text-sm">
          <p className="text-green-600 font-bold">‚úì Marked for today</p>
          <p className="text-gray-600">
            Status: {teacherAttendance.find(a=>a.teacherId===currentUser.afid&&a.date===getTodayDate()).status}
          </p>
        </div>
      :
        <p className="text-orange-600 font-bold">‚ö†Ô∏è Not marked yet</p>
      }
    </div>
  </div>
</div>
  <div className="bg-white p-6 rounded-2xl shadow-lg">
  <h3 className="text-2xl font-bold mb-4">‚è∞ Today's Punch-In Times - {mySchool}</h3>
  <div className="space-y-2 max-h-96 overflow-y-auto">
    {teachers
      .filter(t=>t.school===mySchool && !t.isArchived)
      .map(teacher=>{
        const todayAttendance=teacherAttendance.find(
          a=>a.teacherId===teacher.afid&&a.date===getTodayDate()
        );
        return(
          <div key={teacher.afid} className={`p-4 rounded-xl border-2 ${
            teacher.afid===currentUser.afid?'bg-yellow-50 border-yellow-400':'bg-gray-50 border-gray-200'
          }`}>
            <div className="flex justify-between items-center">
              <div className="flex-1">
                <div className="font-bold text-lg">
                  {teacher.name} {teacher.afid===currentUser.afid&&'(You)'}
                </div>
                <div className="text-sm text-gray-600">{teacher.subject}</div>
              </div>
              <div className="text-right">
                {todayAttendance?(
                  <>
                    <div className={`text-2xl font-bold ${
                      todayAttendance.status==='Present'?'text-green-600':'text-orange-600'
                    }`}>
                      ‚è∞ {todayAttendance.punchInTime||'--:--'}
                    </div>
                    <div className={`text-xs font-semibold ${
                      todayAttendance.status==='Present'?'text-green-600':'text-orange-600'
                    }`}>
                      {todayAttendance.status}
                    </div>
                  </>
                ):(
                  <div className="text-gray-400 font-semibold">Not Marked</div>
                )}
              </div>
            </div>
          </div>
        );
      })
    }
  </div>
</div>
</div></div>)}
// ========================================
// CLASS VIEW COMPONENT (for Class 11 & 12 tabs)
// ========================================
function ClassView({grade, currentUser, curriculum, chapterProgress, updateChapterProgress}) {
  const [expandedChapters, setExpandedChapters] = useState({});
  const [currentDate] = useState(new Date().toISOString().split('T')[0]);

  /// Filter curriculum for the specific grade and teacher's subject
  const gradeCurriculum = useMemo(() => {
    const filtered = {};
    Object.keys(curriculum).forEach(subject => {
      if (currentUser.subject === 'All' || subject === currentUser.subject) {
        const chapters = (curriculum[subject] || []).filter(
          ch => String(ch.grade) === String(grade) || ch.grade === `Class ${grade}`
        );
        if (chapters.length > 0) {
          filtered[subject] = chapters;
        }
      }
    });
    return filtered;
  }, [curriculum, grade, currentUser.subject]);

  // Get progress for specific chapter
  const getChapterProgress = (chapterId) => {
    return chapterProgress[currentUser.school]?.[chapterId] || {};
  };

  // Toggle chapter expansion
  const toggleChapter = (chapterId) => {
    setExpandedChapters(prev => ({
      ...prev,
      [chapterId]: !prev[chapterId]
    }));
  };

  // Calculate status based on dates
  const getChapterStatus = (chapter) => {
    const progress = getChapterProgress(chapter.id);
    if (progress.completed) return 'completed';
    
    const today = new Date(currentDate);
    const plannedEnd = new Date(chapter.plannedEndDate);
    
    if (today > plannedEnd) return 'delayed';
    return 'pending';
  };

  // Count chapters by status
  const getStatusCounts = () => {
    let completed = 0, delayed = 0, pending = 0;
    Object.values(gradeCurriculum).forEach(chapters => {
      chapters.forEach(chapter => {
        const status = getChapterStatus(chapter);
        if (status === 'completed') completed++;
        else if (status === 'delayed') delayed++;
        else pending++;
      });
    });
    return { completed, delayed, pending };
  };

  const statusCounts = getStatusCounts();
  const totalChapters = statusCounts.completed + statusCounts.delayed + statusCounts.pending;

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex justify-between items-center">
        <h2 className="text-3xl font-bold">üìö Class {grade} Curriculum</h2>
        <div className="text-sm text-gray-600">
          Subject: <span className="font-bold">{currentUser.subject}</span>
        </div>
      </div>

      {/* Summary Cards */}
      <div className="grid md:grid-cols-4 gap-4">
        <div className="stat-card bg-blue-500 text-white">
          <div className="text-sm opacity-90">Total Chapters</div>
          <div className="text-4xl font-bold">{totalChapters}</div>
        </div>
        <div className="stat-card bg-green-500 text-white">
          <div className="text-sm opacity-90">‚úì Completed</div>
          <div className="text-4xl font-bold">{statusCounts.completed}</div>
        </div>
        <div className="stat-card bg-orange-500 text-white">
          <div className="text-sm opacity-90">‚ö† Delayed</div>
          <div className="text-4xl font-bold">{statusCounts.delayed}</div>
        </div>
        <div className="stat-card bg-red-500 text-white">
          <div className="text-sm opacity-90">‚è≥ Pending</div>
          <div className="text-4xl font-bold">{statusCounts.pending}</div>
        </div>
      </div>

      {/* Chapters by Subject */}
      {Object.keys(gradeCurriculum).length === 0 ? (
        <div className="bg-white p-12 rounded-2xl shadow-lg text-center">
          <div className="text-6xl mb-4">üì≠</div>
          <p className="text-xl text-gray-600">No chapters found for Class {grade}</p>
        </div>
      ) : (
        Object.keys(gradeCurriculum).map(subject => {
          const chapters = gradeCurriculum[subject];
          if (chapters.length === 0) return null;

          return (
            <div key={subject} className="bg-white p-6 rounded-2xl shadow-lg">
              <h3 className="text-2xl font-bold mb-4 text-blue-600">
                {subject} ({chapters.length} chapters)
              </h3>
              
              <div className="space-y-4">
                {chapters.map(chapter => {
                  const progress = getChapterProgress(chapter.id);
                  const status = getChapterStatus(chapter);
                  const isExpanded = expandedChapters[chapter.id];

                  return (
                    <div
                      key={chapter.id}
                      className={`chapter-card ${status} border-2 rounded-xl p-4`}
                    >
                      {/* Chapter Header */}
                      <div 
                        className="flex justify-between items-start cursor-pointer gap-3"
                        onClick={() => toggleChapter(chapter.id)}
                      >
                        <div className="flex-1 min-w-0">
                          <div className="flex flex-wrap items-center gap-3 mb-2">
                            <h4 className="text-lg font-bold break-words">{chapter.name}</h4>
                            <span className={`status-badge status-${status} flex-shrink-0`}>
                              {status === 'completed' ? '‚úì Done' : 
                               status === 'delayed' ? '‚ö† Delayed' : '‚è≥ Pending'}
                            </span>
                          </div>
                          <div className="text-sm text-gray-600 space-y-1">
                            <div><strong>Duration:</strong> {chapter.duration} days</div>
                            <div><strong>Planned:</strong> {chapter.plannedStartDate} ‚Üí {chapter.plannedEndDate}</div>
                            {progress.actualStartDate && (
                              <div><strong>Actual Start:</strong> {progress.actualStartDate}</div>
                            )}
                            {progress.completed && progress.actualEndDate && (
                              <div><strong>Actual End:</strong> {progress.actualEndDate}</div>
                            )}
                          </div>
                        </div>
                        <button className="text-2xl flex-shrink-0">
                          {isExpanded ? '‚ñ≤' : '‚ñº'}
                        </button>
                      </div>

                      {/* Expanded Details */}
                      {isExpanded && (
                        <div className="mt-4 pt-4 border-t-2 chapter-details">
                          <div className="grid md:grid-cols-2 gap-4 mb-4">
                            {/* Actual Start Date */}
                            <div>
                              <label className="block text-sm font-semibold mb-2">
                                Actual Start Date
                              </label>
                              <input
                                type="date"
                                value={progress.actualStartDate || ''}
                                onChange={(e) => {
                                  updateChapterProgress(chapter.id, {
                                    ...progress,
                                    actualStartDate: e.target.value
                                  });
                                }}
                                className="w-full px-3 py-2 border-2 rounded-lg"
                              />
                            </div>

                            {/* Actual End Date */}
                            <div>
                              <label className="block text-sm font-semibold mb-2">
                                Actual End Date
                              </label>
                              <input
                                type="date"
                                value={progress.actualEndDate || ''}
                                onChange={(e) => {
                                  updateChapterProgress(chapter.id, {
                                    ...progress,
                                    actualEndDate: e.target.value
                                  });
                                }}
                                className="w-full px-3 py-2 border-2 rounded-lg"
                              />
                            </div>
                          </div>

                          {/* Completion Checkbox */}
                          <label className="flex items-center gap-3 p-3 bg-gray-50 rounded-lg cursor-pointer">
                            <input
                              type="checkbox"
                              checked={progress.completed || false}
                              onChange={(e) => {
                                updateChapterProgress(chapter.id, {
                                  ...progress,
                                  completed: e.target.checked,
                                  actualEndDate: e.target.checked && !progress.actualEndDate 
                                    ? currentDate 
                                    : progress.actualEndDate
                                });
                              }}
                            />
                            <span className="font-semibold">Mark as Completed</span>
                          </label>

                          {/* Notes */}
                          <div className="mt-4">
                            <label className="block text-sm font-semibold mb-2">
                              Notes / Remarks
                            </label>
                            <textarea
                              value={progress.notes || ''}
                              onChange={(e) => {
                                updateChapterProgress(chapter.id, {
                                  ...progress,
                                  notes: e.target.value
                                });
                              }}
                              className="w-full px-3 py-2 border-2 rounded-lg"
                              rows="3"
                              placeholder="Add any notes about this chapter..."
                            />
                          </div>
                        </div>
                      )}
                    </div>
                  );
                })}
              </div>
            </div>
          );
        })
      )}
    </div>
  );
}    
function TeacherAnalytics({currentUser,curriculum,chapterProgress}){
  const chart1Ref=useRef(null);
  const chart2Ref=useRef(null);
  const chart3Ref=useRef(null);
  const chart4Ref=useRef(null);
  const chart5Ref=useRef(null);
  
  const chartInstances=useRef({});
  
  const mySchool=currentUser.school;
  const mySubject=currentUser.subject;
  
  // My school data
  const myData=useMemo(()=>{
    const data={
      11:{total:0,completed:0,testsCompleted:0,testsPending:0},
      12:{total:0,completed:0,testsCompleted:0,testsPending:0}
    };
    let totalDays=0;
    let chaptersWithDates=0;
    
    ['11','12'].forEach(grade=>{
      const docId=`${mySchool}_${mySubject}_${grade}`;
      const chapters=curriculum[docId]?.chapters||[];
      chapters.forEach(ch=>{
        data[grade].total++;
        const progressId=`${mySchool}_${ch.id}`;
        const prog=chapterProgress[progressId]||{};
        
        if(prog.completed==='Yes'){
          data[grade].completed++;
          
          if(prog.testConducted==='Yes'){
            data[grade].testsCompleted++;
          }else{
            data[grade].testsPending++;
          }
          
          if(prog.completionDate&&ch.targetDate){
            const target=new Date(ch.targetDate);
            const completion=new Date(prog.completionDate);
            const days=Math.abs(Math.ceil((completion-target)/(1000*60*60*24)));
            totalDays+=days;
            chaptersWithDates++;
          }
        }
      })
    });
    
    const avgDays=chaptersWithDates?Math.round(totalDays/chaptersWithDates):0;
    return{...data,avgDays};
  },[curriculum,chapterProgress,mySchool,mySubject]);

  // All schools comparison data
  const allSchoolsData=useMemo(()=>{
    const data={};
    SCHOOLS.forEach(school=>{
      data[school]={
        11:{total:0,completed:0,testsCompleted:0},
        12:{total:0,completed:0,testsCompleted:0}
      };
      
      ['11','12'].forEach(grade=>{
        const docId=`${school}_${mySubject}_${grade}`;
        const chapters=curriculum[docId]?.chapters||[];
        chapters.forEach(ch=>{
          data[school][grade].total++;
          const progressId=`${school}_${ch.id}`;
          const prog=chapterProgress[progressId]||{};
          if(prog.completed==='Yes'){
            data[school][grade].completed++;
            if(prog.testConducted==='Yes'){
              data[school][grade].testsCompleted++;
            }
          }
        })
      });
    });
    return data;
  },[curriculum,chapterProgress,mySubject]);

  useEffect(()=>{
    Object.values(chartInstances.current).forEach(c=>c&&c.destroy());
    chartInstances.current={};

    // Chart 1: My Chapter Progress (11th & 12th)
    if(chart1Ref.current){
      const ctx=chart1Ref.current.getContext('2d');
      chartInstances.current.chart1=new Chart(ctx,{
        type:'bar',
        data:{
          labels:['Class 11','Class 12'],
          datasets:[{
            label:'Completed',
            data:[myData[11].completed,myData[12].completed],
            backgroundColor:'#10B981'
          },{
            label:'Pending',
            data:[
              myData[11].total-myData[11].completed,
              myData[12].total-myData[12].completed
            ],
            backgroundColor:'#F59E0B'
          }]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            title:{display:true,text:'My Chapter Progress',font:{size:16,weight:'bold'}},
            legend:{position:'bottom'}
          },
          scales:{x:{stacked:true},y:{stacked:true,beginAtZero:true}}
        }
      });
    }

    // Chart 2: My Tests Status (11th & 12th)
    if(chart2Ref.current){
      const ctx=chart2Ref.current.getContext('2d');
      chartInstances.current.chart2=new Chart(ctx,{
        type:'bar',
        data:{
          labels:['Class 11','Class 12'],
          datasets:[{
            label:'Tests Completed',
            data:[myData[11].testsCompleted,myData[12].testsCompleted],
            backgroundColor:'#3B82F6'
          },{
            label:'Tests Pending',
            data:[myData[11].testsPending,myData[12].testsPending],
            backgroundColor:'#EF4444'
          }]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            title:{display:true,text:'My Tests Status',font:{size:16,weight:'bold'}},
            legend:{position:'bottom'}
          },
          scales:{y:{beginAtZero:true}}
        }
      });
    }

    // Chart 3: Class 11 - School Comparison
    if(chart3Ref.current){
      const ctx=chart3Ref.current.getContext('2d');
      chartInstances.current.chart3=new Chart(ctx,{
        type:'bar',
        data:{
          labels:SCHOOLS,
          datasets:[{
            label:'Chapters Completed',
            data:SCHOOLS.map(s=>allSchoolsData[s][11].completed),
            backgroundColor:SCHOOLS.map(s=>s===mySchool?'#C8342E':'#10B981'),
            borderWidth:SCHOOLS.map(s=>s===mySchool?3:0),
            borderColor:'#000'
          }]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            title:{display:true,text:`Class 11 ${mySubject} - School Comparison`,font:{size:16,weight:'bold'}},
            legend:{display:false}
          },
          scales:{y:{beginAtZero:true}}
        }
      });
    }

    // Chart 4: Class 12 - School Comparison
    if(chart4Ref.current){
      const ctx=chart4Ref.current.getContext('2d');
      chartInstances.current.chart4=new Chart(ctx,{
        type:'bar',
        data:{
          labels:SCHOOLS,
          datasets:[{
            label:'Chapters Completed',
            data:SCHOOLS.map(s=>allSchoolsData[s][12].completed),
            backgroundColor:SCHOOLS.map(s=>s===mySchool?'#C8342E':'#10B981'),
            borderWidth:SCHOOLS.map(s=>s===mySchool?3:0),
            borderColor:'#000'
          }]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            title:{display:true,text:`Class 12 ${mySubject} - School Comparison`,font:{size:16,weight:'bold'}},
            legend:{display:false}
          },
          scales:{y:{beginAtZero:true}}
        }
      });
    }

    // Chart 5: Tests Comparison - All Schools
    if(chart5Ref.current){
      const ctx=chart5Ref.current.getContext('2d');
      chartInstances.current.chart5=new Chart(ctx,{
        type:'bar',
        data:{
          labels:SCHOOLS,
          datasets:[
            {
              label:'Class 11 Tests',
              data:SCHOOLS.map(s=>allSchoolsData[s][11].testsCompleted),
              backgroundColor:'#3B82F6'
            },
            {
              label:'Class 12 Tests',
              data:SCHOOLS.map(s=>allSchoolsData[s][12].testsCompleted),
              backgroundColor:'#8B5CF6'
            }
          ]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            title:{display:true,text:`${mySubject} Tests Completed - School Comparison`,font:{size:16,weight:'bold'}},
            legend:{position:'bottom'}
          },
          scales:{y:{beginAtZero:true}}
        }
      });
    }

    return()=>{
      Object.values(chartInstances.current).forEach(c=>c&&c.destroy());
    };
  },[myData,allSchoolsData,mySchool,mySubject]);

  const handleExport=()=>{
    const exportData=[
      {
        Grade:'Class 11',
        'Total Chapters':myData[11].total,
        'Completed':myData[11].completed,
        'Tests Completed':myData[11].testsCompleted,
        'Tests Pending':myData[11].testsPending,
        'Completion %':myData[11].total?Math.round((myData[11].completed/myData[11].total)*100):0
      },
      {
        Grade:'Class 12',
        'Total Chapters':myData[12].total,
        'Completed':myData[12].completed,
        'Tests Completed':myData[12].testsCompleted,
        'Tests Pending':myData[12].testsPending,
        'Completion %':myData[12].total?Math.round((myData[12].completed/myData[12].total)*100):0
      }
    ];
    exportToExcel(exportData,`${mySubject}_analytics_${mySchool}`);
  };

  return(
    <div className="space-y-6">
      <div className="flex justify-between items-center">
        <h2 className="text-3xl font-bold">My Analytics - {mySubject}</h2>
        <button onClick={handleExport} className="px-6 py-3 bg-green-600 text-white rounded-xl font-semibold">
          üìä Export to Excel
        </button>
      </div>

      <div className="grid grid-cols-2 md:grid-cols-5 gap-4">
        <div className="stat-card">
          <div className="text-sm text-gray-600">Avg Days per Chapter</div>
          <div className="text-4xl font-bold">{myData.avgDays}</div>
        </div>
        <div className="stat-card bg-green-500 text-white">
          <div className="text-sm opacity-90">Class 11 Completed</div>
          <div className="text-4xl font-bold">{myData[11].completed}/{myData[11].total}</div>
          <div className="text-sm opacity-90">
            {myData[11].total?Math.round((myData[11].completed/myData[11].total)*100):0}%
          </div>
        </div>
        <div className="stat-card bg-green-500 text-white">
          <div className="text-sm opacity-90">Class 12 Completed</div>
          <div className="text-4xl font-bold">{myData[12].completed}/{myData[12].total}</div>
          <div className="text-sm opacity-90">
            {myData[12].total?Math.round((myData[12].completed/myData[12].total)*100):0}%
          </div>
        </div>
        <div className="stat-card bg-blue-500 text-white">
          <div className="text-sm opacity-90">Tests Completed</div>
          <div className="text-4xl font-bold">
            {myData[11].testsCompleted+myData[12].testsCompleted}
          </div>
        </div>
        <div className="stat-card bg-red-500 text-white">
          <div className="text-sm opacity-90">Tests Pending</div>
          <div className="text-4xl font-bold">
            {myData[11].testsPending+myData[12].testsPending}
          </div>
        </div>
      </div>

      <div className="grid md:grid-cols-2 gap-6">
        <div className="bg-white p-6 rounded-2xl shadow-lg" style={{height:'400px'}}>
          <canvas ref={chart1Ref}></canvas>
        </div>
        <div className="bg-white p-6 rounded-2xl shadow-lg" style={{height:'400px'}}>
          <canvas ref={chart2Ref}></canvas>
        </div>
      </div>

      <div className="bg-white p-6 rounded-2xl shadow-lg" style={{height:'400px'}}>
        <canvas ref={chart5Ref}></canvas>
      </div>

      <div className="grid md:grid-cols-2 gap-6">
        <div className="bg-white p-6 rounded-2xl shadow-lg" style={{height:'400px'}}>
          <canvas ref={chart3Ref}></canvas>
        </div>
        <div className="bg-white p-6 rounded-2xl shadow-lg" style={{height:'400px'}}>
          <canvas ref={chart4Ref}></canvas>
        </div>
      </div>
    </div>
  );
}

// ========================================
// STUDENT CURRICULUM WITH PRIORITY FILTER
// ========================================
function StudentCurriculumWithPriority({mySchool, myGrade, curriculum, chapterProgress}) {
  const [priorityFilter, setPriorityFilter] = useState('all');
  const [selectedSubject, setSelectedSubject] = useState('All');

  // Get all chapters with their subjects for filtering
  const getAllChaptersWithSubject = () => {
    let allChapters = [];
    SUBJECTS.forEach(subject => {
      const docId = `${mySchool}_${subject}_${myGrade}`;
      const chapters = curriculum[docId]?.chapters || [];
      chapters.forEach(chapter => {
        const progressId = `${mySchool}_${chapter.id}`;
        const prog = chapterProgress[progressId] || {};
        const status = getChapterStatus(chapter, prog);
        allChapters.push({
          ...chapter,
          subject,
          prog,
          status
        });
      });
    });
    return allChapters;
  };

  const allChapters = getAllChaptersWithSubject();

  // Count chapters by priority
  const priorityCounts = {
    all: allChapters.length,
    high: allChapters.filter(ch => ch.priority === 'high' || !ch.priority).length,
    medium: allChapters.filter(ch => ch.priority === 'medium').length,
    low: allChapters.filter(ch => ch.priority === 'low').length
  };

  return (
    <div className="space-y-6">
      <h2 className="text-3xl font-bold">üìö My Curriculum - Class {myGrade}</h2>
      
      {/* Priority Filter Section */}
      <div className="bg-white p-4 rounded-2xl shadow-lg">
        <div className="flex flex-wrap items-center gap-3">
          <span className="font-bold text-gray-700">üéØ Filter by Priority:</span>
          <div className="flex flex-wrap gap-2">
            <button
              onClick={() => setPriorityFilter('all')}
              className={`px-4 py-2 rounded-xl font-semibold transition-all ${
                priorityFilter === 'all' 
                  ? 'bg-gray-800 text-white shadow-lg' 
                  : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
              }`}
            >
              üìã All ({priorityCounts.all})
            </button>
            <button
              onClick={() => setPriorityFilter('high')}
              className={`px-4 py-2 rounded-xl font-semibold transition-all ${
                priorityFilter === 'high' 
                  ? 'bg-gradient-to-r from-green-500 to-emerald-500 text-white shadow-lg' 
                  : 'bg-green-50 text-green-700 hover:bg-green-100 border border-green-200'
              }`}
            >
              üü¢ High ({priorityCounts.high})
            </button>
            <button
              onClick={() => setPriorityFilter('medium')}
              className={`px-4 py-2 rounded-xl font-semibold transition-all ${
                priorityFilter === 'medium' 
                  ? 'bg-gradient-to-r from-yellow-500 to-amber-500 text-white shadow-lg' 
                  : 'bg-yellow-50 text-yellow-700 hover:bg-yellow-100 border border-yellow-200'
              }`}
            >
              üü° Medium ({priorityCounts.medium})
            </button>
            <button
              onClick={() => setPriorityFilter('low')}
              className={`px-4 py-2 rounded-xl font-semibold transition-all ${
                priorityFilter === 'low' 
                  ? 'bg-gradient-to-r from-red-500 to-rose-500 text-white shadow-lg' 
                  : 'bg-red-50 text-red-700 hover:bg-red-100 border border-red-200'
              }`}
            >
              üî¥ Low ({priorityCounts.low})
            </button>
          </div>
        </div>
        
        {/* Subject Filter */}
        <div className="flex flex-wrap items-center gap-3 mt-3 pt-3 border-t">
          <span className="font-bold text-gray-700">üìö Subject:</span>
          <select
            value={selectedSubject}
            onChange={(e) => setSelectedSubject(e.target.value)}
            className="border-2 px-4 py-2 rounded-xl font-semibold"
          >
            <option value="All">All Subjects</option>
            {SUBJECTS.map(s => <option key={s} value={s}>{s}</option>)}
          </select>
        </div>
      </div>

      {/* Chapters Display */}
      {SUBJECTS.filter(subject => selectedSubject === 'All' || subject === selectedSubject).map(subject => {
        const docId = `${mySchool}_${subject}_${myGrade}`;
        let chapters = curriculum[docId]?.chapters || [];
        
        // Apply priority filter
        if (priorityFilter !== 'all') {
          chapters = chapters.filter(chapter => {
            const chPriority = chapter.priority || 'high'; // default to high if not set
            return chPriority === priorityFilter;
          });
        }
        
        // Don't show subject section if no chapters match filter
        if (chapters.length === 0 && priorityFilter !== 'all') return null;
        
        return (
          <div key={subject} className="bg-white p-6 rounded-2xl shadow-lg">
            <h3 className="text-2xl font-bold mb-4">{subject}</h3>
            {chapters.length === 0 ? (
              <p className="text-gray-500">
                {priorityFilter !== 'all' 
                  ? `No ${priorityFilter} priority chapters` 
                  : 'No chapters available'}
              </p>
            ) : (
              <div className="space-y-3">
                {chapters.map(chapter => {
                  const progressId = `${mySchool}_${chapter.id}`;
                  const prog = chapterProgress[progressId] || {};
                  const status = getChapterStatus(chapter, prog);
                  const chPriority = chapter.priority || 'high';
                  
                  return (
                    <div key={chapter.id} className="border-2 rounded-xl p-4 hover:shadow-md transition-all">
                      <div className="flex justify-between items-start">
                        <div className="flex-1">
                          <div className="flex items-center gap-3 flex-wrap">
                            <h4 className="font-bold text-lg">{chapter.name}</h4>
                            {/* Priority Badge */}
                            {chPriority === 'high' && (
                              <span className="priority-badge priority-high text-xs">üü¢ High Priority</span>
                            )}
                            {chPriority === 'medium' && (
                              <span className="priority-badge priority-medium text-xs">üü° Medium Priority</span>
                            )}
                            {chPriority === 'low' && (
                              <span className="priority-badge priority-low text-xs">üî¥ Low Priority</span>
                            )}
                          </div>
                          <div className="text-sm text-gray-600 mt-2">
                            üìÖ Target: {chapter.targetDate || 'Not set'}
                          </div>
                          {/* Show topics count if available */}
                          {chapter.topics && chapter.topics.length > 0 && (
                            <div className="text-sm text-gray-500 mt-1">
                              üìù {chapter.topics.length} topic{chapter.topics.length > 1 ? 's' : ''}
                            </div>
                          )}
                        </div>
                        <div className={`status-badge ${status.class}`}>
                          {status.label}
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>
            )}
          </div>
        );
      })}
    </div>
  );
}

function TeacherCurriculum({grade,currentUser,curriculum,chapterProgress,updateChapterProgress}){
  const[expandedChapters,setExpandedChapters]=useState({});
  const[priorityFilter,setPriorityFilter]=useState('all');
  const mySchool=currentUser.school;
  const mySubject=currentUser.subject;
  const docId=`${mySchool}_${mySubject}_${grade}`;
  const allChapters=curriculum[docId]?.chapters||[];
  
  // Filter chapters by priority
  const chapters = priorityFilter === 'all' 
    ? allChapters 
    : allChapters.filter(ch => {
        const chPriority = ch.priority || 'high'; // default to high if not set
        return chPriority === priorityFilter;
      });

  // Count chapters by priority
  const priorityCounts = {
    all: allChapters.length,
    high: allChapters.filter(ch => ch.priority === 'high' || !ch.priority).length,
    medium: allChapters.filter(ch => ch.priority === 'medium').length,
    low: allChapters.filter(ch => ch.priority === 'low').length
  };

  const handleCompletedChange=(chapterId,value)=>{
  updateChapterProgress(mySchool,chapterId,'completed',value);
};

  return(
    <div className="space-y-6">
      <h2 className="text-3xl font-bold">Class {grade} - {mySubject}</h2>
      
      {/* Priority Filter for Teachers */}
      <div className="bg-white p-4 rounded-2xl shadow-lg">
        <div className="flex flex-wrap items-center gap-3">
          <span className="font-bold text-gray-700">üéØ Filter by Priority:</span>
          <div className="flex flex-wrap gap-2">
            <button
              onClick={() => setPriorityFilter('all')}
              className={`px-4 py-2 rounded-xl font-semibold transition-all ${
                priorityFilter === 'all' 
                  ? 'bg-gray-800 text-white shadow-lg' 
                  : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
              }`}
            >
              üìã All ({priorityCounts.all})
            </button>
            <button
              onClick={() => setPriorityFilter('high')}
              className={`px-4 py-2 rounded-xl font-semibold transition-all ${
                priorityFilter === 'high' 
                  ? 'bg-gradient-to-r from-green-500 to-emerald-500 text-white shadow-lg' 
                  : 'bg-green-50 text-green-700 hover:bg-green-100 border border-green-200'
              }`}
            >
              üü¢ High ({priorityCounts.high})
            </button>
            <button
              onClick={() => setPriorityFilter('medium')}
              className={`px-4 py-2 rounded-xl font-semibold transition-all ${
                priorityFilter === 'medium' 
                  ? 'bg-gradient-to-r from-yellow-500 to-amber-500 text-white shadow-lg' 
                  : 'bg-yellow-50 text-yellow-700 hover:bg-yellow-100 border border-yellow-200'
              }`}
            >
              üü° Medium ({priorityCounts.medium})
            </button>
            <button
              onClick={() => setPriorityFilter('low')}
              className={`px-4 py-2 rounded-xl font-semibold transition-all ${
                priorityFilter === 'low' 
                  ? 'bg-gradient-to-r from-red-500 to-rose-500 text-white shadow-lg' 
                  : 'bg-red-50 text-red-700 hover:bg-red-100 border border-red-200'
              }`}
            >
              üî¥ Low ({priorityCounts.low})
            </button>
          </div>
        </div>
      </div>
      
      {chapters.length===0?
        <div className="bg-white p-8 rounded-2xl text-center">
          <p className="text-gray-600">
            {priorityFilter !== 'all' 
              ? `No ${priorityFilter} priority chapters available.` 
              : 'No chapters available. Contact admin.'}
          </p>
        </div>
      :
        <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
          {chapters.map(chapter=>{
            const progressId=`${mySchool}_${chapter.id}`;
            const prog=chapterProgress[progressId]||{};
            const completedTopics=prog.completedTopics||[];
            const allTopics=chapter.topics||[];
            const progress=allTopics.length?Math.round((completedTopics.length/allTopics.length)*100):0;
            const isExpanded=expandedChapters[chapter.id];
            const status=getChapterStatus(chapter,prog);

            return(
              <div className={`chapter-card ${status.color} rounded-2xl shadow-lg p-5`}>
  <div className="flex justify-between items-start mb-3 gap-3">
    <div className="flex-1 min-w-0">
      <h3 className="text-xl font-bold mb-2 break-words">{chapter.name}</h3>
      <div>
        {(chapter.priority==='high'||!chapter.priority)&&(
          <span className="priority-badge priority-high text-xs">
            üü¢ High Priority
          </span>
        )}
        {chapter.priority==='medium'&&(
          <span className="priority-badge priority-medium text-xs">
            üü° Medium Priority
          </span>
        )}
        {chapter.priority==='low'&&(
          <span className="priority-badge priority-low text-xs">
            üî¥ Low Priority
          </span>
        )}
      </div>
    </div>
    <button 
      onClick={(e)=>{
        e.preventDefault();
        e.stopPropagation();
        setExpandedChapters(prev=>({...prev,[chapter.id]:!prev[chapter.id]}));
      }} 
      className="text-sm px-3 py-1 bg-white rounded-lg font-semibold flex-shrink-0"
    >
      {isExpanded?'‚ñ≤':'‚ñº'}
    </button>
  </div>

                <div className={`status-badge ${status.class} mb-3`}>{status.label}</div>

                <div className="space-y-3">
                  <div>
                    <div className="flex justify-between text-sm mb-1">
                      <span className="font-semibold">Topics</span>
                      <span className="font-bold">{completedTopics.length}/{allTopics.length}</span>
                    </div>
                    <div className="h-2 bg-gray-200 rounded-full">
                      <div className="h-2 avanti-gradient rounded-full transition-all" style={{width:`${progress}%`}}/>
                    </div>
                  </div>

                  {isExpanded&&(
                    <>
                      <div className="space-y-2 max-h-40 overflow-y-auto bg-white p-2 rounded-lg">
                        {allTopics.map((topic,idx)=>{
                          // Support both old string format and new object format
                          const topicName = typeof topic === 'string' ? topic : topic.name;
                          const topicPriority = typeof topic === 'string' ? 'medium' : (topic.priority || 'medium');
                          const topicKey = typeof topic === 'string' ? topic : topic.name;
                          const checked = completedTopics.includes(topicKey) || completedTopics.includes(topic);
                          const priorityIcon = topicPriority === 'high' ? 'üü¢' : topicPriority === 'medium' ? 'üü°' : 'üî¥';
                          return(
                            <label 
  key={idx} 
  className="flex items-start gap-2 cursor-pointer p-2 hover:bg-gray-50 rounded"
  onClick={(e)=>e.stopPropagation()}
>
  <input 
    type="checkbox" 
    checked={checked}
    className="mt-1 flex-shrink-0"
    onClick={(e)=>e.stopPropagation()}
    onChange={(e)=>{
      e.stopPropagation();
      const updated=e.target.checked?[...completedTopics,topicKey]:completedTopics.filter(t=>t!==topicKey && t!==topic);
      updateChapterProgress(mySchool,chapter.id,'completedTopics',updated);
    }}
  />
                              <span className={`text-sm flex-1 break-words ${checked?'line-through text-gray-500':'font-medium'}`}>
                                {topicName}
                              </span>
                              <span className="text-xs flex-shrink-0 mt-1">{priorityIcon}</span>
                            </label>
                          );
                        })}
                      </div>
                      <div className="bg-white p-3 rounded-lg">
      <label className="block text-sm font-bold mb-1">Chapter Priority</label>
      <div>
        {(chapter.priority==='high'||!chapter.priority)&&(
          <span className="priority-badge priority-high text-sm">üü¢ High Priority</span>
        )}
        {chapter.priority==='medium'&&(
          <span className="priority-badge priority-medium text-sm">üü° Medium Priority</span>
        )}
        {chapter.priority==='low'&&(
          <span className="priority-badge priority-low text-sm">üî¥ Low Priority</span>
        )}
      </div>
    </div>

                      <div className="bg-white p-3 rounded-lg">
                        <label className="block text-sm font-bold mb-1">Target Date</label>
                        <div className="text-sm">{chapter.targetDate||'‚Äî'}</div>
                      </div>

                      <div className="bg-white p-3 rounded-lg">
                        <label className="block text-sm font-bold mb-1">Completion Date *</label>
                        <input 
  type="date" 
  value={prog.completionDate||''} 
  onClick={(e)=>e.stopPropagation()}
  onChange={(e)=>{
    e.stopPropagation();
    updateChapterProgress(mySchool,chapter.id,'completionDate',e.target.value);
  }}
  className="w-full border-2 px-3 py-2 rounded-lg cursor-pointer"
/>
                      </div>

                      <div className="bg-white p-3 rounded-lg">
                        <label className="block text-sm font-bold mb-1">Test Conducted? *</label>
                        <select 
  value={prog.testConducted||'No'} 
  onClick={(e)=>e.stopPropagation()}
  onChange={(e)=>{
    e.stopPropagation();
    updateChapterProgress(mySchool,chapter.id,'testConducted',e.target.value);
  }}
  className="w-full border-2 px-3 py-2 rounded-lg cursor-pointer"
>
                          <option value="No">No</option>
                          <option value="Yes">Yes</option>
                        </select>
                      </div>

                      <div className="bg-white p-3 rounded-lg">
                        <label className="block text-sm font-bold mb-1">Chapter Completed? *</label>
                        <select 
  value={prog.completed||'No'} 
  onClick={(e)=>e.stopPropagation()}
  onChange={(e)=>{
    e.stopPropagation();
    handleCompletedChange(chapter.id,e.target.value);
  }}
  className="w-full border-2 px-3 py-2 rounded-lg cursor-pointer"
>
                          <option value="No">No</option>
                          <option value="Yes">Yes</option>
                        </select>
                      </div>

                      <div className="bg-white p-3 rounded-lg">
                        <label className="block text-sm font-bold mb-1">Notes</label>
                        <textarea 
  value={prog.notes||''} 
  onClick={(e)=>e.stopPropagation()}
  onChange={(e)=>{
    e.stopPropagation();
    updateChapterProgress(mySchool,chapter.id,'notes',e.target.value);
  }}
  className="w-full border-2 px-3 py-2 rounded-lg cursor-text" 
  rows="2" 
  placeholder="Add notes..."
/>
                      </div>
                    </>
                  )}
                </div>
              </div>
            );
          })}
        </div>
      }
    </div>
  );
}

function BirthdaysPage({teachers}){const todayBirthdays=useMemo(()=>getBirthdays(teachers,'today'),[teachers]);const weekBirthdays=useMemo(()=>getBirthdays(teachers,'week'),[teachers]);const monthBirthdays=useMemo(()=>getBirthdays(teachers,'month'),[teachers]);const todayAnniversaries=useMemo(()=>getAnniversaries(teachers,'today'),[teachers]);const weekAnniversaries=useMemo(()=>getAnniversaries(teachers,'week'),[teachers]);return(<div className="space-y-6"><h2 className="text-3xl font-bold">üéâ Celebrations</h2><div className="grid md:grid-cols-2 gap-6"><>{todayBirthdays.length>0&&<div className="birthday-card p-6 rounded-2xl"><h3 className="text-2xl font-bold text-white mb-4">üéÇ Today's Birthdays</h3>{todayBirthdays.map(t=><div key={t.id} className="bg-white p-4 rounded-lg mb-2"><div className="font-bold text-lg">{t.name}</div><div className="text-sm text-gray-600">{t.school}</div></div>)}</div>}{todayAnniversaries.length>0&&<div className="birthday-card p-6 rounded-2xl"><h3 className="text-2xl font-bold text-white mb-4">üéâ Today's Anniversaries</h3>{todayAnniversaries.map(t=>{const years=new Date().getFullYear()-new Date(t.joiningDate).getFullYear();return(<div key={t.id} className="bg-white p-4 rounded-lg mb-2"><div className="font-bold text-lg">{t.name}</div><div className="text-sm text-gray-600">{years} Years at Avanti</div></div>)})}</div>}</></div><div className="grid md:grid-cols-2 gap-6"><div className="bg-white p-6 rounded-2xl shadow-lg"><h3 className="text-xl font-bold mb-4">This Week's Birthdays</h3>{weekBirthdays.length===0?<p className="text-gray-500">No birthdays this week</p>:<div className="space-y-2">{weekBirthdays.map(t=><div key={t.id} className="p-3 bg-gray-50 rounded-lg"><div className="font-semibold">{t.name}</div><div className="text-sm text-gray-600">{new Date(t.dob).toLocaleDateString(undefined,{month:'short',day:'numeric'})}</div></div>)}</div>}</div><div className="bg-white p-6 rounded-2xl shadow-lg"><h3 className="text-xl font-bold mb-4">This Month's Birthdays</h3>{monthBirthdays.length===0?<p className="text-gray-500">No birthdays this month</p>:<div className="space-y-2 max-h-96 overflow-y-auto">{monthBirthdays.map(t=><div key={t.id} className="p-3 bg-gray-50 rounded-lg"><div className="font-semibold">{t.name}</div><div className="text-sm text-gray-600">{new Date(t.dob).toLocaleDateString(undefined,{month:'short',day:'numeric'})}</div></div>)}</div>}</div></div></div>)}

function TeacherManagement({teachers, teacherAttendance, leaveAdjustments, setLeaveAdjustments, isSuperAdmin = false}){
  const[showModal,setShowModal]=useState(false);
  const[editingTeacher,setEditingTeacher]=useState(null);
  const[showLeaveModal,setShowLeaveModal]=useState(false);
  const[selectedTeacherLeave,setSelectedTeacherLeave]=useState(null);
  const[isEditingLeave,setIsEditingLeave]=useState(false);
  const[leaveForm,setLeaveForm]=useState({entitled: 0, maternity: 0, paternity: 0});
  const[savingLeave,setSavingLeave]=useState(false);
  const[form,setForm]=useState({name:'',afid:'',afCode:'',email:'',password:'',dob:'',joiningDate:'',subject:'',school:'',phone:''});
  
  // Archive functionality
  const[showArchiveModal,setShowArchiveModal]=useState(false);
  const[teacherToArchive,setTeacherToArchive]=useState(null);
  const[archiveReason,setArchiveReason]=useState('');
  const[archiveNotes,setArchiveNotes]=useState('');
  const[archiving,setArchiving]=useState(false);
  const[showArchivedTeachers,setShowArchivedTeachers]=useState(false);
  
  // NEW: Bulk Import functionality
  const[showBulkImport,setShowBulkImport]=useState(false);
  const[isImporting,setIsImporting]=useState(false);
  const[importResults,setImportResults]=useState(null);
  const bulkFileInputRef=useRef(null);
  
  // NEW: Bulk CSV Import Handler
  const handleBulkCSVImport = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    Papa.parse(file, {
      complete: async (results) => {
        try {
          setIsImporting(true);
          setImportResults(null);
          const rows = results.data;
          
          if (rows.length < 2) {
            alert('CSV file is empty or has no data rows');
            setIsImporting(false);
            return;
          }
          
          const teachersToAdd = [];
          const errors = [];
          const firebaseAuthList = [];
          
          rows.forEach((row, index) => {
            if (index === 0) return; // Skip header
            
            // Expected columns: AFID, AF Code, Name, Email, Password, Subject, School, DOB, Joining Date, Phone
            const afid = row[0] ? row[0].trim() : '';
            const afCode = row[1] ? row[1].trim() : '';
            const name = row[2] ? row[2].trim() : '';
            const email = row[3] ? row[3].trim().toLowerCase() : '';
            const password = row[4] ? row[4].trim() : '';
            const subject = row[5] ? row[5].trim() : '';
            const school = row[6] ? row[6].trim() : '';
            const dob = row[7] ? row[7].trim() : '';
            const joiningDate = row[8] ? row[8].trim() : '';
            const phone = row[9] ? row[9].trim() : '';
            
            // Validate required fields
            if (!afid || !name || !email || !subject || !school) {
              if (afid || name || email) { // Only report error if row has some data
                errors.push(`Row ${index + 1}: Missing required fields (AFID, Name, Email, Subject, or School)`);
              }
              return;
            }
            
            // Validate subject
            if (!SUBJECTS.includes(subject)) {
              errors.push(`Row ${index + 1}: Invalid subject "${subject}". Must be one of: ${SUBJECTS.join(', ')}`);
              return;
            }
            
            // Validate school
            if (!SCHOOLS.includes(school)) {
              errors.push(`Row ${index + 1}: Invalid school "${school}". Must be one of: ${SCHOOLS.join(', ')}`);
              return;
            }
            
            // Check for duplicate AFID in current batch
            if (teachersToAdd.some(t => t.afid === afid)) {
              errors.push(`Row ${index + 1}: Duplicate AFID "${afid}" in CSV`);
              return;
            }
            
            teachersToAdd.push({
              afid,
              afCode: afCode || null,
              name,
              email,
              subject,
              school,
              dob: dob || null,
              joiningDate: joiningDate || null,
              phone: phone || null,
              isArchived: false
            });
            
            if (password) {
              firebaseAuthList.push({ email, password, name, afid });
            }
          });
          
          if (teachersToAdd.length === 0) {
            alert('No valid teachers found in CSV.\n\nErrors:\n' + errors.join('\n'));
            setIsImporting(false);
            return;
          }
          
          // Check for existing teachers
          const existingAFIDs = teachers.map(t => t.afid);
          const duplicates = teachersToAdd.filter(t => existingAFIDs.includes(t.afid));
          
          if (duplicates.length > 0) {
            const proceed = confirm(`‚ö†Ô∏è Warning: ${duplicates.length} teacher(s) already exist with these AFIDs:\n${duplicates.map(d => `‚Ä¢ ${d.afid} - ${d.name}`).join('\n')}\n\nDo you want to UPDATE these existing teachers?\n\nClick OK to update existing + add new, or Cancel to abort.`);
            if (!proceed) {
              setIsImporting(false);
              if (bulkFileInputRef.current) bulkFileInputRef.current.value = '';
              return;
            }
          }
          
          // Save to Firestore
          let successCount = 0;
          let failCount = 0;
          
          for (const teacher of teachersToAdd) {
            try {
              await db.collection('teachers').doc(teacher.afid).set(teacher);
              successCount++;
            } catch (err) {
              failCount++;
              errors.push(`Failed to save ${teacher.name} (${teacher.afid}): ${err.message}`);
            }
          }
          
          setIsImporting(false);
          
          // Show results
          setImportResults({
            success: successCount,
            failed: failCount,
            errors,
            firebaseAuth: firebaseAuthList
          });
          
          if (bulkFileInputRef.current) bulkFileInputRef.current.value = '';
          
        } catch (e) {
          setIsImporting(false);
          alert('Import failed: ' + e.message);
        }
      },
      error: () => {
        setIsImporting(false);
        alert('Failed to parse CSV file');
      }
    });
  };
  
  const openAddModal=()=>{setEditingTeacher(null);setForm({name:'',afid:'',afCode:'',email:'',password:'',dob:'',joiningDate:'',subject:'',school:'',phone:''});setShowModal(true)};
  const openEditModal=teacher=>{setEditingTeacher(teacher);setForm({...teacher,password:''});setShowModal(true)};
  
  const openLeaveModal=(teacher)=>{
    const balance = calculateLeaveBalance(teacherAttendance || [], teacher.afid, leaveAdjustments || {});
    const currentAdj = leaveAdjustments[teacher.afid] || { entitled: 0, maternity: 0, paternity: 0 };
    setSelectedTeacherLeave({teacher, balance});
    setLeaveForm({
      entitled: currentAdj.entitled || 0,
      maternity: currentAdj.maternity || 0,
      paternity: currentAdj.paternity || 0
    });
    setIsEditingLeave(false);
    setShowLeaveModal(true);
  };
  
  const handleSaveLeaveAdjustment = async () => {
    if (!selectedTeacherLeave) return;
    
    setSavingLeave(true);
    try {
      const teacherId = selectedTeacherLeave.teacher.afid;
      await db.collection('leaveAdjustments').doc(teacherId).set({
        entitled: parseInt(leaveForm.entitled) || 0,
        maternity: parseInt(leaveForm.maternity) || 0,
        paternity: parseInt(leaveForm.paternity) || 0,
        updatedAt: new Date().toISOString(),
        updatedBy: 'admin'
      });
      
      // Update local state
      setLeaveAdjustments(prev => ({
        ...prev,
        [teacherId]: {
          entitled: parseInt(leaveForm.entitled) || 0,
          maternity: parseInt(leaveForm.maternity) || 0,
          paternity: parseInt(leaveForm.paternity) || 0
        }
      }));
      
      // Recalculate balance with new adjustments
      const newBalance = calculateLeaveBalance(
        teacherAttendance || [], 
        teacherId, 
        {
          ...leaveAdjustments,
          [teacherId]: {
            entitled: parseInt(leaveForm.entitled) || 0,
            maternity: parseInt(leaveForm.maternity) || 0,
            paternity: parseInt(leaveForm.paternity) || 0
          }
        }
      );
      setSelectedTeacherLeave({...selectedTeacherLeave, balance: newBalance});
      
      setIsEditingLeave(false);
      alert('Leave adjustment saved successfully!');
    } catch (e) {
      alert('Failed to save: ' + e.message);
    } finally {
      setSavingLeave(false);
    }
  };
  
  const handleSave=async()=>{if(!form.afid||!form.name||!form.email||!form.subject||!form.school){alert('Please fill all required fields (AFID, Name, Email, Subject, School)');return}try{await db.collection('teachers').doc(form.afid).set({afid:form.afid,afCode:form.afCode||null,name:form.name,email:form.email.toLowerCase(),subject:form.subject,school:form.school,dob:form.dob||null,joiningDate:form.joiningDate||null,phone:form.phone||null,isArchived:form.isArchived||false,archiveReason:form.archiveReason||null,archiveNotes:form.archiveNotes||null,archivedAt:form.archivedAt||null});if(!editingTeacher&&form.password){alert(`Teacher added!\n\nCREATE FIREBASE AUTH:\n1. Firebase Console ‚Üí Authentication\n2. Add User\n3. Email: ${form.email}\n4. Password: ${form.password}`)}else{alert('Teacher updated!')}setShowModal(false)}catch(e){alert('Failed: '+e.message)}};
  
  // Open archive modal
  const openArchiveModal = (teacher) => {
    setTeacherToArchive(teacher);
    setArchiveReason('');
    setArchiveNotes('');
    setShowArchiveModal(true);
  };
  
  // Handle archive teacher
  const handleArchive = async () => {
    if (!archiveReason) {
      alert('Please select a reason for archiving');
      return;
    }
    
    setArchiving(true);
    try {
      await db.collection('teachers').doc(teacherToArchive.afid).update({
        isArchived: true,
        archiveReason: archiveReason,
        archiveNotes: archiveNotes || '',
        archivedAt: new Date().toISOString(),
        archivedBy: 'admin'
      });
      
      alert(`‚úÖ ${teacherToArchive.name} has been archived.\n\nReason: ${archiveReason}\n\n‚Ä¢ All curriculum data is preserved\n‚Ä¢ Student feedback history is preserved\n‚Ä¢ A new teacher can be assigned to continue`);
      setShowArchiveModal(false);
      setTeacherToArchive(null);
    } catch (e) {
      alert('Failed to archive: ' + e.message);
    } finally {
      setArchiving(false);
    }
  };
  
  // Restore archived teacher
  const handleRestore = async (teacher) => {
    if (!confirm(`Restore ${teacher.name} as an active teacher?`)) return;
    
    try {
      await db.collection('teachers').doc(teacher.afid).update({
        isArchived: false,
        archiveReason: null,
        archiveNotes: null,
        archivedAt: null,
        archivedBy: null,
        restoredAt: new Date().toISOString()
      });
      alert(`‚úÖ ${teacher.name} has been restored as an active teacher.`);
    } catch (e) {
      alert('Failed to restore: ' + e.message);
    }
  };
  
  // Permanently delete (only for archived teachers)
  const handlePermanentDelete = async (teacher) => {
    if (!confirm(`‚ö†Ô∏è PERMANENT DELETE\n\nAre you sure you want to permanently delete ${teacher.name}?\n\nThis action cannot be undone.\nNote: Historical data (feedback, observations) will remain but show "Deleted Teacher".`)) return;
    
    try {
      await db.collection('teachers').doc(teacher.afid).delete();
      alert('Teacher permanently deleted.');
    } catch (e) {
      alert('Failed to delete: ' + e.message);
    }
  };
  
  // Filter teachers based on archive status
  const activeTeachers = teachers.filter(t => !t.isArchived);
  const archivedTeachers = teachers.filter(t => t.isArchived);
  
  // Helper to get leave balance for display
  const getLeaveBalanceDisplay = (teacherId) => {
    const balance = calculateLeaveBalance(teacherAttendance || [], teacherId, leaveAdjustments || {});
    return balance;
  };
  
  return(
    <div className="space-y-6">
      <div className="flex justify-between items-center flex-wrap gap-4">
        <h2 className="text-3xl font-bold">Teacher Management</h2>
        <div className="flex items-center gap-4">
          {/* Toggle for archived teachers */}
          <label className="flex items-center gap-2 cursor-pointer">
            <input 
              type="checkbox" 
              checked={showArchivedTeachers}
              onChange={e => setShowArchivedTeachers(e.target.checked)}
              className="w-5 h-5"
            />
            <span className="text-sm font-medium">
              Show Archived ({archivedTeachers.length})
            </span>
          </label>
          {isSuperAdmin && (
            <button onClick={openAddModal} className="px-6 py-3 bg-blue-600 text-white rounded-xl font-semibold">+ Add Teacher</button>
          )}
        </div>
      </div>
      
      {/* NEW: Bulk Import Section */}
      {isSuperAdmin && (
        <div className="bg-white p-6 rounded-2xl shadow-lg border-2 border-purple-200">
          <div className="flex justify-between items-center mb-4">
            <h3 className="text-xl font-bold text-purple-700">üì§ Bulk Import Teachers</h3>
            <button 
              onClick={() => setShowBulkImport(!showBulkImport)} 
              className="px-4 py-2 bg-purple-100 text-purple-700 rounded-lg font-semibold hover:bg-purple-200"
            >
              {showBulkImport ? '‚ñ≤ Hide' : '‚ñº Expand'}
            </button>
          </div>
          
          {showBulkImport && (
            <div className="space-y-4">
              {/* CSV Format Guide */}
              <div className="p-4 bg-purple-50 border-2 border-purple-200 rounded-xl">
                <p className="font-bold text-purple-800 mb-2">üìã CSV Format (10 columns):</p>
                <div className="text-sm text-purple-700 space-y-1">
                  <p><strong>Column A:</strong> AFID * (unique identifier)</p>
                  <p><strong>Column B:</strong> AF Code (e.g., AF355)</p>
                  <p><strong>Column C:</strong> Name *</p>
                  <p><strong>Column D:</strong> Email *</p>
                  <p><strong>Column E:</strong> Password (for new teachers - you'll need to create in Firebase Auth)</p>
                  <p><strong>Column F:</strong> Subject * (Physics, Chemistry, Mathematics, Biology)</p>
                  <p><strong>Column G:</strong> School * (must match exactly: {SCHOOLS.join(', ')})</p>
                  <p><strong>Column H:</strong> Date of Birth (YYYY-MM-DD)</p>
                  <p><strong>Column I:</strong> Joining Date (YYYY-MM-DD)</p>
                  <p><strong>Column J:</strong> Phone</p>
                </div>
                <p className="text-xs text-purple-600 mt-2">* Required fields</p>
              </div>
              
              {/* Sample CSV Table */}
              <div className="bg-white p-3 rounded-lg text-xs font-mono overflow-x-auto border">
                <table className="w-full border-collapse">
                  <thead>
                    <tr className="bg-gray-100">
                      <th className="border p-1 text-left">AFID</th>
                      <th className="border p-1 text-left">AF Code</th>
                      <th className="border p-1 text-left">Name</th>
                      <th className="border p-1 text-left">Email</th>
                      <th className="border p-1 text-left">Password</th>
                      <th className="border p-1 text-left">Subject</th>
                      <th className="border p-1 text-left">School</th>
                      <th className="border p-1 text-left">DOB</th>
                      <th className="border p-1 text-left">Joining</th>
                      <th className="border p-1 text-left">Phone</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td className="border p-1">T001</td>
                      <td className="border p-1">AF355</td>
                      <td className="border p-1">Rahul Sharma</td>
                      <td className="border p-1">rahul@avanti.org</td>
                      <td className="border p-1">pass123</td>
                      <td className="border p-1">Physics</td>
                      <td className="border p-1">CoE Barwani</td>
                      <td className="border p-1">1990-05-15</td>
                      <td className="border p-1">2023-06-01</td>
                      <td className="border p-1">9876543210</td>
                    </tr>
                    <tr className="bg-gray-50">
                      <td className="border p-1">T002</td>
                      <td className="border p-1">AF356</td>
                      <td className="border p-1">Priya Patel</td>
                      <td className="border p-1">priya@avanti.org</td>
                      <td className="border p-1">pass456</td>
                      <td className="border p-1">Chemistry</td>
                      <td className="border p-1">CoE Bundi</td>
                      <td className="border p-1">1992-08-20</td>
                      <td className="border p-1">2024-01-15</td>
                      <td className="border p-1">9876543211</td>
                    </tr>
                  </tbody>
                </table>
              </div>
              
              {/* Import Button */}
              <div className="flex gap-3">
                <label className={`flex-1 px-6 py-4 ${!isImporting ? 'bg-purple-600 hover:bg-purple-700 cursor-pointer' : 'bg-gray-400 cursor-not-allowed'} text-white rounded-xl font-semibold text-center transition-all`}>
                  {isImporting ? (
                    <span className="flex items-center justify-center gap-2">
                      <svg className="animate-spin h-5 w-5" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" fill="none"/><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/></svg>
                      Importing Teachers...
                    </span>
                  ) : (
                    'üì§ Select CSV File to Import'
                  )}
                  <input 
                    ref={bulkFileInputRef} 
                    type="file" 
                    accept=".csv" 
                    onChange={handleBulkCSVImport} 
                    disabled={isImporting}
                    className="hidden"
                  />
                </label>
              </div>
              
              {/* Import Results */}
              {importResults && (
                <div className={`p-4 rounded-xl ${importResults.failed > 0 ? 'bg-yellow-50 border-2 border-yellow-300' : 'bg-green-50 border-2 border-green-300'}`}>
                  <h4 className="font-bold text-lg mb-2">
                    {importResults.failed > 0 ? '‚ö†Ô∏è Import Completed with Warnings' : '‚úÖ Import Successful!'}
                  </h4>
                  <div className="space-y-2 text-sm">
                    <p className="text-green-700">‚úì {importResults.success} teacher(s) imported successfully</p>
                    {importResults.failed > 0 && (
                      <p className="text-red-700">‚úó {importResults.failed} teacher(s) failed</p>
                    )}
                    
                    {importResults.errors.length > 0 && (
                      <div className="mt-3 p-3 bg-red-50 rounded-lg">
                        <p className="font-bold text-red-700 mb-1">Errors:</p>
                        <ul className="text-red-600 text-xs space-y-1 max-h-32 overflow-y-auto">
                          {importResults.errors.map((err, i) => <li key={i}>‚Ä¢ {err}</li>)}
                        </ul>
                      </div>
                    )}
                    
                    {importResults.firebaseAuth.length > 0 && (
                      <div className="mt-3 p-3 bg-blue-50 rounded-lg">
                        <p className="font-bold text-blue-700 mb-2">üîê Firebase Authentication Required:</p>
                        <p className="text-blue-600 text-xs mb-2">Create these users in Firebase Console ‚Üí Authentication ‚Üí Add User:</p>
                        <div className="bg-white rounded p-2 max-h-40 overflow-y-auto">
                          <table className="w-full text-xs">
                            <thead>
                              <tr className="bg-gray-100">
                                <th className="p-1 text-left">Email</th>
                                <th className="p-1 text-left">Password</th>
                                <th className="p-1 text-left">Name</th>
                              </tr>
                            </thead>
                            <tbody>
                              {importResults.firebaseAuth.map((auth, i) => (
                                <tr key={i} className="border-b">
                                  <td className="p-1 font-mono">{auth.email}</td>
                                  <td className="p-1 font-mono">{auth.password}</td>
                                  <td className="p-1">{auth.name}</td>
                                </tr>
                              ))}
                            </tbody>
                          </table>
                        </div>
                      </div>
                    )}
                  </div>
                  <button 
                    onClick={() => setImportResults(null)} 
                    className="mt-3 px-4 py-2 bg-gray-200 rounded-lg text-sm font-medium hover:bg-gray-300"
                  >
                    Dismiss
                  </button>
                </div>
              )}
            </div>
          )}
        </div>
      )}
      
      {/* Active Teachers Table */}
      <div className="bg-white p-6 rounded-2xl shadow-lg overflow-x-auto">
        <h3 className="text-lg font-bold mb-4 text-green-600">‚úÖ Active Teachers ({activeTeachers.length})</h3>
        <table className="w-full">
          <thead className="avanti-gradient-light">
            <tr>
              <th className="p-3 text-left">AFID</th>
              <th className="p-3 text-left">AF Code</th>
              <th className="p-3 text-left">Name</th>
              <th className="p-3 text-left">Email</th>
              <th className="p-3 text-left">Subject</th>
              <th className="p-3 text-left">School</th>
              <th className="p-3 text-center">Leave Balance</th>
              <th className="p-3 text-left">Actions</th>
            </tr>
          </thead>
          <tbody>
            {activeTeachers.map(t => {
              const balance = getLeaveBalanceDisplay(t.afid);
              return (
                <tr key={t.id} className="border-b hover:bg-gray-50">
                  <td className="p-3 font-mono">{t.afid}</td>
                  <td className="p-3 font-mono text-blue-600">{t.afCode || '‚Äî'}</td>
                  <td className="p-3">{t.name}</td>
                  <td className="p-3 text-sm">{t.email}</td>
                  <td className="p-3">{t.subject}</td>
                  <td className="p-3">{t.school}</td>
                  <td className="p-3">
                    <button 
                      onClick={() => openLeaveModal(t)}
                      className="flex flex-col items-center gap-1 w-full hover:bg-gray-100 p-2 rounded-lg transition-colors"
                    >
                      <div className="flex gap-2 text-xs">
                        <span className="px-2 py-0.5 bg-blue-100 text-blue-700 rounded-full" title="Entitled Leave">
                          E: {balance.entitled.remaining}/{balance.entitled.total}
                        </span>
                      </div>
                      <div className="flex gap-2 text-xs">
                        <span className="px-2 py-0.5 bg-pink-100 text-pink-700 rounded-full" title="Maternity Leave">
                          M: {balance.maternity.remaining}
                        </span>
                        <span className="px-2 py-0.5 bg-purple-100 text-purple-700 rounded-full" title="Paternity Leave">
                          P: {balance.paternity.remaining}
                        </span>
                      </div>
                      <span className="text-xs text-gray-400">Click to view/edit</span>
                    </button>
                  </td>
                  <td className="p-3">
                    {isSuperAdmin ? (
                      <div className="flex gap-2">
                        <button onClick={()=>openEditModal(t)} className="px-3 py-1 bg-yellow-400 rounded-lg">Edit</button>
                        <button onClick={()=>openArchiveModal(t)} className="px-3 py-1 bg-orange-500 text-white rounded-lg" title="Archive instead of delete">Archive</button>
                      </div>
                    ) : (
                      <span className="text-gray-400 text-sm">View Only</span>
                    )}
                  </td>
                </tr>
              );
            })}
          </tbody>
        </table>
      </div>
      
      {/* Archived Teachers Table (Conditional) */}
      {showArchivedTeachers && archivedTeachers.length > 0 && (
        <div className="bg-white p-6 rounded-2xl shadow-lg overflow-x-auto border-2 border-red-200">
          <h3 className="text-lg font-bold mb-4 text-red-600">üì¶ Archived Teachers ({archivedTeachers.length})</h3>
          <table className="w-full">
            <thead className="bg-red-50">
              <tr>
                <th className="p-3 text-left">AFID</th>
                <th className="p-3 text-left">Name</th>
                <th className="p-3 text-left">Subject</th>
                <th className="p-3 text-left">School</th>
                <th className="p-3 text-left">Archive Reason</th>
                <th className="p-3 text-left">Archived Date</th>
                <th className="p-3 text-left">Actions</th>
              </tr>
            </thead>
            <tbody>
              {archivedTeachers.map(t => (
                <tr key={t.id} className="border-b bg-red-50/50 hover:bg-red-100/50">
                  <td className="p-3 font-mono text-red-700">{t.afid}</td>
                  <td className="p-3 text-red-700 font-medium">{t.name}</td>
                  <td className="p-3 text-red-600">{t.subject}</td>
                  <td className="p-3 text-red-600">{t.school}</td>
                  <td className="p-3">
                    <span className={`px-2 py-1 rounded-full text-xs font-bold ${
                      t.archiveReason === 'Resigned' ? 'bg-yellow-100 text-yellow-800' :
                      t.archiveReason === 'Removed' ? 'bg-red-100 text-red-800' :
                      t.archiveReason === 'Transferred' ? 'bg-blue-100 text-blue-800' :
                      'bg-gray-100 text-gray-800'
                    }`}>
                      {t.archiveReason || 'Unknown'}
                    </span>
                    {t.archiveNotes && (
                      <div className="text-xs text-gray-500 mt-1" title={t.archiveNotes}>
                        üìù {t.archiveNotes.length > 30 ? t.archiveNotes.slice(0, 30) + '...' : t.archiveNotes}
                      </div>
                    )}
                  </td>
                  <td className="p-3 text-sm text-gray-600">
                    {t.archivedAt ? new Date(t.archivedAt).toLocaleDateString() : '‚Äî'}
                  </td>
                  <td className="p-3">
                    {isSuperAdmin && (
                      <div className="flex gap-2">
                        <button onClick={() => handleRestore(t)} className="px-3 py-1 bg-green-500 text-white rounded-lg text-sm">Restore</button>
                        <button onClick={() => handlePermanentDelete(t)} className="px-3 py-1 bg-red-600 text-white rounded-lg text-sm">Delete</button>
                      </div>
                    )}
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      )}
      
      {/* Leave Balance Modal */}
      {showLeaveModal && selectedTeacherLeave && (
        <div className="modal-overlay" onClick={() => {setShowLeaveModal(false); setIsEditingLeave(false);}}>
          <div className="modal-content max-w-lg" onClick={e => e.stopPropagation()}>
            <div className="flex justify-between items-center mb-4">
              <h3 className="text-2xl font-bold">üìä Leave Balance - {selectedTeacherLeave.teacher.name}</h3>
              {!isEditingLeave && (
                <button 
                  onClick={() => setIsEditingLeave(true)}
                  className="px-4 py-2 bg-yellow-400 rounded-lg font-semibold text-sm"
                >
                  ‚úèÔ∏è Edit
                </button>
              )}
            </div>
            
            {isEditingLeave ? (
              /* Edit Mode */
              <div className="space-y-4">
                <div className="bg-yellow-50 p-4 rounded-xl border-2 border-yellow-300 mb-4">
                  <p className="text-sm text-yellow-800">
                    <strong>üìù Adjust Prior Leaves:</strong> Enter the number of leaves already taken before this system was implemented. These will be added to the system-tracked leaves.
                  </p>
                </div>
                
                {/* Entitled Leave Edit */}
                <div className="bg-blue-50 p-4 rounded-xl border-2 border-blue-200">
                  <label className="block font-bold text-blue-800 mb-2">Entitled Leave (Prior Adjustment)</label>
                  <div className="flex items-center gap-3">
                    <input 
                      type="number" 
                      min="0" 
                      max="35"
                      value={leaveForm.entitled}
                      onChange={e => setLeaveForm({...leaveForm, entitled: Math.min(35, Math.max(0, parseInt(e.target.value) || 0))})}
                      className="w-24 border-2 px-3 py-2 rounded-lg text-center font-bold text-lg"
                    />
                    <span className="text-blue-700">days taken before system</span>
                  </div>
                  <p className="text-xs text-blue-600 mt-2">Max: 35 days (Personal, Sick, Emergency combined)</p>
                </div>
                
                {/* Maternity Leave Edit */}
                <div className="bg-pink-50 p-4 rounded-xl border-2 border-pink-200">
                  <label className="block font-bold text-pink-800 mb-2">Maternity Leave (Prior Adjustment)</label>
                  <div className="flex items-center gap-3">
                    <input 
                      type="number" 
                      min="0" 
                      max="180"
                      value={leaveForm.maternity}
                      onChange={e => setLeaveForm({...leaveForm, maternity: Math.min(180, Math.max(0, parseInt(e.target.value) || 0))})}
                      className="w-24 border-2 px-3 py-2 rounded-lg text-center font-bold text-lg"
                    />
                    <span className="text-pink-700">days taken before system</span>
                  </div>
                  <p className="text-xs text-pink-600 mt-2">Max: 180 days</p>
                </div>
                
                {/* Paternity Leave Edit */}
                <div className="bg-purple-50 p-4 rounded-xl border-2 border-purple-200">
                  <label className="block font-bold text-purple-800 mb-2">Paternity Leave (Prior Adjustment)</label>
                  <div className="flex items-center gap-3">
                    <input 
                      type="number" 
                      min="0" 
                      max="15"
                      value={leaveForm.paternity}
                      onChange={e => setLeaveForm({...leaveForm, paternity: Math.min(15, Math.max(0, parseInt(e.target.value) || 0))})}
                      className="w-24 border-2 px-3 py-2 rounded-lg text-center font-bold text-lg"
                    />
                    <span className="text-purple-700">days taken before system</span>
                  </div>
                  <p className="text-xs text-purple-600 mt-2">Max: 15 days</p>
                </div>
                
                <div className="flex gap-3 mt-6">
                  <button 
                    onClick={handleSaveLeaveAdjustment}
                    disabled={savingLeave}
                    className="flex-1 avanti-gradient text-white py-3 rounded-xl font-semibold disabled:opacity-50"
                  >
                    {savingLeave ? 'Saving...' : 'üíæ Save Adjustment'}
                  </button>
                  <button 
                    onClick={() => {
                      setIsEditingLeave(false);
                      const currentAdj = leaveAdjustments[selectedTeacherLeave.teacher.afid] || { entitled: 0, maternity: 0, paternity: 0 };
                      setLeaveForm({
                        entitled: currentAdj.entitled || 0,
                        maternity: currentAdj.maternity || 0,
                        paternity: currentAdj.paternity || 0
                      });
                    }}
                    className="flex-1 bg-gray-300 py-3 rounded-xl font-semibold"
                  >
                    Cancel
                  </button>
                </div>
              </div>
            ) : (
              /* View Mode */
              <div className="space-y-4">
                {/* Entitled Leave */}
                <div className="bg-blue-50 p-4 rounded-xl border-2 border-blue-200">
                  <div className="flex justify-between items-center mb-2">
                    <span className="font-bold text-blue-800">Entitled Leave</span>
                    <span className="text-2xl font-bold text-blue-600">
                      {selectedTeacherLeave.balance.entitled.remaining}/{selectedTeacherLeave.balance.entitled.total}
                    </span>
                  </div>
                  <div className="flex justify-between text-sm text-blue-700">
                    <span>Used: {selectedTeacherLeave.balance.entitled.used} days</span>
                    <span>Remaining: {selectedTeacherLeave.balance.entitled.remaining} days</span>
                  </div>
                  {selectedTeacherLeave.balance.entitled.adjustment > 0 && (
                    <div className="text-xs text-blue-600 mt-1">
                      (includes {selectedTeacherLeave.balance.entitled.adjustment} prior adjustment)
                    </div>
                  )}
                  <div className="mt-2 bg-blue-200 rounded-full h-3">
                    <div 
                      className="bg-blue-500 h-3 rounded-full transition-all" 
                      style={{width: `${(selectedTeacherLeave.balance.entitled.remaining/selectedTeacherLeave.balance.entitled.total)*100}%`}}
                    />
                  </div>
                  <p className="text-xs text-blue-600 mt-2">Includes: Personal Leave, Sick Leave, Emergency Leave</p>
                </div>
                
                {/* Maternity Leave */}
                <div className="bg-pink-50 p-4 rounded-xl border-2 border-pink-200">
                  <div className="flex justify-between items-center mb-2">
                    <span className="font-bold text-pink-800">Maternity Leave</span>
                    <span className="text-2xl font-bold text-pink-600">
                      {selectedTeacherLeave.balance.maternity.remaining}/{selectedTeacherLeave.balance.maternity.total}
                    </span>
                  </div>
                  <div className="flex justify-between text-sm text-pink-700">
                    <span>Used: {selectedTeacherLeave.balance.maternity.used} days</span>
                    <span>Remaining: {selectedTeacherLeave.balance.maternity.remaining} days</span>
                  </div>
                  {selectedTeacherLeave.balance.maternity.adjustment > 0 && (
                    <div className="text-xs text-pink-600 mt-1">
                      (includes {selectedTeacherLeave.balance.maternity.adjustment} prior adjustment)
                    </div>
                  )}
                  <div className="mt-2 bg-pink-200 rounded-full h-3">
                    <div 
                      className="bg-pink-500 h-3 rounded-full transition-all" 
                      style={{width: `${(selectedTeacherLeave.balance.maternity.remaining/selectedTeacherLeave.balance.maternity.total)*100}%`}}
                    />
                  </div>
                </div>
                
                {/* Paternity Leave */}
                <div className="bg-purple-50 p-4 rounded-xl border-2 border-purple-200">
                  <div className="flex justify-between items-center mb-2">
                    <span className="font-bold text-purple-800">Paternity Leave</span>
                    <span className="text-2xl font-bold text-purple-600">
                      {selectedTeacherLeave.balance.paternity.remaining}/{selectedTeacherLeave.balance.paternity.total}
                    </span>
                  </div>
                  <div className="flex justify-between text-sm text-purple-700">
                    <span>Used: {selectedTeacherLeave.balance.paternity.used} days</span>
                    <span>Remaining: {selectedTeacherLeave.balance.paternity.remaining} days</span>
                  </div>
                  {selectedTeacherLeave.balance.paternity.adjustment > 0 && (
                    <div className="text-xs text-purple-600 mt-1">
                      (includes {selectedTeacherLeave.balance.paternity.adjustment} prior adjustment)
                    </div>
                  )}
                  <div className="mt-2 bg-purple-200 rounded-full h-3">
                    <div 
                      className="bg-purple-500 h-3 rounded-full transition-all" 
                      style={{width: `${(selectedTeacherLeave.balance.paternity.remaining/selectedTeacherLeave.balance.paternity.total)*100}%`}}
                    />
                  </div>
                </div>
                
                <button 
                  onClick={() => {setShowLeaveModal(false); setIsEditingLeave(false);}}
                  className="w-full mt-6 bg-gray-300 py-3 rounded-xl font-semibold"
                >
                  Close
                </button>
              </div>
            )}
          </div>
        </div>
      )}
      
      {/* Archive Teacher Modal */}
      {showArchiveModal && teacherToArchive && (
        <div className="modal-overlay" onClick={() => setShowArchiveModal(false)}>
          <div className="modal-content max-w-md" onClick={e => e.stopPropagation()}>
            <div className="text-center mb-6">
              <div className="text-5xl mb-3">üì¶</div>
              <h3 className="text-2xl font-bold text-gray-800">Archive Teacher</h3>
              <p className="text-gray-600 mt-2">
                You are about to archive <strong className="text-red-600">{teacherToArchive.name}</strong>
              </p>
            </div>
            
            <div className="bg-blue-50 p-4 rounded-xl mb-4 text-sm">
              <p className="font-bold text-blue-800 mb-2">üìå What happens when you archive:</p>
              <ul className="space-y-1 text-blue-700">
                <li>‚úÖ All curriculum data is <strong>preserved</strong></li>
                <li>‚úÖ Student feedback history is <strong>preserved</strong></li>
                <li>‚úÖ Teacher appears as "Archived" in directory</li>
                <li>‚úÖ Students see "Vacant" for this subject</li>
                <li>‚úÖ New teacher can continue from where they left off</li>
              </ul>
            </div>
            
            <div className="space-y-4">
              <div>
                <label className="block font-bold mb-2 text-gray-700">
                  Reason for Archiving <span className="text-red-500">*</span>
                </label>
                <select
                  value={archiveReason}
                  onChange={e => setArchiveReason(e.target.value)}
                  className="w-full border-2 px-4 py-3 rounded-xl"
                  required
                >
                  <option value="">-- Select Reason --</option>
                  <option value="Resigned">üòî Resigned</option>
                  <option value="Removed">‚ùå Removed</option>
                  <option value="Transferred">üîÑ Transferred to another program</option>
                  <option value="On Long Leave">üèñÔ∏è On Long Leave</option>
                  <option value="Other">üìù Other</option>
                </select>
              </div>
              
              <div>
                <label className="block font-bold mb-2 text-gray-700">Additional Notes (Optional)</label>
                <textarea
                  value={archiveNotes}
                  onChange={e => setArchiveNotes(e.target.value)}
                  placeholder="E.g., Resigned for personal reasons, effective date, etc."
                  className="w-full border-2 px-4 py-3 rounded-xl resize-none"
                  rows="3"
                />
              </div>
            </div>
            
            <div className="flex gap-3 mt-6">
              <button
                onClick={() => setShowArchiveModal(false)}
                className="flex-1 bg-gray-300 py-3 rounded-xl font-semibold"
                disabled={archiving}
              >
                Cancel
              </button>
              <button
                onClick={handleArchive}
                disabled={!archiveReason || archiving}
                className={`flex-1 py-3 rounded-xl font-semibold text-white ${
                  !archiveReason || archiving ? 'bg-gray-400 cursor-not-allowed' : 'bg-orange-500 hover:bg-orange-600'
                }`}
              >
                {archiving ? '‚è≥ Archiving...' : 'üì¶ Archive Teacher'}
              </button>
            </div>
          </div>
        </div>
      )}
      
      {/* Add/Edit Teacher Modal */}
      {showModal && (
        <div className="modal-overlay" onClick={() => setShowModal(false)}>
          <div className="modal-content" onClick={e => e.stopPropagation()}>
            <h3 className="text-2xl font-bold mb-4">{editingTeacher ? 'Edit Teacher' : 'Add New Teacher'}</h3>
            <div className="space-y-4">
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-bold mb-1">AFID *</label>
                  <input type="text" value={form.afid} onChange={e => setForm({...form, afid: e.target.value})} disabled={!!editingTeacher} className="w-full border-2 px-3 py-2 rounded-lg"/>
                </div>
                <div>
                  <label className="block text-sm font-bold mb-1">AF Code (e.g. AF355)</label>
                  <input type="text" value={form.afCode || ''} onChange={e => setForm({...form, afCode: e.target.value})} placeholder="AF355" className="w-full border-2 px-3 py-2 rounded-lg"/>
                </div>
              </div>
              <div>
                <label className="block text-sm font-bold mb-1">Name *</label>
                <input type="text" value={form.name} onChange={e => setForm({...form, name: e.target.value})} className="w-full border-2 px-3 py-2 rounded-lg"/>
              </div>
              <div>
                <label className="block text-sm font-bold mb-1">Email *</label>
                <input type="email" value={form.email} onChange={e => setForm({...form, email: e.target.value})} className="w-full border-2 px-3 py-2 rounded-lg"/>
              </div>
              {!editingTeacher && (
                <div>
                  <label className="block text-sm font-bold mb-1">Password *</label>
                  <input type="password" value={form.password} onChange={e => setForm({...form, password: e.target.value})} className="w-full border-2 px-3 py-2 rounded-lg"/>
                </div>
              )}
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-bold mb-1">Subject *</label>
                  <select value={form.subject} onChange={e => setForm({...form, subject: e.target.value})} className="w-full border-2 px-3 py-2 rounded-lg">
                    <option value="">Select</option>
                    {SUBJECTS.map(s => <option key={s} value={s}>{s}</option>)}
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-bold mb-1">School *</label>
                  <select value={form.school} onChange={e => setForm({...form, school: e.target.value})} className="w-full border-2 px-3 py-2 rounded-lg">
                    <option value="">Select</option>
                    {SCHOOLS.map(s => <option key={s} value={s}>{s}</option>)}
                  </select>
                </div>
              </div>
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-bold mb-1">Date of Birth</label>
                  <input type="date" value={form.dob} onChange={e => setForm({...form, dob: e.target.value})} className="w-full border-2 px-3 py-2 rounded-lg"/>
                </div>
                <div>
                  <label className="block text-sm font-bold mb-1">Joining Date</label>
                  <input type="date" value={form.joiningDate} onChange={e => setForm({...form, joiningDate: e.target.value})} className="w-full border-2 px-3 py-2 rounded-lg"/>
                </div>
              </div>
              <div>
                <label className="block text-sm font-bold mb-1">Phone</label>
                <input type="text" value={form.phone} onChange={e => setForm({...form, phone: e.target.value})} className="w-full border-2 px-3 py-2 rounded-lg"/>
              </div>
              <div className="flex gap-3">
                <button onClick={handleSave} className="flex-1 avanti-gradient text-white py-3 rounded-xl font-semibold">Save</button>
                <button onClick={() => setShowModal(false)} className="flex-1 bg-gray-300 py-3 rounded-xl font-semibold">Cancel</button>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

function AdminCurriculum({curriculum,addChapter,updateChapter,deleteChapter}){const[selectedSchool,setSelectedSchool]=useState(SCHOOLS[0]);const[selectedSubject,setSelectedSubject]=useState(SUBJECTS[0]);const[selectedGrade,setSelectedGrade]=useState('11');const[showAddForm,setShowAddForm]=useState(false);const[editingChapter,setEditingChapter]=useState(null);const[chapterForm,setChapterForm]=useState({name:'',topics:[],targetDate:'',priority:'medium'});const[newTopic,setNewTopic]=useState('');const fileInputRef=useRef(null);
// NEW: Multi-school selection for bulk CSV import
const[selectedSchoolsForImport,setSelectedSchoolsForImport]=useState([SCHOOLS[0]]);
const[importSubject,setImportSubject]=useState(SUBJECTS[0]);
const[importGrade,setImportGrade]=useState('11');
const[showBulkImport,setShowBulkImport]=useState(false);
const[isImporting,setIsImporting]=useState(false);
// NEW: Bulk delete selection
const[selectedChaptersForDelete,setSelectedChaptersForDelete]=useState([]);
const[isDeleting,setIsDeleting]=useState(false);

const toggleSchoolSelection=(school)=>{
  setSelectedSchoolsForImport(prev=>
    prev.includes(school)?prev.filter(s=>s!==school):[...prev,school]
  );
};
const selectAllSchools=()=>setSelectedSchoolsForImport([...SCHOOLS]);
const deselectAllSchools=()=>setSelectedSchoolsForImport([]);

// NEW: Bulk delete handlers
const toggleChapterSelection=(chapterId)=>{
  setSelectedChaptersForDelete(prev=>
    prev.includes(chapterId)?prev.filter(id=>id!==chapterId):[...prev,chapterId]
  );
};
const selectAllChapters=()=>{
  const docId=`${selectedSchool}_${selectedSubject}_${selectedGrade}`;
  const chapters=curriculum[docId]?.chapters||[];
  setSelectedChaptersForDelete(chapters.map(ch=>ch.id));
};
const deselectAllChapters=()=>setSelectedChaptersForDelete([]);

const handleBulkDelete=async()=>{
  if(selectedChaptersForDelete.length===0){
    alert('Please select chapters to delete');
    return;
  }
  const count=selectedChaptersForDelete.length;
  if(!confirm(`Are you sure you want to delete ${count} chapter${count>1?'s':''}? This action cannot be undone.`))return;
  
  setIsDeleting(true);
  try{
    const docId=`${selectedSchool}_${selectedSubject}_${selectedGrade}`;
    const doc=await db.collection('curriculum').doc(docId).get();
    const existing=doc.exists?(doc.data().chapters||[]):[];
    const updated=existing.filter(ch=>!selectedChaptersForDelete.includes(ch.id));
    await db.collection('curriculum').doc(docId).set({chapters:updated});
    setSelectedChaptersForDelete([]);
    alert(`‚úÖ Successfully deleted ${count} chapter${count>1?'s':''}`);
  }catch(e){
    console.error('Bulk delete error',e);
    alert('Failed to delete chapters: '+e.message);
  }finally{
    setIsDeleting(false);
  }
};

// Clear selection when school/subject/grade changes
React.useEffect(()=>{
  setSelectedChaptersForDelete([]);
},[selectedSchool,selectedSubject,selectedGrade]);

const docId=`${selectedSchool}_${selectedSubject}_${selectedGrade}`;const chapters=curriculum[docId]?.chapters||[];const handleSaveChapter=()=>{if(!chapterForm.name){alert('Chapter name is required');return}if(editingChapter){updateChapter(selectedSchool,selectedSubject,selectedGrade,editingChapter.id,chapterForm);setEditingChapter(null)}else{addChapter(selectedSchool,selectedSubject,selectedGrade,chapterForm)}setChapterForm({name:'',topics:[],targetDate:'',priority:'medium'});setShowAddForm(false)};const handleEditChapter=chapter=>{setEditingChapter(chapter);
  // Convert old string topics to new object format if needed
  const convertedTopics = (chapter.topics||[]).map(t => 
    typeof t === 'string' ? {name: t, priority: 'medium'} : t
  );
  setChapterForm({
  name:chapter.name,
  topics:convertedTopics,
  targetDate:chapter.targetDate||'',
  priority:chapter.priority||'medium'
});setShowAddForm(true)};const handleAddTopic=()=>{if(!newTopic.trim())return;setChapterForm({...chapterForm,topics:[...chapterForm.topics,{name:newTopic.trim(),priority:'medium'}]});setNewTopic('')};

// NEW: Enhanced CSV Import with multi-school support
const handleCSVImport=e=>{
  const file=e.target.files[0];
  if(!file)return;

  // Validate school selection
  if(selectedSchoolsForImport.length===0){
    alert('Please select at least one school');
    if(fileInputRef.current)fileInputRef.current.value='';
    return;
  }

  Papa.parse(file,{
    complete:async results=>{
      try{
        setIsImporting(true);
        const rows=results.data;
        if(rows.length<2){
          alert('CSV file is empty');
          setIsImporting(false);
          return;
        }

        let currentChapter=null;
        const chaptersToAdd=[];

        rows.forEach((row,index)=>{
          if(index===0)return; // Skip header

          const chapterName=row[0]?row[0].trim():'';
          const topicName=row[1]?row[1].trim():'';
          const targetDate=row[2]?row[2].trim():''; // Column C for target date
          const priorityRaw=row[3]?row[3].trim().toLowerCase():''; // Column D for priority

          // Parse priority - accept variations like "High", "HIGH", "high", "H", "1", etc.
          let priority='medium'; // default
          if(priorityRaw==='high'||priorityRaw==='h'||priorityRaw==='1'||priorityRaw==='üü¢'){
            priority='high';
          }else if(priorityRaw==='medium'||priorityRaw==='med'||priorityRaw==='m'||priorityRaw==='2'||priorityRaw==='üü°'){
            priority='medium';
          }else if(priorityRaw==='low'||priorityRaw==='l'||priorityRaw==='3'||priorityRaw==='üî¥'){
            priority='low';
          }

          if(chapterName){
            // New chapter row - chapter gets its own priority
            if(currentChapter){
              chaptersToAdd.push(currentChapter);
            }
            currentChapter={
              name:chapterName,
              topics:topicName?[{name:topicName,priority:priority}]:[],
              targetDate:targetDate||'',
              priority:priority // Chapter-level priority
            };
          }else if(topicName&&currentChapter){
            // Topic row - each topic gets its own priority from Column D
            currentChapter.topics.push({name:topicName,priority:priority});
          }
        });

        if(currentChapter){
          chaptersToAdd.push(currentChapter);
        }

        if(chaptersToAdd.length===0){
          alert('No valid chapters found in CSV');
          setIsImporting(false);
          return;
        }

        // NEW: Import to ALL selected schools
        let totalImported = 0;
        const failedSchools = [];
        
        for(const school of selectedSchoolsForImport){
          try{
            for(const chapter of chaptersToAdd){
              await addChapter(school,importSubject,importGrade,chapter);
            }
            totalImported++;
          }catch(err){
            failedSchools.push(school);
            console.error(`Failed to import to ${school}:`,err);
          }
        }

        setIsImporting(false);
        
        if(failedSchools.length > 0){
          alert(`Imported ${chaptersToAdd.length} chapters to ${totalImported} schools.\nFailed for: ${failedSchools.join(', ')}`);
        }else{
          alert(`‚úÖ Successfully imported ${chaptersToAdd.length} chapters to ${selectedSchoolsForImport.length} school(s):\n${selectedSchoolsForImport.join(', ')}`);
        }
        
        if(fileInputRef.current)fileInputRef.current.value='';
      }catch(e){
        setIsImporting(false);
        alert('Import failed: '+e.message);
      }
    },
    error:()=>{
      setIsImporting(false);
      alert('Failed to parse CSV');
    }
  });
};

return(<div className="space-y-6"><h2 className="text-3xl font-bold">Curriculum Management</h2>

{/* NEW: Bulk Import Section with Multi-School Checkboxes */}
<div className="bg-white p-6 rounded-2xl shadow-lg border-2 border-green-200">
  <div className="flex justify-between items-center mb-4">
    <h3 className="text-xl font-bold text-green-700">üì§ Bulk Import Curriculum</h3>
    <button 
      onClick={()=>setShowBulkImport(!showBulkImport)} 
      className="px-4 py-2 bg-green-100 text-green-700 rounded-lg font-semibold hover:bg-green-200"
    >
      {showBulkImport ? '‚ñ≤ Hide' : '‚ñº Expand'}
    </button>
  </div>
  
  {showBulkImport && (
    <div className="space-y-4">
      {/* School Checkboxes */}
      <div>
        <div className="flex justify-between items-center mb-2">
          <label className="block text-sm font-bold">Select Schools (can select multiple)</label>
          <div className="flex gap-2">
            <button onClick={selectAllSchools} className="text-xs px-3 py-1 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200">Select All</button>
            <button onClick={deselectAllSchools} className="text-xs px-3 py-1 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200">Clear All</button>
          </div>
        </div>
        <div className="grid grid-cols-2 md:grid-cols-3 gap-2 p-3 bg-gray-50 rounded-xl">
          {SCHOOLS.map(school=>(
            <label key={school} className={`flex items-center gap-2 p-2 rounded-lg cursor-pointer transition-all ${selectedSchoolsForImport.includes(school)?'bg-green-100 border-2 border-green-400':'bg-white border-2 border-gray-200 hover:border-gray-300'}`}>
              <input 
                type="checkbox" 
                checked={selectedSchoolsForImport.includes(school)}
                onChange={()=>toggleSchoolSelection(school)}
                className="w-5 h-5"
              />
              <span className={`text-sm font-medium ${selectedSchoolsForImport.includes(school)?'text-green-700':'text-gray-700'}`}>{school}</span>
            </label>
          ))}
        </div>
        <p className="text-xs text-gray-500 mt-1">Selected: {selectedSchoolsForImport.length} school(s)</p>
      </div>
      
      {/* Subject and Grade */}
      <div className="grid md:grid-cols-2 gap-4">
        <div>
          <label className="block text-sm font-bold mb-2">Subject</label>
          <select value={importSubject} onChange={e=>setImportSubject(e.target.value)} className="w-full border-2 px-4 py-3 rounded-xl">
            {SUBJECTS.map(s=><option key={s} value={s}>{s}</option>)}
          </select>
        </div>
        <div>
          <label className="block text-sm font-bold mb-2">Grade</label>
          <select value={importGrade} onChange={e=>setImportGrade(e.target.value)} className="w-full border-2 px-4 py-3 rounded-xl">
            <option value="11">Class 11</option>
            <option value="12">Class 12</option>
          </select>
        </div>
      </div>
      
      {/* Import Button */}
      <div className="flex gap-3">
        <label className={`flex-1 px-6 py-4 ${selectedSchoolsForImport.length>0&&!isImporting?'bg-green-600 hover:bg-green-700 cursor-pointer':'bg-gray-400 cursor-not-allowed'} text-white rounded-xl font-semibold text-center transition-all`}>
          {isImporting ? (
            <span className="flex items-center justify-center gap-2">
              <svg className="animate-spin h-5 w-5" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" fill="none"/><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/></svg>
              Importing...
            </span>
          ) : (
            `üì§ Import CSV to ${selectedSchoolsForImport.length} School(s)`
          )}
          <input 
            ref={fileInputRef} 
            type="file" 
            accept=".csv" 
            onChange={handleCSVImport} 
            disabled={selectedSchoolsForImport.length===0||isImporting}
            className="hidden"
          />
        </label>
      </div>
      
      {selectedSchoolsForImport.length > 0 && (
        <div className="p-3 bg-green-50 rounded-xl">
          <p className="text-sm text-green-700"><strong>Will import to:</strong> {selectedSchoolsForImport.join(', ')}</p>
          <p className="text-sm text-green-600"><strong>Subject:</strong> {importSubject} | <strong>Grade:</strong> Class {importGrade}</p>
        </div>
      )}
    </div>
  )}
</div>

{/* Existing View/Edit Section */}
<div className="bg-white p-6 rounded-2xl shadow-lg">
<h3 className="text-lg font-bold text-gray-700 mb-4">üìù View & Edit Chapters</h3>
<div className="grid md:grid-cols-3 gap-4 mb-4"><div><label className="block text-sm font-bold mb-2">School</label><select value={selectedSchool} onChange={e=>setSelectedSchool(e.target.value)} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed">{SCHOOLS.map(s=><option key={s} value={s}>{s}</option>)}</select></div><div><label className="block text-sm font-bold mb-2">Subject</label><select value={selectedSubject} onChange={e=>setSelectedSubject(e.target.value)} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed">{SUBJECTS.map(s=><option key={s} value={s}>{s}</option>)}</select></div><div><label className="block text-sm font-bold mb-2">Grade</label><select value={selectedGrade} onChange={e=>setSelectedGrade(e.target.value)} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"><option value="11">Class 11</option><option value="12">Class 12</option></select></div></div><div className="flex gap-3"><button onClick={()=>{setEditingChapter(null);setChapterForm({name:'',topics:[],targetDate:'',priority:'medium'});setShowAddForm(!showAddForm)}} className="px-6 py-3 bg-blue-600 text-white rounded-xl font-semibold">{showAddForm?'Cancel':'+ Add Chapter'}</button></div>

{/* CSV Format Guide */}
<div className="mt-4 p-4 bg-blue-50 border-2 border-blue-200 rounded-xl">
  <p className="font-bold text-blue-800 mb-2">üìã CSV Import Format (4 columns) - Supports Topic-Level Priorities:</p>
  <div className="text-sm text-blue-700 space-y-1">
    <p><strong>Column A:</strong> Chapter Name (leave blank for topics under same chapter)</p>
    <p><strong>Column B:</strong> Topic Name</p>
    <p><strong>Column C:</strong> Target Date (YYYY-MM-DD format, only for chapter rows)</p>
    <p><strong>Column D:</strong> Priority (High, Medium, Low) - <span className="font-bold text-green-700">Works for BOTH chapters AND individual topics!</span></p>
  </div>
  <div className="mt-3 bg-white p-3 rounded-lg text-xs font-mono overflow-x-auto">
    <table className="w-full border-collapse">
      <thead>
        <tr className="bg-gray-100">
          <th className="border p-1 text-left">Chapter Name</th>
          <th className="border p-1 text-left">Topic Name</th>
          <th className="border p-1 text-left">Target Date</th>
          <th className="border p-1 text-left">Priority</th>
        </tr>
      </thead>
      <tbody>
        <tr className="bg-green-50"><td className="border p-1 font-bold">Laws of Motion</td><td className="border p-1">Newton's First Law</td><td className="border p-1">2025-02-15</td><td className="border p-1 text-green-700 font-bold">High</td></tr>
        <tr><td className="border p-1"></td><td className="border p-1">Newton's Second Law</td><td className="border p-1"></td><td className="border p-1 text-green-700">High</td></tr>
        <tr><td className="border p-1"></td><td className="border p-1">Newton's Third Law</td><td className="border p-1"></td><td className="border p-1 text-yellow-700">Medium</td></tr>
        <tr className="bg-yellow-50"><td className="border p-1 font-bold">Thermodynamics</td><td className="border p-1">First Law</td><td className="border p-1">2025-03-01</td><td className="border p-1 text-yellow-700 font-bold">Medium</td></tr>
        <tr><td className="border p-1"></td><td className="border p-1">Second Law</td><td className="border p-1"></td><td className="border p-1 text-red-700">Low</td></tr>
        <tr><td className="border p-1"></td><td className="border p-1">Carnot Engine</td><td className="border p-1"></td><td className="border p-1 text-green-700">High</td></tr>
      </tbody>
    </table>
  </div>
  <div className="mt-2 space-y-1 text-xs">
    <p className="text-blue-600">üí° <strong>Priority accepts:</strong> High/H/1 (üü¢), Medium/Med/M/2 (üü°), Low/L/3 (üî¥). Default is Medium.</p>
    <p className="text-green-700">‚úÖ <strong>Each topic can have its own priority!</strong> Just add the priority in Column D for each topic row.</p>
  </div>
</div>

</div>{showAddForm&&<div className="bg-white p-6 rounded-2xl shadow-lg"><h4 className="text-xl font-bold mb-4">{editingChapter?'Edit Chapter':'Add New Chapter'}</h4><div className="space-y-4"><div><label className="block text-sm font-bold mb-2">Chapter Name *</label><input type="text" value={chapterForm.name} onChange={e=>setChapterForm({...chapterForm,name:e.target.value})} className="w-full border-2 px-4 py-3 rounded-xl"/></div><div><label className="block text-sm font-bold mb-2">Target Date</label><input type="date" value={chapterForm.targetDate} onChange={e=>setChapterForm({...chapterForm,targetDate:e.target.value})} className="w-full border-2 px-4 py-3 rounded-xl"/></div><div>
  <label className="block text-sm font-bold mb-2">Priority Level</label>
  <select 
    value={chapterForm.priority||'medium'} 
    onChange={e=>setChapterForm({...chapterForm,priority:e.target.value})} 
    className="w-full border-2 px-4 py-3 rounded-xl"
  >
    <option value="high">üü¢ High Priority</option>
    <option value="medium">üü° Medium Priority</option>
    <option value="low">üî¥ Low Priority</option>
  </select>
</div><div><label className="block text-sm font-bold mb-2">Topics</label><div className="flex gap-2 mb-3"><input type="text" value={newTopic} onChange={e=>setNewTopic(e.target.value)} onKeyPress={e=>e.key==='Enter'&&handleAddTopic()} className="flex-1 border-2 px-4 py-3 rounded-xl" placeholder="Enter topic"/><button onClick={handleAddTopic} className="px-6 py-3 bg-blue-600 text-white rounded-xl">Add</button></div><div className="space-y-2">{chapterForm.topics.map((topic,idx)=>{
  const topicName = typeof topic === 'string' ? topic : topic.name;
  const topicPriority = typeof topic === 'string' ? 'medium' : (topic.priority || 'medium');
  return (
    <div key={idx} className="flex justify-between items-center p-3 bg-gray-50 rounded-lg gap-2">
      <span className="flex-1">{topicName}</span>
      <select 
        value={topicPriority}
        onChange={(e)=>{
          const updated = [...chapterForm.topics];
          updated[idx] = {name: topicName, priority: e.target.value};
          setChapterForm({...chapterForm, topics: updated});
        }}
        className="border px-2 py-1 rounded-lg text-sm"
      >
        <option value="high">üü¢ High</option>
        <option value="medium">üü° Medium</option>
        <option value="low">üî¥ Low</option>
      </select>
      <button onClick={()=>{const updated=chapterForm.topics.filter((_,i)=>i!==idx);setChapterForm({...chapterForm,topics:updated})}} className="px-3 py-1 bg-red-500 text-white rounded-lg">Remove</button>
    </div>
  );
})}</div></div><button onClick={handleSaveChapter} className="px-6 py-3 avanti-gradient text-white rounded-xl font-semibold">{editingChapter?'Update Chapter':'Save Chapter'}</button></div></div>}<div className="bg-white p-6 rounded-2xl shadow-lg"><div className="flex flex-wrap justify-between items-center gap-3 mb-4"><h4 className="text-xl font-bold">{selectedSchool} - {selectedSubject} - Class {selectedGrade} ({chapters.length} chapters)</h4>{chapters.length>0&&<div className="flex flex-wrap gap-2 items-center"><span className="text-sm text-gray-600 mr-2">{selectedChaptersForDelete.length} selected</span><button onClick={selectAllChapters} className="px-3 py-1 bg-blue-100 text-blue-700 rounded-lg text-sm font-semibold hover:bg-blue-200">Select All</button><button onClick={deselectAllChapters} className="px-3 py-1 bg-gray-100 text-gray-700 rounded-lg text-sm font-semibold hover:bg-gray-200">Deselect All</button><button onClick={handleBulkDelete} disabled={selectedChaptersForDelete.length===0||isDeleting} className={`px-4 py-1 rounded-lg text-sm font-semibold ${selectedChaptersForDelete.length===0?'bg-gray-200 text-gray-400 cursor-not-allowed':'bg-red-500 text-white hover:bg-red-600'}`}>{isDeleting?'Deleting...':'üóëÔ∏è Delete Selected ('+selectedChaptersForDelete.length+')'}</button></div>}</div>{chapters.length===0?<p className="text-gray-500 text-center py-8">No chapters yet</p>:<div className="space-y-3">{chapters.map(ch=><div key={ch.id} className={`border-2 rounded-xl p-4 hover:bg-gray-50 ${selectedChaptersForDelete.includes(ch.id)?'bg-red-50 border-red-300':''}`}><div className="flex justify-between items-start"><div className="flex items-start gap-3"><input type="checkbox" checked={selectedChaptersForDelete.includes(ch.id)} onChange={()=>toggleChapterSelection(ch.id)} className="mt-1 w-5 h-5 cursor-pointer"/><div className="flex-1"><h5 className="font-bold text-lg">{ch.name}</h5><p className="text-sm text-gray-600">Target: {ch.targetDate||'Not set'} | Topics: {ch.topics?.length||0}</p><div className="mt-2">
    {(ch.priority==='high'||!ch.priority)&&(
      <span className="priority-badge priority-high text-xs">üü¢ High Priority</span>
    )}
    {ch.priority==='medium'&&(
      <span className="priority-badge priority-medium text-xs">üü° Medium Priority</span>
    )}
    {ch.priority==='low'&&(
      <span className="priority-badge priority-low text-xs">üî¥ Low Priority</span>
    )}
  </div>{ch.topics&&ch.topics.length>0&&<ul className="text-xs text-gray-600 ml-4 mt-2">{ch.topics.map((t,i)=>{
    const topicName = typeof t === 'string' ? t : t.name;
    const topicPriority = typeof t === 'string' ? 'medium' : (t.priority || 'medium');
    const priorityIcon = topicPriority === 'high' ? 'üü¢' : topicPriority === 'medium' ? 'üü°' : 'üî¥';
    return <li key={i}>‚Ä¢ {topicName} <span className="ml-1">{priorityIcon}</span></li>;
  })}</ul>}</div></div><div className="flex gap-2 mt-2 md:mt-0 flex-shrink-0"><button onClick={()=>handleEditChapter(ch)} className="px-3 py-1 bg-yellow-400 rounded-lg">Edit</button><button onClick={()=>deleteChapter(selectedSchool,selectedSubject,selectedGrade,ch.id)} className="px-3 py-1 bg-red-500 text-white rounded-lg">Delete</button></div></div></div>)}</div>}</div></div>)}
function AdminAnalytics({teachers,curriculum,chapterProgress,accessibleSchools = SCHOOLS,isSuperAdmin = false}){
  // Available schools for dropdown
  const availableSchoolOptions = isSuperAdmin ? SCHOOLS : accessibleSchools;
  
  // Multi-select: Use arrays instead of single values
  const initialSchools = isSuperAdmin ? [...SCHOOLS] : [...accessibleSchools];
  const[filterSchools,setFilterSchools]=useState(initialSchools);
  const[filterGrade,setFilterGrade]=useState('All');
  const[filterTeachers,setFilterTeachers]=useState([]);

  // Filter teachers based on selected schools
  const availableTeachers = useMemo(() => {
    if (filterSchools.length === 0) return [];
    return teachers.filter(t => filterSchools.includes(t.school));
  }, [teachers, filterSchools]);

  // Reset teacher selection when schools change
  React.useEffect(() => {
    const validTeachers = filterTeachers.filter(afid => 
      availableTeachers.some(t => t.afid === afid)
    );
    if (validTeachers.length !== filterTeachers.length) {
      setFilterTeachers(validTeachers);
    }
  }, [availableTeachers]);

  const chart1Ref=useRef(null);
  const chart2Ref=useRef(null);
  const chart3Ref=useRef(null);
  const chart4Ref=useRef(null);
  const chart5Ref=useRef(null);
  const chart6Ref=useRef(null);
  const chart7Ref=useRef(null);
  const chart8Ref=useRef(null);

  const chartInstances=useRef({});

  const filteredData=useMemo(()=>{
  const data={
    totalChapters:0,
    completedChapters:0,
    delayedChapters:0,
    aheadChapters:0,
    testsCompleted:0,
    testsPending:0,
    schoolData:{},
    subjectData:{},
    gradeData:{},
    teacherData:{},
    statusData:{ahead:0,ontrack:0,delayed:0,pending:0},
    testData:{completed:0,pending:0}
  };

  // Multi-select: Use selected schools array directly
  const schoolsToProcess = filterSchools.length > 0 ? filterSchools : [];
  const gradesToProcess=filterGrade==='All'?['11','12']:[filterGrade];
  // Multi-select: Filter teachers based on selection
  const teachersFiltered = filterTeachers.length === 0 
    ? teachers.filter(t => schoolsToProcess.includes(t.school))
    : teachers.filter(t => filterTeachers.includes(t.afid));

  schoolsToProcess.forEach(school=>{
    if(!data.schoolData[school]){
      data.schoolData[school]={total:0,completed:0,delayed:0,ahead:0,tests:0,testsPending:0};
    }

    SUBJECTS.forEach(subject=>{
      if(!data.subjectData[subject]){
        data.subjectData[subject]={total:0,completed:0,testsCompleted:0,testsPending:0};
      }

      gradesToProcess.forEach(grade=>{
        if(!data.gradeData[grade]){
          data.gradeData[grade]={total:0,completed:0,testsCompleted:0,testsPending:0};
        }

        const docId=`${school}_${subject}_${grade}`;
        const chapters=curriculum[docId]?.chapters||[];

        const relevantTeachers=teachersFiltered.filter(t=>t.school===school&&t.subject===subject);
        if(filterTeachers.length>0&&relevantTeachers.length===0)return;

        chapters.forEach(ch=>{
          data.totalChapters++;
          data.schoolData[school].total++;
          data.subjectData[subject].total++;
          data.gradeData[grade].total++;

          const progressId=`${school}_${ch.id}`;
          const prog=chapterProgress[progressId]||{};
          const status=getChapterStatus(ch,prog);

          if(prog.completed==='Yes'){
            data.completedChapters++;
            data.schoolData[school].completed++;
            data.subjectData[subject].completed++;
            data.gradeData[grade].completed++;

            if(prog.testConducted==='Yes'){
              data.testsCompleted++;
              data.schoolData[school].tests++;
              data.subjectData[subject].testsCompleted++;
              data.gradeData[grade].testsCompleted++;
              data.testData.completed++;
            }else{
              data.testsPending++;
              data.schoolData[school].testsPending++;
              data.subjectData[subject].testsPending++;
              data.gradeData[grade].testsPending++;
              data.testData.pending++;
            }

            if(status.class==='status-ahead'){
              data.aheadChapters++;
              data.schoolData[school].ahead++;
              data.statusData.ahead++;
            }else if(status.class==='status-ontrack'){
              data.statusData.ontrack++;
            }
          }

          if(status.label.includes('Delayed')){
            data.delayedChapters++;
            data.schoolData[school].delayed++;
            data.statusData.delayed++;
          }

          if(status.label==='Pending'){
            data.statusData.pending++;
          }
        });
      });
    });
  });

  teachersFiltered.forEach(teacher=>{
    if(!data.teacherData[teacher.afid]){
      data.teacherData[teacher.afid]={name:teacher.name,total:0,completed:0};
    }
  });

  return data;
},[curriculum,chapterProgress,teachers,filterSchools,filterGrade,filterTeachers]);

  useEffect(()=>{
    Object.values(chartInstances.current).forEach(chart=>{
      if(chart)chart.destroy();
    });
    chartInstances.current={};

    if(chart1Ref.current){
      const ctx=chart1Ref.current.getContext('2d');
      const schools=Object.keys(filteredData.schoolData);
      chartInstances.current.chart1=new Chart(ctx,{
        type:'bar',
        data:{
          labels:schools,
          datasets:[{
            label:'Completion %',
            data:schools.map(s=>{
              const d=filteredData.schoolData[s];
              return d.total?Math.round((d.completed/d.total)*100):0;
            }),
            backgroundColor:'#C8342E',
            borderRadius:8
          }]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            title:{display:true,text:'School-wise Completion %',font:{size:16,weight:'bold'}},
            legend:{display:false}
          },
          scales:{y:{beginAtZero:true,max:100,ticks:{callback:v=>v+'%'}}}
        }
      });
    }

    if(chart2Ref.current){
      const ctx=chart2Ref.current.getContext('2d');
      const subjects=Object.keys(filteredData.subjectData);
      chartInstances.current.chart2=new Chart(ctx,{
        type:'pie',
        data:{
          labels:subjects,
          datasets:[{
            data:subjects.map(s=>filteredData.subjectData[s].completed),
            backgroundColor:['#F4B41A','#3B82F6','#10B981','#EF4444'],
            borderWidth:2
          }]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            title:{display:true,text:'Completed Chapters by Subject',font:{size:16,weight:'bold'}},
            legend:{position:'bottom'}
          }
        }
      });
    }

    if(chart3Ref.current){
      const ctx=chart3Ref.current.getContext('2d');
      const grades=Object.keys(filteredData.gradeData);
      chartInstances.current.chart3=new Chart(ctx,{
        type:'bar',
        data:{
          labels:grades.map(g=>`Class ${g}`),
          datasets:[
            {
              label:'Completed',
              data:grades.map(g=>filteredData.gradeData[g].completed),
              backgroundColor:'#10B981'
            },
            {
              label:'Pending',
              data:grades.map(g=>filteredData.gradeData[g].total-filteredData.gradeData[g].completed),
              backgroundColor:'#F59E0B'
            }
          ]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            title:{display:true,text:'Grade-wise Progress',font:{size:16,weight:'bold'}},
            legend:{position:'bottom'}
          },
          scales:{x:{stacked:true},y:{stacked:true,beginAtZero:true}}
        }
      });
    }

    if(chart4Ref.current){
      const ctx=chart4Ref.current.getContext('2d');
      chartInstances.current.chart4=new Chart(ctx,{
        type:'doughnut',
        data:{
          labels:['Completed','Pending','Delayed'],
          datasets:[{
            data:[
              filteredData.completedChapters,
              filteredData.totalChapters-filteredData.completedChapters-filteredData.delayedChapters,
              filteredData.delayedChapters
            ],
            backgroundColor:['#10B981','#F59E0B','#EF4444'],
            borderWidth:0
          }]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            title:{display:true,text:'Overall Chapter Status',font:{size:16,weight:'bold'}},
            legend:{position:'bottom'}
          }
        }
      });
    }

    if(chart5Ref.current){
      const ctx=chart5Ref.current.getContext('2d');
      chartInstances.current.chart5=new Chart(ctx,{
        type:'pie',
        data:{
          labels:['Tests Completed','Tests Pending'],
          datasets:[{
            data:[filteredData.testsCompleted,filteredData.testsPending],
            backgroundColor:['#3B82F6','#F97316'],
            borderWidth:2
          }]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            title:{display:true,text:'Chapter Tests Status',font:{size:16,weight:'bold'}},
            legend:{position:'bottom'}
          }
        }
      });
    }

    if(chart6Ref.current){
      const ctx=chart6Ref.current.getContext('2d');
      chartInstances.current.chart6=new Chart(ctx,{
        type:'bar',
        data:{
          labels:['Ahead','On Track','Delayed','Pending'],
          datasets:[{
            label:'Chapters',
            data:[
              filteredData.statusData.ahead,
              filteredData.statusData.ontrack,
              filteredData.statusData.delayed,
              filteredData.statusData.pending
            ],
            backgroundColor:['#10B981','#3B82F6','#F97316','#EF4444'],
            borderRadius:8
          }]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            title:{display:true,text:'Performance Status Distribution',font:{size:16,weight:'bold'}},
            legend:{display:false}
          },
          scales:{y:{beginAtZero:true}}
        }
      });
    }

    if(chart7Ref.current){
      const ctx=chart7Ref.current.getContext('2d');
      const schools=Object.keys(filteredData.schoolData);
      chartInstances.current.chart7=new Chart(ctx,{
        type:'bar',
        data:{
          labels:schools,
          datasets:[{
            label:'Delayed Chapters',
            data:schools.map(s=>filteredData.schoolData[s].delayed),
            backgroundColor:'#EF4444',
            borderRadius:6
          }]
        },
        options:{
          indexAxis:'y',
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            title:{display:true,text:'Delayed Chapters by School',font:{size:16,weight:'bold'}},
            legend:{display:false}
          },
          scales:{x:{beginAtZero:true}}
        }
      });
    }

    if(chart8Ref.current){
      const ctx=chart8Ref.current.getContext('2d');
      const subjects=Object.keys(filteredData.subjectData);
      chartInstances.current.chart8=new Chart(ctx,{
        type:'doughnut',
        data:{
          labels:subjects.map(s=>`${s} - ${filteredData.subjectData[s].total?Math.round((filteredData.subjectData[s].completed/filteredData.subjectData[s].total)*100):0}%`),
          datasets:[{
            data:subjects.map(s=>filteredData.subjectData[s].completed),
            backgroundColor:['#F4B41A','#3B82F6','#10B981','#EF4444'],
            borderWidth:2
          }]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            title:{display:true,text:'Subject-wise Completion Rate',font:{size:16,weight:'bold'}},
            legend:{position:'bottom'}
          }
        }
      });
    }

    return()=>{
      Object.values(chartInstances.current).forEach(chart=>{
        if(chart)chart.destroy();
      });
    };
  },[filteredData]);

  const handleExport=()=>{
    // Create workbook with multiple sheets
    const wb = XLSX.utils.book_new();
    
    // Sheet 1: School-wise Summary
    const schoolData = Object.keys(filteredData.schoolData).map(school=>({
      School: school,
      'Total Chapters': filteredData.schoolData[school].total,
      'Completed': filteredData.schoolData[school].completed,
      'Delayed': filteredData.schoolData[school].delayed,
      'Ahead': filteredData.schoolData[school].ahead,
      'Tests Completed': filteredData.schoolData[school].tests,
      'Tests Pending': filteredData.schoolData[school].testsPending,
      'Completion %': filteredData.schoolData[school].total ? Math.round((filteredData.schoolData[school].completed/filteredData.schoolData[school].total)*100) : 0
    }));
    const wsSchool = XLSX.utils.json_to_sheet(schoolData);
    XLSX.utils.book_append_sheet(wb, wsSchool, "School Summary");
    
    // Sheet 2: Subject-wise Summary
    const subjectData = Object.keys(filteredData.subjectData).map(subject=>({
      Subject: subject,
      'Total Chapters': filteredData.subjectData[subject].total,
      'Completed': filteredData.subjectData[subject].completed,
      'Tests Completed': filteredData.subjectData[subject].testsCompleted,
      'Tests Pending': filteredData.subjectData[subject].testsPending,
      'Completion %': filteredData.subjectData[subject].total ? Math.round((filteredData.subjectData[subject].completed/filteredData.subjectData[subject].total)*100) : 0
    }));
    const wsSubject = XLSX.utils.json_to_sheet(subjectData);
    XLSX.utils.book_append_sheet(wb, wsSubject, "Subject Summary");
    
    // Sheet 3: Grade-wise Summary
    const gradeData = Object.keys(filteredData.gradeData).map(grade=>({
      Grade: `Class ${grade}`,
      'Total Chapters': filteredData.gradeData[grade].total,
      'Completed': filteredData.gradeData[grade].completed,
      'Tests Completed': filteredData.gradeData[grade].testsCompleted,
      'Tests Pending': filteredData.gradeData[grade].testsPending,
      'Completion %': filteredData.gradeData[grade].total ? Math.round((filteredData.gradeData[grade].completed/filteredData.gradeData[grade].total)*100) : 0
    }));
    const wsGrade = XLSX.utils.json_to_sheet(gradeData);
    XLSX.utils.book_append_sheet(wb, wsGrade, "Grade Summary");
    
    // Sheet 4: Teacher-wise Detailed Data
    const teacherDetailedData = [];
    const teachersToExport = filterTeachers.length > 0 
      ? teachers.filter(t => filterTeachers.includes(t.afid))
      : teachers.filter(t => filterSchools.includes(t.school));
    
    teachersToExport.forEach(teacher => {
      const gradesToProcess = filterGrade === 'All' ? ['11', '12'] : [filterGrade];
      let teacherTotal = 0, teacherCompleted = 0, teacherTests = 0, teacherDelayed = 0;
      
      gradesToProcess.forEach(grade => {
        const docId = `${teacher.school}_${teacher.subject}_${grade}`;
        const chapters = curriculum[docId]?.chapters || [];
        
        chapters.forEach(ch => {
          teacherTotal++;
          const progressId = `${teacher.school}_${ch.id}`;
          const prog = chapterProgress[progressId] || {};
          const status = getChapterStatus(ch, prog);
          
          if (prog.completed === 'Yes') {
            teacherCompleted++;
            if (prog.testConducted === 'Yes') teacherTests++;
          }
          if (status.label.includes('Delayed')) teacherDelayed++;
        });
      });
      
      if (teacherTotal > 0) {
        teacherDetailedData.push({
          'Teacher Name': teacher.name,
          'AFID': teacher.afid,
          'School': teacher.school,
          'Subject': teacher.subject,
          'Total Chapters': teacherTotal,
          'Completed': teacherCompleted,
          'Delayed': teacherDelayed,
          'Tests Completed': teacherTests,
          'Tests Pending': teacherCompleted - teacherTests,
          'Completion %': Math.round((teacherCompleted/teacherTotal)*100)
        });
      }
    });
    
    if (teacherDetailedData.length > 0) {
      const wsTeacher = XLSX.utils.json_to_sheet(teacherDetailedData);
      XLSX.utils.book_append_sheet(wb, wsTeacher, "Teacher Summary");
    }
    
    // Sheet 5: Overall Summary
    const overallData = [{
      'Total Chapters': filteredData.totalChapters,
      'Completed': filteredData.completedChapters,
      'Delayed': filteredData.delayedChapters,
      'Ahead': filteredData.aheadChapters,
      'Tests Completed': filteredData.testsCompleted,
      'Tests Pending': filteredData.testsPending,
      'Overall Completion %': filteredData.totalChapters ? Math.round((filteredData.completedChapters/filteredData.totalChapters)*100) : 0,
      'Schools Selected': filterSchools.join(', '),
      'Grade Filter': filterGrade,
      'Teachers Selected': filterTeachers.length === 0 ? 'All' : filterTeachers.length + ' teachers'
    }];
    const wsOverall = XLSX.utils.json_to_sheet(overallData);
    XLSX.utils.book_append_sheet(wb, wsOverall, "Overall Summary");
    
    // Save the workbook
    XLSX.writeFile(wb, `analytics_report_${new Date().toISOString().slice(0,10)}.xlsx`);
  };

  return(
    <div className="space-y-6">
      <div className="flex justify-between items-center">
        <h2 className="text-3xl font-bold">üìä Analytics Dashboard</h2>
        <button onClick={handleExport} className="px-6 py-3 bg-green-600 text-white rounded-xl font-semibold">
          üì• Export Filtered Data
        </button>
      </div>

      <div className="bg-white p-6 rounded-2xl shadow-lg">
        <h3 className="text-xl font-bold mb-4">üîç Filters (Apply to All Charts)</h3>
        <div className="grid md:grid-cols-3 gap-4">
          <div>
            <label className="block text-sm font-bold mb-2">Schools ({filterSchools.length}/{availableSchoolOptions.length})</label>
            <MultiSelectDropdown
              options={availableSchoolOptions}
              selected={filterSchools}
              onChange={setFilterSchools}
              placeholder="Select Schools..."
            />
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">Grade</label>
            <select 
              value={filterGrade} 
              onChange={e=>setFilterGrade(e.target.value)}
              className="w-full border-2 px-4 py-3 rounded-xl"
            >
              <option value="All">All Grades</option>
              <option value="11">Class 11</option>
              <option value="12">Class 12</option>
            </select>
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">Teachers ({filterTeachers.length === 0 ? 'All' : filterTeachers.length}/{availableTeachers.length})</label>
            <MultiSelectDropdown
              options={availableTeachers}
              selected={filterTeachers}
              onChange={setFilterTeachers}
              placeholder="All Teachers"
              getOptionLabel={(t) => `${t.name} (${t.school})`}
              getOptionValue={(t) => t.afid}
              disabled={filterSchools.length === 0}
            />
          </div>
        </div>
        {filterSchools.length === 0 && (
          <p className="text-orange-600 mt-2 text-sm">‚ö†Ô∏è Please select at least one school to see data</p>
        )}
      </div>

      <div className="bg-white p-6 rounded-2xl shadow-lg">
        <h3 className="text-xl font-bold mb-4">üìä Overall Progress Summary</h3>
        <div className="grid grid-cols-2 md:grid-cols-5 gap-4">
          <div className="stat-card avanti-gradient text-white">
            <div className="text-sm opacity-90">Total Chapters</div>
            <div className="text-4xl font-bold">{filteredData.totalChapters}</div>
          </div>
          <div className="stat-card bg-green-500 text-white">
            <div className="text-sm opacity-90">Completed</div>
            <div className="text-3xl font-bold">{filteredData.completedChapters}/{filteredData.totalChapters}</div>
            <div className="text-lg font-semibold mt-1">
              {filteredData.totalChapters?Math.round((filteredData.completedChapters/filteredData.totalChapters)*100):0}%
            </div>
          </div>
          <div className="stat-card bg-blue-500 text-white">
            <div className="text-sm opacity-90">Tests Completed</div>
            <div className="text-3xl font-bold">{filteredData.testsCompleted}/{filteredData.completedChapters}</div>
            <div className="text-lg font-semibold mt-1">
              {filteredData.completedChapters?Math.round((filteredData.testsCompleted/filteredData.completedChapters)*100):0}%
            </div>
          </div>
          <div className="stat-card bg-purple-500 text-white">
            <div className="text-sm opacity-90">Tests Pending</div>
            <div className="text-4xl font-bold">{filteredData.testsPending}</div>
          </div>
          <div className="stat-card bg-orange-500 text-white">
            <div className="text-sm opacity-90">Delayed</div>
            <div className="text-3xl font-bold">{filteredData.delayedChapters}</div>
          </div>
        </div>
      </div>

      <div className="bg-white p-6 rounded-2xl shadow-lg">
        <h3 className="text-xl font-bold mb-4">üìö Grade-wise Breakdown</h3>
        <div className="grid md:grid-cols-2 gap-6">
          <div className="border-4 border-green-500 rounded-2xl p-6 bg-gradient-to-br from-green-50 to-emerald-50">
            <h4 className="text-2xl font-bold text-green-800 mb-4">üìó Class 11</h4>
            <div className="space-y-3">
              <div className="flex justify-between items-center p-3 bg-white rounded-lg shadow">
                <span className="font-semibold">Total Chapters:</span>
                <span className="text-2xl font-bold text-gray-800">{filteredData.gradeData['11']?.total||0}</span>
              </div>
              <div className="flex justify-between items-center p-3 bg-white rounded-lg shadow">
                <span className="font-semibold">Completed:</span>
                <span className="text-2xl font-bold text-green-600">{filteredData.gradeData['11']?.completed||0}</span>
              </div>
              <div className="flex justify-between items-center p-3 bg-white rounded-lg shadow">
                <span className="font-semibold">Tests Completed:</span>
                <span className="text-2xl font-bold text-blue-600">{filteredData.gradeData['11']?.testsCompleted||0}</span>
              </div>
              <div className="flex justify-between items-center p-3 bg-white rounded-lg shadow">
                <span className="font-semibold">Tests Pending:</span>
                <span className="text-2xl font-bold text-red-600">{filteredData.gradeData['11']?.testsPending||0}</span>
              </div>
              <div className="mt-4 p-4 bg-green-600 text-white rounded-xl text-center">
                <div className="text-sm opacity-90">Completion Rate</div>
                <div className="text-4xl font-bold">
                  {filteredData.gradeData['11']?.total?Math.round((filteredData.gradeData['11'].completed/filteredData.gradeData['11'].total)*100):0}%
                </div>
              </div>
            </div>
          </div>

          <div className="border-4 border-blue-500 rounded-2xl p-6 bg-gradient-to-br from-blue-50 to-cyan-50">
            <h4 className="text-2xl font-bold text-blue-800 mb-4">üìò Class 12</h4>
            <div className="space-y-3">
              <div className="flex justify-between items-center p-3 bg-white rounded-lg shadow">
                <span className="font-semibold">Total Chapters:</span>
                <span className="text-2xl font-bold text-gray-800">{filteredData.gradeData['12']?.total||0}</span>
              </div>
              <div className="flex justify-between items-center p-3 bg-white rounded-lg shadow">
                <span className="font-semibold">Completed:</span>
                <span className="text-2xl font-bold text-green-600">{filteredData.gradeData['12']?.completed||0}</span>
              </div>
              <div className="flex justify-between items-center p-3 bg-white rounded-lg shadow">
                <span className="font-semibold">Tests Completed:</span>
                <span className="text-2xl font-bold text-blue-600">{filteredData.gradeData['12']?.testsCompleted||0}</span>
              </div>
              <div className="flex justify-between items-center p-3 bg-white rounded-lg shadow">
                <span className="font-semibold">Tests Pending:</span>
                <span className="text-2xl font-bold text-red-600">{filteredData.gradeData['12']?.testsPending||0}</span>
              </div>
              <div className="mt-4 p-4 bg-blue-600 text-white rounded-xl text-center">
                <div className="text-sm opacity-90">Completion Rate</div>
                <div className="text-4xl font-bold">
                  {filteredData.gradeData['12']?.total?Math.round((filteredData.gradeData['12'].completed/filteredData.gradeData['12'].total)*100):0}%
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div className="grid md:grid-cols-2 lg:grid-cols-2 gap-6">
        <div className="bg-white p-6 rounded-2xl shadow-lg" style={{height:'350px'}}>
          <canvas ref={chart1Ref}></canvas>
        </div>
        <div className="bg-white p-6 rounded-2xl shadow-lg" style={{height:'350px'}}>
          <canvas ref={chart2Ref}></canvas>
        </div>
        <div className="bg-white p-6 rounded-2xl shadow-lg" style={{height:'350px'}}>
          <canvas ref={chart3Ref}></canvas>
        </div>
        <div className="bg-white p-6 rounded-2xl shadow-lg" style={{height:'350px'}}>
          <canvas ref={chart4Ref}></canvas>
        </div>
        <div className="bg-white p-6 rounded-2xl shadow-lg" style={{height:'350px'}}>
          <canvas ref={chart5Ref}></canvas>
        </div>
        <div className="bg-white p-6 rounded-2xl shadow-lg" style={{height:'350px'}}>
          <canvas ref={chart6Ref}></canvas>
        </div>
        <div className="bg-white p-6 rounded-2xl shadow-lg" style={{height:'350px'}}>
          <canvas ref={chart7Ref}></canvas>
        </div>
        <div className="bg-white p-6 rounded-2xl shadow-lg" style={{height:'350px'}}>
          <canvas ref={chart8Ref}></canvas>
        </div>
      </div>
    </div>
  );
}

function AdminChapterDetails({curriculum,chapterProgress}){const[filterSchool,setFilterSchool]=useState('All');const[filterSubject,setFilterSubject]=useState('All');const[filterGrade,setFilterGrade]=useState('All');const chapterDetails=useMemo(()=>{const details=[];const schoolsToProcess=filterSchool==='All'?SCHOOLS:[filterSchool];const subjectsToProcess=filterSubject==='All'?SUBJECTS:[filterSubject];const gradesToProcess=filterGrade==='All'?['11','12']:[filterGrade];schoolsToProcess.forEach(school=>{subjectsToProcess.forEach(subject=>{gradesToProcess.forEach(grade=>{const docId=`${school}_${subject}_${grade}`;const chapters=curriculum[docId]?.chapters||[];chapters.forEach(ch=>{const progressId=`${school}_${ch.id}`;const prog=chapterProgress[progressId]||{};details.push({school,subject,grade:`Class ${grade}`,chapterName:ch.name,targetDate:ch.targetDate||'‚Äî',completed:prog.completed||'No',completionDate:prog.completionDate||'‚Äî',testConducted:prog.testConducted||'No',notes:prog.notes||'‚Äî'})})})})});return details},[curriculum,chapterProgress,filterSchool,filterSubject,filterGrade]);const handleExport=()=>{exportToExcel(chapterDetails,'chapter_details')};return(<div className="space-y-6"><div className="flex justify-between items-center"><h2 className="text-3xl font-bold">Chapter Details</h2><button onClick={handleExport} className="px-6 py-3 bg-green-600 text-white rounded-xl font-semibold">üìä Export to Excel</button></div><div className="bg-white p-6 rounded-2xl shadow-lg"><h3 className="font-bold mb-4">Filters</h3><div className="grid md:grid-cols-3 gap-4"><div><label className="block text-sm font-bold mb-2">School</label><select value={filterSchool} onChange={e=>setFilterSchool(e.target.value)} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"><option value="All">All Schools</option>{SCHOOLS.map(s=><option key={s} value={s}>{s}</option>)}</select></div><div><label className="block text-sm font-bold mb-2">Subject</label><select value={filterSubject} onChange={e=>setFilterSubject(e.target.value)} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"><option value="All">All Subjects</option>{SUBJECTS.map(s=><option key={s} value={s}>{s}</option>)}</select></div><div><label className="block text-sm font-bold mb-2">Grade</label><select value={filterGrade} onChange={e=>setFilterGrade(e.target.value)} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"><option value="All">All Grades</option><option value="11">Class 11</option><option value="12">Class 12</option></select></div></div></div><div className="bg-white p-6 rounded-2xl shadow-lg overflow-x-auto"><h3 className="font-bold mb-4">All Chapters ({chapterDetails.length})</h3><table className="w-full"><thead className="avanti-gradient-light"><tr><th className="p-3 text-left">School</th><th className="p-3 text-left">Subject</th><th className="p-3 text-left">Grade</th><th className="p-3 text-left">Chapter Name</th><th className="p-3 text-left">Target Date</th><th className="p-3 text-left">Completed</th><th className="p-3 text-left">Completion Date</th><th className="p-3 text-left">Test Conducted</th><th className="p-3 text-left">Notes</th></tr></thead><tbody>{chapterDetails.length===0?<tr><td colSpan="9" className="p-8 text-center text-gray-500">No chapters found</td></tr>:chapterDetails.map((ch,idx)=><tr key={idx} className="border-b hover:bg-gray-50"><td className="p-3">{ch.school}</td><td className="p-3">{ch.subject}</td><td className="p-3">{ch.grade}</td><td className="p-3 font-semibold">{ch.chapterName}</td><td className="p-3 text-sm">{ch.targetDate}</td><td className="p-3"><span className={`px-2 py-1 rounded-full text-xs font-bold ${ch.completed==='Yes'?'bg-green-100 text-green-700':'bg-gray-100'}`}>{ch.completed}</span></td><td className="p-3 text-sm">{ch.completionDate}</td><td className="p-3"><span className={`px-2 py-1 rounded-full text-xs font-bold ${ch.testConducted==='Yes'?'bg-blue-100 text-blue-700':'bg-orange-100 text-orange-700'}`}>{ch.testConducted}</span></td><td className="p-3 text-sm">{ch.notes}</td></tr>)}</tbody></table></div></div>)}
// ========================================
// ========================================
// ADMIN SETTINGS COMPONENT
// ========================================
function AdminSettings() {
  const [settings, setSettings] = useState({
    // Feature Access Settings
    managerCanViewStudents: true,
    managerCanViewStudentProfiles: true,
    managerCanViewAnalytics: true,
    managerCanViewAttendance: true,
    managerCanViewObservations: true,
    managerCanExportData: true,
    teacherCanEditOwnAttendance: false,
    studentCanViewFeedback: true,
    
    // Notification Settings
    enableEmailNotifications: true,
    enablePushNotifications: true,
    notifyOnNewTeacher: true,
    notifyOnNewStudent: true,
    notifyOnAttendanceAlert: true,
    
    // Data Settings
    autoArchiveAfterDays: 365,
    dataRetentionMonths: 24,
    
    // App Settings
    appName: 'Curriculum Tracker',
    primaryColor: '#F4B41A',
    enableDarkMode: false,
    showWelcomeMessage: true,
    maintenanceMode: false
  });
  
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [successMessage, setSuccessMessage] = useState('');
  
  // Load settings from Firestore
  useEffect(() => {
    const loadSettings = async () => {
      try {
        const doc = await db.collection('app_settings').doc('global').get();
        if (doc.exists) {
          setSettings(prev => ({ ...prev, ...doc.data() }));
        }
        setLoading(false);
      } catch (e) {
        console.error('Error loading settings:', e);
        setLoading(false);
      }
    };
    loadSettings();
  }, []);
  
  const handleSave = async () => {
    setSaving(true);
    try {
      await db.collection('app_settings').doc('global').set({
        ...settings,
        updatedAt: new Date().toISOString()
      });
      setSuccessMessage('‚úÖ Settings saved successfully!');
      setTimeout(() => setSuccessMessage(''), 3000);
    } catch (e) {
      console.error('Error saving settings:', e);
      alert('‚ùå Error saving settings: ' + e.message);
    }
    setSaving(false);
  };
  
  const ToggleSwitch = ({ checked, onChange, label, description }) => (
    <div className="flex items-center justify-between py-3 border-b border-gray-100 last:border-0">
      <div>
        <div className="font-medium text-gray-800">{label}</div>
        {description && <div className="text-sm text-gray-500">{description}</div>}
      </div>
      <button
        onClick={() => onChange(!checked)}
        className={`relative inline-flex h-6 w-11 items-center rounded-full transition-colors ${
          checked ? 'bg-green-500' : 'bg-gray-300'
        }`}
      >
        <span
          className={`inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${
            checked ? 'translate-x-6' : 'translate-x-1'
          }`}
        />
      </button>
    </div>
  );
  
  if (loading) {
    return (
      <div className="text-center py-12">
        <div className="animate-spin text-4xl mb-4">‚è≥</div>
        <p>Loading settings...</p>
      </div>
    );
  }
  
  return (
    <div className="space-y-6">
      <div className="flex justify-between items-center">
        <div>
          <h2 className="text-3xl font-bold">‚öôÔ∏è Admin Settings</h2>
          <p className="text-gray-500 mt-1">Configure application settings and access controls</p>
        </div>
        <button
          onClick={handleSave}
          disabled={saving}
          className="px-6 py-3 bg-green-600 text-white rounded-xl font-semibold disabled:opacity-50"
        >
          {saving ? 'üíæ Saving...' : 'üíæ Save Settings'}
        </button>
      </div>
      
      {successMessage && (
        <div className="bg-green-50 border-2 border-green-300 p-4 rounded-xl text-green-800 font-semibold">
          {successMessage}
        </div>
      )}
      
      {/* Manager Access Controls */}
      <div className="bg-white p-6 rounded-2xl shadow-lg">
        <h3 className="text-xl font-bold mb-4 flex items-center gap-2">
          üëî Manager Access Controls
        </h3>
        <p className="text-sm text-gray-500 mb-4">Configure what managers (PM, APM, APH) can access</p>
        
        <ToggleSwitch
          checked={settings.managerCanViewStudents}
          onChange={(val) => setSettings({ ...settings, managerCanViewStudents: val })}
          label="View Student Management"
          description="Allow managers to view student list (read-only)"
        />
        <ToggleSwitch
          checked={settings.managerCanViewStudentProfiles}
          onChange={(val) => setSettings({ ...settings, managerCanViewStudentProfiles: val })}
          label="View Student Profiles"
          description="Allow managers to view detailed student profiles with demographics"
        />
        <ToggleSwitch
          checked={settings.managerCanViewAnalytics}
          onChange={(val) => setSettings({ ...settings, managerCanViewAnalytics: val })}
          label="View Analytics"
          description="Allow managers to access analytics dashboards"
        />
        <ToggleSwitch
          checked={settings.managerCanViewAttendance}
          onChange={(val) => setSettings({ ...settings, managerCanViewAttendance: val })}
          label="View Attendance"
          description="Allow managers to view attendance records"
        />
        <ToggleSwitch
          checked={settings.managerCanViewObservations}
          onChange={(val) => setSettings({ ...settings, managerCanViewObservations: val })}
          label="View Classroom Observations"
          description="Allow managers to view and create classroom observations"
        />
        <ToggleSwitch
          checked={settings.managerCanExportData}
          onChange={(val) => setSettings({ ...settings, managerCanExportData: val })}
          label="Export Data"
          description="Allow managers to export data to Excel/CSV"
        />
      </div>
      
      {/* Teacher Settings */}
      <div className="bg-white p-6 rounded-2xl shadow-lg">
        <h3 className="text-xl font-bold mb-4 flex items-center gap-2">
          üë• Teacher Settings
        </h3>
        
        <ToggleSwitch
          checked={settings.teacherCanEditOwnAttendance}
          onChange={(val) => setSettings({ ...settings, teacherCanEditOwnAttendance: val })}
          label="Edit Own Attendance"
          description="Allow teachers to modify their own attendance records"
        />
      </div>
      
      {/* Student Settings */}
      <div className="bg-white p-6 rounded-2xl shadow-lg">
        <h3 className="text-xl font-bold mb-4 flex items-center gap-2">
          üéì Student Settings
        </h3>
        
        <ToggleSwitch
          checked={settings.studentCanViewFeedback}
          onChange={(val) => setSettings({ ...settings, studentCanViewFeedback: val })}
          label="View Feedback Results"
          description="Allow students to view feedback summary for their teachers"
        />
      </div>
      
      {/* Notification Settings */}
      <div className="bg-white p-6 rounded-2xl shadow-lg">
        <h3 className="text-xl font-bold mb-4 flex items-center gap-2">
          üîî Notification Settings
        </h3>
        
        <ToggleSwitch
          checked={settings.enableEmailNotifications}
          onChange={(val) => setSettings({ ...settings, enableEmailNotifications: val })}
          label="Email Notifications"
          description="Enable email notifications for important events"
        />
        <ToggleSwitch
          checked={settings.enablePushNotifications}
          onChange={(val) => setSettings({ ...settings, enablePushNotifications: val })}
          label="Push Notifications"
          description="Enable browser push notifications"
        />
        <ToggleSwitch
          checked={settings.notifyOnNewTeacher}
          onChange={(val) => setSettings({ ...settings, notifyOnNewTeacher: val })}
          label="New Teacher Alert"
          description="Notify when a new teacher is added"
        />
        <ToggleSwitch
          checked={settings.notifyOnNewStudent}
          onChange={(val) => setSettings({ ...settings, notifyOnNewStudent: val })}
          label="New Student Alert"
          description="Notify when new students are added"
        />
        <ToggleSwitch
          checked={settings.notifyOnAttendanceAlert}
          onChange={(val) => setSettings({ ...settings, notifyOnAttendanceAlert: val })}
          label="Attendance Alerts"
          description="Notify when attendance drops below threshold"
        />
      </div>
      
      {/* Data Management */}
      <div className="bg-white p-6 rounded-2xl shadow-lg">
        <h3 className="text-xl font-bold mb-4 flex items-center gap-2">
          üóÑÔ∏è Data Management
        </h3>
        
        <div className="grid md:grid-cols-2 gap-4">
          <div>
            <label className="block text-sm font-bold mb-2">Auto-archive after (days)</label>
            <input
              type="number"
              value={settings.autoArchiveAfterDays}
              onChange={(e) => setSettings({ ...settings, autoArchiveAfterDays: parseInt(e.target.value) || 365 })}
              className="w-full border-2 px-4 py-3 rounded-xl"
              min="30"
              max="730"
            />
            <p className="text-xs text-gray-500 mt-1">Old data will be archived after this many days</p>
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">Data retention (months)</label>
            <input
              type="number"
              value={settings.dataRetentionMonths}
              onChange={(e) => setSettings({ ...settings, dataRetentionMonths: parseInt(e.target.value) || 24 })}
              className="w-full border-2 px-4 py-3 rounded-xl"
              min="6"
              max="60"
            />
            <p className="text-xs text-gray-500 mt-1">Archived data will be retained for this duration</p>
          </div>
        </div>
      </div>
      
      {/* App Customization */}
      <div className="bg-white p-6 rounded-2xl shadow-lg">
        <h3 className="text-xl font-bold mb-4 flex items-center gap-2">
          üé® App Customization
        </h3>
        
        <div className="grid md:grid-cols-2 gap-4 mb-4">
          <div>
            <label className="block text-sm font-bold mb-2">App Name</label>
            <input
              type="text"
              value={settings.appName}
              onChange={(e) => setSettings({ ...settings, appName: e.target.value })}
              className="w-full border-2 px-4 py-3 rounded-xl"
            />
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">Primary Color</label>
            <div className="flex gap-2">
              <input
                type="color"
                value={settings.primaryColor}
                onChange={(e) => setSettings({ ...settings, primaryColor: e.target.value })}
                className="w-16 h-12 border-2 rounded-xl cursor-pointer"
              />
              <input
                type="text"
                value={settings.primaryColor}
                onChange={(e) => setSettings({ ...settings, primaryColor: e.target.value })}
                className="flex-1 border-2 px-4 py-3 rounded-xl font-mono"
              />
            </div>
          </div>
        </div>
        
        <ToggleSwitch
          checked={settings.showWelcomeMessage}
          onChange={(val) => setSettings({ ...settings, showWelcomeMessage: val })}
          label="Show Welcome Message"
          description="Display welcome message on dashboard"
        />
        <ToggleSwitch
          checked={settings.enableDarkMode}
          onChange={(val) => setSettings({ ...settings, enableDarkMode: val })}
          label="Enable Dark Mode Option"
          description="Allow users to switch to dark mode (coming soon)"
        />
      </div>
      
      {/* Maintenance Mode */}
      <div className="bg-white p-6 rounded-2xl shadow-lg border-2 border-red-200">
        <h3 className="text-xl font-bold mb-4 flex items-center gap-2 text-red-600">
          üöß Maintenance Mode
        </h3>
        
        <ToggleSwitch
          checked={settings.maintenanceMode}
          onChange={(val) => setSettings({ ...settings, maintenanceMode: val })}
          label="Enable Maintenance Mode"
          description="‚ö†Ô∏è When enabled, only Super Admins can access the application"
        />
        
        {settings.maintenanceMode && (
          <div className="mt-4 p-4 bg-red-50 rounded-xl text-red-800">
            <strong>‚ö†Ô∏è Warning:</strong> Maintenance mode is enabled. All users except Super Admins will see a maintenance message.
          </div>
        )}
      </div>
      
      {/* System Information */}
      <div className="bg-gray-50 p-6 rounded-2xl">
        <h3 className="text-xl font-bold mb-4">üìä System Information</h3>
        <div className="grid md:grid-cols-3 gap-4 text-sm">
          <div className="bg-white p-4 rounded-xl">
            <div className="text-gray-500">Version</div>
            <div className="font-bold text-lg">2.0.0</div>
          </div>
          <div className="bg-white p-4 rounded-xl">
            <div className="text-gray-500">Last Updated</div>
            <div className="font-bold text-lg">{new Date().toLocaleDateString()}</div>
          </div>
          <div className="bg-white p-4 rounded-xl">
            <div className="text-gray-500">Database</div>
            <div className="font-bold text-lg">Firebase Firestore</div>
          </div>
        </div>
      </div>
    </div>
  );
}

function AdminBirthdays({teachers}){const todayBirthdays=useMemo(()=>getBirthdays(teachers,'today'),[teachers]);const weekBirthdays=useMemo(()=>getBirthdays(teachers,'week'),[teachers]);const monthBirthdays=useMemo(()=>getBirthdays(teachers,'month'),[teachers]);const todayAnniversaries=useMemo(()=>getAnniversaries(teachers,'today'),[teachers]);const weekAnniversaries=useMemo(()=>getAnniversaries(teachers,'week'),[teachers]);const monthAnniversaries=useMemo(()=>getAnniversaries(teachers,'month'),[teachers]);return(<div className="space-y-6"><h2 className="text-3xl font-bold">üéâ Celebrations</h2><div className="grid md:grid-cols-2 gap-6"><>{todayBirthdays.length>0&&<div className="birthday-card p-6 rounded-2xl"><h3 className="text-2xl font-bold text-white mb-4">üéÇ Today's Birthdays</h3>{todayBirthdays.map(t=><div key={t.id} className="bg-white p-4 rounded-lg mb-2"><div className="font-bold text-lg">{t.name}</div><div className="text-sm text-gray-600">{t.school} - {t.subject}</div></div>)}</div>}{todayAnniversaries.length>0&&<div className="birthday-card p-6 rounded-2xl"><h3 className="text-2xl font-bold text-white mb-4">üéâ Today's Work Anniversaries</h3>{todayAnniversaries.map(t=>{const years=new Date().getFullYear()-new Date(t.joiningDate).getFullYear();return(<div key={t.id} className="bg-white p-4 rounded-lg mb-2"><div className="font-bold text-lg">{t.name}</div><div className="text-sm text-gray-600">{years} Years - {t.school}</div></div>)})}</div>}</></div><div className="grid md:grid-cols-3 gap-6"><div className="bg-white p-6 rounded-2xl shadow-lg"><h3 className="text-xl font-bold mb-4">This Week</h3>{weekBirthdays.length===0&&weekAnniversaries.length===0?<p className="text-gray-500">No celebrations</p>:<div className="space-y-2"><>{weekBirthdays.map(t=><div key={t.id} className="p-3 bg-blue-50 rounded-lg"><div className="font-semibold">üéÇ {t.name}</div><div className="text-sm text-gray-600">{new Date(t.dob).toLocaleDateString(undefined,{month:'short',day:'numeric'})}</div></div>)}{weekAnniversaries.map(t=><div key={t.id} className="p-3 bg-green-50 rounded-lg"><div className="font-semibold">üéâ {t.name}</div><div className="text-sm text-gray-600">Work Anniversary</div></div>)}</></div>}</div><div className="bg-white p-6 rounded-2xl shadow-lg"><h3 className="text-xl font-bold mb-4">This Month - Birthdays</h3>{monthBirthdays.length===0?<p className="text-gray-500">No birthdays</p>:<div className="space-y-2 max-h-96 overflow-y-auto">{monthBirthdays.map(t=><div key={t.id} className="p-3 bg-gray-50 rounded-lg"><div className="font-semibold">{t.name}</div><div className="text-sm text-gray-600">{new Date(t.dob).toLocaleDateString(undefined,{month:'short',day:'numeric'})}</div></div>)}</div>}</div><div className="bg-white p-6 rounded-2xl shadow-lg"><h3 className="text-xl font-bold mb-4">This Month - Anniversaries</h3>{monthAnniversaries.length===0?<p className="text-gray-500">No anniversaries</p>:<div className="space-y-2 max-h-96 overflow-y-auto">{monthAnniversaries.map(t=>{const years=new Date().getFullYear()-new Date(t.joiningDate).getFullYear();return(<div key={t.id} className="p-3 bg-gray-50 rounded-lg"><div className="font-semibold">{t.name}</div><div className="text-sm text-gray-600">{years} Years</div></div>)})}</div>}</div></div></div>)}
function StudentManagement({students, isSuperAdmin = true, accessibleSchools = SCHOOLS}){
  const[showModal,setShowModal]=useState(false);
  const[editingStudent,setEditingStudent]=useState(null);
  const[form,setForm]=useState({school:'',grade:'',name:'',gender:'',id:''});
  const[selectedStudents,setSelectedStudents]=useState([]);
  const[filterSchool,setFilterSchool]=useState('All');
  const[filterGrade,setFilterGrade]=useState('All');
  const[selectAll,setSelectAll]=useState(false);
  const[searchQuery,setSearchQuery]=useState('');
  const fileInputRef=useRef(null);
  const updateIdFileRef=useRef(null);
  
  // Filter schools based on access
  const availableSchools = isSuperAdmin ? SCHOOLS : accessibleSchools;

  const filteredStudents=students
  .filter(s=>{
    // First filter by accessible schools for managers
    if(!isSuperAdmin && !accessibleSchools.includes(s.school)) return false;
    if(filterSchool!=='All'&&s.school!==filterSchool)return false;
    if(filterGrade!=='All'&&s.grade!==filterGrade)return false;
    if(searchQuery && !s.name?.toLowerCase().includes(searchQuery.toLowerCase()) && !s.id?.toLowerCase().includes(searchQuery.toLowerCase()))return false;
    return true;
  })
  .sort((a,b)=>a.name.localeCompare(b.name));

  const handleSave=async()=>{
  if(!form.school||!form.grade||!form.name||!form.gender||!form.id){
    alert('‚ö†Ô∏è Please fill all required fields:\n\n‚Ä¢ School\n‚Ä¢ Student ID\n‚Ä¢ Grade\n‚Ä¢ Name\n‚Ä¢ Gender');
    return;
  }
  
  try{
    const newDocId = `${form.school.replace(/\s+/g,'_')}_${form.id}`;
    
    if(editingStudent){
      // ============ EDITING EXISTING STUDENT ============
      const oldDocId = `${editingStudent.school.replace(/\s+/g,'_')}_${editingStudent.id}`;
      
      console.log('üìù Editing student:');
      console.log('  Old Doc ID:', oldDocId);
      console.log('  New Doc ID:', newDocId);
      
      // Check if student ID or school changed
      if(newDocId !== oldDocId){
        console.log('üîÑ ID or School changed - need to delete old doc');
        
        // Check if new ID already exists
        const existingDoc = await db.collection('students').doc(newDocId).get();
        if(existingDoc.exists){
          alert('‚ùå This Student ID already exists in this school!\n\nPlease use a different Student ID.');
          return;
        }
        
        // Delete old document
        console.log('üóëÔ∏è Deleting old document:', oldDocId);
        await db.collection('students').doc(oldDocId).delete();
      }
      
      // Save with new/same document ID
      console.log('üíæ Saving to:', newDocId);
      await db.collection('students').doc(newDocId).set({
        school: form.school,
        grade: form.grade,
        name: form.name,
        gender: form.gender,
        id: form.id,
        updatedAt: new Date().toISOString()
      });
      
      alert('‚úÖ Student updated successfully!');
      
    } else {
      // ============ ADDING NEW STUDENT ============
      console.log('‚ûï Adding new student:', newDocId);
      
      // Check if student already exists
      const existingDoc = await db.collection('students').doc(newDocId).get();
      if(existingDoc.exists){
        alert('‚ùå This Student ID already exists!\n\nStudent ID: ' + form.id + '\nSchool: ' + form.school);
        return;
      }
      
      // Create new student
      await db.collection('students').doc(newDocId).set({
        school: form.school,
        grade: form.grade,
        name: form.name,
        gender: form.gender,
        id: form.id,
        createdAt: new Date().toISOString()
      });
      
      alert('‚úÖ Student added successfully!\n\nüìù Login Details:\nStudent ID: ' + form.id + '\nPassword: pass123');
    }
    
    // Close modal and reset form
    setShowModal(false);
    setEditingStudent(null);
    setForm({school:'',grade:'',name:'',gender:'',id:''});
    
    // Reload to show changes
    console.log('üîÑ Reloading page...');
    setTimeout(() => window.location.reload(), 500);
    
  } catch(e) {
    console.error('‚ùå Save error:', e);
    alert('Failed to save student:\n\n' + e.message);
  }
};

  const openAddModal=()=>{
    setEditingStudent(null);
    setForm({school:'',grade:'',name:'',gender:'',id:''});
    setShowModal(true);
  };

  const openEditModal=(student)=>{
  console.log('Editing student:', student); // ‚úÖ Debug log
  
  setEditingStudent(student); // ‚úÖ Store entire student object
  setForm({
    school:student.school,
    grade:student.grade,
    name:student.name,
    gender:student.gender,
    id:student.id
  });
  setShowModal(true);
};

  const handleSelectAll=()=>{
    if(selectAll){
      setSelectedStudents([]);
      setSelectAll(false);
    }else{
      setSelectedStudents(filteredStudents.map(s=>s.docId));
      setSelectAll(true);
    }
  };

  const handleSelectStudent=(studentId)=>{
    if(selectedStudents.includes(studentId)){
      setSelectedStudents(selectedStudents.filter(id=>id!==studentId));
    }else{
      setSelectedStudents([...selectedStudents,studentId]);
    }
  };

  const handleBulkDelete=async()=>{
    if(selectedStudents.length===0){
      alert('Please select students to delete');
      return;
    }
    if(!confirm(`Delete ${selectedStudents.length} selected students?`))return;
    
    try{
      const batch=db.batch();
      selectedStudents.forEach(id=>{
        batch.delete(db.collection('students').doc(id));
      });
      await batch.commit();
      alert(`${selectedStudents.length} students deleted!`);
      setSelectedStudents([]);
      setSelectAll(false);
      window.location.reload();
    }catch(e){
      alert('Failed: '+e.message);
    }
  };

  const handleBulkUpdateSchool=async()=>{
    if(selectedStudents.length===0){
      alert('Please select students first');
      return;
    }
    const newSchool=prompt('Enter new school name:');
    if(!newSchool||!SCHOOLS.includes(newSchool)){
      alert('Invalid school name');
      return;
    }
    if(!confirm(`Update school to "${newSchool}" for ${selectedStudents.length} students?`))return;

    try{
      const batch=db.batch();
      selectedStudents.forEach(id=>{
        batch.update(db.collection('students').doc(id),{school:newSchool,updatedAt:new Date().toISOString()});
      });
      await batch.commit();
      alert(`${selectedStudents.length} students updated!`);
      setSelectedStudents([]);
      setSelectAll(false);
    }catch(e){
      alert('Failed: '+e.message);
    }
  };

  const handleBulkUpdateGrade=async()=>{
    if(selectedStudents.length===0){
      alert('Please select students first');
      return;
    }
    const newGrade=prompt('Enter new grade (11 or 12):');
    if(!newGrade||!['11','12'].includes(newGrade)){
      alert('Invalid grade. Must be 11 or 12');
      return;
    }
    if(!confirm(`Update grade to "${newGrade}" for ${selectedStudents.length} students?`))return;

    try{
      const batch=db.batch();
      selectedStudents.forEach(id=>{
        batch.update(db.collection('students').doc(id),{grade:newGrade,updatedAt:new Date().toISOString()});
      });
      await batch.commit();
      alert(`${selectedStudents.length} students updated!`);
      setSelectedStudents([]);
      setSelectAll(false);
    }catch(e){
      alert('Failed: '+e.message);
    }
  };

  const handleCSVImport=e=>{
    const file=e.target.files[0];
    if(!file)return;

    Papa.parse(file,{
      complete:async results=>{
        try{
          const rows=results.data;
          if(rows.length<2){
            alert('CSV file is empty');
            return;
          }

          let imported=0;
          let skipped=0;
          const errors=[];
          
          for(let i=1;i<rows.length;i++){
            const row=rows[i];
            const school=row[0]?row[0].trim():'';
            const studentId=row[1]?row[1].trim():'';
            const grade=row[2]?row[2].trim():'';
            const name=row[3]?row[3].trim():'';
            const gender=row[4]?row[4].trim():'';

            if(!school||!studentId||!grade||!name||!gender){
              errors.push(`Row ${i+1}: Missing required fields`);
              skipped++;
              continue;
            }

            // Check if student ID already exists
            const existingSnap=await db.collection('students').where('id','==',studentId).limit(1).get();
            if(!existingSnap.empty){
              errors.push(`Row ${i+1}: Student ID "${studentId}" already exists`);
              skipped++;
              continue;
            }

            // ‚úÖ Use compound key instead of .add()
const docId = `${school.replace(/\s+/g, '_')}_${studentId}`;
await db.collection('students').doc(docId).set({
  school,
  grade,
  name,
  gender,
  id: studentId,
  createdAt: new Date().toISOString()
});
            imported++;
          }

          let message=`‚úÖ Imported ${imported} students!`;
          if(skipped>0){
            message+=`\n‚ö†Ô∏è Skipped ${skipped} students`;
            if(errors.length>0){
              message+='\n\nErrors:\n'+errors.slice(0,5).join('\n');
              if(errors.length>5)message+=`\n... and ${errors.length-5} more`;
            }
          }
          message+='\n\nüìù Students can login with:\nStudent ID + Password: pass123';
          alert(message);
          
          if(fileInputRef.current)fileInputRef.current.value='';
        }catch(e){
          alert('Import failed: '+e.message);
        }
      },
      error:()=>alert('Failed to parse CSV')
    });
  };

  // ‚úÖ NEW: Bulk Update Student IDs
  const handleBulkUpdateIDs=e=>{
    const file=e.target.files[0];
    if(!file)return;

    Papa.parse(file,{
      complete:async results=>{
        try{
          const rows=results.data;
          if(rows.length<2){
            alert('CSV file is empty');
            return;
          }

          let updated=0;
          let notFound=0;
          const errors=[];
          const updateLog=[];
          
          for(let i=1;i<rows.length;i++){
            const row=rows[i];
            const schoolName=row[0]?row[0].trim():'';
            const studentName=row[1]?row[1].trim():'';
            const grade=row[2]?row[2].trim():'';
            const newStudentId=row[3]?row[3].trim():'';

            if(!schoolName||!studentName||!grade||!newStudentId){
              errors.push(`Row ${i+1}: Missing required fields (School, Name, Grade, Student ID)`);
              notFound++;
              continue;
            }

            // Find student by School + Name + Grade (exact match)
            const querySnap=await db.collection('students')
              .where('school','==',schoolName)
              .where('name','==',studentName)
              .where('grade','==',grade)
              .limit(1)
              .get();

            if(querySnap.empty){
              errors.push(`Row ${i+1}: Student "${studentName}" not found in ${schoolName}, Grade ${grade}`);
              notFound++;
              continue;
            }

            // Update the student ID
            const studentDoc=querySnap.docs[0];
            const oldId=studentDoc.data().id||'(blank)';
            
            await studentDoc.ref.update({
              id: newStudentId,
              updatedAt: new Date().toISOString()
            });
            
            updated++;
            updateLog.push(`‚úÖ ${studentName} (${schoolName}): ${oldId} ‚Üí ${newStudentId}`);
          }

          let message=`‚úÖ Updated ${updated} Student IDs!`;
          if(notFound>0){
            message+=`\n‚ö†Ô∏è ${notFound} students not found`;
          }
          
          if(updateLog.length>0){
            message+='\n\nüìù Updates:\n'+updateLog.slice(0,10).join('\n');
            if(updateLog.length>10)message+=`\n... and ${updateLog.length-10} more`;
          }
          
          if(errors.length>0){
            message+='\n\n‚ùå Errors:\n'+errors.slice(0,5).join('\n');
            if(errors.length>5)message+=`\n... and ${errors.length-5} more`;
          }
          
          alert(message);
          
          if(updateIdFileRef.current)updateIdFileRef.current.value='';
          window.location.reload(); // Refresh to show updated IDs
        }catch(e){
          alert('Update failed: '+e.message);
        }
      },
      error:()=>alert('Failed to parse CSV')
    });
  };

  const handleDelete = async (student) => {
  if (!confirm(`‚ö†Ô∏è Delete ${student.name}?\n\nStudent ID: ${student.id}\nSchool: ${student.school}\n\nThis action cannot be undone!`)) return;
  
  try {
    console.log('=== DELETE ATTEMPT ===');
    console.log('Student object:', student);
    
    // Try multiple document ID formats
    const formats = [
      `${student.school.replace(/\s+/g, '_')}_${student.id}`,
      `${student.school}_${student.id}`,
      student.docId
    ];
    
    console.log('Trying document IDs:', formats);
    
    let deleted = false;
    
    for (const docId of formats) {
      if (!docId) continue;
      
      const docRef = db.collection('students').doc(docId);
      const docSnap = await docRef.get();
      
      if (docSnap.exists) {
        console.log('‚úÖ Found document:', docId);
        await docRef.delete();
        deleted = true;
        break;
      } else {
        console.log('‚ùå Not found:', docId);
      }
    }
    
    if (deleted) {
      alert('‚úÖ Student deleted successfully!');
      window.location.reload();
    } else {
      alert('‚ùå Error: Could not find student document.\n\nPlease contact support.');
      console.error('Tried formats:', formats);
    }
    
  } catch (e) {
    console.error('Delete error:', e);
    alert('Failed to delete:\n\n' + e.message);
  }
};

  const handleExport=()=>{
    const exportData=students.map(s=>({
      School:s.school,
      'Student ID':s.id,
      Grade:s.grade,
      Name:s.name,
      Gender:s.gender
    }));
    exportToExcel(exportData,'students_list');
  };

  return(
    <div className="space-y-6">
      <div className="flex justify-between items-center flex-wrap gap-4">
        <div>
          <h2 className="text-3xl font-bold">Student Management</h2>
          {!isSuperAdmin && (
            <p className="text-sm text-gray-500 mt-1">üëÅÔ∏è View Only Mode - Contact Super Admin for modifications</p>
          )}
        </div>
        <div className="flex gap-3 flex-wrap">
          {isSuperAdmin && (
            <>
              <button onClick={openAddModal} className="px-6 py-3 bg-blue-600 text-white rounded-xl font-semibold">
                + Add Student
              </button>
              <label className="px-6 py-3 bg-green-600 text-white rounded-xl font-semibold cursor-pointer">
                üì§ Import CSV
                <input ref={fileInputRef} type="file" accept=".csv" onChange={handleCSVImport} className="hidden"/>
              </label>
              <label className="px-6 py-3 bg-orange-600 text-white rounded-xl font-semibold cursor-pointer">
                üîÑ Update Student IDs
                <input ref={updateIdFileRef} type="file" accept=".csv" onChange={handleBulkUpdateIDs} className="hidden"/>
              </label>
            </>
          )}
          <button onClick={handleExport} className="px-6 py-3 bg-purple-600 text-white rounded-xl font-semibold">
            üì• Export
          </button>
        </div>
      </div>

      {isSuperAdmin && selectedStudents.length>0&&(
        <div className="bg-blue-50 border-2 border-blue-300 p-4 rounded-xl">
          <div className="flex justify-between items-center">
            <div className="font-bold text-blue-800">
              {selectedStudents.length} student(s) selected
            </div>
            <div className="flex gap-2">
              <button onClick={handleBulkUpdateSchool} className="px-4 py-2 bg-blue-600 text-white rounded-lg font-semibold">
                üè´ Change School
              </button>
              <button onClick={handleBulkUpdateGrade} className="px-4 py-2 bg-green-600 text-white rounded-lg font-semibold">
                üìö Change Grade
              </button>
              <button onClick={handleBulkDelete} className="px-4 py-2 bg-red-600 text-white rounded-lg font-semibold">
                üóëÔ∏è Delete Selected
              </button>
              <button onClick={()=>{setSelectedStudents([]);setSelectAll(false)}} className="px-4 py-2 bg-gray-400 text-white rounded-lg font-semibold">
                Cancel
              </button>
            </div>
          </div>
        </div>
      )}

      <div className="bg-white p-6 rounded-2xl shadow-lg">
        <h3 className="text-xl font-bold mb-4">üîç Filters & Search</h3>
        <div className="grid md:grid-cols-3 gap-4">
          <div>
            <label className="block text-sm font-bold mb-2">Search</label>
            <input 
              type="text" 
              value={searchQuery} 
              onChange={e=>setSearchQuery(e.target.value)} 
              placeholder="Search by name or ID..." 
              className="w-full border-2 px-4 py-3 rounded-xl"
            />
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">School</label>
            <select value={filterSchool} onChange={e=>{setFilterSchool(e.target.value);setSelectedStudents([]);setSelectAll(false)}} className="w-full border-2 px-4 py-3 rounded-xl">
              <option value="All">All Schools</option>
              {availableSchools.map(s=><option key={s} value={s}>{s}</option>)}
            </select>
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">Grade</label>
            <select value={filterGrade} onChange={e=>{setFilterGrade(e.target.value);setSelectedStudents([]);setSelectAll(false)}} className="w-full border-2 px-4 py-3 rounded-xl">
              <option value="All">All Grades</option>
              <option value="11">Class 11</option>
              <option value="12">Class 12</option>
            </select>
          </div>
        </div>
      </div>

      {/* Summary Cards */}
      <div className="grid grid-cols-3 gap-4">
        <div className="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-4 rounded-xl shadow-lg">
          <div className="text-sm opacity-90">Total Students</div>
          <div className="text-3xl font-bold">{filteredStudents.length}</div>
          <div className="text-xs opacity-75 mt-1">Filtered results</div>
        </div>
        <div className="bg-gradient-to-r from-indigo-500 to-purple-600 text-white p-4 rounded-xl shadow-lg">
          <div className="text-sm opacity-90">Male</div>
          <div className="text-3xl font-bold">{filteredStudents.filter(s => s.gender === 'Male').length}</div>
          <div className="text-xs opacity-75 mt-1">{filteredStudents.length > 0 ? Math.round((filteredStudents.filter(s => s.gender === 'Male').length / filteredStudents.length) * 100) : 0}%</div>
        </div>
        <div className="bg-gradient-to-r from-pink-500 to-rose-600 text-white p-4 rounded-xl shadow-lg">
          <div className="text-sm opacity-90">Female</div>
          <div className="text-3xl font-bold">{filteredStudents.filter(s => s.gender === 'Female').length}</div>
          <div className="text-xs opacity-75 mt-1">{filteredStudents.length > 0 ? Math.round((filteredStudents.filter(s => s.gender === 'Female').length / filteredStudents.length) * 100) : 0}%</div>
        </div>
      </div>

      {isSuperAdmin && (
        <>
          <div className="bg-white p-4 rounded-xl border-2 border-gray-200">
            <p className="text-sm text-gray-600">
              <strong>üìã Import New Students CSV Format (5 columns):</strong>
              <br/>School Name, Student ID, Grade, Student Name, Gender
              <br/><br/>
              <strong>‚úÖ Example Row:</strong>
              <br/>CoE Barwani, STU001, 11, Raj Kumar, Male
              <br/><br/>
              <strong>üîê Login Info:</strong> Students use their Student ID + Password: <span className="font-mono bg-yellow-100 px-2 py-1 rounded">pass123</span>
            </p>
          </div>

          <div className="bg-orange-50 p-4 rounded-xl border-2 border-orange-300">
            <p className="text-sm text-gray-600">
              <strong>üîÑ Update Student IDs CSV Format (4 columns):</strong>
              <br/>School Name, Student Name, Grade, Student ID
              <br/><br/>
              <strong>‚úÖ Example Row:</strong>
              <br/>CoE Bundi, Aaditya Raj Dhawan, Class 12, 2754059028
              <br/><br/>
              <strong>‚ö° How it works:</strong> System finds existing student by matching School + Name + Grade, then updates only the Student ID field.
            </p>
          </div>
        </>
      )}

      <div className="bg-white p-6 rounded-2xl shadow-lg overflow-x-auto">
        <h3 className="font-bold mb-4">
          Showing {filteredStudents.length} of {students.length} Students
        </h3>
        <table className="w-full">
          <thead className="avanti-gradient-light">
            <tr>
              {isSuperAdmin && (
                <th className="p-3">
                  <input 
                    type="checkbox" 
                    checked={selectAll&&filteredStudents.length>0} 
                    onChange={handleSelectAll}
                    className="cursor-pointer"
                  />
                </th>
              )}
              <th className="p-3 text-left">School</th>
              <th className="p-3 text-left">Student ID</th>
              <th className="p-3 text-left">Grade</th>
              <th className="p-3 text-left">Name</th>
              <th className="p-3 text-left">Gender</th>
              {isSuperAdmin && <th className="p-3 text-left">Actions</th>}
            </tr>
          </thead>
          <tbody>
            {filteredStudents.length===0?(
              <tr>
                <td colSpan={isSuperAdmin ? "7" : "5"} className="p-8 text-center text-gray-500">
                  No students found
                </td>
              </tr>
            ):(
              filteredStudents.map(s=>
                <tr key={s.docId} className={`border-b hover:bg-gray-50 ${selectedStudents.includes(s.docId)?'bg-blue-50':''}`}>
                  {isSuperAdmin && (
                    <td className="p-3">
                      <input 
                        type="checkbox" 
                        checked={selectedStudents.includes(s.docId)}
                        onChange={()=>handleSelectStudent(s.docId)}
                        className="cursor-pointer"
                      />
                    </td>
                  )}
                  <td className="p-3">{s.school}</td>
                  <td className="p-3">
                    <span className="font-mono bg-blue-100 px-2 py-1 rounded font-bold">
                      {s.id}
                    </span>
                  </td>
                  <td className="p-3">Class {s.grade}</td>
                  <td className="p-3 font-semibold">{s.name}</td>
                  <td className="p-3">{s.gender}</td>
                  {isSuperAdmin && (
                    <td className="p-3">
                      <div className="flex gap-2">
                        <button onClick={()=>openEditModal(s)} className="px-3 py-1 bg-yellow-400 rounded-lg font-semibold">
                          Edit
                        </button>
                        <button onClick={()=>handleDelete(s)} className="px-3 py-1 bg-red-500 text-white rounded-lg font-semibold">
                          Delete
                        </button>
                      </div>
                    </td>
                  )}
                </tr>
              )
            )}
          </tbody>
        </table>
      </div>

      {isSuperAdmin && showModal&&(
        <div className="modal-overlay" onClick={()=>{setShowModal(false);setEditingStudent(null)}}>
          <div className="modal-content" onClick={e=>e.stopPropagation()}>
            <h3 className="text-2xl font-bold mb-4">{editingStudent?'Edit Student':'Add New Student'}</h3>
            <div className="space-y-4">
              <div>
                <label className="block text-sm font-bold mb-1">School *</label>
                <select value={form.school} onChange={e=>setForm({...form,school:e.target.value})} className="w-full border-2 px-3 py-2 rounded-lg">
                  <option value="">Select</option>
                  {SCHOOLS.map(s=><option key={s} value={s}>{s}</option>)}
                </select>
              </div>
              <div>
                <label className="block text-sm font-bold mb-1">Student ID * (For Login)</label>
                <input 
                  type="text" 
                  value={form.id} 
                  onChange={e=>setForm({...form,id:e.target.value})} 
                  placeholder="e.g., STU001"
                  className="w-full border-2 px-3 py-2 rounded-lg"
                />
                <p className="text-xs text-gray-600 mt-1">This will be used for student login</p>
              </div>
              <div>
                <label className="block text-sm font-bold mb-1">Grade *</label>
                <select value={form.grade} onChange={e=>setForm({...form,grade:e.target.value})} className="w-full border-2 px-3 py-2 rounded-lg">
                  <option value="">Select</option>
                  <option value="11">Class 11</option>
                  <option value="12">Class 12</option>
                </select>
              </div>
              <div>
                <label className="block text-sm font-bold mb-1">Name *</label>
                <input type="text" value={form.name} onChange={e=>setForm({...form,name:e.target.value})} className="w-full border-2 px-3 py-2 rounded-lg"/>
              </div>
              <div>
                <label className="block text-sm font-bold mb-1">Gender *</label>
                <select value={form.gender} onChange={e=>setForm({...form,gender:e.target.value})} className="w-full border-2 px-3 py-2 rounded-lg">
                  <option value="">Select</option>
                  {GENDERS.map(g=><option key={g} value={g}>{g}</option>)}
                </select>
              </div>
              {!editingStudent&&(
                <div className="bg-blue-50 border-2 border-blue-300 p-3 rounded-lg">
                  <p className="text-sm text-blue-800">
                    <strong>üîê Login Credentials:</strong>
                    <br/>Student ID: <span className="font-mono">{form.id||'(will be generated)'}</span>
                    <br/>Password: <span className="font-mono bg-yellow-100 px-2 py-1 rounded">pass123</span>
                  </p>
                </div>
              )}
              <div className="flex gap-3">
                <button onClick={handleSave} className="flex-1 avanti-gradient text-white py-3 rounded-xl font-semibold">
                  Save
                </button>
                <button onClick={()=>{setShowModal(false);setEditingStudent(null);setForm({school:'',grade:'',name:'',gender:'',id:''})}} className="flex-1 bg-gray-300 py-3 rounded-xl font-semibold">
                  Cancel
                </button>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

// ========================================
// TEACHER ATTENDANCE DASHBOARD
// ========================================
function TeacherAttendanceDashboard({currentUser,students,teachers,studentAttendance,teacherAttendance}){
  const[filterGrade,setFilterGrade]=useState('All');
  const[filterSubject,setFilterSubject]=useState('All');
  const today = getTodayDate();
  const[startDate,setStartDate]=useState(today);
  const[endDate,setEndDate]=useState(today);

  const mySchool=currentUser.school;

  const chart1Ref=useRef(null);
  const chart2Ref=useRef(null);
  const chart3Ref=useRef(null);
  const chartInstances=useRef({});

  const filteredStudentAttendance=useMemo(()=>{
    return studentAttendance.filter(a=>{
      if(a.school!==mySchool)return false;
      if(filterGrade!=='All'&&a.grade!==filterGrade)return false;
      if(a.date<startDate||a.date>endDate)return false;
      return true;
    });
  },[studentAttendance,mySchool,filterGrade,startDate,endDate]);

  const filteredTeacherAttendance=useMemo(()=>{
    return teacherAttendance.filter(a=>{
      if(a.school!==mySchool)return false;
      if(filterSubject!=='All'){
        const teacher=teachers.find(t=>t.afid===a.teacherId);
        if(!teacher||teacher.subject!==filterSubject)return false;
      }
      if(a.date<startDate||a.date>endDate)return false;
      return true;
    });
  },[teacherAttendance,mySchool,teachers,filterSubject,startDate,endDate]);

  const dailyStats=useMemo(()=>{
    const stats={};
    filteredStudentAttendance.forEach(a=>{
      if(!stats[a.date]){
        stats[a.date]={present:0,absent:0};
      }
      if(a.status==='Present'){
        stats[a.date].present++;
      }else{
        stats[a.date].absent++;
      }
    });
    return stats;
  },[filteredStudentAttendance]);

  const gradeStats=useMemo(()=>{
    const stats={'11':{present:0,absent:0},'12':{present:0,absent:0}};
    filteredStudentAttendance.forEach(a=>{
      if(stats[a.grade]){
        if(a.status==='Present'){
          stats[a.grade].present++;
        }else{
          stats[a.grade].absent++;
        }
      }
    });
    return stats;
  },[filteredStudentAttendance]);

  const teacherStats=useMemo(()=>{
    const present=filteredTeacherAttendance.filter(a=>a.status==='Present').length;
    const onLeave=filteredTeacherAttendance.filter(a=>a.status==='On Leave').length;
    return{present,onLeave};
  },[filteredTeacherAttendance]);

  useEffect(()=>{
    Object.values(chartInstances.current).forEach(chart=>{
      if(chart)chart.destroy();
    });
    chartInstances.current={};

    if(chart1Ref.current){
      const ctx=chart1Ref.current.getContext('2d');
      const dates=Object.keys(dailyStats).sort();
      chartInstances.current.chart1=new Chart(ctx,{
        type:'line',
        data:{
          labels:dates.map(d=>new Date(d).getDate()+'/'+String(new Date(d).getMonth()+1)),
          datasets:[
            {
              label:'Present',
              data:dates.map(d=>dailyStats[d].present),
              borderColor:'#10B981',
              backgroundColor:'rgba(16,185,129,0.1)',
              tension:0.4,
              fill:true
            },
            {
              label:'Absent',
              data:dates.map(d=>dailyStats[d].absent),
              borderColor:'#EF4444',
              backgroundColor:'rgba(239,68,68,0.1)',
              tension:0.4,
              fill:true
            }
          ]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            title:{display:true,text:'Daily Student Attendance Trend',font:{size:16,weight:'bold'}},
            legend:{position:'bottom'}
          },
          scales:{y:{beginAtZero:true}}
        }
      });
    }

    if(chart2Ref.current){
      const ctx=chart2Ref.current.getContext('2d');
      chartInstances.current.chart2=new Chart(ctx,{
        type:'bar',
        data:{
          labels:['Class 11','Class 12'],
          datasets:[
            {
              label:'Present',
              data:[gradeStats['11'].present,gradeStats['12'].present],
              backgroundColor:'#10B981'
            },
            {
              label:'Absent',
              data:[gradeStats['11'].absent,gradeStats['12'].absent],
              backgroundColor:'#EF4444'
            }
          ]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            title:{display:true,text:'Grade-wise Attendance',font:{size:16,weight:'bold'}},
            legend:{position:'bottom'}
          },
          scales:{y:{beginAtZero:true}}
        }
      });
    }

    if(chart3Ref.current){
      const ctx=chart3Ref.current.getContext('2d');
      chartInstances.current.chart3=new Chart(ctx,{
        type:'pie',
        data:{
          labels:['Present','On Leave'],
          datasets:[{
            data:[teacherStats.present,teacherStats.onLeave],
            backgroundColor:['#10B981','#F59E0B'],
            borderWidth:2
          }]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            title:{display:true,text:'Teacher Attendance',font:{size:16,weight:'bold'}},
            legend:{position:'bottom'}
          }
        }
      });
    }

    return()=>{
      Object.values(chartInstances.current).forEach(chart=>{
        if(chart)chart.destroy();
      });
    };
  },[dailyStats,gradeStats,teacherStats]);

  const handleExportStudents=()=>{
    const exportData=filteredStudentAttendance.map(a=>({
      Date:a.date,
      Grade:a.grade,
      'Student Name':a.studentName,
      Status:a.status,
      Remarks:a.remarks||'',
      'Marked By':a.markedBy
    }));
    exportToExcel(exportData,`student_attendance_${mySchool}_${startDate}_to_${endDate}`);
  };

  const handleExportTeachers=()=>{
    const exportData=filteredTeacherAttendance.map(a=>({
      Date:a.date,
      'Teacher Name':a.teacherName,
      'Punch-In Time':a.punchInTime||'Not recorded',
      Status:a.status,
      Reason:a.reason,
      Location:a.location
    }));
    exportToExcel(exportData,`teacher_attendance_${mySchool}_${startDate}_to_${endDate}`);
  };

  return(
    <div className="space-y-6">
      <div className="flex justify-between items-center">
        <h2 className="text-3xl font-bold">üìä Attendance Dashboard - {mySchool}</h2>
      </div>

      <div className="bg-white p-6 rounded-2xl shadow-lg">
        <h3 className="text-xl font-bold mb-4">üîç Filters</h3>
        <div className="grid md:grid-cols-4 gap-4">
          <div>
            <label className="block text-sm font-bold mb-2">Student Grade</label>
            <select value={filterGrade} onChange={e=>setFilterGrade(e.target.value)} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed">
              <option value="All">All Grades</option>
              <option value="11">Class 11</option>
              <option value="12">Class 12</option>
            </select>
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">Teacher Subject</label>
            <select value={filterSubject} onChange={e=>setFilterSubject(e.target.value)} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed">
              <option value="All">All Subjects</option>
              {SUBJECTS.map(s=><option key={s} value={s}>{s}</option>)}
            </select>
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">Start Date</label>
            <input type="date" value={startDate} onChange={e=>setStartDate(e.target.value)} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"/>
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">End Date</label>
            <input type="date" value={endDate} onChange={e=>setEndDate(e.target.value)} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"/>
          </div>
        </div>
        <div className="flex gap-3 mt-4">
          <button onClick={handleExportStudents} className="px-6 py-3 bg-green-600 text-white rounded-xl font-semibold">
            üì• Export Student Attendance
          </button>
          <button onClick={handleExportTeachers} className="px-6 py-3 bg-blue-600 text-white rounded-xl font-semibold">
            üì• Export Teacher Attendance
          </button>
        </div>
      </div>

      <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div className="stat-card bg-green-500 text-white">
          <div className="text-sm opacity-90">Students Present</div>
          <div className="text-4xl font-bold">{filteredStudentAttendance.filter(a=>a.status==='Present').length}</div>
        </div>
        <div className="stat-card bg-red-500 text-white">
          <div className="text-sm opacity-90">Students Absent</div>
          <div className="text-4xl font-bold">{filteredStudentAttendance.filter(a=>a.status==='Absent').length}</div>
        </div>
        <div className="stat-card bg-blue-500 text-white">
          <div className="text-sm opacity-90">Teachers Present</div>
          <div className="text-4xl font-bold">{teacherStats.present}</div>
        </div>
        <div className="stat-card bg-orange-500 text-white">
          <div className="text-sm opacity-90">Teachers on Leave</div>
          <div className="text-4xl font-bold">{teacherStats.onLeave}</div>
        </div>
      </div>

      <div className="grid md:grid-cols-2 gap-6">
        <div className="bg-white p-6 rounded-2xl shadow-lg" style={{height:'350px'}}>
          <canvas ref={chart1Ref}></canvas>
        </div>
        <div className="bg-white p-6 rounded-2xl shadow-lg" style={{height:'350px'}}>
          <canvas ref={chart2Ref}></canvas>
        </div>
      </div>

      <div className="bg-white p-6 rounded-2xl shadow-lg" style={{height:'350px'}}>
        <canvas ref={chart3Ref}></canvas>
      </div>

      <div className="grid md:grid-cols-2 gap-6">
        <div className="bg-white p-6 rounded-2xl shadow-lg">
          <h3 className="text-xl font-bold mb-4">üìã Recent Student Attendance</h3>
          <div className="overflow-x-auto max-h-96">
            <table className="w-full">
              <thead className="avanti-gradient-light sticky top-0">
                <tr>
                  <th className="p-3 text-left">Date</th>
                  <th className="p-3 text-left">Grade</th>
                  <th className="p-3 text-left">Student</th>
                  <th className="p-3 text-left">Status</th>
                </tr>
              </thead>
              <tbody>
                {filteredStudentAttendance.slice(0,50).map((a,idx)=>
                  <tr key={idx} className="border-b hover:bg-gray-50">
                    <td className="p-3 text-sm">{a.date}</td>
                    <td className="p-3">{a.grade}</td>
                    <td className="p-3 font-semibold">{a.studentName}</td>
                    <td className="p-3">
                      <span className={`px-2 py-1 rounded-full text-xs font-bold ${a.status==='Present'?'bg-green-100 text-green-700':'bg-red-100 text-red-700'}`}>
                        {a.status}
                      </span>
                    </td>
                  </tr>
                )}
              </tbody>
            </table>
          </div>
        </div>

        <div className="bg-white p-6 rounded-2xl shadow-lg">
          <h3 className="text-xl font-bold mb-4">üë• Teacher Attendance Records</h3>
          <div className="overflow-x-auto max-h-96">
            <table className="w-full">
              <thead className="avanti-gradient-light sticky top-0">
                <tr>
                  <th className="p-3 text-left">Date</th>
                  <th className="p-3 text-left">Teacher</th>
                  <th className="p-3 text-left">Punch-In</th>
                  <th className="p-3 text-left">Status</th>
                  <th className="p-3 text-left">Reason</th>
                </tr>
              </thead>
              <tbody>
                {filteredTeacherAttendance.slice(0,50).map((a,idx)=>
                  <tr key={idx} className="border-b hover:bg-gray-50">
                    <td className="p-3 text-sm">{a.date}</td>
                    <td className="p-3 font-semibold">{a.teacherName}</td>
                    <td className="p-3">
                      <span className="font-mono font-bold text-blue-600">
                        ‚è∞ {a.punchInTime||'--:--'}
                      </span>
                    </td>
                    <td className="p-3">
                      <span className={`px-2 py-1 rounded-full text-xs font-bold ${a.status==='Present'?'bg-green-100 text-green-700':'bg-orange-100 text-orange-700'}`}>
                        {a.status}
                      </span>
                    </td>
                    <td className="p-3 text-sm">{a.reason}</td>
                  </tr>
                )}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  );
}
// ========================================
// REMARKS MODAL FOR ABSENT STUDENTS
// ========================================
function RemarksModal({student,onSave,onClose}){
  const[selectedRemark,setSelectedRemark]=useState('Sick Leave');
  const[customRemark,setCustomRemark]=useState('');

  const ABSENCE_REASONS=[
    'Sick Leave',
    'Went Home for Festival',
    'Family Emergency',
    'Medical Appointment',
    'Personal Reason',
    'Others'
  ];

  const handleSave=()=>{
    const finalRemark=selectedRemark==='Others'?customRemark:selectedRemark;
    if(selectedRemark==='Others'&&!customRemark.trim()){
      alert('Please enter a custom reason');
      return;
    }
    onSave(finalRemark);
  };

  return(
    <div className="modal-overlay" onClick={onClose}>
      <div className="modal-content" onClick={e=>e.stopPropagation()}>
        <h3 className="text-2xl font-bold mb-4">üìù Absence Remarks</h3>
        <p className="text-gray-600 mb-4">Student: <strong>{student.name}</strong></p>
        
        <div className="space-y-4">
          <div>
            <label className="block text-sm font-bold mb-2">Reason for Absence *</label>
            <select 
              value={selectedRemark} 
              onChange={e=>setSelectedRemark(e.target.value)} 
              disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"
            >
              {ABSENCE_REASONS.map(reason=>
                <option key={reason} value={reason}>{reason}</option>
              )}
            </select>
          </div>

          {selectedRemark==='Others'&&(
            <div>
              <label className="block text-sm font-bold mb-2">Please Specify *</label>
              <textarea
                value={customRemark}
                onChange={e=>setCustomRemark(e.target.value)}
                className="w-full border-2 px-4 py-3 rounded-xl"
                rows="3"
                placeholder="Enter custom reason..."
              />
            </div>
          )}

          <div className="flex gap-3 mt-6">
            <button 
              onClick={handleSave} 
              className="flex-1 bg-red-500 text-white py-3 rounded-xl font-semibold"
            >
              Mark Absent
            </button>
            <button 
              onClick={onClose} 
              className="flex-1 bg-gray-300 py-3 rounded-xl font-semibold"
            >
              Cancel
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}    
// ========================================
// STUDENT ATTENDANCE VIEW (FOR TEACHERS)
// ========================================
function StudentAttendanceView({currentUser,students,studentAttendance}){
  const[selectedGrade,setSelectedGrade]=useState('11');
  const[selectedDate,setSelectedDate]=useState(getTodayDate());
  const[attendanceMap,setAttendanceMap]=useState({});
  const[showRemarksModal,setShowRemarksModal]=useState(false);
  const[selectedStudent,setSelectedStudent]=useState(null);
  const[lockStatus,setLockStatus]=useState({11: false, 12: false}); // Track lock status for each grade
  const[lockInfo,setLockInfo]=useState({11: null, 12: null}); // Track lock info for each grade
  const[isLoading,setIsLoading]=useState(false);
  const[isMarkingAll,setIsMarkingAll]=useState(false);
  const[markingProgress,setMarkingProgress]=useState({current:0,total:0});
  
  // Current grade lock status
  const isLocked = lockStatus[selectedGrade] || false;
  const currentLockInfo = lockInfo[selectedGrade] || null;

  const mySchool=currentUser.school;
  const filteredStudents=students
  .filter(s=>s.school===mySchool&&s.grade===selectedGrade)
  .sort((a,b)=>a.name.localeCompare(b.name));

  console.log('StudentAttendanceView Debug:',{
    mySchool,
    selectedGrade,
    totalStudents:students.length,
    filteredCount:filteredStudents.length,
    allSchools:Array.from(new Set(students.map(s=>s.school))),
    allGrades:Array.from(new Set(students.map(s=>s.grade)))
  });

  useEffect(()=>{
    const map={};
    studentAttendance
      .filter(a=>a.date===selectedDate&&a.school===mySchool&&a.grade===selectedGrade)
      .forEach(a=>{
        map[a.studentId]=a.status;
      });
    setAttendanceMap(map);
    
    // ‚úÖ Check lock status for BOTH grades
    checkAllLocks();
  }, [selectedDate, mySchool, studentAttendance]);
  
  // Check when grade changes
  useEffect(()=>{
    const map={};
    studentAttendance
      .filter(a=>a.date===selectedDate&&a.school===mySchool&&a.grade===selectedGrade)
      .forEach(a=>{
        map[a.studentId]=a.status;
      });
    setAttendanceMap(map);
  }, [selectedGrade]);
  
  const checkAllLocks=async()=>{
    try{
      const newLockStatus = {11: false, 12: false};
      const newLockInfo = {11: null, 12: null};
      
      // Check lock for both grades
      for (const grade of ['11', '12']) {
        const lockId=`${mySchool}_${grade}_${selectedDate}`;
        const lockDoc=await db.collection('attendanceLocks').doc(lockId).get();
        
        if(lockDoc.exists){
          newLockStatus[grade] = true;
          newLockInfo[grade] = lockDoc.data();
        }
      }
      
      setLockStatus(newLockStatus);
      setLockInfo(newLockInfo);
    }catch(e){
      console.error('Error checking locks:',e);
    }
  };
  
  const lockAttendance=async()=>{
    const confirmation=confirm(`Are you sure you want to lock attendance for Class ${selectedGrade} on ${selectedDate}?\n\nOnce locked:\n- No teacher can mark or change attendance for Class ${selectedGrade}\n- Only admins can unlock it\n\nThis prevents duplicate entries.`);
    
    if(!confirmation)return;
    
    try{
      setIsLoading(true);
      const lockId=`${mySchool}_${selectedGrade}_${selectedDate}`;
      
      await db.collection('attendanceLocks').doc(lockId).set({
        school:mySchool,
        grade:selectedGrade,
        date:selectedDate,
        lockedBy:currentUser.afid,
        lockedAt:new Date().toISOString(),
        lockedByName:currentUser.name||currentUser.afid
      });
      
      alert(`‚úÖ Attendance locked for Class ${selectedGrade}!\n\nNo one can modify attendance for Class ${selectedGrade} on this date now.`);
      checkAllLocks();
    }catch(e){
      alert('Failed to lock: '+e.message);
    }finally{
      setIsLoading(false);
    }
  };
  
  const unlockAttendance=async()=>{
    if(currentUser.role!=='admin'){
      alert('Only admins can unlock attendance.');
      return;
    }
    
    const confirmation=confirm(`Are you sure you want to unlock attendance for Class ${selectedGrade}?\n\nTeachers will be able to mark/modify attendance for Class ${selectedGrade} again.`);
    
    if(!confirmation)return;
    
    try{
      setIsLoading(true);
      const lockId=`${mySchool}_${selectedGrade}_${selectedDate}`;
      await db.collection('attendanceLocks').doc(lockId).delete();
      
      alert(`‚úÖ Attendance unlocked for Class ${selectedGrade}!`);
      checkAllLocks();
    }catch(e){
      alert('Failed to unlock: '+e.message);
    }finally{
      setIsLoading(false);
    }
  };
  const handleAttendanceChange=async(studentId,status,remarks='')=>{
    // ‚úÖ CHECK IF LOCKED
        if (isLocked) {
      const lockedBy = currentLockInfo?.lockedByName || 'Unknown';
      const lockedAt = currentLockInfo?.lockedAt
        ? new Date(currentLockInfo.lockedAt).toLocaleString()
        : 'Unknown time';

      alert(
        `‚ùå Attendance is locked for Class ${selectedGrade} on this date!\n\n` +
        `Locked by: ${lockedBy}\n` +
        `Locked at: ${lockedAt}\n\n` +
        'Contact admin to unlock.'
      );
      return;
    }
    
    try{
      // ‚úÖ UPDATE UI FIRST (Optimistic update)
      setAttendanceMap(prev=>({...prev,[studentId]:status}));
      
      // ‚úÖ THEN save to database
      const docId=`${mySchool}_${selectedGrade}_${studentId}_${selectedDate}`;
      await db.collection('studentAttendance').doc(docId).set({
        school:mySchool,
        grade:selectedGrade,
        studentId,
        studentName:filteredStudents.find(s=>s.id===studentId)?.name||'',
        date:selectedDate,
        status,
        remarks:status==='Absent'?remarks:'',
        markedBy:currentUser.afid,
        markedAt:new Date().toISOString()
      });
    }catch(e){
      // ‚úÖ Rollback UI if save fails
      setAttendanceMap(prev=>({...prev,[studentId]:prev[studentId]||''}));
      alert('Failed: '+e.message);
    }
  };

  const handleSelectAll=async()=>{
    // ‚úÖ CHECK IF LOCKED
        if (isLocked) {
      const lockedBy = lockInfo?.lockedByName || 'Unknown';
      const lockedAt = lockInfo?.lockedAt
        ? new Date(lockInfo.lockedAt).toLocaleString()
        : 'Unknown time';

      alert(
        '‚ùå Attendance is locked for this date!\n\n' +
        `Locked by: ${lockedBy}\n` +
        `Locked at: ${lockedAt}\n\n` +
        'Contact admin to unlock.'
      );
      return;
    }
    
    // ‚úÖ SHOW LOADING OVERLAY
    setIsMarkingAll(true);
    setMarkingProgress({current:0,total:filteredStudents.length});
    
    try{
      let completed=0;
      for(const student of filteredStudents){
        const docId=`${mySchool}_${selectedGrade}_${student.id}_${selectedDate}`;
        await db.collection('studentAttendance').doc(docId).set({
          school:mySchool,
          grade:selectedGrade,
          studentId:student.id,
          studentName:student.name,
          date:selectedDate,
          status:'Present',
          markedBy:currentUser.afid,
          markedAt:new Date().toISOString()
        });
        completed++;
        setMarkingProgress({current:completed,total:filteredStudents.length});
      }
      const newMap={};
      filteredStudents.forEach(s=>newMap[s.id]='Present');
      setAttendanceMap(newMap);
      alert('All students marked present!');
    }catch(e){
      alert('Failed: '+e.message);
    }finally{
      // ‚úÖ HIDE LOADING OVERLAY
      setIsMarkingAll(false);
      setMarkingProgress({current:0,total:0});
    }
  };

  return(
    <div className="space-y-6">
      {/* ‚úÖ FULL-SCREEN LOADING OVERLAY FOR MARK ALL PRESENT */}
      {isMarkingAll&&(
        <div style={{
          position:'fixed',
          top:0,
          left:0,
          right:0,
          bottom:0,
          backgroundColor:'rgba(0,0,0,0.7)',
          display:'flex',
          flexDirection:'column',
          alignItems:'center',
          justifyContent:'center',
          zIndex:99999
        }}>
          <div style={{
            backgroundColor:'white',
            padding:'2rem',
            borderRadius:'1rem',
            textAlign:'center',
            maxWidth:'90%',
            width:'320px',
            boxShadow:'0 20px 60px rgba(0,0,0,0.3)'
          }}>
            {/* Spinner */}
            <div style={{
              width:'60px',
              height:'60px',
              border:'4px solid #e5e7eb',
              borderTopColor:'#10b981',
              borderRadius:'50%',
              animation:'spin 1s linear infinite',
              margin:'0 auto 1rem'
            }}></div>
            <div style={{fontSize:'1.25rem',fontWeight:'bold',color:'#1f2937',marginBottom:'0.5rem'}}>
              Marking Attendance...
            </div>
            <div style={{fontSize:'1rem',color:'#6b7280',marginBottom:'1rem'}}>
              Please wait, do not close this page
            </div>
            {/* Progress indicator */}
            <div style={{
              width:'100%',
              height:'8px',
              backgroundColor:'#e5e7eb',
              borderRadius:'4px',
              overflow:'hidden',
              marginBottom:'0.5rem'
            }}>
              <div style={{
                width:`${markingProgress.total>0?(markingProgress.current/markingProgress.total)*100:0}%`,
                height:'100%',
                backgroundColor:'#10b981',
                transition:'width 0.3s ease'
              }}></div>
            </div>
            <div style={{fontSize:'0.875rem',color:'#6b7280'}}>
              {markingProgress.current} of {markingProgress.total} students
            </div>
          </div>
        </div>
      )}
      
      <h2 className="text-3xl font-bold">Student Attendance - {mySchool}</h2>

      {/* ‚úÖ GRADE LOCK STATUS OVERVIEW */}
      <div className="grid grid-cols-2 gap-4">
        <div className={`p-4 rounded-xl border-2 ${lockStatus['11'] ? 'bg-red-50 border-red-300' : 'bg-green-50 border-green-300'}`}>
          <div className="flex items-center justify-between">
            <div>
              <span className="font-bold text-lg">Class 11</span>
              <span className={`ml-2 px-2 py-1 rounded text-sm font-semibold ${lockStatus['11'] ? 'bg-red-200 text-red-800' : 'bg-green-200 text-green-800'}`}>
                {lockStatus['11'] ? 'üîí Locked' : 'üîì Unlocked'}
              </span>
            </div>
            {lockStatus['11'] && lockInfo['11'] && (
              <div className="text-xs text-gray-600">
                by {lockInfo['11'].lockedByName}
              </div>
            )}
          </div>
        </div>
        <div className={`p-4 rounded-xl border-2 ${lockStatus['12'] ? 'bg-red-50 border-red-300' : 'bg-green-50 border-green-300'}`}>
          <div className="flex items-center justify-between">
            <div>
              <span className="font-bold text-lg">Class 12</span>
              <span className={`ml-2 px-2 py-1 rounded text-sm font-semibold ${lockStatus['12'] ? 'bg-red-200 text-red-800' : 'bg-green-200 text-green-800'}`}>
                {lockStatus['12'] ? 'üîí Locked' : 'üîì Unlocked'}
              </span>
            </div>
            {lockStatus['12'] && lockInfo['12'] && (
              <div className="text-xs text-gray-600">
                by {lockInfo['12'].lockedByName}
              </div>
            )}
          </div>
        </div>
      </div>

      {/* ‚úÖ LOCK STATUS BANNER FOR SELECTED GRADE */}
      {isLocked&&(
        <div className="bg-red-100 border-2 border-red-500 p-4 rounded-xl">
          <div className="flex items-center justify-between">
            <div>
              <div className="font-bold text-red-800">üîí Attendance is LOCKED for Class {selectedGrade}</div>
              <div className="text-sm text-red-700 mt-1">
                Locked by: <strong>{currentLockInfo?.lockedByName || 'Unknown'}</strong> on {currentLockInfo?.lockedAt ? new Date(currentLockInfo.lockedAt).toLocaleString() : 'Unknown date'}
              </div>
              <div className="text-sm text-red-700">No changes can be made to Class {selectedGrade} attendance for this date.</div>
            </div>
            {currentUser.role==='admin'&&(
              <button 
                onClick={unlockAttendance} 
                disabled={isLoading}
                className="px-6 py-3 bg-yellow-600 hover:bg-yellow-700 text-white rounded-xl font-semibold disabled:opacity-50">
                {isLoading?'Unlocking...':'üîì Unlock Class '+selectedGrade}
              </button>
            )}
          </div>
        </div>
      )}

      {/* ‚úÖ SUCCESS BANNER WHEN UNLOCKED */}
      {!isLocked&&selectedDate===getTodayDate()&&(
        <div className="bg-green-100 border-2 border-green-500 p-4 rounded-xl">
          <div className="flex items-center justify-between">
            <div>
              <div className="font-bold text-green-800">‚úÖ Class {selectedGrade} Attendance is UNLOCKED</div>
              <div className="text-sm text-green-700 mt-1">
                You can mark/modify attendance for Class {selectedGrade}. Remember to lock it after completion to prevent duplicates.
              </div>
            </div>
            <button 
              onClick={lockAttendance} 
              disabled={isLoading}
              className="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-semibold disabled:opacity-50">
              {isLoading?'Locking...':'üîí Lock Class '+selectedGrade}
            </button>
          </div>
        </div>
      )}

      <div className="bg-white p-6 rounded-2xl shadow-lg">
        <div className="grid md:grid-cols-3 gap-4 mb-4">
          <div>
            <label className="block text-sm font-bold mb-2">Grade</label>
            <select value={selectedGrade} onChange={e=>setSelectedGrade(e.target.value)} className="w-full border-2 px-4 py-3 rounded-xl">
              <option value="11">Class 11 {lockStatus['11'] ? 'üîí' : ''}</option>
              <option value="12">Class 12 {lockStatus['12'] ? 'üîí' : ''}</option>
            </select>
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">Date</label>
            <input type="date" value={selectedDate} onChange={e=>setSelectedDate(e.target.value)} className="w-full border-2 px-4 py-3 rounded-xl"/>
          </div>
          <div className="flex items-end">
            <button 
              onClick={handleSelectAll} 
              disabled={isLocked||isMarkingAll}
              className="w-full px-6 py-3 bg-green-600 text-white rounded-xl font-semibold disabled:opacity-50 disabled:cursor-not-allowed">
              {isMarkingAll?'‚è≥ Marking...':'‚úÖ Mark All Present'}
            </button>
          </div>
        </div>
      </div>

      <div className="bg-white p-6 rounded-2xl shadow-lg">
        <h3 className="font-bold mb-4">Students ({filteredStudents.length})</h3>
        {filteredStudents.length===0?
          <p className="text-gray-500 text-center py-8">No students found</p>
        :
          <div className="space-y-2">
            {filteredStudents.map(student=>
              <div key={student.id} className="flex items-center justify-between p-4 border-2 rounded-xl hover:bg-gray-50">
                <div className="flex-1">
                  <div className="font-semibold text-lg">{student.name}</div>
                  <div className="text-sm text-gray-600">{student.gender}</div>
                  {attendanceMap[student.id]==='Absent'&&(
                    <div className="text-xs text-red-600 mt-1">
                      üìù {studentAttendance.find(a=>a.studentId===student.id&&a.date===selectedDate)?.remarks||'No reason provided'}
                    </div>
                  )}
                </div>
                <div className="flex gap-2">
                  <button 
                    onClick={()=>handleAttendanceChange(student.id,'Present')}
                    disabled={isLocked}
                    className={`px-6 py-2 rounded-lg font-semibold disabled:opacity-50 disabled:cursor-not-allowed ${attendanceMap[student.id]==='Present'?'bg-green-500 text-white':'bg-gray-200'}`}
                  >
                    ‚úì Present
                  </button>
                  <button 
                    onClick={()=>{
                      if(!isLocked){
                        setSelectedStudent(student);
                        setShowRemarksModal(true);
                      }
                    }}
                    disabled={isLocked}
                    className={`px-6 py-2 rounded-lg font-semibold disabled:opacity-50 disabled:cursor-not-allowed ${attendanceMap[student.id]==='Absent'?'bg-red-500 text-white':'bg-gray-200'}`}
                  >
                    ‚úó Absent
                  </button>
                </div>
              </div>
            )}
          </div>
        }
      </div>

      {showRemarksModal&&selectedStudent&&(
        <RemarksModal
          student={selectedStudent}
          onSave={(remarks)=>{
            handleAttendanceChange(selectedStudent.id,'Absent',remarks);
            setShowRemarksModal(false);
            setSelectedStudent(null);
          }}
          onClose={()=>{
            setShowRemarksModal(false);
            setSelectedStudent(null);
          }}
        />
      )}
    </div>
  );
}

// ========================================
// TEACHER ATTENDANCE VIEW
// ========================================
function TeacherAttendanceView({currentUser,teacherAttendance,leaveAdjustments}){
  const[selectedDate,setSelectedDate]=useState(getTodayDate());
  const[endDate,setEndDate]=useState(getTodayDate());
  const[isDateRange,setIsDateRange]=useState(false);
  const[status,setStatus]=useState('Present');
  const[reason,setReason]=useState('Present');
  const[location,setLocation]=useState('');
  const[fetchingLocation,setFetchingLocation]=useState(false);
  const[submitting,setSubmitting]=useState(false);

  const todayRecord=teacherAttendance.find(a=>a.teacherId===currentUser.afid&&a.date===selectedDate);
  
  // Calculate leave balance (including adjustments)
  const leaveBalance = useMemo(() => {
    return calculateLeaveBalance(teacherAttendance, currentUser.afid, leaveAdjustments || {});
  }, [teacherAttendance, currentUser.afid, leaveAdjustments]);

  useEffect(()=>{
    if(todayRecord){
      setStatus(todayRecord.status);
      setReason(todayRecord.reason||'Present');
      setLocation(todayRecord.location||'');
    }
  },[todayRecord]);

  // Reset date range when switching back to Present
  useEffect(() => {
    if (status === 'Present') {
      setIsDateRange(false);
      setEndDate(selectedDate);
    }
  }, [status, selectedDate]);

  const getLocation=()=>{
    setFetchingLocation(true);
    if(navigator.geolocation){
      navigator.geolocation.getCurrentPosition(
        position=>{
          const loc=`${position.coords.latitude.toFixed(6)}, ${position.coords.longitude.toFixed(6)}`;
          setLocation(loc);
          setFetchingLocation(false);
        },
        ()=>{
          alert('Unable to fetch location');
          setFetchingLocation(false);
        }
      );
    }else{
      alert('Geolocation not supported');
      setFetchingLocation(false);
    }
  };

  // Generate array of dates between start and end
  const getDateRange = (start, end) => {
    const dates = [];
    let currentDate = new Date(start);
    const endDateObj = new Date(end);
    
    while (currentDate <= endDateObj) {
      dates.push(currentDate.toISOString().split('T')[0]);
      currentDate.setDate(currentDate.getDate() + 1);
    }
    return dates;
  };

  // Calculate how many days will be marked
  const daysToMark = useMemo(() => {
    if (!isDateRange || status === 'Present') return 1;
    return getDateRange(selectedDate, endDate).length;
  }, [isDateRange, selectedDate, endDate, status]);

  const handleSubmit=async()=>{
    if(status!=='Present'&&!reason){
      alert('Please select a reason');
      return;
    }

    // Validate date range
    if (isDateRange && endDate < selectedDate) {
      alert('End date must be after or equal to start date');
      return;
    }

    // Check leave balance for entitled leaves
    if (status === 'On Leave') {
      if (ENTITLED_LEAVE_TYPES.includes(reason) && daysToMark > leaveBalance.entitled.remaining) {
        const proceed = confirm(`Warning: You only have ${leaveBalance.entitled.remaining} entitled leave days remaining, but you're marking ${daysToMark} days.\n\nDo you want to continue?`);
        if (!proceed) return;
      }
      if (MATERNITY_LEAVE_TYPES.includes(reason) && daysToMark > leaveBalance.maternity.remaining) {
        const proceed = confirm(`Warning: You only have ${leaveBalance.maternity.remaining} maternity leave days remaining, but you're marking ${daysToMark} days.\n\nDo you want to continue?`);
        if (!proceed) return;
      }
      if (PATERNITY_LEAVE_TYPES.includes(reason) && daysToMark > leaveBalance.paternity.remaining) {
        const proceed = confirm(`Warning: You only have ${leaveBalance.paternity.remaining} paternity leave days remaining, but you're marking ${daysToMark} days.\n\nDo you want to continue?`);
        if (!proceed) return;
      }
    }

    setSubmitting(true);
    
    try{
      const now=new Date();
      const punchInTime=now.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:true});
      
      // If date range is enabled for leave, mark all dates
      const datesToMark = (isDateRange && status === 'On Leave') 
        ? getDateRange(selectedDate, endDate)
        : [selectedDate];
      
      // Create batch for multiple dates
      const batch = db.batch();
      
      datesToMark.forEach(date => {
        const docId = `${currentUser.afid}_${date}`;
        const docRef = db.collection('teacherAttendance').doc(docId);
        batch.set(docRef, {
          teacherId: currentUser.afid,
          teacherName: currentUser.name,
          school: currentUser.school,
          date: date,
          status,
          reason: status === 'Present' ? 'Present' : reason,
          location: location || 'Not provided',
          punchInTime: date === getTodayDate() ? punchInTime : 'Leave applied',
          markedAt: new Date().toISOString(),
          // Store date range info for reference
          isPartOfRange: datesToMark.length > 1,
          rangeStart: datesToMark.length > 1 ? selectedDate : null,
          rangeEnd: datesToMark.length > 1 ? endDate : null
        });
      });
      
      await batch.commit();
      
      if (datesToMark.length > 1) {
        alert(`Leave marked for ${datesToMark.length} days! ‚úì\nFrom: ${selectedDate}\nTo: ${endDate}`);
      } else {
        alert(`Attendance marked! ‚úì\nPunch-in time: ${punchInTime}`);
      }
      
      // Reset date range after successful submission
      setIsDateRange(false);
      setEndDate(selectedDate);
      
    }catch(e){
      alert('Failed: '+e.message);
    } finally {
      setSubmitting(false);
    }
  };

  return(
    <div className="space-y-6">
      <h2 className="text-3xl font-bold">My Attendance</h2>

      {/* Leave Balance Cards */}
      <div className="grid md:grid-cols-3 gap-4">
        <div className="bg-white p-4 rounded-xl shadow-lg border-l-4 border-blue-500">
          <div className="flex justify-between items-center">
            <div>
              <p className="text-sm text-gray-600">Entitled Leave</p>
              <p className="text-2xl font-bold text-blue-600">{leaveBalance.entitled.remaining}/{leaveBalance.entitled.total}</p>
            </div>
            <div className="text-right">
              <span className="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded-full">
                Used: {leaveBalance.entitled.used}
              </span>
            </div>
          </div>
          <div className="mt-2 bg-gray-200 rounded-full h-2">
            <div 
              className="bg-blue-500 h-2 rounded-full transition-all" 
              style={{width: `${(leaveBalance.entitled.remaining/leaveBalance.entitled.total)*100}%`}}
            />
          </div>
        </div>
        
        <div className="bg-white p-4 rounded-xl shadow-lg border-l-4 border-pink-500">
          <div className="flex justify-between items-center">
            <div>
              <p className="text-sm text-gray-600">Maternity Leave</p>
              <p className="text-2xl font-bold text-pink-600">{leaveBalance.maternity.remaining}/{leaveBalance.maternity.total}</p>
            </div>
            <div className="text-right">
              <span className="text-xs bg-pink-100 text-pink-700 px-2 py-1 rounded-full">
                Used: {leaveBalance.maternity.used}
              </span>
            </div>
          </div>
          <div className="mt-2 bg-gray-200 rounded-full h-2">
            <div 
              className="bg-pink-500 h-2 rounded-full transition-all" 
              style={{width: `${(leaveBalance.maternity.remaining/leaveBalance.maternity.total)*100}%`}}
            />
          </div>
        </div>
        
        <div className="bg-white p-4 rounded-xl shadow-lg border-l-4 border-purple-500">
          <div className="flex justify-between items-center">
            <div>
              <p className="text-sm text-gray-600">Paternity Leave</p>
              <p className="text-2xl font-bold text-purple-600">{leaveBalance.paternity.remaining}/{leaveBalance.paternity.total}</p>
            </div>
            <div className="text-right">
              <span className="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded-full">
                Used: {leaveBalance.paternity.used}
              </span>
            </div>
          </div>
          <div className="mt-2 bg-gray-200 rounded-full h-2">
            <div 
              className="bg-purple-500 h-2 rounded-full transition-all" 
              style={{width: `${(leaveBalance.paternity.remaining/leaveBalance.paternity.total)*100}%`}}
            />
          </div>
        </div>
      </div>

      <div className="bg-white p-6 rounded-2xl shadow-lg max-w-2xl mx-auto">
        <div className="space-y-4">
          <div>
            <label className="block text-sm font-bold mb-2">Status *</label>
            <div className="flex gap-3">
              <button 
                onClick={()=>{setStatus('Present');setReason('Present')}}
                className={`flex-1 py-3 rounded-xl font-semibold ${status==='Present'?'bg-green-500 text-white':'bg-gray-200'}`}
              >
                ‚úì Present
              </button>
              <button 
                onClick={()=>setStatus('On Leave')}
                className={`flex-1 py-3 rounded-xl font-semibold ${status==='On Leave'?'bg-orange-500 text-white':'bg-gray-200'}`}
              >
                üìÖ On Leave
              </button>
            </div>
          </div>

          {status==='On Leave'&&(
            <>
              <div>
                <label className="block text-sm font-bold mb-2">Reason *</label>
                <select value={reason} onChange={e=>setReason(e.target.value)} className="w-full border-2 px-4 py-3 rounded-xl">
                  {LEAVE_REASONS.filter(r=>r!=='Present').map(r=><option key={r} value={r}>{r}</option>)}
                </select>
              </div>
              
              {/* Date Range Toggle */}
              <div className="bg-blue-50 p-4 rounded-xl border-2 border-blue-200">
                <label className="flex items-center gap-3 cursor-pointer">
                  <input 
                    type="checkbox" 
                    checked={isDateRange}
                    onChange={e => {
                      setIsDateRange(e.target.checked);
                      if (!e.target.checked) {
                        setEndDate(selectedDate);
                      }
                    }}
                    className="w-5 h-5 rounded"
                  />
                  <span className="font-semibold text-blue-800">Apply leave for multiple days</span>
                </label>
                <p className="text-sm text-blue-600 mt-1 ml-8">Enable this if you're taking 2 or more days of leave</p>
              </div>
            </>
          )}

          <div className={`grid ${isDateRange && status === 'On Leave' ? 'md:grid-cols-2' : 'grid-cols-1'} gap-4`}>
            <div>
              <label className="block text-sm font-bold mb-2">
                {isDateRange && status === 'On Leave' ? 'Start Date' : 'Date'}
              </label>
              <input 
                type="date" 
                value={selectedDate} 
                onChange={e => {
                  setSelectedDate(e.target.value);
                  if (!isDateRange || e.target.value > endDate) {
                    setEndDate(e.target.value);
                  }
                }} 
                className="w-full border-2 px-4 py-3 rounded-xl"
              />
            </div>
            
            {isDateRange && status === 'On Leave' && (
              <div>
                <label className="block text-sm font-bold mb-2">End Date</label>
                <input 
                  type="date" 
                  value={endDate} 
                  min={selectedDate}
                  onChange={e => setEndDate(e.target.value)} 
                  className="w-full border-2 px-4 py-3 rounded-xl"
                />
              </div>
            )}
          </div>

          {isDateRange && status === 'On Leave' && daysToMark > 0 && (
            <div className="bg-yellow-50 p-4 rounded-xl border-2 border-yellow-300">
              <p className="font-semibold text-yellow-800">
                üìÖ {daysToMark} day{daysToMark > 1 ? 's' : ''} will be marked as {reason}
              </p>
              <p className="text-sm text-yellow-700 mt-1">
                From {selectedDate} to {endDate}
              </p>
            </div>
          )}

          {status === 'Present' && (
            <div>
              <label className="block text-sm font-bold mb-2">Location</label>
              <div className="flex gap-2">
                <input type="text" value={location} onChange={e=>setLocation(e.target.value)} className="flex-1 border-2 px-4 py-3 rounded-xl" placeholder="Enter location or fetch GPS"/>
                <button onClick={getLocation} disabled={fetchingLocation} className="px-6 py-3 bg-blue-600 text-white rounded-xl font-semibold disabled:opacity-50">
                  {fetchingLocation?'üìç Fetching...':'üìç Get GPS'}
                </button>
              </div>
              {location&&<p className="text-sm text-gray-600 mt-2">üìç {location}</p>}
            </div>
          )}

          <button 
            onClick={handleSubmit} 
            disabled={submitting}
            className="w-full avanti-gradient text-white py-4 rounded-xl font-bold text-lg disabled:opacity-50"
          >
            {submitting ? 'Submitting...' : (isDateRange && status === 'On Leave' ? `Submit Leave (${daysToMark} days)` : 'Submit Attendance')}
          </button>

          {todayRecord&&(
            <div className="mt-6 p-4 bg-green-50 border-2 border-green-200 rounded-xl">
              <h4 className="font-bold text-green-800 mb-2">‚úì Already Marked for {selectedDate}</h4>
              <p><strong>Status:</strong> {todayRecord.status}</p>
              <p><strong>Reason:</strong> {todayRecord.reason}</p>
              <p><strong>Punch-in Time:</strong> ‚è∞ {todayRecord.punchInTime||'Not recorded'}</p>
              <p><strong>Location:</strong> {todayRecord.location}</p>
            </div>
          )}
        </div>
      </div>
    </div>
  );
}

// ========================================
// ADMIN ATTENDANCE ANALYTICS
// ========================================
function AdminAttendanceAnalytics({students,teachers,studentAttendance,teacherAttendance,accessibleSchools=[],isSuperAdmin=false}){
  // Use accessible schools for dropdown
  const schoolOptions = isSuperAdmin ? SCHOOLS : accessibleSchools;
  
  // Multi-select: Initialize with all schools selected
  const[filterSchools,setFilterSchools]=useState([...schoolOptions]);
  const[filterGrade,setFilterGrade]=useState('All');
  const[startDate,setStartDate]=useState(getTodayDate().slice(0,7)+'-01');
  const[endDate,setEndDate]=useState(getTodayDate());
  const[selectedDate,setSelectedDate]=useState(getTodayDate());
  
  // Lock Management State
  const[attendanceLocks,setAttendanceLocks]=useState([]);
  const[loadingLocks,setLoadingLocks]=useState(false);
  const[showLockManagement,setShowLockManagement]=useState(false);
  const[lockFilterSchool,setLockFilterSchool]=useState('All');
  const[lockFilterDate,setLockFilterDate]=useState(getTodayDate());

  const chart1Ref=useRef(null);
  const chart2Ref=useRef(null);
  const chart3Ref=useRef(null);
  const chart4Ref=useRef(null);

  const chartInstances=useRef({});
  
  // Load attendance locks
  const loadAttendanceLocks=async()=>{
    setLoadingLocks(true);
    try{
      let query = db.collection('attendanceLocks').orderBy('lockedAt', 'desc').limit(100);
      const snapshot = await query.get();
      const locks = snapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data()
      }));
      setAttendanceLocks(locks);
    }catch(e){
      console.error('Error loading locks:', e);
    }
    setLoadingLocks(false);
  };
  
  // Load locks when component mounts or when lock management is opened
  useEffect(()=>{
    if(showLockManagement){
      loadAttendanceLocks();
    }
  },[showLockManagement]);
  
  // Unlock attendance
  const handleUnlock=async(lockId, school, grade, date)=>{
    const confirmation = confirm(`Are you sure you want to unlock attendance for:\n\nSchool: ${school}\nClass: ${grade}\nDate: ${date}\n\nTeachers will be able to modify attendance again.`);
    
    if(!confirmation)return;
    
    try{
      await db.collection('attendanceLocks').doc(lockId).delete();
      alert('‚úÖ Attendance unlocked successfully!');
      loadAttendanceLocks();
    }catch(e){
      alert('Failed to unlock: '+e.message);
    }
  };
  
  // Filter locks for display
  const filteredLocks = attendanceLocks.filter(lock => {
    if(lockFilterSchool !== 'All' && lock.school !== lockFilterSchool) return false;
    if(lockFilterDate && lock.date !== lockFilterDate) return false;
    // Also filter by accessible schools for non-super admins
    if(!isSuperAdmin && !accessibleSchools.includes(lock.school)) return false;
    return true;
  });

  const filteredStudentAttendance=useMemo(()=>{
    return studentAttendance.filter(a=>{
      if(filterSchools.length > 0 && !filterSchools.includes(a.school))return false;
      if(filterGrade!=='All'&&a.grade!==filterGrade)return false;
      if(a.date<startDate||a.date>endDate)return false;
      return true;
    });
  },[studentAttendance,filterSchools,filterGrade,startDate,endDate]);

  const filteredTeacherAttendance=useMemo(()=>{
    return teacherAttendance.filter(a=>{
      if(filterSchools.length > 0 && !filterSchools.includes(a.school))return false;
      if(a.date<startDate||a.date>endDate)return false;
      return true;
    });
  },[teacherAttendance,filterSchools,startDate,endDate]);

  const todayStats=useMemo(()=>{
  const studentRecords=studentAttendance.filter(a=>{
    if(a.date!==selectedDate)return false;
    if(filterSchools.length > 0 && !filterSchools.includes(a.school))return false;
    if(filterGrade!=='All'&&a.grade!==filterGrade)return false;
    return true;
  });
  const teacherRecords=teacherAttendance.filter(a=>{
    if(a.date!==selectedDate)return false;
    if(filterSchools.length > 0 && !filterSchools.includes(a.school))return false;
    return true;
  });
  return{
    studentPresent:studentRecords.filter(r=>r.status==='Present').length,
    studentAbsent:studentRecords.filter(r=>r.status==='Absent').length,
    teacherPresent:teacherRecords.filter(r=>r.status==='Present').length,
    teacherAbsent:teacherRecords.filter(r=>r.status==='On Leave').length
  };
},[studentAttendance,teacherAttendance,selectedDate,filterSchools,filterGrade]);

  const genderStats=useMemo(()=>{
    const stats={Male:{present:0,absent:0},Female:{present:0,absent:0},Other:{present:0,absent:0}};
    filteredStudentAttendance.forEach(a=>{
      const student=students.find(s=>s.id===a.studentId);
      if(student&&stats[student.gender]){
        if(a.status==='Present'){
          stats[student.gender].present++;
        }else{
          stats[student.gender].absent++;
        }
      }
    });
    return stats;
  },[filteredStudentAttendance,students]);

  const monthlyDayStats=useMemo(()=>{
    const stats={};
    filteredStudentAttendance.forEach(a=>{
      if(!stats[a.date]){
        stats[a.date]={present:0,absent:0};
      }
      if(a.status==='Present'){
        stats[a.date].present++;
      }else{
        stats[a.date].absent++;
      }
    });
    return stats;
  },[filteredStudentAttendance]);

  useEffect(()=>{
    Object.values(chartInstances.current).forEach(chart=>{
      if(chart)chart.destroy();
    });
    chartInstances.current={};

    // Chart 1: Daily Student Attendance (Line)
    if(chart1Ref.current){
      const ctx=chart1Ref.current.getContext('2d');
      const dates=Object.keys(monthlyDayStats).sort();
      chartInstances.current.chart1=new Chart(ctx,{
        type:'line',
        data:{
          labels:dates.map(d=>new Date(d).getDate()),
          datasets:[
            {
              label:'Present',
              data:dates.map(d=>monthlyDayStats[d].present),
              borderColor:'#10B981',
              backgroundColor:'rgba(16,185,129,0.1)',
              tension:0.4,
              fill:true
            },
            {
              label:'Absent',
              data:dates.map(d=>monthlyDayStats[d].absent),
              borderColor:'#EF4444',
              backgroundColor:'rgba(239,68,68,0.1)',
              tension:0.4,
              fill:true
            }
          ]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            title:{display:true,text:'Daily Student Attendance (Month)',font:{size:16,weight:'bold'}},
            legend:{position:'bottom'}
          },
          scales:{
            y:{beginAtZero:true}
          }
        }
      });
    }

    // Chart 2: Gender-wise Attendance (Bar)
    if(chart2Ref.current){
      const ctx=chart2Ref.current.getContext('2d');
      const genders=Object.keys(genderStats);
      chartInstances.current.chart2=new Chart(ctx,{
        type:'bar',
        data:{
          labels:genders,
          datasets:[
            {
              label:'Present',
              data:genders.map(g=>genderStats[g].present),
              backgroundColor:'#10B981'
            },
            {
              label:'Absent',
              data:genders.map(g=>genderStats[g].absent),
              backgroundColor:'#EF4444'
            }
          ]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            title:{display:true,text:'Gender-wise Student Attendance',font:{size:16,weight:'bold'}},
            legend:{position:'bottom'}
          },
          scales:{
            y:{beginAtZero:true}
          }
        }
      });
    }

    // Chart 3: Teacher Attendance Status (Pie)
    if(chart3Ref.current){
      const ctx=chart3Ref.current.getContext('2d');
      const present=filteredTeacherAttendance.filter(a=>a.status==='Present').length;
      const onLeave=filteredTeacherAttendance.filter(a=>a.status==='On Leave').length;
      chartInstances.current.chart3=new Chart(ctx,{
        type:'pie',
        data:{
          labels:['Present','On Leave'],
          datasets:[{
            data:[present,onLeave],
            backgroundColor:['#10B981','#F59E0B'],
            borderWidth:2
          }]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            title:{display:true,text:'Teacher Attendance Status (Month)',font:{size:16,weight:'bold'}},
            legend:{position:'bottom'}
          }
        }
      });
    }

    // Chart 4: Overall Student Attendance (Doughnut)
    if(chart4Ref.current){
      const ctx=chart4Ref.current.getContext('2d');
      const present=filteredStudentAttendance.filter(a=>a.status==='Present').length;
      const absent=filteredStudentAttendance.filter(a=>a.status==='Absent').length;
      chartInstances.current.chart4=new Chart(ctx,{
        type:'doughnut',
        data:{
          labels:['Present','Absent'],
          datasets:[{
            data:[present,absent],
            backgroundColor:['#3B82F6','#EF4444'],
            borderWidth:0
          }]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            title:{display:true,text:'Overall Student Attendance (Month)',font:{size:16,weight:'bold'}},
            legend:{position:'bottom'}
          }
        }
      });
    }
    
    return()=>{
      Object.values(chartInstances.current).forEach(chart=>{
        if(chart)chart.destroy();
      });
    };
  },[monthlyDayStats,genderStats,filteredTeacherAttendance,filteredStudentAttendance]);

  const handleExportStudents=()=>{
    const exportData=filteredStudentAttendance.map(a=>({
      Date:a.date,
      School:a.school,
      Grade:a.grade,
      'Student Name':a.studentName,
      Status:a.status,
      Remarks:a.remarks||'',
      'Marked By':a.markedBy
    }));
    exportToExcel(exportData,`student_attendance_${startDate}_to_${endDate}`);
  };

  const handleExportTeachers=()=>{
    const exportData=filteredTeacherAttendance.map(a=>({
      Date:a.date,
      'Teacher Name':a.teacherName,
      School:a.school,
      'Punch-In Time':a.punchInTime||'Not recorded',
      Status:a.status,
      Reason:a.reason,
      Location:a.location
    }));
    exportToExcel(exportData,`teacher_attendance_${startDate}_to_${endDate}`);
  };

  return(
    <div className="space-y-6">
      <div className="flex justify-between items-center flex-wrap gap-4">
        <h2 className="text-3xl font-bold">üìä Attendance Analytics</h2>
        <div className="flex gap-2 flex-wrap">
          <button 
            onClick={()=>setShowLockManagement(!showLockManagement)} 
            className={`px-4 py-2 rounded-xl font-semibold ${showLockManagement ? 'bg-yellow-600 text-white' : 'bg-yellow-100 text-yellow-800 border-2 border-yellow-400'}`}
          >
            üîê Manage Locks
          </button>
          <button onClick={handleExportStudents} className="px-4 py-2 bg-green-600 text-white rounded-xl font-semibold">
            üì• Export Students
          </button>
          <button onClick={handleExportTeachers} className="px-4 py-2 bg-blue-600 text-white rounded-xl font-semibold">
            üì• Export Teachers
          </button>
        </div>
      </div>

      {/* ‚úÖ ATTENDANCE LOCK MANAGEMENT SECTION */}
      {showLockManagement && (
        <div className="bg-white p-6 rounded-2xl shadow-lg border-2 border-yellow-300">
          <div className="flex justify-between items-center mb-4">
            <h3 className="text-xl font-bold flex items-center gap-2">
              üîê Attendance Lock Management
            </h3>
            <button 
              onClick={loadAttendanceLocks}
              disabled={loadingLocks}
              className="px-4 py-2 bg-gray-200 rounded-lg font-semibold"
            >
              {loadingLocks ? '‚è≥ Loading...' : 'üîÑ Refresh'}
            </button>
          </div>
          
          <p className="text-sm text-gray-600 mb-4">
            View and manage attendance locks. When attendance is locked, teachers cannot modify it. 
            Use this section to unlock attendance when needed.
          </p>
          
          {/* Lock Filters */}
          <div className="grid md:grid-cols-3 gap-4 mb-4">
            <div>
              <label className="block text-sm font-bold mb-2">Filter by School</label>
              <select 
                value={lockFilterSchool} 
                onChange={e=>setLockFilterSchool(e.target.value)}
                className="w-full border-2 px-4 py-3 rounded-xl"
              >
                <option value="All">All Schools</option>
                {schoolOptions.map(s=><option key={s} value={s}>{s}</option>)}
              </select>
            </div>
            <div>
              <label className="block text-sm font-bold mb-2">Filter by Date</label>
              <input 
                type="date" 
                value={lockFilterDate} 
                onChange={e=>setLockFilterDate(e.target.value)}
                className="w-full border-2 px-4 py-3 rounded-xl"
              />
            </div>
            <div className="flex items-end">
              <button 
                onClick={()=>setLockFilterDate('')}
                className="w-full px-4 py-3 bg-gray-200 rounded-xl font-semibold"
              >
                Show All Dates
              </button>
            </div>
          </div>
          
          {/* Locks Table */}
          {loadingLocks ? (
            <div className="text-center py-8">
              <div className="animate-spin text-4xl mb-2">‚è≥</div>
              <p>Loading attendance locks...</p>
            </div>
          ) : filteredLocks.length === 0 ? (
            <div className="text-center py-8 text-gray-500">
              <div className="text-4xl mb-2">üîì</div>
              <p>No attendance locks found for the selected filters.</p>
            </div>
          ) : (
            <div className="overflow-x-auto">
              <table className="w-full">
                <thead className="bg-yellow-100">
                  <tr>
                    <th className="p-3 text-left">School</th>
                    <th className="p-3 text-left">Grade</th>
                    <th className="p-3 text-left">Date</th>
                    <th className="p-3 text-left">Locked By</th>
                    <th className="p-3 text-left">Locked At</th>
                    <th className="p-3 text-left">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {filteredLocks.map(lock => (
                    <tr key={lock.id} className="border-b hover:bg-gray-50">
                      <td className="p-3">{lock.school}</td>
                      <td className="p-3">
                        <span className="px-2 py-1 bg-blue-100 text-blue-800 rounded font-semibold">
                          Class {lock.grade}
                        </span>
                      </td>
                      <td className="p-3 font-mono">{lock.date}</td>
                      <td className="p-3">{lock.lockedByName || lock.lockedBy}</td>
                      <td className="p-3 text-sm">
                        {lock.lockedAt ? new Date(lock.lockedAt).toLocaleString() : 'Unknown'}
                      </td>
                      <td className="p-3">
                        <button 
                          onClick={()=>handleUnlock(lock.id, lock.school, lock.grade, lock.date)}
                          className="px-4 py-2 bg-red-500 text-white rounded-lg font-semibold hover:bg-red-600"
                        >
                          üîì Unlock
                        </button>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
              <div className="mt-4 text-sm text-gray-500">
                Showing {filteredLocks.length} lock(s)
              </div>
            </div>
          )}
        </div>
      )}

      <div className="bg-white p-6 rounded-2xl shadow-lg">
        <h3 className="text-xl font-bold mb-4">üîç Filters</h3>
        <div className="grid md:grid-cols-5 gap-4">
          <div>
            <label className="block text-sm font-bold mb-2">Schools ({filterSchools.length}/{schoolOptions.length})</label>
            <MultiSelectDropdown
              options={schoolOptions}
              selected={filterSchools}
              onChange={setFilterSchools}
              placeholder="Select Schools..."
            />
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">Grade</label>
            <select value={filterGrade} onChange={e=>setFilterGrade(e.target.value)} className="w-full border-2 px-4 py-3 rounded-xl">
              <option value="All">All Grades</option>
              <option value="11">Class 11</option>
              <option value="12">Class 12</option>
            </select>
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">Start Date</label>
            <input type="date" value={startDate} onChange={e=>setStartDate(e.target.value)} className="w-full border-2 px-4 py-3 rounded-xl"/>
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">End Date</label>
            <input type="date" value={endDate} onChange={e=>setEndDate(e.target.value)} className="w-full border-2 px-4 py-3 rounded-xl"/>
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">Today's View</label>
            <input type="date" value={selectedDate} onChange={e=>setSelectedDate(e.target.value)} className="w-full border-2 px-4 py-3 rounded-xl"/>
          </div>
        </div>
      </div>

      <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div className="stat-card bg-green-500 text-white">
          <div className="text-sm opacity-90">Students Present Today</div>
          <div className="text-4xl font-bold">{todayStats.studentPresent}</div>
        </div>
        <div className="stat-card bg-red-500 text-white">
          <div className="text-sm opacity-90">Students Absent Today</div>
          <div className="text-4xl font-bold">{todayStats.studentAbsent}</div>
        </div>
        <div className="stat-card bg-blue-500 text-white">
          <div className="text-sm opacity-90">Teachers Present Today</div>
          <div className="text-4xl font-bold">{todayStats.teacherPresent}</div>
        </div>
        <div className="stat-card bg-orange-500 text-white">
          <div className="text-sm opacity-90">Teachers on Leave Today</div>
          <div className="text-4xl font-bold">{todayStats.teacherAbsent}</div>
        </div>
      </div>

      <div className="grid md:grid-cols-2 gap-6">
        <div className="bg-white p-6 rounded-2xl shadow-lg" style={{height:'350px'}}>
          <canvas ref={chart1Ref}></canvas>
        </div>
        <div className="bg-white p-6 rounded-2xl shadow-lg" style={{height:'350px'}}>
          <canvas ref={chart2Ref}></canvas>
        </div>
        <div className="bg-white p-6 rounded-2xl shadow-lg" style={{height:'350px'}}>
          <canvas ref={chart3Ref}></canvas>
        </div>
        <div className="bg-white p-6 rounded-2xl shadow-lg" style={{height:'350px'}}>
          <canvas ref={chart4Ref}></canvas>
        </div>
      </div>

      <div className="bg-white p-6 rounded-2xl shadow-lg">
        <h3 className="text-xl font-bold mb-4">üìã Detailed Teacher Attendance</h3>
        <div className="overflow-x-auto">
          <table className="w-full">
            <thead className="avanti-gradient-light">
                <tr>
                  <th className="p-3 text-left">Date</th>
                  <th className="p-3 text-left">Teacher</th>
                  <th className="p-3 text-left">School</th>
                  <th className="p-3 text-left">Punch-In Time</th>
                  <th className="p-3 text-left">Status</th>
                  <th className="p-3 text-left">Reason</th>
                  <th className="p-3 text-left">Location</th>
                </tr>
              </thead>
            <tbody>
              {filteredTeacherAttendance.length===0?
                <tr><td colSpan="7" className="p-8 text-center text-gray-500">No records found</td></tr>
              :
                filteredTeacherAttendance.slice(0,50).map((a,idx)=>
                  <tr key={idx} className="border-b hover:bg-gray-50">
                    <td className="p-3 text-sm">{a.date}</td>
                    <td className="p-3 font-semibold">{a.teacherName}</td>
                    <td className="p-3">{a.school}</td>
                    <td className="p-3">
                      <span className="font-mono font-bold text-blue-600 text-lg">
                        ‚è∞ {a.punchInTime||'--:--'}
                      </span>
                    </td>
                    <td className="p-3">
                      <span className={`px-2 py-1 rounded-full text-xs font-bold ${a.status==='Present'?'bg-green-100 text-green-700':'bg-orange-100 text-orange-700'}`}>
                        {a.status}
                      </span>
                    </td>
                    <td className="p-3 text-sm">{a.reason}</td>
                    <td className="p-3 text-sm">üìç {a.location}</td>
                  </tr>
                )
              }
            </tbody>
          </table>
        </div>
      </div>
    </div>
  );
}
// ========================================
// SCHOOL INFO VIEW (FOR TEACHERS)
// ========================================
function SchoolInfoView({currentUser,schoolInfo,setSchoolInfo}){
  const mySchool=currentUser.school;
  const existingInfo=schoolInfo.find(info=>info.school===mySchool);
  const[isEditing,setIsEditing]=useState(false);
  
  const[formData,setFormData]=useState({
    // Principal Info
    principalName:'',
    principalPhone:'',
    principalEmail:'',
    // Vice Principal Info
    vicePrincipalName:'',
    vicePrincipalPhone:'',
    vicePrincipalEmail:'',
    // Avanti Coordinator
    coordinatorName:'',
    coordinatorPhone:'',
    coordinatorEmail:'',
    // WiFi Info
    wifiInClassroom:'No',
    wifiInstalledBy:'',
    wifiWorking:'No',
    wifiMonthlyBill:'',
    wifiConnectionType:'',
    wifiNetworkName:'',
    bothClassesWifi:'No',
    // Modules - Class 11
    modules11Received:'',
    modules11Distributed:'',
    modules11Stock:'',
    modules11Remarks:'',
    // Modules - Class 12
    modules12Received:'',
    modules12Distributed:'',
    modules12Stock:'',
    modules12Remarks:'',
    // Reference Books
    referenceBooks:[],
    // Chromebooks - Class 11
    chromebooks11Distributed:'No',
    chromebooks11Count:'',
    chromebooks11Working:'',
    chromebooks11Brand:'',
    chromebooks11DistributedDate:'',
    chromebooks11TestMethod:'',
    chromebooks11JNVLabAccess:'',
    chromebooks11JNVCount:'',
    // Chromebooks - Class 12
    chromebooks12Distributed:'No',
    chromebooks12Count:'',
    chromebooks12Working:'',
    chromebooks12Brand:'',
    chromebooks12DistributedDate:'',
    chromebooks12TestMethod:'',
    chromebooks12JNVLabAccess:'',
    chromebooks12JNVCount:'',
    // Printer
    printerAvailable:'No',
    printerWorking:'No',
    printerBrand:'',
    printerIssuedDate:'',
    // Other Assets
    otherAssets:[],
    // Meeting Minutes
    meetingMinutes:[]
  });

  useEffect(()=>{
    if(existingInfo){
      setFormData({...existingInfo});
      setIsEditing(false);
    }else{
      setIsEditing(true);
    }
  },[existingInfo]);

  const handleAddBook=()=>{
    setFormData({
      ...formData,
      referenceBooks:[...formData.referenceBooks,{
        bookName:'',
        publisher:'',
        author:'',
        price:'',
        inStock:'',
        distributed:''
      }]
    });
  };

  const handleRemoveBook=(index)=>{
    const updated=[...formData.referenceBooks];
    updated.splice(index,1);
    setFormData({...formData,referenceBooks:updated});
  };

  const handleBookChange=(index,field,value)=>{
    const updated=[...formData.referenceBooks];
    updated[index][field]=value;
    setFormData({...formData,referenceBooks:updated});
  };

  const handleAddAsset=()=>{
    setFormData({
      ...formData,
      otherAssets:[...formData.otherAssets,{
        assetName:'',
        assetQuantity:'',
        assetCondition:'',
        assetNotes:''
      }]
    });
  };

  const handleRemoveAsset=(index)=>{
    const updated=[...formData.otherAssets];
    updated.splice(index,1);
    setFormData({...formData,otherAssets:updated});
  };

  const handleAssetChange=(index,field,value)=>{
    const updated=[...formData.otherAssets];
    updated[index][field]=value;
    setFormData({...formData,otherAssets:updated});
  };

  // Meeting Minutes handlers
  const handleAddMeeting=()=>{
    setFormData({
      ...formData,
      meetingMinutes:[{
        meetingDate:new Date().toISOString().split('T')[0],
        meetingTime:new Date().toLocaleTimeString('en-IN', {hour:'2-digit', minute:'2-digit', hour12:false}),
        attendees:'',
        discussedPoints:'',
        actionPoints:'',
        updatedBy:currentUser.name,
        updatedAt:new Date().toISOString()
      }, ...(formData.meetingMinutes || [])]
    });
  };

  const handleRemoveMeeting=(index)=>{
    const updated=[...(formData.meetingMinutes || [])];
    updated.splice(index,1);
    setFormData({...formData,meetingMinutes:updated});
  };

  const handleMeetingChange=(index,field,value)=>{
    const updated=[...(formData.meetingMinutes || [])];
    updated[index][field]=value;
    updated[index].updatedBy=currentUser.name;
    updated[index].updatedAt=new Date().toISOString();
    setFormData({...formData,meetingMinutes:updated});
  };

  const handleSubmit = async () => {
  // Validation for mandatory fields
  const requiredFields = [
    { field: 'principalName', label: 'Principal Name' },
    { field: 'principalPhone', label: 'Principal Phone Number' },
    { field: 'principalEmail', label: 'Principal Email ID' },
    { field: 'vicePrincipalName', label: 'Vice Principal Name' },
    { field: 'vicePrincipalPhone', label: 'Vice Principal Phone Number' },
    { field: 'vicePrincipalEmail', label: 'Vice Principal Email ID' },
    { field: 'coordinatorName', label: 'Avanti Coordinator Name' },
    { field: 'coordinatorPhone', label: 'Avanti Coordinator Phone Number' },
    { field: 'coordinatorEmail', label: 'Avanti Coordinator Email ID' }
  ];
  
  const missingFields = [];
  for (const { field, label } of requiredFields) {
    if (!formData[field] || formData[field].toString().trim() === '') {
      missingFields.push(label);
    }
  }
  
  // Validate phone numbers (10 digits)
  const phoneFields = [
    { field: 'principalPhone', label: 'Principal Phone' },
    { field: 'vicePrincipalPhone', label: 'Vice Principal Phone' },
    { field: 'coordinatorPhone', label: 'Coordinator Phone' }
  ];
  
  const invalidPhones = [];
  for (const { field, label } of phoneFields) {
    const phone = formData[field]?.toString().replace(/\D/g, '');
    if (phone && phone.length !== 10) {
      invalidPhones.push(label + ' (must be 10 digits)');
    }
  }
  
  // Validate email format
  const emailFields = [
    { field: 'principalEmail', label: 'Principal Email' },
    { field: 'vicePrincipalEmail', label: 'Vice Principal Email' },
    { field: 'coordinatorEmail', label: 'Coordinator Email' }
  ];
  
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  const invalidEmails = [];
  for (const { field, label } of emailFields) {
    if (formData[field] && !emailRegex.test(formData[field])) {
      invalidEmails.push(label + ' (invalid format)');
    }
  }
  
  // Show all validation errors
  let errorMessage = '';
  if (missingFields.length > 0) {
    errorMessage += '‚ùå Missing required fields:\n‚Ä¢ ' + missingFields.join('\n‚Ä¢ ') + '\n\n';
  }
  if (invalidPhones.length > 0) {
    errorMessage += '‚ùå Invalid phone numbers:\n‚Ä¢ ' + invalidPhones.join('\n‚Ä¢ ') + '\n\n';
  }
  if (invalidEmails.length > 0) {
    errorMessage += '‚ùå Invalid email addresses:\n‚Ä¢ ' + invalidEmails.join('\n‚Ä¢ ');
  }
  
  if (errorMessage) {
    alert(errorMessage);
    return;
  }
  
  try {
    const docId = mySchool.replace(/\s+/g, '_');
    const now = new Date().toISOString();

    const historyEntry = {
      updatedBy: currentUser.afid,
      updatedByName: currentUser.name,
      updatedAt: now
    };

    const dataToSave = {
      ...formData,
      school: mySchool,
      updatedBy: currentUser.afid,
      updatedByName: currentUser.name,
      updatedAt: now
    };

    await db.collection('schoolInfo').doc(docId).set({
      ...dataToSave,
      updateHistory: firebase.firestore.FieldValue.arrayUnion(historyEntry)
    }, { merge: true });

    // ‚úÖ FIX: Update parent state with new data so form displays correctly
    const existingHistory = existingInfo?.updateHistory || [];
    const updatedInfo = {
      ...dataToSave,
      docId: docId,
      updateHistory: [...existingHistory, historyEntry]
    };
    
    setSchoolInfo(prev => {
      const idx = prev.findIndex(s => s.school === mySchool);
      if (idx >= 0) {
        const updated = [...prev];
        updated[idx] = updatedInfo;
        return updated;
      } else {
        return [...prev, updatedInfo];
      }
    });

    setIsEditing(false);
    alert('‚úÖ School information saved successfully!');
  } catch (e) {
    console.error('Save error:', e);
    alert('‚ùå Failed to save: ' + e.message);
  }
};


  // Generate month/year options
  const generateMonthYearOptions=()=>{
    const options=[];
    for(let year=2022;year<=2025;year++){
      for(let month=1;month<=12;month++){
        const monthName=new Date(year,month-1).toLocaleString('default',{month:'long'});
        options.push(`${monthName} ${year}`);
      }
    }
    return options;
  };

  return(
  <div className="space-y-6">
    <div className="flex justify-between items-center">
      <h2 className="text-3xl font-bold">üè´ School Information - {mySchool}</h2>
      {!isEditing && existingInfo && (
        <button onClick={()=>setIsEditing(true)} className="px-6 py-3 bg-blue-600 text-white rounded-xl font-semibold hover:bg-blue-700">
          ‚úèÔ∏è Edit Information
        </button>
      )}
      {isEditing && existingInfo && (
        <button onClick={()=>{setFormData({...existingInfo});setIsEditing(false);}} className="px-6 py-3 bg-gray-600 text-white rounded-xl font-semibold hover:bg-gray-700">
          ‚ùå Cancel
        </button>
      )}
    </div>

    {existingInfo && (
      <div className="bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded-xl text-sm">
        <div>
          Last updated:{' '}
          {existingInfo.updatedAt
            ? new Date(existingInfo.updatedAt).toLocaleString()
            : 'Not filled yet'}
          {existingInfo.updatedByName && (
            <> by <span className="font-semibold">{existingInfo.updatedByName}</span></>
          )}
        </div>

        {existingInfo.updateHistory && existingInfo.updateHistory.length > 0 && (
          <div className="mt-2">
            <div className="font-semibold mb-1">Edit History (Newest First)</div>
            <ul className="max-h-32 overflow-y-auto space-y-1">
              {existingInfo.updateHistory
                .slice()
                .sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt))
                .map((entry, idx) => (
                  <li key={idx}>
                    {new Date(entry.updatedAt).toLocaleString()} ‚Äî {entry.updatedByName || entry.updatedBy}
                  </li>
                ))}
            </ul>
          </div>
        )}
      </div>
    )}

    <div className="bg-white p-6 rounded-2xl shadow-lg space-y-6">

        
        {/* Principal Information */}
        <div className="border-4 border-blue-500 rounded-2xl p-6 bg-blue-50">
          <h3 className="text-2xl font-bold mb-4 text-blue-800">üë®‚Äçüíº Principal Information</h3>
          <div className="grid md:grid-cols-3 gap-4">
            <div>
              <label className="block text-sm font-bold mb-2">Principal Name *</label>
              <input type="text" value={formData.principalName} onChange={e=>setFormData({...formData,principalName:e.target.value})} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"/>
            </div>
            <div>
              <label className="block text-sm font-bold mb-2">Phone Number *</label>
              <input type="tel" value={formData.principalPhone} onChange={e=>setFormData({...formData,principalPhone:e.target.value})} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"/>
            </div>
            <div>
              <label className="block text-sm font-bold mb-2">Email ID *</label>
              <input type="email" value={formData.principalEmail} onChange={e=>setFormData({...formData,principalEmail:e.target.value})} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"/>
            </div>
          </div>
        </div>

        {/* Vice Principal Information */}
        <div className="border-4 border-green-500 rounded-2xl p-6 bg-green-50">
          <h3 className="text-2xl font-bold mb-4 text-green-800">üë®‚Äçüíº Vice Principal Information</h3>
          <div className="grid md:grid-cols-3 gap-4">
            <div>
              <label className="block text-sm font-bold mb-2">Vice Principal Name *</label>
              <input type="text" value={formData.vicePrincipalName} onChange={e=>setFormData({...formData,vicePrincipalName:e.target.value})} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"/>
            </div>
            <div>
              <label className="block text-sm font-bold mb-2">Phone Number *</label>
              <input type="tel" value={formData.vicePrincipalPhone} onChange={e=>setFormData({...formData,vicePrincipalPhone:e.target.value})} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"/>
            </div>
            <div>
              <label className="block text-sm font-bold mb-2">Email ID *</label>
              <input type="email" value={formData.vicePrincipalEmail} onChange={e=>setFormData({...formData,vicePrincipalEmail:e.target.value})} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"/>
            </div>
          </div>
        </div>

        {/* Avanti Coordinator Information */}
        <div className="border-4 border-orange-500 rounded-2xl p-6 bg-orange-50">
          <h3 className="text-2xl font-bold mb-4 text-orange-800">üë®‚Äçüíº Avanti Coordinator Information</h3>
          <div className="grid md:grid-cols-3 gap-4">
            <div>
              <label className="block text-sm font-bold mb-2">Coordinator Name *</label>
              <input type="text" value={formData.coordinatorName} onChange={e=>setFormData({...formData,coordinatorName:e.target.value})} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"/>
            </div>
            <div>
              <label className="block text-sm font-bold mb-2">Phone Number *</label>
              <input type="tel" value={formData.coordinatorPhone} onChange={e=>setFormData({...formData,coordinatorPhone:e.target.value})} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"/>
            </div>
            <div>
              <label className="block text-sm font-bold mb-2">Email ID *</label>
              <input type="email" value={formData.coordinatorEmail} onChange={e=>setFormData({...formData,coordinatorEmail:e.target.value})} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"/>
            </div>
          </div>
        </div>

        {/* WiFi Information */}
        <div className="border-4 border-purple-500 rounded-2xl p-6 bg-purple-50">
          <h3 className="text-2xl font-bold mb-4 text-purple-800">üì∂ WiFi Connection Details</h3>
          <div className="grid md:grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-bold mb-2">WiFi in Classroom? *</label>
              <select value={formData.wifiInClassroom} onChange={e=>setFormData({...formData,wifiInClassroom:e.target.value})} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed">
                <option value="No">No</option>
                <option value="Yes">Yes</option>
              </select>
            </div>
            {formData.wifiInClassroom==='Yes'&&(
              <>
                <div>
                  <label className="block text-sm font-bold mb-2">Installed By *</label>
                  <select value={formData.wifiInstalledBy} onChange={e=>setFormData({...formData,wifiInstalledBy:e.target.value})} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed">
                    <option value="">Select</option>
                    <option value="Avanti">Avanti</option>
                    <option value="JNV">JNV</option>
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-bold mb-2">Working Condition? *</label>
                  <select value={formData.wifiWorking} onChange={e=>setFormData({...formData,wifiWorking:e.target.value})} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed">
                    <option value="No">No</option>
                    <option value="Yes">Yes</option>
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-bold mb-2">Monthly Bill Amount *</label>
                  <input type="text" value={formData.wifiMonthlyBill} onChange={e=>setFormData({...formData,wifiMonthlyBill:e.target.value})} disabled={!isEditing} placeholder="‚Çπ Amount" className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"/>
                </div>
                <div>
                  <label className="block text-sm font-bold mb-2">Connection Type *</label>
                  <select value={formData.wifiConnectionType} onChange={e=>setFormData({...formData,wifiConnectionType:e.target.value})} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed">
                    <option value="">Select</option>
                    <option value="Postpaid">Postpaid</option>
                    <option value="Prepaid">Prepaid</option>
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-bold mb-2">Network Name *</label>
                  <select value={formData.wifiNetworkName} onChange={e=>setFormData({...formData,wifiNetworkName:e.target.value})} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed">
                    <option value="">Select</option>
                    <option value="Airtel">Airtel</option>
                    <option value="Jio">Jio</option>
                    <option value="Local">Local</option>
                    <option value="BSNL">BSNL</option>
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-bold mb-2">Both 11th & 12th have WiFi? *</label>
                  <select value={formData.bothClassesWifi} onChange={e=>setFormData({...formData,bothClassesWifi:e.target.value})} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed">
                    <option value="No">No</option>
                    <option value="Yes">Yes</option>
                  </select>
                </div>
              </>
            )}
          </div>
        </div>

        {/* Modules - Class 11 */}
        <div className="border-4 border-green-500 rounded-2xl p-6 bg-green-50">
          <h3 className="text-2xl font-bold mb-4 text-green-800">üìö Modules - Class 11th</h3>
          <div className="grid md:grid-cols-3 gap-4">
            <div>
              <label className="block text-sm font-bold mb-2">Modules Received (AY 2025-26) *</label>
              <input type="number" min="0" value={formData.modules11Received} onChange={e=>setFormData({...formData,modules11Received:e.target.value})} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed" placeholder="Enter number only"/>
            </div>
            <div>
              <label className="block text-sm font-bold mb-2">Modules Distributed to 11th *</label>
              <input type="number" min="0" value={formData.modules11Distributed} onChange={e=>setFormData({...formData,modules11Distributed:e.target.value})} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed" placeholder="Enter number only"/>
            </div>
            <div>
              <label className="block text-sm font-bold mb-2">Modules in Stock (11th) *</label>
              <input type="number" min="0" value={formData.modules11Stock} onChange={e=>setFormData({...formData,modules11Stock:e.target.value})} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed" placeholder="Enter number only"/>
            </div>
          </div>
          <div className="mt-4">
            <label className="block text-sm font-bold mb-2">üìù Remarks for Class 11th Modules</label>
            <textarea value={formData.modules11Remarks||''} onChange={e=>setFormData({...formData,modules11Remarks:e.target.value})} disabled={!isEditing} placeholder="Add any remarks about 11th class modules here..." className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed" rows="2"/>
          </div>
        </div>

        {/* Modules - Class 12 */}
        <div className="border-4 border-blue-500 rounded-2xl p-6 bg-blue-50">
          <h3 className="text-2xl font-bold mb-4 text-blue-800">üìö Modules - Class 12th</h3>
          <div className="grid md:grid-cols-3 gap-4">
            <div>
              <label className="block text-sm font-bold mb-2">Modules Received (AY 2025-26) *</label>
              <input type="number" min="0" value={formData.modules12Received} onChange={e=>setFormData({...formData,modules12Received:e.target.value})} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed" placeholder="Enter number only"/>
            </div>
            <div>
              <label className="block text-sm font-bold mb-2">Modules Distributed to 12th *</label>
              <input type="number" min="0" value={formData.modules12Distributed} onChange={e=>setFormData({...formData,modules12Distributed:e.target.value})} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed" placeholder="Enter number only"/>
            </div>
            <div>
              <label className="block text-sm font-bold mb-2">Modules in Stock (12th) *</label>
              <input type="number" min="0" value={formData.modules12Stock} onChange={e=>setFormData({...formData,modules12Stock:e.target.value})} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed" placeholder="Enter number only"/>
            </div>
          </div>
          <div className="mt-4">
            <label className="block text-sm font-bold mb-2">üìù Remarks for Class 12th Modules</label>
            <textarea value={formData.modules12Remarks||''} onChange={e=>setFormData({...formData,modules12Remarks:e.target.value})} disabled={!isEditing} placeholder="Add any remarks about 12th class modules here..." className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed" rows="2"/>
          </div>
        </div>

        {/* Reference Books */}
        <div className="border-4 border-yellow-500 rounded-2xl p-6 bg-yellow-50">
          <div className="flex justify-between items-center mb-4">
            <h3 className="text-2xl font-bold text-yellow-800">üìñ Other Reference Books (AY 2025-26)</h3>
            {isEditing && (
              <button onClick={handleAddBook} className="px-6 py-3 bg-yellow-600 text-white rounded-xl font-semibold">
                + Add Book
              </button>
            )}
          </div>
          {formData.referenceBooks.map((book,idx)=>
            <div key={idx} className="bg-white p-4 rounded-xl mb-4 border-2 border-yellow-300">
              <div className="flex justify-between items-center mb-3">
                <h4 className="font-bold text-lg">Book {idx+1}</h4>
                {isEditing && (
                    <button onClick={()=>handleRemoveBook(idx)} className="px-4 py-2 bg-red-500 text-white rounded-lg">
                      Remove
                    </button>
                  )}
              </div>
              <div className="grid md:grid-cols-3 gap-4">
                <div>
                  <label className="block text-sm font-bold mb-2">Book Name *</label>
                  <input type="text" value={book.bookName} onChange={e=>handleBookChange(idx,'bookName',e.target.value)} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"/>
                </div>
                <div>
                  <label className="block text-sm font-bold mb-2">Publisher Name *</label>
                  <input type="text" value={book.publisher} onChange={e=>handleBookChange(idx,'publisher',e.target.value)} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"/>
                </div>
                <div>
                  <label className="block text-sm font-bold mb-2">Author Name *</label>
                  <input type="text" value={book.author} onChange={e=>handleBookChange(idx,'author',e.target.value)} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"/>
                </div>
                <div>
                  <label className="block text-sm font-bold mb-2">Price *</label>
                  <input type="text" value={book.price} onChange={e=>handleBookChange(idx,'price',e.target.value)} placeholder="‚Çπ Amount" disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"/>
                </div>
                <div>
                  <label className="block text-sm font-bold mb-2">In Stock *</label>
                  <input type="number" value={book.inStock} onChange={e=>handleBookChange(idx,'inStock',e.target.value)} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"/>
                </div>
                <div>
                  <label className="block text-sm font-bold mb-2">Distributed *</label>
                  <input type="number" value={book.distributed} onChange={e=>handleBookChange(idx,'distributed',e.target.value)} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"/>
                </div>
              </div>
            </div>
          )}
        </div>

        {/* Chromebooks - Class 11 */}
        <div className="border-4 border-indigo-500 rounded-2xl p-6 bg-indigo-50">
          <h3 className="text-2xl font-bold mb-4 text-indigo-800">üíª Chromebooks/Laptops - Class 11th</h3>
          <div className="grid md:grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-bold mb-2">Distributed from Avanti? *</label>
              <select value={formData.chromebooks11Distributed} onChange={e=>setFormData({...formData,chromebooks11Distributed:e.target.value})} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed">
                <option value="No">No</option>
                <option value="Yes">Yes</option>
              </select>
            </div>
            {formData.chromebooks11Distributed==='Yes'?(
              <>
                <div>
                  <label className="block text-sm font-bold mb-2">Number Distributed *</label>
                  <input type="number" min="0" value={formData.chromebooks11Count} onChange={e=>setFormData({...formData,chromebooks11Count:e.target.value})} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed" placeholder="Enter number only"/>
                </div>
                <div>
                  <label className="block text-sm font-bold mb-2">Working Condition *</label>
                  <input type="number" min="0" value={formData.chromebooks11Working} onChange={e=>setFormData({...formData,chromebooks11Working:e.target.value})} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed" placeholder="Enter number only"/>
                </div>
                <div>
                  <label className="block text-sm font-bold mb-2">Brand Name *</label>
                  <input type="text" value={formData.chromebooks11Brand} onChange={e=>setFormData({...formData,chromebooks11Brand:e.target.value})} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"/>
                </div>
                <div className="md:col-span-2">
                  <label className="block text-sm font-bold mb-2">When Distributed? *</label>
                  <select value={formData.chromebooks11DistributedDate} onChange={e=>setFormData({...formData,chromebooks11DistributedDate:e.target.value})} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed">
                    <option value="">Select Month & Year</option>
                    {generateMonthYearOptions().map(opt=><option key={opt} value={opt}>{opt}</option>)}
                  </select>
                </div>
              </>
            ):(
              <>
                <div className="md:col-span-2">
                  <label className="block text-sm font-bold mb-2">How do you conduct tests? *</label>
                  <textarea value={formData.chromebooks11TestMethod} onChange={e=>setFormData({...formData,chromebooks11TestMethod:e.target.value})} disabled={!isEditing} rows="3" className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"/>
                </div>
                <div>
                  <label className="block text-sm font-bold mb-2">JNV Computer Lab/Tablets Accessible? *</label>
                  <input type="text" value={formData.chromebooks11JNVLabAccess} onChange={e=>setFormData({...formData,chromebooks11JNVLabAccess:e.target.value})} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"/>
                </div>
                <div>
                  <label className="block text-sm font-bold mb-2">How many tabs/computers in JNV? *</label>
                  <input type="number" min="0" value={formData.chromebooks11JNVCount} onChange={e=>setFormData({...formData,chromebooks11JNVCount:e.target.value})} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed" placeholder="Enter number only"/>
                </div>
              </>
            )}
          </div>
        </div>

        {/* Chromebooks - Class 12 */}
        <div className="border-4 border-pink-500 rounded-2xl p-6 bg-pink-50">
          <h3 className="text-2xl font-bold mb-4 text-pink-800">üíª Chromebooks/Laptops - Class 12th</h3>
          <div className="grid md:grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-bold mb-2">Distributed from Avanti? *</label>
              <select value={formData.chromebooks12Distributed} onChange={e=>setFormData({...formData,chromebooks12Distributed:e.target.value})} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed">
                <option value="No">No</option>
                <option value="Yes">Yes</option>
              </select>
            </div>
            {formData.chromebooks12Distributed==='Yes'?(
              <>
                <div>
                  <label className="block text-sm font-bold mb-2">Number Distributed *</label>
                  <input type="number" min="0" value={formData.chromebooks12Count} onChange={e=>setFormData({...formData,chromebooks12Count:e.target.value})} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed" placeholder="Enter number only"/>
                </div>
                <div>
                  <label className="block text-sm font-bold mb-2">Working Condition *</label>
                  <input type="number" min="0" value={formData.chromebooks12Working} onChange={e=>setFormData({...formData,chromebooks12Working:e.target.value})} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed" placeholder="Enter number only"/>
                </div>
                <div>
                  <label className="block text-sm font-bold mb-2">Brand Name *</label>
                  <input type="text" value={formData.chromebooks12Brand} onChange={e=>setFormData({...formData,chromebooks12Brand:e.target.value})} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"/>
                </div>
                <div className="md:col-span-2">
                  <label className="block text-sm font-bold mb-2">When Distributed? *</label>
                  <select value={formData.chromebooks12DistributedDate} onChange={e=>setFormData({...formData,chromebooks12DistributedDate:e.target.value})} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed">
                    <option value="">Select Month & Year</option>
                    {generateMonthYearOptions().map(opt=><option key={opt} value={opt}>{opt}</option>)}
                  </select>
                </div>
              </>
            ):(
              <>
                <div className="md:col-span-2">
                  <label className="block text-sm font-bold mb-2">How do you conduct tests? *</label>
                  <textarea value={formData.chromebooks12TestMethod} onChange={e=>setFormData({...formData,chromebooks12TestMethod:e.target.value})} disabled={!isEditing} rows="3" className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"/>
                </div>
                <div>
                  <label className="block text-sm font-bold mb-2">JNV Computer Lab/Tablets Accessible? *</label>
                  <input type="text" value={formData.chromebooks12JNVLabAccess} onChange={e=>setFormData({...formData,chromebooks12JNVLabAccess:e.target.value})} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"/>
                </div>
                <div>
                  <label className="block text-sm font-bold mb-2">How many tabs/computers in JNV? *</label>
                  <input type="number" min="0" value={formData.chromebooks12JNVCount} onChange={e=>setFormData({...formData,chromebooks12JNVCount:e.target.value})} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed" placeholder="Enter number only"/>
                </div>
              </>
            )}
          </div>
        </div>

        {/* Printer Information */}
        <div className="border-4 border-cyan-500 rounded-2xl p-6 bg-cyan-50">
          <h3 className="text-2xl font-bold mb-4 text-cyan-800">üñ®Ô∏è Printer Information</h3>
          <div className="grid md:grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-bold mb-2">Printer Available? *</label>
              <select value={formData.printerAvailable} onChange={e=>setFormData({...formData,printerAvailable:e.target.value})} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed">
                <option value="No">No</option>
                <option value="Yes">Yes</option>
              </select>
            </div>
            {formData.printerAvailable==='Yes'&&(
              <>
                <div>
                  <label className="block text-sm font-bold mb-2">Working Condition? *</label>
                  <select value={formData.printerWorking} onChange={e=>setFormData({...formData,printerWorking:e.target.value})} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed">
                    <option value="No">No</option>
                    <option value="Yes">Yes</option>
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-bold mb-2">Printer Brand *</label>
                  <input type="text" value={formData.printerBrand} onChange={e=>setFormData({...formData,printerBrand:e.target.value})} disabled={!isEditing} placeholder="e.g., HP, Canon, Epson" className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"/>
                </div>
                <div>
                  <label className="block text-sm font-bold mb-2">When Issued? *</label>
                  <select value={formData.printerIssuedDate} onChange={e=>setFormData({...formData,printerIssuedDate:e.target.value})} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed">
                    <option value="">Select Month & Year</option>
                    {generateMonthYearOptions().map(opt=><option key={opt} value={opt}>{opt}</option>)}
                  </select>
                </div>
              </>
            )}
          </div>
        </div>

        {/* Other Assets */}
        <div className="border-4 border-teal-500 rounded-2xl p-6 bg-teal-50">
          <div className="flex justify-between items-center mb-4">
            <h3 className="text-2xl font-bold text-teal-800">üì¶ Other Assets</h3>
            {isEditing && (
              <button onClick={handleAddAsset} className="px-6 py-3 bg-teal-600 text-white rounded-xl font-semibold">
                + Add Asset
              </button>
            )}
          </div>
          {formData.otherAssets.length===0?(
            <p className="text-gray-600 text-center py-4">No other assets added yet. Click "+ Add Asset" to add.</p>
          ):(
            formData.otherAssets.map((asset,idx)=>
              <div key={idx} className="bg-white p-4 rounded-xl mb-4 border-2 border-teal-300">
                <div className="flex justify-between items-center mb-3">
                  <h4 className="font-bold text-lg">Asset {idx+1}</h4>
                  {isEditing && (
                    <button onClick={()=>handleRemoveAsset(idx)} className="px-4 py-2 bg-red-500 text-white rounded-lg">
                      Remove
                    </button>
                  )}
                </div>
                <div className="grid md:grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-bold mb-2">Asset Name *</label>
                    <input type="text" value={asset.assetName} onChange={e=>handleAssetChange(idx,'assetName',e.target.value)} placeholder="e.g., Projector, Whiteboard" disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"/>
                  </div>
                  <div>
                    <label className="block text-sm font-bold mb-2">Quantity *</label>
                    <input type="number" value={asset.assetQuantity} onChange={e=>handleAssetChange(idx,'assetQuantity',e.target.value)} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"/>
                  </div>
                  <div>
                    <label className="block text-sm font-bold mb-2">Condition *</label>
                    <select value={asset.assetCondition} onChange={e=>handleAssetChange(idx,'assetCondition',e.target.value)} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed">
                      <option value="">Select</option>
                      <option value="Working">Working</option>
                      <option value="Not Working">Not Working</option>
                      <option value="Needs Repair">Needs Repair</option>
                    </select>
                  </div>
                  <div>
                    <label className="block text-sm font-bold mb-2">Notes</label>
                    <input type="text" value={asset.assetNotes} onChange={e=>handleAssetChange(idx,'assetNotes',e.target.value)} placeholder="Additional details" disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"/>
                  </div>
                </div>
              </div>
            )
          )}
        </div>

        {/* Meeting Minutes Section */}
        <div className="bg-white p-6 rounded-2xl shadow-lg mt-6">
          <div className="flex justify-between items-center mb-4">
            <h3 className="text-xl font-bold text-purple-700">üìù Minutes of Meeting</h3>
            {isEditing && (
              <button onClick={handleAddMeeting} className="px-4 py-2 bg-purple-600 text-white rounded-xl font-semibold">
                + Add New Meeting
              </button>
            )}
          </div>
          
          {(formData.meetingMinutes || []).length === 0 ? (
            <p className="text-gray-500 text-center py-4">No meeting records yet</p>
          ) : (
            <div className="space-y-4">
              {(formData.meetingMinutes || []).map((meeting, idx) => (
                <div key={idx} className="border-2 border-purple-200 rounded-xl p-4 bg-purple-50">
                  <div className="flex justify-between items-start mb-3">
                    <div className="flex gap-4 items-center">
                      <span className="px-3 py-1 bg-purple-600 text-white rounded-full text-sm font-semibold">
                        Meeting #{(formData.meetingMinutes || []).length - idx}
                      </span>
                      <span className="text-sm text-gray-500">
                        Last updated: {meeting.updatedAt ? new Date(meeting.updatedAt).toLocaleString() : 'N/A'} by {meeting.updatedBy || 'Unknown'}
                      </span>
                    </div>
                    {isEditing && (
                      <button onClick={() => handleRemoveMeeting(idx)} className="px-3 py-1 bg-red-500 text-white rounded-lg text-sm">
                        Remove
                      </button>
                    )}
                  </div>
                  
                  <div className="grid md:grid-cols-2 gap-4 mb-4">
                    <div>
                      <label className="block text-sm font-bold mb-2">üìÖ Date *</label>
                      <input 
                        type="date" 
                        value={meeting.meetingDate || ''} 
                        onChange={e => handleMeetingChange(idx, 'meetingDate', e.target.value)} 
                        disabled={!isEditing} 
                        className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-bold mb-2">üïê Time *</label>
                      <input 
                        type="time" 
                        value={meeting.meetingTime || ''} 
                        onChange={e => handleMeetingChange(idx, 'meetingTime', e.target.value)} 
                        disabled={!isEditing} 
                        className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"
                      />
                    </div>
                  </div>
                  
                  <div className="mb-4">
                    <label className="block text-sm font-bold mb-2">üë• Attendees *</label>
                    <input 
                      type="text" 
                      value={meeting.attendees || ''} 
                      onChange={e => handleMeetingChange(idx, 'attendees', e.target.value)} 
                      placeholder="e.g., Principal, Vice Principal, Team Lead, Teacher A, Teacher B"
                      disabled={!isEditing} 
                      className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"
                    />
                  </div>
                  
                  <div className="mb-4">
                    <label className="block text-sm font-bold mb-2">üí¨ Discussed Points *</label>
                    <textarea 
                      value={meeting.discussedPoints || ''} 
                      onChange={e => handleMeetingChange(idx, 'discussedPoints', e.target.value)} 
                      placeholder="Enter the key points discussed in the meeting..."
                      disabled={!isEditing} 
                      className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"
                      rows="4"
                    />
                  </div>
                  
                  <div>
                    <label className="block text-sm font-bold mb-2">‚úÖ Action Points</label>
                    <textarea 
                      value={meeting.actionPoints || ''} 
                      onChange={e => handleMeetingChange(idx, 'actionPoints', e.target.value)} 
                      placeholder="Enter action items and next steps..."
                      disabled={!isEditing} 
                      className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"
                      rows="3"
                    />
                  </div>
                  
                  {/* PDF Export Button */}
                  {!isEditing && meeting.meetingDate && (
                    <div className="mt-4 pt-3 border-t border-purple-200">
                      <button
                        onClick={() => {
                          const printWindow = window.open('', '_blank');
                          const meetingNum = (formData.meetingMinutes || []).length - idx;
                          const dateStr = meeting.meetingDate ? new Date(meeting.meetingDate).toLocaleDateString('en-IN', { weekday: 'long', day: '2-digit', month: 'long', year: 'numeric' }) : 'Not specified';
                          const timeStr = meeting.meetingTime || 'Not specified';
                          const attendeesStr = meeting.attendees || 'Not specified';
                          const discussedStr = (meeting.discussedPoints || 'No discussion points recorded').replace(/\n/g, '<br>');
                          const actionStr = (meeting.actionPoints || 'No action items recorded').replace(/\n/g, '<br>');
                          const updatedStr = meeting.updatedAt ? new Date(meeting.updatedAt).toLocaleString('en-IN') : 'N/A';
                          const updatedByStr = meeting.updatedBy ? ' by <strong>' + meeting.updatedBy + '</strong>' : '';
                          const nowStr = new Date().toLocaleString('en-IN');
                          
                          printWindow.document.write(
                            '<!DOCTYPE html><html><head><title>Meeting Minutes - ' + mySchool + '</title>' +
                            '<style>@media print { @page { margin: 1cm; size: A4; } body { -webkit-print-color-adjust: exact; print-color-adjust: exact; } }' +
                            'body { font-family: Arial, sans-serif; padding: 20px; color: #333; max-width: 800px; margin: 0 auto; }' +
                            '.header { display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 3px solid #7C3AED; padding-bottom: 15px; margin-bottom: 20px; }' +
                            '.logo { font-size: 24px; font-weight: bold; color: #7C3AED; }' +
                            '.meeting-badge { background: #7C3AED; color: white; padding: 8px 16px; border-radius: 20px; font-size: 14px; }' +
                            '.info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }' +
                            '.info-item { padding: 12px; background: #F9FAFB; border-radius: 8px; border-left: 4px solid #7C3AED; }' +
                            '.info-item label { font-size: 11px; color: #6B7280; text-transform: uppercase; display: block; margin-bottom: 4px; }' +
                            '.info-item span { font-weight: bold; color: #1F2937; font-size: 14px; }' +
                            '.section { margin-top: 20px; padding: 15px; background: #FAF5FF; border-radius: 8px; border: 1px solid #E9D5FF; }' +
                            '.section-title { font-weight: bold; color: #7C3AED; margin-bottom: 10px; font-size: 14px; }' +
                            '.section-content { white-space: pre-wrap; line-height: 1.8; font-size: 13px; color: #374151; }' +
                            '.footer { margin-top: 30px; padding-top: 15px; border-top: 2px solid #E9D5FF; font-size: 11px; color: #6B7280; display: flex; justify-content: space-between; }' +
                            '</style></head><body>' +
                            '<div class="header"><div><div class="logo">‡§Ö‡§µ‡§Ç‡§§‡•Ä Avanti Fellows</div>' +
                            '<h1 style="margin: 10px 0 5px; font-size: 22px; color: #1F2937;">Minutes of Meeting</h1>' +
                            '<p style="margin: 0; color: #6B7280; font-size: 14px;">üè´ ' + mySchool + '</p></div>' +
                            '<div class="meeting-badge">Meeting #' + meetingNum + '</div></div>' +
                            '<div class="info-grid"><div class="info-item"><label>üìÖ Date</label><span>' + dateStr + '</span></div>' +
                            '<div class="info-item"><label>üïê Time</label><span>' + timeStr + '</span></div></div>' +
                            '<div class="section"><div class="section-title">üë• Attendees</div><div class="section-content">' + attendeesStr + '</div></div>' +
                            '<div class="section"><div class="section-title">üí¨ Discussion Points</div><div class="section-content">' + discussedStr + '</div></div>' +
                            '<div class="section" style="background: #F0FDF4; border-color: #BBF7D0;"><div class="section-title" style="color: #059669;">‚úÖ Action Items</div><div class="section-content">' + actionStr + '</div></div>' +
                            '<div class="footer"><div><strong>Last Updated:</strong> ' + updatedStr + updatedByStr + '</div><div>Generated on: ' + nowStr + '</div></div>' +
                            '<script>window.onload = function() { setTimeout(function() { window.print(); }, 500); }</scr' + 'ipt></body></html>'
                          );
                          printWindow.document.close();
                        }}
                        className="px-4 py-2 bg-purple-600 text-white rounded-lg font-semibold text-sm hover:bg-purple-700 flex items-center gap-2"
                      >
                        üìÑ Export to PDF
                      </button>
                    </div>
                  )}
                </div>
              ))}
            </div>
          )}
        </div>

        {isEditing && (
        <button onClick={handleSubmit} className="w-full avanti-gradient text-white py-4 rounded-xl font-bold text-xl">
          üíæ Save School Information
        </button>
      )}
      </div>
    </div>
  );
}

// ========================================
// ADMIN SCHOOL INFO VIEW
// ========================================
function AdminSchoolInfo({schoolInfo}){
  const handleExport=()=>{
    const exportData=schoolInfo.map(info=>({
      School:info.school,
      'Principal Name':info.principalName,
      'Principal Phone':info.principalPhone,
      'Principal Email':info.principalEmail,
      'Vice Principal Name':info.vicePrincipalName,
      'Vice Principal Phone':info.vicePrincipalPhone,
      'Vice Principal Email':info.vicePrincipalEmail,
      'Coordinator Name':info.coordinatorName,
      'Coordinator Phone':info.coordinatorPhone,
      'Coordinator Email':info.coordinatorEmail,
      'WiFi in Classroom':info.wifiInClassroom,
      'WiFi Installed By':info.wifiInstalledBy,
      'WiFi Working':info.wifiWorking,
      'WiFi Monthly Bill':info.wifiMonthlyBill,
      'WiFi Connection Type':info.wifiConnectionType,
      'WiFi Network Name':info.wifiNetworkName,
      'Both Classes WiFi':info.bothClassesWifi,
      'Modules 11 Received':info.modules11Received,
      'Modules 11 Distributed':info.modules11Distributed,
      'Modules 11 Stock':info.modules11Stock,
      'Modules 11 Remarks':info.modules11Remarks||'',
      'Modules 12 Received':info.modules12Received,
      'Modules 12 Distributed':info.modules12Distributed,
      'Modules 12 Stock':info.modules12Stock,
      'Modules 12 Remarks':info.modules12Remarks||'',
      'Chromebooks 11 Distributed':info.chromebooks11Distributed,
      'Chromebooks 11 Count':info.chromebooks11Count,
      'Chromebooks 11 Working':info.chromebooks11Working,
      'Chromebooks 11 Brand':info.chromebooks11Brand,
      'Chromebooks 11 Date':info.chromebooks11DistributedDate,
      'Chromebooks 12 Distributed':info.chromebooks12Distributed,
      'Chromebooks 12 Count':info.chromebooks12Count,
      'Chromebooks 12 Working':info.chromebooks12Working,
      'Chromebooks 12 Brand':info.chromebooks12Brand,
      'Chromebooks 12 Date':info.chromebooks12DistributedDate,
      'Printer Available':info.printerAvailable,
      'Printer Working':info.printerWorking,
      'Printer Brand':info.printerBrand,
      'Printer Issued Date':info.printerIssuedDate,
      'Other Assets Count':info.otherAssets?info.otherAssets.length:0,
      'Last Updated':info.updatedAt?new Date(info.updatedAt).toLocaleString():''
    }));
    exportToExcel(exportData,'school_information');
  };

  return(
    <div className="space-y-6">
      <div className="flex justify-between items-center">
        <h2 className="text-3xl font-bold">üè´ School Information</h2>
        <button onClick={handleExport} className="px-6 py-3 bg-green-600 text-white rounded-xl font-semibold">
          üì• Export to Excel
        </button>
      </div>

      {schoolInfo.length===0?(
        <div className="bg-white p-8 rounded-2xl text-center">
          <p className="text-gray-600">No school information available yet. Teachers need to fill the forms.</p>
        </div>
      ):(
        <div className="space-y-6">
          {schoolInfo.map(info=>
            <div key={info.id} className="bg-white p-6 rounded-2xl shadow-lg">
              <div className="flex justify-between items-center mb-2">
  <h3 className="text-2xl font-bold">{info.school}</h3>
  <div className="text-right text-sm text-gray-600">
    <div>
      Last updated:{' '}
      {info.updatedAt ? new Date(info.updatedAt).toLocaleString() : 'N/A'}
    </div>
    {info.updatedByName && (
      <div>By: {info.updatedByName} ({info.updatedBy})</div>
    )}
  </div>
</div>

{info.updateHistory && info.updateHistory.length > 0 && (
  <div className="mb-4 bg-yellow-50 border-l-4 border-yellow-400 p-3 rounded">
    <div className="font-semibold mb-1">Edit history</div>
    <ul className="text-xs max-h-32 overflow-y-auto space-y-1">
      {info.updateHistory
        .slice()
        .sort((a, b) => new Date(a.updatedAt) - new Date(b.updatedAt))
        .map((entry, idx) => (
          <li key={idx}>
            {new Date(entry.updatedAt).toLocaleString()} ‚Äî {entry.updatedByName || entry.updatedBy}
          </li>
        ))}
    </ul>
  </div>
)}

              {/* Principal Info */}
              <div className="border-2 border-blue-300 rounded-xl p-4 mb-4 bg-blue-50">
                <h4 className="font-bold text-lg mb-3 text-blue-800">üë®‚Äçüíº Principal</h4>
                <div className="grid md:grid-cols-3 gap-3 text-sm">
                  <div><strong>Name:</strong> {info.principalName||'‚Äî'}</div>
                  <div><strong>Phone:</strong> {info.principalPhone||'‚Äî'}</div>
                  <div><strong>Email:</strong> {info.principalEmail||'‚Äî'}</div>
                </div>
              </div>

              {/* Vice Principal Info */}
              <div className="border-2 border-green-300 rounded-xl p-4 mb-4 bg-green-50">
                <h4 className="font-bold text-lg mb-3 text-green-800">üë®‚Äçüíº Vice Principal</h4>
                <div className="grid md:grid-cols-3 gap-3 text-sm">
                  <div><strong>Name:</strong> {info.vicePrincipalName||'‚Äî'}</div>
                  <div><strong>Phone:</strong> {info.vicePrincipalPhone||'‚Äî'}</div>
                  <div><strong>Email:</strong> {info.vicePrincipalEmail||'‚Äî'}</div>
                </div>
              </div>

              {/* Avanti Coordinator Info */}
              <div className="border-2 border-orange-300 rounded-xl p-4 mb-4 bg-orange-50">
                <h4 className="font-bold text-lg mb-3 text-orange-800">üë®‚Äçüíº Avanti Coordinator</h4>
                <div className="grid md:grid-cols-3 gap-3 text-sm">
                  <div><strong>Name:</strong> {info.coordinatorName||'‚Äî'}</div>
                  <div><strong>Phone:</strong> {info.coordinatorPhone||'‚Äî'}</div>
                  <div><strong>Email:</strong> {info.coordinatorEmail||'‚Äî'}</div>
                </div>
              </div>

              {/* WiFi Info */}
              <div className="border-2 border-purple-300 rounded-xl p-4 mb-4 bg-purple-50">
                <h4 className="font-bold text-lg mb-3 text-purple-800">üì∂ WiFi Connection</h4>
                <div className="grid md:grid-cols-3 gap-3 text-sm">
                  <div><strong>WiFi Available:</strong> {info.wifiInClassroom||'‚Äî'}</div>
                  {info.wifiInClassroom==='Yes'&&(
                    <>
                      <div><strong>Installed By:</strong> {info.wifiInstalledBy||'‚Äî'}</div>
                      <div><strong>Working:</strong> {info.wifiWorking||'‚Äî'}</div>
                      <div><strong>Monthly Bill:</strong> ‚Çπ{info.wifiMonthlyBill||'‚Äî'}</div>
                      <div><strong>Connection Type:</strong> {info.wifiConnectionType||'‚Äî'}</div>
                      <div><strong>Network:</strong> {info.wifiNetworkName||'‚Äî'}</div>
                      <div><strong>Both Classes WiFi:</strong> {info.bothClassesWifi||'‚Äî'}</div>
                    </>
                  )}
                </div>
              </div>

              {/* Modules Info */}
              <div className="grid md:grid-cols-2 gap-4 mb-4">
                <div className="border-2 border-green-300 rounded-xl p-4 bg-green-50">
                  <h4 className="font-bold text-lg mb-3 text-green-800">üìö Modules - Class 11</h4>
                  <div className="space-y-2 text-sm">
                    <div><strong>Received:</strong> {info.modules11Received||'‚Äî'}</div>
                    <div><strong>Distributed:</strong> {info.modules11Distributed||'‚Äî'}</div>
                    <div><strong>In Stock:</strong> {info.modules11Stock||'‚Äî'}</div>
                    {info.modules11Remarks && <div className="mt-2 p-2 bg-white rounded border border-green-200"><strong>üìù Remarks:</strong> {info.modules11Remarks}</div>}
                  </div>
                </div>
                <div className="border-2 border-blue-300 rounded-xl p-4 bg-blue-50">
                  <h4 className="font-bold text-lg mb-3 text-blue-800">üìö Modules - Class 12</h4>
                  <div className="space-y-2 text-sm">
                    <div><strong>Received:</strong> {info.modules12Received||'‚Äî'}</div>
                    <div><strong>Distributed:</strong> {info.modules12Distributed||'‚Äî'}</div>
                    <div><strong>In Stock:</strong> {info.modules12Stock||'‚Äî'}</div>
                    {info.modules12Remarks && <div className="mt-2 p-2 bg-white rounded border border-blue-200"><strong>üìù Remarks:</strong> {info.modules12Remarks}</div>}
                  </div>
                </div>
              </div>

              {/* Reference Books */}
              {info.referenceBooks&&info.referenceBooks.length>0&&(
                <div className="border-2 border-yellow-300 rounded-xl p-4 mb-4 bg-yellow-50">
                  <h4 className="font-bold text-lg mb-3 text-yellow-800">üìñ Reference Books</h4>
                  <div className="overflow-x-auto">
                    <table className="w-full text-sm">
                      <thead className="bg-yellow-200">
                        <tr>
                          <th className="p-2 text-left">Book Name</th>
                          <th className="p-2 text-left">Publisher</th>
                          <th className="p-2 text-left">Author</th>
                          <th className="p-2 text-left">Price</th>
                          <th className="p-2 text-left">In Stock</th>
                          <th className="p-2 text-left">Distributed</th>
                        </tr>
                      </thead>
                      <tbody>
                        {info.referenceBooks.map((book,idx)=>
                          <tr key={idx} className="border-b border-yellow-200">
                            <td className="p-2">{book.bookName||'‚Äî'}</td>
                            <td className="p-2">{book.publisher||'‚Äî'}</td>
                            <td className="p-2">{book.author||'‚Äî'}</td>
                            <td className="p-2">‚Çπ{book.price||'‚Äî'}</td>
                            <td className="p-2">{book.inStock||'‚Äî'}</td>
                            <td className="p-2">{book.distributed||'‚Äî'}</td>
                          </tr>
                        )}
                      </tbody>
                    </table>
                  </div>
                </div>
              )}

              {/* Chromebooks Info */}
              <div className="grid md:grid-cols-2 gap-4 mb-4">
                <div className="border-2 border-indigo-300 rounded-xl p-4 bg-indigo-50">
                  <h4 className="font-bold text-lg mb-3 text-indigo-800">üíª Chromebooks - Class 11</h4>
                  <div className="space-y-2 text-sm">
                    <div><strong>Distributed from Avanti:</strong> {info.chromebooks11Distributed||'‚Äî'}</div>
                    {info.chromebooks11Distributed==='Yes'?(
                      <>
                        <div><strong>Count:</strong> {info.chromebooks11Count||'‚Äî'}</div>
                        <div><strong>Working:</strong> {info.chromebooks11Working||'‚Äî'}</div>
                        <div><strong>Brand:</strong> {info.chromebooks11Brand||'‚Äî'}</div>
                        <div><strong>Distributed:</strong> {info.chromebooks11DistributedDate||'‚Äî'}</div>
                      </>
                    ):(
                      <>
                        <div><strong>Test Method:</strong> {info.chromebooks11TestMethod||'‚Äî'}</div>
                        <div><strong>JNV Lab Access:</strong> {info.chromebooks11JNVLabAccess||'‚Äî'}</div>
                        <div><strong>JNV Devices:</strong> {info.chromebooks11JNVCount||'‚Äî'}</div>
                      </>
                    )}
                  </div>
                </div>
                <div className="border-2 border-pink-300 rounded-xl p-4 bg-pink-50">
                  <h4 className="font-bold text-lg mb-3 text-pink-800">üíª Chromebooks - Class 12</h4>
                  <div className="space-y-2 text-sm">
                    <div><strong>Distributed from Avanti:</strong> {info.chromebooks12Distributed||'‚Äî'}</div>
                    {info.chromebooks12Distributed==='Yes'?(
                      <>
                        <div><strong>Count:</strong> {info.chromebooks12Count||'‚Äî'}</div>
                        <div><strong>Working:</strong> {info.chromebooks12Working||'‚Äî'}</div>
                        <div><strong>Brand:</strong> {info.chromebooks12Brand||'‚Äî'}</div>
                        <div><strong>Distributed:</strong> {info.chromebooks12DistributedDate||'‚Äî'}</div>
                      </>
                    ):(
                      <>
                        <div><strong>Test Method:</strong> {info.chromebooks12TestMethod||'‚Äî'}</div>
                        <div><strong>JNV Lab Access:</strong> {info.chromebooks12JNVLabAccess||'‚Äî'}</div>
                        <div><strong>JNV Devices:</strong> {info.chromebooks12JNVCount||'‚Äî'}</div>
                      </>
                    )}
                  </div>
                </div>
              </div>

              {/* Printer Info */}
              <div className="border-2 border-cyan-300 rounded-xl p-4 mb-4 bg-cyan-50">
                <h4 className="font-bold text-lg mb-3 text-cyan-800">üñ®Ô∏è Printer</h4>
                <div className="grid md:grid-cols-2 gap-3 text-sm">
                  <div><strong>Printer Available:</strong> {info.printerAvailable||'‚Äî'}</div>
                  {info.printerAvailable==='Yes'&&(
                    <>
                      <div><strong>Working:</strong> {info.printerWorking||'‚Äî'}</div>
                      <div><strong>Brand:</strong> {info.printerBrand||'‚Äî'}</div>
                      <div><strong>Issued:</strong> {info.printerIssuedDate||'‚Äî'}</div>
                    </>
                  )}
                </div>
              </div>

              {/* Other Assets */}
              {info.otherAssets&&info.otherAssets.length>0&&(
                <div className="border-2 border-teal-300 rounded-xl p-4 mb-4 bg-teal-50">
                  <h4 className="font-bold text-lg mb-3 text-teal-800">üì¶ Other Assets ({info.otherAssets.length})</h4>
                  <div className="overflow-x-auto">
                    <table className="w-full text-sm">
                      <thead className="bg-teal-200">
                        <tr>
                          <th className="p-2 text-left">Asset Name</th>
                          <th className="p-2 text-left">Quantity</th>
                          <th className="p-2 text-left">Condition</th>
                          <th className="p-2 text-left">Notes</th>
                        </tr>
                      </thead>
                      <tbody>
                        {info.otherAssets.map((asset,idx)=>
                          <tr key={idx} className="border-b border-teal-200">
                            <td className="p-2 font-semibold">{asset.assetName||'‚Äî'}</td>
                            <td className="p-2">{asset.assetQuantity||'‚Äî'}</td>
                            <td className="p-2">
                              <span className={`px-2 py-1 rounded-full text-xs font-bold ${
                                asset.assetCondition==='Working'?'bg-green-100 text-green-700':
                                asset.assetCondition==='Not Working'?'bg-red-100 text-red-700':
                                'bg-yellow-100 text-yellow-700'
                              }`}>
                                {asset.assetCondition||'‚Äî'}
                              </span>
                            </td>
                            <td className="p-2">{asset.assetNotes||'‚Äî'}</td>
                          </tr>
                        )}
                      </tbody>
                    </table>
                  </div>
                </div>
              )}

              {/* Meeting Minutes Section */}
              {info.meetingMinutes && info.meetingMinutes.length > 0 && (
                <div className="border-2 border-purple-300 rounded-xl p-4 bg-purple-50">
                  <h4 className="font-bold text-lg mb-3 text-purple-800">üìù Meeting Minutes ({info.meetingMinutes.length})</h4>
                  <div className="space-y-3">
                    {info.meetingMinutes.map((meeting, idx) => (
                      <div key={idx} className="bg-white p-4 rounded-lg border border-purple-200">
                        <div className="flex justify-between items-start mb-3">
                          <div className="flex items-center gap-3">
                            <span className="px-3 py-1 bg-purple-600 text-white rounded-full text-xs font-semibold">
                              Meeting #{info.meetingMinutes.length - idx}
                            </span>
                            <span className="text-sm text-gray-600">
                              {meeting.meetingDate ? new Date(meeting.meetingDate).toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' }) : 'No date'} 
                              {meeting.meetingTime && ` at ${meeting.meetingTime}`}
                            </span>
                          </div>
                          <button
                            onClick={() => {
                              const printWindow = window.open('', '_blank');
                              const meetingNum = info.meetingMinutes.length - idx;
                              const schoolName = info.school;
                              const dateStr = meeting.meetingDate ? new Date(meeting.meetingDate).toLocaleDateString('en-IN', { weekday: 'long', day: '2-digit', month: 'long', year: 'numeric' }) : 'N/A';
                              const timeStr = meeting.meetingTime || 'N/A';
                              const attendeesStr = meeting.attendees || 'Not specified';
                              const discussedStr = (meeting.discussedPoints || 'No points recorded').replace(/\n/g, '<br>');
                              const actionStr = (meeting.actionPoints || 'No action items').replace(/\n/g, '<br>');
                              const updatedStr = meeting.updatedAt ? new Date(meeting.updatedAt).toLocaleString('en-IN') : 'N/A';
                              const updatedByStr = meeting.updatedBy || 'Unknown';
                              const nowStr = new Date().toLocaleString('en-IN');
                              
                              printWindow.document.write(
                                '<!DOCTYPE html><html><head><title>Meeting Minutes - ' + schoolName + '</title>' +
                                '<style>@media print { @page { margin: 1cm; size: A4; } body { -webkit-print-color-adjust: exact; } }' +
                                'body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; color: #333; }' +
                                '.header { display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 3px solid #7C3AED; padding-bottom: 15px; margin-bottom: 20px; }' +
                                '.logo { font-size: 24px; font-weight: bold; color: #7C3AED; }' +
                                '.meeting-badge { background: #7C3AED; color: white; padding: 8px 16px; border-radius: 20px; }' +
                                '.info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }' +
                                '.info-item { padding: 12px; background: #F9FAFB; border-radius: 8px; border-left: 4px solid #7C3AED; }' +
                                '.info-item label { font-size: 11px; color: #6B7280; text-transform: uppercase; display: block; margin-bottom: 4px; }' +
                                '.info-item span { font-weight: bold; color: #1F2937; }' +
                                '.section { margin-top: 20px; padding: 15px; background: #FAF5FF; border-radius: 8px; border: 1px solid #E9D5FF; }' +
                                '.section-title { font-weight: bold; color: #7C3AED; margin-bottom: 10px; }' +
                                '.section-content { white-space: pre-wrap; line-height: 1.8; }' +
                                '.footer { margin-top: 30px; padding-top: 15px; border-top: 2px solid #E9D5FF; font-size: 11px; color: #666; display: flex; justify-content: space-between; }' +
                                '</style></head><body>' +
                                '<div class="header"><div><div class="logo">‡§Ö‡§µ‡§Ç‡§§‡•Ä Avanti Fellows</div>' +
                                '<h1 style="margin: 10px 0 5px; font-size: 22px;">Minutes of Meeting</h1>' +
                                '<p style="margin: 0; color: #666;">üè´ ' + schoolName + '</p></div>' +
                                '<div class="meeting-badge">Meeting #' + meetingNum + '</div></div>' +
                                '<div class="info-grid"><div class="info-item"><label>üìÖ Date</label><span>' + dateStr + '</span></div>' +
                                '<div class="info-item"><label>üïê Time</label><span>' + timeStr + '</span></div></div>' +
                                '<div class="section"><div class="section-title">üë• Attendees</div><div class="section-content">' + attendeesStr + '</div></div>' +
                                '<div class="section"><div class="section-title">üí¨ Discussion Points</div><div class="section-content">' + discussedStr + '</div></div>' +
                                '<div class="section" style="background: #F0FDF4; border-color: #BBF7D0;"><div class="section-title" style="color: #059669;">‚úÖ Action Items</div><div class="section-content">' + actionStr + '</div></div>' +
                                '<div class="footer"><div>Updated: ' + updatedStr + ' by ' + updatedByStr + '</div><div>Generated: ' + nowStr + '</div></div>' +
                                '<script>window.onload = function() { setTimeout(function() { window.print(); }, 500); }</scr' + 'ipt></body></html>'
                              );
                              printWindow.document.close();
                            }}
                            className="px-3 py-1 bg-purple-600 text-white rounded-lg text-xs font-semibold hover:bg-purple-700"
                          >
                            üìÑ Export PDF
                          </button>
                        </div>
                        <div className="text-sm space-y-2">
                          <div><strong className="text-purple-700">üë• Attendees:</strong> {meeting.attendees || 'Not specified'}</div>
                          <div><strong className="text-purple-700">üí¨ Discussed:</strong> {meeting.discussedPoints?.substring(0, 150)}{meeting.discussedPoints?.length > 150 ? '...' : '' || 'No points'}</div>
                          {meeting.actionPoints && (
                            <div><strong className="text-green-700">‚úÖ Actions:</strong> {meeting.actionPoints.substring(0, 100)}{meeting.actionPoints.length > 100 ? '...' : ''}</div>
                          )}
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              )}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
// ========================================
// TEACHER DIRECTORY
// ========================================
function TeacherDirectory({ teachers, currentUser }) {
  const [searchTerm, setSearchTerm] = useState('');
  const [filterSchool, setFilterSchool] = useState('All');
  const [filterSubject, setFilterSubject] = useState('All');
  const [selectedTeacher, setSelectedTeacher] = useState(null);

  // Get unique schools
  const schools = ['All', ...new Set(teachers.map(t => t.school))];

  // Filter teachers
  const filteredTeachers = teachers.filter(teacher => {
    const matchesSearch = teacher.name?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                         teacher.email?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                         teacher.phone?.includes(searchTerm);
    const matchesSchool = filterSchool === 'All' || teacher.school === filterSchool;
    const matchesSubject = filterSubject === 'All' || teacher.subject === filterSubject;
    return matchesSearch && matchesSchool && matchesSubject;
  });

  // Get subject icon
  const getSubjectIcon = (subject) => {
    const icons = {
      'Physics': '‚öõÔ∏è',
      'Chemistry': 'üß™',
      'Mathematics': 'üìê',
      'Biology': 'üß¨'
    };
    return icons[subject] || 'üìö';
  };

  // Get school color
  const getSchoolColor = (school) => {
    const colors = {
      'CoE Barwani': 'from-blue-500 to-blue-600',
      'CoE Cuttak': 'from-green-500 to-green-600',
      'CoE Bundi': 'from-purple-500 to-purple-600',
      'CoE Mahisagar': 'from-orange-500 to-orange-600',
      'EMRS Bhopal': 'from-pink-500 to-pink-600',
      'JNV Bharuch': 'from-red-500 to-red-600'
    };
    return colors[school] || 'from-gray-500 to-gray-600';
  };

  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <h2 className="text-3xl font-bold">üìñ Teacher Directory</h2>
        <div className="text-lg font-semibold text-gray-600">
          {filteredTeachers.length} {filteredTeachers.length === 1 ? 'Teacher' : 'Teachers'}
        </div>
      </div>

      {/* Search and Filters */}
      <div className="bg-white p-6 rounded-2xl shadow-lg">
        <div className="grid md:grid-cols-3 gap-4">
          {/* Search */}
          <div>
            <label className="block text-sm font-semibold mb-2">üîç Search</label>
            <input
              type="text"
              placeholder="Name, email, or phone..."
              value={searchTerm}
              onChange={(e) => setSearchTerm(e.target.value)}
              className="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-yellow-500"
            />
          </div>

          {/* School Filter */}
          <div>
            <label className="block text-sm font-semibold mb-2">üè´ School</label>
            <select
              value={filterSchool}
              onChange={(e) => setFilterSchool(e.target.value)}
              className="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-yellow-500"
            >
              {schools.map(school => (
                <option key={school} value={school}>{school}</option>
              ))}
            </select>
          </div>

          {/* Subject Filter */}
          <div>
            <label className="block text-sm font-semibold mb-2">üìö Subject</label>
            <select
              value={filterSubject}
              onChange={(e) => setFilterSubject(e.target.value)}
              className="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-yellow-500"
            >
              <option value="All">All Subjects</option>
              {SUBJECTS.map(subject => (
                <option key={subject} value={subject}>{subject}</option>
              ))}
            </select>
          </div>
        </div>
      </div>

      {/* Teacher Cards Grid */}
      {filteredTeachers.length === 0 ? (
        <div className="bg-white p-12 rounded-2xl shadow-lg text-center">
          <div className="text-6xl mb-4">üîç</div>
          <div className="text-xl font-semibold text-gray-600">No teachers found</div>
          <div className="text-gray-500 mt-2">Try adjusting your search filters</div>
        </div>
      ) : (
        <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
          {filteredTeachers.map((teacher) => (
            <div
              key={teacher.docId}
              className={`bg-white rounded-2xl shadow-lg hover:shadow-2xl transition-all duration-300 overflow-hidden cursor-pointer transform hover:-translate-y-1 ${
                teacher.isArchived ? 'ring-2 ring-red-400 opacity-75' : ''
              }`}
              onClick={() => setSelectedTeacher(teacher)}
            >
              {/* Archived Banner */}
              {teacher.isArchived && (
                <div className="bg-red-500 text-white text-center py-1 text-xs font-bold">
                  üì¶ ARCHIVED - {teacher.archiveReason || 'Unknown'}
                </div>
              )}
              
              {/* Header with gradient */}
              <div className={`bg-gradient-to-r ${teacher.isArchived ? 'from-gray-400 to-gray-500' : getSchoolColor(teacher.school)} p-4 text-white`}>
                <div className="flex items-start justify-between">
                  <div className="flex-1">
                    <div className="text-xs font-semibold opacity-90 mb-1">{teacher.school}</div>
                    <div className="text-sm opacity-90">{teacher.grade || 'Class 11 & 12'}</div>
                  </div>
                  <div className="text-3xl">
                    {teacher.isArchived ? 'üì¶' : getSubjectIcon(teacher.subject)}
                  </div>
                </div>
              </div>

              {/* Profile Photo */}
              <div className="flex justify-center -mt-10 mb-4">
                {teacher.profilePhoto ? (
                  <img
                    src={teacher.profilePhoto}
                    alt={teacher.name}
                    className={`w-20 h-20 rounded-full border-4 shadow-lg object-cover ${
                      teacher.isArchived ? 'border-red-300 grayscale' : 'border-white'
                    }`}
                  />
                ) : (
                  <div className={`w-20 h-20 rounded-full border-4 shadow-lg flex items-center justify-center text-3xl font-bold text-white ${
                    teacher.isArchived 
                      ? 'border-red-300 bg-gradient-to-br from-gray-400 to-gray-500' 
                      : 'border-white bg-gradient-to-br from-gray-300 to-gray-400'
                  }`}>
                    {teacher.name?.charAt(0) || '?'}
                  </div>
                )}
              </div>

              {/* Teacher Info */}
              <div className="px-4 pb-4 space-y-3">
                {/* Name */}
                <div className="text-center">
                  <div className={`text-xl font-bold ${teacher.isArchived ? 'text-red-600' : 'text-gray-800'}`}>
                    {teacher.name}
                    {teacher.isArchived && <span className="text-sm ml-1">(Archived)</span>}
                  </div>
                  <div className="text-sm font-semibold text-gray-600">{teacher.subject}</div>
                  
                  {/* Archive Reason Badge */}
                  {teacher.isArchived && (
                    <div className="mt-2">
                      <span className={`px-3 py-1 rounded-full text-xs font-bold ${
                        teacher.archiveReason === 'Resigned' ? 'bg-yellow-100 text-yellow-800' :
                        teacher.archiveReason === 'Removed' ? 'bg-red-100 text-red-800' :
                        teacher.archiveReason === 'Transferred' ? 'bg-blue-100 text-blue-800' :
                        teacher.archiveReason === 'On Long Leave' ? 'bg-purple-100 text-purple-800' :
                        'bg-gray-100 text-gray-800'
                      }`}>
                        {teacher.archiveReason === 'Resigned' && 'üòî '}
                        {teacher.archiveReason === 'Removed' && '‚ùå '}
                        {teacher.archiveReason === 'Transferred' && 'üîÑ '}
                        {teacher.archiveReason === 'On Long Leave' && 'üèñÔ∏è '}
                        {teacher.archiveReason || 'Archived'}
                      </span>
                      {teacher.archivedAt && (
                        <div className="text-xs text-gray-500 mt-1">
                          Since {new Date(teacher.archivedAt).toLocaleDateString()}
                        </div>
                      )}
                    </div>
                  )}
                </div>

                {/* Contact Info */}
                <div className="space-y-2 text-sm">
                  {teacher.phone && (
                    <div className="flex items-center gap-2 text-gray-700">
                      <span className="text-lg">üì±</span>
                      <span className="font-medium">{teacher.phone}</span>
                    </div>
                  )}
                  
                  {teacher.whatsapp && (
                    <div className="flex items-center gap-2 text-gray-700">
                      <span className="text-lg">üí¨</span>
                      <span className="font-medium">{teacher.whatsapp}</span>
                    </div>
                  )}
                  
                  {teacher.email && (
                    <div className="flex items-center gap-2 text-gray-700">
                      <span className="text-lg">üìß</span>
                      <span className="font-medium text-xs break-all">{teacher.email}</span>
                    </div>
                  )}
                </div>

                {/* Dates */}
                <div className="grid grid-cols-2 gap-2 pt-2 border-t">
                  {teacher.dateOfJoining && (
                    <div className="text-center">
                      <div className="text-xs text-gray-500">Joined</div>
                      <div className="text-sm font-semibold text-gray-700">
                        {new Date(teacher.dateOfJoining).toLocaleDateString('en-IN', { day: 'numeric', month: 'short', year: 'numeric' })}
                      </div>
                    </div>
                  )}
                  {teacher.dateOfBirth && (
                    <div className="text-center">
                      <div className="text-xs text-gray-500">Birthday</div>
                      <div className="text-sm font-semibold text-gray-700">
                        {new Date(teacher.dateOfBirth).toLocaleDateString('en-IN', { day: 'numeric', month: 'short' })}
                      </div>
                    </div>
                  )}
                </div>

                {/* Click for more */}
                <div className="text-center pt-2">
                  <button className="text-xs text-blue-600 font-semibold hover:text-blue-800">
                    Click for full details ‚Üí
                  </button>
                </div>
              </div>
            </div>
          ))}
        </div>
      )}

      {/* Teacher Detail Modal */}
      {selectedTeacher && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setSelectedTeacher(null)}>
          <div className="bg-white rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto" onClick={(e) => e.stopPropagation()}>
            {/* Archived Warning Banner */}
            {selectedTeacher.isArchived && (
              <div className="bg-red-500 text-white p-4">
                <div className="flex items-center justify-center gap-2">
                  <span className="text-2xl">üì¶</span>
                  <div>
                    <div className="font-bold">This teacher has been archived</div>
                    <div className="text-sm opacity-90">
                      Reason: {selectedTeacher.archiveReason || 'Not specified'}
                      {selectedTeacher.archivedAt && ` ‚Ä¢ Since ${new Date(selectedTeacher.archivedAt).toLocaleDateString()}`}
                    </div>
                    {selectedTeacher.archiveNotes && (
                      <div className="text-sm opacity-80 mt-1">Notes: {selectedTeacher.archiveNotes}</div>
                    )}
                  </div>
                </div>
              </div>
            )}
            
            {/* Header */}
            <div className={`bg-gradient-to-r ${selectedTeacher.isArchived ? 'from-gray-400 to-gray-500' : getSchoolColor(selectedTeacher.school)} p-6 text-white relative`}>
              <button
                onClick={() => setSelectedTeacher(null)}
                className="absolute top-4 right-4 text-white text-2xl hover:text-gray-200 w-10 h-10 flex items-center justify-center rounded-full hover:bg-white/20"
              >
                √ó
              </button>
              <div className="flex items-center gap-4">
                {selectedTeacher.profilePhoto ? (
                  <img
                    src={selectedTeacher.profilePhoto}
                    alt={selectedTeacher.name}
                    className={`w-24 h-24 rounded-full border-4 border-white shadow-lg object-cover ${selectedTeacher.isArchived ? 'grayscale' : ''}`}
                  />
                ) : (
                  <div className="w-24 h-24 rounded-full border-4 border-white shadow-lg bg-white/30 flex items-center justify-center text-4xl font-bold">
                    {selectedTeacher.name?.charAt(0) || '?'}
                  </div>
                )}
                <div className="flex-1">
                  <div className="text-2xl font-bold">
                    {selectedTeacher.name}
                    {selectedTeacher.isArchived && <span className="text-sm ml-2 bg-red-600 px-2 py-1 rounded">Archived</span>}
                  </div>
                  <div className="text-lg opacity-90">{selectedTeacher.subject}</div>
                  <div className="text-sm opacity-80 mt-1">{selectedTeacher.school}</div>
                </div>
              </div>
            </div>

            {/* Content */}
            <div className="p-6 space-y-6">
              {/* Contact Information */}
              <div>
                <div className="text-lg font-bold mb-3 flex items-center gap-2">
                  <span>üìû</span> Contact Information
                </div>
                <div className="bg-gray-50 rounded-xl p-4 space-y-3">
                  {selectedTeacher.phone && (
                    <div className="flex items-center justify-between">
                      <span className="text-gray-600 font-medium">Phone:</span>
                      <a href={`tel:${selectedTeacher.phone}`} className="text-blue-600 font-semibold hover:underline">
                        {selectedTeacher.phone}
                      </a>
                    </div>
                  )}
                  {selectedTeacher.whatsapp && (
                    <div className="flex items-center justify-between">
                      <span className="text-gray-600 font-medium">WhatsApp:</span>
                      <a href={`https://wa.me/${selectedTeacher.whatsapp.replace(/[^0-9]/g, '')}`} target="_blank" rel="noopener noreferrer" className="text-green-600 font-semibold hover:underline">
                        {selectedTeacher.whatsapp}
                      </a>
                    </div>
                  )}
                  {selectedTeacher.email && (
                    <div className="flex items-start justify-between">
                      <span className="text-gray-600 font-medium">Email:</span>
                      <a href={`mailto:${selectedTeacher.email}`} className="text-blue-600 font-semibold hover:underline text-right break-all">
                        {selectedTeacher.email}
                      </a>
                    </div>
                  )}
                </div>
              </div>

              {/* Personal Information */}
              <div>
                <div className="text-lg font-bold mb-3 flex items-center gap-2">
                  <span>üë§</span> Personal Information
                </div>
                <div className="bg-gray-50 rounded-xl p-4 space-y-3">
                  <div className="flex items-center justify-between">
                    <span className="text-gray-600 font-medium">Class:</span>
                    <span className="font-semibold">{selectedTeacher.grade || 'Class 11 & 12'}</span>
                  </div>
                  {selectedTeacher.dateOfBirth && (
                    <div className="flex items-center justify-between">
                      <span className="text-gray-600 font-medium">Date of Birth:</span>
                      <span className="font-semibold">
                        {new Date(selectedTeacher.dateOfBirth).toLocaleDateString('en-IN', { day: 'numeric', month: 'long', year: 'numeric' })}
                      </span>
                    </div>
                  )}
                  {selectedTeacher.dateOfJoining && (
                    <div className="flex items-center justify-between">
                      <span className="text-gray-600 font-medium">Date of Joining:</span>
                      <span className="font-semibold">
                        {new Date(selectedTeacher.dateOfJoining).toLocaleDateString('en-IN', { day: 'numeric', month: 'long', year: 'numeric' })}
                      </span>
                    </div>
                  )}
                  {selectedTeacher.anniversary && (
                    <div className="flex items-center justify-between">
                      <span className="text-gray-600 font-medium">Anniversary:</span>
                      <span className="font-semibold">
                        {new Date(selectedTeacher.anniversary).toLocaleDateString('en-IN', { day: 'numeric', month: 'long' })}
                      </span>
                    </div>
                  )}
                </div>
              </div>

              {/* Additional Details */}
              {(selectedTeacher.additionalDetails || selectedTeacher.qualification || selectedTeacher.experience || selectedTeacher.bio) && (
                <div>
                  <div className="text-lg font-bold mb-3 flex items-center gap-2">
                    <span>üìù</span> Additional Information
                  </div>
                  <div className="bg-gray-50 rounded-xl p-4 space-y-3">
                    {selectedTeacher.qualification && (
                      <div>
                        <span className="text-gray-600 font-medium">Qualification:</span>
                        <div className="font-semibold mt-1">{selectedTeacher.qualification}</div>
                      </div>
                    )}
                    {selectedTeacher.experience && (
                      <div>
                        <span className="text-gray-600 font-medium">Experience:</span>
                        <div className="font-semibold mt-1">{selectedTeacher.experience}</div>
                      </div>
                    )}
                    {selectedTeacher.bio && (
                      <div>
                        <span className="text-gray-600 font-medium">About:</span>
                        <div className="font-semibold mt-1">{selectedTeacher.bio}</div>
                      </div>
                    )}
                    {selectedTeacher.additionalDetails && (
                      <div>
                        <span className="text-gray-600 font-medium">Notes:</span>
                        <div className="font-semibold mt-1">{selectedTeacher.additionalDetails}</div>
                      </div>
                    )}
                  </div>
                </div>
              )}

              {/* Action Buttons */}
              <div className="grid grid-cols-2 gap-3 pt-4">
                {selectedTeacher.phone && (
                  <a
                    href={`tel:${selectedTeacher.phone}`}
                    className="bg-blue-500 text-white px-4 py-3 rounded-xl font-semibold text-center hover:bg-blue-600 transition-colors"
                  >
                    üì± Call
                  </a>
                )}
                {selectedTeacher.whatsapp && (
                  <a
                    href={`https://wa.me/${selectedTeacher.whatsapp.replace(/[^0-9]/g, '')}`}
                    target="_blank"
                    rel="noopener noreferrer"
                    className="bg-green-500 text-white px-4 py-3 rounded-xl font-semibold text-center hover:bg-green-600 transition-colors"
                  >
                    üí¨ WhatsApp
                  </a>
                )}
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
// ========================================
// TEACHER EXAM STATISTICS
// ========================================
function TeacherExamStats({ currentUser }) {
  const [examRegistrations, setExamRegistrations] = useState([]);
  const [students, setStudents] = useState([]);
  const [filterGrade, setFilterGrade] = useState('All');
  const [filterGender, setFilterGender] = useState('All');
  const [filterStatus, setFilterStatus] = useState('All');   // Completed / Partial / NotDone / NeedHelp
  const [filterExam, setFilterExam] = useState('All');

  useEffect(() => {
    const fetchData = async () => {
      // All exam registrations
      const regsSnap = await db.collection('studentExamRegistrations').get();
      setExamRegistrations(regsSnap.docs.map(d => ({ ...d.data(), id: d.id })));

      // Students of this school ‚Äì be sure `id` is the student ID
      const stuSnap = await db.collection('students')
        .where('school', '==', currentUser.school)
        .get();

      const studentsData = stuSnap.docs.map(d => {
        const data = d.data();
        let studentId = data.id;
        if (!studentId) {
          const parts = d.id.split('_');      // e.g. JNV_Barwani_1234
          studentId = parts[parts.length - 1];
        }
        return { ...data, id: studentId, docId: d.id };
      });

      setStudents(studentsData);
    };
    fetchData();
  }, [currentUser.school]);

  // Options for filters
  const gradeOptions = Array.from(new Set(students.map(s => s.grade).filter(Boolean))).sort();
  const genderOptions = Array.from(new Set(students.map(s => s.gender).filter(Boolean))).sort();
  const examOptions = Array.from(
    new Set(
      examRegistrations.flatMap(r => (r.exams || []).map(e => e.examName)).filter(Boolean)
    )
  ).sort();

  // Students in this school after basic filters
  const filteredStudents = students.filter(s => {
    if (filterGrade !== 'All' && s.grade !== filterGrade) return false;
    if (filterGender !== 'All' && (s.gender || '') !== filterGender) return false;
    return true;
  });

  // Flatten exam registrations ‚Üí one row per student+exam, with all filters applied
  const detailRows = [];
  examRegistrations.forEach(reg => {
    const student = filteredStudents.find(s => s.id === reg.studentId);
    if (!student) return;
    (reg.exams || []).forEach(exam => {
      if (filterExam !== 'All' && exam.examName !== filterExam) return;

      if (filterStatus === 'Completed' && exam.registrationStatus !== 'Yes') return;
      if (filterStatus === 'Partial' && exam.registrationStatus !== 'Partially') return;
      if (filterStatus === 'NotDone' && exam.registrationStatus !== 'No') return;
      if (filterStatus === 'NeedHelp' && exam.needSupport !== 'Yes') return;

      detailRows.push({ student, reg, exam });
    });
  });

  const totalStudents = filteredStudents.length;
  const studentsWithRegs = new Set(detailRows.map(r => r.reg.studentId)).size;
  const pendingStudents = totalStudents - studentsWithRegs;

  // Exam-wise stats from filtered rows
  const examStats = {};
  detailRows.forEach(({ exam }) => {
    const name = exam.examName || 'Other';
    if (!examStats[name]) {
      examStats[name] = { completed: 0, partial: 0, notCompleted: 0, needSupport: 0 };
    }
    if (exam.registrationStatus === 'Yes') examStats[name].completed++;
    if (exam.registrationStatus === 'Partially') examStats[name].partial++;
    if (exam.registrationStatus === 'No') examStats[name].notCompleted++;
    if (exam.needSupport === 'Yes') examStats[name].needSupport++;
  });

  return (
    <div className="space-y-6">
      <h2 className="text-3xl font-bold">üìä Exam Statistics - {currentUser.school}</h2>

      {/* Summary cards */}
      <div className="grid md:grid-cols-3 gap-4">
        <div className="stat-card bg-blue-500 text-white">
          <div className="text-sm opacity-90">Total Students</div>
          <div className="text-5xl font-bold">{totalStudents}</div>
        </div>
        <div className="stat-card bg-green-500 text-white">
          <div className="text-sm opacity-90">Registered</div>
          <div className="text-5xl font-bold">{studentsWithRegs}</div>
        </div>
        <div className="stat-card bg-orange-500 text-white">
          <div className="text-sm opacity-90">Pending</div>
          <div className="text-5xl font-bold">{pendingStudents}</div>
        </div>
      </div>

      {/* Filters */}
      <div className="bg-white p-6 rounded-2xl shadow-lg">
        <h3 className="text-xl font-bold mb-4">üîç Filters</h3>
        <div className="grid md:grid-cols-4 gap-4">
          <div>
            <label className="block text-sm font-bold mb-2">Grade</label>
            <select
              value={filterGrade}
              onChange={e => setFilterGrade(e.target.value)}
              className="w-full border-2 px-4 py-3 rounded-xl"
            >
              <option value="All">All Grades</option>
              {gradeOptions.map(g => (
                <option key={g} value={g}>Class {g}</option>
              ))}
            </select>
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">Gender</label>
            <select
              value={filterGender}
              onChange={e => setFilterGender(e.target.value)}
              className="w-full border-2 px-4 py-3 rounded-xl"
            >
              <option value="All">All</option>
              {genderOptions.map(g => (
                <option key={g} value={g}>{g}</option>
              ))}
            </select>
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">Exam Name</label>
            <select
              value={filterExam}
              onChange={e => setFilterExam(e.target.value)}
              className="w-full border-2 px-4 py-3 rounded-xl"
            >
              <option value="All">All Exams</option>
              {examOptions.map(name => (
                <option key={name} value={name}>{name}</option>
              ))}
            </select>
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">Status</label>
            <select
              value={filterStatus}
              onChange={e => setFilterStatus(e.target.value)}
              className="w-full border-2 px-4 py-3 rounded-xl"
            >
              <option value="All">All</option>
              <option value="Completed">Completed</option>
              <option value="Partial">Partial</option>
              <option value="NotDone">Not Done</option>
              <option value="NeedHelp">Need Help</option>
            </select>
          </div>
        </div>
      </div>

      {/* Exam-wise status table */}
      <div className="bg-white p-6 rounded-2xl shadow-lg">
        <h3 className="text-xl font-bold mb-4">üìã Exam-wise Status</h3>
        <div className="overflow-x-auto">
          <table className="w-full">
            <thead className="avanti-gradient-light">
              <tr>
                <th className="p-3 text-left">Exam</th>
                <th className="p-3 text-center">‚úì Done</th>
                <th className="p-3 text-center">‚ö† Partial</th>
                <th className="p-3 text-center">‚úó Not Done</th>
                <th className="p-3 text-center">üÜò Need Help</th>
              </tr>
            </thead>
            <tbody>
              {Object.keys(examStats).length === 0 ? (
                <tr>
                  <td colSpan="5" className="p-8 text-center text-gray-500">
                    No registrations yet
                  </td>
                </tr>
              ) : (
                Object.entries(examStats).map(([examName, stats]) => (
                  <tr key={examName} className="border-b hover:bg-gray-50">
                    <td className="p-3 font-semibold">{examName}</td>
                    <td className="p-3 text-center">
                      <span className="px-3 py-1 rounded-full bg-green-100 text-green-700 font-bold">
                        {stats.completed}
                      </span>
                    </td>
                    <td className="p-3 text-center">
                      <span className="px-3 py-1 rounded-full bg-yellow-100 text-yellow-700 font-bold">
                        {stats.partial}
                      </span>
                    </td>
                    <td className="p-3 text-center">
                      <span className="px-3 py-1 rounded-full bg-red-100 text-red-700 font-bold">
                        {stats.notCompleted}
                      </span>
                    </td>
                    <td className="p-3 text-center">
                      <span className="px-3 py-1 rounded-full bg-orange-100 text-orange-700 font-bold">
                        {stats.needSupport}
                      </span>
                    </td>
                  </tr>
                ))
              )}
            </tbody>
          </table>
        </div>
      </div>

      {/* NEW: Student-wise detail table */}
      <div className="bg-white p-6 rounded-2xl shadow-lg">
        <h3 className="text-xl font-bold mb-4">üßë‚Äçüéì Student-wise Exam Registrations</h3>
        <div className="overflow-x-auto">
          <table className="w-full text-sm">
            <thead className="bg-gray-100">
              <tr>
                <th className="p-3 text-left">Student ID</th>
                <th className="p-3 text-left">Name</th>
                <th className="p-3 text-left">Grade</th>
                <th className="p-3 text-left">Gender</th>
                <th className="p-3 text-left">Exam</th>
                <th className="p-3 text-left">Status</th>
                <th className="p-3 text-left">Need Help</th>
                <th className="p-3 text-left">Reg. No.</th>
                <th className="p-3 text-left">Email</th>
                <th className="p-3 text-left">Phone</th>
              </tr>
            </thead>
            <tbody>
              {detailRows.length === 0 ? (
                <tr>
                  <td colSpan="10" className="p-6 text-center text-gray-500">
                    No exam registrations found with current filters.
                  </td>
                </tr>
              ) : (
                detailRows.map((row, idx) => {
                  const status = row.exam.registrationStatus || 'No';
                  const needHelp = row.exam.needSupport === 'Yes';
                  return (
                    <tr key={idx} className="border-b hover:bg-gray-50">
                      <td className="p-3">{row.student.id}</td>
                      <td className="p-3">{row.student.name}</td>
                      <td className="p-3">{row.student.grade}</td>
                      <td className="p-3">{row.student.gender || '‚Äî'}</td>
                      <td className="p-3">{row.exam.examName}</td>
                      <td className="p-3">
                        {status === 'Yes' && <span className="px-3 py-1 rounded-full bg-green-100 text-green-700 font-semibold">Completed</span>}
                        {status === 'Partially' && <span className="px-3 py-1 rounded-full bg-yellow-100 text-yellow-700 font-semibold">Partial</span>}
                        {status === 'No' && <span className="px-3 py-1 rounded-full bg-red-100 text-red-700 font-semibold">Not Done</span>}
                      </td>
                      <td className="p-3">
                        {needHelp ? (
                          <span className="px-3 py-1 rounded-full bg-orange-100 text-orange-700 font-semibold">Yes</span>
                        ) : (
                          'No'
                        )}
                      </td>
                      <td className="p-3">{row.exam.registrationNumber || '‚Äî'}</td>
                      <td className="p-3">{row.exam.emailUsed || '‚Äî'}</td>
                      <td className="p-3">{row.exam.phoneUsed || '‚Äî'}</td>
                    </tr>
                  );
                })
              )}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  );
}

// ========================================
// STUDENT FEEDBACK VIEW (ADMIN)
// ========================================
function StudentFeedbackView({ accessibleSchools = [], isSuperAdmin = false }) {
  const [feedbackList, setFeedbackList] = useState([]);
  const [students, setStudents] = useState([]);
  const [teachers, setTeachers] = useState([]);
  const [loading, setLoading] = useState(true);
  
  // Filters
  const [filterSchool, setFilterSchool] = useState('All');
  const [filterGrade, setFilterGrade] = useState('All');
  const [filterTeacher, setFilterTeacher] = useState('All');
  const [searchQuery, setSearchQuery] = useState('');
  const [dateFrom, setDateFrom] = useState('');
  const [dateTo, setDateTo] = useState('');
    // ----- Helpers to derive summary fields from 19-question responses -----
  const getCategoryFromRating = (rating) => {
    if (rating == null) return null;
    if (rating >= 5) return 'Excellent';
    if (rating >= 4) return 'Good';
    if (rating >= 3) return 'Average';
    return 'Needs Improvement';
  };

  const getExplanationSummary = (responses = {}) => {
    // Use Q4 - Explanation Clarity as proxy
    const rating = responses.q4?.rating ?? null;
    return getCategoryFromRating(rating);
  };

  const getDoubtSummary = (responses = {}) => {
    // Use Q3 ‚Äì Problem Solving / Doubt Clearing
    const rating = responses.q3?.rating;
    if (rating == null) return null;
    if (rating >= 5) return 'Always';
    if (rating >= 3) return 'Sometimes';
    return 'Rarely';
  };

  const getPaceSummary = (responses = {}) => {
    // Use Q6 ‚Äì Time Management
    const rating = responses.q6?.rating;
    if (rating == null) return null;
    if (rating >= 4) return 'Just Right';
    return 'Needs Change';
  };

  const getCommentsSummary = (responses = {}) => {
    // Q10 ‚Äì what they liked most
    return responses.q10?.text || '';
  };

  // Labels for raw export of all questions
  const QUESTION_DEFS = [
    { id: 'q1',  label: 'Q1 Punctuality (1-5)', type: 'mcq' },
    { id: 'q2',  label: 'Q2 Academic Level (1-5)', type: 'mcq' },
    { id: 'q3',  label: 'Q3 Problem Solving (1-5)', type: 'mcq' },
    { id: 'q4',  label: 'Q4 Explanation Clarity (1-5)', type: 'mcq' },
    { id: 'q5',  label: 'Q5 Handwriting & Voice (1-5)', type: 'mcq' },
    { id: 'q6',  label: 'Q6 Time Management (1-5)', type: 'mcq' },
    { id: 'q7',  label: 'Q7 Guidance & Motivation (1-5)', type: 'mcq' },
    { id: 'q8',  label: 'Q8 Student Participation (1-5)', type: 'mcq' },
    { id: 'q9',  label: 'Q9 Equal Attention (1-5)', type: 'mcq' },
    { id: 'q10', label: 'Q10 What they liked most', type: 'text' },
    { id: 'q11', label: 'Q11 What can be improved', type: 'text' },
  ];


  // Fetch all data
  useEffect(() => {
    const fetchData = async () => {
      try {
        setLoading(true);
        
        // Fetch feedback
const feedbackSnap = await db.collection('teacherFeedback').get();
const feedbackData = feedbackSnap.docs.map(doc => {
  const data = doc.data();
  const responses = data.responses || {};

  // Make sure submittedAt is always a real JS Date
  let submittedAt = new Date(); // default = now

  if (data.submittedAt) {
    if (typeof data.submittedAt.toDate === 'function') {
      // Firestore Timestamp
      submittedAt = data.submittedAt.toDate();
    } else {
      // ISO string or normal date string
      submittedAt = new Date(data.submittedAt);
    }
  } else if (data.completedAt) {
    // Fallback if only completedAt exists
    submittedAt = new Date(data.completedAt);
  }

  return {
    id: doc.id,
    ...data,
    submittedAt,
    // use averageRating (1‚Äì10) if simple rating is missing
    rating: data.rating || data.averageRating || 0,
    // derive summary fields from 19-question responses when old fields are missing
    explanationQuality: data.explanationQuality || getExplanationSummary(responses),
    doubtResolution: data.doubtResolution || getDoubtSummary(responses),
    teachingPace: data.teachingPace || getPaceSummary(responses),
    comments: data.comments || getCommentsSummary(responses),
  };
});



        
        // Fetch students
        const studentsSnap = await db.collection('students').get();
        const studentsData = studentsSnap.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));
        
        // Fetch teachers
        const teachersSnap = await db.collection('teachers').get();
        const teachersData = teachersSnap.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));
        
        setFeedbackList(feedbackData);
        setStudents(studentsData);
        setTeachers(teachersData);
      } catch (error) {
        console.error('Error fetching data:', error);
        alert('Error loading feedback data');
      } finally {
        setLoading(false);
      }
    };
    
    fetchData();
  }, []);

  // Use only accessible schools for dropdown
  const schoolOptions = isSuperAdmin ? SCHOOLS : accessibleSchools;
  
  // Filter feedback by accessible schools first
  const accessibleFeedback = isSuperAdmin ? feedbackList : feedbackList.filter(f => accessibleSchools.includes(f.school));
  
  // Filter teachers by accessible schools for dropdown (Fix #6)
  const accessibleTeachers = isSuperAdmin ? teachers : teachers.filter(t => accessibleSchools.includes(t.school));
  
  // When school filter is selected, further filter teachers to that school only
  const teachersForDropdown = filterSchool === 'All' 
    ? accessibleTeachers 
    : accessibleTeachers.filter(t => t.school === filterSchool);

  // Get student details
  const getStudentDetails = (studentId) => {
    return students.find(s => s.id === studentId) || {};
  };

  // Get teacher name
  const getTeacherName = (teacherId) => {
    const teacher = teachers.find(t => t.id === teacherId);
    if (!teacher) return 'Unknown Teacher';
    return teacher.isArchived ? `${teacher.name} (Archived)` : teacher.name;
  };
  
  // Get teacher object for detailed info
  const getTeacherInfo = (teacherId) => {
    return teachers.find(t => t.id === teacherId) || null;
  };

  // Filter feedback - using accessibleFeedback which is already filtered by accessible schools
  const filteredFeedback = accessibleFeedback.filter(feedback => {
    const student = getStudentDetails(feedback.studentId);
    const teacherName = getTeacherName(feedback.teacherId);
    
    // School filter
    if (filterSchool !== 'All' && feedback.school !== filterSchool) return false;
    
    // Grade filter
    if (filterGrade !== 'All' && student.grade !== filterGrade) return false;
    
    // Teacher filter
    if (filterTeacher !== 'All' && teacherName !== filterTeacher) return false;
    
    // Search query (student name or ID)
    if (searchQuery) {
      const query = searchQuery.toLowerCase();
      const matchesName = student.name?.toLowerCase().includes(query);
      const matchesId = student.studentId?.toLowerCase().includes(query);
      if (!matchesName && !matchesId) return false;
    }
    
    // Date range filter
    if (dateFrom) {
      const fromDate = new Date(dateFrom);
      fromDate.setHours(0, 0, 0, 0);
      if (feedback.submittedAt < fromDate) return false;
    }
    
    if (dateTo) {
      const toDate = new Date(dateTo);
      toDate.setHours(23, 59, 59, 999);
      if (feedback.submittedAt > toDate) return false;
    }
    
    return true;
  });

  // Get unique grades from accessible feedback only
  const uniqueGrades = [...new Set(accessibleFeedback.map(f => {
    const student = getStudentDetails(f.studentId);
    return student.grade;
  }))].filter(Boolean).sort();

    // Export to CSV (includes all Q1‚ÄìQ17 raw answers)
  const exportToCSV = () => {
    if (filteredFeedback.length === 0) {
      alert('No feedback to export');
      return;
    }

    const csvData = filteredFeedback.map(feedback => {
      const student = getStudentDetails(feedback.studentId);
      const teacherName = getTeacherName(feedback.teacherId);
      const responses = feedback.responses || {};

      // Base columns (same as before)
      const row = {
        'Date': feedback.submittedAt.toLocaleDateString('en-IN'),
        'Time': feedback.submittedAt.toLocaleTimeString('en-IN'),
        'School': feedback.school || student.school || 'N/A',
        'Student ID': student.studentId || 'N/A',
        'Student Name': student.name || feedback.studentName || 'N/A',
        'Grade': student.grade || feedback.grade || 'N/A',
        'Teacher Name': teacherName,
        'Subject': feedback.subject || 'N/A',
        'Overall Rating (1-5)': feedback.rating || feedback.averageRating || 0,
        'Explanation Quality (summary)': feedback.explanationQuality || 'N/A',
        'Doubt Resolution (summary)': feedback.doubtResolution || 'N/A',
        'Teaching Pace (summary)': feedback.teachingPace || 'N/A',
        'Comments (summary)': feedback.comments || '',
      };

      // Add one column per question + optional explanation
      QUESTION_DEFS.forEach(q => {
        const resp = responses[q.id] || {};
        let value = '';

        if (q.type === 'mcq') {
          // MCQ type stores rating value (1-5)
          value = resp.rating != null ? resp.rating : '';
        } else if (q.type === 'rating') {
          value = resp.rating != null ? resp.rating : '';
        } else if (q.type === 'yesno') {
          // your yes/no answers are stored as .answer
          value = resp.answer != null ? resp.answer : '';
        } else if (q.type === 'text') {
          value = resp.text || resp || '';
        } else {
          // Fallback - try to get any value
          value = resp.rating || resp.text || resp.answer || resp || '';
        }

        row[q.label] = value;

        // If student wrote explanation (when rating < threshold)
        if (resp.explanation) {
          row[`${q.label} - Explanation`] = resp.explanation;
        }
      });

      return row;
    });

    // Convert to CSV
    const headers = Object.keys(csvData[0]);
    const csvContent = [
      headers.join(','),
      ...csvData.map(row =>
        headers
          .map(header => {
            const value = row[header]?.toString() || '';
            return value.includes(',') || value.includes('"')
              ? `"${value.replace(/"/g, '""')}"`
              : value;
          })
          .join(',')
      ),
    ].join('\n');

    // Download
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute(
      'download',
      `student_feedback_${new Date().toISOString().split('T')[0]}.csv`
    );
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

    // Get rating badge (1‚Äì5 scale)
  const getRatingBadge = (rating) => {
    if (rating >= 4.5) return { text: 'Excellent', class: 'rating-excellent' };
    if (rating >= 3.5) return { text: 'Good', class: 'rating-good' };
    if (rating >= 2.5) return { text: 'Average', class: 'rating-average' };
    return { text: 'Needs Improvement', class: 'rating-poor' };
  };

  // Statistics for cards (1‚Äì5 scale)
  const stats = {
    total: filteredFeedback.length,
    avgRating:
      filteredFeedback.length > 0
        ? (
            filteredFeedback.reduce((sum, f) => sum + (f.rating || 0), 0) /
            filteredFeedback.length
          ).toFixed(1)
        : 0,
    excellent: filteredFeedback.filter(f => (f.rating || 0) >= 4.5).length,
    good:      filteredFeedback.filter(f => (f.rating || 0) >= 3.5 && (f.rating || 0) < 4.5).length,
    average:   filteredFeedback.filter(f => (f.rating || 0) >= 2.5 && (f.rating || 0) < 3.5).length,
    poor:      filteredFeedback.filter(f => (f.rating || 0) < 2.5).length,
  };

  if (loading) {
    return (
      <div className="flex items-center justify-center min-h-screen">
        <div className="text-2xl font-bold">Loading feedback data...</div>
      </div>
    );
  }

  return (
    <div className="space-y-6 p-6">
      {/* Header */}
      <div className="flex flex-wrap items-center justify-between gap-4">
        <h2 className="text-3xl font-bold">üí¨ Student Feedback</h2>
        <button
          onClick={exportToCSV}
          disabled={filteredFeedback.length === 0}
          className="px-6 py-3 avanti-gradient text-white rounded-xl font-semibold hover:opacity-90 disabled:opacity-50 disabled:cursor-not-allowed"
        >
          üì• Export to CSV
        </button>
      </div>

      {/* Statistics Cards */}
      <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
        <div className="stat-card bg-blue-500 text-white">
          <div className="text-sm opacity-90">Total Feedback</div>
          <div className="text-3xl font-bold">{stats.total}</div>
        </div>
        <div className="stat-card bg-purple-500 text-white">
          <div className="text-sm opacity-90">Avg Rating</div>
          <div className="text-3xl font-bold">‚≠ê {stats.avgRating}</div>
        </div>
        <div className="stat-card bg-green-500 text-white">
          <div className="text-sm opacity-90">Excellent</div>
          <div className="text-3xl font-bold">{stats.excellent}</div>
        </div>
        <div className="stat-card bg-blue-400 text-white">
          <div className="text-sm opacity-90">Good</div>
          <div className="text-3xl font-bold">{stats.good}</div>
        </div>
        <div className="stat-card bg-yellow-500 text-white">
          <div className="text-sm opacity-90">Average</div>
          <div className="text-3xl font-bold">{stats.average}</div>
        </div>
        <div className="stat-card bg-red-500 text-white">
          <div className="text-sm opacity-90">Poor</div>
          <div className="text-3xl font-bold">{stats.poor}</div>
        </div>
      </div>

      {/* Monthly Feedback Trend Graph */}
      <MonthlyFeedbackTrendGraph feedbackData={filteredFeedback} />

      {/* Filters */}
      <div className="bg-white p-6 rounded-2xl shadow-lg space-y-4">
        <h3 className="text-xl font-bold mb-4">üîç Filters</h3>
        
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          {/* School Filter */}
          <div>
            <label className="block text-sm font-semibold mb-2">School</label>
            <select
              value={filterSchool}
              onChange={(e) => {
                setFilterSchool(e.target.value);
                setFilterTeacher('All'); // Reset teacher filter when school changes
              }}
              className="w-full p-3 border-2 rounded-xl"
            >
              <option value="All">All Schools</option>
              {schoolOptions.map(school => (
                <option key={school} value={school}>{school}</option>
              ))}
            </select>
          </div>

          {/* Grade Filter */}
          <div>
            <label className="block text-sm font-semibold mb-2">Grade</label>
            <select
              value={filterGrade}
              onChange={(e) => setFilterGrade(e.target.value)}
              className="w-full p-3 border-2 rounded-xl"
            >
              <option value="All">All Grades</option>
              {uniqueGrades.map(grade => (
                <option key={grade} value={grade}>{grade}</option>
              ))}
            </select>
          </div>

          {/* Teacher Filter - Now filtered by selected school */}
          <div>
            <label className="block text-sm font-semibold mb-2">Teacher</label>
            <select
              value={filterTeacher}
              onChange={(e) => setFilterTeacher(e.target.value)}
              className="w-full p-3 border-2 rounded-xl"
            >
              <option value="All">All Teachers</option>
              {teachersForDropdown.map(teacher => (
                <option key={teacher.id} value={teacher.name}>{teacher.name}</option>
              ))}
            </select>
          </div>

          {/* Search */}
          <div>
            <label className="block text-sm font-semibold mb-2">Search Student</label>
            <input
              type="text"
              value={searchQuery}
              onChange={(e) => setSearchQuery(e.target.value)}
              placeholder="Name or ID..."
              className="w-full p-3 border-2 rounded-xl"
            />
          </div>

          {/* Date From */}
          <div>
            <label className="block text-sm font-semibold mb-2">From Date</label>
            <input
              type="date"
              value={dateFrom}
              onChange={(e) => setDateFrom(e.target.value)}
              className="w-full p-3 border-2 rounded-xl"
            />
          </div>

          {/* Date To */}
          <div>
            <label className="block text-sm font-semibold mb-2">To Date</label>
            <input
              type="date"
              value={dateTo}
              onChange={(e) => setDateTo(e.target.value)}
              className="w-full p-3 border-2 rounded-xl"
            />
          </div>
        </div>

        {/* Clear Filters */}
        <button
          onClick={() => {
            setFilterSchool('All');
            setFilterGrade('All');
            setFilterTeacher('All');
            setSearchQuery('');
            setDateFrom('');
            setDateTo('');
          }}
          className="mt-4 px-6 py-2 bg-gray-500 text-white rounded-xl font-semibold hover:bg-gray-600"
        >
          Clear All Filters
        </button>
      </div>

      {/* Feedback Table */}
      <div className="bg-white p-6 rounded-2xl shadow-lg">
        <h3 className="text-xl font-bold mb-4">
          üìã Feedback List ({filteredFeedback.length} {filteredFeedback.length === 1 ? 'entry' : 'entries'})
        </h3>
        
        <div className="overflow-x-auto">
          {filteredFeedback.length === 0 ? (
            <div className="text-center py-12 text-gray-500">
              <div className="text-6xl mb-4">üì≠</div>
              <div className="text-xl font-semibold">No feedback found</div>
              <div className="text-sm mt-2">Try adjusting your filters</div>
            </div>
          ) : (
            <table className="w-full">
              <thead className="avanti-gradient-light">
                <tr>
                  <th className="p-3 text-left">Date</th>
                  <th className="p-3 text-left">School</th>
                  <th className="p-3 text-left">Student ID</th>
                  <th className="p-3 text-left">Student Name</th>
                  <th className="p-3 text-left">Grade</th>
                  <th className="p-3 text-left">Teacher</th>
                  <th className="p-3 text-left">Subject</th>
                  <th className="p-3 text-left">Rating</th>
                  <th className="p-3 text-left">Explanation</th>
                  <th className="p-3 text-left">Doubt Help</th>
                  <th className="p-3 text-left">Pace</th>
                  <th className="p-3 text-left">Comments</th>
                </tr>
              </thead>
              <tbody>
                {filteredFeedback.map(feedback => {
                  const student = getStudentDetails(feedback.studentId);
                  const teacherName = getTeacherName(feedback.teacherId);
                  const ratingBadge = getRatingBadge(feedback.rating);
                  
                  return (
                    <tr key={feedback.id} className="border-b hover:bg-gray-50">
                      <td className="p-3">
                        <div className="text-sm font-semibold">
                          {feedback.submittedAt.toLocaleDateString('en-IN')}
                        </div>
                        <div className="text-xs text-gray-500">
                          {feedback.submittedAt.toLocaleTimeString('en-IN')}
                        </div>
                      </td>
                      <td className="p-3 font-semibold">{student.school || 'N/A'}</td>
                      <td className="p-3">{student.studentId || 'N/A'}</td>
                      <td className="p-3 font-semibold">{student.name || 'N/A'}</td>
                      <td className="p-3">{student.grade || 'N/A'}</td>
                      <td className="p-3 font-semibold">{teacherName}</td>
                      <td className="p-3">{feedback.subject || 'N/A'}</td>
                      <td className="p-3">
                        <div className={`rating-badge ${ratingBadge.class}`}>
                          ‚≠ê {feedback.rating?.toFixed(1) || 0}
                        </div>
                      </td>
                      <td className="p-3">
                        <span className={`px-3 py-1 rounded-full text-sm font-semibold ${
                          feedback.explanationQuality === 'Excellent' ? 'bg-green-100 text-green-700' :
                          feedback.explanationQuality === 'Good' ? 'bg-blue-100 text-blue-700' :
                          feedback.explanationQuality === 'Average' ? 'bg-yellow-100 text-yellow-700' :
                          'bg-red-100 text-red-700'
                        }`}>
                          {feedback.explanationQuality || 'N/A'}
                        </span>
                      </td>
                      <td className="p-3">
                        <span className={`px-3 py-1 rounded-full text-sm font-semibold ${
                          feedback.doubtResolution === 'Always' ? 'bg-green-100 text-green-700' :
                          feedback.doubtResolution === 'Sometimes' ? 'bg-yellow-100 text-yellow-700' :
                          'bg-red-100 text-red-700'
                        }`}>
                          {feedback.doubtResolution || 'N/A'}
                        </span>
                      </td>
                      <td className="p-3">
                        <span className={`px-3 py-1 rounded-full text-sm font-semibold ${
                          feedback.teachingPace === 'Just Right' ? 'bg-green-100 text-green-700' :
                          feedback.teachingPace === 'Too Fast' ? 'bg-orange-100 text-orange-700' :
                          'bg-blue-100 text-blue-700'
                        }`}>
                          {feedback.teachingPace || 'N/A'}
                        </span>
                      </td>
                      <td className="p-3">
                        <div className="max-w-xs truncate" title={feedback.comments}>
                          {feedback.comments || '-'}
                        </div>
                      </td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
          )}
        </div>
      </div>
    </div>
  );
}

// ========================================
// TEACHER SELF PROFILE (for teachers to see their own data)
// ========================================
function TeacherSelfProfile({ currentUser, teachers }) {
  // Find the current teacher in teachers array
  const [teacherData, setTeacherData] = useState(null);
  const [observations, setObservations] = useState([]);
  const [feedbackData, setFeedbackData] = useState([]);
  const [loading, setLoading] = useState(true);
  const [selectedMonth, setSelectedMonth] = useState('All');
  const [selectedObservation, setSelectedObservation] = useState(null);
  const [showEditModal, setShowEditModal] = useState(false);
  const [saving, setSaving] = useState(false);
  const [editForm, setEditForm] = useState({
    qualification: '',
    experience: '',
    whatsapp: '',
    profilePhoto: '',
    bio: ''
  });
  const chartRef = useRef(null);
  const chartInstance = useRef(null);

  // Fetch teacher data and initialize form
  useEffect(() => {
    const teacher = teachers.find(t => t.afid === currentUser.afid || t.email === currentUser.email) || {
      name: currentUser.name || currentUser.email,
      subject: currentUser.subject,
      school: currentUser.school,
      afid: currentUser.afid,
      docId: currentUser.afid
    };
    setTeacherData(teacher);
    setEditForm({
      qualification: teacher.qualification || '',
      experience: teacher.experience || '',
      whatsapp: teacher.whatsapp || '',
      profilePhoto: teacher.profilePhoto || '',
      bio: teacher.bio || ''
    });
  }, [teachers, currentUser]);

  // Fetch observations and feedback for this teacher
  useEffect(() => {
    const fetchData = async () => {
      try {
        setLoading(true);
        const teacherId = currentUser.afid || currentUser.uid;
        
        // Fetch observations
        const obsSnap = await db.collection('classroomObservations')
          .where('teacherId', '==', teacherId)
          .orderBy('submittedAt', 'desc')
          .get();
        
        const obsData = obsSnap.docs.map(doc => ({
          id: doc.id,
          ...doc.data(),
          submittedAt: doc.data().submittedAt?.toDate() || new Date(doc.data().submittedAtISO)
        }));
        setObservations(obsData);

        // Fetch ALL feedback and filter client-side (avoids Firebase index requirement)
        const feedbackSnap = await db.collection('teacherFeedback').get();
        
        // Create list of all possible identifiers for this teacher
        const teacherIdentifiers = [
          currentUser.afid,
          currentUser.docId,
          currentUser.id,
          currentUser.uid,
          currentUser.name
        ].filter(Boolean).map(id => String(id).toLowerCase());
        
        const fbData = feedbackSnap.docs
          .filter(doc => {
            const data = doc.data();
            const feedbackTeacherId = String(data.teacherId || '').toLowerCase();
            const feedbackTeacherAfid = String(data.teacherAfid || '').toLowerCase();
            const feedbackTeacherDocId = String(data.teacherDocId || '').toLowerCase();
            const feedbackTeacherName = String(data.teacherName || '').toLowerCase();
            
            return teacherIdentifiers.includes(feedbackTeacherId) ||
                   teacherIdentifiers.includes(feedbackTeacherAfid) ||
                   teacherIdentifiers.includes(feedbackTeacherDocId) ||
                   teacherIdentifiers.includes(feedbackTeacherName);
          })
          .map(doc => {
            const data = doc.data();
            return {
              id: doc.id,
              ...data,
              submittedAt: data.submittedAt?.toDate ? data.submittedAt.toDate() : new Date(data.submittedAt || data.completedAt)
            };
          });
        
        console.log('My Profile - Found feedback:', fbData.length, 'responses');
        setFeedbackData(fbData);

      } catch (error) {
        console.error('Error fetching teacher profile data:', error);
      } finally {
        setLoading(false);
      }
    };

    fetchData();
  }, [currentUser]);

  // Save profile updates
  const handleSaveProfile = async () => {
    if (!teacherData?.docId) {
      alert('Unable to update profile. Please contact admin.');
      return;
    }

    setSaving(true);
    try {
      await db.collection('teachers').doc(teacherData.docId).update({
        qualification: editForm.qualification,
        experience: editForm.experience,
        whatsapp: editForm.whatsapp,
        profilePhoto: editForm.profilePhoto,
        bio: editForm.bio,
        updatedAt: new Date().toISOString()
      });
      
      // Update local state
      setTeacherData(prev => ({
        ...prev,
        ...editForm
      }));
      
      alert('‚úÖ Profile updated successfully!');
      setShowEditModal(false);
    } catch (error) {
      console.error('Error updating profile:', error);
      alert('‚ùå Failed to update profile: ' + error.message);
    } finally {
      setSaving(false);
    }
  };

  // Get unique months from observations
  const availableMonths = useMemo(() => {
    const months = new Set();
    observations.forEach(obs => {
      const date = new Date(obs.observationDate || obs.submittedAt);
      months.add(`${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`);
    });
    return Array.from(months).sort().reverse();
  }, [observations]);

  // Filter observations by month
  const filteredObservations = useMemo(() => {
    if (selectedMonth === 'All') return observations;
    return observations.filter(obs => {
      const date = new Date(obs.observationDate || obs.submittedAt);
      const month = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
      return month === selectedMonth;
    });
  }, [observations, selectedMonth]);

  // Calculate average feedback scores
  const feedbackAverages = useMemo(() => {
    if (feedbackData.length === 0) return null;
    
    const questionAverages = {};
    const questionLabels = {
      q1: 'Punctuality',
      q2: 'Academic Level', 
      q3: 'Problem Solving',
      q4: 'Explanation Clarity',
      q5: 'Handwriting & Voice',
      q6: 'Time Management',
      q7: 'Guidance & Motivation',
      q8: 'Student Participation',
      q9: 'Equal Attention',
      
      
      
      
      
      
    };

    Object.keys(questionLabels).forEach(qId => {
      const ratings = feedbackData
        .map(fb => fb.responses?.[qId]?.rating)
        .filter(r => r !== undefined && r !== null);
      
      if (ratings.length > 0) {
        questionAverages[qId] = {
          label: questionLabels[qId],
          average: (ratings.reduce((a, b) => a + b, 0) / ratings.length).toFixed(1),
          count: ratings.length
        };
      }
    });

    return questionAverages;
  }, [feedbackData]);

  // Overall average rating
  const overallRating = useMemo(() => {
    if (!feedbackAverages) return null;
    const values = Object.values(feedbackAverages).map(v => parseFloat(v.average));
    if (values.length === 0) return null;
    return (values.reduce((a, b) => a + b, 0) / values.length).toFixed(1);
  }, [feedbackAverages]);

  // Chart for observation trends
  useEffect(() => {
    if (chartInstance.current) {
      chartInstance.current.destroy();
    }

    if (chartRef.current && observations.length > 0) {
      const ctx = chartRef.current.getContext('2d');
      
      // Group by month
      const monthlyData = {};
      observations.forEach(obs => {
        const date = new Date(obs.observationDate || obs.submittedAt);
        const month = date.toLocaleDateString('en-IN', { month: 'short', year: '2-digit' });
        if (!monthlyData[month]) {
          monthlyData[month] = [];
        }
        monthlyData[month].push(obs.percentageScore);
      });

      const labels = Object.keys(monthlyData);
      const avgScores = labels.map(month => {
        const scores = monthlyData[month];
        return (scores.reduce((a, b) => a + b, 0) / scores.length).toFixed(1);
      });

      chartInstance.current = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Observation Score %',
            data: avgScores,
            borderColor: '#F4B41A',
            backgroundColor: 'rgba(244, 180, 26, 0.1)',
            tension: 0.4,
            fill: true,
            pointBackgroundColor: '#F4B41A',
            pointRadius: 6
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: { display: true, text: 'My Observation Score Trend', font: { size: 16, weight: 'bold' } },
            legend: { display: false }
          },
          scales: {
            y: { beginAtZero: true, max: 100, title: { display: true, text: 'Score %' } }
          }
        }
      });
    }

    return () => {
      if (chartInstance.current) {
        chartInstance.current.destroy();
      }
    };
  }, [observations]);

  if (loading || !teacherData) {
    return (
      <div className="flex items-center justify-center min-h-[400px]">
        <div className="text-center">
          <div className="text-4xl mb-4">‚è≥</div>
          <p>Loading your profile...</p>
        </div>
      </div>
    );
  }

  return (
    <div className="space-y-6">
      {/* Header with Edit Button */}
      <div className="bg-gradient-to-r from-yellow-400 to-orange-500 text-white p-6 rounded-2xl">
        <div className="flex justify-between items-start">
          <div className="flex items-center gap-4">
            {teacherData.profilePhoto ? (
              <img src={teacherData.profilePhoto} alt={teacherData.name} className="w-20 h-20 rounded-full border-4 border-white object-cover"/>
            ) : (
              <div className="w-20 h-20 rounded-full border-4 border-white bg-white/30 flex items-center justify-center text-3xl font-bold">
                {teacherData.name?.charAt(0) || '?'}
              </div>
            )}
            <div>
              <h2 className="text-2xl font-bold">üë§ My Profile</h2>
              <p className="text-xl mt-1">{teacherData.name}</p>
              <p className="opacity-90">{teacherData.subject} | {teacherData.school}</p>
              <div className="flex gap-2 mt-2">
                {teacherData.afid && (
                  <span className="px-2 py-0.5 bg-white/30 text-white rounded text-xs font-mono">
                    AFID: {teacherData.afid}
                  </span>
                )}
                {teacherData.afCode && (
                  <span className="px-2 py-0.5 bg-blue-500 text-white rounded text-xs font-mono">
                    AF Code: {teacherData.afCode}
                  </span>
                )}
              </div>
            </div>
          </div>
          <button
            onClick={() => setShowEditModal(true)}
            className="px-4 py-2 bg-white text-orange-600 rounded-xl font-semibold hover:bg-orange-50"
          >
            ‚úèÔ∏è Edit Profile
          </button>
        </div>
      </div>

      {/* Profile Details */}
      <div className="bg-white p-6 rounded-xl shadow">
        <h3 className="text-xl font-bold mb-4">üìã Profile Details</h3>
        <div className="grid md:grid-cols-2 gap-4">
          <div className="bg-gray-50 p-4 rounded-lg">
            <div className="text-sm text-gray-500">Education Qualification</div>
            <div className="font-semibold">{teacherData.qualification || 'Not specified'}</div>
          </div>
          <div className="bg-gray-50 p-4 rounded-lg">
            <div className="text-sm text-gray-500">Experience</div>
            <div className="font-semibold">{teacherData.experience || 'Not specified'}</div>
          </div>
          <div className="bg-gray-50 p-4 rounded-lg">
            <div className="text-sm text-gray-500">Phone</div>
            <div className="font-semibold">{teacherData.phone || 'Not specified'}</div>
          </div>
          <div className="bg-gray-50 p-4 rounded-lg">
            <div className="text-sm text-gray-500">WhatsApp</div>
            <div className="font-semibold">{teacherData.whatsapp || 'Not specified'}</div>
          </div>
          <div className="bg-gray-50 p-4 rounded-lg">
            <div className="text-sm text-gray-500">Email</div>
            <div className="font-semibold">{teacherData.email || 'Not specified'}</div>
          </div>
          <div className="bg-gray-50 p-4 rounded-lg">
            <div className="text-sm text-gray-500">Average Rating</div>
            <div className="font-semibold text-yellow-600">{overallRating || 'N/A'}/5</div>
          </div>
        </div>
        {teacherData.bio && (
          <div className="mt-4 bg-gray-50 p-4 rounded-lg">
            <div className="text-sm text-gray-500">Bio</div>
            <div className="font-semibold">{teacherData.bio}</div>
          </div>
        )}
      </div>

      {/* Overall Stats Cards */}
      <div className="grid md:grid-cols-3 gap-4">
        <div className="bg-white p-4 rounded-xl shadow border-l-4 border-yellow-500">
          <div className="text-sm text-gray-500">Total Observations</div>
          <div className="text-3xl font-bold text-yellow-600">{observations.length}</div>
        </div>
        <div className="bg-white p-4 rounded-xl shadow border-l-4 border-green-500">
          <div className="text-sm text-gray-500">Avg Observation Score</div>
          <div className="text-3xl font-bold text-green-600">
            {observations.length > 0 
              ? (observations.reduce((sum, o) => sum + o.percentageScore, 0) / observations.length).toFixed(1) + '%'
              : 'N/A'}
          </div>
        </div>
        <div className="bg-white p-4 rounded-xl shadow border-l-4 border-blue-500">
          <div className="text-sm text-gray-500">Student Feedback Rating</div>
          <div className="text-3xl font-bold text-blue-600">{overallRating || 'N/A'}/5</div>
          <div className="text-xs text-gray-400">{feedbackData.length} responses</div>
        </div>
      </div>

      {/* Observation Trend Chart */}
      {observations.length > 0 && (
        <div className="bg-white p-4 rounded-xl shadow">
          <div style={{ height: '250px' }}>
            <canvas ref={chartRef}></canvas>
          </div>
        </div>
      )}

      {/* My Classroom Observations */}
      <div className="bg-white p-6 rounded-xl shadow">
        <div className="flex justify-between items-center mb-4">
          <h3 className="text-xl font-bold">üìã My Classroom Observations</h3>
          <select 
            value={selectedMonth} 
            onChange={e => setSelectedMonth(e.target.value)}
            className="border-2 px-4 py-2 rounded-xl"
          >
            <option value="All">All Months</option>
            {availableMonths.map(month => (
              <option key={month} value={month}>
                {new Date(month + '-01').toLocaleDateString('en-IN', { month: 'long', year: 'numeric' })}
              </option>
            ))}
          </select>
        </div>

        {filteredObservations.length === 0 ? (
          <div className="text-center py-8 text-gray-500">
            <div className="text-4xl mb-2">üìã</div>
            <p>No classroom observations yet</p>
            <p className="text-sm">Your manager will add observations when they visit your class</p>
          </div>
        ) : (
          <div className="space-y-3">
            {filteredObservations.map(obs => (
              <div key={obs.id} className="border-2 rounded-xl p-4 hover:border-yellow-400 cursor-pointer transition" onClick={() => setSelectedObservation(obs)}>
                <div className="flex justify-between items-center">
                  <div>
                    <div className="font-bold">
                      {new Date(obs.observationDate || obs.submittedAt).toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' })}
                      <span className="text-gray-500 font-normal ml-2">Class {obs.grade}</span>
                    </div>
                    <div className="text-sm text-gray-500">Observer: {obs.observerName}</div>
                  </div>
                  <div className="text-right">
                    <div className={`text-2xl font-bold ${
                      obs.percentageScore >= 80 ? 'text-green-600' : 
                      obs.percentageScore >= 60 ? 'text-yellow-600' : 'text-red-600'
                    }`}>
                      {obs.percentageScore}%
                    </div>
                    <div className="text-sm text-gray-500">{obs.totalScore}/{obs.maxScore}</div>
                  </div>
                </div>
              </div>
            ))}
          </div>
        )}
      </div>

      {/* Student Feedback Summary */}
      <div className="bg-white p-6 rounded-xl shadow">
        <h3 className="text-xl font-bold mb-4">üí¨ Student Feedback Summary</h3>
        <p className="text-sm text-gray-500 mb-4">Average scores from {feedbackData.length} student responses (individual responses are anonymous)</p>
        
        {!feedbackAverages ? (
          <div className="text-center py-8 text-gray-500">
            <div className="text-4xl mb-2">üí¨</div>
            <p>No student feedback received yet</p>
          </div>
        ) : (
          <div className="grid md:grid-cols-3 gap-4">
            {Object.entries(feedbackAverages).map(([qId, data]) => (
              <div key={qId} className="bg-gray-50 p-3 rounded-lg">
                <div className="text-sm text-gray-600 mb-1">{data.label}</div>
                <div className="flex items-center justify-between">
                  <span className={`text-xl font-bold ${
                    parseFloat(data.average) >= 8 ? 'text-green-600' :
                    parseFloat(data.average) >= 6 ? 'text-yellow-600' : 'text-red-600'
                  }`}>
                    {data.average}/5
                  </span>
                  <span className="text-xs text-gray-400">({data.count} ratings)</span>
                </div>
              </div>
            ))}
          </div>
        )}
      </div>

      {/* Edit Profile Modal */}
      {showEditModal && (
        <div className="modal-overlay" onClick={() => setShowEditModal(false)}>
          <div className="modal-content max-w-lg" onClick={e => e.stopPropagation()}>
            <div className="p-6">
              <div className="flex justify-between items-center mb-6">
                <h3 className="text-xl font-bold">‚úèÔ∏è Edit Profile</h3>
                <button onClick={() => setShowEditModal(false)} className="text-2xl font-bold text-gray-400">√ó</button>
              </div>

              <div className="space-y-4">
                <div>
                  <label className="block text-sm font-bold mb-2">Profile Photo URL</label>
                  <input
                    type="url"
                    value={editForm.profilePhoto}
                    onChange={e => setEditForm({...editForm, profilePhoto: e.target.value})}
                    placeholder="https://drive.google.com/... (max 2MB image)"
                    className="w-full border-2 px-4 py-3 rounded-xl"
                  />
                  <p className="text-xs text-gray-500 mt-1">Use Google Drive or any image URL (under 2MB)</p>
                </div>

                <div>
                  <label className="block text-sm font-bold mb-2">Education Qualification</label>
                  <input
                    type="text"
                    value={editForm.qualification}
                    onChange={e => setEditForm({...editForm, qualification: e.target.value})}
                    placeholder="e.g., M.Sc Physics, B.Ed"
                    className="w-full border-2 px-4 py-3 rounded-xl"
                  />
                </div>

                <div>
                  <label className="block text-sm font-bold mb-2">Experience</label>
                  <input
                    type="text"
                    value={editForm.experience}
                    onChange={e => setEditForm({...editForm, experience: e.target.value})}
                    placeholder="e.g., 5 years teaching Physics"
                    className="w-full border-2 px-4 py-3 rounded-xl"
                  />
                </div>

                <div>
                  <label className="block text-sm font-bold mb-2">WhatsApp Number</label>
                  <input
                    type="tel"
                    value={editForm.whatsapp}
                    onChange={e => setEditForm({...editForm, whatsapp: e.target.value})}
                    placeholder="e.g., 9876543210"
                    className="w-full border-2 px-4 py-3 rounded-xl"
                  />
                </div>

                <div>
                  <label className="block text-sm font-bold mb-2">Bio (About Me)</label>
                  <textarea
                    value={editForm.bio}
                    onChange={e => setEditForm({...editForm, bio: e.target.value})}
                    placeholder="Tell students about yourself..."
                    rows="3"
                    className="w-full border-2 px-4 py-3 rounded-xl"
                  />
                </div>

                <div className="flex gap-3 pt-4">
                  <button
                    onClick={handleSaveProfile}
                    disabled={saving}
                    className="flex-1 avanti-gradient text-white py-3 rounded-xl font-semibold disabled:opacity-50"
                  >
                    {saving ? '‚è≥ Saving...' : '‚úÖ Save Changes'}
                  </button>
                  <button
                    onClick={() => setShowEditModal(false)}
                    className="px-6 py-3 bg-gray-300 rounded-xl font-semibold"
                  >
                    Cancel
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Observation Detail Modal */}
      {selectedObservation && (
        <div className="modal-overlay" onClick={() => setSelectedObservation(null)}>
          <div className="modal-content max-w-3xl max-h-[90vh] overflow-y-auto" onClick={e => e.stopPropagation()}>
            <div className="p-6">
              <div className="flex justify-between items-start mb-4">
                <div>
                  <h3 className="text-xl font-bold">Observation Details</h3>
                  <p className="text-gray-500">
                    {new Date(selectedObservation.observationDate).toLocaleDateString('en-IN', { weekday: 'long', day: '2-digit', month: 'long', year: 'numeric' })}
                  </p>
                </div>
                <button onClick={() => setSelectedObservation(null)} className="text-2xl font-bold text-gray-400">√ó</button>
              </div>

              <div className={`p-4 rounded-xl mb-4 ${
                selectedObservation.percentageScore >= 80 ? 'bg-green-100' :
                selectedObservation.percentageScore >= 60 ? 'bg-yellow-100' : 'bg-red-100'
              }`}>
                <div className="text-center">
                  <div className="text-3xl font-bold">{selectedObservation.totalScore}/{selectedObservation.maxScore}</div>
                  <div className="text-xl">{selectedObservation.percentageScore}%</div>
                  <div className="text-sm text-gray-600">{selectedObservation.flaggedCount} items flagged</div>
                </div>
              </div>

              <div className="space-y-2 mb-4">
                {CLASSROOM_OBSERVATION_PARAMETERS.map(param => {
                  const score = selectedObservation.responses?.[param.id];
                  const remark = selectedObservation.remarks?.[param.id];
                  const isFlagged = score !== undefined && score < param.maxScore;
                  
                  return (
                    <div key={param.id} className={`p-3 rounded-lg ${isFlagged ? 'bg-red-50' : 'bg-green-50'}`}>
                      <div className="flex justify-between items-start">
                        <div className="flex-1 text-sm">{param.text}</div>
                        <div className={`font-bold ml-2 ${isFlagged ? 'text-red-600' : 'text-green-600'}`}>
                          {score ?? 'N/A'}/{param.maxScore}
                        </div>
                      </div>
                      {remark && <div className="text-xs text-red-600 mt-1">üìù {remark}</div>}
                    </div>
                  );
                })}
              </div>

              {selectedObservation.strengths && (
                <div className="bg-green-50 p-4 rounded-xl mb-3">
                  <h4 className="font-bold text-green-700 mb-2">‚úÖ Strengths</h4>
                  <p className="text-sm">{selectedObservation.strengths}</p>
                </div>
              )}

              {selectedObservation.improvements && (
                <div className="bg-yellow-50 p-4 rounded-xl mb-3">
                  <h4 className="font-bold text-yellow-700 mb-2">üí° Improvements</h4>
                  <p className="text-sm">{selectedObservation.improvements}</p>
                </div>
              )}

              <div className="text-sm text-gray-500 mt-4">
                Observer: {selectedObservation.observerName} ({selectedObservation.observerPosition}) | 
                Submitted: {new Date(selectedObservation.submittedAt).toLocaleString('en-IN')}
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

// ========================================
// ADMIN CLASSROOM OBSERVATIONS
// ========================================
function AdminClassroomObservations({ teachers, currentUser }) {
  const [observations, setObservations] = useState([]);
  const [loading, setLoading] = useState(true);
  const [selectedTeacher, setSelectedTeacher] = useState(null);
  const [showObservationForm, setShowObservationForm] = useState(false);
  const [showTeacherProfile, setShowTeacherProfile] = useState(false);
  const [filterSchool, setFilterSchool] = useState('All');
  const [filterSubject, setFilterSubject] = useState('All');
  const [searchTerm, setSearchTerm] = useState('');
  
  // For observation list view
  const [observationList, setObservationList] = useState([]);
  const [listFilterSchool, setListFilterSchool] = useState('All');
  const [listFilterTeacher, setListFilterTeacher] = useState('All');
  const [dateFrom, setDateFrom] = useState('');
  const [dateTo, setDateTo] = useState('');

  // Fetch all observations
  useEffect(() => {
    const fetchObservations = async () => {
      try {
        setLoading(true);
        const snapshot = await db.collection('classroomObservations')
          .orderBy('submittedAt', 'desc')
          .get();
        
        const data = snapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data(),
          submittedAt: doc.data().submittedAt?.toDate() || new Date(doc.data().submittedAtISO)
        }));
        
        setObservationList(data);
      } catch (error) {
        console.error('Error fetching observations:', error);
      } finally {
        setLoading(false);
      }
    };

    fetchObservations();
  }, []);

  // Filter teachers
  const filteredTeachers = teachers.filter(t => {
    const matchesSearch = t.name?.toLowerCase().includes(searchTerm.toLowerCase());
    const matchesSchool = filterSchool === 'All' || t.school === filterSchool;
    const matchesSubject = filterSubject === 'All' || t.subject === filterSubject;
    return matchesSearch && matchesSchool && matchesSubject;
  });

  // Filter observations list
  const filteredObservations = observationList.filter(obs => {
    const matchesSchool = listFilterSchool === 'All' || obs.school === listFilterSchool;
    const matchesTeacher = listFilterTeacher === 'All' || obs.teacherId === listFilterTeacher;
    const obsDate = new Date(obs.observationDate || obs.submittedAt).toISOString().split('T')[0];
    const matchesDateFrom = !dateFrom || obsDate >= dateFrom;
    const matchesDateTo = !dateTo || obsDate <= dateTo;
    return matchesSchool && matchesTeacher && matchesDateFrom && matchesDateTo;
  });

  // Get observation counts per teacher
  const teacherObservationCounts = useMemo(() => {
    const counts = {};
    observationList.forEach(obs => {
      counts[obs.teacherId] = (counts[obs.teacherId] || 0) + 1;
    });
    return counts;
  }, [observationList]);

  // Get latest score per teacher
  const teacherLatestScores = useMemo(() => {
    const scores = {};
    observationList.forEach(obs => {
      if (!scores[obs.teacherId]) {
        scores[obs.teacherId] = obs.percentageScore;
      }
    });
    return scores;
  }, [observationList]);

  // Observer info for form
  const observerInfo = {
    id: currentUser?.afid || currentUser?.uid,
    name: currentUser?.name || currentUser?.email || 'Admin',
    position: currentUser?.position || 'Manager'
  };

  // Handle observation form success
  const handleObservationSuccess = async () => {
    // Refresh observation list
    const snapshot = await db.collection('classroomObservations')
      .orderBy('submittedAt', 'desc')
      .get();
    
    const data = snapshot.docs.map(doc => ({
      id: doc.id,
      ...doc.data(),
      submittedAt: doc.data().submittedAt?.toDate() || new Date(doc.data().submittedAtISO)
    }));
    
    setObservationList(data);
  };

  // Export observations
  const handleExport = () => {
    const exportData = filteredObservations.map(obs => ({
      'Date': new Date(obs.observationDate || obs.submittedAt).toLocaleDateString('en-IN'),
      'Time': obs.observationTime || '',
      'Teacher': obs.teacherName,
      'Subject': obs.teacherSubject,
      'School': obs.school,
      'Grade': obs.grade,
      'Score': obs.totalScore,
      'Max Score': obs.maxScore,
      'Percentage': obs.percentageScore + '%',
      'Flagged Items': obs.flaggedCount,
      'Strengths': obs.strengths || '',
      'Improvements': obs.improvements || '',
      'Observer': obs.observerName
    }));
    exportToExcel(exportData, 'classroom_observations');
  };

  return (
    <div className="space-y-6">
      <h2 className="text-3xl font-bold">üìã Classroom Observations</h2>

      {/* Stats Cards */}
      <div className="grid md:grid-cols-4 gap-4">
        <div className="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-4 rounded-xl">
          <div className="text-sm opacity-90">Total Observations</div>
          <div className="text-3xl font-bold">{observationList.length}</div>
        </div>
        <div className="bg-gradient-to-r from-green-500 to-green-600 text-white p-4 rounded-xl">
          <div className="text-sm opacity-90">Teachers Observed</div>
          <div className="text-3xl font-bold">{Object.keys(teacherObservationCounts).length}</div>
        </div>
        <div className="bg-gradient-to-r from-yellow-500 to-orange-500 text-white p-4 rounded-xl">
          <div className="text-sm opacity-90">Avg Score</div>
          <div className="text-3xl font-bold">
            {observationList.length > 0 
              ? (observationList.reduce((sum, o) => sum + o.percentageScore, 0) / observationList.length).toFixed(1) + '%'
              : 'N/A'}
          </div>
        </div>
        <div className="bg-gradient-to-r from-purple-500 to-purple-600 text-white p-4 rounded-xl">
          <div className="text-sm opacity-90">This Month</div>
          <div className="text-3xl font-bold">
            {observationList.filter(o => {
              const d = new Date(o.observationDate || o.submittedAt);
              const now = new Date();
              return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
            }).length}
          </div>
        </div>
      </div>

      {/* Teacher Selection for New Observation */}
      <div className="bg-white p-6 rounded-2xl shadow-lg">
        <h3 className="text-xl font-bold mb-4">üë• Select Teacher for Observation</h3>
        
        {/* Filters */}
        <div className="grid md:grid-cols-3 gap-4 mb-4">
          <div>
            <label className="block text-sm font-bold mb-2">Search Teacher</label>
            <input
              type="text"
              value={searchTerm}
              onChange={e => setSearchTerm(e.target.value)}
              placeholder="Type name..."
              className="w-full border-2 px-4 py-3 rounded-xl"
            />
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">School</label>
            <select value={filterSchool} onChange={e => setFilterSchool(e.target.value)} className="w-full border-2 px-4 py-3 rounded-xl">
              <option value="All">All Schools</option>
              {SCHOOLS.map(s => <option key={s} value={s}>{s}</option>)}
            </select>
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">Subject</label>
            <select value={filterSubject} onChange={e => setFilterSubject(e.target.value)} className="w-full border-2 px-4 py-3 rounded-xl">
              <option value="All">All Subjects</option>
              {SUBJECTS.map(s => <option key={s} value={s}>{s}</option>)}
            </select>
          </div>
        </div>

        {/* Teacher Cards */}
        <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
          {filteredTeachers.map(teacher => (
            <div key={teacher.docId || teacher.afid} className="border-2 rounded-xl p-4 hover:border-yellow-400 transition">
              <div className="flex justify-between items-start mb-3">
                <div>
                  <div className="font-bold text-lg">{teacher.name}</div>
                  <div className="text-sm text-gray-500">{teacher.subject} | {teacher.school}</div>
                </div>
                {teacherObservationCounts[teacher.afid] && (
                  <span className="px-2 py-1 bg-blue-100 text-blue-700 rounded-full text-xs font-bold">
                    {teacherObservationCounts[teacher.afid]} obs
                  </span>
                )}
              </div>
              
              {teacherLatestScores[teacher.afid] !== undefined && (
                <div className="mb-3">
                  <span className="text-sm text-gray-500">Latest Score: </span>
                  <span className={`font-bold ${
                    teacherLatestScores[teacher.afid] >= 80 ? 'text-green-600' :
                    teacherLatestScores[teacher.afid] >= 60 ? 'text-yellow-600' : 'text-red-600'
                  }`}>
                    {teacherLatestScores[teacher.afid]}%
                  </span>
                </div>
              )}

              <div className="flex gap-2">
                <button
                  onClick={() => {
                    setSelectedTeacher(teacher);
                    setShowObservationForm(true);
                  }}
                  className="flex-1 px-3 py-2 avanti-gradient text-white rounded-lg text-sm font-semibold"
                >
                  üìù New Observation
                </button>
                <button
                  onClick={() => {
                    setSelectedTeacher(teacher);
                    setShowTeacherProfile(true);
                  }}
                  className="flex-1 px-3 py-2 bg-gray-200 rounded-lg text-sm font-semibold hover:bg-gray-300"
                >
                  üë§ Profile
                </button>
              </div>
            </div>
          ))}
        </div>
      </div>

      {/* Observation History */}
      <div className="bg-white p-6 rounded-2xl shadow-lg">
        <div className="flex justify-between items-center mb-4">
          <h3 className="text-xl font-bold">üìä Observation History</h3>
          <button onClick={handleExport} className="px-4 py-2 bg-green-600 text-white rounded-xl font-semibold">
            üì• Export to Excel
          </button>
        </div>

        {/* List Filters */}
        <div className="grid md:grid-cols-4 gap-4 mb-4">
          <div>
            <label className="block text-sm font-bold mb-2">School</label>
            <select value={listFilterSchool} onChange={e => setListFilterSchool(e.target.value)} className="w-full border-2 px-4 py-2 rounded-xl">
              <option value="All">All Schools</option>
              {SCHOOLS.map(s => <option key={s} value={s}>{s}</option>)}
            </select>
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">Teacher</label>
            <select value={listFilterTeacher} onChange={e => setListFilterTeacher(e.target.value)} className="w-full border-2 px-4 py-2 rounded-xl">
              <option value="All">All Teachers</option>
              {teachers.map(t => <option key={t.afid} value={t.afid}>{t.name}</option>)}
            </select>
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">From Date</label>
            <input type="date" value={dateFrom} onChange={e => setDateFrom(e.target.value)} className="w-full border-2 px-4 py-2 rounded-xl"/>
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">To Date</label>
            <input type="date" value={dateTo} onChange={e => setDateTo(e.target.value)} className="w-full border-2 px-4 py-2 rounded-xl"/>
          </div>
        </div>

        {/* Observations Table */}
        {loading ? (
          <div className="text-center py-8">
            <div className="text-4xl mb-2">‚è≥</div>
            <p>Loading observations...</p>
          </div>
        ) : filteredObservations.length === 0 ? (
          <div className="text-center py-8 text-gray-500">
            <div className="text-4xl mb-2">üìã</div>
            <p>No observations found</p>
          </div>
        ) : (
          <div className="overflow-x-auto">
            <table className="w-full">
              <thead className="avanti-gradient-light">
                <tr>
                  <th className="p-3 text-left">Date</th>
                  <th className="p-3 text-left">Teacher</th>
                  <th className="p-3 text-left">Subject</th>
                  <th className="p-3 text-left">School</th>
                  <th className="p-3 text-left">Grade</th>
                  <th className="p-3 text-left">Score</th>
                  <th className="p-3 text-left">Flagged</th>
                  <th className="p-3 text-left">Observer</th>
                  <th className="p-3 text-left">Actions</th>
                </tr>
              </thead>
              <tbody>
                {filteredObservations.map(obs => (
                  <tr key={obs.id} className="border-b hover:bg-gray-50">
                    <td className="p-3">
                      <div className="font-semibold">{new Date(obs.observationDate || obs.submittedAt).toLocaleDateString('en-IN')}</div>
                      <div className="text-xs text-gray-500">{obs.observationTime}</div>
                    </td>
                    <td className="p-3 font-semibold">{obs.teacherName}</td>
                    <td className="p-3">{obs.teacherSubject}</td>
                    <td className="p-3">{obs.school}</td>
                    <td className="p-3">Class {obs.grade}</td>
                    <td className="p-3">
                      <span className={`px-3 py-1 rounded-full font-bold ${
                        obs.percentageScore >= 80 ? 'bg-green-100 text-green-700' :
                        obs.percentageScore >= 60 ? 'bg-yellow-100 text-yellow-700' : 'bg-red-100 text-red-700'
                      }`}>
                        {obs.percentageScore}%
                      </span>
                    </td>
                    <td className="p-3">
                      <span className="px-2 py-1 bg-red-100 text-red-700 rounded-full text-sm">
                        {obs.flaggedCount}
                      </span>
                    </td>
                    <td className="p-3 text-sm">{obs.observerName}</td>
                    <td className="p-3">
                      <button
                        onClick={() => {
                          const teacher = teachers.find(t => t.afid === obs.teacherId);
                          if (teacher) {
                            setSelectedTeacher(teacher);
                            setShowTeacherProfile(true);
                          }
                        }}
                        className="px-3 py-1 bg-blue-600 text-white rounded-lg text-sm"
                      >
                        View
                      </button>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        )}
      </div>

      {/* Observation Form Modal */}
      {showObservationForm && selectedTeacher && (
        <ClassroomObservationForm
          teacher={selectedTeacher}
          observerInfo={observerInfo}
          onClose={() => {
            setShowObservationForm(false);
            setSelectedTeacher(null);
          }}
          onSubmitSuccess={handleObservationSuccess}
        />
      )}

      {/* Teacher Profile Modal */}
      {showTeacherProfile && selectedTeacher && (
        <TeacherProfileView
          teacher={selectedTeacher}
          currentUser={currentUser}
          onClose={() => {
            setShowTeacherProfile(false);
            setSelectedTeacher(null);
          }}
        />
      )}
    </div>
  );
}

ReactDOM.render(<App/>,document.getElementById('root'));
  </script>
  <script>
  // ========================================
  // AGGRESSIVE AUTO-UPDATE MECHANISM FOR PWA
  // ========================================
  // Version management - UPDATE THIS WITH EACH DEPLOYMENT
  const CURRENT_VERSION = '3.5.1'; // Added Teacher Archive System - archive instead of delete, preserves data

  // Immediately check for updates on every page load
  (async function immediateUpdateCheck() {
    try {
      // Fetch the latest index.html with cache bypass
      const response = await fetch('/index.html?v=' + Date.now(), { 
        cache: 'no-store',
        headers: { 'Cache-Control': 'no-cache' }
      });
      const html = await response.text();
      
      // Extract version from fetched HTML
      const versionMatch = html.match(/CURRENT_VERSION\s*=\s*['"]([^'"]+)['"]/);
      if (versionMatch && versionMatch[1] !== CURRENT_VERSION) {
        console.log('üÜï New version available:', versionMatch[1], '(current:', CURRENT_VERSION, ')');
        // Auto-update without asking
        performUpdate();
      }
    } catch (e) {
      console.log('Version check failed:', e);
    }
  })();

  // Check stored version
  function checkStoredVersion() {
    const storedVersion = localStorage.getItem('appVersion');
    if (storedVersion && storedVersion !== CURRENT_VERSION) {
      console.log('üîÑ Stored version mismatch, updating...');
      performUpdate();
    } else if (!storedVersion) {
      localStorage.setItem('appVersion', CURRENT_VERSION);
    }
  }

  // Perform the update
  async function performUpdate() {
    console.log('üîÑ Starting auto-update...');
    
    // Show update indicator
    const updateBanner = document.createElement('div');
    updateBanner.innerHTML = `
      <div style="position: fixed; top: 0; left: 0; right: 0; background: linear-gradient(90deg, #F4B41A, #E8B039); color: white; padding: 12px 20px; text-align: center; z-index: 99999; font-family: Arial, sans-serif; box-shadow: 0 2px 10px rgba(0,0,0,0.2);">
        <span style="font-size: 16px;">üîÑ Updating to latest version... Please wait</span>
      </div>
    `;
    document.body.prepend(updateBanner);

    try {
      // Clear all caches
      if ('caches' in window) {
        const cacheNames = await caches.keys();
        await Promise.all(cacheNames.map(name => caches.delete(name)));
        console.log('üóëÔ∏è All caches cleared');
      }

      // Unregister all service workers
      if ('serviceWorker' in navigator) {
        const registrations = await navigator.serviceWorker.getRegistrations();
        await Promise.all(registrations.map(reg => reg.unregister()));
        console.log('üóëÔ∏è Service workers unregistered');
      }

      // Preserve user session
      const sessionData = {
        studentSession: localStorage.getItem('studentSession'),
        authToken: localStorage.getItem('authToken')
      };

      // Clear storage
      localStorage.clear();
      sessionStorage.clear();

      // Restore session
      if (sessionData.studentSession) localStorage.setItem('studentSession', sessionData.studentSession);
      if (sessionData.authToken) localStorage.setItem('authToken', sessionData.authToken);
      
      // Set new version
      localStorage.setItem('appVersion', CURRENT_VERSION);

      // Force reload with cache bypass
      setTimeout(() => {
        window.location.href = window.location.pathname + '?updated=' + Date.now();
      }, 500);

    } catch (e) {
      console.error('Update failed:', e);
      window.location.reload(true);
    }
  }

  // Manual update function
  window.forceUpdate = performUpdate;

  // Register service worker with immediate update behavior
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', async () => {
      try {
        const registration = await navigator.serviceWorker.register('/sw.js');
        console.log('‚úÖ Service Worker registered');

        // Check for updates immediately
        registration.update();

        // Check for updates every 5 minutes
        setInterval(() => registration.update(), 5 * 60 * 1000);

        // Handle updates
        registration.addEventListener('updatefound', () => {
          const newWorker = registration.installing;
          newWorker.addEventListener('statechange', () => {
            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
              // Skip waiting and activate immediately
              newWorker.postMessage({ type: 'SKIP_WAITING' });
            }
          });
        });

        // Reload on controller change
        navigator.serviceWorker.addEventListener('controllerchange', () => {
          window.location.reload(true);
        });

      } catch (err) {
        console.error('SW registration failed:', err);
      }
    });
  }

  // Also check on visibility change (when user returns to app)
  document.addEventListener('visibilitychange', () => {
    if (!document.hidden) {
      checkStoredVersion();
    }
  });

  // Check on load
  window.addEventListener('load', () => setTimeout(checkStoredVersion, 2000));

  // Log version
  console.log('%cüì± Curriculum Tracker v' + CURRENT_VERSION, 'color: #F4B41A; font-size: 16px; font-weight: bold;');
  console.log('%cType forceUpdate() to manually update', 'color: #666; font-size: 12px;');
</script>
  <script>
  window.va = window.va || function () { (window.vaq = window.vaq || []).push(arguments); };
</script>
<script defer src="/_vercel/insights/script.js"></script>
<script defer src="/_vercel/speed-insights/script.js"></script>

<!-- START: Global saving-indicator + Firestore write wrapper (added by ChatGPT) -->
<style>
/* simple overlay */
#__global_saving_overlay {
  position: fixed;
  right: 16px;
  bottom: 16px;
  background: rgba(0,0,0,0.75);
  color: white;
  padding: 10px 14px;
  border-radius: 10px;
  font-weight: 600;
  z-index: 99999;
  display: none;
  align-items: center;
  gap: 8px;
  box-shadow: 0 6px 20px rgba(0,0,0,0.35);
  backdrop-filter: blur(4px);
}
.__saving_spinner {
  width: 16px;
  height: 16px;
  border: 2px solid rgba(255,255,255,0.25);
  border-top-color: white;
  border-radius: 50%;
  animation: __spin 1s linear infinite;
}
@keyframes __spin { to { transform: rotate(360deg); } }

/* disabled appearance when saving */
.__global_saving_disabled {
  pointer-events: none !important;
  opacity: 0.6 !important;
}
</style>

<div id="__global_saving_overlay" aria-live="polite" role="status">
  <div class="__saving_spinner" aria-hidden="true"></div>
  <div>Saving‚Ä¶</div>
</div>

<script>
(function(){
  // Small, resilient wrapper that watches Firestore write methods and shows a saving indicator.
  if (!window || !document) return;
  const overlay = document.getElementById('__global_saving_overlay');
  let activeWrites = 0;
  function updateUI(){
    if (activeWrites > 0) {
      overlay.style.display = 'flex';
      // disable interactive elements except those marked data-allow-during-saving="true"
      const selectors = 'button, input[type="button"], input[type="submit"], a[role="button"], select, textarea';
      document.querySelectorAll(selectors).forEach(el=>{
        if (el.dataset.allowDuringSaving === "true") return;
        el.__wasDisabledBySaving = el.disabled || false;
        try { el.disabled = true; } catch(e){}
        el.classList.add('__global_saving_disabled');
      });
    } else {
      overlay.style.display = 'none';
      const selectors = 'button, input[type="button"], input[type="submit"], a[role="button"], select, textarea';
      document.querySelectorAll(selectors).forEach(el=>{
        try {
          // restore original disabled state only if we changed it
          if (el.__wasDisabledBySaving !== undefined) el.disabled = !!el.__wasDisabledBySaving;
        } catch(e){}
        el.classList.remove('__global_saving_disabled');
      });
    }
  }

  function startWrite(){ activeWrites++; updateUI(); }
  function endWrite(){ activeWrites = Math.max(0, activeWrites-1); updateUI(); }

  // Wrap common Firestore write methods if firebase is present.
  function tryWrapFirestore(firebase){
    try {
      const firestore = firebase && firebase.firestore && firebase.firestore();
      if (!firestore) return;
      // DocumentReference.prototype.set/update/delete
      const docProto = firestore.constructor && firestore.constructor.prototype;
      // Instead, find DocumentReference from an actual doc object if possible
      let sampleDoc;
      try {
        sampleDoc = firestore.collection('_chattmp_').doc('_tmp_');
      } catch(e){}
      if (sampleDoc) {
        const docRefProto = Object.getPrototypeOf(sampleDoc);
        ['set','update','delete'].forEach(name=>{
          if (docRefProto && docRefProto[name]) {
            const orig = docRefProto[name];
            if (!orig.__wrappedBySaving) {
              docRefProto[name] = function(...args){
                startWrite();
                try {
                  const result = orig.apply(this,args);
                  if (result && typeof result.then === 'function') {
                    return result.finally(endWrite);
                  } else {
                    endWrite();
                    return result;
                  }
                } catch(err){
                  endWrite();
                  throw err;
                }
              };
              docRefProto[name].__wrappedBySaving = true;
            }
          }
        });
      }
      // CollectionReference.add
      let sampleCol;
      try { sampleCol = firestore.collection('_chattmp_'); } catch(e){}
      if (sampleCol) {
        const colProto = Object.getPrototypeOf(sampleCol);
        if (colProto && colProto.add && !colProto.add.__wrappedBySaving) {
          const origAdd = colProto.add;
          colProto.add = function(...args){
            startWrite();
            try {
              const result = origAdd.apply(this,args);
              if (result && typeof result.then === 'function') {
                return result.finally(endWrite);
              } else {
                endWrite();
                return result;
              }
            } catch(err){
              endWrite();
              throw err;
            }
          };
          colProto.add.__wrappedBySaving = true;
        }
      }

      // Wrap write batch commit if available
      try {
        const batch = firestore.batch();
        const batchProto = Object.getPrototypeOf(batch);
        if (batchProto && batchProto.commit && !batchProto.commit.__wrappedBySaving) {
          const origCommit = batchProto.commit;
          batchProto.commit = function(...args){
            startWrite();
            try {
              const res = origCommit.apply(this,args);
              if (res && typeof res.then === 'function') return res.finally(endWrite);
              endWrite();
              return res;
            } catch(e){
              endWrite();
              throw e;
            }
          };
          batchProto.commit.__wrappedBySaving = true;
        }
      } catch(e){}
    } catch(e){}
  }

  // Try to wrap immediately if firebase exists, otherwise poll until it does (for lazy init)
  function attemptWrap(){
    try {
      if (window.firebase && firebase.firestore) {
        tryWrapFirestore(window.firebase);
        return true;
      }
    } catch(e){}
    return false;
  }
  if (!attemptWrap()){
    // poll a few times
    const maxAttempts = 20;
    let attempts = 0;
    const t = setInterval(()=>{
      attempts++;
      if (attemptWrap() || attempts >= maxAttempts) clearInterval(t);
    }, 300);
  }

  // As a fallback, also watch for global ajax/fetch/XHR calls that return promises ‚Äî optional
  // Wrap fetch to show saving indicator if fetch options contain a header 'X-Expect-Save: true'
  if (window.fetch && !window.fetch.__wrappedBySaving) {
    const origFetch = window.fetch.bind(window);
    window.fetch = function(resource, init){
      const expectSave = init && init.headers && (init.headers['X-Expect-Save'] === 'true' || init.headers.get && init.headers.get('X-Expect-Save') === 'true');
      if (expectSave) startWrite();
      const p = origFetch(resource, init);
      if (expectSave && p && typeof p.then === 'function') return p.finally(()=>endWrite());
      return p;
    };
    window.fetch.__wrappedBySaving = true;
  }

  // expose controls for debugging
  window.__savingOverlay = {
    isActive: ()=> activeWrites > 0,
    startWrite,
    endWrite
  };

})();
</script>
<!-- 
    AVANTI HELP DESK WIDGET - v4.0
    ================================
    
    FIXES INCLUDED:
    1. ‚úì Better mobile close button styling
    2. ‚úì Optimized screenshot upload with compression
    3. ‚úì PWA notification badge (red dot)
    4. ‚úì Real-time ticket notifications
    
    INSTALLATION:
    Add this entire code block just before </body> in your index.html
-->

<!-- Widget CSS -->
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Space+Mono&display=swap" rel="stylesheet">

<style>
/* ============================================
   AVANTI WIDGET STYLES v4.0
   ============================================ */

/* Greeting Popup */
.avanti-greeting-popup {
    position: fixed;
    bottom: 100px;
    right: 30px;
    background: linear-gradient(135deg, #12121a, #1a1a24);
    border: 1px solid #2a2a3a;
    border-radius: 16px;
    padding: 16px 20px;
    max-width: 280px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
    z-index: 99997;
    cursor: pointer;
    opacity: 0;
    visibility: hidden;
    transform: translateY(10px);
    transition: all 0.3s ease;
}

.avanti-greeting-popup.show {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
}

.avanti-greeting-popup .greeting-text {
    color: #fff;
    font-size: 14px;
    line-height: 1.5;
}

.avanti-greeting-popup .greeting-close {
    position: absolute;
    top: 8px;
    right: 8px;
    background: none;
    border: none;
    color: #5a5a6a;
    cursor: pointer;
    font-size: 18px;
    padding: 4px;
    line-height: 1;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.avanti-greeting-popup .greeting-close:hover {
    color: #fff;
    background: rgba(255,255,255,0.1);
}

/* Help Button - YELLOW GRADIENT */
.avanti-help-btn {
    position: fixed;
    bottom: 30px;
    right: 30px;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: linear-gradient(135deg, #F4B41A, #E8A830);
    border: none;
    cursor: pointer;
    box-shadow: 0 4px 20px rgba(244, 180, 26, 0.4);
    z-index: 99999;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
}

.avanti-help-btn:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 30px rgba(244, 180, 26, 0.5);
}

.avanti-help-btn .btn-icon {
    width: 28px;
    height: 28px;
    transition: all 0.3s ease;
}

.avanti-help-btn .btn-icon svg {
    width: 100%;
    height: 100%;
    fill: #0a0a0f;
}

.avanti-help-btn.open .btn-icon svg.chat-icon {
    display: none;
}

.avanti-help-btn.open .btn-icon svg.close-icon {
    display: block;
}

.avanti-help-btn .btn-icon svg.close-icon {
    display: none;
}

/* PWA Notification Badge */
.avanti-help-btn .notification-dot {
    position: absolute;
    top: 0px;
    right: 0px;
    width: 18px;
    height: 18px;
    background: #ef4444;
    border-radius: 50%;
    border: 3px solid #0a0a0f;
    display: none;
    animation: pulseBadge 2s infinite;
}

.avanti-help-btn .notification-dot.show {
    display: block;
}

@keyframes pulseBadge {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
}

/* Widget Panel */
.avanti-widget-panel {
    position: fixed;
    bottom: 100px;
    right: 30px;
    width: 380px;
    height: 520px;
    background: #12121a;
    border-radius: 20px;
    box-shadow: 0 10px 50px rgba(0, 0, 0, 0.5);
    z-index: 99998;
    display: flex;
    flex-direction: column;
    border: 1px solid #2a2a3a;
    opacity: 0;
    visibility: hidden;
    transform: translateY(20px) scale(0.95);
    transition: all 0.3s ease;
    overflow: hidden;
}

.avanti-widget-panel.open {
    opacity: 1;
    visibility: visible;
    transform: translateY(0) scale(1);
}

/* Header */
.avanti-widget-header {
    background: linear-gradient(135deg, #F4B41A, #E8A830);
    padding: 16px 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    min-height: 70px;
}

.avanti-widget-header-content {
    display: flex;
    align-items: center;
    gap: 12px;
}

.avanti-widget-header .logo {
    width: 42px;
    height: 42px;
    background: rgba(0,0,0,0.15);
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 22px;
}

.avanti-widget-header h3 {
    color: #0a0a0f;
    font-size: 17px;
    font-weight: 700;
    margin: 0;
}

.avanti-widget-header p {
    color: rgba(0,0,0,0.6);
    font-size: 12px;
    margin: 2px 0 0 0;
}

/* FIXED: Close button - better styling for mobile */
.avanti-widget-header .close-btn {
    background: rgba(0,0,0,0.15);
    border: none;
    width: 44px;
    height: 44px;
    min-width: 44px;
    min-height: 44px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    font-weight: bold;
    color: #0a0a0f;
    transition: all 0.2s;
    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;
}

.avanti-widget-header .close-btn:hover,
.avanti-widget-header .close-btn:active {
    background: rgba(0,0,0,0.25);
    transform: scale(1.05);
}

/* Body */
.avanti-widget-body {
    flex: 1;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
}

/* Home View */
.avanti-home-view {
    padding: 24px 20px;
    display: flex;
    flex-direction: column;
    height: 100%;
}

.avanti-welcome {
    margin-bottom: 24px;
}

.avanti-welcome h2 {
    font-size: 24px;
    font-weight: 700;
    color: #fff;
    margin: 0 0 4px 0;
    line-height: 1.3;
}

.avanti-welcome p {
    color: #8a8a9a;
    font-size: 15px;
    margin: 0;
}

/* Search Box */
.avanti-search-box {
    background: #1a1a24;
    border: 1px solid #2a2a3a;
    border-radius: 12px;
    padding: 14px 16px;
    display: flex;
    align-items: center;
    gap: 12px;
    cursor: pointer;
    transition: all 0.2s;
    margin-bottom: 20px;
}

.avanti-search-box:hover {
    border-color: #F4B41A;
}

.avanti-search-box span {
    color: #5a5a6a;
    font-size: 15px;
}

.avanti-search-box .arrow {
    margin-left: auto;
    color: #F4B41A;
    font-size: 18px;
}

/* Quick Actions */
.avanti-quick-actions {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-bottom: 20px;
}

.avanti-quick-action {
    background: #1a1a24;
    border: 1px solid #2a2a3a;
    border-radius: 12px;
    padding: 14px 16px;
    display: flex;
    align-items: center;
    gap: 12px;
    cursor: pointer;
    transition: all 0.2s;
    text-align: left;
    color: #fff;
    font-size: 14px;
    font-family: inherit;
}

.avanti-quick-action:hover {
    border-color: #F4B41A;
    transform: translateX(4px);
}

.avanti-quick-action .icon {
    font-size: 18px;
}

.avanti-quick-action .arrow {
    margin-left: auto;
    color: #5a5a6a;
}

/* Bottom Navigation */
.avanti-bottom-nav {
    display: flex;
    border-top: 1px solid #2a2a3a;
    background: #0a0a0f;
    padding: 8px 0;
}

.avanti-nav-item {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    padding: 10px;
    cursor: pointer;
    color: #5a5a6a;
    font-size: 11px;
    background: none;
    border: none;
    transition: all 0.2s;
    font-family: inherit;
    position: relative;
}

.avanti-nav-item:hover,
.avanti-nav-item.active {
    color: #F4B41A;
}

.avanti-nav-item .nav-icon {
    font-size: 20px;
}

.avanti-nav-item .nav-badge {
    position: absolute;
    top: 6px;
    right: calc(50% - 18px);
    width: 8px;
    height: 8px;
    background: #ef4444;
    border-radius: 50%;
    display: none;
}

.avanti-nav-item .nav-badge.show {
    display: block;
}

/* Chat View */
.avanti-chat-view {
    display: none;
    flex-direction: column;
    height: 100%;
}

.avanti-chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.avanti-chat-input {
    padding: 12px 16px;
    border-top: 1px solid #2a2a3a;
    display: flex;
    gap: 10px;
    background: #0a0a0f;
}

.avanti-chat-input input {
    flex: 1;
    background: #1a1a24;
    border: 1px solid #2a2a3a;
    border-radius: 24px;
    padding: 12px 18px;
    color: #fff;
    font-size: 14px;
    font-family: inherit;
}

.avanti-chat-input input:focus {
    outline: none;
    border-color: #F4B41A;
}

.avanti-chat-input input::placeholder {
    color: #5a5a6a;
}

.avanti-chat-input button {
    background: linear-gradient(135deg, #F4B41A, #E8A830);
    border: none;
    width: 44px;
    height: 44px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    color: #0a0a0f;
    transition: all 0.2s;
}

.avanti-chat-input button:hover {
    transform: scale(1.05);
}

/* Messages */
.avanti-msg {
    padding: 12px 16px;
    border-radius: 16px;
    font-size: 14px;
    line-height: 1.5;
    max-width: 85%;
    animation: msgSlide 0.3s ease;
}

@keyframes msgSlide {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.avanti-msg.bot {
    background: #1a1a24;
    color: #fff;
    align-self: flex-start;
    border: 1px solid #2a2a3a;
}

.avanti-msg.user {
    background: linear-gradient(135deg, #F4B41A, #E8A830);
    color: #0a0a0f;
    align-self: flex-end;
}

/* FAQ Results */
.avanti-faq-card {
    background: #1a1a24;
    border: 1px solid #2a2a3a;
    border-radius: 12px;
    padding: 14px;
    cursor: pointer;
    transition: all 0.2s;
    margin-bottom: 8px;
}

.avanti-faq-card:hover {
    border-color: #F4B41A;
}

.avanti-faq-card h4 {
    color: #fff;
    font-size: 14px;
    margin: 0;
    line-height: 1.4;
}

.avanti-faq-card .category {
    font-size: 11px;
    color: #F4B41A;
    text-transform: uppercase;
    margin-top: 6px;
}

/* FAQ Answer */
.avanti-faq-answer {
    background: #1a1a24;
    border: 1px solid #2a2a3a;
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 12px;
}

.avanti-faq-answer h4 {
    color: #F4B41A;
    font-size: 14px;
    margin: 0 0 10px 0;
}

.avanti-faq-answer p {
    color: #d1d1d1;
    font-size: 13px;
    line-height: 1.6;
    margin: 0;
}

/* Feedback Buttons */
.avanti-feedback-btns {
    display: flex;
    gap: 10px;
    margin-top: 10px;
}

.avanti-feedback-btn {
    flex: 1;
    padding: 10px;
    border: 1px solid #2a2a3a;
    background: #1a1a24;
    border-radius: 8px;
    cursor: pointer;
    color: #fff;
    font-size: 13px;
    transition: all 0.2s;
    font-family: inherit;
}

.avanti-feedback-btn:hover {
    border-color: #F4B41A;
}

.avanti-feedback-btn.yes:hover {
    background: rgba(16, 185, 129, 0.2);
    border-color: #10b981;
}

.avanti-feedback-btn.no:hover {
    background: rgba(239, 68, 68, 0.2);
    border-color: #ef4444;
}

/* Tickets View */
.avanti-tickets-view {
    display: none;
    flex-direction: column;
    height: 100%;
}

.avanti-tickets-header {
    padding: 16px 20px;
    border-bottom: 1px solid #2a2a3a;
}

.avanti-tickets-header h3 {
    color: #fff;
    font-size: 18px;
    margin: 0;
}

.avanti-tickets-list {
    flex: 1;
    overflow-y: auto;
    padding: 16px 20px;
}

/* Ticket Card */
.avanti-ticket-card {
    background: #1a1a24;
    border: 1px solid #2a2a3a;
    border-radius: 12px;
    padding: 14px;
    margin-bottom: 10px;
    cursor: pointer;
    transition: all 0.2s;
}

.avanti-ticket-card:hover {
    border-color: #F4B41A;
}

.avanti-ticket-card .ticket-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
}

.avanti-ticket-card .ticket-id {
    font-family: 'Space Mono', monospace;
    color: #F4B41A;
    font-size: 13px;
}

.avanti-ticket-card .status {
    font-size: 11px;
    padding: 4px 10px;
    border-radius: 20px;
    text-transform: capitalize;
}

.avanti-ticket-card .status.open {
    background: rgba(239, 68, 68, 0.2);
    color: #ef4444;
}

.avanti-ticket-card .status.in-progress {
    background: rgba(234, 179, 8, 0.2);
    color: #eab308;
}

.avanti-ticket-card .status.resolved {
    background: rgba(16, 185, 129, 0.2);
    color: #10b981;
}

.avanti-ticket-card .subject {
    color: #fff;
    font-size: 14px;
    margin-bottom: 6px;
}

.avanti-ticket-card .meta {
    color: #5a5a6a;
    font-size: 12px;
}

/* Form View */
.avanti-form-view {
    display: none;
    flex-direction: column;
    height: 100%;
}

.avanti-form-content {
    flex: 1;
    overflow-y: auto;
    padding: 16px 20px;
}

/* Action Buttons */
.avanti-action-btns {
    display: flex;
    gap: 10px;
    margin-top: 16px;
}

.avanti-action-btn {
    flex: 1;
    padding: 12px;
    border-radius: 10px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    font-family: inherit;
    border: none;
}

.avanti-action-btn.primary {
    background: linear-gradient(135deg, #F4B41A, #E8A830);
    color: #0a0a0f;
}

.avanti-action-btn.secondary {
    background: #1a1a24;
    border: 1px solid #2a2a3a;
    color: #fff;
}

.avanti-action-btn:hover {
    transform: translateY(-2px);
}

/* User Info Display */
.avanti-user-info {
    background: #1a1a24;
    border: 1px solid #2a2a3a;
    border-radius: 12px;
    padding: 14px;
    margin-bottom: 16px;
}

.avanti-user-info .user-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 10px;
    color: #10b981;
    font-size: 13px;
}

.avanti-user-row {
    display: flex;
    justify-content: space-between;
    padding: 6px 0;
    border-bottom: 1px solid #2a2a3a;
    font-size: 13px;
}

.avanti-user-row:last-child {
    border-bottom: none;
}

.avanti-user-row span:first-child {
    color: #8a8a9a;
}

.avanti-user-row span:last-child {
    color: #fff;
}

/* Form Styles */
.avanti-form-group {
    margin-bottom: 14px;
}

.avanti-form-group label {
    display: block;
    color: #8a8a9a;
    font-size: 12px;
    margin-bottom: 6px;
}

.avanti-form-group input,
.avanti-form-group textarea,
.avanti-form-group select {
    width: 100%;
    padding: 12px 14px;
    background: #1a1a24;
    border: 1px solid #2a2a3a;
    border-radius: 10px;
    color: #fff;
    font-size: 14px;
    font-family: inherit;
}

.avanti-form-group input:focus,
.avanti-form-group textarea:focus,
.avanti-form-group select:focus {
    outline: none;
    border-color: #F4B41A;
}

.avanti-form-group textarea {
    min-height: 100px;
    resize: vertical;
}

.avanti-form-group input:disabled {
    background: #0a0a0f;
    color: #8a8a9a;
}

.avanti-submit-btn {
    width: 100%;
    background: linear-gradient(135deg, #F4B41A, #E8A830);
    color: #0a0a0f;
    border: none;
    padding: 14px;
    border-radius: 10px;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    font-family: inherit;
}

.avanti-submit-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(244, 180, 26, 0.3);
}

.avanti-submit-btn:disabled {
    opacity: 0.7;
    cursor: not-allowed;
    transform: none;
}

/* Screenshot Upload */
.avanti-screenshot-section {
    margin-bottom: 16px;
}

.avanti-screenshot-label {
    color: #8a8a9a;
    font-size: 12px;
    margin-bottom: 8px;
}

.avanti-screenshot-upload {
    background: #1a1a24;
    border: 2px dashed #2a2a3a;
    border-radius: 12px;
    padding: 20px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
}

.avanti-screenshot-upload:hover {
    border-color: #F4B41A;
}

.avanti-screenshot-upload .upload-icon {
    font-size: 28px;
    margin-bottom: 8px;
}

.avanti-screenshot-upload .upload-text {
    color: #8a8a9a;
    font-size: 13px;
}

.avanti-screenshot-upload input[type="file"] {
    display: none;
}

.avanti-screenshot-preview {
    display: none;
    position: relative;
    margin-top: 10px;
}

.avanti-screenshot-preview img {
    width: 100%;
    border-radius: 8px;
    border: 1px solid #2a2a3a;
}

.avanti-screenshot-preview .remove-btn {
    position: absolute;
    top: 8px;
    right: 8px;
    width: 28px;
    height: 28px;
    background: #ef4444;
    border: none;
    border-radius: 50%;
    color: white;
    cursor: pointer;
    font-size: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* Upload Progress */
.avanti-upload-progress {
    background: #1a1a24;
    border-radius: 8px;
    padding: 12px;
    margin-top: 10px;
}

.avanti-progress-bar {
    height: 4px;
    background: #2a2a3a;
    border-radius: 2px;
    overflow: hidden;
}

.avanti-progress-fill {
    height: 100%;
    background: linear-gradient(135deg, #F4B41A, #E8A830);
    width: 0%;
    transition: width 0.3s;
}

.avanti-progress-text {
    font-size: 12px;
    color: #8a8a9a;
    margin-top: 6px;
    text-align: center;
}

/* Success View */
.avanti-success {
    text-align: center;
    padding: 40px 20px;
}

.avanti-success .icon {
    font-size: 60px;
    margin-bottom: 16px;
}

.avanti-success h3 {
    color: #10b981;
    font-size: 20px;
    margin: 0 0 8px 0;
}

.avanti-success .ticket-id {
    background: #1a1a24;
    padding: 12px 24px;
    border-radius: 10px;
    font-family: 'Space Mono', monospace;
    font-size: 18px;
    color: #F4B41A;
    margin: 16px 0;
    display: inline-block;
    border: 1px solid #2a2a3a;
}

.avanti-success p {
    color: #8a8a9a;
    font-size: 14px;
    line-height: 1.5;
}

/* Empty State */
.avanti-empty {
    text-align: center;
    padding: 40px 20px;
    color: #5a5a6a;
}

.avanti-empty .icon {
    font-size: 48px;
    margin-bottom: 12px;
}

.avanti-empty h4 {
    color: #8a8a9a;
    margin: 0 0 8px 0;
}

/* Loading */
.avanti-loading {
    display: inline-block;
    width: 18px;
    height: 18px;
    border: 2px solid rgba(0,0,0,0.2);
    border-top-color: #0a0a0f;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* MOBILE RESPONSIVE - FIXED */
@media (max-width: 480px) {
    .avanti-widget-panel {
        width: calc(100% - 20px);
        right: 10px;
        bottom: 80px;
        height: 75vh;
        max-height: 600px;
        border-radius: 16px;
    }
    
    .avanti-help-btn {
        width: 56px;
        height: 56px;
        right: 16px;
        bottom: 16px;
    }
    
    .avanti-help-btn .btn-icon {
        width: 24px;
        height: 24px;
    }
    
    .avanti-greeting-popup {
        right: 16px;
        bottom: 85px;
        max-width: calc(100% - 90px);
    }
    
    /* FIXED: Mobile close button - larger touch target */
    .avanti-widget-header {
        padding: 14px 16px;
    }
    
    .avanti-widget-header .close-btn {
        width: 48px;
        height: 48px;
        min-width: 48px;
        min-height: 48px;
        font-size: 28px;
        font-weight: bold;
        background: rgba(0,0,0,0.2);
    }
    
    .avanti-widget-header .logo {
        width: 38px;
        height: 38px;
    }
    
    .avanti-widget-header h3 {
        font-size: 15px;
    }
    
    .avanti-widget-header p {
        font-size: 11px;
    }
    
    .avanti-welcome h2 {
        font-size: 20px;
    }
    
    .avanti-home-view {
        padding: 20px 16px;
    }
}

/* Logo styling */
.replaced-logo { width: 32px; height: auto; display: inline-block; vertical-align: middle; }
</style>

<!-- Widget HTML -->
<div class="avanti-widget-container">
    <!-- Greeting Popup -->
    <div class="avanti-greeting-popup" id="avantiGreeting" onclick="AvantiWidget.open()">
        <button class="greeting-close" onclick="event.stopPropagation(); AvantiWidget.hideGreeting()">√ó</button>
        <div class="greeting-text" id="greetingText">
            üôè <strong>Namaste!</strong> Need any help with the Curriculum Tracker?
        </div>
    </div>
    
    <!-- Help Button -->
    <button class="avanti-help-btn" id="avantiBtn" onclick="AvantiWidget.toggle()">
        <span class="btn-icon">
            <svg class="chat-icon" viewBox="0 0 24 24" fill="#0a0a0f">
                <path d="M20 2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h14l4 4V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/>
            </svg>
            <svg class="close-icon" viewBox="0 0 24 24" fill="#0a0a0f">
                <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
            </svg>
        </span>
        <span class="notification-dot" id="notifDot"></span>
    </button>
    
    <!-- Widget Panel -->
    <div class="avanti-widget-panel" id="avantiPanel">
        <!-- Header -->
        <div class="avanti-widget-header">
            <div class="avanti-widget-header-content">
                <div class="logo">
  <img src="./logo.png" class="replaced-logo" alt="Avanti Logo">
</div>
                <div>
                    <h3>Avanti Help Desk</h3>
                    <p>We're here to help!</p>
                </div>
            </div>
            <button class="close-btn" onclick="AvantiWidget.close()" aria-label="Close">√ó</button>
        </div>
        
        <!-- Body -->
        <div class="avanti-widget-body" id="avantiBody">
            <!-- Home View -->
            <div class="avanti-home-view" id="homeView">
                <div class="avanti-welcome">
                    <h2 id="welcomeText">üôè Namaste! üëã</h2>
                    <p>How can we help you today?</p>
                </div>
                
                <div class="avanti-search-box" onclick="AvantiWidget.showChat()">
                    <span>üîç</span>
                    <span>Search for help...</span>
                    <span class="arrow">‚Üí</span>
                </div>
                
                <div class="avanti-quick-actions">
                    <button class="avanti-quick-action" onclick="AvantiWidget.searchTopic('login')">
                        <span class="icon">üîê</span>
                        <span>Login Issues</span>
                        <span class="arrow">‚Ä∫</span>
                    </button>
                    <button class="avanti-quick-action" onclick="AvantiWidget.searchTopic('attendance')">
                        <span class="icon">üìÖ</span>
                        <span>Attendance Help</span>
                        <span class="arrow">‚Ä∫</span>
                    </button>
                    <button class="avanti-quick-action" onclick="AvantiWidget.searchTopic('curriculum')">
                        <span class="icon">üìö</span>
                        <span>Curriculum & Progress</span>
                        <span class="arrow">‚Ä∫</span>
                    </button>
                    <button class="avanti-quick-action" onclick="AvantiWidget.showForm()">
                        <span class="icon">üé´</span>
                        <span>Raise a Support Ticket</span>
                        <span class="arrow">‚Ä∫</span>
                    </button>
                </div>
            </div>
            
            <!-- Chat View -->
            <div class="avanti-chat-view" id="chatView">
                <div class="avanti-chat-messages" id="chatMessages"></div>
                <div class="avanti-chat-input">
                    <input type="text" id="chatInput" placeholder="Type your question..." onkeypress="if(event.key==='Enter')AvantiWidget.sendMessage()">
                    <button onclick="AvantiWidget.sendMessage()">‚û§</button>
                </div>
            </div>
            
            <!-- Tickets View -->
            <div class="avanti-tickets-view" id="ticketsView">
                <div class="avanti-tickets-header">
                    <h3>Your Tickets</h3>
                </div>
                <div class="avanti-tickets-list" id="ticketsList"></div>
            </div>
            
            <!-- Form View -->
            <div class="avanti-form-view" id="formView">
                <div class="avanti-form-content" id="formContent"></div>
            </div>
        </div>
        
        <!-- Bottom Navigation -->
        <div class="avanti-bottom-nav">
            <button class="avanti-nav-item active" id="navHome" onclick="AvantiWidget.showHome()">
                <span class="nav-icon">üè†</span>
                <span>Home</span>
            </button>
            <button class="avanti-nav-item" id="navTickets" onclick="AvantiWidget.showTickets()">
                <span class="nav-icon">üé´</span>
                <span>Tickets</span>
                <span class="nav-badge" id="ticketsBadge"></span>
            </button>
        </div>
    </div>
</div>

<script>
// ============================================
// AVANTI WIDGET - VERSION 4.0
// FIXES:
// 1. Better mobile close button
// 2. Optimized screenshot upload with compression
// 3. PWA notification badge
// 4. Real-time ticket notifications
// ============================================
const AvantiWidget = {
    isOpen: false,
    user: null,
    faqs: [],
    tickets: [],
    currentView: 'home',
    screenshotFile: null,
    screenshotDataUrl: null,
    firebaseReady: false,
    initAttempts: 0,
    unreadNotifications: 0,
    
    // Get time-based greeting in Hindi/Sanskrit
    getGreeting: function(name) {
        const hour = new Date().getHours();
        const nameStr = name ? ` ${name}` : '';
        
        if (hour < 12) {
            return `üôè Namaste${nameStr}! ‡§∏‡•Å‡§™‡•ç‡§∞‡§≠‡§æ‡§§‡§Æ‡•ç üåÖ`;
        } else if (hour < 17) {
            return `üôè Namaste${nameStr}! ‡§∂‡•Å‡§≠‡§Æ‡§ß‡•ç‡§Ø‡§æ‡§π‡•ç‡§®‡§Æ‡•ç üåá`;
        } else {
            return `üôè Namaste${nameStr}! ‡§∂‡•Å‡§≠‡§∏‡§æ‡§Ø‡§Ç‡§ï‡§æ‡§≤‡§Æ‡•ç üåÉ`;
        }
    },
    
    // Initialize
    init: function() {
        console.log('[AvantiWidget] Starting initialization v4.0...');
        
        // Get user from localStorage first (students)
        this.getUserFromLocalStorage();
        
        // Update welcome text with Namaste
        this.updateWelcomeText();
        
        // Wait for Firebase
        this.waitForFirebase();
        
        // Show greeting popup after delay
        setTimeout(() => this.showGreeting(), 12000 + Math.random() * 3000);
        
        console.log('[AvantiWidget] Init complete');
    },
    
    // Wait for Firebase to be initialized
    waitForFirebase: function() {
        this.initAttempts++;
        
        if (typeof firebase !== 'undefined') {
            try {
                const testRef = firebase.firestore();
                this.firebaseReady = true;
                console.log('[AvantiWidget] ‚úì Firebase ready!');
                
                // Do Firebase-dependent init
                this.getTeacherFromFirebase();
                this.loadFAQs();
                setTimeout(() => this.loadTickets(), 1000);
                setTimeout(() => this.loadUserNotifications(), 1500);
                return;
            } catch (e) {
                console.log('[AvantiWidget] Waiting for Firebase... attempt:', this.initAttempts);
            }
        }
        
        // Retry up to 30 times (15 seconds)
        if (this.initAttempts < 30) {
            setTimeout(() => this.waitForFirebase(), 500);
        } else {
            console.log('[AvantiWidget] Firebase not available - running in offline mode');
        }
    },
    
    // Get user from localStorage (students)
    getUserFromLocalStorage: function() {
        const possibleKeys = ['studentSession', 'student', 'studentData', 'currentStudent', 'loggedInStudent'];
        
        for (const key of possibleKeys) {
            try {
                const data = localStorage.getItem(key);
                if (data) {
                    const parsed = JSON.parse(data);
                    if (parsed && (parsed.name || parsed.studentId || parsed.id)) {
                        const studentId = parsed.studentId || parsed.id || parsed.student_id || '';
                        this.user = {
                            type: 'student',
                            name: parsed.name || parsed.studentName || parsed.student_name || '',
                            studentId: studentId ? String(studentId) : '',
                            school: parsed.school || parsed.schoolName || parsed.center || parsed.school_name || '',
                            grade: parsed.grade || parsed.class || ''
                        };
                        console.log('[AvantiWidget] ‚úì Found student:', this.user.name, '| ID:', this.user.studentId);
                        return;
                    }
                }
            } catch (e) {}
        }
        console.log('[AvantiWidget] No student in localStorage');
    },
    
    // Get teacher from Firebase Auth
    getTeacherFromFirebase: function() {
        if (!this.firebaseReady || this.user) return;
        
        try {
            const currentUser = firebase.auth().currentUser;
            if (currentUser) {
                this.setTeacherUser(currentUser);
            }
            
            firebase.auth().onAuthStateChanged(u => {
                if (u && (!this.user || this.user.type !== 'student')) {
                    this.setTeacherUser(u);
                }
            });
        } catch (e) {
            console.log('[AvantiWidget] Firebase auth error:', e);
        }
    },
    
    // Set teacher user data
    setTeacherUser: function(firebaseUser) {
        this.user = {
            type: 'teacher',
            name: firebaseUser.displayName || firebaseUser.email?.split('@')[0] || '',
            email: firebaseUser.email || '',
            school: ''
        };
        
        console.log('[AvantiWidget] ‚úì Found teacher:', this.user.email);
        
        // Get teacher details from Firestore
        try {
            firebase.firestore().collection('teachers')
                .where('email', '==', firebaseUser.email)
                .limit(1)
                .get()
                .then(snap => {
                    if (!snap.empty) {
                        const t = snap.docs[0].data();
                        this.user.name = t.name || this.user.name;
                        this.user.school = t.school || t.center || t.schoolName || '';
                        console.log('[AvantiWidget] ‚úì Teacher details:', this.user.name, this.user.school);
                        this.updateWelcomeText();
                    }
                })
                .catch(e => {});
        } catch (e) {}
        
        this.updateWelcomeText();
    },
    
    // Update welcome text with NAMASTE
    updateWelcomeText: function() {
        const welcomeEl = document.getElementById('welcomeText');
        if (welcomeEl) {
            welcomeEl.textContent = this.getGreeting(this.user?.name);
        }
    },
    
    // Load FAQs
    loadFAQs: function() {
        if (!this.firebaseReady) return;
        
        try {
            firebase.firestore().collection('helpdesk_faqs')
                .onSnapshot(snap => {
                    this.faqs = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    console.log('[AvantiWidget] ‚úì Loaded FAQs:', this.faqs.length);
                }, err => {
                    console.log('[AvantiWidget] FAQ error:', err);
                });
        } catch (e) {}
    },
    
    // Load tickets
    loadTickets: function() {
        if (!this.firebaseReady || !this.user) {
            console.log('[AvantiWidget] Cannot load tickets - Firebase:', this.firebaseReady, 'User:', !!this.user);
            return;
        }
        
        try {
            let query;
            if (this.user.type === 'student' && this.user.studentId) {
                console.log('[AvantiWidget] Loading tickets for student:', this.user.studentId);
                query = firebase.firestore().collection('helpdesk_tickets')
                    .where('studentId', '==', String(this.user.studentId));
            } else if (this.user.email) {
                console.log('[AvantiWidget] Loading tickets for teacher:', this.user.email);
                query = firebase.firestore().collection('helpdesk_tickets')
                    .where('userEmail', '==', this.user.email);
            }
            
            if (query) {
                query.onSnapshot(snap => {
                    this.tickets = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    
                    // Sort by createdAt descending (newest first) - client-side
                    this.tickets.sort((a, b) => {
                        const dateA = a.createdAt?.toDate ? a.createdAt.toDate() : new Date(0);
                        const dateB = b.createdAt?.toDate ? b.createdAt.toDate() : new Date(0);
                        return dateB - dateA;
                    });
                    
                    console.log('[AvantiWidget] ‚úì Loaded tickets:', this.tickets.length);
                    
                    // Update badge
                    const openCount = this.tickets.filter(t => t.status !== 'resolved').length;
                    const badge = document.getElementById('ticketsBadge');
                    if (badge) {
                        badge.classList.toggle('show', openCount > 0);
                    }
                    
                    // Update list if visible
                    if (this.currentView === 'tickets') {
                        this.renderTickets();
                    }
                }, err => {
                    console.log('[AvantiWidget] Tickets error:', err);
                });
            }
        } catch (e) {
            console.error('[AvantiWidget] Error loading tickets:', e);
        }
    },
    
    // FIXED: Load user notifications and update PWA badge
    loadUserNotifications: function() {
        if (!this.firebaseReady || !this.user) return;
        
        const userId = this.user.studentId || this.user.email;
        if (!userId) return;
        
        try {
            firebase.firestore().collection('user_notifications')
                .where('userId', '==', String(userId))
                .onSnapshot(snap => {
                    const readIds = JSON.parse(localStorage.getItem('readTicketNotifications') || '[]');
                    const unread = snap.docs.filter(d => !readIds.includes(d.id));
                    
                    this.unreadNotifications = unread.length;
                    this.updatePWABadge();
                    
                    console.log('[AvantiWidget] ‚úì Unread notifications:', this.unreadNotifications);
                }, err => {
                    console.log('[AvantiWidget] Notifications error:', err);
                });
        } catch (e) {}
    },
    
    // FIXED: Update PWA notification badge
    updatePWABadge: function() {
        const notifDot = document.getElementById('notifDot');
        if (notifDot) {
            notifDot.classList.toggle('show', this.unreadNotifications > 0);
        }
        
        // Also update document title for PWA
        if (this.unreadNotifications > 0) {
            if (!document.title.startsWith('(')) {
                document.title = `(${this.unreadNotifications}) ${document.title}`;
            }
        } else {
            document.title = document.title.replace(/^\(\d+\)\s*/, '');
        }
    },
    
    // Show greeting popup
    showGreeting: function() {
        const popup = document.getElementById('avantiGreeting');
        const greetingText = document.getElementById('greetingText');
        
        if (greetingText && this.user?.name) {
            const hour = new Date().getHours();
            let timeGreeting = 'Namaste';
            if (hour < 12) timeGreeting = 'Good morning';
            else if (hour < 17) timeGreeting = 'Good afternoon';
            else timeGreeting = 'Good evening';
            
            greetingText.innerHTML = `üôè <strong>${timeGreeting}, ${this.user.name}!</strong> Need help with the Curriculum Tracker?`;
        }
        
        if (popup && !this.isOpen) {
            popup.classList.add('show');
            
            // Auto hide after 8 seconds
            setTimeout(() => this.hideGreeting(), 8000);
        }
    },
    
    hideGreeting: function() {
        document.getElementById('avantiGreeting')?.classList.remove('show');
    },
    
    // Toggle widget
    toggle: function() {
        this.isOpen ? this.close() : this.open();
    },
    
    open: function() {
        this.isOpen = true;
        document.getElementById('avantiPanel')?.classList.add('open');
        document.getElementById('avantiBtn')?.classList.add('open');
        this.hideGreeting();
        
        // Mark notifications as read when opened
        if (this.unreadNotifications > 0) {
            this.markNotificationsRead();
        }
    },
    
    close: function() {
        this.isOpen = false;
        document.getElementById('avantiPanel')?.classList.remove('open');
        document.getElementById('avantiBtn')?.classList.remove('open');
    },
    
    // Mark notifications as read
    markNotificationsRead: function() {
        if (!this.firebaseReady || !this.user) return;
        
        const userId = this.user.studentId || this.user.email;
        if (!userId) return;
        
        try {
            firebase.firestore().collection('user_notifications')
                .where('userId', '==', String(userId))
                .get()
                .then(snap => {
                    const readIds = snap.docs.map(d => d.id);
                    localStorage.setItem('readTicketNotifications', JSON.stringify(readIds));
                    this.unreadNotifications = 0;
                    this.updatePWABadge();
                });
        } catch (e) {}
    },
    
    // View navigation
    showHome: function() {
        this.currentView = 'home';
        document.getElementById('homeView').style.display = 'flex';
        document.getElementById('chatView').style.display = 'none';
        document.getElementById('ticketsView').style.display = 'none';
        document.getElementById('formView').style.display = 'none';
        
        document.getElementById('navHome').classList.add('active');
        document.getElementById('navTickets').classList.remove('active');
    },
    
    showChat: function() {
        this.currentView = 'chat';
        document.getElementById('homeView').style.display = 'none';
        document.getElementById('chatView').style.display = 'flex';
        document.getElementById('ticketsView').style.display = 'none';
        document.getElementById('formView').style.display = 'none';
        
        document.getElementById('navHome').classList.remove('active');
        document.getElementById('navTickets').classList.remove('active');
        
        // Clear and focus
        document.getElementById('chatMessages').innerHTML = 
            `<div class="avanti-msg bot">Hi! What can I help you with? Type your question below.</div>`;
        document.getElementById('chatInput').focus();
    },
    
    showTickets: function() {
        this.currentView = 'tickets';
        document.getElementById('homeView').style.display = 'none';
        document.getElementById('chatView').style.display = 'none';
        document.getElementById('ticketsView').style.display = 'flex';
        document.getElementById('formView').style.display = 'none';
        
        document.getElementById('navHome').classList.remove('active');
        document.getElementById('navTickets').classList.add('active');
        
        this.renderTickets();
    },
    
    renderTickets: function() {
        const container = document.getElementById('ticketsList');
        
        if (this.tickets.length === 0) {
            container.innerHTML = `
                <div class="avanti-empty">
                    <div class="icon">üì≠</div>
                    <h4>No tickets yet</h4>
                    <p>Raise a ticket when you need help!</p>
                    <button class="avanti-action-btn primary" style="margin-top: 16px;" onclick="AvantiWidget.showForm()">
                        üé´ Raise Ticket
                    </button>
                </div>
            `;
            return;
        }
        
        container.innerHTML = this.tickets.map(t => {
            const date = t.createdAt?.toDate ? t.createdAt.toDate() : new Date();
            const timeAgo = this.timeAgo(date);
            
            return `
                <div class="avanti-ticket-card" onclick="AvantiWidget.viewTicket('${t.id}')">
                    <div class="ticket-header">
                        <span class="ticket-id">#${t.ticketId || t.id.slice(0,8)}</span>
                        <span class="status ${t.status}">${t.status.replace('-', ' ')}</span>
                    </div>
                    <div class="subject">${t.subject || 'No subject'}</div>
                    <div class="meta">${timeAgo}</div>
                </div>
            `;
        }).join('');
    },
    
    timeAgo: function(date) {
        const seconds = Math.floor((new Date() - date) / 1000);
        if (seconds < 60) return 'Just now';
        if (seconds < 3600) return Math.floor(seconds / 60) + ' min ago';
        if (seconds < 86400) return Math.floor(seconds / 3600) + ' hours ago';
        return Math.floor(seconds / 86400) + ' days ago';
    },
    
    viewTicket: function(id) {
        const t = this.tickets.find(x => x.id === id);
        if (!t) return;
        
        const date = t.createdAt?.toDate ? t.createdAt.toDate() : new Date();
        
        const replies = (t.replies || []).map(r => {
            const rDate = r.timestamp?.toDate ? r.timestamp.toDate() : new Date(r.timestamp);
            return `
                <div style="background:${r.isAdmin ? 'rgba(244,180,26,0.1)' : '#1a1a24'};border:1px solid ${r.isAdmin ? '#F4B41A' : '#2a2a3a'};border-radius:10px;padding:12px;margin-bottom:8px;${r.isAdmin ? 'border-left:3px solid #F4B41A;' : ''}">
                    <div style="font-size:11px;color:#8a8a9a;margin-bottom:6px;">${r.isAdmin ? 'üë§ Admin' : 'üë§ You'} ‚Ä¢ ${rDate.toLocaleString()}</div>
                    <div style="color:#d1d1d1;font-size:13px;">${r.message}</div>
                </div>
            `;
        }).join('');
        
        const container = document.getElementById('ticketsList');
        container.innerHTML = `
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
                <span style="font-family:'Space Mono',monospace;color:#F4B41A;font-size:15px;">#${t.ticketId || t.id.slice(0,8)}</span>
                <span style="font-size:12px;padding:4px 10px;border-radius:20px;background:${
                    t.status === 'resolved' ? 'rgba(16,185,129,0.2)' : 
                    t.status === 'in-progress' ? 'rgba(234,179,8,0.2)' : 'rgba(239,68,68,0.2)'
                };color:${
                    t.status === 'resolved' ? '#10b981' : 
                    t.status === 'in-progress' ? '#eab308' : '#ef4444'
                };">${t.status.replace('-', ' ')}</span>
            </div>
            
            <div style="background:#1a1a24;border:1px solid #2a2a3a;border-radius:12px;padding:14px;margin-bottom:16px;">
                <div style="color:#F4B41A;font-size:14px;font-weight:600;margin-bottom:8px;">${t.subject}</div>
                <div style="color:#d1d1d1;font-size:13px;line-height:1.6;">${t.description}</div>
            </div>
            
            ${t.screenshotUrl ? `
                <div style="margin-bottom:16px;">
                    <div style="color:#8a8a9a;font-size:12px;margin-bottom:8px;">üì∑ Screenshot</div>
                    <img src="${t.screenshotUrl}" style="max-width:100%;border-radius:8px;border:1px solid #2a2a3a;cursor:pointer;" onclick="window.open('${t.screenshotUrl}', '_blank')">
                </div>
            ` : ''}
            
            ${replies ? `
                <div style="margin-bottom:16px;">
                    <div style="color:#8a8a9a;font-size:12px;margin-bottom:8px;">üí¨ Conversation</div>
                    ${replies}
                </div>
            ` : ''}
            
            <button class="avanti-action-btn secondary" style="width:100%;" onclick="AvantiWidget.showTickets()">
                ‚Üê Back to Tickets
            </button>
        `;
    },
    
    // Send message in chat
    sendMessage: function() {
        const input = document.getElementById('chatInput');
        const msg = input.value.trim();
        if (!msg) return;
        
        const messages = document.getElementById('chatMessages');
        messages.innerHTML += `<div class="avanti-msg user">${msg}</div>`;
        input.value = '';
        
        this.searchFAQs(msg);
        messages.scrollTop = messages.scrollHeight;
    },
    
    // Search topic
    searchTopic: function(topic) {
        this.showChat();
        setTimeout(() => {
            document.getElementById('chatInput').value = topic;
            this.sendMessage();
        }, 300);
    },
    
// ENTERPRISE CHAT LOGIC (FINAL)
searchFAQs: function(query) {
    const messages = document.getElementById('chatMessages');
    const q = query.toLowerCase().trim();

    this.botState = this.botState || { unclearCount: 0 };

    messages.innerHTML += `
        <div class="avanti-msg bot typing" id="typing">
            Avanti is typing<span>.</span><span>.</span><span>.</span>
        </div>`;
    messages.scrollTop = messages.scrollHeight;

    setTimeout(() => {
        document.getElementById('typing')?.remove();

        // Greeting
        if (/^(hi|hello|hey|namaste)$/.test(q)) {
            this.botState.unclearCount = 0;
            messages.innerHTML += `
                <div class="avanti-msg bot">Hello üëã How can I help you today?</div>
                <div class="avanti-msg bot">
                    You can ask about:
                    <br>üîê Login
                    <br>üìÖ Attendance
                    <br>üìö Curriculum
                </div>`;
            return;
        }

        // Small talk
        if (q.includes('how are you')) {
            messages.innerHTML += `<div class="avanti-msg bot">
                I‚Äôm doing well üòä Please tell me your issue.
            </div>`;
            return;
        }

        if (q.includes('thank')) {
            messages.innerHTML += `<div class="avanti-msg bot">
                You‚Äôre welcome. Happy to help.
            </div>`;
            return;
        }

        // Intent detection
        const intents = [
            { k:'login', w:['login','password','otp'] },
            { k:'attendance', w:['attendance','present','absent'] },
            { k:'curriculum', w:['curriculum','chapter','syllabus'] }
        ];

        for (const i of intents) {
            if (i.w.some(w => q.includes(w))) {
                this.botState.unclearCount = 0;
                this.searchTopic(i.k);
                return;
            }
        }

        // FAQ match
        const words = q.split(/\s+/).filter(w => w.length > 2);
        const results = this.faqs.filter(f => {
            const t = `${f.question} ${f.answer}`.toLowerCase();
            return words.filter(w => t.includes(w)).length >= 2;
        }).slice(0,3);

        if (results.length) {
            this.botState.unclearCount = 0;
            messages.innerHTML += `<div class="avanti-msg bot">Here‚Äôs what I found:</div>`;
            results.forEach(f => {
                messages.innerHTML += `
                    <div class="avanti-faq-card" onclick="AvantiWidget.showFAQAnswer('${f.id}')">
                        <h4>${f.question}</h4>
                        <div class="category">${f.category || 'General'}</div>
                    </div>`;
            });
            return;
        }

        // Controlled fallback (NO instant ticket)
        this.botState.unclearCount++;

        if (this.botState.unclearCount === 1) {
            messages.innerHTML += `<div class="avanti-msg bot">
                Can you clarify a bit more?
                Is this about login, attendance, or curriculum?
            </div>`;
            return;
        }

        if (this.botState.unclearCount === 2) {
            messages.innerHTML += `
                <div class="avanti-msg bot">
                    Thanks for your patience.
                    Please raise a ticket for detailed support.
                </div>
                <div class="avanti-action-btns" style="margin:10px 0;">
                    <button class="avanti-action-btn primary" onclick="AvantiWidget.showForm()">
                        üé´ Raise Ticket
                    </button>
                </div>`;
        }
    }, 600);
},
    
    // Show form view
    showForm: function() {
        this.currentView = 'form';
        document.getElementById('homeView').style.display = 'none';
        document.getElementById('chatView').style.display = 'none';
        document.getElementById('ticketsView').style.display = 'none';
        document.getElementById('formView').style.display = 'flex';
        
        this.screenshotFile = null;
        this.screenshotDataUrl = null;
        
        const formContent = document.getElementById('formContent');
        
        if (this.user) {
            // Logged in user - auto-filled form
            formContent.innerHTML = `
                <div class="avanti-user-info">
                    <div class="user-header">
                        ‚úì Logged in as ${this.user.type === 'student' ? 'Student' : 'Teacher'}
                    </div>
                    <div class="avanti-user-row">
                        <span>Name:</span>
                        <span>${this.user.name || 'N/A'}</span>
                    </div>
                    ${this.user.type === 'student' ? `
                        <div class="avanti-user-row">
                            <span>Student ID:</span>
                            <span>${this.user.studentId || 'N/A'}</span>
                        </div>
                        <div class="avanti-user-row">
                            <span>Grade:</span>
                            <span>Class ${this.user.grade || 'N/A'}</span>
                        </div>
                    ` : `
                        <div class="avanti-user-row">
                            <span>Email:</span>
                            <span>${this.user.email || 'N/A'}</span>
                        </div>
                    `}
                    <div class="avanti-user-row">
                        <span>School:</span>
                        <span>${this.user.school || 'N/A'}</span>
                    </div>
                </div>
                
                <div class="avanti-form-group">
                    <label>Issue Category</label>
                    <select id="formCategory">
                        <option value="login">Login Issues</option>
                        <option value="attendance">Attendance</option>
                        <option value="curriculum">Curriculum & Progress</option>
                        <option value="technical">Technical Error</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                
                <div class="avanti-form-group">
                    <label>Subject *</label>
                    <input type="text" id="formSubject" placeholder="Brief description of your issue">
                </div>
                
                <div class="avanti-form-group">
                    <label>Describe your issue *</label>
                    <textarea id="formDesc" placeholder="Please provide details..."></textarea>
                </div>
                
                <div class="avanti-screenshot-section">
                    <div class="avanti-screenshot-label">Screenshot (optional - max 2MB)</div>
                    <div class="avanti-screenshot-upload" onclick="document.getElementById('screenshotInput').click()">
                        <div class="upload-icon">üì∑</div>
                        <div class="upload-text">Click to upload screenshot</div>
                        <input type="file" id="screenshotInput" accept="image/*" onchange="AvantiWidget.handleScreenshot(this)">
                    </div>
                    <div class="avanti-screenshot-preview" id="screenshotPreview">
                        <img id="screenshotImg" src="">
                        <button class="remove-btn" onclick="AvantiWidget.removeScreenshot()">√ó</button>
                    </div>
                    <div class="avanti-upload-progress" id="uploadProgress" style="display: none;">
                        <div class="avanti-progress-bar">
                            <div class="avanti-progress-fill" id="progressFill"></div>
                        </div>
                        <div class="avanti-progress-text" id="progressText">Compressing image...</div>
                    </div>
                </div>
                
                <button class="avanti-submit-btn" id="formSubmitBtn" onclick="AvantiWidget.submitTicket()">
                    üé´ Submit Ticket
                </button>
                
                <button class="avanti-action-btn secondary" style="width:100%;margin-top:10px;" onclick="AvantiWidget.showHome()">
                    ‚Üê Back to Home
                </button>
            `;
        } else {
            // Not logged in - manual form
            formContent.innerHTML = `
                <div class="avanti-msg bot" style="background:#1a1a24;border:1px solid #f59e0b;margin-bottom:16px;border-radius:12px;padding:14px;">
                    ‚ö†Ô∏è <strong>Not logged in</strong><br>
                    <span style="color:#8a8a9a;font-size:13px;">Please fill in your details below.</span>
                </div>
                
                <div class="avanti-form-group">
                    <label>Your Name *</label>
                    <input type="text" id="formName" placeholder="Enter your name">
                </div>
                
                <div class="avanti-form-group">
                    <label>Student ID (if student)</label>
                    <input type="text" id="formStudentId" placeholder="e.g., JNV001">
                </div>
                
                <div class="avanti-form-group">
                    <label>Email (if teacher)</label>
                    <input type="email" id="formEmail" placeholder="your.email@school.com">
                </div>
                
                <div class="avanti-form-group">
                    <label>School Name *</label>
                    <input type="text" id="formSchool" placeholder="e.g., JNV Dhar, CoE Barwani">
                </div>
                
                <div class="avanti-form-group">
                    <label>Issue Category</label>
                    <select id="formCategory">
                        <option value="login">Login Issues</option>
                        <option value="attendance">Attendance</option>
                        <option value="curriculum">Curriculum & Progress</option>
                        <option value="technical">Technical Error</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                
                <div class="avanti-form-group">
                    <label>Subject *</label>
                    <input type="text" id="formSubject" placeholder="Brief description of your issue">
                </div>
                
                <div class="avanti-form-group">
                    <label>Describe your issue *</label>
                    <textarea id="formDesc" placeholder="Please provide details..."></textarea>
                </div>
                
                <div class="avanti-screenshot-section">
                    <div class="avanti-screenshot-label">Screenshot (optional - max 2MB)</div>
                    <div class="avanti-screenshot-upload" onclick="document.getElementById('screenshotInput').click()">
                        <div class="upload-icon">üì∑</div>
                        <div class="upload-text">Click to upload screenshot</div>
                        <input type="file" id="screenshotInput" accept="image/*" onchange="AvantiWidget.handleScreenshot(this)">
                    </div>
                    <div class="avanti-screenshot-preview" id="screenshotPreview">
                        <img id="screenshotImg" src="">
                        <button class="remove-btn" onclick="AvantiWidget.removeScreenshot()">√ó</button>
                    </div>
                    <div class="avanti-upload-progress" id="uploadProgress" style="display: none;">
                        <div class="avanti-progress-bar">
                            <div class="avanti-progress-fill" id="progressFill"></div>
                        </div>
                        <div class="avanti-progress-text" id="progressText">Compressing image...</div>
                    </div>
                </div>
                
                <button class="avanti-submit-btn" id="formSubmitBtn" onclick="AvantiWidget.submitTicketManual()">
                    üé´ Submit Ticket
                </button>
                
                <button class="avanti-action-btn secondary" style="width:100%;margin-top:10px;" onclick="AvantiWidget.showHome()">
                    ‚Üê Back to Home
                </button>
            `;
        }
    },
    
    // FIXED: Handle screenshot upload with compression
    handleScreenshot: function(input) {
        if (input.files && input.files[0]) {
            const file = input.files[0];
            
            // Show progress
            document.getElementById('uploadProgress').style.display = 'block';
            document.getElementById('progressText').textContent = 'Processing image...';
            document.getElementById('progressFill').style.width = '20%';
            
            // If file is too large, compress it
            if (file.size > 2 * 1024 * 1024) {
                this.compressImage(file).then(compressedFile => {
                    this.setScreenshot(compressedFile);
                }).catch(err => {
                    console.error('Compression error:', err);
                    alert('Failed to process image. Please try a smaller file.');
                    document.getElementById('uploadProgress').style.display = 'none';
                });
            } else {
                this.setScreenshot(file);
            }
        }
    },
    
    // FIXED: Compress large images
    compressImage: function(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    
                    // Max dimensions
                    const maxWidth = 1200;
                    const maxHeight = 1200;
                    
                    if (width > maxWidth) {
                        height = (height * maxWidth) / width;
                        width = maxWidth;
                    }
                    if (height > maxHeight) {
                        width = (width * maxHeight) / height;
                        height = maxHeight;
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    document.getElementById('progressFill').style.width = '60%';
                    document.getElementById('progressText').textContent = 'Compressing...';
                    
                    canvas.toBlob((blob) => {
                        if (blob) {
                            const compressedFile = new File([blob], file.name, {
                                type: 'image/jpeg',
                                lastModified: Date.now()
                            });
                            console.log('[AvantiWidget] Compressed from', file.size, 'to', compressedFile.size);
                            resolve(compressedFile);
                        } else {
                            reject(new Error('Compression failed'));
                        }
                    }, 'image/jpeg', 0.7);
                };
                img.onerror = reject;
                img.src = e.target.result;
            };
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    },
    
    setScreenshot: function(file) {
        this.screenshotFile = file;
        
        const reader = new FileReader();
        reader.onload = (e) => {
            this.screenshotDataUrl = e.target.result;
            document.getElementById('screenshotImg').src = e.target.result;
            document.getElementById('screenshotPreview').style.display = 'block';
            
            document.getElementById('progressFill').style.width = '100%';
            document.getElementById('progressText').textContent = 'Ready!';
            
            setTimeout(() => {
                document.getElementById('uploadProgress').style.display = 'none';
            }, 500);
        };
        reader.readAsDataURL(file);
    },
    
    // Remove screenshot
    removeScreenshot: function() {
        this.screenshotFile = null;
        this.screenshotDataUrl = null;
        document.getElementById('screenshotPreview').style.display = 'none';
        document.getElementById('screenshotInput').value = '';
        document.getElementById('uploadProgress').style.display = 'none';
    },
    
    // Upload screenshot to Firebase Storage
    uploadScreenshot: async function(ticketId) {
        if (!this.screenshotFile || !this.firebaseReady) return null;
        try {
            const storageRef = firebase.storage().ref();
            const fileRef = storageRef.child(`helpdesk_screenshots/${ticketId}_${Date.now()}.jpg`);
            await fileRef.put(this.screenshotFile);
            return await fileRef.getDownloadURL();
        } catch (e) {
            console.error('[AvantiWidget] Screenshot upload error:', e);
            return null;
        }
    },
    
    // Submit ticket (logged in user)
    submitTicket: async function() {
        if (!this.firebaseReady) {
            alert('Please wait, connecting to server...');
            return;
        }
        
        const btn = document.getElementById('formSubmitBtn');
        const subject = document.getElementById('formSubject').value.trim();
        const desc = document.getElementById('formDesc').value.trim();
        const category = document.getElementById('formCategory').value;
        
        if (!subject || !desc) {
            alert('Please fill in all required fields');
            return;
        }
        
        btn.disabled = true;
        btn.innerHTML = '<span class="avanti-loading"></span> Submitting...';
        
        try {
            const ticketId = 'AV' + Date.now().toString(36).toUpperCase() + Math.random().toString(36).substring(2,5).toUpperCase();
            
            let screenshotUrl = null;
            if (this.screenshotFile) {
                btn.innerHTML = '<span class="avanti-loading"></span> Uploading screenshot...';
                screenshotUrl = await this.uploadScreenshot(ticketId);
            }
            
            await firebase.firestore().collection('helpdesk_tickets').add({
                ticketId,
                userName: this.user.name,
                userEmail: this.user.email || '',
                studentId: this.user.studentId ? String(this.user.studentId) : null,
                school: this.user.school,
                userRole: this.user.type === 'student' ? 'Student' : 'Teacher',
                userGrade: this.user.grade || null,
                category,
                subject,
                description: desc,
                screenshotUrl: screenshotUrl,
                status: 'open',
                priority: 'medium',
                replies: [],
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            // Reload tickets immediately
            this.loadTickets();
            
            this.showSuccess(ticketId);
        } catch (err) {
            console.error(err);
            alert('Failed to submit. Please try again.');
            btn.disabled = false;
            btn.innerHTML = 'üé´ Submit Ticket';
        }
    },
    
    // Submit ticket (manual entry)
    submitTicketManual: async function() {
        if (!this.firebaseReady) {
            alert('Please wait, connecting to server...');
            return;
        }
        
        const btn = document.getElementById('formSubmitBtn');
        const name = document.getElementById('formName').value.trim();
        const studentId = document.getElementById('formStudentId').value.trim();
        const email = document.getElementById('formEmail').value.trim();
        const school = document.getElementById('formSchool').value.trim();
        const subject = document.getElementById('formSubject').value.trim();
        const desc = document.getElementById('formDesc').value.trim();
        const category = document.getElementById('formCategory').value;
        
        if (!name || !school || !subject || !desc) {
            alert('Please fill in all required fields');
            return;
        }
        
        btn.disabled = true;
        btn.innerHTML = '<span class="avanti-loading"></span> Submitting...';
        
        try {
            const ticketId = 'AV' + Date.now().toString(36).toUpperCase() + Math.random().toString(36).substring(2,5).toUpperCase();
            
            let screenshotUrl = null;
            if (this.screenshotFile) {
                btn.innerHTML = '<span class="avanti-loading"></span> Uploading screenshot...';
                screenshotUrl = await this.uploadScreenshot(ticketId);
            }
            
            await firebase.firestore().collection('helpdesk_tickets').add({
                ticketId,
                userName: name,
                userEmail: email || '',
                studentId: studentId || null,
                school: school,
                userRole: studentId ? 'Student' : (email ? 'Teacher' : 'Unknown'),
                category,
                subject,
                description: desc,
                screenshotUrl: screenshotUrl,
                status: 'open',
                priority: 'medium',
                replies: [],
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            this.showSuccess(ticketId);
        } catch (err) {
            console.error(err);
            alert('Failed to submit. Please try again.');
            btn.disabled = false;
            btn.innerHTML = 'üé´ Submit Ticket';
        }
    },
    
    // Show success view
    showSuccess: function(ticketId) {
        const formContent = document.getElementById('formContent');
        formContent.innerHTML = `
            <div class="avanti-success">
                <div class="icon">‚úÖ</div>
                <h3>Ticket Submitted!</h3>
                <div class="ticket-id">${ticketId}</div>
                <p>We've received your ticket. You'll be notified when there's an update.</p>
                <button class="avanti-action-btn primary" style="margin-top: 20px;" onclick="AvantiWidget.showTickets()">
                    View My Tickets
                </button>
                <button class="avanti-action-btn secondary" style="margin-top: 10px;" onclick="AvantiWidget.showHome()">
                    Back to Home
                </button>
            </div>
        `;
    }
};

// Initialize when DOM is ready
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => AvantiWidget.init());
} else {
    AvantiWidget.init();
}
</script>

<!-- ============================================
     GLOBAL NOTIFICATION SYSTEM
     For entire Curriculum Tracker app
============================================ -->
<style>
/* Notification Bell */
.notification-bell {
    position: fixed;
    top: 20px;
    right: 80px;
    z-index: 9998;
    background: #12121a;
    border: 1px solid #2a2a3a;
    border-radius: 50%;
    width: 44px;
    height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}

.notification-bell:hover {
    background: #1a1a24;
    transform: scale(1.05);
}

.notification-bell .bell-icon {
    font-size: 20px;
}

.notification-bell .badge {
    position: absolute;
    top: -4px;
    right: -4px;
    background: #ef4444;
    color: white;
    font-size: 11px;
    font-weight: 700;
    min-width: 18px;
    height: 18px;
    border-radius: 9px;
    display: none;
    align-items: center;
    justify-content: center;
    padding: 0 4px;
}

.notification-bell .badge.show {
    display: flex;
}

/* Notification Panel */
.notification-panel {
    position: fixed;
    top: 70px;
    right: 20px;
    width: 340px;
    max-height: 450px;
    background: #12121a;
    border: 1px solid #2a2a3a;
    border-radius: 16px;
    z-index: 9997;
    display: none;
    flex-direction: column;
    box-shadow: 0 10px 40px rgba(0,0,0,0.4);
    overflow: hidden;
}

.notification-panel.show {
    display: flex;
}

.notification-panel-header {
    padding: 16px 20px;
    border-bottom: 1px solid #2a2a3a;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.notification-panel-header h3 {
    color: #F4B41A;
    font-size: 16px;
    font-weight: 600;
}

.notification-panel-header button {
    background: none;
    border: none;
    color: #8a8a9a;
    cursor: pointer;
    font-size: 12px;
}

.notification-panel-header button:hover {
    color: #F4B41A;
}

.notification-panel-body {
    flex: 1;
    overflow-y: auto;
    padding: 12px;
}

.notification-item {
    background: #1a1a24;
    border: 1px solid #2a2a3a;
    border-radius: 12px;
    padding: 14px;
    margin-bottom: 10px;
    cursor: pointer;
    transition: all 0.2s;
}

.notification-item:hover {
    border-color: #F4B41A;
}

.notification-item.unread {
    border-left: 3px solid #F4B41A;
}

.notification-item .title {
    color: #fff;
    font-weight: 600;
    font-size: 14px;
    margin-bottom: 6px;
}

.notification-item .message {
    color: #8a8a9a;
    font-size: 13px;
    line-height: 1.4;
}

.notification-item .time {
    color: #5a5a6a;
    font-size: 11px;
    margin-top: 8px;
}

.notification-empty {
    text-align: center;
    padding: 40px 20px;
    color: #5a5a6a;
}

.notification-empty .icon {
    font-size: 40px;
    margin-bottom: 12px;
}

/* Enable notifications banner */
.enable-notifications-banner {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    padding: 12px 16px;
    margin: 12px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.enable-notifications-banner .text {
    flex: 1;
    color: #fff;
    font-size: 12px;
}

.enable-notifications-banner .btn {
    background: #fff;
    color: #667eea;
    border: none;
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 11px;
    font-weight: 600;
    cursor: pointer;
}

@media (max-width: 480px) {
    .notification-bell {
        right: 70px;
        top: 15px;
        width: 38px;
        height: 38px;
    }
    
    .notification-panel {
        right: 10px;
        left: 10px;
        width: auto;
    }
}
</style>

<!-- Notification Bell -->
<div class="notification-bell" id="notificationBell" onclick="NotificationManager.togglePanel()">
    <span class="bell-icon">üîî</span>
    <span class="badge" id="notificationBadge">0</span>
</div>

<!-- Notification Panel -->
<div class="notification-panel" id="notificationPanel">
    <div class="notification-panel-header">
        <h3>üîî Notifications</h3>
        <button onclick="NotificationManager.markAllRead()">Mark all read</button>
    </div>
    <div class="notification-panel-body" id="notificationList">
        <!-- Notifications loaded here -->
    </div>
</div>

<script>
// ============================================
// NOTIFICATION MANAGER - Global App Notifications
// ============================================
const NotificationManager = {
    notifications: [],
    unreadCount: 0,
    messaging: null,
    fcmToken: null,
    isOpen: false,
    userId: null,
    
    init: function() {
        console.log('[NotificationManager] Initializing...');
        
        // Get user ID
        this.getUserId();
        
        // Initialize Firebase Messaging
        this.initMessaging();
        
        // Load notifications from Firestore
        setTimeout(() => this.loadNotifications(), 2000);
        
        // Close panel when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.notification-bell') && !e.target.closest('.notification-panel')) {
                this.closePanel();
            }
        });
        
        console.log('[NotificationManager] Initialized');
    },
    
    getUserId: function() {
        // Try to get from localStorage (students)
        const studentSession = localStorage.getItem('studentSession');
        if (studentSession) {
            try {
                const student = JSON.parse(studentSession);
                this.userId = student.studentId || student.id || null;
                return;
            } catch (e) {}
        }
        
        // Try Firebase Auth (teachers)
        if (typeof firebase !== 'undefined' && firebase.auth) {
            firebase.auth().onAuthStateChanged(user => {
                if (user) {
                    this.userId = user.email;
                    this.loadNotifications();
                }
            });
        }
    },
    
    initMessaging: function() {
        if (typeof firebase === 'undefined' || !firebase.messaging) {
            console.log('[NotificationManager] Firebase Messaging not available');
            return;
        }
        
        try {
            this.messaging = firebase.messaging();
            console.log('[NotificationManager] Messaging ready');
            
            // Handle foreground messages
            this.messaging.onMessage((payload) => {
                console.log('[NotificationManager] Message received:', payload);
                
                // Show browser notification
                if (Notification.permission === 'granted') {
                    new Notification(payload.notification?.title || 'Avanti Fellows', {
                        body: payload.notification?.body,
                        icon: '/icon-192.png'
                    });
                }
                
                // Reload notifications
                this.loadNotifications();
            });
        } catch (e) {
            console.log('[NotificationManager] Messaging init error:', e);
        }
    },
    
    requestPermission: async function() {
        if (!('Notification' in window)) {
            alert('Your browser does not support notifications');
            return false;
        }
        
        try {
            const permission = await Notification.requestPermission();
            
            if (permission === 'granted') {
                await this.getFCMToken();
                this.renderNotifications();
                return true;
            } else {
                alert('Notifications blocked. Enable in browser settings.');
                return false;
            }
        } catch (e) {
            console.error('[NotificationManager] Permission error:', e);
            return false;
        }
    },
    
    getFCMToken: async function() {
        if (!this.messaging) return null;
        
        try {
            // Register service worker
            if ('serviceWorker' in navigator) {
                try {
                    await navigator.serviceWorker.register('/firebase-messaging-sw.js');
                } catch (e) {
                    console.log('[NotificationManager] SW error:', e.message);
                }
            }
            
            const token = await this.messaging.getToken({
                vapidKey: 'BAmI6KolDdphNCYs1yHd5UtWT80R4MQIO-5VVu5yvc2UfSBez-n5UAJ--MBQc_ZOAvzGOTJRWHQv2uyW2enLbEw' // Replace with your key
            });
            
            if (token) {
                this.fcmToken = token;
                await this.saveFCMToken(token);
                return token;
            }
        } catch (e) {
            console.error('[NotificationManager] Token error:', e);
        }
        return null;
    },
    
    saveFCMToken: async function(token) {
        if (!this.userId || typeof firebase === 'undefined') return;
        
        try {
            await firebase.firestore().collection('app_fcm_tokens').doc(String(this.userId)).set({
                token: token,
                userId: this.userId,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true });
            console.log('[NotificationManager] Token saved');
        } catch (e) {
            console.error('[NotificationManager] Save token error:', e);
        }
    },
    
    loadNotifications: function() {
        if (typeof firebase === 'undefined') return;
        
        try {
            // Load global announcements
            firebase.firestore().collection('app_notifications')
                .orderBy('createdAt', 'desc')
                .limit(15)
                .onSnapshot(snap => {
                    const globalNotifs = snap.docs.map(d => ({ id: d.id, source: 'global', ...d.data() }));
                    this.mergeNotifications(globalNotifs, 'global');
                }, err => {
                    console.log('[NotificationManager] Global notifications error:', err);
                });
            
            // Load user-specific ticket notifications
            if (this.userId) {
                firebase.firestore().collection('user_notifications')
                    .where('userId', '==', String(this.userId))
                    .orderBy('createdAt', 'desc')
                    .limit(15)
                    .onSnapshot(snap => {
                        const ticketNotifs = snap.docs.map(d => ({ id: d.id, source: 'ticket', ...d.data() }));
                        this.mergeNotifications(ticketNotifs, 'ticket');
                    }, err => {
                        // If index error, try without orderBy
                        console.log('[NotificationManager] Ticket notifications error:', err);
                        firebase.firestore().collection('user_notifications')
                            .where('userId', '==', String(this.userId))
                            .limit(15)
                            .get()
                            .then(snap => {
                                const ticketNotifs = snap.docs.map(d => ({ id: d.id, source: 'ticket', ...d.data() }));
                                this.mergeNotifications(ticketNotifs, 'ticket');
                            });
                    });
            }
        } catch (e) {
            console.error('[NotificationManager] Error:', e);
        }
    },
    
    // Merge notifications from different sources
    mergeNotifications: function(newNotifs, source) {
        // Remove old notifications from same source
        this.notifications = this.notifications.filter(n => n.source !== source);
        
        // Add new notifications
        this.notifications = this.notifications.concat(newNotifs);
        
        // Sort by date (newest first)
        this.notifications.sort((a, b) => {
            const dateA = a.createdAt?.toDate?.() || new Date(0);
            const dateB = b.createdAt?.toDate?.() || new Date(0);
            return dateB - dateA;
        });
        
        // Keep only latest 20
        this.notifications = this.notifications.slice(0, 20);
        
        this.updateUnreadCount();
        this.renderNotifications();
    },
    
    updateUnreadCount: function() {
        const readIds = JSON.parse(localStorage.getItem('readNotifications') || '[]');
        this.unreadCount = this.notifications.filter(n => !readIds.includes(n.id)).length;
        
        const badge = document.getElementById('notificationBadge');
        if (badge) {
            badge.textContent = this.unreadCount;
            badge.classList.toggle('show', this.unreadCount > 0);
        }
    },
    
    renderNotifications: function() {
        const list = document.getElementById('notificationList');
        if (!list) return;
        
        const readIds = JSON.parse(localStorage.getItem('readNotifications') || '[]');
        const permissionBanner = Notification.permission !== 'granted' ? 
            '<div class="enable-notifications-banner"><span class="text">üîî Enable push notifications to get instant updates</span><button class="btn" onclick="NotificationManager.requestPermission()">Enable</button></div>' : '';
        
        if (this.notifications.length === 0) {
            list.innerHTML = permissionBanner + '<div class="notification-empty"><div class="icon">üì≠</div><p>No notifications yet</p></div>';
            return;
        }
        
        list.innerHTML = permissionBanner + this.notifications.map(n => {
            const isUnread = !readIds.includes(n.id);
            const time = n.createdAt?.toDate?.() || new Date();
            const timeAgo = this.timeAgo(time);
            const isTicket = n.source === 'ticket' || n.type === 'ticket_update';
            const icon = isTicket ? 'üé´' : 'üì¢';
            const ticketLabel = isTicket && n.ticketId ? '<span style="color: #F4B41A; font-size: 11px; margin-left: 6px;">#' + n.ticketId + '</span>' : '';
            
            // Priority indicator
            const priorityColors = { 'urgent': '#ef4444', 'important': '#f59e0b', 'normal': '#3b82f6' };
            const priorityStyle = n.priority && n.priority !== 'normal' ? 'border-left: 3px solid ' + (priorityColors[n.priority] || '#3b82f6') + ';' : '';
            
            // Link button
            const linkBtn = n.link ? '<a href="' + n.link + '" target="_blank" style="display: inline-block; margin-top: 8px; background: #2a2a3a; color: #3b82f6; padding: 4px 10px; border-radius: 6px; font-size: 11px; text-decoration: none;">üîó Open Link</a>' : '';
            
            return `<div class="notification-item ${isUnread ? 'unread' : ''}" style="${priorityStyle}" onclick="NotificationManager.markRead('${n.id}')">
                <div class="title">${icon} ${n.title || 'Notification'}${ticketLabel}</div>
                <div class="message">${n.message || ''}</div>
                ${linkBtn}
                <div class="time">${timeAgo}</div>
            </div>`;
        }).join('');
    },
    
    timeAgo: function(date) {
        const seconds = Math.floor((new Date() - date) / 1000);
        if (seconds < 60) return 'Just now';
        if (seconds < 3600) return Math.floor(seconds / 60) + ' min ago';
        if (seconds < 86400) return Math.floor(seconds / 3600) + ' hours ago';
        return Math.floor(seconds / 86400) + ' days ago';
    },
    
    togglePanel: function() {
        this.isOpen ? this.closePanel() : this.openPanel();
    },
    
    openPanel: function() {
        document.getElementById('notificationPanel')?.classList.add('show');
        this.isOpen = true;
    },
    
    closePanel: function() {
        document.getElementById('notificationPanel')?.classList.remove('show');
        this.isOpen = false;
    },
    
    markRead: function(id) {
        const readIds = JSON.parse(localStorage.getItem('readNotifications') || '[]');
        if (!readIds.includes(id)) {
            readIds.push(id);
            localStorage.setItem('readNotifications', JSON.stringify(readIds));
            this.updateUnreadCount();
            this.renderNotifications();
            
            // Track view in Firestore for analytics
            this.trackNotificationView(id);
        }
    },
    
    // Track notification view for analytics
    trackNotificationView: async function(notificationId) {
        if (!this.userId || typeof firebase === 'undefined') return;
        
        try {
            const notifRef = firebase.firestore().collection('app_notifications').doc(notificationId);
            
            // Increment view count and add user to viewedBy array
            await notifRef.update({
                viewCount: firebase.firestore.FieldValue.increment(1),
                viewedBy: firebase.firestore.FieldValue.arrayUnion(String(this.userId))
            });
            
            console.log('[NotificationManager] View tracked for:', notificationId);
        } catch (e) {
            // Notification might not exist or be a ticket notification
            console.log('[NotificationManager] Could not track view:', e.message);
        }
    },
    
    markAllRead: function() {
        const readIds = this.notifications.map(n => n.id);
        localStorage.setItem('readNotifications', JSON.stringify(readIds));
        this.updateUnreadCount();
        this.renderNotifications();
    }
};

// Initialize when Firebase is ready
setTimeout(() => NotificationManager.init(), 1500);
</script>
</body>
</html>
