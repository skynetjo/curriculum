<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Curriculum Tracker - Avanti Fellows</title>
  
  <!-- ‚úÖ PERFORMANCE FIX: Resource hints for faster connections -->
  <link rel="preconnect" href="https://www.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://unpkg.com" crossorigin>
  <link rel="preconnect" href="https://cdn.tailwindcss.com" crossorigin>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="dns-prefetch" href="https://firestore.googleapis.com">
  <link rel="dns-prefetch" href="https://identitytoolkit.googleapis.com">
  
  <!-- ‚úÖ PERFORMANCE FIX: Critical CSS inline for instant loading screen -->
  <style id="critical-css">
    /* Instant loading screen - shows before any JS loads */
    .instant-loader {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #F4B41A 0%, #E8B039 50%, #C8342E 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 99999;
    }
    .instant-loader-logo {
      width: 80px;
      height: 80px;
      background: white;
      border-radius: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 40px;
      animation: pulse 1.5s ease-in-out infinite;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }
    .instant-loader-text {
      color: white;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      font-size: 24px;
      font-weight: bold;
      margin-top: 20px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .instant-loader-sub {
      color: rgba(255,255,255,0.9);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      font-size: 14px;
      margin-top: 8px;
    }
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    .loader-dots {
      display: flex;
      gap: 8px;
      margin-top: 30px;
    }
    .loader-dot {
      width: 12px;
      height: 12px;
      background: white;
      border-radius: 50%;
      animation: bounce 1.4s ease-in-out infinite;
    }
    .loader-dot:nth-child(1) { animation-delay: 0s; }
    .loader-dot:nth-child(2) { animation-delay: 0.2s; }
    .loader-dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes bounce {
      0%, 80%, 100% { transform: scale(0.6); opacity: 0.5; }
      40% { transform: scale(1); opacity: 1; }
    }
    
    /* ‚úÖ NEW: Login button spinner animation */
    .login-spinner {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
    }
    .login-spinner-icon {
      width: 24px;
      height: 24px;
      border: 3px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: login-spin 0.8s linear infinite;
    }
    @keyframes login-spin {
      to { transform: rotate(360deg); }
    }
    .login-progress-text {
      font-size: 16px;
      font-weight: 600;
    }
    
    /* ‚úÖ NEW: iOS fix - prevent stuck loading */
    .loader-timeout-msg {
      color: rgba(255,255,255,0.9);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      font-size: 13px;
      margin-top: 20px;
      text-align: center;
      max-width: 280px;
      line-height: 1.5;
      display: none;
    }
    .instant-loader.slow-loading .loader-timeout-msg {
      display: block;
    }
    .retry-btn {
      background: rgba(255,255,255,0.2);
      color: white;
      border: 2px solid white;
      padding: 10px 24px;
      border-radius: 25px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 12px;
      transition: all 0.2s;
    }
    .retry-btn:hover, .retry-btn:active {
      background: white;
      color: #C8342E;
    }
  </style>
  
  <!-- ‚úÖ iOS FIX: Force loader timeout after 15 seconds for iOS -->
  <script>
    // iOS detection and early timeout setup
    (function() {
      var isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || 
                  (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
      var isAndroid = /Android/.test(navigator.userAgent);
      var isMobile = isIOS || isAndroid;
      
      // ‚úÖ CRITICAL FIX: Increased timeout for remote JNV areas with slow connectivity
      // Teachers are 30-40km from cities with poor signals, need more time to load
      var loaderTimeout = isMobile ? 35000 : 45000; // 35s mobile, 45s desktop
      
      window._loaderTimeoutId = setTimeout(function() {
        var loader = document.getElementById('instant-loader');
        if (loader) {
          loader.classList.add('slow-loading');
        }
      }, loaderTimeout - 10000); // Show "slow loading" message 10s before force hide
      
      // ‚úÖ FIX: Force hide loader after timeout (prevents infinite loading on iOS)
      window._forceHideTimeout = setTimeout(function() {
        var loader = document.getElementById('instant-loader');
        if (loader && loader.parentNode) {
          console.warn('[Loader] Force hiding stuck loader after ' + loaderTimeout + 'ms');
          loader.style.transition = 'opacity 0.3s';
          loader.style.opacity = '0';
          setTimeout(function() { 
            if (loader.parentNode) loader.parentNode.removeChild(loader); 
          }, 300);
        }
      }, loaderTimeout);
      
      // ‚úÖ PERFORMANCE: Track load time for debugging
      window._appLoadStart = Date.now();
      window._logLoadTime = function(stage) {
        console.log('‚è±Ô∏è ' + stage + ': ' + (Date.now() - window._appLoadStart) + 'ms');
      };
      
      // ‚úÖ FIX: Safe localStorage wrapper for iOS private mode
      window.safeStorage = {
        getItem: function(key) {
          try { return localStorage.getItem(key); } 
          catch(e) { return null; }
        },
        setItem: function(key, value) {
          try { localStorage.setItem(key, value); return true; } 
          catch(e) { return false; }
        },
        removeItem: function(key) {
          try { localStorage.removeItem(key); return true; } 
          catch(e) { return false; }
        }
      };
      
      // ‚úÖ NEW: IndexedDB wrapper for persistent storage (survives PWA/APK restarts)
      window.persistentStorage = {
        _db: null,
        _dbName: 'AvantiCurriculumTracker',
        _storeName: 'sessions',
        
        init: function() {
          return new Promise((resolve, reject) => {
            if (this._db) { resolve(this._db); return; }
            if (!window.indexedDB) { reject('IndexedDB not supported'); return; }
            
            const request = indexedDB.open(this._dbName, 2); // Upgraded to v2 for dataCache store
            request.onerror = () => reject(request.error);
            request.onsuccess = () => { this._db = request.result; resolve(this._db); };
            request.onupgradeneeded = (e) => {
              const db = e.target.result;
              if (!db.objectStoreNames.contains(this._storeName)) {
                db.createObjectStore(this._storeName, { keyPath: 'key' });
              }
              // ‚úÖ NEW: Add dataCache store for app data persistence
              if (!db.objectStoreNames.contains('dataCache')) {
                db.createObjectStore('dataCache', { keyPath: 'key' });
              }
            };
          });
        },
        
        getItem: async function(key) {
          try {
            await this.init();
            return new Promise((resolve) => {
              const tx = this._db.transaction(this._storeName, 'readonly');
              const store = tx.objectStore(this._storeName);
              const request = store.get(key);
              request.onsuccess = () => resolve(request.result?.value || null);
              request.onerror = () => resolve(null);
            });
          } catch(e) { return null; }
        },
        
        setItem: async function(key, value) {
          try {
            await this.init();
            return new Promise((resolve) => {
              const tx = this._db.transaction(this._storeName, 'readwrite');
              const store = tx.objectStore(this._storeName);
              store.put({ key, value, timestamp: Date.now() });
              tx.oncomplete = () => resolve(true);
              tx.onerror = () => resolve(false);
            });
          } catch(e) { return false; }
        },
        
        removeItem: async function(key) {
          try {
            await this.init();
            return new Promise((resolve) => {
              const tx = this._db.transaction(this._storeName, 'readwrite');
              const store = tx.objectStore(this._storeName);
              store.delete(key);
              tx.oncomplete = () => resolve(true);
              tx.onerror = () => resolve(false);
            });
          } catch(e) { return false; }
        }
      };
      
      // ========================================
      // ‚úÖ CRITICAL FIX: Enhanced Data Cache Manager
      // Solves "Dashboard showing 0" and "Attendance not showing" issues
      // Uses Cache-First + Background Refresh strategy for low-connectivity areas
      // ========================================
      window.DataCacheManager = {
        _initialized: false,
        _cacheTimestamps: {},
        _dataFreshness: {},
        CACHE_MAX_AGE: 24 * 60 * 60 * 1000, // 24 hours max cache age
        STALE_THRESHOLD: 5 * 60 * 1000, // 5 minutes = consider stale, but still use
        
        init: async function() {
          if (this._initialized) return;
          try {
            await window.persistentStorage.init();
            this._initialized = true;
            console.log('[DataCache] ‚úÖ Initialized successfully');
          } catch(e) {
            console.warn('[DataCache] Init failed, using memory cache only:', e);
          }
        },
        
        // Save data to IndexedDB cache
        saveToCache: async function(key, data) {
          try {
            await this.init();
            const db = window.persistentStorage._db;
            if (!db) return false;
            
            return new Promise((resolve) => {
              try {
                const tx = db.transaction('dataCache', 'readwrite');
                const store = tx.objectStore('dataCache');
                store.put({ 
                  key, 
                  data,
                  timestamp: Date.now(),
                  userSchool: window._currentUserSchool || 'unknown'
                });
                tx.oncomplete = () => {
                  this._cacheTimestamps[key] = Date.now();
                  console.log('[DataCache] ‚úÖ Saved:', key);
                  resolve(true);
                };
                tx.onerror = () => resolve(false);
              } catch(e) {
                resolve(false);
              }
            });
          } catch(e) { 
            console.warn('[DataCache] Save failed for', key, e);
            return false; 
          }
        },
        
        // Load data from IndexedDB cache
        loadFromCache: async function(key) {
          try {
            await this.init();
            const db = window.persistentStorage._db;
            if (!db) return null;
            
            return new Promise((resolve) => {
              try {
                const tx = db.transaction('dataCache', 'readonly');
                const store = tx.objectStore('dataCache');
                const request = store.get(key);
                request.onsuccess = () => {
                  const result = request.result;
                  if (result && result.data) {
                    const age = Date.now() - (result.timestamp || 0);
                    // Return cached data if not too old (24 hours max)
                    if (age < this.CACHE_MAX_AGE) {
                      this._cacheTimestamps[key] = result.timestamp;
                      this._dataFreshness[key] = age < this.STALE_THRESHOLD ? 'fresh' : 'stale';
                      console.log('[DataCache] ‚úÖ Loaded from cache:', key, '(age:', Math.round(age/1000), 's)');
                      resolve(result.data);
                      return;
                    }
                  }
                  resolve(null);
                };
                request.onerror = () => resolve(null);
              } catch(e) {
                resolve(null);
              }
            });
          } catch(e) { 
            return null; 
          }
        },
        
        // Check if data is stale
        isStale: function(key) {
          const timestamp = this._cacheTimestamps[key];
          if (!timestamp) return true;
          return (Date.now() - timestamp) > this.STALE_THRESHOLD;
        },
        
        // Get freshness status for UI
        getFreshness: function(key) {
          return this._dataFreshness[key] || 'unknown';
        },
        
        // Clear all cached data (for logout, etc)
        clearAll: async function() {
          try {
            await this.init();
            const db = window.persistentStorage._db;
            if (!db) return;
            
            const tx = db.transaction('dataCache', 'readwrite');
            const store = tx.objectStore('dataCache');
            store.clear();
            this._cacheTimestamps = {};
            this._dataFreshness = {};
            console.log('[DataCache] üóëÔ∏è Cleared all cache');
          } catch(e) {
            console.warn('[DataCache] Clear failed:', e);
          }
        }
      };
      
      // ========================================
      // ‚úÖ CRITICAL FIX: Smart Firebase Query with Retry + Cache
      // Longer timeouts (30s), auto-retry, and cache fallback
      // ========================================
      window.smartFetch = async function(promise, options = {}) {
        const {
          cacheKey = null,
          timeoutMs = 30000, // ‚úÖ Increased from 6-8s to 30s for remote areas
          retries = 3,
          fallback = { docs: [] }
        } = options;
        
        // ‚úÖ STEP 1: Return cached data immediately if available
        let cachedData = null;
        if (cacheKey) {
          cachedData = await window.DataCacheManager.loadFromCache(cacheKey);
          if (cachedData && !window._forceRefresh) {
            console.log('[SmartFetch] ‚úÖ Using cached data for:', cacheKey);
            // Schedule background refresh
            setTimeout(() => {
              window._backgroundRefresh(promise, cacheKey);
            }, 100);
            return cachedData;
          }
        }
        
        // ‚úÖ STEP 2: Try to fetch fresh data with retries
        for (let attempt = 1; attempt <= retries; attempt++) {
          try {
            const result = await Promise.race([
              promise,
              new Promise((_, reject) => setTimeout(() => {
                reject(new Error(`Timeout after ${timeoutMs}ms (attempt ${attempt}/${retries})`));
              }, timeoutMs))
            ]);
            
            // ‚úÖ Success! Save to cache and return
            if (cacheKey && result?.docs) {
              const dataToCache = {
                docs: result.docs.map(d => ({ id: d.id, data: d.data() }))
              };
              window.DataCacheManager.saveToCache(cacheKey, dataToCache);
            }
            
            console.log('[SmartFetch] ‚úÖ Fresh data loaded for:', cacheKey || 'query');
            return result;
            
          } catch (error) {
            console.warn(`[SmartFetch] ‚ö†Ô∏è Attempt ${attempt}/${retries} failed:`, error.message);
            
            // Wait before retry (exponential backoff)
            if (attempt < retries) {
              await new Promise(r => setTimeout(r, 1000 * attempt));
            }
          }
        }
        
        // ‚úÖ STEP 3: All retries failed - use cache if available, otherwise fallback
        if (cachedData) {
          console.log('[SmartFetch] ‚ö†Ô∏è Using stale cache as fallback for:', cacheKey);
          window.DataCacheManager._dataFreshness[cacheKey] = 'stale';
          return cachedData;
        }
        
        console.warn('[SmartFetch] ‚ùå All attempts failed, using empty fallback for:', cacheKey || 'query');
        return fallback;
      };
      
      // Background refresh function (updates cache silently)
      window._backgroundRefresh = async function(promiseFactory, cacheKey) {
        try {
          // Create a new promise instance for background fetch
          const result = await Promise.race([
            typeof promiseFactory === 'function' ? promiseFactory() : promiseFactory,
            new Promise((_, reject) => setTimeout(() => reject(new Error('Background timeout')), 45000))
          ]);
          
          if (result?.docs && cacheKey) {
            const dataToCache = {
              docs: result.docs.map(d => ({ id: d.id, data: d.data() }))
            };
            await window.DataCacheManager.saveToCache(cacheKey, dataToCache);
            window.DataCacheManager._dataFreshness[cacheKey] = 'fresh';
            console.log('[BackgroundRefresh] ‚úÖ Updated cache for:', cacheKey);
            
            // Dispatch event for UI to know fresh data is available
            window.dispatchEvent(new CustomEvent('dataCacheUpdated', { detail: { key: cacheKey } }));
          }
        } catch(e) {
          console.log('[BackgroundRefresh] Background refresh failed:', e.message);
        }
      };
      
      // ‚úÖ Track data loading state globally for UI indicators
      window._dataLoadingState = {
        isLoading: false,
        lastLoadTime: null,
        errors: [],
        setLoading: function(loading) {
          this.isLoading = loading;
          if (!loading) this.lastLoadTime = Date.now();
          window.dispatchEvent(new CustomEvent('dataLoadingStateChange', { detail: this }));
        },
        addError: function(error) {
          this.errors.push({ message: error, time: Date.now() });
          if (this.errors.length > 10) this.errors.shift();
        }
      };
      
      // Initialize DataCache early
      window.DataCacheManager.init().catch(function(e) {
        console.log('[DataCache] Early init skipped:', e);
      });
      
      // Initialize IndexedDB early
      window.persistentStorage.init().catch(function(e) {
        console.log('IndexedDB init skipped:', e);
      });
    })();
  </script>
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#F4B41A">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Curriculum Tracker">
  <link rel="apple-touch-icon" href="/Icon-192.png">
  
  <!-- ‚úÖ PERFORMANCE: Preload critical scripts for faster loading -->
  <link rel="preload" href="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js" as="script">
  <link rel="preload" href="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js" as="script">
  <link rel="preload" href="https://unpkg.com/react@18/umd/react.production.min.js" as="script" crossorigin>
  <link rel="preload" href="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" as="script" crossorigin>
  
  <!-- ‚úÖ PERFORMANCE: Defer FontAwesome - not critical for initial render -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" crossorigin="anonymous" media="print" onload="this.media='all'" />

  <!-- ‚úÖ PERFORMANCE FIX: Load critical scripts first -->
  <!-- Firebase Core (required for auth) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  
  <!-- ‚úÖ COST FIX: Enable offline persistence early -->
  <script>
    window._firestoreInitialized = false;
    window._enableOfflinePersistence = function(db) {
      if (window._firestoreInitialized) return;
      window._firestoreInitialized = true;
      
      // Enable unlimited cache for offline support
      db.settings({ cacheSizeBytes: firebase.firestore.CACHE_SIZE_UNLIMITED });
      
      // Enable persistence - reduces Firebase reads by caching locally
      db.enablePersistence({ synchronizeTabs: true })
        .then(() => console.log('‚úÖ Offline persistence enabled - reduces Firebase costs'))
        .catch((err) => {
          if (err.code === 'failed-precondition') {
            console.log('Persistence limited to one tab');
          } else if (err.code === 'unimplemented') {
            console.log('Browser does not support persistence');
          }
        });
    };
    
    // ========================================
    // ‚úÖ MODERN PERFORMANCE ENHANCEMENTS
    // For fast, error-free loading in low-connectivity areas
    // ========================================
    
    // 1. CONNECTION STATUS DETECTION
    window.ConnectionManager = {
      _online: navigator.onLine,
      _listeners: [],
      _connectionQuality: 'unknown', // 'good', 'slow', 'offline'
      _lastPingTime: null,
      
      init: function() {
        window.addEventListener('online', () => this._setStatus(true));
        window.addEventListener('offline', () => this._setStatus(false));
        
        // Check actual connectivity (not just network interface)
        this.checkRealConnectivity();
        setInterval(() => this.checkRealConnectivity(), 30000);
      },
      
      _setStatus: function(online) {
        const wasOnline = this._online;
        this._online = online;
        this._connectionQuality = online ? 'unknown' : 'offline';
        
        if (!wasOnline && online) {
          console.log('üì∂ Back online - syncing data...');
          window.dispatchEvent(new CustomEvent('connectionRestored'));
        } else if (wasOnline && !online) {
          console.log('üì¥ Gone offline - using cached data');
          window.dispatchEvent(new CustomEvent('connectionLost'));
        }
        
        this._notifyListeners();
      },
      
      checkRealConnectivity: async function() {
        if (!navigator.onLine) {
          this._connectionQuality = 'offline';
          return;
        }
        
        const startTime = Date.now();
        try {
          // Use a small Firebase read to test actual connectivity
          const response = await Promise.race([
            fetch('https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js', { method: 'HEAD', mode: 'no-cors' }),
            new Promise((_, reject) => setTimeout(() => reject(new Error('timeout')), 5000))
          ]);
          
          const pingTime = Date.now() - startTime;
          this._lastPingTime = pingTime;
          
          if (pingTime < 1000) {
            this._connectionQuality = 'good';
          } else if (pingTime < 3000) {
            this._connectionQuality = 'slow';
          } else {
            this._connectionQuality = 'very-slow';
          }
          
          console.log('üì∂ Connection:', this._connectionQuality, '(' + pingTime + 'ms)');
        } catch (e) {
          this._connectionQuality = 'offline';
          this._online = false;
        }
        
        this._notifyListeners();
      },
      
      isOnline: function() { return this._online; },
      getQuality: function() { return this._connectionQuality; },
      
      subscribe: function(callback) {
        this._listeners.push(callback);
        return () => {
          this._listeners = this._listeners.filter(l => l !== callback);
        };
      },
      
      _notifyListeners: function() {
        this._listeners.forEach(l => l(this._online, this._connectionQuality));
      }
    };
    
    // 2. REQUEST DEDUPLICATION (prevents duplicate API calls)
    window.RequestDeduplicator = {
      _pendingRequests: new Map(),
      
      // Wrap a promise to deduplicate concurrent identical requests
      dedupe: function(key, promiseFactory) {
        if (this._pendingRequests.has(key)) {
          console.log('‚ö° Deduplicating request:', key);
          return this._pendingRequests.get(key);
        }
        
        const promise = promiseFactory()
          .finally(() => {
            // Remove from pending after a short delay
            setTimeout(() => this._pendingRequests.delete(key), 100);
          });
        
        this._pendingRequests.set(key, promise);
        return promise;
      },
      
      clear: function() {
        this._pendingRequests.clear();
      }
    };
    
    // 3. EXPONENTIAL BACKOFF RETRY
    window.retryWithBackoff = async function(fn, options = {}) {
      const { maxRetries = 3, baseDelay = 1000, maxDelay = 30000, onRetry = null } = options;
      let lastError;
      
      for (let attempt = 0; attempt < maxRetries; attempt++) {
        try {
          return await fn();
        } catch (error) {
          lastError = error;
          
          if (attempt < maxRetries - 1) {
            const delay = Math.min(baseDelay * Math.pow(2, attempt), maxDelay);
            console.log(`‚è≥ Retry ${attempt + 1}/${maxRetries} in ${delay}ms...`);
            
            if (onRetry) onRetry(attempt + 1, delay, error);
            
            await new Promise(resolve => setTimeout(resolve, delay));
          }
        }
      }
      
      throw lastError;
    };
    
    // 4. REQUEST QUEUE FOR OFFLINE (queues requests when offline)
    window.OfflineQueue = {
      _queue: [],
      _processing: false,
      
      init: function() {
        // Load queue from storage
        try {
          const saved = localStorage.getItem('offlineQueue');
          if (saved) this._queue = JSON.parse(saved);
        } catch(e) {}
        
        // Process when back online
        window.addEventListener('connectionRestored', () => this.processQueue());
      },
      
      add: function(operation) {
        this._queue.push({
          ...operation,
          id: Date.now() + '_' + Math.random().toString(36).substr(2, 9),
          timestamp: new Date().toISOString()
        });
        this._save();
        console.log('üìù Queued offline operation:', operation.type);
      },
      
      processQueue: async function() {
        if (this._processing || this._queue.length === 0) return;
        this._processing = true;
        
        console.log('üîÑ Processing', this._queue.length, 'queued operations...');
        
        const queue = [...this._queue];
        this._queue = [];
        this._save();
        
        for (const op of queue) {
          try {
            if (op.type === 'attendance') {
              await firebase.firestore().collection('studentAttendance').doc(op.docId).set(op.data);
              console.log('‚úÖ Synced attendance:', op.docId);
            } else if (op.type === 'curriculum') {
              await firebase.firestore().collection('chapterProgress').doc(op.docId).set(op.data, { merge: true });
              console.log('‚úÖ Synced curriculum:', op.docId);
            }
          } catch (e) {
            console.error('‚ùå Failed to sync:', op, e);
            this._queue.push(op); // Re-add failed operations
          }
        }
        
        this._save();
        this._processing = false;
        
        if (this._queue.length > 0) {
          console.log('‚ö†Ô∏è', this._queue.length, 'operations still pending');
        }
      },
      
      _save: function() {
        try {
          localStorage.setItem('offlineQueue', JSON.stringify(this._queue));
        } catch(e) {}
      },
      
      getPendingCount: function() {
        return this._queue.length;
      }
    };
    
    // 5. GLOBAL ERROR BOUNDARY (prevents app crashes)
    window.onerror = function(message, source, lineno, colno, error) {
      console.error('üö® Global error:', message, source, lineno);
      
      // Don't crash on non-critical errors
      if (message.includes('Loading chunk') || message.includes('ChunkLoadError')) {
        console.log('Attempting to recover from chunk load error...');
        // Could trigger a soft reload here
        return true;
      }
      
      return false;
    };
    
    window.addEventListener('unhandledrejection', function(event) {
      console.error('üö® Unhandled promise rejection:', event.reason);
      
      // Prevent crash on network errors
      if (event.reason && (
        event.reason.message?.includes('network') ||
        event.reason.message?.includes('timeout') ||
        event.reason.code === 'unavailable'
      )) {
        event.preventDefault();
        console.log('üì∂ Network error handled gracefully');
      }
    });
    
    // Initialize managers early
    window.ConnectionManager.init();
    window.OfflineQueue.init();
    
    console.log('‚úÖ Modern performance enhancements loaded');
  </script>
  
  <!-- React (required for app) -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- ‚úÖ PERFORMANCE FIX: Defer non-critical scripts -->
  <script defer src="https://www.gstatic.com/firebasejs/9.22.0/firebase-messaging-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
  
  <!-- Chart.js - NOT deferred because datalabels registration needs it immediately -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
  
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script defer src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/otpauth/9.2.2/otpauth.umd.min.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script defer src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
  
  <style>
    /* ‚úÖ PERFORMANCE: GPU acceleration for smooth animations */
    .avanti-gradient, .stat-card, .chapter-card, .modal-content {
      transform: translateZ(0);
      backface-visibility: hidden;
    }
    
    /* ‚úÖ PERFORMANCE: Reduce paint areas */
    #root {
  min-height: 100vh;
}
    
    /* Priority Badge Gradients */
.priority-badge {
  display: inline-block;
  padding: 0.4rem 0.8rem;
  border-radius: 0.4rem;
  font-size: 0.75rem;
  font-weight: 600;
  color: white;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.12);
  text-align: center;
  min-width: 100px;
  letter-spacing: 0.02em;
}

.priority-high {
  background: linear-gradient(90deg, #10B981 0%, #34D399 100%);
}

.priority-medium {
  background: linear-gradient(90deg, #F59E0B 0%, #FBBF24 100%);
}

.priority-low {
  background: linear-gradient(90deg, #EF4444 0%, #F87171 100%);
}
    :root{
      --avanti-yellow:#F4B41A;
      --avanti-orange:#E8B039;
      --avanti-red:#C8342E;
      /* Light theme (default) */
      --bg-primary: #f8fafc;
      --bg-secondary: #ffffff;
      --bg-card: #ffffff;
      --text-primary: #1f2937;
      --text-secondary: #6b7280;
      --border-color: #e5e7eb;
    }
    
    /* Dark Theme */
    [data-theme="dark"] {
      --bg-primary: #0f172a;
      --bg-secondary: #1e293b;
      --bg-card: #1e293b;
      --text-primary: #f1f5f9;
      --text-secondary: #94a3b8;
      --border-color: #334155;
    }
    
    [data-theme="dark"] .main-content {
      background: var(--bg-primary) !important;
    }
    
    [data-theme="dark"] .bg-white {
      background: var(--bg-card) !important;
    }
    
    [data-theme="dark"] .bg-gray-50,
    [data-theme="dark"] .bg-gray-100 {
      background: var(--bg-secondary) !important;
    }
    
    [data-theme="dark"] .text-gray-900,
    [data-theme="dark"] .text-gray-800,
    [data-theme="dark"] .text-gray-700 {
      color: var(--text-primary) !important;
    }
    
    [data-theme="dark"] .text-gray-600,
    [data-theme="dark"] .text-gray-500 {
      color: var(--text-secondary) !important;
    }
    
    [data-theme="dark"] .border-gray-200,
    [data-theme="dark"] .border-gray-300 {
      border-color: var(--border-color) !important;
    }
    
    [data-theme="dark"] .shadow-lg,
    [data-theme="dark"] .shadow-md,
    [data-theme="dark"] .shadow {
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.2) !important;
    }
    
    [data-theme="dark"] input,
    [data-theme="dark"] select,
    [data-theme="dark"] textarea {
      background: var(--bg-secondary) !important;
      color: var(--text-primary) !important;
      border-color: var(--border-color) !important;
    }
    
    [data-theme="dark"] table {
      background: var(--bg-card);
    }
    
    [data-theme="dark"] th {
      background: var(--bg-secondary) !important;
      color: var(--text-primary) !important;
    }
    
    [data-theme="dark"] td {
      border-color: var(--border-color) !important;
      color: var(--text-primary) !important;
    }
    
    [data-theme="dark"] tr:hover {
      background: rgba(255,255,255,0.05) !important;
    }
    
    /* ‚úÖ FIX: Dark mode Social Wall text visibility */
    [data-theme="dark"] .post-card {
      background: var(--bg-card) !important;
      border-color: var(--border-color) !important;
    }
    
    [data-theme="dark"] .post-card .text-gray-700,
    [data-theme="dark"] .post-card .text-gray-800,
    [data-theme="dark"] .post-card p {
      color: #e2e8f0 !important;
    }
    
    [data-theme="dark"] .post-card .text-gray-500,
    [data-theme="dark"] .post-card .text-gray-400 {
      color: #94a3b8 !important;
    }
    
    [data-theme="dark"] .post-card .bg-gray-50,
    [data-theme="dark"] .post-card .bg-gray-100 {
      background: #334155 !important;
    }
    
    [data-theme="dark"] .reddit-action-row .reddit-timestamp,
    [data-theme="dark"] .reddit-action-row .reddit-action-btn {
      color: #94a3b8 !important;
    }
    
    [data-theme="dark"] .reddit-action-row .reddit-action-btn:hover {
      background: rgba(255,255,255,0.1) !important;
      color: #e2e8f0 !important;
    }
    
    [data-theme="dark"] .emoji-btn {
      background: #334155 !important;
    }
    
    [data-theme="dark"] .emoji-btn:hover {
      background: #475569 !important;
    }
    
    [data-theme="dark"] .mention-tag {
      color: #60a5fa !important;
      background: rgba(96, 165, 250, 0.15) !important;
    }
    
    [data-theme="dark"] .tab-inactive {
      background: var(--bg-card) !important;
      color: #94a3b8 !important;
    }
    
    [data-theme="dark"] .celebration-card {
      background: linear-gradient(135deg, #1e1b4b 0%, #312e81 50%, #4c1d95 100%) !important;
      border-color: #6366f1 !important;
    }
    
    [data-theme="dark"] .celebration-card h3 {
      color: #f9a8d4 !important;
    }
    
    /* ‚úÖ FIX: Profile photo in comments - remove vertical line */
    .comment-wrapper img,
    .comment-wrapper > div:first-child {
      border: none !important;
      box-shadow: none !important;
      position: relative;
      z-index: 2;
    }
    
    /* ‚úÖ FIX: Ensure thread line doesn't overlap avatar */
    .reddit-comment-thread::before {
      left: 12px;
      z-index: 1;
    }
    
    /* Theme Toggle Switch */
    .theme-toggle-container {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 12px;
      background: rgba(255,255,255,0.05);
      border-radius: 10px;
      margin: 8px;
    }
    
    .theme-toggle {
      position: relative;
      width: 50px;
      height: 26px;
      background: #374151;
      border-radius: 13px;
      cursor: pointer;
      transition: background 0.3s;
    }
    
    .theme-toggle.dark {
      background: #F4B41A;
    }
    
    .theme-toggle-slider {
      position: absolute;
      top: 3px;
      left: 3px;
      width: 20px;
      height: 20px;
      background: white;
      border-radius: 50%;
      transition: transform 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
    }
    
    .theme-toggle.dark .theme-toggle-slider {
      transform: translateX(24px);
    }
    
    *{box-sizing:border-box}
    
    /* Smooth scrolling for the entire app */
    html {
      scroll-behavior: smooth;
    }
    
    /* Better font rendering */
    body {
  margin: 0;
  overflow-x: hidden;

  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  text-rendering: optimizeLegibility;
}

    
    /* Enhanced Mobile Sidebar Styles */
    .mobile-sidebar-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 998;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }
    
    .mobile-sidebar-overlay.active {
      opacity: 1;
      visibility: visible;
    }
    
    .mobile-sidebar {
      position: fixed;
      top: 0;
      left: 0;
      bottom: 0;
      width: 280px;
      max-width: 85vw;
      background: white;
      z-index: 999;
      transform: translateX(-100%);
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 2px 0 12px rgba(0, 0, 0, 0.15);
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    
    .mobile-sidebar.active {
      transform: translateX(0);
    }
    
    /* Desktop sidebar adjustments */
    @media (min-width: 768px) {
      .mobile-sidebar {
        position: fixed;
        top: 0;
        left: 0;
        height: 100vh;
        transform: translateX(0) !important;
        max-width: none;
        box-shadow: none;
      }
      
      /* Width is controlled by .sidebar.collapsed/expanded classes */
      
      .mobile-sidebar-overlay {
        display: none;
      }
    }
    
    /* Responsive card improvements */
    @media (max-width: 768px) {
      .stat-card {
        padding: 1rem;
        margin-bottom: 0.75rem;
      }
      
      .chapter-card {
        padding: 1rem;
        margin-bottom: 0.75rem;
      }
      
      .modal-content {
        width: 95%;
        padding: 1.25rem;
        margin: 10px;
      }
      
      .ranking-card {
        padding: 1rem;
        margin-bottom: 0.75rem;
      }
      
      /* Better table responsiveness */
      table {
        font-size: 0.875rem;
      }
      
      th, td {
        padding: 0.5rem !important;
      }
    }
    
    /* Touch-friendly buttons */
    button, .button {
      min-height: 44px;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
    }
    
    /* Mobile Performance Optimizations */
    @media (max-width: 768px) {
      /* Hardware acceleration for smooth scrolling */
      .mobile-sidebar, .chapter-card, .stat-card {
        will-change: transform;
        -webkit-backface-visibility: hidden;
        backface-visibility: hidden;
      }
      
      /* Reduce animations on mobile for smoother experience */
      .chapter-card {
        transition: box-shadow 0.2s ease !important;
      }
      
      .chapter-card:hover {
        transform: none !important;
      }
      
      /* Optimize scroll performance */
      body {
        -webkit-overflow-scrolling: touch;
        overflow-scrolling: touch;
      }
      
      /* Prevent layout shifts */
      img, svg {
        max-width: 100%;
        height: auto;
      }
      
      /* Faster tap response */
      a, button, input, select, textarea {
        touch-action: manipulation;
      }
    }
    
    /* Reduce motion for users who prefer it */
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }
    
    /* Better spacing for mobile */
    @media (max-width: 768px) {
      .p-6 {
        padding: 1rem !important;
      }
      
      .p-8 {
        padding: 1.5rem !important;
      }
      
      .gap-6 {
        gap: 1rem !important;
      }
      
      .space-y-6 > * + * {
        margin-top: 1rem !important;
      }
      
      /* Responsive grid adjustments */
      .grid-cols-2, .grid-cols-3, .grid-cols-4 {
        grid-template-columns: repeat(1, minmax(0, 1fr)) !important;
      }
      
      .md\:grid-cols-2, .md\:grid-cols-3 {
        grid-template-columns: repeat(1, minmax(0, 1fr)) !important;
      }
    }
    
    /* Small screens - 2 columns for some grids */
    @media (min-width: 480px) and (max-width: 768px) {
      .grid-cols-2 {
        grid-template-columns: repeat(2, minmax(0, 1fr)) !important;
      }
    }
    @keyframes confetti-fall{0%{transform:translateY(-100vh) rotate(0) scale(1);opacity:1}100%{transform:translateY(100vh) rotate(720deg) scale(.5);opacity:0}}
    @keyframes spin{to{transform:rotate(360deg)}}
    .confetti-piece{position:fixed;pointer-events:none;z-index:9999;animation:confetti-fall 4s cubic-bezier(.25,.46,.45,.94) forwards}
    .chapter-card{transition:all .3s ease;position:relative;overflow:hidden}
    .chapter-card h3{word-break:break-word;overflow-wrap:break-word}
    .break-words{word-break:break-word;overflow-wrap:break-word}
    .chapter-card:hover{transform:translateY(-4px);box-shadow:0 20px 40px -12px rgba(0,0,0,.2)}
    .chapter-card.completed{background:linear-gradient(135deg,#d1fae5,#a7f3d0);border:3px solid #10b981}
    .chapter-card.delayed{background:linear-gradient(135deg,#fed7aa,#fdba74);border:3px solid #f97316}
    .chapter-card.pending{background:linear-gradient(135deg,#fecaca,#fca5a5);border:3px solid #ef4444}
    input:focus,select:focus,textarea:focus{outline:none;box-shadow:0 0 0 4px rgba(244,180,26,.2);border-color:var(--avanti-yellow)}
    .avanti-gradient{background:linear-gradient(135deg,var(--avanti-yellow) 0%,var(--avanti-orange) 50%,var(--avanti-red) 100%) !important}
    .avanti-gradient-light{background:linear-gradient(135deg,rgba(244,180,26,.1) 0%,rgba(232,176,57,.1) 50%,rgba(200,52,46,.1) 100%)}
    .stat-card{border-radius:1rem;padding:1.5rem;box-shadow:0 4px 6px -1px rgba(0,0,0,.1);transition:all .3s}
    /* ‚úÖ FIX: Only apply white background when no gradient class is present */
    .stat-card:not(.avanti-gradient):not([class*="bg-"]):not([class*="from-"]) {
      background: white;
    }
    .stat-card:hover{transform:translateY(-4px);box-shadow:0 10px 15px -3px rgba(0,0,0,.1)}
    input[type="checkbox"]{appearance:none;width:20px;height:20px;border:2px solid var(--avanti-red);border-radius:4px;cursor:pointer;position:relative;flex-shrink:0}
    input[type="checkbox"]:checked{background:var(--avanti-red)}
    input[type="checkbox"]:checked::after{content:'‚úì';position:absolute;color:white;font-size:14px;top:50%;left:50%;transform:translate(-50%,-50%)}
    .birthday-card{background:linear-gradient(135deg,#FFD700,#FFA500);border:3px solid #FF6347;animation:pulse 2s infinite}
    @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
    
    /* Floating Celebration Card */
    .floating-celebration-card {
      position: fixed;
      top: 80px;
      right: 20px;
      width: 320px;
      max-width: calc(100vw - 40px);
      background: linear-gradient(135deg, #FF6B9D 0%, #C44B6C 50%, #8B2A4D 100%);
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 10px 40px rgba(196, 75, 108, 0.4);
      z-index: 9990;
      animation: slideInRight 0.5s ease-out, celebrationGlow 2s ease-in-out infinite;
      color: white;
    }
    .floating-celebration-card.anniversary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #6B4D9E 100%);
      box-shadow: 0 10px 40px rgba(118, 75, 162, 0.4);
    }
    @keyframes slideInRight {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    @keyframes celebrationGlow {
      0%, 100% { box-shadow: 0 10px 40px rgba(196, 75, 108, 0.4); }
      50% { box-shadow: 0 10px 50px rgba(196, 75, 108, 0.6), 0 0 60px rgba(255, 107, 157, 0.3); }
    }
    .floating-celebration-card .close-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      background: rgba(255,255,255,0.2);
      border: none;
      border-radius: 50%;
      width: 28px;
      height: 28px;
      cursor: pointer;
      color: white;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
    }
    .floating-celebration-card .close-btn:hover {
      background: rgba(255,255,255,0.3);
    }
    .floating-celebration-card .celebration-content {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .floating-celebration-card .avatar {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: rgba(255,255,255,0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      flex-shrink: 0;
      border: 3px solid rgba(255,255,255,0.3);
      overflow: hidden;
    }
    .floating-celebration-card .avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .floating-celebration-card .info h4 {
      font-size: 14px;
      font-weight: 600;
      margin: 0;
      opacity: 0.9;
    }
    .floating-celebration-card .info h3 {
      font-size: 18px;
      font-weight: 700;
      margin: 4px 0;
    }
    .floating-celebration-card .info p {
      font-size: 12px;
      margin: 0;
      opacity: 0.8;
    }
    .floating-celebration-card .confetti {
      position: absolute;
      font-size: 20px;
      animation: float 3s ease-in-out infinite;
    }
    @keyframes float {
      0%, 100% { transform: translateY(0) rotate(0deg); }
      50% { transform: translateY(-10px) rotate(10deg); }
    }
    @media (max-width: 640px) {
      .floating-celebration-card {
        top: auto;
        bottom: 80px;
        right: 10px;
        left: 10px;
        width: auto;
      }
    }
    .modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:9998}
    .modal-content{background:white;border-radius:1rem;padding:2rem;max-width:600px;width:90%;max-height:90vh;overflow-y:auto}
    .status-badge{padding:.5rem 1rem;border-radius:.5rem;font-weight:bold;text-align:center;font-size:.875rem}
    .status-ahead{background:#10b981;color:white}
    .status-ontrack{background:#3b82f6;color:white}
    .status-delayed{background:#f97316;color:white}
    .ranking-card{background:white;border-radius:1rem;padding:1.5rem;box-shadow:0 4px 6px rgba(0,0,0,.1)}
    .ranking-1{border-left:4px solid #fbbf24}
    .ranking-2{border-left:4px solid #c0c0c0}
    .ranking-3{border-left:4px solid #cd7f32}
    .chapter-details{position:relative;z-index:10;pointer-events:auto!important}
.chapter-details input,.chapter-details select,.chapter-details textarea,.chapter-details button,.chapter-details label{position:relative;z-index:20;pointer-events:auto!important;cursor:pointer}
.chapter-details input[type="checkbox"]{cursor:pointer}
.chapter-details select{cursor:pointer;background-color:white}
.chapter-details input[type="date"]{cursor:pointer;background-color:white}

/* Teacher Feedback Styles */
.star-rating {
  display: inline-flex;
  gap: 8px;
  font-size: 32px;
  cursor: pointer;
}
.star {
  color: #d1d5db;
  transition: color 0.2s;
  cursor: pointer;
}
.star.filled {
  color: #F4B41A;
}
.star:hover, .star.hover {
  color: #E8B039;
}
.feedback-modal {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.6);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10000;
  overflow-y: auto;
}
.feedback-content {
  background: white;
  border-radius: 1rem;
  max-width: 600px;
  width: 95%;
  max-height: 90vh;
  overflow-y: auto;
  margin: 20px;
}
.rating-badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 14px;
  font-weight: bold;
}
.rating-excellent {
  background: #10b981;
  color: white;
}
.rating-good {
  background: #3b82f6;
  color: white;
}
.rating-average {
  background: #f59e0b;
  color: white;
}
.rating-poor {
  background: #ef4444;
  color: white;
}
.teacher-card {
  transition: all 0.3s ease;
  cursor: pointer;
}
.teacher-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 10px 20px rgba(0,0,0,0.1);
}
.feedback-notification {
  position: fixed;
  top: 80px;
  right: 20px;
  background: linear-gradient(135deg, #F4B41A, #E8B039);
  color: white;
  padding: 16px 24px;
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  z-index: 9999;
  animation: slideIn 0.5s ease;
}
@keyframes slideIn {
  from {
    transform: translateX(400px);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

@keyframes slideOut {
  from {
    transform: translateX(0);
    opacity: 1;
  }
  to {
    transform: translateX(400px);
    opacity: 0;
  }
}

/* ========================================
   MODERN SIDEBAR STYLES - Fixed & Scrollable
   ======================================== */
.sidebar {
  position: fixed !important;
  top: 0 !important;
  left: 0 !important;
  height: 100vh !important;
  height: 100dvh !important;
  background: #1a1a2e;
  box-shadow: 4px 0 15px rgba(0,0,0,0.15);
  transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1), transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  z-index: 1000 !important;
  overflow-x: hidden;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
}

/* Custom scrollbar for sidebar */
.sidebar::-webkit-scrollbar {
  width: 6px;
}
.sidebar::-webkit-scrollbar-track {
  background: rgba(255,255,255,0.05);
}
.sidebar::-webkit-scrollbar-thumb {
  background: rgba(255,255,255,0.2);
  border-radius: 3px;
}
.sidebar::-webkit-scrollbar-thumb:hover {
  background: rgba(255,255,255,0.3);
}

.sidebar.collapsed {
  width: 72px;
}

.sidebar.expanded {
  width: 260px;
}

/* ========================================
   MOBILE FIXED HEADER WITH HAMBURGER
   ======================================== */
.mobile-fixed-header {
  display: none;
  position: fixed !important;
  top: 0 !important;
  left: 0 !important;
  right: 0 !important;
  height: 56px;
  background: #1a1a2e;
  z-index: 1001 !important;
  padding: 0 16px;
  align-items: center;
  justify-content: space-between;
  box-shadow: 0 2px 10px rgba(0,0,0,0.2);
}

@media (max-width: 768px) {
  .mobile-fixed-header {
    display: flex !important;
  }
}

.mobile-hamburger {
  width: 44px;
  height: 44px;
  background: linear-gradient(135deg, #F4B41A 0%, #E8B039 100%);
  border: none;
  border-radius: 10px;
  color: white;
  font-size: 20px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}

.mobile-header-title {
  color: white;
  font-weight: 600;
  font-size: 16px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.mobile-header-logo {
  width: 32px;
  height: 32px;
  background: linear-gradient(135deg, #F4B41A 0%, #E8B039 100%);
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px;
}

/* ========================================
   MOBILE BOTTOM NAVIGATION - Always Visible
   ======================================== */
.mobile-bottom-nav {
  display: none;
  position: fixed !important;
  bottom: 0 !important;
  left: 0 !important;
  right: 0 !important;
  height: 65px;
  background: #1a1a2e;
  z-index: 1001 !important;
  box-shadow: 0 -4px 20px rgba(0,0,0,0.3);
  padding: 0 8px;
  padding-bottom: env(safe-area-inset-bottom, 0px);
  border-top: 1px solid rgba(255,255,255,0.1);
  align-items: center;
  justify-content: space-around;
}

@media (max-width: 768px) {
  .mobile-bottom-nav {
    display: flex !important;
  }
}

.mobile-nav-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 6px 10px;
  color: rgba(255,255,255,0.5);
  cursor: pointer;
  transition: all 0.2s ease;
  border-radius: 10px;
  min-width: 55px;
  text-decoration: none;
  background: none;
  border: none;
  font-family: inherit;
}

.mobile-nav-item:hover,
.mobile-nav-item:active {
  color: rgba(255,255,255,0.8);
  background: rgba(255,255,255,0.05);
}

.mobile-nav-item.active {
  color: #F4B41A;
  background: rgba(244, 180, 26, 0.15);
}

.mobile-nav-icon {
  font-size: 1.3rem;
  margin-bottom: 2px;
}

.mobile-nav-label {
  font-size: 0.6rem;
  font-weight: 500;
  white-space: nowrap;
}

/* More menu popup */
.mobile-more-menu {
  position: fixed !important;
  bottom: 75px !important;
  right: 10px !important;
  background: #1a1a2e;
  border-radius: 16px;
  box-shadow: 0 -8px 30px rgba(0,0,0,0.4);
  padding: 12px;
  min-width: 220px;
  max-height: 60vh;
  overflow-y: auto;
  z-index: 1002 !important;
  border: 1px solid rgba(255,255,255,0.1);
  transform: translateY(20px);
  opacity: 0;
  visibility: hidden;
  transition: all 0.3s ease;
}

.mobile-more-menu.open {
  transform: translateY(0);
  opacity: 1;
  visibility: visible;
}

.mobile-more-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px 16px;
  color: rgba(255,255,255,0.8);
  cursor: pointer;
  border-radius: 10px;
  transition: all 0.2s;
  border: none;
  background: none;
  width: 100%;
  text-align: left;
  font-family: inherit;
  font-size: 14px;
}

.mobile-more-item:hover {
  background: rgba(255,255,255,0.08);
  color: white;
}

.mobile-more-item.active {
  background: rgba(244, 180, 26, 0.2);
  color: #F4B41A;
}

.mobile-more-item-icon {
  font-size: 1.1rem;
  width: 24px;
  text-align: center;
}

.mobile-more-overlay {
  position: fixed !important;
  top: 0 !important;
  left: 0 !important;
  right: 0 !important;
  bottom: 65px !important;
  background: rgba(0,0,0,0.4);
  z-index: 1001 !important;
  opacity: 0;
  visibility: hidden;
  transition: all 0.3s ease;
}

.mobile-more-overlay.open {
  opacity: 1;
  visibility: visible;
}

/* ========================================
   FLOATING TOGGLE BUTTON - HIDDEN (User Request)
   ======================================== */
.sidebar-float-toggle {
  display: none !important;
}

/* ========================================
   INSTALL APP BANNER - Top of Page
   ======================================== */
.install-app-banner {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 12px;
  padding: 10px 20px;
  background: #1a1a2e;
  color: white;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  z-index: 1005;
  box-shadow: 0 2px 10px rgba(0,0,0,0.3);
  font-size: 14px;
  font-weight: 500;
}

.install-app-banner.hidden {
  display: none !important;
}

.install-app-banner-text {
  display: flex;
  align-items: center;
  gap: 8px;
}

.install-app-banner-text i {
  font-size: 18px;
  color: #F4B41A;
}

.install-app-banner-btn {
  background: linear-gradient(135deg, #F4B41A 0%, #E8B039 100%);
  color: white;
  border: none;
  padding: 8px 16px;
  border-radius: 8px;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  gap: 6px;
}

.install-app-banner-btn:hover {
  transform: scale(1.05);
  box-shadow: 0 4px 12px rgba(244, 180, 26, 0.4);
}

.install-app-banner-close {
  background: rgba(255,255,255,0.1);
  border: none;
  color: rgba(255,255,255,0.7);
  width: 28px;
  height: 28px;
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  margin-left: 8px;
  transition: all 0.2s;
}

.install-app-banner-close:hover {
  background: rgba(255,255,255,0.2);
  color: white;
}

/* Adjust page layout when banner is visible */
body.has-install-banner .mobile-fixed-header {
  top: 44px !important;
}

body.has-install-banner .main-content {
  padding-top: 114px !important;
}

body.has-install-banner .sidebar {
  top: 44px !important;
  height: calc(100vh - 44px) !important;
  height: calc(100dvh - 44px) !important;
}

@media (max-width: 768px) {
  .install-app-banner {
    padding: 8px 12px;
    font-size: 12px;
    gap: 8px;
  }
  
  .install-app-banner-btn {
    padding: 6px 12px;
    font-size: 12px;
  }
  
  .install-app-banner-text span {
    display: none;
  }
  
  body.has-install-banner .main-content.sidebar-expanded,
  body.has-install-banner .main-content.sidebar-collapsed {
    padding-top: 114px !important;
  }
}

/* ========================================
   HOVER-TO-OPEN SIDEBAR (Desktop Only)
   ======================================== */
@media (min-width: 769px) {
  /* Hover detection zone */
  .sidebar-hover-zone {
    position: fixed;
    top: 0;
    left: 0;
    width: 20px;
    height: 100vh;
    z-index: 999;
    background: transparent;
  }
  
  /* When sidebar is collapsed, expand on hover */
  .sidebar.collapsed.hovering {
    width: 260px !important;
  }
  
  .sidebar.collapsed.hovering .sidebar-label {
    opacity: 1 !important;
    width: auto !important;
    display: inline !important;
  }
  
  .sidebar.collapsed.hovering .sidebar-logo-text {
    opacity: 1 !important;
    width: auto !important;
  }
  
  .sidebar.collapsed.hovering .sidebar-item {
    justify-content: flex-start !important;
    padding: 0.75rem 1rem !important;
  }
  
  .sidebar.collapsed.hovering .sidebar-item.active::before {
    display: block !important;
  }
  
  .sidebar.collapsed.hovering .sidebar-logout span {
    display: inline !important;
  }
  
  .sidebar.collapsed.hovering .theme-toggle-container {
    display: flex !important;
  }
  
  /* Hide collapsed dark mode toggle when hovering */
  .sidebar.collapsed.hovering > .sidebar-footer > .sidebar-item[data-tooltip] {
    display: none !important;
  }
}

.sidebar-header {
  padding: 1.25rem;
  border-bottom: 1px solid rgba(255,255,255,0.08);
  display: flex;
  align-items: center;
  justify-content: space-between;
  min-height: 70px;
  background: rgba(244, 180, 26, 0.1);
  position: sticky;
  top: 0;
  z-index: 10;
}

.sidebar-logo {
  display: flex;
  align-items: center;
  gap: 12px;
}

.sidebar-logo-icon {
  width: 40px;
  height: 40px;
  background: linear-gradient(135deg, #F4B41A 0%, #E8B039 100%);
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
  flex-shrink: 0;
}

.sidebar-logo-text {
  color: white;
  font-weight: 700;
  font-size: 1rem;
  white-space: nowrap;
  overflow: hidden;
  transition: opacity 0.2s, width 0.2s;
}

.sidebar.collapsed .sidebar-logo-text {
  opacity: 0;
  width: 0;
}

.sidebar-toggle {
  background: rgba(255,255,255,0.08);
  border: none;
  color: rgba(255,255,255,0.7);
  width: 32px;
  height: 32px;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  flex-shrink: 0;
}

.sidebar-toggle:hover {
  background: rgba(244, 180, 26, 0.3);
  color: #F4B41A;
}

.sidebar-nav {
  padding: 1rem 0.75rem;
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.sidebar-item {
  display: flex;
  align-items: center;
  padding: 0.75rem 1rem;
  color: rgba(255,255,255,0.65);
  cursor: pointer;
  transition: all 0.2s ease;
  border-radius: 10px;
  gap: 12px;
  text-decoration: none;
  position: relative;
  margin: 0 4px;
}

.sidebar-item:hover {
  background: rgba(255,255,255,0.06);
  color: rgba(255,255,255,0.9);
}

.sidebar-item.active {
  background: linear-gradient(135deg, rgba(244, 180, 26, 0.2) 0%, rgba(232, 176, 57, 0.15) 100%);
  color: #F4B41A;
  font-weight: 600;
}

.sidebar-item.active::before {
  content: '';
  position: absolute;
  left: 0;
  top: 50%;
  transform: translateY(-50%);
  width: 3px;
  height: 60%;
  background: #F4B41A;
  border-radius: 0 3px 3px 0;
}

.sidebar-icon {
  font-size: 1.2rem;
  min-width: 24px;
  text-align: center;
  transition: transform 0.2s;
}

.sidebar-item:hover .sidebar-icon {
  transform: scale(1.1);
}

.sidebar-label {
  white-space: nowrap;
  overflow: hidden;
  font-size: 0.9rem;
  transition: opacity 0.2s, width 0.2s;
}

.sidebar.collapsed .sidebar-label {
  opacity: 0;
  width: 0;
  display: none;
}

.sidebar.collapsed .sidebar-item {
  justify-content: center;
  padding: 0.85rem;
}

.sidebar.collapsed .sidebar-item.active::before {
  display: none;
}

/* Sidebar footer */
.sidebar-footer {
  padding: 1rem;
  border-top: 1px solid rgba(255,255,255,0.08);
  margin-top: auto;
}

.sidebar-logout {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  width: 100%;
  padding: 0.75rem 1rem;
  background: rgba(239, 68, 68, 0.15);
  color: #f87171;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  font-size: 0.9rem;
  font-weight: 500;
  transition: all 0.2s;
}

.sidebar-logout:hover {
  background: rgba(239, 68, 68, 0.25);
  color: #fca5a5;
}

.sidebar.collapsed .sidebar-logout span {
  display: none;
}

/* Mobile hamburger */
.mobile-header {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  height: 60px;
  background: #1a1a2e;
  z-index: 999;
  padding: 0 1rem;
  align-items: center;
  justify-content: space-between;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.hamburger-btn {
  background: none;
  border: none;
  color: white;
  font-size: 1.5rem;
  cursor: pointer;
  padding: 8px;
  border-radius: 8px;
  transition: background 0.2s;
}

.hamburger-btn:hover {
  background: rgba(255,255,255,0.1);
}

.mobile-logo {
  display: flex;
  align-items: center;
  gap: 10px;
  color: white;
  font-weight: 600;
}

/* Main content adjustments */
.main-content {
  min-height: 100vh;
  background: #f8fafc;
  transition: margin-left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.main-content.sidebar-expanded {
  margin-left: 260px;
}

.main-content.sidebar-collapsed {
  margin-left: 72px;
}

/* Mobile responsive */
@media (max-width: 768px) {
  .mobile-header {
    display: none; /* Hide old mobile header */
  }
  
  .sidebar {
    transform: translateX(-100%);
    width: 280px !important;
  }
  
  .sidebar.mobile-open {
    transform: translateX(0) !important;
  }
  
  .sidebar-toggle {
    display: none;
  }
  
  .main-content.sidebar-expanded,
  .main-content.sidebar-collapsed {
    margin-left: 0 !important;
    padding-top: 70px; /* Space for mobile header */
    padding-bottom: 20px;
    width: 100%;
  }
  
  .mobile-sidebar-overlay.active {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    z-index: 998;
  }
}

/* Tooltip for collapsed sidebar */
.sidebar.collapsed .sidebar-item {
  position: relative;
}

.sidebar.collapsed .sidebar-item::after {
  content: attr(data-tooltip);
  position: absolute;
  left: 100%;
  top: 50%;
  transform: translateY(-50%);
  background: #1a1a2e;
  color: white;
  padding: 6px 12px;
  border-radius: 6px;
  font-size: 0.85rem;
  white-space: nowrap;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.2s, left 0.2s;
  margin-left: 10px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  z-index: 1001;
}

.sidebar.collapsed .sidebar-item:hover::after {
  opacity: 1;
  left: calc(100% + 5px);
}

/* Scrollbar styling for sidebar */
.sidebar::-webkit-scrollbar {
  width: 6px;
}

.sidebar::-webkit-scrollbar-track {
  background: rgba(255,255,255,0.1);
}

.sidebar::-webkit-scrollbar-thumb {
  background: rgba(255,255,255,0.3);
  border-radius: 3px;
}

.sidebar::-webkit-scrollbar-thumb:hover {
  background: rgba(255,255,255,0.5);
}

/* ========================================
   ASSET MANAGEMENT STYLES
   ======================================== */
.barcode-scanner-container {
  position: relative;
  width: 100%;
  max-width: 400px;
  margin: 0 auto;
}

#barcode-reader {
  width: 100%;
  border-radius: 12px;
  overflow: hidden;
}

#barcode-reader video {
  border-radius: 12px;
}

.asset-card {
  background: white;
  border-radius: 1rem;
  padding: 1.5rem;
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
  transition: all 0.3s ease;
  border-left: 4px solid #F4B41A;
}

.asset-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 10px 20px rgba(0,0,0,0.1);
}

.asset-card.book {
  border-left-color: #3B82F6;
}

.asset-card.chromebook {
  border-left-color: #10B981;
}

.asset-card.overdue {
  border-left-color: #EF4444;
  background: #FEF2F2;
}

.asset-badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 600;
}

.badge-available {
  background: #D1FAE5;
  color: #059669;
}

.badge-assigned {
  background: #FEF3C7;
  color: #D97706;
}

.badge-overdue {
  background: #FEE2E2;
  color: #DC2626;
}

.badge-returned {
  background: #E0E7FF;
  color: #4F46E5;
}

.request-card {
  background: white;
  border-radius: 1rem;
  padding: 1.5rem;
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
  border-left: 4px solid #F59E0B;
}

.request-card.pending {
  border-left-color: #F59E0B;
}

.request-card.approved {
  border-left-color: #10B981;
}

.request-card.rejected {
  border-left-color: #EF4444;
}

@media (max-width: 768px) {
  .barcode-scanner-container {
    max-width: 100%;
  }
}

/* ========================================
   ONLINE STATUS CARD STYLES
   ======================================== */
.online-status-card {
  position: fixed;
  top: 80px;
  right: 20px;
  background: linear-gradient(135deg, #1a1a24 0%, #12121a 100%);
  border: 1px solid #2a2a3a;
  border-radius: 16px;
  padding: 12px 16px;
  min-width: 180px;
  z-index: 9990;
  box-shadow: 0 8px 24px rgba(0,0,0,0.4);
  animation: slideInRight 0.3s ease;
}

@keyframes slideInRight {
  from { transform: translateX(100%); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}

.online-status-card .close-btn {
  position: absolute;
  top: 8px;
  right: 8px;
  background: none;
  border: none;
  color: #666;
  cursor: pointer;
  font-size: 14px;
  padding: 2px 6px;
  border-radius: 4px;
  transition: all 0.2s;
}

.online-status-card .close-btn:hover {
  background: #2a2a3a;
  color: #fff;
}

.online-status-card .status-row {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 8px;
}

.online-status-card .status-dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  animation: pulse 2s infinite;
}

.online-status-card .status-dot.online {
  background: #10b981;
  box-shadow: 0 0 8px #10b981;
}

.online-status-card .status-dot.offline {
  background: #6b7280;
  animation: none;
}

/* ========================================
   REACTION TOOLTIP STYLES
   ======================================== */
.reaction-btn-wrapper {
  position: relative;
  display: inline-block;
}

.reaction-tooltip {
  position: absolute;
  bottom: 100%;
  left: 50%;
  transform: translateX(-50%);
  background: #1a1a24;
  color: white;
  padding: 8px 12px;
  border-radius: 8px;
  font-size: 12px;
  white-space: nowrap;
  max-width: 200px;
  overflow: hidden;
  text-overflow: ellipsis;
  z-index: 1000;
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.2s, visibility 0.2s;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  pointer-events: none;
}

.reaction-tooltip::after {
  content: '';
  position: absolute;
  top: 100%;
  left: 50%;
  transform: translateX(-50%);
  border: 6px solid transparent;
  border-top-color: #1a1a24;
}

.reaction-btn-wrapper:hover .reaction-tooltip {
  opacity: 1;
  visibility: visible;
}

/* ========================================
   @MENTION STYLES
   ======================================== */
.mention-input-container {
  position: relative;
}

.mention-dropdown {
  position: absolute;
  bottom: 100%;
  left: 0;
  right: 0;
  max-height: 200px;
  overflow-y: auto;
  background: white;
  border: 1px solid #e5e7eb;
  border-radius: 12px;
  box-shadow: 0 -4px 16px rgba(0,0,0,0.1);
  z-index: 100;
  margin-bottom: 4px;
}

.mention-dropdown-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 14px;
  cursor: pointer;
  border-bottom: 1px solid #f3f4f6;
  transition: background 0.2s;
}

.mention-dropdown-item:last-child {
  border-bottom: none;
}

.mention-dropdown-item:hover {
  background: #f3e8ff;
}

.mention-dropdown-item.highlighted {
  background: #ede9fe;
}

.mention-dropdown-item .avatar {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: linear-gradient(135deg, #ec4899, #8b5cf6);
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-weight: bold;
  font-size: 12px;
}

.mention-tag {
  background: linear-gradient(135deg, #ede9fe, #fce7f3);
  color: #7c3aed;
  padding: 2px 6px;
  border-radius: 4px;
  font-weight: 600;
}

.mention-everyone {
  background: linear-gradient(135deg, #fee2e2, #fef3c7);
  color: #dc2626;
}

/* Last Active Badge */
.last-active-badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  font-size: 10px;
  color: #6b7280;
  padding: 2px 6px;
  background: #f3f4f6;
  border-radius: 10px;
}

.last-active-badge.online {
  background: #d1fae5;
  color: #059669;
}

/* Notification sound indicator */
@keyframes bellRing {
  0%, 100% { transform: rotate(0); }
  25% { transform: rotate(10deg); }
  50% { transform: rotate(-10deg); }
  75% { transform: rotate(5deg); }
}

.bell-ringing {
  animation: bellRing 0.5s ease-in-out;
}

/* Comment reaction buttons - smaller size */
.comment-reactions .reaction-btn-wrapper .emoji-btn {
  padding: 2px 6px;
  font-size: 12px;
  background: transparent;
  min-height: auto;
}

.comment-reactions .reaction-btn-wrapper .emoji-btn:hover {
  background: #f3e8ff;
}

.comment-reactions .reaction-btn-wrapper .emoji-btn.active {
  background: #ede9fe;
}

.comment-reactions .reaction-tooltip {
  font-size: 10px;
  padding: 4px 8px;
}

/* ========================================
   HIDDEN EMOJI REACTIONS - Show on hover/tap
   ======================================== */
.comment-emoji-container {
  display: flex;
  align-items: center;
  gap: 2px;
}

/* Hide emoji buttons by default - only show counts if any */
.comment-emoji-container .emoji-btn:not(.has-reactions) {
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.2s, visibility 0.2s;
}

/* Show on hover (desktop) */
.comment-wrapper:hover .comment-emoji-container .emoji-btn {
  opacity: 1;
  visibility: visible;
}

/* Touch device: show emoji picker button instead */
.comment-emoji-toggle {
  display: none;
  padding: 2px 8px;
  font-size: 14px;
  background: transparent;
  border: none;
  cursor: pointer;
  border-radius: 12px;
  min-height: auto;
}

.comment-emoji-toggle:hover {
  background: #f3e8ff;
}

/* Always show toggle on mobile */
@media (hover: none) {
  .comment-emoji-container .emoji-btn:not(.has-reactions) {
    display: none;
  }
  
  .comment-emoji-toggle {
    display: inline-flex;
  }
  
  .comment-emoji-container.emoji-picker-open .emoji-btn {
    display: inline-flex;
    opacity: 1;
    visibility: visible;
  }
}

/* ========================================
   REDDIT-STYLE THREADED COMMENTS
   ======================================== */
.reddit-comment-thread {
  position: relative;
  margin-left: 0;
}

.reddit-comment {
  position: relative;
  display: flex;
  gap: 8px;
}

.reddit-comment-thread .reddit-comment {
  margin-left: 32px;
  padding-left: 16px;
}

/* Vertical connecting line */
.reddit-comment-thread::before {
  content: '';
  position: absolute;
  left: 14px;
  top: 0;
  bottom: 16px;
  width: 2px;
  background: #e5e7eb;
  border-radius: 1px;
}

/* Collapse button */
.reddit-collapse-btn {
  position: absolute;
  left: 6px;
  top: 0;
  width: 18px;
  height: 18px;
  border-radius: 50%;
  border: 2px solid #d1d5db;
  background: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 10px;
  cursor: pointer;
  z-index: 5;
  color: #6b7280;
  transition: all 0.2s;
  min-height: auto;
  padding: 0;
}

.reddit-collapse-btn:hover {
  border-color: #9333ea;
  color: #9333ea;
  background: #faf5ff;
}

/* Collapsed thread */
.reddit-comment-thread.collapsed > .reddit-comment:not(:first-child) {
  display: none;
}

.reddit-comment-thread.collapsed::before {
  display: none;
}

/* Reply input */
.reddit-reply-input {
  margin-left: 48px;
  margin-top: 8px;
  padding: 8px 12px;
  background: #f9fafb;
  border-radius: 12px;
  border: 1px solid #e5e7eb;
}

/* ‚úÖ IMPROVED: Reddit-style action button row */
.reddit-action-row {
  display: flex;
  align-items: center;
  gap: 4px;
  margin-top: 4px;
  margin-left: 2px;
}

.reddit-reply-btn {
  font-size: 12px;
  font-weight: 600;
  color: #878a8c;
  background: transparent;
  border: none;
  cursor: pointer;
  padding: 4px 8px;
  border-radius: 4px;
  min-height: auto;
  display: inline-flex;
  align-items: center;
  gap: 4px;
  transition: all 0.15s ease;
}

.reddit-reply-btn:hover {
  background: #f0f0f0;
  color: #1a1a1b;
}

.reddit-reply-btn:active {
  transform: scale(0.98);
}

/* Reddit-style vote/action buttons */
.reddit-action-btn {
  font-size: 12px;
  font-weight: 600;
  color: #878a8c;
  background: transparent;
  border: none;
  cursor: pointer;
  padding: 4px 8px;
  border-radius: 4px;
  min-height: auto;
  display: inline-flex;
  align-items: center;
  gap: 4px;
  transition: all 0.15s ease;
}

.reddit-action-btn:hover {
  background: #f0f0f0;
  color: #1a1a1b;
}

.reddit-action-btn.active {
  color: #ff4500;
}

.reddit-action-btn .icon {
  font-size: 14px;
}

/* Reddit-style separator dot */
.reddit-separator {
  color: #d1d5db;
  font-size: 3px;
  margin: 0 2px;
}

/* Reddit timestamp styling */
.reddit-timestamp {
  font-size: 12px;
  color: #787c7e;
}

/* Reddit author styling */
.reddit-author {
  font-size: 12px;
  font-weight: 600;
  color: #1c1c1c;
}

.reddit-author:hover {
  text-decoration: underline;
  cursor: pointer;
}

/* Reddit comment body */
.reddit-comment-body {
  font-size: 14px;
  line-height: 1.5;
  color: #1c1c1c;
  word-break: break-word;
}

/* Reddit reactions */
.reddit-reactions {
  display: inline-flex;
  align-items: center;
  gap: 2px;
  padding: 2px 6px;
  background: #f6f7f8;
  border-radius: 12px;
  margin-left: 4px;
}

.reddit-reactions .emoji-btn {
  font-size: 14px;
  padding: 2px 4px;
  border-radius: 4px;
  min-height: auto;
  border: none;
  background: transparent;
  cursor: pointer;
  transition: transform 0.1s;
}

.reddit-reactions .emoji-btn:hover {
  transform: scale(1.2);
  background: #e8e9ea;
}

.reddit-reactions .emoji-btn.active {
  background: #ffe4d4;
}

/* Mobile responsive */
@media (max-width: 640px) {
  .reddit-reply-btn, .reddit-action-btn {
    padding: 6px 10px;
    font-size: 11px;
  }
  
  .reddit-action-row {
    flex-wrap: wrap;
    gap: 2px;
  }
}
    /* ========================================
   PWA ENHANCEMENT STYLES - Added for offline support
   ======================================== */

/* Network Status Indicator */
.pwa-network-status {
  position: fixed;
  top: 10px;
  right: 70px;
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 6px 14px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 600;
  z-index: 9998;
  transition: all 0.3s ease;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.pwa-network-status.online {
  background: rgba(34, 197, 94, 0.15);
  color: #16a34a;
  border: 1px solid rgba(34, 197, 94, 0.3);
}

.pwa-network-status.offline {
  background: rgba(239, 68, 68, 0.15);
  color: #dc2626;
  border: 1px solid rgba(239, 68, 68, 0.3);
  animation: pwa-pulse 2s infinite;
}

.pwa-network-status .status-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
}

.pwa-network-status.online .status-dot { background: #22c55e; }
.pwa-network-status.offline .status-dot { background: #ef4444; animation: pwa-blink 1s infinite; }

@keyframes pwa-pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
@keyframes pwa-blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }

/* Pending Sync Badge */
.pwa-pending-badge {
  position: fixed;
  bottom: 80px;
  right: 20px;
  display: none;
  align-items: center;
  gap: 8px;
  padding: 10px 16px;
  background: linear-gradient(135deg, #f59e0b, #d97706);
  color: white;
  border-radius: 12px;
  font-size: 13px;
  font-weight: 600;
  z-index: 9997;
  box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4);
}

.pwa-pending-badge.show { display: flex; }
.pwa-pending-badge i { animation: pwa-spin 2s linear infinite; }

@keyframes pwa-spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

/* PWA Toast */
.pwa-toast {
  position: fixed;
  bottom: 100px;
  left: 50%;
  transform: translateX(-50%);
  padding: 14px 24px;
  border-radius: 12px;
  color: white;
  font-size: 14px;
  font-weight: 500;
  z-index: 99999;
  box-shadow: 0 4px 20px rgba(0,0,0,0.25);
  animation: pwa-toastIn 0.3s ease;
  max-width: 90%;
  text-align: center;
  transition: all 0.3s ease;
}

.pwa-toast.success { background: linear-gradient(135deg, #10b981, #059669); }
.pwa-toast.warning { background: linear-gradient(135deg, #f59e0b, #d97706); }
.pwa-toast.error { background: linear-gradient(135deg, #ef4444, #dc2626); }
.pwa-toast.info { background: linear-gradient(135deg, #3b82f6, #2563eb); }

@keyframes pwa-toastIn { from { transform: translateX(-50%) translateY(30px); opacity: 0; } to { transform: translateX(-50%) translateY(0); opacity: 1; } }

@media (max-width: 768px) {
  .pwa-network-status { top: auto; bottom: 70px; right: 10px; padding: 5px 10px; font-size: 11px; }
  .pwa-pending-badge { bottom: 120px; right: 10px; }
}
  </style>
</head>
<body>
  <!-- ‚úÖ PERFORMANCE FIX: Instant loading screen - shows before ANY JavaScript loads -->
  <!-- This dramatically improves First Contentful Paint (FCP) -->
  <div id="instant-loader" class="instant-loader">
    <div class="instant-loader-logo">üìö</div>
    <div class="instant-loader-text">Curriculum Tracker</div>
    <div class="instant-loader-sub">Avanti Fellows</div>
    <div class="loader-dots">
      <div class="loader-dot"></div>
      <div class="loader-dot"></div>
      <div class="loader-dot"></div>
    </div>
    <!-- ‚úÖ NEW: Slow connection message for iOS/low connectivity -->
    <div class="loader-timeout-msg">
      Loading is taking longer than usual.<br/>
      This may be due to slow network.
      <br/>
      <button class="retry-btn" onclick="location.reload()">‚Üª Tap to Retry</button>
    </div>
  </div>
  
  <div id="root"></div>
  <!-- PWA Network Status Indicator -->
<div id="pwa-network-status" class="pwa-network-status online">
  <span class="status-dot"></span>
  <span class="status-text">Online</span>
</div>

<!-- PWA Pending Sync Badge -->
<div id="pwa-pending-badge" class="pwa-pending-badge">
  <i class="fa-solid fa-sync"></i>
  <span id="pwa-pending-count">0</span> items pending sync
</div>
  
  <script>
  // ‚úÖ PERFORMANCE FIX: Hide instant loader once React app renders
  window.hideInstantLoader = function() {
    // ‚úÖ iOS FIX: Clear timeout handlers
    if (window._loaderTimeoutId) clearTimeout(window._loaderTimeoutId);
    if (window._forceHideTimeout) clearTimeout(window._forceHideTimeout);
    
    const loader = document.getElementById('instant-loader');
    if (loader) {
      loader.style.transition = 'opacity 0.3s ease';
      loader.style.opacity = '0';
      setTimeout(() => {
        if (loader && loader.parentNode) {
          loader.parentNode.removeChild(loader);
        }
      }, 300);
    }
  };
  </script>
  
  <script>
  // Register Chart.js datalabels plugin safely
if (typeof ChartDataLabels !== 'undefined' && typeof Chart !== 'undefined') {
  try {
    Chart.register(ChartDataLabels);
    
    if (Chart.defaults && Chart.defaults.plugins) {
      Chart.defaults.plugins.datalabels = {
        anchor: 'center',
        align: 'center',
        offset: 0,
        formatter: (value, ctx) => {
          const type = ctx.chart.config.type;
          if (type === 'pie' || type === 'doughnut') {
            // Show the actual number inside the slice
            return value > 0 ? value : '';
          }
          return value;
        },
        color: '#fff',
        font: { weight: '700', size: 14 },
        textShadow: true
      };
    }
  } catch (e) {
    console.warn('ChartDataLabels plugin registration failed:', e);
  }
}

// Optional overrides per chart type
if (typeof Chart !== 'undefined' && Chart.overrides) {
  Chart.overrides.bar = Chart.overrides.bar || {};
  Chart.overrides.bar.plugins = Chart.overrides.bar.plugins || {};
  Chart.overrides.bar.plugins.datalabels = {
    color: '#374151',
    font: { weight: '700', size: 12 },
    align: 'end',
    anchor: 'end'
  };

  Chart.overrides.pie = Chart.overrides.pie || {};
  Chart.overrides.pie.plugins = Chart.overrides.pie.plugins || {};
  Chart.overrides.pie.plugins.datalabels = {
    color: '#fff',
    font: { weight: '700', size: 14 },
    textStrokeColor: 'rgba(0,0,0,0.3)',
    textStrokeWidth: 2
  };
  
  Chart.overrides.doughnut = Chart.overrides.doughnut || {};
  Chart.overrides.doughnut.plugins = Chart.overrides.doughnut.plugins || {};
  Chart.overrides.doughnut.plugins.datalabels = {
    color: '#fff',
    font: { weight: '700', size: 14 }
  };
}

// ‚úÖ Define consistent chart color palette (muted teal/gray like sample)
const CHART_COLORS = {
  // Primary palette - muted teal/slate tones
  primary: ['#5B8A8A', '#7BA3A3', '#3D6B6B', '#9CBFBF', '#2D5454', '#B5D4D4'],
  // For completion/status charts
  status: {
    completed: '#5B8A8A',
    pending: '#D4A574',
    delayed: '#C17A6E'
  },
  // For subject charts
  subjects: {
    physics: '#D4A574',
    chemistry: '#5B8A8A',
    maths: '#7BA3A3',
    biology: '#C17A6E'
  },
  // General purpose
  general: ['#5B8A8A', '#D4A574', '#7BA3A3', '#C17A6E', '#3D6B6B', '#9CBFBF']
};
</script>
  <script type="text/babel">
const {useState,useEffect,useRef,useCallback,useMemo}=React;
    const firestoreCache = new Map();

async function cachedQuery(key, queryFn, ttl = 120000) {
  if (firestoreCache.has(key)) return firestoreCache.get(key);
  const data = await queryFn();
  firestoreCache.set(key, data);
  setTimeout(() => firestoreCache.delete(key), ttl);
  return data;
}

// ========================================
// DEBOUNCE UTILITY - Prevents page refresh while typing
// ========================================
const useDebounce = (value, delay = 300) => {
  const [debouncedValue, setDebouncedValue] = useState(value);
  
  useEffect(() => {
    const timer = setTimeout(() => {
      setDebouncedValue(value);
    }, delay);
    
    return () => clearTimeout(timer);
  }, [value, delay]);
  
  return debouncedValue;
};

// Debounced state hook - prevents excessive re-renders while typing
const useDebouncedState = (initialValue, delay = 300) => {
  const [value, setValue] = useState(initialValue);
  const [debouncedValue, setDebouncedValue] = useState(initialValue);
  const timeoutRef = useRef(null);
  
  const setValueDebounced = useCallback((newValue) => {
    setValue(newValue);
    
    if (timeoutRef.current) {
      clearTimeout(timeoutRef.current);
    }
    
    timeoutRef.current = setTimeout(() => {
      setDebouncedValue(newValue);
    }, delay);
  }, [delay]);
  
  useEffect(() => {
    return () => {
      if (timeoutRef.current) {
        clearTimeout(timeoutRef.current);
      }
    };
  }, []);
  
  return [value, setValueDebounced, debouncedValue];
};
const firebaseConfig={apiKey:"AIzaSyDyyGAHNJvhuint86USW36eBJKfw_u3AcA",authDomain:"curriculum-dbb10.firebaseapp.com",projectId:"curriculum-dbb10",storageBucket:"curriculum-dbb10.firebasestorage.app",messagingSenderId:"706387632109",appId:"1:706387632109:web:06c78a304fdbdc12f391e4"};

// ‚úÖ FIX: Safer Firebase initialization with error handling
let firebaseInitialized = false;
try {
  if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
  }
  firebaseInitialized = true;
} catch (e) {
  console.error('Firebase initialization error:', e);
  // Retry initialization
  try {
    firebase.initializeApp(firebaseConfig);
    firebaseInitialized = true;
  } catch (retryError) {
    console.error('Firebase retry failed:', retryError);
  }
}

// ‚úÖ FIX: Helper to safely get Firestore instance
const getFirestore = () => {
  if (!firebaseInitialized || !firebase.apps.length) {
    console.warn('Firebase not initialized, attempting to initialize...');
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
  }
  return firebase.firestore();
};

const db = getFirestore();

// ‚úÖ COST FIX: Enable offline persistence - reduces Firebase reads by caching locally
if (window._enableOfflinePersistence) {
  window._enableOfflinePersistence(db);
}

// ========================================
// ‚úÖ FIX: FIREBASE TIMEOUT HELPER
// Prevents infinite loading on slow networks (JNV remote areas)
// ========================================
const firebaseWithTimeout = async (promise, timeoutMs = 15000, fallback = null) => {
  let timeoutId;
  const timeoutPromise = new Promise((_, reject) => {
    timeoutId = setTimeout(() => {
      reject(new Error('Firebase operation timed out after ' + timeoutMs + 'ms'));
    }, timeoutMs);
  });
  
  try {
    const result = await Promise.race([promise, timeoutPromise]);
    clearTimeout(timeoutId);
    return result;
  } catch (error) {
    clearTimeout(timeoutId);
    console.warn('[Timeout] Firebase operation failed:', error.message);
    return fallback;
  }
};
// ======================================== END TIMEOUT HELPER
const auth=firebase.auth();
const SUBJECTS=['Physics','Chemistry','Maths','Biology'];

// ========================================
// PRESENCE SYSTEM - Track Online/Offline Status
// ========================================
const PresenceSystem = {
  userId: null,
  userName: null,
  presenceRef: null,
  heartbeatInterval: null,
  onlineUsers: {},
  allPresence: {}, // Store all presence data (including offline)
  listeners: [],
  initialized: false,
  OFFLINE_TIMEOUT: 60000, // 60 seconds - mark offline if no heartbeat
  
  init: function(userId, userName) {
    if (!userId || this.initialized) return;
    this.userId = String(userId);
    this.userName = userName || '';
    this.initialized = true;
    
    console.log('[Presence] Initializing for:', this.userId, this.userName);
    
    this.updatePresence('online');
    
    // Heartbeat every 30 seconds
    // Update presence only once on load
this.updatePresence('online');
    
    // Handle tab visibility
    document.addEventListener('visibilitychange', () => {
      this.updatePresence(document.hidden ? 'away' : 'online');
    });
    
    // Handle page unload - try to mark offline
    window.addEventListener('beforeunload', () => {
      this.updatePresence('offline');
    });
    
    // Handle page hide (more reliable on mobile)
    window.addEventListener('pagehide', () => {
      this.updatePresence('offline');
    });
    
    // Handle when page loses focus (additional safety)
    document.addEventListener('freeze', () => {
      this.updatePresence('offline');
    });
    
    // Listen for ALL presence changes (not just online)
    this.listenToPresence();
  },
  
  updatePresence: async function(status) {
    if (!this.userId || typeof firebase === 'undefined') return;
    try {
      const docId = this.userId.replace(/[^a-zA-Z0-9]/g, '_'); // Sanitize for Firestore doc ID
      await db.collection('user_presence').doc(docId).set({
        status: status,
        lastSeen: firebase.firestore.FieldValue.serverTimestamp(),
        userId: this.userId,
        userName: this.userName,
        updatedAt: new Date().toISOString(),
        heartbeatAt: Date.now() // Client timestamp for quick offline check
      }, { merge: true });
      console.log('[Presence] Updated:', status);
    } catch (e) {
      console.log('[Presence] Update error:', e);
    }
  },
  
  // ‚úÖ FIX: Optimized presence - fetch ALL presence data for last seen feature
  listenToPresence: function() {
    const fetchPresence = async () => {
      try {
        // ‚úÖ FIX: Fetch ALL presence data (not just online users) for "last seen" feature
        const snap = await db.collection('user_presence')
          .orderBy('lastSeen', 'desc')
          .limit(200) // Get more users for directory "last seen"
          .get();
          
        const online = {};
        const all = {};
        const now = Date.now();
        
        snap.docs.forEach(doc => {
          const data = doc.data();
          const heartbeatAt = data.heartbeatAt || 0;
          const timeSinceHeartbeat = now - heartbeatAt;
          
          let effectiveStatus = data.status;
          if (effectiveStatus === 'online' || effectiveStatus === 'away') {
            if (timeSinceHeartbeat > this.OFFLINE_TIMEOUT) {
              effectiveStatus = 'offline';
            }
          }
          
          // Store presence data with multiple keys for flexible lookup
          const presenceData = { ...data, status: effectiveStatus, originalStatus: data.status };
          all[doc.id] = presenceData;
          if (data.userId) all[data.userId] = presenceData;
          if (data.userName) all[data.userName.toLowerCase()] = presenceData;
          // Also store by email for matching
          if (data.email) all[data.email.toLowerCase()] = presenceData;
          
          if (effectiveStatus === 'online' || effectiveStatus === 'away') {
            online[doc.id] = presenceData;
          }
        });
        
        this.onlineUsers = online;
        this.allPresence = all;
        this.notifyListeners();
        console.log('[Presence] Loaded', Object.keys(all).length, 'presence records');
      } catch (err) {
        console.log('[Presence] Fetch error:', err);
      }
    };
    
    // Initial fetch
    fetchPresence();
    
    // ‚úÖ COST FIX: Refresh every 10 minutes instead of 3 minutes (saves ~‚Çπ3,000/month)
    this.presenceInterval = setInterval(fetchPresence, 600000);
  },
  
  getOnlineCount: function() {
    return Object.keys(this.onlineUsers).length;
  },
  
  // Flexible lookup for presence data
  findPresence: function(userId) {
    if (!userId) return null;
    
    const searchKey = String(userId).toLowerCase();
    const sanitizedKey = searchKey.replace(/[^a-zA-Z0-9]/g, '_');
    
    // Try direct matches first
    if (this.allPresence[userId]) return this.allPresence[userId];
    if (this.allPresence[sanitizedKey]) return this.allPresence[sanitizedKey];
    if (this.allPresence[searchKey]) return this.allPresence[searchKey];
    
    // Try to find by partial match or email
    for (const [key, data] of Object.entries(this.allPresence)) {
      // Match by userId
      if (data.userId && String(data.userId).toLowerCase() === searchKey) return data;
      // Match by userName
      if (data.userName && String(data.userName).toLowerCase() === searchKey) return data;
      // Match by email
      if (data.email && String(data.email).toLowerCase() === searchKey) return data;
      // Partial match on key
      if (key.toLowerCase() === searchKey) return data;
      // Match if userId contains the search key
      if (data.userId && String(data.userId).toLowerCase().includes(searchKey)) return data;
    }
    
    return null;
  },
  
  isOnline: function(userId) {
    const presence = this.findPresence(userId);
    if (!presence) return false;
    
    // Check heartbeat timeout
    const now = Date.now();
    const heartbeatAt = presence.heartbeatAt || 0;
    const timeSinceHeartbeat = now - heartbeatAt;
    
    // If heartbeat is stale (>60s), consider offline
    if (timeSinceHeartbeat > this.OFFLINE_TIMEOUT) {
      return false;
    }
    
    return presence?.status === 'online' || presence?.status === 'away';
  },
  
  getLastSeen: function(userId) {
    const presence = this.findPresence(userId);
    if (!presence?.lastSeen) return null;
    
    try {
      const lastSeen = presence.lastSeen.toDate ? presence.lastSeen.toDate() : new Date(presence.lastSeen);
      return lastSeen;
    } catch (e) {
      // Try parsing updatedAt as fallback
      if (presence.updatedAt) {
        return new Date(presence.updatedAt);
      }
      return null;
    }
  },
  
  formatLastSeen: function(userId) {
    const lastSeen = this.getLastSeen(userId);
    if (!lastSeen) return 'Never';
    
    const now = new Date();
    const diff = Math.floor((now - lastSeen) / 1000);
    
    if (diff < 60) return 'Just now';
    if (diff < 3600) return Math.floor(diff / 60) + 'm ago';
    if (diff < 86400) return Math.floor(diff / 3600) + 'h ago';
    return Math.floor(diff / 86400) + 'd ago';
  },
  
  subscribe: function(callback) {
    this.listeners.push(callback);
    return () => {
      this.listeners = this.listeners.filter(l => l !== callback);
    };
  },
  
  notifyListeners: function() {
    this.listeners.forEach(callback => callback(this.onlineUsers));
  },
  
  cleanup: function() {
    if (this.heartbeatInterval) {
      clearInterval(this.heartbeatInterval);
    }
    // ‚úÖ FIX: Clear presence polling interval
    if (this.presenceInterval) {
      clearInterval(this.presenceInterval);
    }
    this.updatePresence('offline');
  }
};

// ========================================
// NOTIFICATION SOUND SYSTEM
// ========================================
const NotificationSound = {
  audioContext: null,
  
  init: function() {
    try {
      this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
    } catch (e) {
      console.log('[Sound] AudioContext not available');
    }
  },
  
  playChime: function() {
    if (!this.audioContext) this.init();
    if (!this.audioContext) return;
    
    try {
      const oscillator = this.audioContext.createOscillator();
      const gainNode = this.audioContext.createGain();
      
      oscillator.connect(gainNode);
      gainNode.connect(this.audioContext.destination);
      
      oscillator.frequency.setValueAtTime(880, this.audioContext.currentTime);
      oscillator.frequency.setValueAtTime(1108.73, this.audioContext.currentTime + 0.1);
      oscillator.frequency.setValueAtTime(1318.51, this.audioContext.currentTime + 0.2);
      
      gainNode.gain.setValueAtTime(0.3, this.audioContext.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.4);
      
      oscillator.start(this.audioContext.currentTime);
      oscillator.stop(this.audioContext.currentTime + 0.4);
    } catch (e) {
      console.log('[Sound] Chime error:', e);
    }
  }
};

// ========================================
// MENTION NOTIFICATION SYSTEM
// ========================================
const MentionNotificationSystem = {
  sendMentionNotification: async function(mentionedUserId, mentionedUserName, postContent, authorName, authorId) {
    if (!mentionedUserId || typeof firebase === 'undefined') return;
    
    try {
      await db.collection('mention_notifications').add({
        targetUserId: mentionedUserId,
        targetUserName: mentionedUserName,
        postContent: postContent.substring(0, 100) + (postContent.length > 100 ? '...' : ''),
        authorName: authorName,
        authorId: authorId,
        type: 'mention',
        read: false,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      console.log('[Mentions] Notification sent to:', mentionedUserName);
    } catch (e) {
      console.log('[Mentions] Error sending notification:', e);
    }
  },
  
  sendEveryoneNotification: async function(postContent, authorName, authorId) {
    if (typeof firebase === 'undefined') return;
    
    try {
      await db.collection('everyone_notifications').add({
        postContent: postContent.substring(0, 100) + (postContent.length > 100 ? '...' : ''),
        authorName: authorName,
        authorId: authorId,
        type: 'everyone',
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      console.log('[Mentions] @everyone notification sent');
    } catch (e) {
      console.log('[Mentions] Error sending @everyone notification:', e);
    }
  },
  
  // ‚úÖ FIX: Optimized mentions - 95% Firebase cost reduction
  listenForMentions: function(userId, callback) {
    if (!userId || typeof firebase === 'undefined') return () => {};
    
    let lastMentionCount = 0;
    
    const fetchMentions = async () => {
      try {
        const snap = await db.collection('mention_notifications')
          .where('targetUserId', '==', userId)
          .where('read', '==', false)
          .orderBy('createdAt', 'desc')
          .limit(10)
          .get();
        
        const mentions = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        // Only play sound if new mentions arrived
        if (mentions.length > lastMentionCount && lastMentionCount > 0) {
          NotificationSound.playChime();
        }
        lastMentionCount = mentions.length;
        
        callback(mentions);
      } catch (e) {
        console.log('[Mentions] Fetch error:', e);
      }
    };
    
    // Initial fetch
    fetchMentions();
    
    // ‚úÖ COST FIX: Check every 2 minutes instead of 30 seconds (saves ~‚Çπ1,500/month)
    const interval = setInterval(fetchMentions, 120000);
    
    // Return cleanup function
    return () => clearInterval(interval);
  },
  
  // ‚úÖ FIX: Optimized everyone notifications
  listenForEveryone: function(callback) {
    if (typeof firebase === 'undefined') return () => {};
    
    const fetchEveryone = async () => {
      try {
        const fiveMinutesAgo = new Date(Date.now() - 5 * 60 * 1000);
        const snap = await db.collection('everyone_notifications')
          .where('createdAt', '>', fiveMinutesAgo)
          .orderBy('createdAt', 'desc')
          .limit(5)
          .get();
        
        const notifications = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        callback(notifications);
      } catch (e) {
        console.log('[Everyone] Fetch error:', e);
      }
    };
    
    fetchEveryone();
    // ‚úÖ COST FIX: Check every 2 minutes instead of 30 seconds (saves ~‚Çπ1,000/month)
    const interval = setInterval(fetchEveryone, 120000);
    return () => clearInterval(interval);
  },
  
  markAsRead: async function(notificationId) {
    try {
      await db.collection('mention_notifications').doc(notificationId).update({ read: true });
    } catch (e) {
      console.log('[Mentions] Mark read error:', e);
    }
  }
};

// Initialize sound on first user interaction
document.addEventListener('click', function initSound() {
  NotificationSound.init();
  document.removeEventListener('click', initSound);
}, { once: true });

// Default schools - will be overridden by dynamic schools from Firebase
let SCHOOLS=['CoE Barwani','CoE Cuttak','CoE Bundi','CoE Mahisagar','EMRS Bhopal','JNV Bharuch'];

// ========================================
// HIERARCHY ROLE CONSTANTS (4-Level)
// ========================================
const MANAGER_ROLES = {
  SUPER_ADMIN: 'super_admin',     // Full access to everything
  DIRECTOR: 'director',           // Director - view all data (read-only)
  ASSOC_DIRECTOR: 'assoc_director', // Associate Director - view all data (read-only)
  TRAINING: 'training',           // Training Department - view all data (read-only)
  APH: 'aph',                     // Program Head - sees all reportees' schools
  PM: 'pm',                       // Program Manager - sees their schools + APM schools
  APM: 'apm',                     // Associate Program Manager - sees only assigned schools
  APC: 'apc'                      // Academic Program Coordinator - school level, view + student attendance
};

const ROLE_LABELS = {
  'super_admin': 'Super Admin',
  'director': 'Director',
  'assoc_director': 'Associate Director',
  'training': 'Training Department',
  'aph': 'Program Head',
  'pm': 'Program Manager',
  'apm': 'Associate Program Manager',
  'apc': 'Academic Program Coordinator'
};

const ROLE_COLORS = {
  'super_admin': { bg: 'bg-purple-100', text: 'text-purple-700', border: 'border-purple-200' },
  'director': { bg: 'bg-indigo-100', text: 'text-indigo-700', border: 'border-indigo-200' },
  'assoc_director': { bg: 'bg-violet-100', text: 'text-violet-700', border: 'border-violet-200' },
  'training': { bg: 'bg-cyan-100', text: 'text-cyan-700', border: 'border-cyan-200' },
  'aph': { bg: 'bg-blue-100', text: 'text-blue-700', border: 'border-blue-200' },
  'pm': { bg: 'bg-green-100', text: 'text-green-700', border: 'border-green-200' },
  'apm': { bg: 'bg-orange-100', text: 'text-orange-700', border: 'border-orange-200' },
  'apc': { bg: 'bg-teal-100', text: 'text-teal-700', border: 'border-teal-200' }
};

// ========================================
// ACADEMIC YEAR CONFIGURATION
// ========================================
const getCurrentAcademicYear = () => {
  const now = new Date();
  const year = now.getFullYear();
  const month = now.getMonth(); // 0-indexed
  // Academic year starts in April (month 3)
  if (month >= 3) { // April onwards
    return `${year}-${year + 1}`;
  } else { // Jan-March
    return `${year - 1}-${year}`;
  }
};

const CURRENT_ACADEMIC_YEAR = getCurrentAcademicYear();

// ========================================
// OFFLINE DATA SYNC & AUTOSAVE UTILITY
// For low connectivity areas (30-40km from city)
// ========================================
const DataSyncManager = {
  pendingOperations: [],
  retryInterval: null,
  maxRetries: 5,
  
  // Initialize the sync manager
  init: function() {
    // Load pending operations from localStorage
    try {
      const stored = localStorage.getItem('pendingDataSync');
      if (stored) {
        this.pendingOperations = JSON.parse(stored);
        console.log('[DataSync] Loaded', this.pendingOperations.length, 'pending operations');
      }
    } catch (e) {
      console.error('[DataSync] Error loading pending ops:', e);
    }
    
    // Listen for online event
    window.addEventListener('online', () => {
      console.log('[DataSync] Back online, syncing...');
      this.syncPendingOperations();
    });
    
    // Try to sync periodically
    setInterval(() => {
      if (navigator.onLine && this.pendingOperations.length > 0) {
        this.syncPendingOperations();
      }
    }, 30000); // Every 30 seconds
  },
  
  // Save data with retry logic
  saveWithRetry: async function(collection, docId, data, options = {}) {
    const { merge = true, maxRetries = this.maxRetries, showToast = true } = options;
    
    // Create operation record
    const operation = {
      id: Date.now() + '_' + Math.random().toString(36).substr(2, 9),
      collection,
      docId,
      data,
      merge,
      timestamp: new Date().toISOString(),
      retries: 0
    };
    
    // Try to save immediately
    for (let attempt = 0; attempt < maxRetries; attempt++) {
      try {
        if (!navigator.onLine) {
          throw new Error('Offline');
        }
        
        const docRef = docId 
          ? db.collection(collection).doc(docId)
          : db.collection(collection).doc();
        
        await docRef.set(data, { merge });
        
        if (showToast) {
          this.showSaveToast('success');
        }
        
        return { success: true, docId: docRef.id };
      } catch (error) {
        console.log(`[DataSync] Attempt ${attempt + 1} failed:`, error.message);
        
        if (attempt < maxRetries - 1) {
          // Wait before retrying (exponential backoff)
          await new Promise(resolve => setTimeout(resolve, Math.pow(2, attempt) * 1000));
        }
      }
    }
    
    // All retries failed, queue for later
    this.pendingOperations.push(operation);
    this.savePendingToStorage();
    
    if (showToast) {
      this.showSaveToast('queued');
    }
    
    return { success: false, queued: true, operationId: operation.id };
  },
  
  // Sync all pending operations
  syncPendingOperations: async function() {
    if (!navigator.onLine || this.pendingOperations.length === 0) return;
    
    console.log('[DataSync] Syncing', this.pendingOperations.length, 'operations');
    
    const successfulOps = [];
    
    for (const op of this.pendingOperations) {
      try {
        const docRef = op.docId 
          ? db.collection(op.collection).doc(op.docId)
          : db.collection(op.collection).doc();
        
        await docRef.set(op.data, { merge: op.merge });
        successfulOps.push(op.id);
        console.log('[DataSync] Synced:', op.collection);
      } catch (error) {
        op.retries++;
        console.log('[DataSync] Failed to sync:', op.collection, error.message);
        
        // Remove if too many retries
        if (op.retries > 10) {
          successfulOps.push(op.id);
          console.log('[DataSync] Giving up on:', op.collection);
        }
      }
    }
    
    // Remove successful operations
    this.pendingOperations = this.pendingOperations.filter(op => !successfulOps.includes(op.id));
    this.savePendingToStorage();
    
    if (successfulOps.length > 0) {
      this.showSaveToast('synced', successfulOps.length);
    }
  },
  
  // Save pending operations to localStorage
  savePendingToStorage: function() {
    try {
      localStorage.setItem('pendingDataSync', JSON.stringify(this.pendingOperations));
    } catch (e) {
      console.error('[DataSync] Error saving to storage:', e);
    }
  },
  
  // Show save status toast
  showSaveToast: function(status, count = 1) {
    const existing = document.getElementById('saveToast');
    if (existing) existing.remove();
    
    const toast = document.createElement('div');
    toast.id = 'saveToast';
    toast.className = 'fixed bottom-20 right-4 px-4 py-2 rounded-lg shadow-lg z-50 flex items-center gap-2 text-sm font-medium transition-all';
    
    switch (status) {
      case 'success':
        toast.className += ' bg-green-500 text-white';
        toast.innerHTML = '‚úÖ Saved!';
        break;
      case 'queued':
        toast.className += ' bg-yellow-500 text-black';
        toast.innerHTML = '‚è≥ Saved offline - will sync when connected';
        break;
      case 'synced':
        toast.className += ' bg-blue-500 text-white';
        toast.innerHTML = `üîÑ Synced ${count} item${count > 1 ? 's' : ''}!`;
        break;
      case 'error':
        toast.className += ' bg-red-500 text-white';
        toast.innerHTML = '‚ùå Save failed';
        break;
    }
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
      toast.style.opacity = '0';
      setTimeout(() => toast.remove(), 300);
    }, status === 'queued' ? 4000 : 2000);
  },
  
  // Get pending count for UI display
  getPendingCount: function() {
    return this.pendingOperations.length;
  }
};

// Initialize on load
if (typeof window !== 'undefined') {
  DataSyncManager.init();
}

const LEAVE_REASONS=['Present','Personal Leave','Sick Leave','Weekly Off','Public Holiday','Organization Holiday','School Holiday','Emergency Leave','Maternity Leave','Paternity Leave'];

// Leave entitlements per year
const LEAVE_ENTITLEMENTS = {
  'Personal Leave': 35,
  'Sick Leave': 35,
  'Emergency Leave': 35,
  'Maternity Leave': 180,
  'Paternity Leave': 15
};

// Leave categories that count against entitlement
const ENTITLED_LEAVE_TYPES = ['Personal Leave', 'Sick Leave', 'Emergency Leave'];
const MATERNITY_LEAVE_TYPES = ['Maternity Leave'];
const PATERNITY_LEAVE_TYPES = ['Paternity Leave'];

// ========================================
// ASSET MANAGEMENT CONSTANTS
// ========================================
const ASSET_CATEGORIES = ['Physics', 'Chemistry', 'Maths', 'Biology', 'General', 'Competition', 'Other'];
const ASSET_TYPES = ['book', 'chromebook'];
// Asset management - no due dates, return when done

// ========================================
// CLASSROOM OBSERVATION PARAMETERS
// ========================================
const CLASSROOM_OBSERVATION_PARAMETERS = [
  {
    id: 'teacherStartedOnTime',
    type: 'minor',
    text: 'Teacher started the class on time',
    maxScore: 1,
    options: [
      { label: 'Yes', value: 1 },
      { label: 'No', value: 0 }
    ]
  },
  {
    id: 'hygiene',
    type: 'minor',
    text: 'Hygiene Parameter: Teacher Grooming - The teacher is formally dressed with proper grooming',
    maxScore: 1,
    options: [
      { label: 'Yes', value: 1 },
      { label: 'No', value: 0 }
    ]
  },
  {
    id: 'startNote',
    type: 'minor',
    text: 'Start Note of the Class: Greetings to the students along with general discussion to gather the attention of all students',
    maxScore: 1,
    options: [
      { label: 'Yes', value: 1 },
      { label: 'No', value: 0 }
    ]
  },
  {
    id: 'preTask',
    type: 'minor',
    text: 'Class structure - Pre-task/Check for HW: The teacher is discussing any previous task assigned',
    maxScore: 1,
    options: [
      { label: 'Yes', value: 1 },
      { label: 'No', value: 0 }
    ]
  },
  {
    id: 'recall',
    type: 'major',
    text: 'Class structure - Recall/Recall test: The session recall needs to be done with two-side communication with simple questions if possible',
    maxScore: 2,
    options: [
      { label: 'Recall done - with questions / students interaction within time', value: 2 },
      { label: 'Recall done - without questions / Taking more than allotted time', value: 1 },
      { label: 'Recall is not done', value: 0 }
    ]
  },
  {
    id: 'learningObjective',
    type: 'major',
    text: 'Learning Objective Setting - Agenda of the class: The teacher needs to set the learning outcome or index for the present class',
    maxScore: 1,
    options: [
      { label: 'Agenda clearly given', value: 1 },
      { label: 'Agenda not given/not clear', value: 0 }
    ]
  },
  {
    id: 'curiosityIntro',
    type: 'major',
    text: 'Curiosity-Introduction: Introduction with practical examples',
    maxScore: 1,
    options: [
      { label: 'Yes', value: 1 },
      { label: 'No', value: 0 }
    ]
  },
  {
    id: 'teachingCompetence',
    type: 'major',
    text: 'Concept-Teaching competence',
    maxScore: 4,
    inputType: 'checkbox',
    checkboxItems: [
      { id: 'conceptClear', label: 'Concept clearly explained' },
      { id: 'cfuPresent', label: 'CFU-Check for understanding present' },
      { id: 'physicalTools', label: 'Used physical teaching tools' },
      { id: 'wellPrepared', label: 'Teacher was well-prepared' }
    ],
    options: [
      { label: 'All 4 parameters met', value: 4 },
      { label: 'Any 3 parameters met', value: 3 },
      { label: 'Any 2 parameters met', value: 2 },
      { label: 'Any 1 parameter met', value: 1 },
      { label: 'None', value: 0 }
    ]
  },
  {
    id: 'notesTaking',
    type: 'major',
    text: 'Concept-Notes Taking: Teacher provides notes and checks students are noting down',
    maxScore: 3,
    options: [
      { label: 'Notes given & checked + mind maps/tricks/mnemonics provided', value: 3 },
      { label: 'Notes given and ensured all students are noting down by checking', value: 2 },
      { label: 'Notes given but not checked with students', value: 1 },
      { label: 'Notes were not given', value: 0 }
    ]
  },
  {
    id: 'problemSolving',
    type: 'major',
    text: 'Concept-Problem solving: Problems solved with student interaction and PYQs',
    maxScore: 4,
    options: [
      { label: 'Problem solved step by step + student opportunity + PYQ given & solved', value: 4 },
      { label: 'Problem solved step by step + giving opportunity for students to solve', value: 3 },
      { label: 'Problem solved step by step with student interaction', value: 2 },
      { label: 'Problem solved without mistakes', value: 1 },
      { label: 'No problems solved or solved with mistakes', value: 0 }
    ]
  },
  {
    id: 'doubtSolving',
    type: 'major',
    text: 'Concept-Doubt solving: Doubts solved correctly with good time management',
    maxScore: 2,
    options: [
      { label: 'Doubt solved correctly with good time management', value: 2 },
      { label: 'Doubt solved correctly but time management not good', value: 1 },
      { label: 'No doubt asked & teacher did not encourage / doubt solved wrong', value: 0 }
    ]
  },
  {
    id: 'boardPresentation',
    type: 'major',
    text: 'Communication-Board Presentation',
    maxScore: 3,
    inputType: 'checkbox',
    checkboxItems: [
      { id: 'boardUsage', label: 'Usage of board' },
      { id: 'writingClear', label: 'Writing is clear' },
      { id: 'boardRepresentation', label: 'Board representation clear/highlighting formulae' }
    ],
    options: [
      { label: 'All 3 parameters met', value: 3 },
      { label: 'Any 2 parameters met', value: 2 },
      { label: 'Any 1 parameter met', value: 1 },
      { label: 'None', value: 0 }
    ]
  },
  {
    id: 'interaction',
    type: 'major',
    text: 'Communication-Interaction: Engaging all students vs limited engagement',
    maxScore: 2,
    options: [
      { label: 'Putting efforts for engaging all the students', value: 2 },
      { label: 'Student engagement is limited to few students', value: 1 },
      { label: 'One way teaching / No engagement with students', value: 0 }
    ]
  },
  {
    id: 'bodyLanguage',
    type: 'major',
    text: 'Communication-Body Language & Energy & Voice',
    maxScore: 6,
    inputType: 'checkbox',
    checkboxItems: [
      { id: 'voiceClear', label: 'Voice clear' },
      { id: 'voiceModulations', label: 'Voice modulations' },
      { id: 'movementAroundClass', label: 'Movement around class' },
      { id: 'eyeContact', label: 'Eye contact' },
      { id: 'handGestures', label: 'Hand gestures' },
      { id: 'adaptiveLanguage', label: 'Adaptive language & fluency' }
    ],
    options: [
      { label: 'All 6 parameters met', value: 6 },
      { label: 'Any 5 parameters', value: 5 },
      { label: 'Any 4 parameters', value: 4 },
      { label: 'Any 3 parameters', value: 3 },
      { label: 'Any 2 parameters', value: 2 },
      { label: 'Any 1 parameter', value: 1 },
      { label: 'None', value: 0 }
    ]
  },
  {
    id: 'conclusion',
    type: 'minor',
    text: 'Class structure-Conclusion: Summary, homework, and next class preview',
    maxScore: 3,
    options: [
      { label: 'Class summary + HW given + Idea about next class', value: 3 },
      { label: 'Both Class summary and HW given', value: 2 },
      { label: 'Either HW or class summary given, not both', value: 1 },
      { label: 'No Summary and no home work given', value: 0 }
    ]
  },
  {
    id: 'paceOfTeaching',
    type: 'major',
    text: 'Class structure-Pace of teaching: Appropriate pace maintained throughout',
    maxScore: 2,
    options: [
      { label: 'Pace of teaching is as per class level', value: 2 },
      { label: 'Pace of teaching is good but not followed throughout', value: 1 },
      { label: 'Pace of teaching is not good', value: 0 }
    ]
  },
  {
    id: 'timeManagement',
    type: 'major',
    text: 'Class structure-Time management: Completed the learning objectives in the stipulated time',
    maxScore: 3,
    options: [
      { label: 'Agenda completed within time', value: 3 },
      { label: 'Agenda is completed but rushed towards the end', value: 2 },
      { label: 'Agenda could not be completed', value: 1 }
    ]
  },
  {
    id: 'classroomManagement',
    type: 'major',
    text: 'Class structure-Classroom management: Teacher set class rules, able to manage entire class well',
    maxScore: 2,
    options: [
      { label: 'Teacher is able to manage the class', value: 2 },
      { label: 'Teacher mostly able to manage with some disruption', value: 1 },
      { label: 'Teacher was unable to manage the class', value: 0 }
    ]
  },
  {
    id: 'genderSensitivity',
    type: 'major',
    text: 'Gender Sensitivity: 1) Avoids gender-biased remarks, 2) Uses gender-neutral language, 3) Represents diversity in examples, 4) Encourages balanced participation, 5) Addresses gender topics sensitively',
    maxScore: 3,
    options: [
      { label: 'No violations + any 2 positive indicators', value: 3 },
      { label: 'No violations + any 1 positive indicator', value: 2 },
      { label: 'Violation occurred once but teacher corrected it', value: 1 },
      { label: 'Violation occurred more than once', value: 0 }
    ]
  }
];

// Maximum total score for classroom observation
const MAX_OBSERVATION_SCORE = CLASSROOM_OBSERVATION_PARAMETERS.reduce((sum, p) => sum + p.maxScore, 0); // = 45

// Helper function to calculate leave balance for a teacher
// Now includes manual adjustments from leaveAdjustments collection
function calculateLeaveBalance(teacherAttendance, teacherId, leaveAdjustments = {}) {
  const teacherLeaves = teacherAttendance.filter(a => 
    a.teacherId === teacherId && a.status === 'On Leave'
  );
  
  // Calculate days used for each category from attendance records
  let entitledUsed = 0;
  let maternityUsed = 0;
  let paternityUsed = 0;
  
  teacherLeaves.forEach(leave => {
    if (ENTITLED_LEAVE_TYPES.includes(leave.reason)) {
      entitledUsed++;
    } else if (MATERNITY_LEAVE_TYPES.includes(leave.reason)) {
      maternityUsed++;
    } else if (PATERNITY_LEAVE_TYPES.includes(leave.reason)) {
      paternityUsed++;
    }
  });
  
  // Get manual adjustments for this teacher (leaves taken before system was implemented)
  const adjustment = leaveAdjustments[teacherId] || { entitled: 0, maternity: 0, paternity: 0 };
  
  // Add adjustments to used count
  entitledUsed += (adjustment.entitled || 0);
  maternityUsed += (adjustment.maternity || 0);
  paternityUsed += (adjustment.paternity || 0);
  
  return {
    entitled: {
      total: 35,
      used: entitledUsed,
      remaining: Math.max(0, 35 - entitledUsed),
      adjustment: adjustment.entitled || 0
    },
    maternity: {
      total: 180,
      used: maternityUsed,
      remaining: Math.max(0, 180 - maternityUsed),
      adjustment: adjustment.maternity || 0
    },
    paternity: {
      total: 15,
      used: paternityUsed,
      remaining: Math.max(0, 15 - paternityUsed),
      adjustment: adjustment.paternity || 0
    }
  };
}
const GENDERS=['Male','Female','Other'];
const isEditing = true;   // keep all admin filters enabled

// ========================================
// CLASSROOM OBSERVATION COMPONENTS
// ========================================

// Classroom Observation Form Component
function ClassroomObservationForm({ teacher, observerInfo, onClose, onSubmitSuccess }) {
  const [grade, setGrade] = useState('11');
  const [observationDate, setObservationDate] = useState(getTodayDate());
  const [observationTime, setObservationTime] = useState(new Date().toTimeString().slice(0,5));
  const [chapterName, setChapterName] = useState('');
  const [topicName, setTopicName] = useState('');
  const [responses, setResponses] = useState({});
  const [checkboxSelections, setCheckboxSelections] = useState({}); // For checkbox-type parameters
  const [remarks, setRemarks] = useState({});
  const [strengths, setStrengths] = useState('');
  const [improvements, setImprovements] = useState('');
  const [mediaLinks, setMediaLinks] = useState(['']);
  const [submitting, setSubmitting] = useState(false);
  const [currentStep, setCurrentStep] = useState(0); // 0 = parameters, 1 = summary

  // Handle checkbox toggle for checkbox-type parameters
  const handleCheckboxToggle = (paramId, itemId) => {
    setCheckboxSelections(prev => {
      const current = prev[paramId] || {};
      const newSelection = { ...current, [itemId]: !current[itemId] };
      
      // Count checked items
      const checkedCount = Object.values(newSelection).filter(Boolean).length;
      
      // Auto-update the score based on checked count
      handleResponseChange(paramId, checkedCount);
      
      return { ...prev, [paramId]: newSelection };
    });
  };

  // Calculate total score
  const totalScore = useMemo(() => {
    return Object.values(responses).reduce((sum, val) => sum + (val || 0), 0);
  }, [responses]);

  const percentageScore = ((totalScore / MAX_OBSERVATION_SCORE) * 100).toFixed(1);

  // Count flagged items (items not at max score)
  const flaggedCount = useMemo(() => {
    return CLASSROOM_OBSERVATION_PARAMETERS.filter(p => {
      const score = responses[p.id];
      return score !== undefined && score < p.maxScore;
    }).length;
  }, [responses]);

  const handleResponseChange = (paramId, value) => {
    setResponses(prev => ({ ...prev, [paramId]: value }));
  };

  const handleRemarkChange = (paramId, value) => {
    setRemarks(prev => ({ ...prev, [paramId]: value }));
  };

  const addMediaLink = () => {
    setMediaLinks(prev => [...prev, '']);
  };

  const updateMediaLink = (index, value) => {
    setMediaLinks(prev => {
      const updated = [...prev];
      updated[index] = value;
      return updated;
    });
  };

  const removeMediaLink = (index) => {
    setMediaLinks(prev => prev.filter((_, i) => i !== index));
  };

  const handleSubmit = async () => {
    // Validate all required fields
    const unanswered = CLASSROOM_OBSERVATION_PARAMETERS.filter(p => responses[p.id] === undefined);
    if (unanswered.length > 0) {
      alert(`Please answer all observation parameters. ${unanswered.length} unanswered.`);
      return;
    }

    setSubmitting(true);
    try {
      const observationData = {
        teacherId: teacher.afid || teacher.docId,
        teacherName: teacher.name,
        teacherAfCode: teacher.afCode || null,
        teacherSubject: teacher.subject,
        school: teacher.school,
        grade: grade,
        chapterName: chapterName || null,
        topicName: topicName || null,
        observationDate: observationDate,
        observationTime: observationTime,
        responses: responses,
        checkboxSelections: checkboxSelections,
        remarks: remarks,
        strengths: strengths,
        improvements: improvements,
        mediaLinks: mediaLinks.filter(link => link.trim() !== ''),
        totalScore: totalScore,
        maxScore: MAX_OBSERVATION_SCORE,
        percentageScore: parseFloat(percentageScore),
        flaggedCount: flaggedCount,
        observerId: observerInfo.id,
        observerName: observerInfo.name,
        observerPosition: observerInfo.position || 'Manager',
        submittedAt: firebase.firestore.FieldValue.serverTimestamp(),
        submittedAtISO: new Date().toISOString()
      };

      await db.collection('classroomObservations').add(observationData);
      alert('‚úÖ Classroom observation submitted successfully!');
      onSubmitSuccess && onSubmitSuccess();
      onClose();
    } catch (error) {
      console.error('Error submitting observation:', error);
      alert('‚ùå Failed to submit observation: ' + error.message);
    } finally {
      setSubmitting(false);
    }
  };

  // Get score color
  const getScoreColor = (score, max) => {
    const pct = (score / max) * 100;
    if (pct >= 80) return 'bg-green-100 text-green-700 border-green-300';
    if (pct >= 60) return 'bg-yellow-100 text-yellow-700 border-yellow-300';
    return 'bg-red-100 text-red-700 border-red-300';
  };

  return (
    <div className="modal-overlay" onClick={onClose}>
      <div className="modal-content max-w-4xl max-h-[95vh] overflow-y-auto" onClick={e => e.stopPropagation()}>
        <div className="p-6">
          {/* Header */}
          <div className="flex justify-between items-start mb-6">
            <div>
              <h2 className="text-2xl font-bold">üìã Classroom Observation</h2>
              <p className="text-gray-600 mt-1">Teacher: <strong>{teacher.name}</strong> ({teacher.subject})</p>
              <p className="text-gray-500 text-sm">School: {teacher.school}</p>
            </div>
            <button onClick={onClose} className="text-3xl font-bold text-gray-400 hover:text-gray-600">√ó</button>
          </div>

          {/* Progress indicator */}
          <div className="mb-6 bg-gray-100 rounded-full h-2">
            <div 
              className="avanti-gradient h-2 rounded-full transition-all"
              style={{ width: `${(Object.keys(responses).length / CLASSROOM_OBSERVATION_PARAMETERS.length) * 100}%` }}
            />
          </div>

          {/* Basic Info */}
          <div className="grid md:grid-cols-3 gap-4 mb-6 bg-gray-50 p-4 rounded-xl">
            <div>
              <label className="block text-sm font-bold mb-2">Grade *</label>
              <select value={grade} onChange={e => setGrade(e.target.value)} className="w-full border-2 px-4 py-3 rounded-xl">
                <option value="11">Class 11</option>
                <option value="12">Class 12</option>
              </select>
            </div>
            <div>
              <label className="block text-sm font-bold mb-2">Date *</label>
              <input type="date" value={observationDate} onChange={e => setObservationDate(e.target.value)} className="w-full border-2 px-4 py-3 rounded-xl"/>
            </div>
            <div>
              <label className="block text-sm font-bold mb-2">Time *</label>
              <input type="time" value={observationTime} onChange={e => setObservationTime(e.target.value)} className="w-full border-2 px-4 py-3 rounded-xl"/>
            </div>
          </div>

          {/* Chapter/Topic Info (Optional) */}
          <div className="grid md:grid-cols-2 gap-4 mb-6 bg-blue-50 p-4 rounded-xl">
            <div>
              <label className="block text-sm font-bold mb-2">Chapter Name (Optional)</label>
              <input 
                type="text" 
                value={chapterName} 
                onChange={e => setChapterName(e.target.value)} 
                placeholder="e.g., Kinematics, Chemical Bonding" 
                className="w-full border-2 px-4 py-3 rounded-xl"
              />
            </div>
            <div>
              <label className="block text-sm font-bold mb-2">Topic Name (Optional)</label>
              <input 
                type="text" 
                value={topicName} 
                onChange={e => setTopicName(e.target.value)} 
                placeholder="e.g., Projectile Motion, Hybridization" 
                className="w-full border-2 px-4 py-3 rounded-xl"
              />
            </div>
          </div>

          {/* Score Summary Card */}
          <div className={`p-4 rounded-xl mb-6 border-2 ${getScoreColor(totalScore, MAX_OBSERVATION_SCORE)}`}>
            <div className="flex justify-between items-center">
              <div>
                <span className="text-2xl font-bold">{totalScore}/{MAX_OBSERVATION_SCORE}</span>
                <span className="ml-2 text-lg">({percentageScore}%)</span>
              </div>
              <div className="text-right">
                <span className="px-3 py-1 bg-red-100 text-red-700 rounded-full text-sm font-semibold">
                  {flaggedCount} flagged items
                </span>
              </div>
            </div>
          </div>

          {/* Parameters */}
          <div className="space-y-4 mb-6">
            <h3 className="text-xl font-bold border-b pb-2">Observation Parameters</h3>
            
            {CLASSROOM_OBSERVATION_PARAMETERS.map((param, idx) => (
              <div key={param.id} className={`p-4 rounded-xl border-2 ${
                responses[param.id] !== undefined 
                  ? responses[param.id] === param.maxScore 
                    ? 'bg-green-50 border-green-200' 
                    : 'bg-red-50 border-red-200'
                  : 'bg-white border-gray-200'
              }`}>
                <div className="flex justify-between items-start mb-3">
                  <div className="flex-1">
                    <span className={`inline-block px-2 py-1 text-xs font-bold rounded mb-2 ${
                      param.type === 'major' ? 'bg-purple-100 text-purple-700' : 'bg-blue-100 text-blue-700'
                    }`}>
                      {param.type === 'major' ? '‚≠ê Major' : 'üìå Minor'} ({param.maxScore} pts)
                    </span>
                    <p className="font-semibold text-gray-800">{idx + 1}. {param.text}</p>
                  </div>
                </div>
                
                {/* Checkbox-based parameters */}
                {param.inputType === 'checkbox' && param.checkboxItems ? (
                  <div className="mb-3">
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-2 mb-3 p-3 bg-gray-50 rounded-xl">
                      {param.checkboxItems.map(item => {
                        const isChecked = checkboxSelections[param.id]?.[item.id] || false;
                        return (
                          <label 
                            key={item.id} 
                            className={`flex items-center gap-2 p-2 rounded-lg cursor-pointer transition-all ${
                              isChecked ? 'bg-green-100 border border-green-300' : 'bg-white border border-gray-200 hover:bg-gray-100'
                            }`}
                          >
                            <input 
                              type="checkbox"
                              checked={isChecked}
                              onChange={() => handleCheckboxToggle(param.id, item.id)}
                              className="cursor-pointer"
                            />
                            <span className={`text-sm ${isChecked ? 'text-green-700 font-semibold' : 'text-gray-700'}`}>
                              {item.label}
                            </span>
                          </label>
                        );
                      })}
                    </div>
                    <div className="flex items-center gap-2 text-sm">
                      <span className="font-semibold">Score:</span>
                      <span className={`px-3 py-1 rounded-full font-bold ${
                        responses[param.id] === param.maxScore ? 'bg-green-100 text-green-700' :
                        responses[param.id] > 0 ? 'bg-yellow-100 text-yellow-700' : 'bg-gray-100 text-gray-600'
                      }`}>
                        {responses[param.id] ?? 0} / {param.maxScore}
                      </span>
                      <span className="text-gray-500">
                        ({Object.values(checkboxSelections[param.id] || {}).filter(Boolean).length} items selected)
                      </span>
                    </div>
                  </div>
                ) : (
                  /* Standard dropdown for other parameters */
                  <select
                    value={responses[param.id] ?? ''}
                    onChange={e => handleResponseChange(param.id, e.target.value === '' ? undefined : parseInt(e.target.value))}
                    className="w-full border-2 px-4 py-3 rounded-xl mb-2"
                  >
                    <option value="">-- Select --</option>
                    {param.options.map((opt, optIdx) => (
                      <option key={optIdx} value={opt.value}>
                        {opt.label} ({opt.value})
                      </option>
                    ))}
                  </select>
                )}

                {/* Show remarks field if not full score */}
                {responses[param.id] !== undefined && responses[param.id] < param.maxScore && (
                  <div className="mt-2">
                    <label className="block text-sm font-semibold text-red-600 mb-1">
                      üìù Remarks (why not full marks?)
                    </label>
                    <textarea
                      value={remarks[param.id] || ''}
                      onChange={e => handleRemarkChange(param.id, e.target.value)}
                      placeholder="Please provide remarks for improvement..."
                      className="w-full border-2 border-red-200 px-4 py-2 rounded-xl text-sm"
                      rows="2"
                    />
                  </div>
                )}
              </div>
            ))}
          </div>

          {/* Observer Summary */}
          <div className="space-y-4 mb-6 bg-blue-50 p-4 rounded-xl">
            <h3 className="text-xl font-bold text-blue-800">üìù Observer Summary</h3>
            
            <div>
              <label className="block text-sm font-bold mb-2">Strengths Observed</label>
              <textarea
                value={strengths}
                onChange={e => setStrengths(e.target.value)}
                placeholder="What did the teacher do well?"
                className="w-full border-2 px-4 py-3 rounded-xl"
                rows="3"
              />
            </div>
            
            <div>
              <label className="block text-sm font-bold mb-2">Points of Improvement</label>
              <textarea
                value={improvements}
                onChange={e => setImprovements(e.target.value)}
                placeholder="What recommendations do you have to improve teaching?"
                className="w-full border-2 px-4 py-3 rounded-xl"
                rows="3"
              />
            </div>
          </div>

          {/* Media Links */}
          <div className="space-y-4 mb-6 bg-gray-50 p-4 rounded-xl">
            <div className="flex justify-between items-center">
              <h3 className="text-xl font-bold">üì∏ Media (Google Drive Links)</h3>
              <button onClick={addMediaLink} className="px-4 py-2 bg-blue-600 text-white rounded-xl text-sm font-semibold">
                + Add Link
              </button>
            </div>
            
            {mediaLinks.map((link, idx) => (
              <div key={idx} className="flex gap-2">
                <input
                  type="url"
                  value={link}
                  onChange={e => updateMediaLink(idx, e.target.value)}
                  placeholder="https://drive.google.com/..."
                  className="flex-1 border-2 px-4 py-2 rounded-xl"
                />
                {mediaLinks.length > 1 && (
                  <button onClick={() => removeMediaLink(idx)} className="px-3 py-2 bg-red-500 text-white rounded-xl">
                    ‚úï
                  </button>
                )}
              </div>
            ))}
          </div>

          {/* Observer Info (Auto-filled) */}
          <div className="bg-gray-100 p-4 rounded-xl mb-6">
            <h4 className="font-bold mb-2">Observer Information (Auto-filled)</h4>
            <div className="grid md:grid-cols-3 gap-4 text-sm">
              <div><strong>Name:</strong> {observerInfo.name}</div>
              <div><strong>Position:</strong> {observerInfo.position || 'Manager'}</div>
              <div><strong>Date/Time:</strong> {new Date().toLocaleString('en-IN')}</div>
            </div>
          </div>

          {/* Submit Button */}
          <div className="flex gap-4">
            <button
              onClick={handleSubmit}
              disabled={submitting}
              className="flex-1 avanti-gradient text-white py-4 rounded-xl font-bold text-lg hover:opacity-90 disabled:opacity-50"
            >
              {submitting ? '‚è≥ Submitting...' : '‚úÖ Submit Observation'}
            </button>
            <button onClick={onClose} className="px-8 py-4 bg-gray-300 rounded-xl font-bold">
              Cancel
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}

// Teacher Profile View Component (shows observations and feedback)
function TeacherProfileView({ teacher, onClose, currentUser }) {
  const [observations, setObservations] = useState([]);
  const [feedbackData, setFeedbackData] = useState([]);
  const [loading, setLoading] = useState(true);
  const [selectedMonth, setSelectedMonth] = useState('All');
  const [selectedObservation, setSelectedObservation] = useState(null);
  const chartRef = useRef(null);
  const chartInstance = useRef(null);

  // Fetch observations and feedback for this teacher
  useEffect(() => {
    const fetchData = async () => {
      try {
        setLoading(true);
        
        // Fetch observations
        const obsSnap = await db.collection('classroomObservations')
          .where('teacherId', '==', teacher.afid || teacher.docId)
          .orderBy('submittedAt', 'desc')
          .get();
        
        const obsData = obsSnap.docs.map(doc => ({
          id: doc.id,
          ...doc.data(),
          submittedAt: doc.data().submittedAt?.toDate() || new Date(doc.data().submittedAtISO)
        }));
        setObservations(obsData);

        // ‚úÖ COST FIX: Query by specific teacher IDs instead of fetching ALL feedback
        // This reduces reads from 1000s to ~10-50 per profile view
        const teacherAfid = teacher.afid || teacher.docId || teacher.id;
        let fbData = [];
        
        try {
          // First try: Query by teacherAfid (most reliable identifier)
          if (teacherAfid) {
            const afidSnap = await db.collection('teacherFeedback')
              .where('teacherAfid', '==', teacherAfid)
              .get();
            fbData = afidSnap.docs.map(doc => {
              const data = doc.data();
              return {
                id: doc.id,
                ...data,
                submittedAt: data.submittedAt?.toDate ? data.submittedAt.toDate() : new Date(data.submittedAt || data.completedAt)
              };
            });
          }
          
          // If no results, try by teacherId
          if (fbData.length === 0 && teacherAfid) {
            const idSnap = await db.collection('teacherFeedback')
              .where('teacherId', '==', teacherAfid)
              .get();
            fbData = idSnap.docs.map(doc => {
              const data = doc.data();
              return {
                id: doc.id,
                ...data,
                submittedAt: data.submittedAt?.toDate ? data.submittedAt.toDate() : new Date(data.submittedAt || data.completedAt)
              };
            });
          }
          
          // If still no results and we have docId, try that
          if (fbData.length === 0 && teacher.docId && teacher.docId !== teacherAfid) {
            const docIdSnap = await db.collection('teacherFeedback')
              .where('teacherDocId', '==', teacher.docId)
              .get();
            fbData = docIdSnap.docs.map(doc => {
              const data = doc.data();
              return {
                id: doc.id,
                ...data,
                submittedAt: data.submittedAt?.toDate ? data.submittedAt.toDate() : new Date(data.submittedAt || data.completedAt)
              };
            });
          }
        } catch (queryError) {
          console.log('Feedback query error, trying alternate method:', queryError.message);
          // Fallback: If queries fail due to missing index, fetch by school and filter
          try {
            const schoolSnap = await db.collection('teacherFeedback')
              .where('school', '==', teacher.school)
              .get();
            const teacherIdentifiers = [teacher.afid, teacher.docId, teacher.id].filter(Boolean).map(id => String(id).toLowerCase());
            fbData = schoolSnap.docs
              .filter(doc => {
                const data = doc.data();
                const feedbackTeacherId = String(data.teacherId || data.teacherAfid || data.teacherDocId || '').toLowerCase();
                return teacherIdentifiers.includes(feedbackTeacherId);
              })
              .map(doc => {
                const data = doc.data();
                return {
                  id: doc.id,
                  ...data,
                  submittedAt: data.submittedAt?.toDate ? data.submittedAt.toDate() : new Date(data.submittedAt || data.completedAt)
                };
              });
          } catch (fallbackError) {
            console.error('Fallback query also failed:', fallbackError);
          }
        }
        
        console.log('Found feedback for teacher:', teacher.name, ':', fbData.length, 'responses');
        setFeedbackData(fbData);

      } catch (error) {
        console.error('Error fetching teacher profile data:', error);
      } finally {
        setLoading(false);
      }
    };

    fetchData();
  }, [teacher]);

  // Get unique months from observations
  const availableMonths = useMemo(() => {
    const months = new Set();
    observations.forEach(obs => {
      const date = new Date(obs.observationDate || obs.submittedAt);
      months.add(`${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`);
    });
    return Array.from(months).sort().reverse();
  }, [observations]);

  // Filter observations by month
  const filteredObservations = useMemo(() => {
    if (selectedMonth === 'All') return observations;
    return observations.filter(obs => {
      const date = new Date(obs.observationDate || obs.submittedAt);
      const month = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
      return month === selectedMonth;
    });
  }, [observations, selectedMonth]);

  // Calculate average feedback scores
  const feedbackAverages = useMemo(() => {
    if (feedbackData.length === 0) return null;
    
    const questionAverages = {};
    const questionLabels = {
      q1: 'Punctuality',
      q2: 'Academic Level', 
      q3: 'Problem Solving',
      q4: 'Explanation Clarity',
      q5: 'Handwriting & Voice',
      q6: 'Time Management',
      q7: 'Guidance & Motivation',
      q8: 'Student Participation',
      q9: 'Equal Attention',
      
      
      
      
      
      
    };

    Object.keys(questionLabels).forEach(qId => {
      const ratings = feedbackData
        .map(fb => fb.responses?.[qId]?.rating)
        .filter(r => r !== undefined && r !== null);
      
      if (ratings.length > 0) {
        questionAverages[qId] = {
          label: questionLabels[qId],
          average: (ratings.reduce((a, b) => a + b, 0) / ratings.length).toFixed(1),
          count: ratings.length
        };
      }
    });

    return questionAverages;
  }, [feedbackData]);

  // Overall average rating
  const overallRating = useMemo(() => {
    if (!feedbackAverages) return null;
    const values = Object.values(feedbackAverages).map(v => parseFloat(v.average));
    if (values.length === 0) return null;
    return (values.reduce((a, b) => a + b, 0) / values.length).toFixed(1);
  }, [feedbackAverages]);

  // Chart for observation trends
  useEffect(() => {
    if (chartInstance.current) {
      chartInstance.current.destroy();
    }

    if (chartRef.current && observations.length > 0) {
      const ctx = chartRef.current.getContext('2d');
      
      // Group by month
      const monthlyData = {};
      observations.forEach(obs => {
        const date = new Date(obs.observationDate || obs.submittedAt);
        const month = date.toLocaleDateString('en-IN', { month: 'short', year: '2-digit' });
        if (!monthlyData[month]) {
          monthlyData[month] = [];
        }
        monthlyData[month].push(obs.percentageScore);
      });

      const labels = Object.keys(monthlyData);
      const avgScores = labels.map(month => {
        const scores = monthlyData[month];
        return (scores.reduce((a, b) => a + b, 0) / scores.length).toFixed(1);
      });

      chartInstance.current = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Observation Score %',
            data: avgScores,
            borderColor: '#F4B41A',
            backgroundColor: 'rgba(244, 180, 26, 0.1)',
            tension: 0.4,
            fill: true,
            pointBackgroundColor: '#F4B41A',
            pointRadius: 6
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: { display: true, text: 'Observation Score Trend', font: { size: 16, weight: 'bold' } },
            legend: { display: false }
          },
          scales: {
            y: { beginAtZero: true, max: 100, title: { display: true, text: 'Score %' } }
          }
        }
      });
    }

    return () => {
      if (chartInstance.current) {
        chartInstance.current.destroy();
      }
    };
  }, [observations]);

  // Generate PDF Report
  const generatePDF = async (observation) => {
    // Create a printable HTML for the observation
    const printWindow = window.open('', '_blank');
    
    const parameterRows = CLASSROOM_OBSERVATION_PARAMETERS.map(param => {
      const score = observation.responses?.[param.id] ?? 'N/A';
      const remark = observation.remarks?.[param.id] || '';
      const isFlagged = score !== param.maxScore;
      return `
        <tr style="border-bottom: 1px solid #eee; ${isFlagged ? 'background-color: #FEE2E2;' : ''}">
          <td style="padding: 8px; font-size: 12px;">${param.type === 'major' ? '‚≠ê' : 'üìå'} ${param.text}</td>
          <td style="padding: 8px; text-align: center; font-weight: bold; ${isFlagged ? 'color: #DC2626;' : 'color: #059669;'}">${score}/${param.maxScore}</td>
          <td style="padding: 8px; font-size: 11px; color: #666;">${remark}</td>
        </tr>
      `;
    }).join('');

    const mediaSection = observation.mediaLinks?.length > 0 ? `
      <div style="margin-top: 20px;">
        <h3 style="color: #1F2937; border-bottom: 2px solid #F4B41A; padding-bottom: 5px;">üì∏ Media Links</h3>
        <ul style="font-size: 12px;">
          ${observation.mediaLinks.map((link, i) => `<li><a href="${link}" target="_blank">Media ${i + 1}</a></li>`).join('')}
        </ul>
      </div>
    ` : '';

    printWindow.document.write(`
      <!DOCTYPE html>
      <html>
      <head>
        <title>Classroom Observation - ${observation.teacherName}</title>
        <style>
          @media print {
            @page { margin: 1cm; size: A4; }
            body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
          }
          body { font-family: Arial, sans-serif; padding: 20px; color: #333; }
          .header { display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 3px solid #F4B41A; padding-bottom: 15px; margin-bottom: 20px; }
          .logo { font-size: 24px; font-weight: bold; color: #F4B41A; }
          .score-box { background: linear-gradient(135deg, #F4B41A, #E8B039); color: white; padding: 15px 25px; border-radius: 10px; text-align: center; }
          .score-box .score { font-size: 32px; font-weight: bold; }
          .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
          .info-item { padding: 10px; background: #F9FAFB; border-radius: 8px; }
          .info-item label { font-size: 11px; color: #6B7280; text-transform: uppercase; }
          .info-item span { display: block; font-weight: bold; color: #1F2937; }
          table { width: 100%; border-collapse: collapse; margin-top: 15px; }
          th { background: #F4B41A; color: white; padding: 10px; text-align: left; }
          .flagged { background: #FEF2F2; }
          .footer { position: fixed; bottom: 0; left: 0; right: 0; padding: 10px 20px; font-size: 10px; border-top: 1px solid #ddd; display: flex; justify-content: space-between; }
        </style>
      </head>
      <body>
        <div class="header">
          <div>
            <div class="logo">‡§Ö‡§µ‡§Ç‡§§‡•Ä Avanti Fellows</div>
            <h1 style="margin: 10px 0 5px; font-size: 20px;">Classroom Observation Report</h1>
            <p style="margin: 0; color: #666;">Teacher: ${observation.teacherName} | ${observation.teacherSubject}</p>
          </div>
          <div class="score-box">
            <div class="score">${observation.totalScore}/${observation.maxScore}</div>
            <div style="font-size: 14px;">${observation.percentageScore}%</div>
            <div style="font-size: 12px; margin-top: 5px;">${observation.flaggedCount} flagged</div>
          </div>
        </div>

        <div class="info-grid">
          <div class="info-item">
            <label>School</label>
            <span>${observation.school}</span>
          </div>
          <div class="info-item">
            <label>Grade</label>
            <span>Class ${observation.grade}</span>
          </div>
          <div class="info-item">
            <label>Observation Date</label>
            <span>${new Date(observation.observationDate).toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' })} ${observation.observationTime}</span>
          </div>
          <div class="info-item">
            <label>Observer</label>
            <span>${observation.observerName} (${observation.observerPosition})</span>
          </div>
        </div>

        <h3 style="color: #1F2937; border-bottom: 2px solid #F4B41A; padding-bottom: 5px;">Observation Parameters</h3>
        <table>
          <thead>
            <tr>
              <th style="width: 60%;">Parameter</th>
              <th style="width: 15%;">Score</th>
              <th style="width: 25%;">Remarks</th>
            </tr>
          </thead>
          <tbody>
            ${parameterRows}
          </tbody>
        </table>

        ${observation.strengths ? `
          <div style="margin-top: 20px; background: #ECFDF5; padding: 15px; border-radius: 8px;">
            <h4 style="color: #059669; margin: 0 0 10px;">‚úÖ Strengths Observed</h4>
            <p style="margin: 0; font-size: 13px;">${observation.strengths}</p>
          </div>
        ` : ''}

        ${observation.improvements ? `
          <div style="margin-top: 15px; background: #FEF3C7; padding: 15px; border-radius: 8px;">
            <h4 style="color: #D97706; margin: 0 0 10px;">üí° Points of Improvement</h4>
            <p style="margin: 0; font-size: 13px;">${observation.improvements}</p>
          </div>
        ` : ''}

        ${mediaSection}

        <div class="footer">
          <span>Private & Confidential</span>
          <span>Page 1</span>
        </div>
      </body>
      </html>
    `);

    printWindow.document.close();
    setTimeout(() => {
      printWindow.print();
    }, 500);
  };

  if (loading) {
    return (
      <div className="modal-overlay" onClick={onClose}>
        <div className="modal-content" onClick={e => e.stopPropagation()}>
          <div className="p-12 text-center">
            <div className="text-4xl mb-4">‚è≥</div>
            <p>Loading teacher profile...</p>
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className="modal-overlay" onClick={onClose}>
      <div className="modal-content max-w-5xl max-h-[95vh] overflow-y-auto" onClick={e => e.stopPropagation()}>
        <div className="p-6">
          {/* Header */}
          <div className="flex justify-between items-start mb-6">
            <div>
              <h2 className="text-2xl font-bold">üë§ Teacher Profile</h2>
              <p className="text-xl text-gray-700 mt-1">{teacher.name}</p>
              <p className="text-gray-500">{teacher.subject} | {teacher.school}</p>
              <div className="flex gap-3 mt-2">
                <span className="px-3 py-1 bg-gray-100 text-gray-700 rounded-lg text-sm font-mono">AFID: {teacher.afid}</span>
                {teacher.afCode && <span className="px-3 py-1 bg-blue-100 text-blue-700 rounded-lg text-sm font-mono">AF Code: {teacher.afCode}</span>}
              </div>
            </div>
            <button onClick={onClose} className="text-3xl font-bold text-gray-400 hover:text-gray-600">√ó</button>
          </div>

          {/* Overall Stats Cards */}
          <div className="grid md:grid-cols-3 gap-4 mb-6">
            <div className="bg-gradient-to-r from-yellow-400 to-orange-500 text-white p-4 rounded-xl">
              <div className="text-sm opacity-90">Total Observations</div>
              <div className="text-3xl font-bold">{observations.length}</div>
            </div>
            <div className="bg-gradient-to-r from-green-400 to-green-600 text-white p-4 rounded-xl">
              <div className="text-sm opacity-90">Avg Observation Score</div>
              <div className="text-3xl font-bold">
                {observations.length > 0 
                  ? (observations.reduce((sum, o) => sum + o.percentageScore, 0) / observations.length).toFixed(1) + '%'
                  : 'N/A'}
              </div>
            </div>
            <div className="bg-gradient-to-r from-blue-400 to-blue-600 text-white p-4 rounded-xl">
              <div className="text-sm opacity-90">Student Feedback Rating</div>
              <div className="text-3xl font-bold">{overallRating || 'N/A'}/5</div>
              <div className="text-xs opacity-75">{feedbackData.length} responses</div>
            </div>
          </div>

          {/* Observation Trend Chart */}
          {observations.length > 0 && (
            <div className="bg-white p-4 rounded-xl shadow mb-6">
              <div style={{ height: '250px' }}>
                <canvas ref={chartRef}></canvas>
              </div>
            </div>
          )}

          {/* Classroom Observations Section */}
          <div className="bg-white p-6 rounded-xl shadow mb-6">
            <div className="flex justify-between items-center mb-4">
              <h3 className="text-xl font-bold">üìã Classroom Observations</h3>
              <select 
                value={selectedMonth} 
                onChange={e => setSelectedMonth(e.target.value)}
                className="border-2 px-4 py-2 rounded-xl"
              >
                <option value="All">All Months</option>
                {availableMonths.map(month => (
                  <option key={month} value={month}>
                    {new Date(month + '-01').toLocaleDateString('en-IN', { month: 'long', year: 'numeric' })}
                  </option>
                ))}
              </select>
            </div>

            {filteredObservations.length === 0 ? (
              <div className="text-center py-8 text-gray-500">
                <div className="text-4xl mb-2">üìã</div>
                <p>No classroom observations recorded yet</p>
              </div>
            ) : (
              <div className="space-y-3">
                {filteredObservations.map(obs => (
                  <div key={obs.id} className="border-2 rounded-xl p-4 hover:border-yellow-400 cursor-pointer transition" onClick={() => setSelectedObservation(obs)}>
                    <div className="flex justify-between items-center">
                      <div>
                        <div className="font-bold">
                          {new Date(obs.observationDate || obs.submittedAt).toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' })}
                          <span className="text-gray-500 font-normal ml-2">Class {obs.grade}</span>
                        </div>
                        <div className="text-sm text-gray-500">Observer: {obs.observerName}</div>
                      </div>
                      <div className="text-right">
                        <div className={`text-2xl font-bold ${
                          obs.percentageScore >= 80 ? 'text-green-600' : 
                          obs.percentageScore >= 60 ? 'text-yellow-600' : 'text-red-600'
                        }`}>
                          {obs.percentageScore}%
                        </div>
                        <div className="text-sm text-gray-500">{obs.totalScore}/{obs.maxScore}</div>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>

          {/* Student Feedback Summary */}
          <div className="bg-white p-6 rounded-xl shadow">
            <h3 className="text-xl font-bold mb-4">üí¨ Student Feedback Summary</h3>
            
            {!feedbackAverages ? (
              <div className="text-center py-8 text-gray-500">
                <div className="text-4xl mb-2">üí¨</div>
                <p>No student feedback received yet</p>
              </div>
            ) : (
              <div className="grid md:grid-cols-3 gap-4">
                {Object.entries(feedbackAverages).map(([qId, data]) => (
                  <div key={qId} className="bg-gray-50 p-3 rounded-lg">
                    <div className="text-sm text-gray-600 mb-1">{data.label}</div>
                    <div className="flex items-center justify-between">
                      <span className={`text-xl font-bold ${
                        parseFloat(data.average) >= 8 ? 'text-green-600' :
                        parseFloat(data.average) >= 6 ? 'text-yellow-600' : 'text-red-600'
                      }`}>
                        {data.average}/5
                      </span>
                      <span className="text-xs text-gray-400">({data.count} ratings)</span>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>
        </div>
      </div>

      {/* Observation Detail Modal */}
      {selectedObservation && (
        <div className="modal-overlay" style={{ zIndex: 1001 }} onClick={() => setSelectedObservation(null)}>
          <div className="modal-content max-w-3xl max-h-[90vh] overflow-y-auto" onClick={e => e.stopPropagation()}>
            <div className="p-6">
              <div className="flex justify-between items-start mb-4">
                <div>
                  <h3 className="text-xl font-bold">Observation Details</h3>
                  <p className="text-gray-500">
                    {new Date(selectedObservation.observationDate).toLocaleDateString('en-IN', { weekday: 'long', day: '2-digit', month: 'long', year: 'numeric' })}
                  </p>
                </div>
                <div className="flex gap-2">
                  <button onClick={() => generatePDF(selectedObservation)} className="px-4 py-2 bg-blue-600 text-white rounded-lg font-semibold">
                    üìÑ Download PDF
                  </button>
                  <button onClick={() => setSelectedObservation(null)} className="text-2xl font-bold text-gray-400">√ó</button>
                </div>
              </div>

              <div className={`p-4 rounded-xl mb-4 ${
                selectedObservation.percentageScore >= 80 ? 'bg-green-100' :
                selectedObservation.percentageScore >= 60 ? 'bg-yellow-100' : 'bg-red-100'
              }`}>
                <div className="text-center">
                  <div className="text-3xl font-bold">{selectedObservation.totalScore}/{selectedObservation.maxScore}</div>
                  <div className="text-xl">{selectedObservation.percentageScore}%</div>
                  <div className="text-sm text-gray-600">{selectedObservation.flaggedCount} items flagged</div>
                </div>
              </div>

              <div className="space-y-2 mb-4">
                {CLASSROOM_OBSERVATION_PARAMETERS.map(param => {
                  const score = selectedObservation.responses?.[param.id];
                  const remark = selectedObservation.remarks?.[param.id];
                  const isFlagged = score !== undefined && score < param.maxScore;
                  
                  return (
                    <div key={param.id} className={`p-3 rounded-lg ${isFlagged ? 'bg-red-50' : 'bg-green-50'}`}>
                      <div className="flex justify-between items-start">
                        <div className="flex-1 text-sm">{param.text}</div>
                        <div className={`font-bold ml-2 ${isFlagged ? 'text-red-600' : 'text-green-600'}`}>
                          {score ?? 'N/A'}/{param.maxScore}
                        </div>
                      </div>
                      {remark && <div className="text-xs text-red-600 mt-1">üìù {remark}</div>}
                    </div>
                  );
                })}
              </div>

              {selectedObservation.strengths && (
                <div className="bg-green-50 p-4 rounded-xl mb-3">
                  <h4 className="font-bold text-green-700 mb-2">‚úÖ Strengths</h4>
                  <p className="text-sm">{selectedObservation.strengths}</p>
                </div>
              )}

              {selectedObservation.improvements && (
                <div className="bg-yellow-50 p-4 rounded-xl mb-3">
                  <h4 className="font-bold text-yellow-700 mb-2">üí° Improvements</h4>
                  <p className="text-sm">{selectedObservation.improvements}</p>
                </div>
              )}

              <div className="text-sm text-gray-500 mt-4">
                Observer: {selectedObservation.observerName} ({selectedObservation.observerPosition}) | 
                Submitted: {new Date(selectedObservation.submittedAt).toLocaleString('en-IN')}
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}


// ========================================
// TEACHER FEEDBACK COMPONENTS
// ========================================

// Star Rating Component
function StarRating({ value, onChange, readonly = false }) {
  const [hoverValue, setHoverValue] = useState(0);
  
  return (
    <div className="star-rating">
      {[1, 2, 3, 4, 5, 6, 7, 8, 9, 10].map(star => (
        <span
          key={star}
          className={`star ${(hoverValue || value) >= star ? 'filled' : ''}`}
          onClick={() => !readonly && onChange(star)}
          onMouseEnter={() => !readonly && setHoverValue(star)}
          onMouseLeave={() => !readonly && setHoverValue(0)}
        >
          ‚òÖ
        </span>
      ))}
    </div>
  );
}

// Teacher Profile Modal  
function TeacherProfileModal({ teacher, onClose, onGiveFeedback, averageRating }) {
  return (
    <div className="modal-overlay" onClick={onClose}>
      <div className="modal-content max-w-md" onClick={e => e.stopPropagation()}>
        <div className="p-6">
          <div className="flex justify-between items-start mb-4">
            <div className="flex items-center gap-4">
              {teacher.profilePhoto ? (
                <img src={teacher.profilePhoto} alt={teacher.name} className="w-16 h-16 rounded-full object-cover border-2 border-yellow-400"/>
              ) : (
                <div className="w-16 h-16 rounded-full bg-gradient-to-br from-yellow-400 to-orange-500 flex items-center justify-center text-2xl font-bold text-white">
                  {teacher.name?.charAt(0) || '?'}
                </div>
              )}
              <div>
                <h2 className="text-xl font-bold">{teacher.name}</h2>
                <p className="text-gray-600">{teacher.subject}</p>
              </div>
            </div>
            <button onClick={onClose} className="text-2xl font-bold text-gray-500 hover:text-gray-700">
              √ó
            </button>
          </div>
          
          <div className="space-y-3">
            <div className="bg-gray-50 p-3 rounded-lg">
              <div className="text-sm text-gray-500">Education Qualification</div>
              <div className="font-semibold">{teacher.qualification || 'Not specified'}</div>
            </div>
            
            <div className="bg-gray-50 p-3 rounded-lg">
              <div className="text-sm text-gray-500">Experience</div>
              <div className="font-semibold">{teacher.experience || 'Not specified'}</div>
            </div>

            {teacher.phone && (
              <div className="bg-gray-50 p-3 rounded-lg">
                <div className="text-sm text-gray-500">Phone</div>
                <a href={`tel:${teacher.phone}`} className="font-semibold text-blue-600 hover:underline">
                  üì± {teacher.phone}
                </a>
              </div>
            )}

            {teacher.whatsapp && (
              <div className="bg-gray-50 p-3 rounded-lg">
                <div className="text-sm text-gray-500">WhatsApp</div>
                <a href={`https://wa.me/${teacher.whatsapp.replace(/[^0-9]/g, '')}`} target="_blank" rel="noopener noreferrer" className="font-semibold text-green-600 hover:underline">
                  üí¨ {teacher.whatsapp}
                </a>
              </div>
            )}

            {teacher.driveLink && (
              <div className="bg-blue-50 p-3 rounded-lg border border-blue-200">
                <div className="text-sm text-gray-500">üìÅ Google Drive Folder</div>
                <a href={teacher.driveLink} target="_blank" rel="noopener noreferrer" className="font-semibold text-blue-600 hover:underline">
                  üìÇ Open Teaching Resources ‚Üí
                </a>
              </div>
            )}

            {teacher.bio && (
              <div className="bg-gray-50 p-3 rounded-lg">
                <div className="text-sm text-gray-500">About</div>
                <div className="font-semibold text-sm">{teacher.bio}</div>
              </div>
            )}
            
            <div className="bg-yellow-50 p-3 rounded-lg border border-yellow-200">
              <div className="text-sm text-gray-500 mb-1">Average Rating</div>
              <div className="flex items-center gap-3">
                <span className="text-2xl font-bold text-yellow-500">
                  {averageRating ? averageRating.toFixed(1) : 'N/A'}
                </span>
                <span className="text-gray-600">/ 5</span>
                {averageRating && (
                  <span className={`px-2 py-1 rounded-full text-xs font-bold ${
                    averageRating >= 4.5 ? 'bg-green-100 text-green-700' :
                    averageRating >= 3.5 ? 'bg-blue-100 text-blue-700' :
                    averageRating >= 2.5 ? 'bg-yellow-100 text-yellow-700' : 'bg-red-100 text-red-700'
                  }`}>
                    {averageRating >= 4.5 ? '‚≠ê Excellent' :
                     averageRating >= 3.5 ? 'üëç Good' :
                     averageRating >= 2.5 ? 'üòê Average' : 'üëé Needs Improvement'}
                  </span>
                )}
              </div>
            </div>
            
            <button
              onClick={onGiveFeedback}
              className="w-full avanti-gradient text-white py-3 rounded-xl font-bold text-lg hover:opacity-90"
            >
              üìù Give Feedback
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}

// ========================================
// MONTHLY FEEDBACK TREND GRAPH
// Simple line chart showing monthly average ratings
// ========================================
function MonthlyFeedbackTrendGraph({ feedbackData = [] }) {
  const chartRef = useRef(null);
  const chartInstance = useRef(null);

  // Calculate monthly average ratings
  const monthlyData = useMemo(() => {
    const now = new Date();
    const months = [];
    
    // Get last 6 months
    for (let i = 5; i >= 0; i--) {
      const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
      months.push({
        key: `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`,
        label: date.toLocaleDateString('en-IN', { month: 'short', year: '2-digit' }),
        totalRating: 0,
        count: 0,
        avgRating: 0
      });
    }

    // Calculate feedback ratings by month
    feedbackData.forEach(fb => {
      if (fb.submittedAt) {
        const date = fb.submittedAt instanceof Date ? fb.submittedAt : new Date(fb.submittedAt);
        const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
        const monthData = months.find(m => m.key === monthKey);
        
        if (monthData) {
          // Use the rating field directly (1-5 scale)
          const rating = fb.rating || fb.averageRating || 0;
          if (rating > 0) {
            monthData.totalRating += rating;
            monthData.count++;
          }
        }
      }
    });

    // Calculate averages
    months.forEach(month => {
      if (month.count > 0) {
        month.avgRating = (month.totalRating / month.count).toFixed(1);
      }
    });

    return months;
  }, [feedbackData]);

  // Create/update chart
  useEffect(() => {
    if (chartInstance.current) {
      chartInstance.current.destroy();
    }

    if (chartRef.current && monthlyData.length > 0) {
      const ctx = chartRef.current.getContext('2d');
      
      chartInstance.current = new Chart(ctx, {
        type: 'line',
        data: {
          labels: monthlyData.map(m => m.label),
          datasets: [
            {
              label: 'Avg Rating (out of 5)',
              data: monthlyData.map(m => m.avgRating > 0 ? parseFloat(m.avgRating) : null),
              borderColor: '#8B5CF6',
              backgroundColor: 'rgba(139, 92, 246, 0.1)',
              tension: 0.4,
              fill: true,
              pointBackgroundColor: '#8B5CF6',
              pointRadius: 6,
              pointHoverRadius: 8,
              spanGaps: true,
              borderWidth: 3
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            mode: 'index',
            intersect: false
          },
          plugins: {
            title: { 
              display: true, 
              text: 'üìà Monthly Average Feedback Rating', 
              font: { size: 16, weight: 'bold' },
              padding: { bottom: 20 }
            },
            legend: { 
              display: false
            },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              titleFont: { size: 14 },
              bodyFont: { size: 13 },
              padding: 12,
              callbacks: {
                label: function(context) {
                  const monthData = monthlyData[context.dataIndex];
                  return [
                    `Average Rating: ${context.raw}/5`,
                    `Total Responses: ${monthData.count}`
                  ];
                }
              }
            },
            datalabels: {
              display: true,
              anchor: 'end',
              align: 'top',
              color: '#8B5CF6',
              font: { weight: 'bold', size: 12 },
              formatter: function(value) {
                return value ? value : '';
              }
            }
          },
          scales: {
            y: { 
              beginAtZero: true, 
              max: 5,
              title: { 
                display: true, 
                text: 'Average Rating',
                font: { weight: 'bold' }
              },
              ticks: {
                stepSize: 1
              }
            },
            x: {
              title: { 
                display: true, 
                text: 'Month',
                font: { weight: 'bold' }
              }
            }
          }
        },
        plugins: [ChartDataLabels]
      });
    }

    return () => {
      if (chartInstance.current) {
        chartInstance.current.destroy();
      }
    };
  }, [monthlyData]);

  // Calculate summary stats
  const totalResponses = monthlyData.reduce((sum, m) => sum + m.count, 0);
  const monthsWithData = monthlyData.filter(m => m.count > 0);
  const overallAvg = monthsWithData.length > 0 
    ? (monthsWithData.reduce((sum, m) => sum + parseFloat(m.avgRating), 0) / monthsWithData.length).toFixed(1)
    : 'N/A';

  if (feedbackData.length === 0) {
    return null;
  }

  return (
    <div className="bg-white p-6 rounded-2xl shadow-lg">
      <div style={{ height: '280px' }}>
        <canvas ref={chartRef}></canvas>
      </div>
      <div className="grid grid-cols-3 gap-4 mt-4 pt-4 border-t">
        <div className="text-center">
          <div className="text-2xl font-bold text-purple-600">{overallAvg}</div>
          <div className="text-xs text-gray-600">6-Month Avg Rating</div>
        </div>
        <div className="text-center">
          <div className="text-2xl font-bold text-blue-600">{totalResponses}</div>
          <div className="text-xs text-gray-600">Total Responses</div>
        </div>
        <div className="text-center">
          <div className="text-2xl font-bold text-green-600">
            {monthlyData[monthlyData.length - 1]?.count || 0}
          </div>
          <div className="text-xs text-gray-600">This Month</div>
        </div>
      </div>
    </div>
  );
}

// Teacher Feedback Form Modal
function TeacherFeedbackForm({ teacher, studentId, studentInfo, onClose, onSubmitSuccess }) {
  const [currentQuestion, setCurrentQuestion] = useState(0);
  const [feedback, setFeedback] = useState({
    teacherId: teacher.afid || teacher.docId,
    teacherDocId: teacher.docId,
    teacherAfid: teacher.afid,
    teacherName: teacher.name,
    subject: teacher.subject,
    school: teacher.school,
    grade: studentInfo?.grade || '',
    studentId: studentId,
    studentName: studentInfo?.name || '',
    submittedAt: new Date().toISOString(),
    responses: {}
  });
  const [showExplanation, setShowExplanation] = useState(false);

  const questions = [
    { 
      id: 'q1', 
      text: 'Does the teacher start and end the class on time?', 
      type: 'mcq',
      options: [
        { value: 'a', text: 'The teacher is always on time and ends the class on time.', rating: 5 },
        { value: 'b', text: 'The teacher is sometimes late or does not end the class on time.', rating: 3 },
        { value: 'c', text: 'The teacher is mostly late / early and ends class early / late.', rating: 1 },
        { value: 'other', text: 'Other (please specify)', rating: null }
      ]
    },
    { 
      id: 'q2', 
      text: 'What is the academic / content level of the teacher?', 
      type: 'mcq',
      options: [
        { value: 'a', text: 'The teacher can teach concepts up to the JEE Advanced curriculum.', rating: 5 },
        { value: 'b', text: 'The teacher can teach concepts up to the JEE Mains/NEET curriculum.', rating: 3 },
        { value: 'c', text: 'The teacher can teach concepts up to the CBSE curriculum.', rating: 1 },
        { value: 'other', text: 'Other (please specify)', rating: null }
      ]
    },
    { 
      id: 'q3', 
      text: 'How effectively does the teacher solve problems and clear doubts in class?', 
      type: 'mcq',
      options: [
        { value: 'a', text: 'The teacher regularly solves mock tests/PYQs in class and clears all doubts.', rating: 5 },
        { value: 'b', text: 'The teacher sometimes solves questions and clears some doubts.', rating: 3 },
        { value: 'c', text: 'The teacher rarely solves questions or clears doubts.', rating: 1 },
        { value: 'other', text: 'Other (please specify)', rating: null }
      ]
    },
    { 
      id: 'q4', 
      text: 'How clear and easy is the teacher\'s explanation and use of language during class?', 
      type: 'mcq',
      options: [
        { value: 'a', text: 'The teacher speaks clearly and explains concepts in an easy-to-understand way.', rating: 5 },
        { value: 'b', text: 'The teacher is clear sometimes and a bit confusing.', rating: 3 },
        { value: 'c', text: 'It\'s hard to understand the teacher\'s language or explanation.', rating: 1 },
        { value: 'other', text: 'Other (please specify)', rating: null }
      ]
    },
    { 
      id: 'q5', 
      text: 'Is the teacher\'s handwriting clear and voice clearly audible during the session?', 
      type: 'mcq',
      options: [
        { value: 'a', text: 'The teacher\'s writing is always clear and voice is always audible.', rating: 5 },
        { value: 'b', text: 'The writing or voice is unclear sometimes.', rating: 3 },
        { value: 'c', text: 'It\'s hard to read the writing and hear the teacher properly.', rating: 1 },
        { value: 'other', text: 'Other (please specify)', rating: null }
      ]
    },
    { 
      id: 'q6', 
      text: 'Does the teacher manage time well and teach at an appropriate speed?', 
      type: 'mcq',
      options: [
        { value: 'a', text: 'The teacher finishes the topic on time and teaches at a good pace.', rating: 5 },
        { value: 'b', text: 'The speed varies to a small extent.', rating: 3 },
        { value: 'c', text: 'The speed is too fast or too slow, so it\'s hard to understand.', rating: 1 },
        { value: 'other', text: 'Other (please specify)', rating: null }
      ]
    },
    { 
      id: 'q7', 
      text: 'Does the teacher provide guidance and motivation related to exams and careers?', 
      type: 'mcq',
      options: [
        { value: 'a', text: 'The teacher gives useful exam/career guidance and motivates the class often.', rating: 5 },
        { value: 'b', text: 'The teacher sometimes gives guidance and motivation.', rating: 3 },
        { value: 'c', text: 'The teacher doesn\'t guide the class and demotivates the students.', rating: 1 },
        { value: 'other', text: 'Other (please specify)', rating: null }
      ]
    },
    { 
      id: 'q8', 
      text: 'How well does the teacher encourage students to participate and ask questions in class?', 
      type: 'mcq',
      options: [
        { value: 'a', text: 'The teacher always encourages us to ask questions and take part in class.', rating: 5 },
        { value: 'b', text: 'The teacher sometimes asks us to participate or share doubts.', rating: 3 },
        { value: 'c', text: 'The teacher doesn\'t ask us to participate or think deeply.', rating: 1 },
        { value: 'other', text: 'Other (please specify)', rating: null }
      ]
    },
    { 
      id: 'q9', 
      text: 'Does the teacher give equal attention to all students?', 
      type: 'mcq',
      options: [
        { value: 'a', text: 'The teacher gives equal attention to everyone in class.', rating: 5 },
        { value: 'b', text: 'The teacher gives attention to some students more than others.', rating: 3 },
        { value: 'c', text: 'The teacher is often biased and does not give equal attention to everyone.', rating: 1 },
        { value: 'other', text: 'Other (please specify)', rating: null }
      ]
    },
    { id: 'q10', text: `What did you like most about the class or ${teacher.name}?`, type: 'opentext' },
    { id: 'q11', text: `What can be improved about the class or ${teacher.name}?`, type: 'opentext' }
  ];

  const currentQ = questions[currentQuestion];

  const handleRatingChange = (value) => {
    setFeedback({
      ...feedback,
      responses: {
        ...feedback.responses,
        [currentQ.id]: { rating: value }
      }
    });
    setShowExplanation(value < 3);
  };

  const handleMCQChange = (option) => {
    const newResponse = {
      selectedOption: option.value,
      selectedText: option.text,
      rating: option.rating // null if 'other' selected
    };
    
    setFeedback({
      ...feedback,
      responses: {
        ...feedback.responses,
        [currentQ.id]: newResponse
      }
    });
    
    // Show explanation field if 'other' is selected
    setShowExplanation(option.value === 'other');
  };

  const handleOtherTextChange = (text) => {
    setFeedback({
      ...feedback,
      responses: {
        ...feedback.responses,
        [currentQ.id]: {
          ...feedback.responses[currentQ.id],
          otherText: text
        }
      }
    });
  };

  const handleYesNoChange = (value) => {
    setFeedback({
      ...feedback,
      responses: {
        ...feedback.responses,
        [currentQ.id]: { answer: value }
      }
    });
    setShowExplanation(value === 'No');
  };

  const handleOpenTextChange = (text) => {
    setFeedback({
      ...feedback,
      responses: {
        ...feedback.responses,
        [currentQ.id]: { text: text }
      }
    });
  };

  const handleExplanationChange = (text) => {
    setFeedback({
      ...feedback,
      responses: {
        ...feedback.responses,
        [currentQ.id]: {
          ...feedback.responses[currentQ.id],
          explanation: text
        }
      }
    });
  };

  const canProceed = () => {
    const response = feedback.responses[currentQ.id];
    if (!response) return false;
    
    if (currentQ.type === 'mcq') {
      if (!response.selectedOption) return false;
      // If 'other' is selected, require the otherText field
      if (response.selectedOption === 'other' && (!response.otherText || response.otherText.trim() === '')) return false;
    } else if (currentQ.type === 'rating') {
      if (!response.rating) return false;
      if (response.rating < 3 && !response.explanation) return false;
    } else if (currentQ.type === 'yesno') {
      if (!response.answer) return false;
      if (response.answer === 'No' && !response.explanation) return false;
    } else if (currentQ.type === 'opentext') {
      if (!response.text || response.text.trim() === '') return false;
    }
    return true;
  };

  const handleNext = () => {
    if (currentQuestion < questions.length - 1) {
      setCurrentQuestion(currentQuestion + 1);
      const nextQ = questions[currentQuestion + 1];
      const nextResponse = feedback.responses[nextQ.id];
      if (nextQ.type === 'mcq') {
        setShowExplanation(nextResponse?.selectedOption === 'other');
      } else if (nextQ.type === 'rating') {
        setShowExplanation(nextResponse?.rating < 3);
      } else if (nextQ.type === 'yesno') {
        setShowExplanation(nextResponse?.answer === 'No');
      } else if (nextQ.type === 'opentext') {
        setShowExplanation(false);
      }
    }
  };

  const handlePrevious = () => {
    if (currentQuestion > 0) {
      setCurrentQuestion(currentQuestion - 1);
      const prevQ = questions[currentQuestion - 1];
      const prevResponse = feedback.responses[prevQ.id];
      if (prevQ.type === 'mcq') {
        setShowExplanation(prevResponse?.selectedOption === 'other');
      } else if (prevQ.type === 'rating') {
        setShowExplanation(prevResponse?.rating < 3);
      } else if (prevQ.type === 'yesno') {
        setShowExplanation(prevResponse?.answer === 'No');
      } else if (prevQ.type === 'opentext') {
        setShowExplanation(false);
      }
    }
  };

  // ‚úÖ FIX: State to prevent double-tap submission
  const [isSubmitting, setIsSubmitting] = useState(false);

  const handleSubmit = async () => {
    // ‚úÖ FIX: Prevent double-tap submission on slow networks
    if (isSubmitting) {
      console.log('Already submitting feedback, please wait...');
      return;
    }
    setIsSubmitting(true);
    
    try {
      let totalRating = 0;
      let ratingCount = 0;
      
      // Calculate average from MCQ responses (only those with valid ratings, not 'other')
      Object.values(feedback.responses).forEach(response => {
        // For MCQ questions, use the rating from the selected option (if not 'other')
        if (response.rating !== null && response.rating !== undefined) {
          totalRating += response.rating;
          ratingCount++;
        }
      });
      
      const averageRating = ratingCount > 0 ? totalRating / ratingCount : 0;

      // ‚úÖ FIX: Create unique document ID to prevent duplicates
      const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD format
      const teacherId = teacher.afid || teacher.id || 'unknown';
      const uniqueDocId = `${studentId}_${teacherId}_${today}`;

      const feedbackData = {
        ...feedback,
        averageRating: averageRating, // Now on 1-5 scale
        maxRating: 5, // Store max rating for reference
        completedAt: new Date().toISOString(),
        submittedAt: firebase.firestore.FieldValue.serverTimestamp(),
        uniqueId: uniqueDocId
      };

      // ‚úÖ FIX: Use set() with unique ID instead of add() - prevents duplicates!
      await db.collection('teacherFeedback').doc(uniqueDocId).set(feedbackData, { merge: true });
      
      await db.collection('studentProfiles').doc(studentId).set({
        lastFeedbackDate: new Date().toISOString()
      }, { merge: true });

      alert('‚úÖ Feedback submitted successfully! Thank you for your input.');
      onSubmitSuccess();
      onClose();
    } catch (error) {
      console.error('Error submitting feedback:', error);
      alert('‚ùå Failed to submit feedback. Please check your internet and try again.');
    } finally {
      setIsSubmitting(false);
    }
  };

  return (
    <div className="feedback-modal" onClick={onClose}>
      <div className="feedback-content" onClick={e => e.stopPropagation()}>
        <div className="p-6">
          <div className="flex justify-between items-start mb-4">
            <div>
              <h2 className="text-2xl font-bold">Feedback for {teacher.name}</h2>
              <p className="text-gray-600">{teacher.subject}</p>
            </div>
            <button onClick={onClose} className="text-2xl font-bold text-gray-500 hover:text-gray-700">
              √ó
            </button>
          </div>

          <div className="mb-6">
            <div className="flex justify-between items-center mb-2">
              <span className="text-sm font-semibold text-gray-600">
                Question {currentQuestion + 1} of {questions.length}
              </span>
              <span className="text-sm text-gray-500">
                {Math.round(((currentQuestion + 1) / questions.length) * 100)}% Complete
              </span>
            </div>
            <div className="w-full bg-gray-200 rounded-full h-2">
              <div 
                className="avanti-gradient h-2 rounded-full transition-all duration-300"
                style={{ width: `${((currentQuestion + 1) / questions.length) * 100}%` }}
              ></div>
            </div>
          </div>

          <div className="space-y-6">
            <div>
              <h3 className="text-lg font-semibold mb-4">{currentQ.text}</h3>
              
              {currentQ.type === 'rating' && (
                <div className="flex flex-col items-center gap-4">
                  <StarRating
                    value={feedback.responses[currentQ.id]?.rating || 0}
                    onChange={handleRatingChange}
                  />
                  <div className="text-center text-sm text-gray-600">
                    {feedback.responses[currentQ.id]?.rating || 0} / 5
                  </div>
                </div>
              )}

              {currentQ.type === 'mcq' && (
                <div className="space-y-3">
                  {currentQ.options.map((option, idx) => (
                    <button
                      key={option.value}
                      onClick={() => handleMCQChange(option)}
                      className={`w-full text-left p-4 rounded-xl border-2 transition-all ${
                        feedback.responses[currentQ.id]?.selectedOption === option.value
                          ? 'border-yellow-500 bg-yellow-50 shadow-md'
                          : 'border-gray-200 bg-white hover:border-yellow-300 hover:bg-yellow-25'
                      }`}
                    >
                      <div className="flex items-start gap-3">
                        <div className={`w-6 h-6 rounded-full border-2 flex items-center justify-center flex-shrink-0 mt-0.5 ${
                          feedback.responses[currentQ.id]?.selectedOption === option.value
                            ? 'border-yellow-500 bg-yellow-500'
                            : 'border-gray-300'
                        }`}>
                          {feedback.responses[currentQ.id]?.selectedOption === option.value && (
                            <span className="text-white text-sm">‚úì</span>
                          )}
                        </div>
                        <span className={`text-base ${
                          feedback.responses[currentQ.id]?.selectedOption === option.value
                            ? 'font-semibold text-gray-800'
                            : 'text-gray-700'
                        }`}>
                          {option.text}
                        </span>
                      </div>
                    </button>
                  ))}
                  
                  {/* Show text input when 'Other' is selected */}
                  {feedback.responses[currentQ.id]?.selectedOption === 'other' && (
                    <div className="mt-4">
                      <label className="block text-sm font-semibold mb-2 text-gray-700">
                        Please specify:
                      </label>
                      <textarea
                        value={feedback.responses[currentQ.id]?.otherText || ''}
                        onChange={(e) => handleOtherTextChange(e.target.value)}
                        className="w-full border-2 px-4 py-3 rounded-xl min-h-[80px] focus:border-yellow-500 focus:ring-2 focus:ring-yellow-200"
                        placeholder="Please describe your answer..."
                      />
                    </div>
                  )}
                </div>
              )}

              {currentQ.type === 'yesno' && (
                <div className="flex gap-4 justify-center">
                  <button
                    onClick={() => handleYesNoChange('Yes')}
                    className={`px-8 py-3 rounded-xl font-bold text-lg ${
                      feedback.responses[currentQ.id]?.answer === 'Yes'
                        ? 'bg-green-500 text-white'
                        : 'bg-gray-200 text-gray-700'
                    }`}
                  >
                    ‚úÖ Yes
                  </button>
                  <button
                    onClick={() => handleYesNoChange('No')}
                    className={`px-8 py-3 rounded-xl font-bold text-lg ${
                      feedback.responses[currentQ.id]?.answer === 'No'
                        ? 'bg-red-500 text-white'
                        : 'bg-gray-200 text-gray-700'
                    }`}
                  >
                    ‚ùå No
                  </button>
                </div>
              )}

              {currentQ.type === 'opentext' && (
                <div className="mt-2">
                  <textarea
                    value={feedback.responses[currentQ.id]?.text || ''}
                    onChange={(e) => handleOpenTextChange(e.target.value)}
                    className="w-full border-2 px-4 py-3 rounded-xl min-h-[120px] focus:border-yellow-500 focus:ring-2 focus:ring-yellow-200"
                    placeholder="Please share your thoughts here..."
                  />
                  <p className="text-sm text-gray-500 mt-2">Your feedback helps us improve!</p>
                </div>
              )}

              {showExplanation && currentQ.type !== 'mcq' && (
                <div className="mt-4">
                  <label className="block text-sm font-semibold mb-2 text-gray-700">
                    {currentQ.type === 'rating' 
                      ? 'Why do you feel it\'s low?' 
                      : 'Can you please explain why?'}
                  </label>
                  <textarea
                    value={feedback.responses[currentQ.id]?.explanation || ''}
                    onChange={(e) => handleExplanationChange(e.target.value)}
                    className="w-full border-2 px-4 py-3 rounded-xl min-h-[100px]"
                    placeholder="Please provide your explanation..."
                  />
                </div>
              )}
            </div>

            <div className="flex justify-between gap-3">
              <button
                onClick={handlePrevious}
                disabled={currentQuestion === 0}
                className="px-6 py-3 bg-gray-300 text-gray-700 rounded-xl font-semibold disabled:opacity-50 disabled:cursor-not-allowed"
              >
                ‚Üê Previous
              </button>
              
              {currentQuestion < questions.length - 1 ? (
                <button
                  onClick={handleNext}
                  disabled={!canProceed()}
                  className="px-6 py-3 avanti-gradient text-white rounded-xl font-semibold disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  Next ‚Üí
                </button>
              ) : (
                <button
                  onClick={handleSubmit}
                  disabled={!canProceed()}
                  className="px-6 py-3 bg-green-600 text-white rounded-xl font-semibold disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  ‚úì Submit Feedback
                </button>
              )}
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}

// Feedback Notification Component
function FeedbackNotification({ onClose, onGiveFeedback }) {
  return (
    <div className="feedback-notification">
      <div className="flex items-start gap-3">
        <div className="text-2xl">üìù</div>
        <div className="flex-1">
          <div className="font-bold text-lg mb-1">Time for Teacher Feedback!</div>
          <p className="text-sm mb-3">
            It\'s been 2 months since your last feedback. Please share your thoughts about your teachers.
          </p>
          <div className="flex gap-2">
            <button
              onClick={onGiveFeedback}
              className="px-4 py-2 bg-white text-gray-800 rounded-lg font-semibold text-sm hover:bg-gray-100"
            >
              Give Feedback Now
            </button>
            <button
              onClick={onClose}
              className="px-4 py-2 bg-transparent border-2 border-white text-white rounded-lg font-semibold text-sm hover:bg-white hover:text-gray-800"
            >
              Remind Later
            </button>
          </div>
        </div>
        <button onClick={onClose} className="text-xl font-bold text-white hover:text-gray-200">
          √ó
        </button>
      </div>
    </div>
  );
}


// ========================================
// STUDENT SYSTEM CONSTANTS (ADD THIS)
// ========================================
const CATEGORIES=['General','General EWS','OBC','SC','ST','PWD'];
const STREAMS=['JEE','NEET'];
const OCCUPATIONS=['Government Job','Private Job','Business','Farmer','Doctor','Engineer','Teacher','Self-Employed','Unemployed','Retired','Daily Wage Worker','Homemaker','Others'];
const EDUCATION_LEVELS=['1st to 5th Standard','6th to 10th Standard','11th to 12th Standard','Graduation - B.A.','Graduation - B.Sc.','Graduation - B.Com','Post Graduation - M.A.','Post Graduation - M.Sc.','Post Graduation - M.Com','Engineering - B.Tech/B.E.','Ph.D','Diploma','ITI','Others'];
const INCOME_RANGES=['Below ‚Çπ1 Lakh','‚Çπ1 - ‚Çπ2.5 Lakh','‚Çπ2.5 - ‚Çπ5 Lakh','‚Çπ5 - ‚Çπ10 Lakh','‚Çπ10 - ‚Çπ15 Lakh','‚Çπ15 - ‚Çπ25 Lakh','Above ‚Çπ25 Lakh'];
const EXAMS_12TH=['JEE Mains Session 1','JEE Mains Session 2','JEE Advanced','NEET UG','NDA','BITSAT','VITEEE','COMEDK','MHT CET','TS EAMCET','AP EAMCET','KCET','WBJEE'];
const EXAMS_11TH=['JEE Mains','JEE Advanced','NEET UG','KVPY','NTSE','Olympiads','BITSAT','VITEEE'];
const INDIAN_STATES=['Andhra Pradesh','Arunachal Pradesh','Assam','Bihar','Chhattisgarh','Goa','Gujarat','Haryana','Himachal Pradesh','Jharkhand','Karnataka','Kerala','Madhya Pradesh','Maharashtra','Manipur','Meghalaya','Mizoram','Nagaland','Odisha','Punjab','Rajasthan','Sikkim','Tamil Nadu','Telangana','Tripura','Uttar Pradesh','Uttarakhand','West Bengal'];
const STATE_DISTRICTS={
  'Andhra Pradesh':['Anantapur','Chittoor','East Godavari','Guntur','Krishna','Kurnool','Prakasam','Srikakulam','Visakhapatnam','Vizianagaram','West Godavari','YSR Kadapa'],
  'Madhya Pradesh':['Agar Malwa','Alirajpur','Anuppur','Ashoknagar','Balaghat','Barwani','Betul','Bhind','Bhopal','Burhanpur','Chhatarpur','Chhindwara','Damoh','Datia','Dewas','Dhar','Dindori','Guna','Gwalior','Harda','Hoshangabad','Indore','Jabalpur','Jhabua','Katni','Khandwa','Khargone','Mandla','Mandsaur','Morena','Narsinghpur','Neemuch','Panna','Raisen','Rajgarh','Ratlam','Rewa','Sagar','Satna','Sehore','Seoni','Shahdol','Shajapur','Sheopur','Shivpuri','Sidhi','Singrauli','Tikamgarh','Ujjain','Umaria','Vidisha'],
  'Maharashtra':['Ahmednagar','Akola','Amravati','Aurangabad','Beed','Bhandara','Buldhana','Chandrapur','Dhule','Gadchiroli','Gondia','Hingoli','Jalgaon','Jalna','Kolhapur','Latur','Mumbai City','Mumbai Suburban','Nagpur','Nanded','Nandurbar','Nashik','Osmanabad','Palghar','Parbhani','Pune','Raigad','Ratnagiri','Sangli','Satara','Sindhudurg','Solapur','Thane','Wardha','Washim','Yavatmal'],
  'Gujarat':['Ahmedabad','Amreli','Anand','Aravalli','Banaskantha','Bharuch','Bhavnagar','Botad','Chhota Udaipur','Dahod','Dang','Devbhoomi Dwarka','Gandhinagar','Gir Somnath','Jamnagar','Junagadh','Kheda','Kutch','Mahisagar','Mehsana','Morbi','Narmada','Navsari','Panchmahal','Patan','Porbandar','Rajkot','Sabarkantha','Surat','Surendranagar','Tapi','Vadodara','Valsad'],
  'Rajasthan':['Ajmer','Alwar','Banswara','Baran','Barmer','Bharatpur','Bhilwara','Bikaner','Bundi','Chittorgarh','Churu','Dausa','Dholpur','Dungarpur','Hanumangarh','Jaipur','Jaisalmer','Jalore','Jhalawar','Jhunjhunu','Jodhpur','Karauli','Kota','Nagaur','Pali','Pratapgarh','Rajsamand','Sawai Madhopur','Sikar','Sirohi','Sri Ganganagar','Tonk','Udaipur'],
  'Karnataka':['Bagalkot','Ballari','Belagavi','Bengaluru Rural','Bengaluru Urban','Bidar','Chamarajanagar','Chikkaballapur','Chikkamagaluru','Chitradurga','Dakshina Kannada','Davanagere','Dharwad','Gadag','Hassan','Haveri','Kalaburagi','Kodagu','Kolar','Koppal','Mandya','Mysuru','Raichur','Ramanagara','Shivamogga','Tumakuru','Udupi','Uttara Kannada','Vijayapura','Yadgir'],
  'Odisha':['Angul','Balangir','Balasore','Bargarh','Bhadrak','Boudh','Cuttack','Deogarh','Dhenkanal','Gajapati','Ganjam','Jagatsinghpur','Jajpur','Jharsuguda','Kalahandi','Kandhamal','Kendrapara','Kendujhar','Khordha','Koraput','Malkangiri','Mayurbhanj','Nabarangpur','Nayagarh','Nuapada','Puri','Rayagada','Sambalpur','Subarnapur','Sundargarh']
};
const AVANTI_LOGO = 'data:image/png;base64,UklGRkpLAABXRUJQVlA4WAoAAAAwAAAA2QIA+QAASUNDUMgBAAAAAAHIAAAAAAQwAABtbnRyUkdCIFhZWiAH4AABAAEAAAAAAABhY3NwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAA9tYAAQAAAADTLQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAlkZXNjAAAA8AAAACRyWFlaAAABFAAAABRnWFlaAAABKAAAABRiWFlaAAABPAAAABR3dHB0AAABUAAAABRyVFJDAAABZAAAAChnVFJDAAABZAAAAChiVFJDAAABZAAAAChjcHJ0AAABjAAAADxtbHVjAAAAAAAAAAEAAAAMZW5VUwAAAAgAAAAcAHMAUgBHAEJYWVogAAAAAAAAb6IAADj1AAADkFhZWiAAAAAAAABimQAAt4UAABjaWFlaIAAAAAAAACSgAAAPhAAAts9YWVogAAAAAAAA9tYAAQAAAADTLXBhcmEAAAAAAAQAAAACZmYAAPKnAAANWQAAE9AAAApbAAAAAAAAAABtbHVjAAAAAAAAAAEAAAAMZW5VUwAAACAAAAAcAEcAbwBvAGcAbABlACAASQBuAGMALgAgADIAMAAxADZBTFBI6R0AAAHwhu3/Iyf9/z1nd9MbGBJ6E6RJ70Uw0qTXhbdgeSN2DVWk+OYNKiBEVEAMKFUE6b33wFvjGwh9gSC9VyGkt9153JjZmdnXvGbG3VsRMQEUGOxoMWz+rosPs925D9N3zB5ciQLFg/utzoTai1PqBoKVmHQf2qb0EQK87COeQPuTnQO6ah2Db7dUCNwakA1fZ74TqDXKAwaXRQRkjQSbZysFYLV3M4K7jQKuYu6B2ay2gVZzwXBOQmBV5SKWkNs6oGou2H7yYgBV6FNNMjZPeatbu3ZdBo6ek5KhArfKB045ob54TXsHKbU1n+xShCMhAVOL1e2uQRo2/jlfAZaaFyG+cbch46bPX70j5eiJM64zJ9IeZVxbN2vSh31aVXL4426qKR4pkLZlZhd5w4cmJL594pwdF/PgS/ftw4vH93re5k+Lh8qivqR9jT3e8uubirJ9vt51H+zmpM4dWtfmJ+uo5k3y6ZBncrgQYRZqffjbLegxc+/El4L9YB+qmEc+rnZCDskmwN77u4O3oOfsbcOe93d9pexsmK8o9Dc58RWjqzj8IHh4M+0NwZ/1k6Kc2uR7YaoMrkUaWbnRx0RwM+O7pv6rXxWNIybHyuB7wwp/Y78HnL34eXk/1Voll4LZoNEyxfWNqV5yBnjs3tnL7o9arWQwsTpNgj8E43G89jv4fXP8c/6nxQruBzEjLJHg30YT9ekN8D13fnV/0w8KfiR2g1MldyIMJW7qU/Dfva6Rf2m8gr4MUZk7ADDZQErPzIExilua+ZMGeRNLsUQvuwHklDOKktNyYJziphf9Ry29pRPbkwFgnjGEjHkKY/X8Ut5fFOH2sokx+1EAhVWMoN8VGG/O5DD/EJ33MpMxqp0PYAn/6uyDMd9w+od+8fIZazQeQHENzoVPL4Jh763uD3rLy9vMBZ0HsJJrUZMyYeR54xz+n3Ki3EDmKEEEPHU5FnMbRn+8vt+Hzsj1YY/WA1jJr063YfyFE+3+nv/K9dBBHTfgrsGpsLkiTGHqC36emnJv64CWAVjCpxddMItisn+HTspM0sPzRUBRFR4NzYWJdIX7dT6WWaAHWgQgmT9hS2Auz9b050TnSHbpoloxkBvLmyqnYDYze/lxaIHEpQtaBuBzziQ8hvn0TBT8N7U9AJ7po5YHuBvMlfeKYEpXhfltaBMAxOuCtgJ4kyO272FWj5b227SUvKmPdgCO8SN0Hczr1Rr+GtoNYLU+KA1AQ16U+B/M7OPm/prGIvDUoY+3AczlROlTMLfZHf00tBZAO32EPQGehnGh4iWY3YLefprqOUCSPugHAIN4UPkqzG9RP/8MDQEu2/TRHMBmDlS+ATNc5PTP0G9AP33QJSA/UncVr8EcF/X2z0RdxnmHPmYC6KO3Mpdglgu7+mWoaSFG6eMVAD/qrOQZmOfcNn4ZGo2cGroIKwJO6Ss8FWb6WX2/jLADpyP1QKeBwiA92TfBXN+p5I+h+HvYEayHbQAq6ykZZvtcjCEIdd5J3nX88s2792//lbrqK2f5f3qovQc7I3XwK4C6+rGtgPne6+Be2SGrH0H1xVkvCf/o0FTgTC32lgGooJ+DMOPzuGZr+eUJERpf/U+cT6om6vb7tWvXrl2ZqMuf1q5duyiR6Slr1/6ayPzEtWsnJPJw+PZVP3ye6Mvv1srPS1R8FMhL9G1LX9TIMWV4n1uOLksewaf5c8v7IDoL/8RP9UHUeZjzwtZ8avnTI/g+d1qkZvSjf0FYB7N+tzSHeh8Do7d7aVZb9CuMgnnfb+dNxC4wvKykRrTPn9CiyMRhKW/s6Szhzssa9fYjRF+FqR/FGRrEFIrHCJrYr/sPVsDci1U5YzvHFLAmXAsa5zcYCLP/G2eoP2M4Gq9FbJ6foNwT04d/cUY4pd2dbTMTB/cbODjxq6WpWd6QXkEDWuIn2Azz/yiOL9RLmyerhlQhxY6mX16Ww+WyGjT2DwyGFVzDGeGYuqcLOgeRhjbnDRm4SqijlWnaXlBzN03lrdzc3NysNF0+zM3NfZym+LiaW2mqL+fmZqQxfyE391waP7NUZKYpPp0rez9N4XU1p9O0/EiL2EeWAD35Ql1UiHtfCyWtI9bK4GCQOq2bqfmC+B2sZhSZzwMq9pCPh6iJI0YXwxrejOQLpSrJm/0C+VJYK4M5/oi2okXATM508FYwpyz5OOaBjNjT/2A/BatYVJsvdEjGvagi+X68DB4853f4BNZxL2faSnbWJRYrymGhv6HEYwuBHnyhfbjVhxi9Iueu72eYCSt5wcGXVquiiNVtcljvX6hcYCnwAV9YXuTFU82vsATW8m6YQSV7QZI/obbbYuAzg1rs7ZbgR1gFq/kowpi2ekNj/0Ftt+XAWGO6oGCs/2A1rOfDMCOK8SjY4DdoCyv6iRH1h8KL/oIK+ZbkusOA1ikpFPwEJYstCQYYT+ViJXjOTzAW1jTVeJZAcUX/gP2mRUFTo2njUVbZP9ALVnWxwcRchvJY/8Auy5Jb0lAc26E8z+YXqOyxLEg0EvtyqDxDfoH/wrqeMJDQDVA73y8gXLUwqG8YFY9BdX+/QBtY2W+MYuATqM4ONxD7c1UaJvR6bciHoydMnPTltMH/JPxoabJshlBlEzRcQAYQ0WTg+J93nLrvhsqcuH8O7A8tDUYZQMmkPGjoeZFzQv2Rq9Ld0HrGPwevwNre5V78tGfQdAXxzJYw/wF8mhVrbI5afRInTmf9Bq9+tDh3BK5FJywtgLa5VTgW//lV+HyKgYW/uSED+ueHcMfioBmvynT5fN1lEZqPJW7Ff58DBp+VMKrYbzLBRX40htX9kj9Cdee0Xffh21QHr4LGZYLNScYkfPwMnOTHJMtzgiuOhkNmHc6E7zMqE6dqHwerT6KNKH4/uMmPPy2PWJonoZfB5uvEKWcW2J1gQC9eg+mIKbY8eJ0n1FFkYhlxapgHDD+ONJxGT2A++sD6LuUK/cpCaiinEsH2Z0ZT52+YkNkW6DpbkUNb+Sjub9+llSA+9fQw9iDcWGKvwIycskCozI6QsDQ7N8xH9LbPtscQn6o8Besj9VKrax899j0NM1LCY4XeYGcZgD/J10KKjzxNiVN74UPPzQMLvhw+uEtC66ZtB49P3nbmmeRuqC5qnoAp5EVnWOFkdlYBWO0zqlngG1wvxacB0PrRb8Nbh5Fq4fmBSfuefKKH0KuwEpMt0XF2JgFY5DuarJ37OgAcDOaRPV2buzNa20l7IVYP/4KluGKJikKZ6QLgFwZC0jVyL68VewMAVggc6gUt9/RwELPsfM+V/NP7Nm9i9xGPusMaN2UmshDYyAC9LGqR8V01ImpWAAA/CIzELGdopwa/tySW2VnGjwdfN7cT0wd41MoivccMHQb+ZIEWqfIcGBJBsh9KMEtgotsdsFOySFXGvwXi0lxeiF+HEOtc6mSRfmRnDPCYidiHinK2fVyBFC6XYEWw70oshXpfDILatCrEODtjOZHVj9jn0giLlMJOdQCxLNDrcgWuNaNbBpPyiLMSpFX3Vfc7YGq+mk1hxKuX+fBXHTIHCyzSQ3boHPAqEzT03Td6t6xsJy1rZEqQNdzui/oboKkvTqhY7yBuhWXzYGsMmYTDFgkl2ZkGTGLDpx/IAKd6CBoJHbd6wJgtV9mfIcQvWsWB9QKZhbtWqRk7zYC9unNckANODI3QoOakv6C5D8pD8ZPyxLMe+rtVgsxChGiVBrEj3ERemN6ovzcga8M7dWzebFUHzkmHL33QRNkQ4prtiu76kmmoA6s8gR1KAjrpzpYOIPeJRJrj2rZ84cIVe1y58LUPOik6LvCNRmo350PN1ytLJfPwqmWaz1AjYJbu6D0AmH3YC8M+6KmoN3Eu4qFmnUnz/yrrbiLes0zbGaJ0XBd0F5kJoPDFL93c6Kvkho13NIa9qYpu2U3EJMt0gqXJQGPd0QIA2EcJd3jRXcl04l74beYmKppNJiLZMt1hqSYwTX+dJOhGpbZzIkFJa/7RW8wNV9TVTKyzTEUCQ3QC1wTdBT2VHCUS3rrFhfoKcoMMwJbGWn9FpczEQcuEaJbGAC/pjjZK8CoRhY15yIFSCo6QAVALD2NNlDwgM3HSOlViqUwxftLfCJntJI0Yfl13lO3tF0OgZMYiPAqOmYpr1qkBS7QZT8N010rGU01CZO+xuUiLu/OHs3PM2xRjiLnHFl1SsMdUPLJO7ZnqBbyhu2hRgq/liKjU+7vylLjTV49sJFAzdhZ6G2UM1I+x5Qq2mIoc6zSNKcc9HNYd3ZG5IXgjorCOkxb/nDx93NBudUJIlqGh3j40CFrJ1kcKtpsJwWOd0pii6RBr6u6IDNoq0pKh6t4+MIpSD5iqoWCfmXDAOnvimKrixizdbZb7jhd0ycsIo6BeIkt0w1uamQi1UKnBTNEWZETobYXcZW4keflKL03Zo3lM/ejtmpmIsFB7ie1OwAd6WySH6rxo6GWJPkImF+kg7BxLHb3lCyYi3ELtZky4iLN6W+LlPV7Qcbkjumh7AaqZoHo5DAU99oIyJiLEQm1jjD4BOulslZcV3BgqlxfKXuxCEfqgwQzRPG9tTITDQm1kLfwxDutsi5dL3Ai+I4POrDmGP4GWjNAchl7y9r6JILd1WsEafQm009fvXsSSvKBP5JYy1ukctGXFsYsd4S8vc81EsXWaz1x8Hvbp64YXtONG8BWZnHiWam2E1qxQ1GlmaJyXIyaiNKzz18zRfKCznuzF3t7nBvWUwWx26qzyQG9U/jIzZQrl8kPMQ0ePdfqYvSqFOGXTUTV4/44ftFHG3YKR1ms88CE7VOEyK7RSDm3NA52wTh3ZowXAv3XUX8F6jpR5LMHtsgyEvpUG3zJEZdO8NfVRay+TTMRe61RaB1UK8aCEfmYqOMoR6i5KkF7RR0K7nzPga5YobKHcWcFHlCb3h4lYaZ1IjwuAefo5ruAWT2iGDJ68LmgX3HnOTTDIFFGH/wO4XY98/ZqcO9Y8zPpHo2IePC31UsajIJsr9p0ywKmh0VqEvjR2axbYZIzohb4dQsnnjhsyeMM8jLdMHl3QDOCvCJ0kQmkQTyjqpByQf2Cys14pQSJE1Wj/xhdrXIVglzlGE+U2m4c3LVOePkr8DczTSZqiklyhspe8yLuzn2Tki2CfT2EPZPKjTEOCZXqoDxoFiH100QKK4/lCFa8q0y2faJwMhpiGapbJpZPgdCCzph42KCvPGSqfbloiH8scNA1BxVZpg06oI4BzUew1E5WV5Q3FperhiCHQWBnP82aBrlilEXqhNQD2BrNmS4Xyktyh0BXMFU8KM4aIhxJMNw27rVIZ3VTIBrBCYGwYlHts/CEaUcjWniYUbAw0XOZhiFmYZZVIvx8DwAIbU3XzVNwjHlHjCwz9rx2RYQRfleAts/CeRSrUke0QAPxqZyj2MlT+yScKmVLAyLFuJDUKGiRz0iy0tkj3dETVcwFgexQzEalQu5BTRNU3iQykdCZ5wxCOS/CKSYj0WKPdeqJPJHBVZSQiBao/4BZR8y0e3+QtbkTeDYM6yewxCXTRGr2jK2GLBBmDmIg7AvW1OUb0QtIDzcTD75cgpcZBeyRoYhJWWqNgXVHsbQmwsrTvmt6A+uvENSJ7+x8uafBk0/vlSKWBNPJINpuEEZaomHT+crEMno0M8o1jfCE0/IZ30jK9J638/+1sAGJm+r457zawkXoDoQUSsYk5aGmJ7uqNEuWA6x+H+ODl09BSrGUEXm2hoQJpbiRxGQCwwxyEFFqh1bqjn70A95NqaWPrsg/a7iYD8a2R0AgJ2pkCSrdCDfTn2OENwOlpL4WqcLSefg1at7FgQecl/xdMwVELJBIHI44qAVB8ZvmU9/t0fql1B+fIOfszof16smDUSYL+puCMBXrIA4o9o4zZZ+UtGW2SXA0xAUKWBVrBBSp9Xg+DyJo9nwsAY01A0NAM61OZDxR3kr0fyKLRWElmWeMjOm55ioiXJVJY2+SwbI4TALDCDPS0PKe4QcG/sLU1hCwbNSoCILYzASRanQH8IBpZxNDSILJwNBUAXEEm4IbFEYmrra+zUvwpMWlhQs4DwKcmYITFucoXil4qMnGpJVk8au4GkFXe+MjivMsZolcu+K5wehhZPpoBAGtMwDVLIxJ/He/f8Y1n9QvErKUJPQ8AXYzvDUtznkNEIe+e1y4ruRYxbGmoWTGA6xGGR24r05lLRNTyx9taZK4fFE5MWxuaCgDfG9+fFqaQ+C00GrnmfKG3x2nLx7RyEOsWJ/g0AHczw6tuYTZxTNZWpkHLdi3rVwsnfVocalAI4FyI0dEz6xLJO71bHRoPAEmG91/LcovMbaUHhmE/ZUz2VADu1mxsZatVNlPksSq9TQ6V3mUUFDLXkKh6NoAr0UzErGWKapxiaq9FySPTK4wpNAiifk+NiN4DgDVMEH2YzxKFJrMUaVG+Nj9Ejf8yCqpyxIhoCwC8zwbVT2eJqN9TduiCJXGTKY5cahQUlCQaUPxDAAVt2KDIZUxR1SPs1LQka8wR0eBMgyDq+sh4qIcI4EElNojezGaJgpJEVuiWBRHtZomeP2IUVC7FeGg+APxVjhGqdYYlom6PWGlsQbaTeQ6a7jEIsn/hNpyIiwCQXpkRCk1misqlMEJ3LIfoMFFE7e8aBFHCXaOhpkUA8PjtMDaIBjxjiexfutloZjm2krmO22YUFLfDaGiCBMmhrFDVIywRJdxlgq5aDI/dZJEwfIJBkDA20WDsh4CMfsRw0MzdLFH8biYqW4yfyXw7jILIYTBUKeNIVWK7GlNks7NARyxFIfkTGwWR4YeJVuITv4Ip/MlC/E0Bh3nWoWHgQR/L8AcFIF6wCG57IEK4aA0SKSDxP5bgOgUo3rYAYlSgQqxo/j6jgMXPTN9lCmC8YPLcIYEMjiJz15sCGl8xdRsowHGeiXtEAY+XTJs7OvDBXmDWOlIAZE3RnE2jgMhBpuwwBUjONmH3KGDyoOnKcwRO0CWT5S5FgZR/myqxPgVUOnLMVAcKsIwsME8DyGj7OqVVNHjV6XQ6K6vo5HQ6nXHq6jilr2rTw+l0OnsLSl5wOp1Ou4JaTk3rKXA4nU5ngm9qONW+qKi0U21HZd2cTmcvrao4nU5ndR+VdH6z/sChrXPff0GDik6n09leQWen0+ls4q200+l0NlMT1nPGhpSDWxaObuPQCT1XZJaGktE2hexSDRYDwE/K4ooAZEeq2w+pu6wm9yF9T8lIAAhTMAGaJimIBIDfffMZ1E5R1AVqTym7AeCpVm8DwAifNF9fCO8n3rKrqQcAGTYvYQUA8Lu3TwFguLKIKRnw/mSCTiiuyBx9Qob7vVxWuLr2kkcORcMAYBGpLueWwRgfZFayFtFLRCg/WVeFcB8A6nlpD2lesJftkmqKXrgExd/qhUoVmqF3yHDt9+QwWJ3tNgB0UnRM0lrdaMif8QH2CVaicjrkPW455PZQRiskH3iZIoPmco5MAOdJaakbUN5KNxSTb34Gk/F2BHD7OoBd6ugbyUIltQAgndQfB/A7ADTwAT7SrNtC+VTJ7wvl+7O3a5bCburSZikcw4ey1yBNea28IJQffFiCgpeVDZH86uV3uRFyLQEgSdFCAMie2rJcpYaD5927I+iHQjJNjtiVDHgJgMWzAbjLqmsg+TtIwVTJZ+pqAfA0EgF8q1U2gOyqWnn/SPI+qWdmMGksM4O01o39MABkDySvr+UAwIN4RRUlV+TCC4EnAFbJTZC0VRJdACCvAck76pGe7fdMjacpGXBYJgBnAgCMVkcuAOjiTbgOoLiMuq8ApNFRAPfsGk0rBpBiswofAUD+S6SwbQEALFREFwGgjEwnAEsA3JDbC+CJQ0l7AFhBvDxlYgrKkRE7ARTG2B8AOKXBeMkSby8DwGZSLVwB8AWNAYBXNUpcDADDLELIPcloUvyZpKiioh8l/WS+BtBdBFBeEpwLYAUpHSCZzw1aa1oeB5MhbwKwh+gHAKinrpIHwNNgLwslvdS1BICGVNEDYIVG4yrmAcitbg0GAcD1IGVB1wHgc0V9JN/J/Al4oq4C6C9pBwCvKeokuVuSGzTRpBwnYy5ZAGAoUQvJTHV0CAB6yIU+A3Dfoe4HABeJKAVAbpQ2k2gqAPzPZgnWSyaSyomSVEUl3AD+L4ksAs7SRgDfSiYDKC6hqGQRAJxpwg3q4DYj88mg3wVQUIKILgG4a1f3nuRXuYEAkESqHQ8BfEFE7wLAv7WZRlF3AWCUQc0to9DBg4eSJmoaSwrsSugIgMIwIuoCIJkmAEiVHAKQQsp/kUDcMyCcE1TiqekQ+5FRpwDYTEQ0GQA6qytZAOBZqMxWSS11XQCgFhGVyAewX5skosGSvBpENJxPxzd5n6CB4nociAWA4iA1QcUAUEnRVABoS0RJAAZSBwD5IURhBQA+VRF3TQIge9krfCA6bDIyy5JRV/AAeE1SXQSwXB1tBIDekrgiAH+Q+uUATpJ0PQBPRU2+JRIOAUCKQDSMT0o3866e5C6pviepryhBMo6IjgKeUhTlBtCSqD0A1FRBldLkAKS14wMNMxX7ybg/A5AdLqH/A8iJVNdfskqSCABD1YVnAxgr0xcAxmsyi4hqFwLA20QfmrzmkqvqbkkaKArJBbCZKLoYOElEpwAMI5oM4BKpDh792AvEGTYuUKVnpkEcSgZ+CsDGErLjAeAtdaEZALLDiegIgOxIda8BEOuXkMZnAjivyWwioimSB9H0jvHcT1NYnQP1JI/UZUqqKqLdAB4QdQXwLRElA1hOtB/A9+qIQt/cVSQDJPGBaItJuB9LBl4Hqvepo4UA0JeoqghgManfBtVNtJgjCTkPAN/QYD5NbOq9ugYzSGudxErEGDXxAFAcpGwMAFShaQC6EdHrAC6QIxtAey2IqOTQEzKehpyghEIzMIsMfZo6T3l1CZLlROMAoI262CJ1szWjFm4A+RV78mkwacwjug8A3dT0k5wk5Q0lA+kwUBRFRFUBeCKbAngWpBGR8FY+AMziBdFBw/u7Mhm6cE0dxqqz3QLwxEFHAVwU1H0E9Q8dmtG3ALDwZbO3SrJczRrJNyqERwBmBuUCqSS9C6BNIoA15MNEyRF+ULtcQxOTyODbAEDadK9rJC51lAQAbSuIAMaS+t8BiN9O9/oQALprF/YXgKKuZq+vpLC6sheKJQ1U0CoAKY0BTJFZD+CT5QDe9EW85ApHiJYY2KVoMvpkSV/yGpMPAI3V1ZdM+xBAcRl1VUQAR8j7LMlq7aidB8Aqs+e4CgCHHErshwFgD6l9F0DmhwDay4wC8PMFwF3KF+UkZ7lCcVcNKr8PGX7QYwBZYd5ovWSWOjoL4OhmAFtI/QQA+FRBM0lejHY0F4Db7JFTgt+CvAX9CgBFdVVVAYAUID9UpgWAs27gD1Ld2K5gnGQ5X4i6ZhuQmEwmsDsArCSF/SQPHOrGAXDnAuitgQuAWEkBXQKAd3wQeQ3yxvJdpNIgVZkNlcar+qahwvqK6DcJjreVa3UU0pGk/jJkD5BscB5kx6sS7l2eWEsm7NNiSTfeEE0qNpqDDjKDv0n6KgnNAIBu6ip6IPsgSF0DADhCSr+QHPIBdRSNSPkHqpSPVaU4T1nYIQlw7qfxY5NdkJ1JGs6X+48c/U+urqpGAPDg4OrVh7IgPSDwh2iBx0jOxJIpjMgBkBWmhBZLVqmjFLlvSH2S5FNFNSRiFR/QAitAYStllBYMIy2dcq28zJC5Tqo/lyi9EE9ctq3yGMW5CmQSXweAlaS4gyQvWt27crXU2W4CECspouMA8B9fxNy2AkT/uqFsz4uk6XMeSVaQl14yc9VNcisSV5Qkbi8sNoKT5ck0zna5XK6uyux/uFwuV3d1Jc64XC7XWlJf3+VyudaR8vdcLpdrg6IUl8s1Xgl1dUlDNPiXy+VyOTUId7lcrl9987bL5XJ116qNS/UARXtdaocq6eNSe1wVOQZs+FvG40qqT1pvcLlcrgXkNc4lTVBHlccezJYRL8+tT1yfmMM5z44w8hsLFVp1bFc3knhoq9yiY0LDEsT/V29yLHsaBfpGbS3iknihOQUE97ws8uZpEgUQj7/LkeyVURRoPPKahwd/L4mhwOR2B7J1VXR+JAU024amZhbrofDSjCgKiK42bueNQmbcGbc39aMA6/DuX287/7hA1K742fXDP79bkQK5Y9oOmTBr+Y6DqcdOnjl9PO3w7g2Lpg/rVpkCVwEAVlA4IGorAAAQvgCdASraAvoAPlEokUYjoqGhIzQY+HAKCU3bHWGkMHFp9R1ThkjSg/rW6tcxnKv9N/ADN5N2vAH7Of2TPBNgP1u+ED8ANwLR39P/mH4MfsB/meAA9ET8E/2x/2NrgZfp+u/hL7OSIyw/zvXwW97R/Yv2j/xX7ffL5WP7t/XP1l/afb13W+Jf4TzgPHf0j/Uf4H/H/sH82P796lf0T/0P7H8AX6ef7X/Df4T9hfrL/Wv9H7C/2u9QX9U/yH/Q/xv7//LB/fv+X/fPch/Zv8v/wf8b8AH9G/uP/L9az2D/3K9gL+b/4v/q+zp/r//h/nP9n///ov/Zv/3f6j9//oU/oP9y/8P5//IB/1/UA/9PqAenf1y/u34r/sn9IPHP9f9YHd9fNtCrKX2Va7Xenn37FeAF4w3mMAX1p82b7nzJ8QDgPvxHqD/zj+/+sf/w+QP9j9RX+Yf1/rF/vT7Kf69q/0FPbMAkmNKntmASTGlT2zAI/b1eFq85sPbL/kd3KVysZ3zApf6IHmIXgILhUwBhlioK+qgGNz/twxLYN/oKe2YBJMaVPbMAkp5dy9i5rkCAHZBKH03esz5mDM8/Vw+hjxIpv9vWwt8aO6qGAPWoN+pS94ayZkDRSaPFv+m+nixJMaVPbMAkmNKntlXdKXD1q+0qsq/pYZQoDlOF/oYEPA5pIO9WPBUkNnY1FoTCQ1M6CUd1O8YEm5vkO3Dms4D1w5unN7hgmmVb7bd9tu+23fbOHHYUEjoDXpDSvqB+TX6EEngaEJEAlw23CzoLxrLWKwCKl8oHSgEUu4LQ2CTDY1oTw5RcDpgXs2g1aYMrpMQ/N8cfDGuUYBU7mv2e4FYGx8DP7GuJYK2hWtPrOSVzNfyYQNxQfemfLhx2PYKvYMUCQjRS9WchyqK2FLO+qcJSl0pbRrmm/S4blY+PEoGq86KF2Y6kCLzmhRErEmNKqGRQ60w+LPbFZPGHWqDWAoYq2ZHCVxx8pOlMxcQ1hENcEDp1p2WaBBq+5bLyssW6AdPD/9rH2wCAWzGgJHqvO63eQmGKOl3P0qu5QFBgO/irACkL3yqhLMcfGkpvnckWjoQcMUyCqnGwrNlN4I6maptnSqK4RDoRq6uxuGsMKSQXPb7eeYrz0JlvP7Sr1YSOsZ/73+8mqrJP8t1TjfUu2bisb/hgGXH/Ot21jXGwJlfr1XgwXFEmVlOfvHMb38BRzTKyxo+lbVG4CluYpquesdlA/ELur4kVGua6jA2fCIB1oSW+Vuhk+AKh//T7EalmLEc7LZH3aBi9/8R/TS27Vf7wOPoB0xqKi93lnHlPpcdlJBjRBaRHN59v3eqoI1mI6y0L/l+POPlSwWlLTHYIkGno8cKFj1vAUcAiHhUBO5/1bHdAoy4ZovrzoRchN+ffUX+7qJv0bl2HLaTvQqP7/UsjX6kRfG7fPn5g/cWQUnK3tXcIeMN1DRJhOh6GZyj4oDdCX8i+a/56EbccldqJycwYiZMQMgNnNc1j4bmCXDociW7Z9gDq2UuMt2dOpiMjVKDNNrtAXebTk/MNLUWYAYn0pyKTAiLlrqPXbTdguhWxIZNtgapvPpDeCURibSdUhGGRvoHR043hxDcGEjOqegZRX+5+JVqULgigtkX+YNvXQ8UOSVSWjjD1Gyc4RKGpMFPOI20MKZlH7Q1CecCHQgZEtdEK3FnNxwy4Uzd5LYssl/VAe+zAJJrR3NthHbnaFsFCvuOVK4pSGajqqYL+Z0NtflJYiCVxx0ydMRUFlpUdnWLOvwSjGnt/TNXFY8qH7qM5SXq6tFdvQrJd2gRLE8A4PMQcuSsnX0Upc5J8x590G9b1lRgfjc3QzsBDvBE+usC+6YzVPFf6f7DhT7WXG1cLxk//FiQU9l+rGu4zGTQoOHuqMGgKCLwmqS6Aq3YaMB4kUM+XdBvYh05FrMYtBeyN82BJ1vSy2sABtzDnkJepnqzUz+9HCD4rWjY/TOzNBocc12L+mnx2SNOPvhKX3xO49U/0+EF5g2IAOwcHquDrNMxAJ94du8OvgAD+nyUAAAdgON/WOpxxVjAYj30ctRK3DM72dhtViVqlxbS+QJPKDkrV5/8G+7QLmopM23DFJJbutON4d4l8JNFMJN0JwrP02sUWSzNQfr7fQEkN4mwAvyzXbzMDv6tmjnWIPJgKLLxcfF4ip4GhaWfJGWuv583kGkjqs/lpgxlVldebQ3wirQ/WHdCfijjetbipruC5WPHJ+lhAWbTxy13SKG8zGHGAFn4r3SSuisNfo6/ZYm3UaUuzprm5XhikC9qqJJTky0AMElaeQO/nc9oPZsV2joGHH2tlR7TCDfPjOUivdgaLRE18f7Uk2ybRRmIS6xTpcdLxILVsi1W2JCr+WCpBqCH7l4WZ5hCQcGBIodsX7nzqyS2Rmv9dQNVk8Z0Ik1zDAzeUJ1fIDSqv+JEsB9H4hU7FBbSfyDdX79v2TtdF6JTJjEUIunJVN9OJSY8eoMTXZx3Qbl9dvv7+c3yXdUP+vV8YfjUgRiAJAKPtan1/Q8nX8s6xXafN1sUzSa5atMao95AnvFgIQqYfJZVIhX4yKaCWV8XhG4pKCM9Yk6Svux0Dvu/qhBC6Kd7kvAABPUzpUWCSFwXB09OGs2KK3guS83Hf67rQoxUqig9q/RDr4rXPlGIbQocsxaLaOAAoiwd0opfYAMxUMsB7w6fR6tXLtS5XuJXXSlQ5JnSmRlXFJ5414+vOf7I31BzYW9CjhIkMQf1wf4RgIM1uU4uD0HhHAhjuxlZkGiCYfd/MdZ8R86quFXsZkTpXN9DEC8yglKSbpEl+ug2Af/YisWFli6v5WuRFqTx0kj1GgUgDtJ5aYhRCjYnIGAk1JpvII7m0bLB4S7T2tzArPNsfxTH/IaILJiRk0LvAPA7LpyTt7/r4Nl+oXsnU3DyOxmS2iY97zEWBIloW/7PVBLyCPhrHWxHURLePLBt7Y39ploSb9tyyznEPmeFOIPkL+bzEHIFXkUzoHUg31kFTOWrEkzSL/AtXPnaLm3hDz8bEYmgOTKVJTzE7YMEueO6SeY1bvSNO19sRnsEehp1Q2OwS3uG/fxRXDR0OZUesRSuPpvzSuDzQHNH+FtbsEFIb/G50EAThXO0C3KQJuys7513slrmCZFzeyzVELaeaFZYDOpiy2FVS7LCem3UF+jMJN/hzI9GBZRDxvo79AASk1uIFHFPmezW7PjX4mBrDxmKXfq4iXoupt20OoYHth+eAtCawf2JsmAf0RsokSIkKez7fuVbpG9CRT1FICYORftHK9ZFMeWTBK2V+FGTdmjMJ2kp8dArhmTWa6u5CNd+msGJ0IO1I9bm212V1ZWth5hd9QNXXTskF+obkrHFcWimr+Cpz/mIufcY6ZaqOi54bbbsb5QlGQw64+8NF+IF+4XlRLvQqFrRYMBlqY/DPuQaCBOJ59MbSgFFn+xhGP1hxdrFoSGtfsOwZTrZSWRt1kMBZCNqGfDzvtQf/3t+i4OulFm/0JyT8l0o4x5qLV1/xe4Wi2bwG87T4/AHJ3pZjTc8/F2ZUGP2hviG0nWnpEvV1pHjtUWFDiD1IxGWnJPHzGW077BeZSstiPeJe4M1P0oASGtV+ZrF4DlWalLjFnGbnm8VrKjP0R3zkgC3ot0dl91wJBYx1C+7rFUa9+HCJXjz4YI0ocXlwO6B5lyY9GMH6NytKOH7JwLs1KzT/ZMH6QwCOdxlKTH2pvu9/C45Sf3SGMJNjieJFJjEUKCqmlhJJ0XlSEeRkdFtA7n4SDQT5yshZ4A1BlHa+HDYbK9ChogJxuz/L3J0+F/ZLma/ILw97wtCdeTjAabvmAobPAImGtb8Azb8trCyQperGZbiwWMgZEX+KleFkAFkI6rX4me23pw4ynW8AsrJSXANfxF3fr2nmhz//+JyF9TA/FLzNXggGmCL+kd+87MafDI4gyr0IKkjvpe6rly0ReVtKj2+MwmCYRHFvamA8Fh80lCvTq74yzv60dWcHyiwHIzkNOEr+w9GmTHwyu/+YSmGrSm8ua8vWNjbQZnMt8Tj1atNKKE+oj68VijG6ZAvFIc9rbbjg7b/EkTk/oyxmoP0hhJyRp4v7x/QGHY/zLv83fdrpRZzU8/t4dDr9hFzxymjZeOx58/qfILN645MzEeuUb1C1mipuiWcuuCGCQmwQkzFlUru64TthqYw7sFfGDrTCCn0oQEczLBSMH/lfBR85Dr+2XKuMlFJCAOLe4yzAUYD5SfuSQaZtdBi6dfUQECeru1kIYuurrXg1TccCpX4C6vJunlJvJiLvNAuztcE3lrIE72Vk2dMLIg4g4ww5oyUHIyE4KT8v6nO0UA6xoA7YTT/Pxk4wn9ZFN/6/1sFYr48yAPU+rz19i9e1033/67rAkG/hH75ogbxsS9gDeAj/clCiJqAyRPBUP9qoW515pitxhV5GTmJIX9j3ZDkiXtDfy1wGQhPrivCOpntTdeJFkCVr5tx0kPv3NKvClfMPV3jYFJ33FNUWZhPu212YmQWWym+kNNVddAqOph8Ly2RL0udZeNyeKwZRStmfqlLKtMA0BCZwY3pEPkiFVEYpn4HAFl4u5NJawAMvUe9tH1RF/QrzMqg7X71VZdTIoMAHuv+Qvndzq+PCvkGtGTO0sxBy5NAk7FyJ17LS+YXtt9+k2rpIbFdiKFvZzJ7DLi18RVaRMB9zdYg8R+kZ9RokpEMlXAhiJtoznlLDT9M9mx8TCHuiHpNxH+W85h7Quo8c/g8+kAk/nmAjYULBQoBROKp/PAEsoyyHqMInjGqZ/tL6x0tTn85VM5FH3EMXVZijPy40CgIya4EoGUyYn0OvduD8+gv8TX58T/t+66KUyRrrNeOMVfTaKHxEeDIvh3zGf8psLrZadV2Ar2bnm3PRqsaRke0cw2rFAWsEz8J9rh54NIbeDw7xidKoReafF6+G6taaoiRSbrg3HcoKXSQoKg03pZvW2jDQeA/wi1kHj2Q+zoD2ldip4bb0tvgVij6FNRs+Rh8/IlNKohbPYdRkCrcD5oK+3WH0feuxv50e394v0nb2Cd7vq46T7M3J9w4G7Kj3J6fwo0lv6FCp7ZvrxhAwUX6gYASXHsENsty5r5jcaOnOLoO+pJ3aZ56/5eB2QE9b1eDGPY4swYIy84s/t5bqGZstpmrmzzGFAbBFwO2Pk0xsZhB5iFzshc9nRbeI3B1fkJRzdgo0sVvqx7pgeXfPNOl9JmmRG8awDQcP0c6ya6mSM4aKL9ywTKn/sdm8RR4NPZYuiJ7UtOXJzUVcMVRByCi7zJ5bPW0UblqSKtI0i9nS2Mu4PE0HiLTyNyXfhi+NsrH0XU21ubCkHPEh6pHf6qqVbEPuZc+YXRS7WEKdr0r8RnQXiG0O8vUMtRPoHCSM8oq/yo+hFxNmmZSSWWCeXrq25i8El8sFMp1KFIAAU+F9XweJGC87eYdbkGx8ZEt4GPZtD23EJezWnYUtPHDP9iZZszUPVAHFr3sxTN8PZI3wIBMCb/5H5LgJEHWnIBCdrLxLNKB7248BDXOReH3EFLmlLFQc3xuPNycKejYWE6KNFa6Ty1/bpGtNH5PlC/lJym9Pa2jmOtqCCo0+7CMX1P4OBKir7bXZATz0+rtAMeNw9EAFde0lwHEwbrKPBcY7SP1jqN+RBLpwIqAAnB0dslv5Iq/88Xkq+j2IpNS/OP8uQaoraUn/5/x1SeqGuIDjYUaNAjiGsMYyvkeIKvUBhegpjif9vFqXXgnD+JPPinkjSCZD0o0SkjmhrKWK2DYvie7UIpZYvvPeeENeIqOllq2ZlJ3M+1ZFrB5o+acdDez/Ub4rvWEoFp2p/MnRP2xVGATMXZ33fFjpYunGLSxe8QD8xQhocco37H/BkHhTbs++5+0rdu9A8KbSdnAS4SsdPUFMadAYtVVSOgK98obTgkVmmKQ6d+Nxsy/1vvhZfA6Slzns7lFaNw5s7q4GUnWsvbJJbsWse/xJEAaoJBhG7wFORDeRBWXe0LJ+vQlB2YhXwA98Qs2dB+ZdKb9k10e/zQKossDpJyH2PAHeLHiDRcN24549IkBA9w2lgwo6YS7lhdwrAm1tKhKhUr9CVZxaU0a74Z9IC8qJ26P5BLghXvuGraRUGqUcTp4y1U7M1eqfkiN8XMJpNVpN+cPjxqYMUvrcKHlPy++AZuWaSF5bYgKPLFCOIzLOTqO7VNbf6a0xgBQ/UKzgqAgm4uARYcu//8Elcqx/nGr/QwavFuliYvbQlvOQWSHxqlJPTQeTAKAtQ3YPTZGtXprdUbrMjmCQ9goLwfbJIRfO5/hJaMPYGuD9HF8PLq8vM89q8zkIs/c7xi+KtsYUXzbwDiBLZ0qzP1xwk7P5OgxmhLSY+M0Rbc5gg8965uQYO25k8aAoeb9YJUq8IyHbBQ5H3ye4DR8GeWGGn5JJ0m/x6AS+VK65aB4BAM7mBmo7QJaFeyO7mI8IXONiCh78Dp/nzxBJP/fs/3MWAamom7himbWYemoif+TxxFocnD8ecuezbspa9kuj1BlN/UlvPfzm2rcZIx/7Pc+YsGPxcT/Ng8H5QPivzwB+9if5GLzjJXw17Y8Yvh3fUaP14H4GkEme2jvgSrDIgu9pPcTQhfDXUiVUO/4LA75NDpyNlzgstXYOWGVLDJ9SsoFie2Vkf5AYeZ5aqTRJfpR961P4klQBLvKXMGnluWnNdjy7OW0UARPn40vq+DBdXPHMpPybiBSR2kNhsntHWWwlbES3yipZ2G01Ky+Y6NYV7R1OXnxg+lHnvqkkKouVWyILK4g6LPbVWt2tiM6vZ/6ITrs4y8FR/Mvh0nE+4UdgdgewzsU2iRPXeKXDLTpQ7o/vEx6kud6WFrdQR4vPoXQwxdsUBaEJzi9zV/wmsqbwFdWDHbmXMGZRo3vhX2nlpmvQUQfhtuW+zH1Fsfdw6EaXRewKhH4l6Qr6lHsTjlmwFOQMAuPKAcEnk+kwncEXpqQpYgyGJOd3Eq3paYnsgggfd/b69iqbTw786h6/DSWXDd47cAiXbjl9fwGbY9LHzXpFHUmUE9agO0SZIUjo3yYzeFTPS25n8StmDO4kZLuyRT0eKbfahYJ4iP+mL4sF6/BCEn6Q4vz03VL2AByC98EcQphsV07SWL9enyacVU08DfRJ+ewNy3BTw2z+75AHlQ2yYJI9XXI3gZ8ICuMz7L/7iHexlA4wzWwnr6ObVF0Ar/HbzPhjb5GhPPrICFQgja1nfxROgpCSVZame1PzjnVoc2qFhCyRTOc//2yRegYcONXChEeTCISo0+Yy8jnEOeS9/ZNZ9Wy7bhuJJItqdsT6qGIT8CunD+QZsdsuvJwRhbkVZpQLD6VBrDj0TdYHPtrhc3jbWBwkHrescLJkvZBRft1M3zFCwo0V0cfiF7lFvqnmG43SCW1sXqWH4Yyd2il0HNDQYs582hQRbT6qII2ThZGxD/GdginW6kHRZ0IGiIIVayhMb+KtFXZUhDv1L5x4R03KMwMQmWkmMfoZlGnL5LpjAS+NxMDO1csfDi0/UZksbqnXttXoOLRiJWKWgoPentAuWHl/jsBGlw9vNHaqKIG9PD/PXtJYI2+bYhLjYw+ab5vd3cftD/HWhgBTRCtHbNNRZOdQ8XwslGKYTGaMYWuzYu9PH6sb6u8fJRW/HM2mpd1ENRg47vpzXhTfhFjfWma+3PHoVVSohsAOZrWtvpYO4pzctgp+xaejSlmRP54fkNLqZw8JCvF2ubKwLcjRvJsgXP6mioDsYFHoKZ0J9hDCDkc/sJo6/5TOQsck8IQz6I1fQ5B8iJTraR9P/ybsdtkxYDm9eGEAdl2jY3/U+CKdesKgSRwciwodJmc0eV/pxBlPnaAMcYwLv9iAXFGN4//eTP0+3zgT0XDEyA2vk8ltT89jh2eyA5LxL2R/vhziJ3HZTk+iMmElnflLoBKZAGYcmrmfhdx5sZsj+5OsZjL1hPdcFwz2f00KMHJ8fvNtUlKEj2jqc2InP2eXXlhaiqiXgfjRmyoodyDwjPAD8DmSgLrLTsQD3fx0kPeVcWXYEgVI89RKKYo2Hl+YBwqIpLqT2u+eIkoWe7YsN6hxt9YZ78BDglgIGO+mFupxwOIx1IUKgIn2wpE4wTseGz6Es3ZJW61PZgJ5zT8ODC0GRWWuH7hM8LdsBycXZ39JC2jA7Kzw580PcSvglqiXBJKiYPx/Le6kDm0PUGe1se31EzfFqozT4QxmaeTXCB253JSqzVscWaA4kFEoOtK1ZaUoRVc2rGNLnuE7CbZoX0MIpS/oTbPOBio20D5nw9WLjBlb1MqdYRRVTddZ35mwkJLPbYVtXeGt2ErOeImPps316KL/T+nLKhHLqX2+DZbFAh77n4RcOxAELS9xbhHSuptMBU3lYii+qwCGmSP8dr6DnFuEXjdDxgqyFYcMavRkbQgosvlzf2MrI5So98n8s0RVAXaGQXUFAnf9IImKu7N5zjk0IneOcG3uwgp3wfpEOU7foSPxpBbbRy+/4OOhY9YAqLCeP7F+s5XIWF8oSJ6b8/LvaU4V5YT5IhpWrChWEfGopB/hxtEMTZ748iVr3fMPjlwBgB/XNv6Fi4m01embX4my3USjpBH9IBnAMSH5cd0Zf553HnK2hl3RAnGPP+Pufjbsy8evt5Q7e14ytYxbTKUyc4P9u/TajsBWEiANS9RDSs7WZFjuJXA1HRxO42C8nLXp5OeQHBUow82DyepmPye8Jhkyt1oFFkoRD/b3qyK+SLr8Qq7GkzYTPCHhXfkENAUaE4Hvyn9kAQ1nqF/zEEytjx0NnDG4wf48wQ15rUBEZRU+9IdZo/hJw8G5uYe0mqtts30Le68QM0F1Pv3cRVNShl2oHpVrcWzPy7W0pbccsqfXSdtlzl6Uu7PCSAETOJM/HnPAzJNQBkv1EtiVRD3BRTmyYIBwq+3Auy6jj0jiB47opjzBf0wlPyciUQh7ZHuCt/ze6oth5r7loW7X3luImMBsP2xDAOtbyfWsvHXmQyvG+fthaakAngVVDWSoT297BffWFzas7p1v+RwvPmkgWoCeHEtIdlE8pm+ZPnaN4SHY3wTDN2LuOpCEXRt4hdIJfVz71Jz4/XeiecMXmql2DJcmZPjkiyWo1Wj2kyR8ajJWeel7VxQ96dv+4IimJKLwlRqFsrGkNwGBy78NEsAURdtOhudFB9yat8SV3jDIMzv10EUFBseFlZ6a8mx7YnGrde8t1HWayx/CVmAOGnwlsG52b4Wf/J8oRKhBHPsGpfGsmGC/4ZwbwwVRzBhoB8Le0BKc4vzUgjJucUlaH4kO9aEGYz6MeiiOe7N5Dyd2fFJsYYAZYOzsJ44VJTp/R39gF4S3Ls09VdcQHdjOrD904UC5UjByXvgICDtOqR3zcVUQZYFSRX/q+5HQrcScCHHQcGdIBWh1FGtq6ZhJvbhogtCQcmGdfk+b0bvWbZgdxSbVzzyd1ivjB9LLcmq2OqUI+/ER7083xFtEgEMzZPkA6Bz4zIVid4KXjVjlmThZ7HHQt6/8yJ7AR0AYE69ZypnfVxyVrb43dpnpCGvkqde2BEChSGf94YCYK58QERV4MhhCG3OEILIIUygB8wx6cV2w1BSoIO5deDEr2aV3jNLmfWTSb/PRM5Na7jPOvFl2iq3pxzN54KBhR33dL3dqjBLyt3L5liF4QYhpJsz39xdtbzMgpKtlGGQnegIzIdc2kdkcmeEL531tPeKm4Bq60UV1mKi5DqG2wajQ+Un7aEwTiA5vRODMLuvRuKD9B5l7ZTW1gXjix9TUxtKra8jIg0HyXTfW4LnUWYjfV7pyMrhDVnrXisqyePykrgX/mcBOAQM2jiZZ3+fjlidlSF7rFINVFTYItED3uKoQ8ioJ1Wl9r7oGwY0S/FUtfiGp0DA8BmBNJ9kmoCDhka0rLx3kxMZgF+b7h3sLJFZbix6bF4bKVNE5gvW/Z/r+bPJY1fwdgZRVdyQiTneRn4JxZYp5+xXngO4PX/8JgDBzhxS9VB8rNhdCMJ0xhdBsVHFPi6mS6nD5EnT4+m83QHxjOkTA565z5f2qU0tuz33G/uVG50zBbCTdgXYbvdX1VNsxBJH2r31gOfhgVajmZhDgdtuZIlQzh62itQQFMVtguLtve+nzI7+/E2qaw899hLHPNw2RKqp/TSGfqb3U0BrBDQ99jwrr/dMIRClqntrExStVzE950nwz5mGXw4JV328kzkal/V2wpyFoGIGQCl6Ko+hfUZtSMKFKocp4xXhYiHP6A+l96/Wpn+SEy2jpCcDBIkydx7+y0Ah2lV7dvP32g1hY9FjCG/Cv28zr53wzECV8TCogpTK1t0uSn8WkR7dbEvrL+ET76zLlySsjgqLJHzxR3YkCl6scsxLUrclktS56ikqwm+LGwANMAFwXlpJiekOmMLSx0dX9nIS58NLbUGNfzL9VShCrrWssQES+t5Xc/SzaJ9iLXt8w24cURZJwOdCgK/QwJL3KwthosGoXJOa1pnWdobDTgBq1GxPATLFw0UvqmZBIie+mmPNaHSBTGp46bML7m8/GpzVpRvaSY0vadBH+v2p5v88My2VSBjDEAVbpec4MMIgbSihPiPTC8kSHzNN36DtbS4uN/0dnuyxkNarhPsuI8m9P/6G1SGLIr1XhrsUsC0QeGrdFr68MSPhKSeeIpRz3wIvofxpxvqXdMEqwCJERFuC9Ua9H0eIF4sOp5vD8ivzNbLONu+Q41PiueNjlVTU3NW5MgX4nzH/ucfRYx898FgTwjLZgKiJezXE8MMRp0kkpySsKfTMek6UCljbH9BF3j8c8ksDlLu1DKfIS/1pjthmTeSMSwtxVbCJO8Q8ghNP9vOfTap1XFvfcuOD3J+20nP36l82bGaihwmjFpjDVkNxcFsvZ+xryRGoFDX2gXveHFxBHO5W5dBx1fKzQ0TlJYkxEZ9676e5aCD9MYAC6FLeW13Fd8a1RC99CPZ/MmBDFens+hHO9I1T6YNj6x8ExRMZF/ptGhRLLys5K14wlxQRMg73c/A7fo3rBZicJhpzgBeyuVlOetkFalxYgmRLpPxispIeR1UTIx3WvRU+DTwtonCb3oc1HqPJClA5XX8u23Zs5KKPTEXd+2faHmiorZUcCkIOuMCwEOwjix1cvpPXWkSsfcXtRR1OiXw3wy/rAS4zJaM6AQ88axzhtMoQ9wGikGovukVe9Q735/Vonx0ru2RaK/ja8JrJu3ZkceBKPq0NTQRhXsvnozUMDrHy7B//Pz2dabkrVt+qf7GjZghkaLvvu9ENWX3TLPccm3avFePq4kdWM9X64xbSZM9EFDOyAZrz/8m3rvFDg5BpMI/FBdHKa+SV834e9J+0Um1uYjHR5M+WfV9P+PPYo92snIr1FVy4goZAV83SJbW4LUSWRcl6oFjbrUrEu3Uoutx8W3BF/G9gSZqufmBm1KcsHDr/dU5r0B49jptUAJRePvGcbt4TA6b+lcbe0cEInWBfiZdZP/0Cb9wLPDmWDsYQN1VMunlAl8mSmxrxI77Z9FItxUF+I4TK/knn9nP3yACSz4Dnf50f4eOijEBbIROs0xflAMuLnagJd6pmQtl6nHumY484E8sLPrLc1eV1ESdQehsrYxmLQRbk61tQjsTiQaRO8aIDuFrNLOYTiUWZjkzSz79/i/rrueSEiFmGXsGQY6Z3n8s24kgSYOHQla1dL1DUqmqCXCOoSLFNulAZAtG9DkhCkF9T/cP+xnnjOOhlyvNRCdfJ/aiTCJW9pkZEbB6JW3qUPU4fBnMW7VTM0bzZQAhX/ik4WpQcaJxaxtjF9x07NezfvTbYaimSdb97p3SKJCw1NpsA75k/betGkhgKXo1538METrCKyzKMi1dXNRf1OQ18QfNLm7xe9vnPuOLCi9qw0Sq6S8XKy9Xf6pHT8rGtHwhT52sXsr87pksZ7lfdMXNRby+ehAZyJwgsEn/9ozrcVVNuwXcHKDEer/LbqF/fOiqFusv8Lez5ZHf8fehAFUKnsWnuogBVVT/J5sL/HRKD8FU21dag6quT6D8ifxHCvA/EEm38Y9ETXGoRXK+Ag1fQW7ySY/LhVajKTNEw4YujkTwCbH4Mt2+IoyFzS1fmoifL/JZR2feEZSAzWyUqyl8Vy4VGfrmVMjSkVWVA2wVgR0CTFBkbyug+qIvfhwXf+k4j1ivdROSasn/rw7x+gtnBeLjFQplmU0Dzv1aryIXwQCK4Mu0kyhcsAqxWoYNu+cTehCGqgwy5WuT+KTwBxN0AUCnYsFd++apmlHIKGXtHQQlNprYooKdZHrbIK9cjmr6wNHTA1IKLGHn50B8cwLZYgywy1HyJrv4uEWbSr2FnqNAQ0FWaPZ2bqyDIbA3ORpqBmrqVe7zhf+qkznrtz7TvNeM8v84XIDSzvIQ81WoZupjMLNObpviKgfc5bm7eA1n/RIGU1UcTQoCuUgacj4Op6dUleviSZy56+nIR1ZoFYsw0sxieRyHGumzyV/fjXH3Q1W9xUsD5saEwcebgNdsmalMgO6bnlGhSiwG2s7v1iC7bx2ZJ1E2OHRbTJQu9Cx6r6xDhWY8ZjKbIfVyZt/4SgCaR31M6Ip9/T2ZPSR/iXsyHYlxt6DVwn3N5xQRWzkZcz9H5qf5KsBzVWV3GjqLJA1XysJsSOHJ6Cj9+ZT+4qvUZMv9jUw5Kg9VpCho8T3Aiw7tOzS2dlxYAyZvje+LoGQtsZstNSoq9KvBx2R+Gzi9WR6xUxibF5Vce3SVEmfAsYSGC2SSYgxNxdap7JYjifwoP/SIcrcmmnecRSxPOk1DP+QzK+JFUgCX8MmJyystRm0peCWQvLXKRfoE43zDgoSSwDcB1KYbp1BlledSWMnaqE4P/1V6PxJQFVP9KP0tMkS1XwRABLbf3TUt2MAyfwAEkL45UqETihhUaMVDpRyBvWbKM2PrPAXGbNVkgU25AzpBwCWCGK2/hmm2LLhwU36wwiSu5eO2De4u1EXsVTBvFA23jhK1AdzZEOiVlqobX8L6IA6UZ+vgeEUWKC7UjgKQ5ji2jQIHugI6RYQw3pOxOLccC9ZNv6mnosMlVbEKJ6wTGJRfMvL/2TuSD6pFlhZ++gqj15AbM/JEP56lvCbJ6YtkUrtxopujr4cvOnBTKvm2enpymcW/aZcuZBgAAAAIR2mzbIchwjtvo0xqY2qjc1vqnTTruHWfjNZNu21TmAcl29LAOInWdFw/tW58VL1bMqTiuKFf+f15MzbtxSYDQCdxpTIoGCFiDNF3Vv/kpOCp2S0AAJkj9XfYloxpvdzrUSRNJfyCQ1+alNIjNjgm8RxcYSn//SjLRT+zckdL5fVy7O++BP+Xf5Ahaf9sQ4lZvLZnn/4C/y+td/bQ8YNHrf0MMXGBZiDqkojp9cm3oQhDUG6UHPqYfU3lxjmYZrGN1Ky+C205CKRIO9Tox3LX62W/YmDt6UUFRdqC+hUtN2880bvy0GFqrSe9LU4WkxIZNEsMdJm4k3VIesVf1OpppvZBdlkQcLfjTnANFiR46MZ0dkcak7FCXn0BwpmAlVLFqJchwsQMeXYqvKFQ+U12gXXleUmhub4fWFMXv9vqpbl9Y9MTpJ/hzroSRIzTtDI1CdG9+AxczsMwIblo9eZpf7VfXBO8dPMCsoB2rv6hVwGCzMG6vcTODgEYP/DrzMJtjyDY7IAM7Bib0OsIAFAQc2kCBoinkZJKgc2FI5RK45wWEgE7l0VSP+1p3OzgA7sMdSWe5cDVKLjqwp1/BM9CQRgmq49XUNW84xRyGbovx62viCqI+2s6miLfXLL7Y1UQsNng0Q6rGs/4pT+zmD2YbStjLHk21r2u1XaA9bk9LpYM1fQgQxTWvAu0GjDCIgbpyRWPIr5Spg2jtADv+h10y7qtjD/Iz2vPJWrhKA6VaVP7DHUuoHYjq70XMwltAF+053AkK6byTQXcgb7mt2XnTk/eesPra2gLM8Op2TYZmfTclrH8G3g/pqn55sTtkd1LPHt9GxM1fBS/e/Ji5LTXK9GHK/KwAX5DFpynlPuAAWaCRORTQo3Md42oFal+xyhelbZ67Z363FdkSIYDMPq4iq2rRXjY+1tbES7ez6U5grWLhqhXpIh42tZ41bDzyMkV+91u89RWhbQoV8WMuv3W4Bu+sZqdiPLhzK/+jNRJmOdG1xM22/4IS99wYWYAWrMbfIxHW7k2g6qqmbQQQlpy2aF2M+QcldG2wHxDL0WY9yOdu3UYMTovaEwhSJJx28puVPjESgm3dHDa6NQGvr6xF4TDlxbFF9JFdWiOS/Q1dK+ogy30XN3Jax/GRyF+ExAk6hcPY2Tc4WW/oOk2Svq7bvI5ARfhfjiit1eMX0J7q3++wl3446YtZ63anpnnQGZSt6mc4qKCTLWvOh8NPrIpRF+7L1enfvPfkU7BhK9/xfT9nM5ScM3l/Xk0X/9fKw1tubw3tyMOsRPQnZIvibaK+8QZwj8FhRfjTjxbu/7NyGQEch5s0ckxfyucIDSaCOgbrzvne9KO9iX058CcxqDgz0H/MGrNRRrzRiuN5QPIpqBS+ddfjuy9MIQyJsdcouTnrXNtKlKpbGaUL9Od5Nr3GNwU5rxpkImisbTiFU9BNxTr20jKeOzdkfcr/tRZg675AE2KuIsFqcPO2ns/8cNkxnlUSya9/sOcDdz3TGgGJexZhrf+f2OrKvMmaay+L8nEoxDI/UKHpU7+q78dTo/8hkxE5zWyFnDWEw38+ZxcxB37Drc3LXPFQ1TDUxdxBVK0/2hIva01xhTyO/nSkRZvzkEr2hlrE5RYbThIAAAAAAAAAAAA==';
const exportToExcel=(data,filename)=>{const ws=XLSX.utils.json_to_sheet(data);const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,"Data");XLSX.writeFile(wb,`${filename}_${new Date().toISOString().slice(0,10)}.xlsx`)};
const getBirthdays=(teachers,period='week')=>{const now=new Date();return teachers.filter(t=>{if(!t.dob)return false;const d=new Date(t.dob);const thisYear=new Date(now.getFullYear(),d.getMonth(),d.getDate());const diff=Math.ceil((thisYear-now)/(1000*60*60*24));if(period==='today'){return d.getDate()===now.getDate()&&d.getMonth()===now.getMonth()}else if(period==='week'){return diff>=0&&diff<=7}else if(period==='month'){return d.getMonth()===now.getMonth()}return false})};
const getAnniversaries=(teachers,period='week')=>{const now=new Date();return teachers.filter(t=>{if(!t.joiningDate)return false;const j=new Date(t.joiningDate);if(j.getFullYear()>=now.getFullYear())return false;const thisYear=new Date(now.getFullYear(),j.getMonth(),j.getDate());const diff=Math.ceil((thisYear-now)/(1000*60*60*24));if(period==='today'){return j.getDate()===now.getDate()&&j.getMonth()===now.getMonth()}else if(period==='week'){return diff>=0&&diff<=7}else if(period==='month'){return j.getMonth()===now.getMonth()}return false})};
const getTodayDate=()=>{
const today=new Date();
  return today.toISOString().split('T')[0];
};

const getMonthYear=(date)=>{
  const d=new Date(date);
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
};

// ========================================
// MULTI-SELECT DROPDOWN COMPONENT
// ========================================
function MultiSelectDropdown({ options, selected, onChange, label, placeholder, disabled = false, getOptionLabel = (opt) => opt, getOptionValue = (opt) => opt }) {
  const [isOpen, setIsOpen] = useState(false);
  const dropdownRef = React.useRef(null);

  React.useEffect(() => {
    const handleClickOutside = (event) => {
      if (dropdownRef.current && !dropdownRef.current.contains(event.target)) {
        setIsOpen(false);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, []);

  const handleToggleOption = (optionValue) => {
    if (selected.includes(optionValue)) {
      onChange(selected.filter(v => v !== optionValue));
    } else {
      onChange([...selected, optionValue]);
    }
  };

  const handleSelectAll = () => {
    if (selected.length === options.length) {
      onChange([]);
    } else {
      onChange(options.map(opt => getOptionValue(opt)));
    }
  };

  const getDisplayText = () => {
    if (selected.length === 0) return placeholder || 'Select...';
    if (selected.length === options.length) return 'All Selected';
    if (selected.length === 1) {
      const selectedOption = options.find(opt => getOptionValue(opt) === selected[0]);
      return selectedOption ? getOptionLabel(selectedOption) : selected[0];
    }
    return `${selected.length} selected`;
  };

  return (
    <div className="relative" ref={dropdownRef}>
      <button
        type="button"
        onClick={() => !disabled && setIsOpen(!isOpen)}
        disabled={disabled}
        className={`w-full border-2 px-4 py-3 rounded-xl text-left flex justify-between items-center ${disabled ? 'bg-gray-100 cursor-not-allowed' : 'bg-white cursor-pointer hover:border-yellow-400'}`}
      >
        <span className={selected.length === 0 ? 'text-gray-400' : 'text-gray-800'}>
          {getDisplayText()}
        </span>
        <span className={`transform transition-transform ${isOpen ? 'rotate-180' : ''}`}>‚ñº</span>
      </button>
      
      {isOpen && !disabled && (
        <div className="absolute z-50 w-full mt-1 bg-white border-2 rounded-xl shadow-lg max-h-64 overflow-y-auto">
          <label className="flex items-center px-4 py-2 hover:bg-yellow-50 cursor-pointer border-b">
            <input
              type="checkbox"
              checked={selected.length === options.length}
              onChange={handleSelectAll}
              className="mr-3"
            />
            <span className="font-semibold">
              {selected.length === options.length ? 'Deselect All' : 'Select All'}
            </span>
          </label>
          
          {options.map((option, idx) => {
            const value = getOptionValue(option);
            const labelText = getOptionLabel(option);
            return (
              <label 
                key={idx} 
                className="flex items-center px-4 py-2 hover:bg-yellow-50 cursor-pointer"
              >
                <input
                  type="checkbox"
                  checked={selected.includes(value)}
                  onChange={() => handleToggleOption(value)}
                  className="mr-3"
                />
                <span>{labelText}</span>
              </label>
            );
          })}
        </div>
      )}
    </div>
  );
}

const getAttendanceStats=(attendanceRecords,filterDate=null)=>{
  if(filterDate){
    const filtered=attendanceRecords.filter(r=>r.date===filterDate);
    const present=filtered.filter(r=>r.status==='Present').length;
    return{total:filtered.length,present,absent:filtered.length-present};
  }
  const present=attendanceRecords.filter(r=>r.status==='Present').length;
  return{total:attendanceRecords.length,present,absent:attendanceRecords.length-present};
};

const getMonthlyAttendanceStats=(attendanceRecords,month)=>{
  const filtered=attendanceRecords.filter(r=>getMonthYear(r.date)===month);
  const dayStats={};
  filtered.forEach(record=>{
    if(!dayStats[record.date]){
      dayStats[record.date]={present:0,absent:0};
    }
    if(record.status==='Present'){
      dayStats[record.date].present++;
    }else{
      dayStats[record.date].absent++;
    }
  });
  return dayStats;
};
const getChapterStatus=(chapter,progress)=>{
  if(!chapter.targetDate){
    return{label:'No Target',color:'pending',class:'status-delayed'}
  }
  const targetDate=new Date(chapter.targetDate);
  const today=new Date();
  const completionDate=progress.completionDate?new Date(progress.completionDate):null;
  
  // ‚úÖ FIXED: Check if test is NOT 'Yes' (handles both 'No' and undefined)
  if(progress.completed==='Yes'&&progress.testConducted!=='Yes'){
    return{label:'‚ö†Ô∏è Test Pending',color:'delayed',class:'status-delayed'}
  }
  
  // Only show green when BOTH are Yes
  if(progress.completed==='Yes'&&progress.testConducted==='Yes'){
    if(completionDate){
      if(completionDate<targetDate){
        return{label:'Ahead - Good Job! üéâ',color:'completed',class:'status-ahead'}
      }else if(completionDate.toDateString()===targetDate.toDateString()){
        return{label:'On Track ‚úì',color:'completed',class:'status-ontrack'}
      }else{
        return{label:'Completed (Late)',color:'delayed',class:'status-delayed'}
      }
    }
    return{label:'Completed ‚úì',color:'completed',class:'status-ahead'}
  }
  
  if(today>targetDate){
    return{label:'Delayed ‚ö†Ô∏è',color:'delayed',class:'status-delayed'}
  }
  return{label:'Pending',color:'pending',class:'status-delayed'}
};
// ====================================
// INSTALL PROMPT COMPONENT (PWA)
// ====================================
function InstallPrompt(){
  const[deferredPrompt,setDeferredPrompt]=useState(null);
  const[showInstall,setShowInstall]=useState(false);
  const[isInstalled,setIsInstalled]=useState(false);

  useEffect(()=>{
    // Check if running as installed PWA
    const checkInstalled = () => {
      const standalone = window.matchMedia('(display-mode: standalone)').matches;
      const fromHomeScreen = window.navigator.standalone === true;
      return standalone || fromHomeScreen;
    };
    
    if(checkInstalled()){
      setIsInstalled(true);
      setShowInstall(false);
      document.body.classList.remove('has-install-banner');
      return;
    }
    
    // Check if user dismissed the banner before
    const dismissed = localStorage.getItem('installBannerDismissed');
    const dismissedTime = localStorage.getItem('installBannerDismissedTime');
    
    // Show again after 7 days if dismissed
    if(dismissed === 'true' && dismissedTime){
      const daysSinceDismissed = (Date.now() - parseInt(dismissedTime)) / (1000 * 60 * 60 * 24);
      if(daysSinceDismissed < 7){
        document.body.classList.remove('has-install-banner');
        return;
      }
    }
    
    const handler=(e)=>{
      e.preventDefault();
      setDeferredPrompt(e);
      setShowInstall(true);
      document.body.classList.add('has-install-banner');
    };
    window.addEventListener('beforeinstallprompt',handler);
    
    // For browsers that don't support beforeinstallprompt, show manual install guide
    const timer = setTimeout(() => {
      if(!deferredPrompt && !checkInstalled()){
        setShowInstall(true);
        document.body.classList.add('has-install-banner');
      }
    }, 2000);
    
    return()=>{
      window.removeEventListener('beforeinstallprompt',handler);
      clearTimeout(timer);
    };
  },[deferredPrompt]);

  const handleInstall=async()=>{
    if(deferredPrompt){
      deferredPrompt.prompt();
      const{outcome}=await deferredPrompt.userChoice;
      if(outcome === 'accepted'){
        setShowInstall(false);
        document.body.classList.remove('has-install-banner');
      }
      setDeferredPrompt(null);
    } else {
      // Show manual install instructions
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      if(isMobile){
        if(/iPhone|iPad|iPod/i.test(navigator.userAgent)){
          alert('üì± To install on iOS:\n\n1. Tap the Share button (üì§) at the bottom\n2. Scroll down and tap "Add to Home Screen"\n3. Tap "Add" to confirm');
        } else {
          alert('üì± To install on Android:\n\n1. Tap the menu (‚ãÆ) at the top right\n2. Tap "Add to Home Screen" or "Install app"\n3. Tap "Install" to confirm');
        }
      } else {
        alert('üíª To install on Desktop:\n\n1. Look for the install icon (‚äï or üì•) in the address bar\n2. Or click the menu (‚ãÆ) and select "Install Curriculum Tracker"');
      }
    }
  };

  const handleDismiss=()=>{
    setShowInstall(false);
    document.body.classList.remove('has-install-banner');
    localStorage.setItem('installBannerDismissed','true');
    localStorage.setItem('installBannerDismissedTime',Date.now().toString());
  };

  // Don't show if installed or dismissed
  if(isInstalled || !showInstall) return null;

  return(
    <div className="install-app-banner">
      <div className="install-app-banner-text">
        <i className="fa-solid fa-mobile-screen-button"></i>
        <span>Install curriculum tracker app</span>
      </div>
      <button onClick={handleInstall} className="install-app-banner-btn">
        <i className="fa-solid fa-download"></i>
        Install
      </button>
      <button onClick={handleDismiss} className="install-app-banner-close" title="Dismiss">
        <i className="fa-solid fa-times"></i>
      </button>
    </div>
  );
}
// ========================================
// STUDENT PROFILE FORM COMPONENT
// ========================================
function StudentProfileForm({ currentUser }) {
  const myId = currentUser.studentId || currentUser.id;

  const [profile, setProfile] = useState({
    firstName: '',
    lastName: '',
    email: '',
    phone: '',
    dob: '',
    grade: currentUser.grade || '',
    category: '',
    stream: '',
    school: currentUser.school || '',
    fatherName: '',
    motherName: '',
    fatherOccupation: '',
    fatherOccupationOther: '',
    motherOccupation: '',
    motherOccupationOther: '',
    fatherEducation: '',
    fatherEducationOther: '',
    motherEducation: '',
    motherEducationOther: '',
    familyIncome: '',
    address: '',
    state: '',
    stateOther: '',
    district: '',
    districtOther: '',
    pincode: '',
    whatsappNumber: '',
    percentage10th: '',
    percentage11th: ''
  });

  const [loading, setLoading] = useState(true);
  const [isEditing, setIsEditing] = useState(false);

  useEffect(() => {
    const fetchProfile = async () => {
      try {
        setLoading(true);
        const docSnap = await db.collection('studentProfiles').doc(myId).get();
        if (docSnap.exists) {
          setProfile(prev => ({ ...prev, ...docSnap.data() }));
        }
        setLoading(false);
      } catch (e) {
        console.error('Error fetching profile:', e);
        setLoading(false);
      }
    };
    fetchProfile();
  }, [myId]);

  const calculateCompletion = () => {
    const requiredFields = [
      'firstName', 'lastName', 'email', 'phone', 'dob', 'grade', 'category',
      'stream', 'school', 'fatherName', 'motherName', 'fatherOccupation',
      'motherOccupation', 'fatherEducation', 'motherEducation', 'familyIncome',
      'address', 'state', 'district', 'pincode', 'whatsappNumber', 'percentage10th'
    ];
    const filled = requiredFields.filter(
      field => profile[field] && String(profile[field]).trim() !== ''
    ).length;
    return Math.round((filled / requiredFields.length) * 100);
  };

  const handleSave = async () => {
    try {
      await db.collection('studentProfiles').doc(myId).set({
        ...profile,
        studentId: myId,
        updatedAt: new Date().toISOString()
      });
      alert('‚úÖ Profile saved successfully!');
      return true;
    } catch (error) {
      console.error('Error saving profile:', error);
      alert('‚ùå Error saving profile: ' + error.message);
      return false;
    }
  };

  const handleToggleEdit = async () => {
    if (isEditing) {
      // closing edit ‚Üí save
      const saved = await handleSave();
      if (saved) {
        setIsEditing(false);
      }
    } else {
      setIsEditing(true);
    }
  };

  const completion = calculateCompletion();

  const inputCls = (extra = '') =>
    `w-full border-2 px-4 py-3 rounded-xl ${extra} ${
      !isEditing ? 'bg-gray-100 cursor-not-allowed' : ''
    }`;

  const disabled = !isEditing;

  if (loading) {
    return <div className="text-center py-8">Loading profile...</div>;
  }

  return (
    <div className="space-y-6">
      {/* Header with Student ID */}
      <div className="bg-gradient-to-r from-blue-500 to-purple-600 text-white p-6 rounded-2xl shadow-lg">
        <div className="flex justify-between items-start flex-wrap gap-4">
          <div>
            <h2 className="text-3xl font-bold">üë§ My Profile</h2>
            <div className="flex flex-wrap gap-2 mt-3">
              <span className="px-3 py-1 bg-white/30 text-white rounded-lg text-sm font-mono">
                Student ID: {myId}
              </span>
              <span className="px-3 py-1 bg-white/30 text-white rounded-lg text-sm">
                {currentUser.school}
              </span>
              <span className="px-3 py-1 bg-white/30 text-white rounded-lg text-sm">
                Class {currentUser.grade}
              </span>
            </div>
          </div>
          <div className="flex items-center gap-4">
            <div className="text-right">
              <div className="text-sm opacity-90">Profile Completion</div>
              <div
                className="text-3xl font-bold"
                style={{
                  color:
                    completion >= 80
                      ? '#86EFAC'
                      : completion >= 50
                      ? '#FCD34D'
                      : '#FCA5A5'
                }}
              >
                {completion}%
              </div>
            </div>
            <button
              onClick={handleToggleEdit}
              className="px-4 py-2 bg-white text-blue-600 rounded-xl font-semibold hover:bg-blue-50"
            >
              {isEditing ? 'Save' : 'Edit'}
            </button>
          </div>
        </div>
      </div>

      {completion < 100 && (
        <div className="bg-orange-50 border-2 border-orange-300 p-4 rounded-xl">
          <p className="text-orange-800 font-semibold">
            ‚ö†Ô∏è Click Edit, complete your profile and then press Save.
          </p>
        </div>
      )}

      <div className="bg-white p-6 rounded-2xl shadow-lg space-y-6">
        {/* Personal Information */}
        <div className="border-4 border-blue-500 rounded-2xl p-6 bg-blue-50">
          <h3 className="text-2xl font-bold mb-4 text-blue-800">üìã Personal Information</h3>
          <div className="grid md:grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-bold mb-2">First Name *</label>
              <input
                type="text"
                value={profile.firstName}
                disabled={disabled}
                onChange={e => setProfile({ ...profile, firstName: e.target.value })}
                className={inputCls()}
              />
            </div>
            <div>
              <label className="block text-sm font-bold mb-2">Last Name *</label>
              <input
                type="text"
                value={profile.lastName}
                disabled={disabled}
                onChange={e => setProfile({ ...profile, lastName: e.target.value })}
                className={inputCls()}
              />
            </div>
            <div>
              <label className="block text-sm font-bold mb-2">Email ID *</label>
              <input
                type="email"
                value={profile.email}
                disabled={disabled}
                onChange={e => setProfile({ ...profile, email: e.target.value })}
                className={inputCls()}
              />
            </div>
            <div>
              <label className="block text-sm font-bold mb-2">Phone Number *</label>
              <input
                type="tel"
                value={profile.phone}
                disabled={disabled}
                onChange={e => setProfile({ ...profile, phone: e.target.value })}
                className={inputCls()}
              />
            </div>
            <div>
              <label className="block text-sm font-bold mb-2">Date of Birth *</label>
              <input
                type="date"
                value={profile.dob}
                disabled={disabled}
                onChange={e => setProfile({ ...profile, dob: e.target.value })}
                className={inputCls()}
              />
            </div>
            <div>
              <label className="block text-sm font-bold mb-2">Class *</label>
              <select
                value={profile.grade}
                disabled={disabled}
                onChange={e => setProfile({ ...profile, grade: e.target.value })}
                className={inputCls()}
              >
                <option value="">Select</option>
                <option value="11">11th</option>
                <option value="12">12th</option>
              </select>
            </div>
            <div>
              <label className="block text-sm font-bold mb-2">Category *</label>
              <select
                value={profile.category}
                disabled={disabled}
                onChange={e => setProfile({ ...profile, category: e.target.value })}
                className={inputCls()}
              >
                <option value="">Select</option>
                {CATEGORIES.map(c => (
                  <option key={c} value={c}>{c}</option>
                ))}
              </select>
            </div>
            <div>
              <label className="block text-sm font-bold mb-2">Stream *</label>
              <select
                value={profile.stream}
                disabled={disabled}
                onChange={e => setProfile({ ...profile, stream: e.target.value })}
                className={inputCls()}
              >
                <option value="">Select</option>
                {STREAMS.map(s => (
                  <option key={s} value={s}>{s}</option>
                ))}
              </select>
            </div>
            <div>
              <label className="block text-sm font-bold mb-2">School *</label>
              <select
                value={profile.school}
                disabled={disabled}
                onChange={e => setProfile({ ...profile, school: e.target.value })}
                className={inputCls()}
              >
                <option value="">Select</option>
                {SCHOOLS.map(s => (
                  <option key={s} value={s}>{s}</option>
                ))}
              </select>
            </div>
            <div>
              <label className="block text-sm font-bold mb-2">
                10th Overall Percentage *
              </label>
              <input
                type="number"
                step="0.01"
                value={profile.percentage10th}
                disabled={disabled}
                onChange={e => setProfile({ ...profile, percentage10th: e.target.value })}
                className={inputCls()}
                placeholder="e.g. 85.5"
              />
            </div>
            <div>
              <label className="block text-sm font-bold mb-2">
                11th Overall Percentage (Optional)
              </label>
              <input
                type="number"
                step="0.01"
                value={profile.percentage11th}
                disabled={disabled}
                onChange={e => setProfile({ ...profile, percentage11th: e.target.value })}
                className={inputCls()}
                placeholder="e.g. 80.0"
              />
            </div>
          </div>
        </div>

        {/* Parent Information */}
        <div className="border-4 border-purple-500 rounded-2xl p-6 bg-purple-50">
          <h3 className="text-2xl font-bold mb-4 text-purple-800">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Parent Information</h3>
          <div className="grid md:grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-bold mb-2">Father's Name *</label>
              <input
                type="text"
                value={profile.fatherName}
                disabled={disabled}
                onChange={e => setProfile({ ...profile, fatherName: e.target.value })}
                className={inputCls()}
              />
            </div>
            <div>
              <label className="block text-sm font-bold mb-2">Mother's Name *</label>
              <input
                type="text"
                value={profile.motherName}
                disabled={disabled}
                onChange={e => setProfile({ ...profile, motherName: e.target.value })}
                className={inputCls()}
              />
            </div>
            <div>
              <label className="block text-sm font-bold mb-2">Father's Occupation *</label>
              <select
                value={profile.fatherOccupation}
                disabled={disabled}
                onChange={e => setProfile({ ...profile, fatherOccupation: e.target.value, fatherOccupationOther: '' })}
                className={inputCls()}
              >
                <option value="">Select Occupation</option>
                {OCCUPATIONS.map(o => <option key={o} value={o}>{o}</option>)}
              </select>
              {profile.fatherOccupation === 'Others' && (
                <input
                  type="text"
                  placeholder="Please specify occupation"
                  value={profile.fatherOccupationOther}
                  disabled={disabled}
                  onChange={e => setProfile({ ...profile, fatherOccupationOther: e.target.value })}
                  className={inputCls('mt-2')}
                />
              )}
            </div>
            <div>
              <label className="block text-sm font-bold mb-2">Mother's Occupation *</label>
              <select
                value={profile.motherOccupation}
                disabled={disabled}
                onChange={e => setProfile({ ...profile, motherOccupation: e.target.value, motherOccupationOther: '' })}
                className={inputCls()}
              >
                <option value="">Select Occupation</option>
                {OCCUPATIONS.map(o => <option key={o} value={o}>{o}</option>)}
              </select>
              {profile.motherOccupation === 'Others' && (
                <input
                  type="text"
                  placeholder="Please specify occupation"
                  value={profile.motherOccupationOther}
                  disabled={disabled}
                  onChange={e => setProfile({ ...profile, motherOccupationOther: e.target.value })}
                  className={inputCls('mt-2')}
                />
              )}
            </div>
            <div>
              <label className="block text-sm font-bold mb-2">Father's Education *</label>
              <select
                value={profile.fatherEducation}
                disabled={disabled}
                onChange={e => setProfile({ ...profile, fatherEducation: e.target.value, fatherEducationOther: '' })}
                className={inputCls()}
              >
                <option value="">Select Education</option>
                {EDUCATION_LEVELS.map(e => <option key={e} value={e}>{e}</option>)}
              </select>
              {profile.fatherEducation === 'Others' && (
                <input
                  type="text"
                  placeholder="Please specify education"
                  value={profile.fatherEducationOther}
                  disabled={disabled}
                  onChange={e => setProfile({ ...profile, fatherEducationOther: e.target.value })}
                  className={inputCls('mt-2')}
                />
              )}
            </div>
            <div>
              <label className="block text-sm font-bold mb-2">Mother's Education *</label>
              <select
                value={profile.motherEducation}
                disabled={disabled}
                onChange={e => setProfile({ ...profile, motherEducation: e.target.value, motherEducationOther: '' })}
                className={inputCls()}
              >
                <option value="">Select Education</option>
                {EDUCATION_LEVELS.map(e => <option key={e} value={e}>{e}</option>)}
              </select>
              {profile.motherEducation === 'Others' && (
                <input
                  type="text"
                  placeholder="Please specify education"
                  value={profile.motherEducationOther}
                  disabled={disabled}
                  onChange={e => setProfile({ ...profile, motherEducationOther: e.target.value })}
                  className={inputCls('mt-2')}
                />
              )}
            </div>
            <div>
              <label className="block text-sm font-bold mb-2">Family Income *</label>
              <select
                value={profile.familyIncome}
                disabled={disabled}
                onChange={e => setProfile({ ...profile, familyIncome: e.target.value })}
                className={inputCls()}
              >
                <option value="">Select Income Range</option>
                {INCOME_RANGES.map(i => <option key={i} value={i}>{i}</option>)}
              </select>
            </div>
          </div>
        </div>

        {/* Contact Details */}
        <div className="border-4 border-green-500 rounded-2xl p-6 bg-green-50">
          <h3 className="text-2xl font-bold mb-4 text-green-800">üìÆ Contact Details</h3>
          <div className="grid md:grid-cols-2 gap-4">
            <div className="md:col-span-2">
              <label className="block text-sm font-bold mb-2">Address *</label>
              <input
                type="text"
                value={profile.address}
                disabled={disabled}
                onChange={e => setProfile({ ...profile, address: e.target.value })}
                className={inputCls()}
              />
            </div>
            <div>
              <label className="block text-sm font-bold mb-2">State *</label>
              <select
                value={profile.state}
                disabled={disabled}
                onChange={e => setProfile({ ...profile, state: e.target.value, district: '', districtOther: '' })}
                className={inputCls()}
              >
                <option value="">Select State</option>
                {INDIAN_STATES.map(s => <option key={s} value={s}>{s}</option>)}
                <option value="Others">Others</option>
              </select>
              {profile.state === 'Others' && (
                <input
                  type="text"
                  placeholder="Please specify state"
                  value={profile.stateOther}
                  disabled={disabled}
                  onChange={e => setProfile({ ...profile, stateOther: e.target.value })}
                  className={inputCls('mt-2')}
                />
              )}
            </div>
            <div>
              <label className="block text-sm font-bold mb-2">District *</label>
              <select
                value={profile.district}
                disabled={disabled || !profile.state || profile.state === 'Others'}
                onChange={e => setProfile({ ...profile, district: e.target.value, districtOther: '' })}
                className={inputCls()}
              >
                <option value="">Select District</option>
                {profile.state && profile.state !== 'Others' && STATE_DISTRICTS[profile.state] && 
                  STATE_DISTRICTS[profile.state].map(d => <option key={d} value={d}>{d}</option>)}
                <option value="Others">Others</option>
              </select>
              {profile.district === 'Others' && (
                <input
                  type="text"
                  placeholder="Please specify district"
                  value={profile.districtOther}
                  disabled={disabled}
                  onChange={e => setProfile({ ...profile, districtOther: e.target.value })}
                  className={inputCls('mt-2')}
                />
              )}
            </div>
            <div>
              <label className="block text-sm font-bold mb-2">Pincode *</label>
              <input
                type="text"
                value={profile.pincode}
                disabled={disabled}
                onChange={e => setProfile({ ...profile, pincode: e.target.value })}
                className={inputCls()}
              />
            </div>
            <div>
              <label className="block text-sm font-bold mb-2">WhatsApp Number *</label>
              <input
                type="text"
                value={profile.whatsappNumber}
                disabled={disabled}
                onChange={e => setProfile({ ...profile, whatsappNumber: e.target.value })}
                className={inputCls()}
              />
            </div>
          </div>
        </div>
      </div>
      {/* Academic Info (optional extras ‚Äì currently just shows percentages again if needed) */}
      <div className="border-4 border-indigo-500 rounded-2xl p-6 bg-indigo-50">
        <div className="flex justify-between items-center mb-4">
          <h3 className="text-2xl font-bold text-indigo-800">üéì Academic Information</h3>
          <button
            onClick={handleToggleEdit}
            className="px-4 py-2 rounded-xl font-semibold text-sm bg-indigo-600 text-white"
          >
            {isEditing ? 'Save' : 'Edit'}
          </button>
        </div>
        <p className="text-sm text-gray-600">
          You can update your marks / percentages here whenever results are updated.
        </p>
        <div className="grid md:grid-cols-2 gap-4 mt-4">
          <div>
            <label className="block text-sm font-bold mb-2">10th Percentage *</label>
            <input
              type="number"
              step="0.01"
              className={inputCls()}
              disabled={!isEditing}
              value={profile.percentage10th}
              onChange={e => setProfile({ ...profile, percentage10th: e.target.value })}
            />
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">11th Percentage (Optional)</label>
            <input
              type="number"
              step="0.01"
              className={inputCls()}
              disabled={!isEditing}
              value={profile.percentage11th}
              onChange={e => setProfile({ ...profile, percentage11th: e.target.value })}
            />
          </div>
        </div>
      </div>
    </div>
  );
}

// ========================================
// STUDENT EXAM REGISTRATION COMPONENT
// ========================================
function StudentExamRegistration({currentUser}) {
  const myId = currentUser.studentId || currentUser.id;
  const myGrade = currentUser.grade;
  const [exams, setExams] = useState([]);
  const [loading, setLoading] = useState(true);
  const [expandedExams, setExpandedExams] = useState(new Set());
  const [editingExams, setEditingExams] = useState(new Set());

  useEffect(() => {
    const fetchExams = async () => {
      try {
        const docSnap = await db.collection('studentExamRegistrations').doc(myId).get();
        if (docSnap.exists) {
          setExams(docSnap.data().exams || []);
        }
        setLoading(false);
      } catch (e) {
        console.error('Error fetching exam registrations:', e);
        setLoading(false);
      }
    };
    fetchExams();
  }, [myId]);

  const handleAddExam = () => {
    const newExams = [...exams, {
      examName: '',
      registrationStatus: 'No',
      registrationNumber: '',
      password: '',
      emailUsed: '',
      phoneUsed: '',
      reasonNotCompleted: '',
      needSupport: 'No',
      supportType: ''
    }];
    setExams(newExams);
    // Auto-expand and edit the new exam
    const newIndex = newExams.length - 1;
    setExpandedExams(new Set([...expandedExams, newIndex]));
    setEditingExams(new Set([...editingExams, newIndex]));
  };

  const handleRemoveExam = (index) => {
    const updated = [...exams];
    updated.splice(index, 1);
    setExams(updated);
    // Remove from expanded and editing sets
    const newExpanded = new Set(expandedExams);
    const newEditing = new Set(editingExams);
    newExpanded.delete(index);
    newEditing.delete(index);
    setExpandedExams(newExpanded);
    setEditingExams(newEditing);
  };

  const handleExamChange = (index, field, value) => {
    const updated = [...exams];
    updated[index][field] = value;
    setExams(updated);
  };

  const toggleExpand = (index) => {
    const newExpanded = new Set(expandedExams);
    if (newExpanded.has(index)) {
      newExpanded.delete(index);
    } else {
      newExpanded.add(index);
    }
    setExpandedExams(newExpanded);
  };

  const toggleEdit = (index) => {
  const newEditing = new Set(editingExams);
  const newExpanded = new Set(expandedExams);

  if (newEditing.has(index)) {
    // closing edit
    newEditing.delete(index);
  } else {
    // going into edit ‚Üí also expand this exam
    newEditing.add(index);
    newExpanded.add(index);
  }

  setEditingExams(newEditing);
  setExpandedExams(newExpanded);
};

  const handleSave = async () => {
    try {
      await db.collection('studentExamRegistrations').doc(myId).set({
        studentId: myId,
        studentName: currentUser.name,
        school: currentUser.school,
        grade: myGrade,
        exams,
        updatedAt: new Date().toISOString()
      });
      alert('‚úÖ Exam registrations saved successfully!');
      // Collapse all exams and exit edit mode
      setExpandedExams(new Set());
      setEditingExams(new Set());
    } catch (e) {
      alert('Failed to save: ' + e.message);
    }
  };

  const examList = myGrade === '12' ? EXAMS_12TH : EXAMS_11TH;

  if (loading) {
    return <div className="text-center py-8">Loading exam registrations...</div>;
  }

  return (
    <div className="space-y-6">
      <div className="flex justify-between items-center">
        <h2 className="text-3xl font-bold">üìù Exam Registration</h2>
        <button onClick={handleAddExam} className="px-6 py-3 bg-blue-600 text-white rounded-xl font-semibold">
          + Add Exam
        </button>
      </div>

      {myGrade === '11' && (
        <div className="bg-blue-50 border-2 border-blue-300 p-4 rounded-xl">
          <p className="font-semibold text-blue-800">
            üìå Class 11: Please list the competitive exams you're interested in appearing for in the future.
          </p>
        </div>
      )}

      {exams.length === 0 ? (
        <div className="bg-white p-8 rounded-2xl text-center">
          <p className="text-gray-600">No exam registrations added yet. Click "+ Add Exam" to start.</p>
        </div>
      ) : (
        exams.map((exam, index) => {
          const isExpanded = expandedExams.has(index);
          const isEditing = editingExams.has(index);
          
          return (
          <div key={index} className="bg-white p-6 rounded-2xl shadow-lg">
            <div className="flex justify-between items-center mb-4">
              <div className="flex items-center gap-3">
                <button 
                  onClick={() => toggleExpand(index)}
                  className="text-2xl"
                >
                  {isExpanded ? '‚ñº' : '‚ñ∂'}
                </button>
                <h3 className="text-xl font-bold">
                  {exam.examName || `Exam ${index + 1}`}
                </h3>
                {exam.registrationStatus === 'Yes' && (
                  <span className="px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm font-bold">
                    ‚úì Completed
                  </span>
                )}
              </div>
              <div className="flex gap-2">
                <button 
                  onClick={() => toggleEdit(index)} 
                  className="px-4 py-2 bg-blue-500 text-white rounded-lg"
                >
                  {isEditing ? 'üíæ Save' : '‚úèÔ∏è Edit'}
                </button>
                <button 
                  onClick={() => handleRemoveExam(index)} 
                  className="px-4 py-2 bg-red-500 text-white rounded-lg"
                >
                  Remove
                </button>
              </div>
            </div>

            {isExpanded && (
            <div className="grid md:grid-cols-2 gap-4">
              <div className="md:col-span-2">
                <label className="block text-sm font-bold mb-2">Exam Name *</label>
                <select value={exam.examName} onChange={e => handleExamChange(index, 'examName', e.target.value)} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed">
                  <option value="">Select Exam</option>
                  {examList.map(e => <option key={e} value={e}>{e}</option>)}
                </select>
              </div>

              {myGrade === '12' && (
                <>
                  <div className="md:col-span-2">
                    <label className="block text-sm font-bold mb-2">Registration Completed? *</label>
                    <select value={exam.registrationStatus} onChange={e => handleExamChange(index, 'registrationStatus', e.target.value)} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed">
                      <option value="No">No</option>
                      <option value="Partially">Partially Completed</option>
                      <option value="Yes">Yes - Fully Completed</option>
                    </select>
                  </div>

                  {exam.registrationStatus === 'Yes' && (
                    <>
                      <div>
                        <label className="block text-sm font-bold mb-2">Registration Number *</label>
                        <input type="text" value={exam.registrationNumber} onChange={e => handleExamChange(index, 'registrationNumber', e.target.value)} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed" />
                      </div>
                      <div>
                        <label className="block text-sm font-bold mb-2">Password *</label>
                        <input type="text" value={exam.password} onChange={e => handleExamChange(index, 'password', e.target.value)} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed" />
                      </div>
                      <div>
                        <label className="block text-sm font-bold mb-2">Email Used for Registration *</label>
                        <input type="email" value={exam.emailUsed} onChange={e => handleExamChange(index, 'emailUsed', e.target.value)} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed" />
                      </div>
                      <div>
                        <label className="block text-sm font-bold mb-2">Phone Number Used *</label>
                        <input type="tel" value={exam.phoneUsed} onChange={e => handleExamChange(index, 'phoneUsed', e.target.value)} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed" />
                      </div>
                    </>
                  )}

                  {exam.registrationStatus === 'No' && (
                    <div className="md:col-span-2">
                      <label className="block text-sm font-bold mb-2">Why is the registration not completed? *</label>
                      <textarea value={exam.reasonNotCompleted} onChange={e => handleExamChange(index, 'reasonNotCompleted', e.target.value)} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed" rows="3" />
                    </div>
                  )}

                  <div className="md:col-span-2">
                    <label className="block text-sm font-bold mb-2">Do you need help/support to complete this application? *</label>
                    <select value={exam.needSupport} onChange={e => handleExamChange(index, 'needSupport', e.target.value)} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed">
                      <option value="No">No</option>
                      <option value="Yes">Yes</option>
                    </select>
                  </div>

                  {exam.needSupport === 'Yes' && (
                    <div className="md:col-span-2">
                      <label className="block text-sm font-bold mb-2">What kind of help do you need? *</label>
                      <textarea value={exam.supportType} onChange={e => handleExamChange(index, 'supportType', e.target.value)} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed" rows="3" placeholder="Please describe the support you need..." />
                    </div>
                  )}
                </>
              )}
            </div>
            )}
          </div>
        );
        })
      )}

      <button onClick={handleSave} className="w-full avanti-gradient text-white py-4 rounded-xl font-bold text-xl">
        üíæ Save Exam Registrations
      </button>
    </div>
  );
}

// ========================================
// ASSET MANAGEMENT - BARCODE SCANNER
// ========================================
function BarcodeScanner({ onScanSuccess, onClose }) {
  const [error, setError] = useState('');
  const [scanning, setScanning] = useState(true);
  const [scannedCode, setScannedCode] = useState(null);
  const html5QrCodeRef = useRef(null);
  const hasScannedRef = useRef(false);

  // Stop scanner helper function - now with explicit video track cleanup
  const stopScanner = useCallback(async () => {
    try {
      if (html5QrCodeRef.current) {
        try {
          const state = html5QrCodeRef.current.getState();
          // State 2 = scanning, State 1 = paused
          if (state === 2 || state === 1) {
            await html5QrCodeRef.current.stop();
            console.log('Scanner stopped successfully');
          }
        } catch (err) {
          console.log('Scanner stop error:', err);
        }
        html5QrCodeRef.current = null;
      }

      // Also manually stop any video tracks (belt and suspenders approach)
      const videoElement = document.querySelector('#barcode-reader video');
      if (videoElement && videoElement.srcObject) {
        const tracks = videoElement.srcObject.getTracks();
        tracks.forEach(track => {
          track.stop();
          console.log('Video track stopped:', track.label);
        });
        videoElement.srcObject = null;
      }

      // Clear the container
      const container = document.getElementById('barcode-reader');
      if (container) {
        container.innerHTML = '';
      }
    } catch (err) {
      console.log('Cleanup error (can be ignored):', err);
    }
  }, []);

  useEffect(() => {
    let mounted = true;

    const startScanner = async () => {
      try {
        // Wait a bit for DOM to be ready
        await new Promise(resolve => setTimeout(resolve, 100));
        
        if (!mounted || hasScannedRef.current) return;

        html5QrCodeRef.current = new Html5Qrcode("barcode-reader");
        
        const config = {
          fps: 10,
          qrbox: { width: 250, height: 100 },
          aspectRatio: 1.777778,
          formatsToSupport: [
            Html5QrcodeSupportedFormats.EAN_13,
            Html5QrcodeSupportedFormats.EAN_8,
            Html5QrcodeSupportedFormats.UPC_A,
            Html5QrcodeSupportedFormats.UPC_E,
            Html5QrcodeSupportedFormats.CODE_128,
            Html5QrcodeSupportedFormats.CODE_39
          ]
        };

        await html5QrCodeRef.current.start(
          { facingMode: "environment" },
          config,
          async (decodedText) => {
            // Prevent multiple scans
            if (hasScannedRef.current) return;
            hasScannedRef.current = true;
            
            console.log('Barcode scanned:', decodedText);
            setScanning(false);
            setScannedCode(decodedText);
            
            // Stop the scanner first
            await stopScanner();
            
            // Then call success callback
            onScanSuccess(decodedText);
          },
          (errorMessage) => {}
        );
      } catch (err) {
        console.error('Scanner error:', err);
        if (mounted) {
          setError('Camera access denied. Please allow camera access and try again.');
        }
      }
    };

    startScanner();

    return () => {
      mounted = false;
      stopScanner();
    };
  }, []);

  const handleClose = async () => {
    await stopScanner();
    onClose();
  };

  return (
    <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[10000] p-4">
      <div className="bg-white rounded-2xl p-6 w-full max-w-md">
        <div className="flex justify-between items-center mb-4">
          <h3 className="text-xl font-bold">üì∑ Scan Barcode</h3>
          <button
            onClick={handleClose}
            className="text-2xl text-gray-500 hover:text-gray-700"
          >
            ‚úï
          </button>
        </div>

        {error ? (
          <div className="text-center py-8">
            <p className="text-red-500 mb-4">{error}</p>
            <button onClick={() => window.location.reload()} className="px-6 py-3 bg-blue-500 text-white rounded-xl font-semibold">
              Retry
            </button>
          </div>
        ) : (
          <>
            <div className="barcode-scanner-container mb-4">
              <div id="barcode-reader"></div>
              {scanning && <p className="text-center text-gray-600 mt-2">Point camera at barcode...</p>}
            </div>
            <p className="text-sm text-gray-500 text-center">
              Position the barcode within the frame. It will scan automatically.
            </p>
          </>
        )}
      </div>
    </div>
  );
}

// ========================================
// ISBN LOOKUP UTILITY
// ========================================
// ========================================
// INDIAN EDUCATIONAL BOOKS DATABASE
// Common JEE/NEET books not found in Google Books API
// ========================================
const INDIAN_BOOKS_DB = {
  '9789368024552': { title: 'Advanced Problems in Mathematics for JEE', author: 'Vikas Gupta, Pankaj Joshi', publisher: 'Shree Balaji Publications', category: 'JEE Preparation' },
  '9788193975800': { title: 'Problems in Physics', author: 'S.S. Krotov', publisher: 'CBS Publishers', category: 'Physics' },
  '9789384934002': { title: 'Cengage Physics', author: 'B.M. Sharma', publisher: 'Cengage Learning', category: 'JEE Physics' },
  '9789354491719': { title: 'HC Verma Concepts of Physics Vol 1', author: 'H.C. Verma', publisher: 'Bharati Bhawan', category: 'Physics' },
  '9789354491726': { title: 'HC Verma Concepts of Physics Vol 2', author: 'H.C. Verma', publisher: 'Bharati Bhawan', category: 'Physics' },
  '9789311123394': { title: 'Organic Chemistry Morrison Boyd', author: 'Morrison & Boyd', publisher: 'Pearson', category: 'Organic Chemistry' },
  '9788120349858': { title: 'Concise Inorganic Chemistry', author: 'J.D. Lee', publisher: 'Wiley', category: 'Inorganic Chemistry' },
  '9789332519008': { title: 'Physical Chemistry', author: 'OP Tandon', publisher: 'G.R. Bathla Publications', category: 'Physical Chemistry' },
  '9788183486934': { title: 'Problems in General Physics', author: 'I.E. Irodov', publisher: 'Arihant', category: 'Physics' },
  '9789325793729': { title: 'Coordinate Geometry for JEE', author: 'S.K. Goyal', publisher: 'Arihant', category: 'Mathematics' },
  '9789325798625': { title: 'Differential Calculus for JEE', author: 'Amit M Agarwal', publisher: 'Arihant', category: 'Mathematics' },
  '9789325798618': { title: 'Integral Calculus for JEE', author: 'Amit M Agarwal', publisher: 'Arihant', category: 'Mathematics' },
  '9788177091878': { title: 'IIT Mathematics', author: 'M.L. Khanna', publisher: 'Jai Prakash Nath', category: 'Mathematics' },
  '9789388241755': { title: 'Objective NCERT Xtract Physics', author: 'MTG Editorial Board', publisher: 'MTG Learning', category: 'NEET Physics' },
  '9789388241762': { title: 'Objective NCERT Xtract Chemistry', author: 'MTG Editorial Board', publisher: 'MTG Learning', category: 'NEET Chemistry' },
  '9789388241779': { title: 'Objective NCERT Xtract Biology', author: 'MTG Editorial Board', publisher: 'MTG Learning', category: 'NEET Biology' },
  '9789389167542': { title: 'NCERT Fingertips Biology', author: 'MTG Editorial Board', publisher: 'MTG Learning', category: 'NEET Biology' },
  '9789312146712': { title: 'Pradeep Chemistry Class 11', author: 'S.C. Kheterpal', publisher: 'Pradeep Publications', category: 'Chemistry' },
  '9789312146729': { title: 'Pradeep Chemistry Class 12', author: 'S.C. Kheterpal', publisher: 'Pradeep Publications', category: 'Chemistry' },
  '9789388127820': { title: 'Cengage Chemistry', author: 'K.S. Verma', publisher: 'Cengage Learning', category: 'JEE Chemistry' },
  '9789332586949': { title: 'RD Sharma Mathematics Class 11', author: 'R.D. Sharma', publisher: 'Dhanpat Rai', category: 'Mathematics' },
  '9789332586956': { title: 'RD Sharma Mathematics Class 12', author: 'R.D. Sharma', publisher: 'Dhanpat Rai', category: 'Mathematics' },
  // Add more as needed
};

// ========================================
// ISBN LOOKUP - Multi-source with Indian DB
// ========================================
async function lookupISBN(isbn) {
  try {
    const cleanISBN = isbn.replace(/[-\s]/g, '');
    console.log('[ISBN] Looking up:', cleanISBN);
    
    // ‚úÖ FIRST: Check local Indian books database
    if (INDIAN_BOOKS_DB[cleanISBN]) {
      console.log('[ISBN] Found in Indian Books DB!');
      const book = INDIAN_BOOKS_DB[cleanISBN];
      return {
        found: true,
        title: book.title,
        author: book.author,
        publisher: book.publisher,
        category: book.category,
        isbn: cleanISBN,
        source: 'Indian Books Database'
      };
    }
    
    // Try Open Library API first (free, no API key needed)
    try {
      const response = await fetch(`https://openlibrary.org/api/books?bibkeys=ISBN:${cleanISBN}&jscmd=data&format=json`);
      const data = await response.json();
      const bookData = data[`ISBN:${cleanISBN}`];
      
      if (bookData) {
        console.log('[ISBN] Found in Open Library!');
        return {
          found: true,
          title: bookData.title || '',
          author: bookData.authors ? bookData.authors.map(a => a.name).join(', ') : '',
          publisher: bookData.publishers ? bookData.publishers.map(p => p.name).join(', ') : '',
          isbn: cleanISBN,
          source: 'Open Library'
        };
      }
    } catch (e) {
      console.log('[ISBN] Open Library error:', e);
    }
    
    // Try Google Books API as fallback
    try {
      const googleResponse = await fetch(`https://www.googleapis.com/books/v1/volumes?q=isbn:${cleanISBN}`);
      const googleData = await googleResponse.json();
      
      if (googleData.items && googleData.items.length > 0) {
        const book = googleData.items[0].volumeInfo;
        console.log('[ISBN] Found in Google Books!');
        return {
          found: true,
          title: book.title || '',
          author: book.authors ? book.authors.join(', ') : '',
          publisher: book.publisher || '',
          isbn: cleanISBN,
          source: 'Google Books'
        };
      }
    } catch (e) {
      console.log('[ISBN] Google Books error:', e);
    }
    
    // ‚úÖ Try with ISBN-10 format if ISBN-13 failed
    if (cleanISBN.length === 13 && cleanISBN.startsWith('978')) {
      const isbn10 = convertISBN13to10(cleanISBN);
      if (isbn10) {
        console.log('[ISBN] Trying ISBN-10 format:', isbn10);
        
        // Check Indian DB with ISBN-10
        for (const [key, value] of Object.entries(INDIAN_BOOKS_DB)) {
          if (key.includes(isbn10) || convertISBN13to10(key) === isbn10) {
            console.log('[ISBN] Found via ISBN-10 conversion!');
            return {
              found: true,
              title: value.title,
              author: value.author,
              publisher: value.publisher,
              category: value.category,
              isbn: cleanISBN,
              source: 'Indian Books Database (ISBN-10)'
            };
          }
        }
        
        // Try Open Library with ISBN-10
        try {
          const response = await fetch(`https://openlibrary.org/api/books?bibkeys=ISBN:${isbn10}&jscmd=data&format=json`);
          const data = await response.json();
          const bookData = data[`ISBN:${isbn10}`];
          
          if (bookData) {
            console.log('[ISBN] Found via ISBN-10 in Open Library!');
            return {
              found: true,
              title: bookData.title || '',
              author: bookData.authors ? bookData.authors.map(a => a.name).join(', ') : '',
              publisher: bookData.publishers ? bookData.publishers.map(p => p.name).join(', ') : '',
              isbn: cleanISBN,
              source: 'Open Library (ISBN-10)'
            };
          }
        } catch (e) {}
      }
    }
    
    console.log('[ISBN] Not found in any database');
    return { found: false, isbn: cleanISBN };
  } catch (error) {
    console.error('ISBN lookup error:', error);
    return { found: false, isbn: isbn };
  }
}

// Convert ISBN-13 to ISBN-10
function convertISBN13to10(isbn13) {
  try {
    if (isbn13.length !== 13 || !isbn13.startsWith('978')) return null;
    const isbn9 = isbn13.substring(3, 12);
    let sum = 0;
    for (let i = 0; i < 9; i++) {
      sum += parseInt(isbn9[i]) * (10 - i);
    }
    const checkDigit = (11 - (sum % 11)) % 11;
    return isbn9 + (checkDigit === 10 ? 'X' : checkDigit.toString());
  } catch (e) {
    return null;
  }
}

// ========================================
// ADD ASSET MODAL
// ========================================
function AddAssetModal({ barcode, lookupResult, lookingUp, onSave, onClose }) {
  const [assetType, setAssetType] = useState('book');
  const [title, setTitle] = useState('');
  const [author, setAuthor] = useState('');
  const [publisher, setPublisher] = useState('');
  const [category, setCategory] = useState('Other');
  const [serialNumber, setSerialNumber] = useState('');
  const [model, setModel] = useState('');
  const [manualBarcode, setManualBarcode] = useState('');
  const [copyNumber, setCopyNumber] = useState(1);
  
  // Check if this is a manual add (barcode starts with MANUAL-)
  const isManualAdd = barcode && barcode.startsWith('MANUAL-');
  const isAdditionalCopy = lookupResult?.isAdditionalCopy;

  useEffect(() => {
    if (lookupResult && lookupResult.found) {
      setTitle(lookupResult.title || '');
      setAuthor(lookupResult.author || '');
      setPublisher(lookupResult.publisher || '');
      setAssetType('book');
      if (lookupResult.copyNumber) {
        setCopyNumber(lookupResult.copyNumber);
      }
    }
  }, [lookupResult]);

  const handleSubmit = (e) => {
    e.preventDefault();
    if (!title.trim()) { alert('Please enter a title'); return; }
    
    // Generate barcode with copy number for books
    let finalBarcode;
    if (isManualAdd) {
      finalBarcode = manualBarcode.trim() || `ASSET-${Date.now()}`;
    } else if (assetType === 'book' && copyNumber > 1) {
      // For additional copies, append copy number to barcode
      finalBarcode = `${barcode}-copy-${copyNumber}`;
    } else if (assetType === 'book' && copyNumber === 1) {
      // First copy keeps original barcode
      finalBarcode = barcode;
    } else {
      finalBarcode = barcode;
    }

    onSave({
      barcode: finalBarcode, 
      assetType, 
      title: title.trim(),
      author: assetType === 'book' ? author.trim() : '',
      publisher: assetType === 'book' ? publisher.trim() : '',
      category: assetType === 'book' ? category : '',
      serialNumber: assetType === 'chromebook' ? serialNumber.trim() : '',
      model: assetType === 'chromebook' ? model.trim() : '',
      isbn: lookupResult?.isbn || barcode || '',
      copyNumber: assetType === 'book' ? copyNumber : null
    });
  };

  return (
    <div className="modal-overlay" onClick={onClose}>
      <div className="modal-content" onClick={e => e.stopPropagation()}>
        <div className="flex justify-between items-center mb-4">
          <h3 className="text-xl font-bold">
            {isAdditionalCopy ? `üìö Add Copy #${copyNumber}` : isManualAdd ? '‚úèÔ∏è Add Asset Manually' : '‚ûï Add New Asset'}
          </h3>
          <button onClick={onClose} className="text-2xl text-gray-500">‚úï</button>
        </div>

        {lookingUp ? (
          <div className="text-center py-8">
            <div className="animate-spin text-4xl mb-4">üîÑ</div>
            <p>Looking up book details...</p>
          </div>
        ) : (
          <form onSubmit={handleSubmit} className="space-y-4">
            {!isManualAdd && (
              <div className={`p-3 rounded-lg ${isAdditionalCopy ? 'bg-blue-50 border-2 border-blue-200' : 'bg-gray-100'}`}>
                <p className="text-sm text-gray-600">ISBN/Barcode: <strong>{barcode}</strong></p>
                {isAdditionalCopy && (
                  <p className="text-sm text-blue-600 mt-1 font-semibold">üìö Adding Copy #{copyNumber} of this book</p>
                )}
                {lookupResult?.found && !isAdditionalCopy && <p className="text-sm text-green-600 mt-1">‚úì Book details found!</p>}
                {lookupResult && !lookupResult.found && !isAdditionalCopy && (
                  <div className="text-sm text-orange-600 mt-1">
                    <p className="font-semibold">üìö Book not found in database.</p>
                    <p className="text-xs mt-1">Please enter details manually. For multiple copies of same book, add one copy first then use the "üìã Copy" button.</p>
                  </div>
                )}
              </div>
            )}

            <div>
              <label className="block text-sm font-bold mb-2">Asset Type *</label>
              <select value={assetType} onChange={(e) => setAssetType(e.target.value)} className="w-full border-2 px-4 py-3 rounded-xl" disabled={isAdditionalCopy}>
                <option value="book">üìö Book</option>
                <option value="chromebook">üíª Chromebook</option>
              </select>
            </div>

            {isManualAdd && (
              <div>
                <label className="block text-sm font-bold mb-2">
                  {assetType === 'book' ? 'ISBN / Barcode (Optional)' : 'Asset ID / Serial (Optional)'}
                </label>
                <input 
                  type="text" 
                  value={manualBarcode} 
                  onChange={(e) => setManualBarcode(e.target.value)} 
                  placeholder={assetType === 'book' ? 'e.g., 9781234567890 or leave empty' : 'e.g., CB-001 or leave empty'} 
                  className="w-full border-2 px-4 py-3 rounded-xl" 
                />
                <p className="text-xs text-gray-500 mt-1">If left empty, a unique ID will be generated automatically</p>
              </div>
            )}

            <div>
              <label className="block text-sm font-bold mb-2">Title *</label>
              <input type="text" value={title} onChange={(e) => setTitle(e.target.value)} placeholder="Enter title" className="w-full border-2 px-4 py-3 rounded-xl" required />
            </div>

            {assetType === 'book' && (
              <>
                <div>
                  <label className="block text-sm font-bold mb-2">Author</label>
                  <input type="text" value={author} onChange={(e) => setAuthor(e.target.value)} placeholder="Enter author" className="w-full border-2 px-4 py-3 rounded-xl" />
                </div>
                <div>
                  <label className="block text-sm font-bold mb-2">Publisher</label>
                  <input type="text" value={publisher} onChange={(e) => setPublisher(e.target.value)} placeholder="Enter publisher" className="w-full border-2 px-4 py-3 rounded-xl" />
                </div>
                <div>
                  <label className="block text-sm font-bold mb-2">Category</label>
                  <select value={category} onChange={(e) => setCategory(e.target.value)} className="w-full border-2 px-4 py-3 rounded-xl">
                    {ASSET_CATEGORIES.map(cat => <option key={cat} value={cat}>{cat}</option>)}
                  </select>
                </div>
              </>
            )}

            {assetType === 'chromebook' && (
              <>
                <div>
                  <label className="block text-sm font-bold mb-2">Model</label>
                  <input type="text" value={model} onChange={(e) => setModel(e.target.value)} placeholder="e.g., HP Chromebook 11 G8" className="w-full border-2 px-4 py-3 rounded-xl" />
                </div>
                <div>
                  <label className="block text-sm font-bold mb-2">Serial Number</label>
                  <input type="text" value={serialNumber} onChange={(e) => setSerialNumber(e.target.value)} placeholder="Enter serial number (usually on bottom of device)" className="w-full border-2 px-4 py-3 rounded-xl" />
                </div>
              </>
            )}

            <div className="flex gap-3 pt-4">
              <button type="button" onClick={onClose} className="flex-1 px-4 py-3 bg-gray-200 rounded-xl font-semibold">Cancel</button>
              <button type="submit" className="flex-1 px-4 py-3 avanti-gradient text-white rounded-xl font-semibold">Add Asset</button>
            </div>
          </form>
        )}
      </div>
    </div>
  );
}

// ========================================
// ASSIGN ASSET MODAL
// ========================================
function AssignAssetModal({ asset, students, onAssign, onClose, onSelectCopy, currentUserSchool }) {
  const [selectedStudent, setSelectedStudent] = useState('');
  const [searchTerm, setSearchTerm] = useState('');
  const [selectedGrade, setSelectedGrade] = useState('all');
  const [selectedCopy, setSelectedCopy] = useState(asset?.docId || '');

  // Get unique grades from school-filtered students
  const availableGrades = useMemo(() => {
    const schoolStudents = students.filter(s => s.school === currentUserSchool);
    const grades = [...new Set(schoolStudents.map(s => s.grade || s.class).filter(Boolean))];
    return grades.sort((a, b) => Number(a) - Number(b));
  }, [students, currentUserSchool]);

  const filteredStudents = useMemo(() => {
    // First filter by school
    let filtered = students.filter(s => s.school === currentUserSchool);
    
    // Then filter by grade if selected
    if (selectedGrade !== 'all') {
      filtered = filtered.filter(s => 
        (s.grade || s.class) === selectedGrade || 
        String(s.grade || s.class) === selectedGrade
      );
    }
    
    // Then filter by search term
    if (searchTerm) {
      const search = searchTerm.toLowerCase();
      filtered = filtered.filter(s => 
        s.name?.toLowerCase().includes(search) ||
        s.studentId?.toLowerCase().includes(search) ||
        s.id?.toLowerCase().includes(search)
      );
    }
    
    return filtered;
  }, [students, currentUserSchool, selectedGrade, searchTerm]);

  // Check if we need to show copy selection
  const hasMultipleCopies = asset?.showCopySelection && asset?.availableCopies?.length > 1;
  const currentAsset = hasMultipleCopies 
    ? (asset.availableCopies.find(c => c.docId === selectedCopy) || asset.availableCopies[0])
    : asset;

  const handleAssign = () => {
    if (!selectedStudent) { alert('Please select a student'); return; }
    const student = students.find(s => (s.studentId || s.id) === selectedStudent);
    if (student) {
      // Pass the selected copy's docId if multiple copies
      if (hasMultipleCopies && onSelectCopy) {
        onSelectCopy(selectedCopy);
      }
      onAssign(student.studentId || student.id, student.name, student.grade || student.class || '', selectedCopy);
    }
  };

  return (
    <div className="modal-overlay" onClick={onClose}>
      <div className="modal-content" onClick={e => e.stopPropagation()}>
        <div className="flex justify-between items-center mb-4">
          <h3 className="text-xl font-bold">üì§ Assign Asset</h3>
          <button onClick={onClose} className="text-2xl text-gray-500">‚úï</button>
        </div>

        <div className="bg-blue-50 p-4 rounded-xl mb-4">
          <p className="font-bold">{currentAsset.title}</p>
          <p className="text-sm text-gray-600">
            {currentAsset.assetType === 'book' ? 'üìö Book' : 'üíª Chromebook'} 
            {currentAsset.copyNumber && ` ‚Ä¢ Copy #${currentAsset.copyNumber}`}
          </p>
        </div>

        {/* Copy Selection if multiple available */}
        {hasMultipleCopies && (
          <div className="mb-4">
            <label className="block text-sm font-bold mb-2">Select Copy ({asset.availableCopies.length} available)</label>
            <select 
              value={selectedCopy} 
              onChange={(e) => setSelectedCopy(e.target.value)} 
              className="w-full border-2 px-4 py-3 rounded-xl bg-green-50"
            >
              {asset.availableCopies.map(copy => (
                <option key={copy.docId} value={copy.docId}>
                  Copy #{copy.copyNumber || '1'} - {copy.barcode}
                </option>
              ))}
            </select>
          </div>
        )}

        <div className="space-y-4">
          <div>
            <label className="block text-sm font-bold mb-2">Search Student</label>
            <input type="text" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} placeholder="Search by name or ID..." className="w-full border-2 px-4 py-3 rounded-xl" />
          </div>

          <div>
            <label className="block text-sm font-bold mb-2">Filter by Grade</label>
            <select value={selectedGrade} onChange={(e) => setSelectedGrade(e.target.value)} className="w-full border-2 px-4 py-3 rounded-xl bg-yellow-50">
              <option value="all">All Grades</option>
              {availableGrades.map(grade => (
                <option key={grade} value={grade}>Class {grade}</option>
              ))}
            </select>
          </div>

          <div>
            <label className="block text-sm font-bold mb-2">Select Student * ({filteredStudents.length} students)</label>
            <select value={selectedStudent} onChange={(e) => setSelectedStudent(e.target.value)} className="w-full border-2 px-4 py-3 rounded-xl" size={6}>
              <option value="">-- Select --</option>
              {filteredStudents.map(student => (
                <option key={student.studentId || student.id} value={student.studentId || student.id}>
                  {student.name} (Class {student.grade || student.class}) - {student.studentId || student.id}
                </option>
              ))}
            </select>
          </div>

          <div className="flex gap-3 pt-4">
            <button type="button" onClick={onClose} className="flex-1 px-4 py-3 bg-gray-200 rounded-xl font-semibold">Cancel</button>
            <button type="button" onClick={handleAssign} className="flex-1 px-4 py-3 bg-green-500 text-white rounded-xl font-semibold">Assign</button>
          </div>
        </div>
      </div>
    </div>
  );
}

// ========================================
// ASSET MANAGEMENT - TEACHER VIEW
// ========================================
function AssetManagement({ currentUser, students }) {
  const [activeSubTab, setActiveSubTab] = useState('inventory');
  const [assets, setAssets] = useState([]);
  const [assignments, setAssignments] = useState([]);
  const [bookRequests, setBookRequests] = useState([]);
  const [loading, setLoading] = useState(true);
  const [showScanner, setShowScanner] = useState(false);
  const [scanMode, setScanMode] = useState('add');
  const [showAddModal, setShowAddModal] = useState(false);
  const [showAssignModal, setShowAssignModal] = useState(false);
  const [selectedAsset, setSelectedAsset] = useState(null);
  const [scannedBarcode, setScannedBarcode] = useState('');
  const [bookLookupResult, setBookLookupResult] = useState(null);
  const [lookingUp, setLookingUp] = useState(false);
  const [filterType, setFilterType] = useState('all');
  const [filterStatus, setFilterStatus] = useState('all');
  const [searchTerm, setSearchTerm] = useState('');

  const mySchool = currentUser.school;

  useEffect(() => {
    const fetchData = async () => {
      try {
        const assetsSnap = await db.collection('assets').where('school', '==', mySchool).get();
        setAssets(assetsSnap.docs.map(d => ({ ...d.data(), docId: d.id })));

        const assignmentsSnap = await db.collection('assetAssignments').where('school', '==', mySchool).get();
        setAssignments(assignmentsSnap.docs.map(d => ({ ...d.data(), docId: d.id })));

        const requestsSnap = await db.collection('bookRequests').where('school', '==', mySchool).where('status', '==', 'pending').get();
        setBookRequests(requestsSnap.docs.map(d => ({ ...d.data(), docId: d.id })));

        setLoading(false);
      } catch (error) {
        console.error('Error fetching assets:', error);
        setLoading(false);
      }
    };
    fetchData();
  }, [mySchool]);

  const handleScanSuccess = async (barcode) => {
    setScannedBarcode(barcode);
    setShowScanner(false);

    if (scanMode === 'add') {
      // Find all existing copies with this ISBN/barcode (base barcode without copy number)
      const baseBarcode = barcode.split('-copy-')[0];
      const existingCopies = assets.filter(a => a.barcode === barcode || a.barcode.startsWith(baseBarcode + '-copy-') || a.isbn === barcode);
      
      if (existingCopies.length > 0) {
        // Book exists - ask if they want to add another copy
        const firstCopy = existingCopies[0];
        const addMore = confirm(
          `"${firstCopy.title}" already exists (${existingCopies.length} copies).\n\n` +
          `Do you want to add another copy?\n\n` +
          `Click OK to add copy #${existingCopies.length + 1}, or Cancel to skip.`
        );
        
        if (addMore) {
          // Auto-fill details from existing book and set copy number
          const nextCopyNum = existingCopies.length + 1;
          setBookLookupResult({
            found: true,
            title: firstCopy.title,
            author: firstCopy.author || '',
            publisher: firstCopy.publisher || '',
            isbn: barcode,
            copyNumber: nextCopyNum,
            isAdditionalCopy: true
          });
          setShowAddModal(true);
        }
        return;
      }

      // New book - lookup ISBN if applicable
      if (barcode.startsWith('978') || barcode.startsWith('979')) {
        setLookingUp(true);
        const result = await lookupISBN(barcode);
        setBookLookupResult({ ...result, copyNumber: 1 });
        setLookingUp(false);
      } else {
        setBookLookupResult({ found: false, isbn: barcode, copyNumber: 1 });
      }
      setShowAddModal(true);
    } else if (scanMode === 'assign') {
      // Find all copies with this barcode (exact match or base ISBN match)
      const baseBarcode = barcode.split('-copy-')[0];
      const matchingAssets = assets.filter(a => 
        a.barcode === barcode || 
        a.barcode.startsWith(baseBarcode + '-copy-') || 
        a.isbn === barcode
      );
      
      if (matchingAssets.length === 0) { 
        alert('Asset not found! Add it first.'); 
        return; 
      }
      
      // Filter to only available copies
      const availableCopies = matchingAssets.filter(a => a.status === 'available');
      
      if (availableCopies.length === 0) {
        alert(`All copies of "${matchingAssets[0].title}" are currently assigned.\n\nTotal copies: ${matchingAssets.length}\nAssigned: ${matchingAssets.length}`);
        return;
      }
      
      if (availableCopies.length === 1) {
        // Only one available, auto-select it
        setSelectedAsset(availableCopies[0]);
        setShowAssignModal(true);
      } else {
        // Multiple available - show selection modal
        setSelectedAsset({ 
          ...availableCopies[0], 
          availableCopies: availableCopies,
          showCopySelection: true 
        });
        setShowAssignModal(true);
      }
    } else if (scanMode === 'return') {
      // Find all assigned copies with this barcode
      const baseBarcode = barcode.split('-copy-')[0];
      const matchingAssets = assets.filter(a => 
        (a.barcode === barcode || a.barcode.startsWith(baseBarcode + '-copy-') || a.isbn === barcode) &&
        a.status === 'assigned'
      );
      
      if (matchingAssets.length === 0) { 
        // Check if asset exists but not assigned
        const anyMatch = assets.find(a => a.barcode === barcode || a.isbn === barcode);
        if (anyMatch) {
          alert('This asset is not currently assigned to anyone.');
        } else {
          alert('Asset not found!'); 
        }
        return; 
      }
      
      if (matchingAssets.length === 1) {
        handleReturnAsset(matchingAssets[0]);
      } else {
        // Multiple assigned copies - show who has them
        const copyList = matchingAssets.map((a, i) => 
          `${i + 1}. Copy #${a.copyNumber || '?'} - ${a.currentAssignee?.studentName || 'Unknown'}`
        ).join('\n');
        
        const choice = prompt(
          `Multiple copies are assigned:\n\n${copyList}\n\n` +
          `Enter the number (1-${matchingAssets.length}) of the copy being returned:`
        );
        
        if (choice && !isNaN(choice)) {
          const index = parseInt(choice) - 1;
          if (index >= 0 && index < matchingAssets.length) {
            handleReturnAsset(matchingAssets[index]);
          }
        }
      }
    }
  };

  const handleAddAsset = async (assetData) => {
    try {
      const newAsset = {
        ...assetData, school: mySchool, status: 'available', currentAssignee: null,
        addedBy: currentUser.id || currentUser.name, addedByName: currentUser.name,
        addedDate: new Date().toISOString(), createdAt: firebase.firestore.FieldValue.serverTimestamp()
      };
      const docRef = await db.collection('assets').add(newAsset);
      setAssets([...assets, { ...newAsset, docId: docRef.id }]);
      setShowAddModal(false);
      setScannedBarcode('');
      setBookLookupResult(null);
      alert('Asset added!');
    } catch (error) {
      console.error('Error adding asset:', error);
      alert('Error adding asset.');
    }
  };

  const handleAssignAsset = async (studentId, studentName, studentClass, selectedCopyId = null) => {
    try {
      // If a specific copy was selected, use that; otherwise use selectedAsset
      const assetToAssign = selectedCopyId 
        ? (selectedAsset.availableCopies?.find(c => c.docId === selectedCopyId) || selectedAsset)
        : selectedAsset;
      
      const now = new Date();

      const assignment = {
        assetId: assetToAssign.docId, 
        assetType: assetToAssign.assetType, 
        assetTitle: assetToAssign.title,
        barcode: assetToAssign.barcode, 
        copyNumber: assetToAssign.copyNumber || 1,
        studentId, studentName, studentClass, school: mySchool,
        assignedBy: currentUser.id || currentUser.name, assignedByName: currentUser.name,
        assignedDate: now.toISOString(), returnedDate: null, status: 'active',
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      };

      const assignmentRef = await db.collection('assetAssignments').add(assignment);

      await db.collection('assets').doc(assetToAssign.docId).update({
        status: 'assigned',
        currentAssignee: { studentId, studentName, assignedDate: now.toISOString(), assignmentId: assignmentRef.id }
      });

      setAssets(assets.map(a => a.docId === assetToAssign.docId ? { ...a, status: 'assigned', currentAssignee: { studentId, studentName, assignedDate: now.toISOString() } } : a));
      setAssignments([...assignments, { ...assignment, docId: assignmentRef.id }]);
      setShowAssignModal(false);
      setSelectedAsset(null);
      
      const copyInfo = assetToAssign.copyNumber ? ` (Copy #${assetToAssign.copyNumber})` : '';
      alert(`"${assetToAssign.title}"${copyInfo} assigned to ${studentName}!`);
    } catch (error) {
      console.error('Error assigning:', error);
      alert('Error assigning asset.');
    }
  };

  const handleReturnAsset = async (asset) => {
    if (!confirm(`Return "${asset.title}" from ${asset.currentAssignee?.studentName}?`)) return;
    try {
      const now = new Date().toISOString();
      const activeAssignment = assignments.find(a => a.assetId === asset.docId && a.status !== 'returned');
      
      if (activeAssignment) {
        await db.collection('assetAssignments').doc(activeAssignment.docId).update({
          returnedDate: now, returnedTo: currentUser.id || currentUser.name, status: 'returned'
        });
        setAssignments(assignments.map(a => a.docId === activeAssignment.docId ? { ...a, returnedDate: now, status: 'returned' } : a));
      }

      await db.collection('assets').doc(asset.docId).update({ status: 'available', currentAssignee: null });
      setAssets(assets.map(a => a.docId === asset.docId ? { ...a, status: 'available', currentAssignee: null } : a));
      alert('Returned!');
    } catch (error) {
      console.error('Error returning:', error);
      alert('Error returning asset.');
    }
  };

  const handleBookRequest = async (requestId, action, remarks = '') => {
    try {
      await db.collection('bookRequests').doc(requestId).update({
        status: action, processedBy: currentUser.id || currentUser.name,
        processedByName: currentUser.name, processedDate: new Date().toISOString(), remarks
      });
      setBookRequests(bookRequests.filter(r => r.docId !== requestId));
      alert(`Request ${action}!`);
    } catch (error) {
      console.error('Error:', error);
      alert('Error processing request.');
    }
  };

  // ‚úÖ NEW: Handle duplicate/copy asset
  const handleDuplicateAsset = async (asset) => {
    // Find all existing copies of this book
    const baseISBN = asset.isbn || asset.barcode.split('-copy-')[0];
    const existingCopies = assets.filter(a => 
      a.isbn === baseISBN || 
      a.barcode === baseISBN || 
      a.barcode.startsWith(baseISBN + '-copy-')
    );
    
    const nextCopyNum = existingCopies.length + 1;
    
    // Pre-fill the add modal with existing book details
    setScannedBarcode(baseISBN);
    setBookLookupResult({
      found: true,
      title: asset.title,
      author: asset.author || '',
      publisher: asset.publisher || '',
      category: asset.category || 'Other',
      isbn: baseISBN,
      copyNumber: nextCopyNum,
      isAdditionalCopy: true
    });
    setShowAddModal(true);
  };

  const filteredAssets = useMemo(() => {
    return assets.filter(asset => {
      if (filterType !== 'all' && asset.assetType !== filterType) return false;
      if (filterStatus !== 'all' && asset.status !== filterStatus) return false;
      if (searchTerm) {
        const search = searchTerm.toLowerCase();
        return asset.title?.toLowerCase().includes(search) || asset.author?.toLowerCase().includes(search) ||
          asset.barcode?.includes(search) || asset.currentAssignee?.studentName?.toLowerCase().includes(search);
      }
      return true;
    });
  }, [assets, filterType, filterStatus, searchTerm]);

  const stats = useMemo(() => ({
    total: assets.length, available: assets.filter(a => a.status === 'available').length,
    assigned: assets.filter(a => a.status === 'assigned').length,
    books: assets.filter(a => a.assetType === 'book').length,
    chromebooks: assets.filter(a => a.assetType === 'chromebook').length,
    pendingRequests: bookRequests.length
  }), [assets, bookRequests]);

  if (loading) return <div className="text-center py-8">Loading assets...</div>;

  return (
    <div className="space-y-6">
      <div className="flex flex-col gap-4">
        <h2 className="text-3xl font-bold">üìö Asset Management</h2>
        <div className="flex gap-2 flex-wrap">
          <button onClick={() => { setScanMode('add'); setShowScanner(true); }} className="px-4 py-2 bg-blue-500 text-white rounded-xl font-semibold hover:bg-blue-600">üì∑ Scan & Add</button>
          <button onClick={() => { setScannedBarcode('MANUAL-' + Date.now()); setBookLookupResult({ found: false }); setShowAddModal(true); }} className="px-4 py-2 bg-purple-500 text-white rounded-xl font-semibold hover:bg-purple-600">‚úèÔ∏è Manual Add</button>
          <button onClick={() => { setScanMode('assign'); setShowScanner(true); }} className="px-4 py-2 bg-green-500 text-white rounded-xl font-semibold hover:bg-green-600">üì§ Assign</button>
          <button onClick={() => { setScanMode('return'); setShowScanner(true); }} className="px-4 py-2 bg-orange-500 text-white rounded-xl font-semibold hover:bg-orange-600">üì• Return</button>
        </div>
      </div>

      <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
        <div className="stat-card bg-gradient-to-br from-blue-500 to-blue-600 text-white"><div className="text-sm opacity-90">Total</div><div className="text-3xl font-bold">{stats.total}</div></div>
        <div className="stat-card bg-gradient-to-br from-green-500 to-green-600 text-white"><div className="text-sm opacity-90">Available</div><div className="text-3xl font-bold">{stats.available}</div></div>
        <div className="stat-card bg-gradient-to-br from-yellow-500 to-yellow-600 text-white"><div className="text-sm opacity-90">Assigned</div><div className="text-3xl font-bold">{stats.assigned}</div></div>
        <div className="stat-card bg-gradient-to-br from-purple-500 to-purple-600 text-white"><div className="text-sm opacity-90">Books</div><div className="text-3xl font-bold">{stats.books}</div></div>
        <div className="stat-card bg-gradient-to-br from-teal-500 to-teal-600 text-white"><div className="text-sm opacity-90">Chromebooks</div><div className="text-3xl font-bold">{stats.chromebooks}</div></div>
        <div className="stat-card bg-gradient-to-br from-orange-500 to-orange-600 text-white"><div className="text-sm opacity-90">Requests</div><div className="text-3xl font-bold">{stats.pendingRequests}</div></div>
      </div>

      <div className="flex gap-2 overflow-x-auto pb-2">
        {['inventory', 'assigned', 'requests', 'history'].map(tab => (
          <button key={tab} onClick={() => setActiveSubTab(tab)} className={`px-4 py-2 rounded-xl font-semibold whitespace-nowrap ${activeSubTab === tab ? 'avanti-gradient text-white' : 'bg-white'}`}>
            {tab === 'inventory' && 'üì¶ Inventory'}
            {tab === 'assigned' && 'üì§ Assigned'}
            {tab === 'requests' && `üìù Requests (${stats.pendingRequests})`}
            {tab === 'history' && 'üìú History'}
          </button>
        ))}
      </div>

      {activeSubTab === 'inventory' && (
        <div className="space-y-4">
          <div className="bg-white p-4 rounded-xl shadow-lg">
            <div className="grid md:grid-cols-4 gap-4">
              <input type="text" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} placeholder="Search..." className="border-2 px-4 py-2 rounded-xl" />
              <select value={filterType} onChange={(e) => setFilterType(e.target.value)} className="border-2 px-4 py-2 rounded-xl">
                <option value="all">All Types</option><option value="book">Books</option><option value="chromebook">Chromebooks</option>
              </select>
              <select value={filterStatus} onChange={(e) => setFilterStatus(e.target.value)} className="border-2 px-4 py-2 rounded-xl">
                <option value="all">All Status</option><option value="available">Available</option><option value="assigned">Assigned</option>
              </select>
              <button onClick={() => { setSearchTerm(''); setFilterType('all'); setFilterStatus('all'); }} className="px-4 py-2 bg-gray-200 rounded-xl">Clear</button>
            </div>
          </div>
          <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
            {filteredAssets.length === 0 ? (
              <div className="col-span-full text-center py-8 text-gray-500">No assets found. Click "Scan & Add" or "Manual Add" to start.</div>
            ) : filteredAssets.map(asset => (
              <div key={asset.docId} className={`asset-card ${asset.assetType}`}>
                <div className="flex justify-between items-start mb-2">
                  <span className={`asset-badge badge-${asset.status === 'available' ? 'available' : 'assigned'}`}>
                    {asset.assetType === 'book' ? 'üìö' : 'üíª'} {asset.assetType}
                    {asset.copyNumber && asset.copyNumber > 1 && ` #${asset.copyNumber}`}
                  </span>
                  <span className={`asset-badge badge-${asset.status}`}>{asset.status}</span>
                </div>
                <h4 className="font-bold text-lg mb-1">{asset.title}</h4>
                {asset.author && <p className="text-sm text-gray-600">by {asset.author}</p>}
                <p className="text-xs text-gray-500 mt-2">
                  {asset.copyNumber ? `Copy #${asset.copyNumber} ‚Ä¢ ` : ''}
                  {asset.isbn || asset.barcode}
                </p>
                {asset.status === 'assigned' && asset.currentAssignee && (
                  <div className="mt-3 p-2 bg-yellow-50 rounded-lg">
                    <p className="text-sm font-semibold">Assigned to: {asset.currentAssignee.studentName}</p>
                    <p className="text-xs text-gray-600">Since: {new Date(asset.currentAssignee.assignedDate).toLocaleDateString()}</p>
                  </div>
                )}
                <div className="mt-3 flex gap-2">
                  {asset.status === 'available' ? (
                    <button onClick={() => { setSelectedAsset(asset); setShowAssignModal(true); }} className="flex-1 px-3 py-2 bg-green-500 text-white rounded-lg text-sm font-semibold">Assign</button>
                  ) : (
                    <button onClick={() => handleReturnAsset(asset)} className="flex-1 px-3 py-2 bg-orange-500 text-white rounded-lg text-sm font-semibold">Return</button>
                  )}
                  {/* ‚úÖ NEW: Duplicate button */}
                  {asset.assetType === 'book' && (
                    <button 
                      onClick={() => handleDuplicateAsset(asset)} 
                      className="px-3 py-2 bg-blue-500 text-white rounded-lg text-sm font-semibold"
                      title="Add another copy of this book"
                    >
                      üìã Copy
                    </button>
                  )}
                </div>
              </div>
            ))}
          </div>
        </div>
      )}

      {activeSubTab === 'assigned' && (
        <div className="bg-white p-6 rounded-xl shadow-lg overflow-x-auto">
          <h3 className="font-bold text-xl mb-4">Currently Assigned</h3>
          <table className="w-full">
            <thead className="avanti-gradient-light">
              <tr><th className="p-3 text-left">Asset</th><th className="p-3 text-left">Type</th><th className="p-3 text-left">Student</th><th className="p-3 text-left">Assigned</th><th className="p-3 text-left">Status</th><th className="p-3 text-left">Action</th></tr>
            </thead>
            <tbody>
              {assignments.filter(a => a.status !== 'returned').length === 0 ? (
                <tr><td colSpan="6" className="p-8 text-center text-gray-500">No assets assigned</td></tr>
              ) : assignments.filter(a => a.status !== 'returned').sort((a, b) => new Date(b.assignedDate) - new Date(a.assignedDate)).map(assignment => {
                return (
                  <tr key={assignment.docId} className="border-b hover:bg-gray-50">
                    <td className="p-3 font-semibold">{assignment.assetTitle}</td>
                    <td className="p-3">{assignment.assetType}</td>
                    <td className="p-3">{assignment.studentName}</td>
                    <td className="p-3 text-sm">{new Date(assignment.assignedDate).toLocaleDateString()}</td>
                    <td className="p-3"><span className="asset-badge badge-assigned">Active</span></td>
                    <td className="p-3"><button onClick={() => { const a = assets.find(x => x.docId === assignment.assetId); if(a) handleReturnAsset(a); }} className="px-3 py-1 bg-orange-500 text-white rounded-lg text-sm">Return</button></td>
                  </tr>
                );
              })}
            </tbody>
          </table>
        </div>
      )}

      {activeSubTab === 'requests' && (
        <div className="bg-white p-6 rounded-xl shadow-lg">
          <h3 className="font-bold text-xl mb-4">üìù Pending Requests</h3>
          {bookRequests.length === 0 ? <p className="text-center py-8 text-gray-500">No pending requests</p> : (
            <div className="space-y-4">
              {bookRequests.map(request => (
                <div key={request.docId} className="request-card pending">
                  <div className="flex justify-between items-start flex-wrap gap-4">
                    <div>
                      <span className="asset-badge badge-assigned mb-2">{request.requestType === 'existing' ? 'Library Book' : 'New Book'}</span>
                      <h4 className="font-bold text-lg">{request.requestType === 'existing' ? request.assetTitle : request.requestedTitle}</h4>
                      <p className="text-sm text-gray-600">By: {request.studentName}</p>
                      <p className="text-sm text-gray-600">Date: {new Date(request.requestDate).toLocaleDateString()}</p>
                      {request.reason && <p className="text-sm mt-2 italic">"{request.reason}"</p>}
                    </div>
                    <div className="flex gap-2">
                      <button onClick={() => handleBookRequest(request.docId, 'approved')} className="px-4 py-2 bg-green-500 text-white rounded-lg font-semibold">Approve</button>
                      <button onClick={() => { const r = prompt('Reason (optional):'); handleBookRequest(request.docId, 'rejected', r || ''); }} className="px-4 py-2 bg-red-500 text-white rounded-lg font-semibold">Reject</button>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>
      )}

      {activeSubTab === 'history' && (
        <div className="bg-white p-6 rounded-xl shadow-lg overflow-x-auto">
          <h3 className="font-bold text-xl mb-4">üìú History</h3>
          <table className="w-full">
            <thead className="avanti-gradient-light">
              <tr><th className="p-3 text-left">Asset</th><th className="p-3 text-left">Student</th><th className="p-3 text-left">Assigned</th><th className="p-3 text-left">Returned</th><th className="p-3 text-left">Duration</th></tr>
            </thead>
            <tbody>
              {assignments.filter(a => a.status === 'returned').sort((a, b) => new Date(b.returnedDate) - new Date(a.returnedDate)).slice(0, 50).map(assignment => {
                const duration = Math.ceil((new Date(assignment.returnedDate) - new Date(assignment.assignedDate)) / (1000 * 60 * 60 * 24));
                return (
                  <tr key={assignment.docId} className="border-b">
                    <td className="p-3 font-semibold">{assignment.assetTitle}</td>
                    <td className="p-3">{assignment.studentName}</td>
                    <td className="p-3 text-sm">{new Date(assignment.assignedDate).toLocaleDateString()}</td>
                    <td className="p-3 text-sm">{new Date(assignment.returnedDate).toLocaleDateString()}</td>
                    <td className="p-3 text-sm">{duration} days</td>
                  </tr>
                );
              })}
            </tbody>
          </table>
        </div>
      )}

      {showScanner && <BarcodeScanner key={`scanner-${Date.now()}`} onScanSuccess={handleScanSuccess} onClose={() => setShowScanner(false)} />}
      {showAddModal && <AddAssetModal barcode={scannedBarcode} lookupResult={bookLookupResult} lookingUp={lookingUp} onSave={handleAddAsset} onClose={() => { setShowAddModal(false); setScannedBarcode(''); setBookLookupResult(null); }} />}
      {showAssignModal && selectedAsset && <AssignAssetModal asset={selectedAsset} students={students} currentUserSchool={mySchool} onAssign={handleAssignAsset} onClose={() => { setShowAssignModal(false); setSelectedAsset(null); }} />}
    </div>
  );
}

// ========================================
// STUDENT ASSETS VIEW
// ========================================
function StudentAssets({ currentUser }) {
  const [myAssets, setMyAssets] = useState([]);
  const [assetHistory, setAssetHistory] = useState([]);
  const [myRequests, setMyRequests] = useState([]);
  const [loading, setLoading] = useState(true);
  const [showRequestModal, setShowRequestModal] = useState(false);
  const [availableBooks, setAvailableBooks] = useState([]);

  const myId = currentUser.studentId || currentUser.id;
  const mySchool = currentUser.school;

  useEffect(() => {
    const fetchData = async () => {
      try {
        const currentSnap = await db.collection('assetAssignments').where('studentId', '==', String(myId)).where('status', 'in', ['active', 'overdue']).get();
        setMyAssets(currentSnap.docs.map(d => ({ ...d.data(), docId: d.id })));

        const historySnap = await db.collection('assetAssignments').where('studentId', '==', String(myId)).where('status', '==', 'returned').get();
        setAssetHistory(historySnap.docs.map(d => ({ ...d.data(), docId: d.id })));

        const requestsSnap = await db.collection('bookRequests').where('studentId', '==', String(myId)).get();
        setMyRequests(requestsSnap.docs.map(d => ({ ...d.data(), docId: d.id })));

        const booksSnap = await db.collection('assets').where('school', '==', mySchool).where('status', '==', 'available').where('assetType', '==', 'book').get();
        setAvailableBooks(booksSnap.docs.map(d => ({ ...d.data(), docId: d.id })));

        setLoading(false);
      } catch (error) {
        console.error('Error:', error);
        setLoading(false);
      }
    };
    fetchData();
  }, [myId, mySchool]);

  const handleRequestBook = async (requestData) => {
    try {
      const request = {
        ...requestData, studentId: String(myId), studentName: currentUser.name, school: mySchool,
        requestDate: new Date().toISOString(), status: 'pending', processedBy: null, processedDate: null, remarks: '',
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      };
      const docRef = await db.collection('bookRequests').add(request);
      setMyRequests([...myRequests, { ...request, docId: docRef.id }]);
      setShowRequestModal(false);
      alert('Request submitted!');
    } catch (error) {
      console.error('Error:', error);
      alert('Error submitting request.');
    }
  };

  if (loading) return <div className="text-center py-8">Loading...</div>;

  return (
    <div className="space-y-6">
      <div className="flex justify-between items-center">
        <h2 className="text-2xl font-bold">üìö My Assets</h2>
        <button onClick={() => setShowRequestModal(true)} className="px-4 py-2 avanti-gradient text-white rounded-xl font-semibold">üìù Request Book</button>
      </div>

      <div className="bg-white p-6 rounded-xl shadow-lg">
        <h3 className="font-bold text-xl mb-4">üì¶ Currently With Me</h3>
        {myAssets.length === 0 ? <p className="text-gray-500 text-center py-4">No assets assigned to you.</p> : (
          <div className="grid md:grid-cols-2 gap-4">
            {myAssets.map(asset => {
              return (
                <div key={asset.docId} className={`asset-card ${asset.assetType}`}>
                  <div className="flex justify-between items-start mb-2">
                    <span className={`asset-badge ${asset.assetType === 'book' ? 'badge-available' : 'badge-assigned'}`}>{asset.assetType === 'book' ? 'üìö Book' : 'üíª Chromebook'}</span>
                  </div>
                  <h4 className="font-bold text-lg">{asset.assetTitle}</h4>
                  <p className="text-sm text-gray-600">Assigned: {new Date(asset.assignedDate).toLocaleDateString()}</p>
                </div>
              );
            })}
          </div>
        )}
      </div>

      <div className="bg-white p-6 rounded-xl shadow-lg">
        <h3 className="font-bold text-xl mb-4">üìù My Requests</h3>
        {myRequests.length === 0 ? <p className="text-gray-500 text-center py-4">No requests yet.</p> : (
          <div className="space-y-3">
            {myRequests.sort((a, b) => new Date(b.requestDate) - new Date(a.requestDate)).map(request => (
              <div key={request.docId} className={`request-card ${request.status}`}>
                <div className="flex justify-between items-start">
                  <div>
                    <h4 className="font-bold">{request.requestType === 'existing' ? request.assetTitle : request.requestedTitle}</h4>
                    <p className="text-sm text-gray-600">Requested: {new Date(request.requestDate).toLocaleDateString()}</p>
                  </div>
                  <span className={`asset-badge ${request.status === 'pending' ? 'badge-assigned' : request.status === 'approved' ? 'badge-available' : 'badge-overdue'}`}>{request.status.toUpperCase()}</span>
                </div>
                {request.remarks && <p className="text-sm mt-2 italic text-gray-600">"{request.remarks}"</p>}
              </div>
            ))}
          </div>
        )}
      </div>

      <div className="bg-white p-6 rounded-xl shadow-lg">
        <h3 className="font-bold text-xl mb-4">üìú Previously Borrowed</h3>
        {assetHistory.length === 0 ? <p className="text-gray-500 text-center py-4">No history yet.</p> : (
          <div className="overflow-x-auto">
            <table className="w-full">
              <thead className="avanti-gradient-light">
                <tr><th className="p-3 text-left">Asset</th><th className="p-3 text-left">Type</th><th className="p-3 text-left">Borrowed</th><th className="p-3 text-left">Returned</th></tr>
              </thead>
              <tbody>
                {assetHistory.sort((a, b) => new Date(b.returnedDate) - new Date(a.returnedDate)).map(item => (
                  <tr key={item.docId} className="border-b">
                    <td className="p-3 font-semibold">{item.assetTitle}</td>
                    <td className="p-3">{item.assetType}</td>
                    <td className="p-3 text-sm">{new Date(item.assignedDate).toLocaleDateString()}</td>
                    <td className="p-3 text-sm">{new Date(item.returnedDate).toLocaleDateString()}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        )}
      </div>

      {showRequestModal && <BookRequestModal availableBooks={availableBooks} onSubmit={handleRequestBook} onClose={() => setShowRequestModal(false)} />}
    </div>
  );
}

// ========================================
// BOOK REQUEST MODAL (Student)
// ========================================
function BookRequestModal({ availableBooks, onSubmit, onClose }) {
  const [requestType, setRequestType] = useState('existing');
  const [selectedBook, setSelectedBook] = useState('');
  const [newBookTitle, setNewBookTitle] = useState('');
  const [newBookAuthor, setNewBookAuthor] = useState('');
  const [reason, setReason] = useState('');

  const handleSubmit = (e) => {
    e.preventDefault();
    if (requestType === 'existing') {
      if (!selectedBook) { alert('Please select a book'); return; }
      const book = availableBooks.find(b => b.docId === selectedBook);
      onSubmit({ requestType: 'existing', assetId: selectedBook, assetTitle: book?.title || '', reason });
    } else {
      if (!newBookTitle.trim()) { alert('Please enter book title'); return; }
      onSubmit({ requestType: 'new', requestedTitle: newBookTitle.trim(), requestedAuthor: newBookAuthor.trim(), reason });
    }
  };

  return (
    <div className="modal-overlay" onClick={onClose}>
      <div className="modal-content" onClick={e => e.stopPropagation()}>
        <div className="flex justify-between items-center mb-4">
          <h3 className="text-xl font-bold">üìù Request a Book</h3>
          <button onClick={onClose} className="text-2xl text-gray-500">‚úï</button>
        </div>

        <form onSubmit={handleSubmit} className="space-y-4">
          <div>
            <label className="block text-sm font-bold mb-2">Request Type</label>
            <div className="flex gap-4">
              <label className="flex items-center gap-2 cursor-pointer">
                <input type="radio" value="existing" checked={requestType === 'existing'} onChange={(e) => setRequestType(e.target.value)} className="w-4 h-4" />
                <span>From Library</span>
              </label>
              <label className="flex items-center gap-2 cursor-pointer">
                <input type="radio" value="new" checked={requestType === 'new'} onChange={(e) => setRequestType(e.target.value)} className="w-4 h-4" />
                <span>Request New Book</span>
              </label>
            </div>
          </div>

          {requestType === 'existing' ? (
            <div>
              <label className="block text-sm font-bold mb-2">Select Book *</label>
              {availableBooks.length === 0 ? <p className="text-gray-500 italic">No books available.</p> : (
                <select value={selectedBook} onChange={(e) => setSelectedBook(e.target.value)} className="w-full border-2 px-4 py-3 rounded-xl" size={5}>
                  <option value="">-- Select --</option>
                  {availableBooks.map(book => <option key={book.docId} value={book.docId}>{book.title} {book.author ? `by ${book.author}` : ''}</option>)}
                </select>
              )}
            </div>
          ) : (
            <>
              <div>
                <label className="block text-sm font-bold mb-2">Book Title *</label>
                <input type="text" value={newBookTitle} onChange={(e) => setNewBookTitle(e.target.value)} placeholder="Enter book title" className="w-full border-2 px-4 py-3 rounded-xl" required />
              </div>
              <div>
                <label className="block text-sm font-bold mb-2">Author (Optional)</label>
                <input type="text" value={newBookAuthor} onChange={(e) => setNewBookAuthor(e.target.value)} placeholder="Enter author" className="w-full border-2 px-4 py-3 rounded-xl" />
              </div>
            </>
          )}

          <div>
            <label className="block text-sm font-bold mb-2">Reason (Optional)</label>
            <textarea value={reason} onChange={(e) => setReason(e.target.value)} placeholder="Why do you need this book?" className="w-full border-2 px-4 py-3 rounded-xl" rows={3} />
          </div>

          <div className="flex gap-3 pt-4">
            <button type="button" onClick={onClose} className="flex-1 px-4 py-3 bg-gray-200 rounded-xl font-semibold">Cancel</button>
            <button type="submit" className="flex-1 px-4 py-3 avanti-gradient text-white rounded-xl font-semibold">Submit</button>
          </div>
        </form>
      </div>
    </div>
  );
}

// ========================================
// COMPLETE STUDENT DASHBOARD - REPLACE EXISTING
// ========================================
function StudentDashboard({currentUser, handleLogout}) {
  const [activeTab, setActiveTab] = useState('dashboard');
  const [loading, setLoading] = useState(true);  // ‚¨ÖÔ∏è ADD THIS LINE
  const [curriculum, setCurriculum] = useState({});
  const [chapterProgress, setChapterProgress] = useState({});
  const [studentAttendance, setStudentAttendance] = useState([]);
  const [teachers, setTeachers] = useState([]);
  const [studentProfile, setStudentProfile] = useState(null);
  const [examRegistrations, setExamRegistrations] = useState(null);
  const [teacherFeedbacks, setTeacherFeedbacks] = useState([]);
  const [selectedTeacher, setSelectedTeacher] = useState(null);
  const [showTeacherProfile, setShowTeacherProfile] = useState(false);
  const [showFeedbackForm, setShowFeedbackForm] = useState(false);
  const [showFeedbackNotification, setShowFeedbackNotification] = useState(false);
  
  const mySchool = currentUser.school;
  const myGrade = currentUser.grade;
  const myId = currentUser.studentId || currentUser.id;

useEffect(() => {
  const fetchData = async () => {
    try {
      // Curriculum
      const currMap = {};
      const currSnap = await db.collection('curriculum').get();
      currSnap.docs.forEach(doc => { currMap[doc.id] = doc.data(); });
      setCurriculum(currMap);

      // Chapter progress
      const progressMap = {};
      const progressSnap = await db.collection('chapterProgress').get();
      progressSnap.docs.forEach(d => { progressMap[d.id] = d.data(); });
      setChapterProgress(progressMap);

      // ‚úÖ ALL attendance records for this student (no date filter)
      const attSnap = await db.collection('studentAttendance')
        .where('studentId', '==', String(myId))
        .get();

      const attendanceData = attSnap.docs
        .map(d => ({ ...d.data(), docId: d.id }))
        .sort((a, b) => b.date.localeCompare(a.date));

      setStudentAttendance(attendanceData);

      // Teachers from this school
      const teacherSnap = await db.collection('teachers')
        .where('school', '==', mySchool)
        .get();
      setTeachers(teacherSnap.docs.map(d => ({ ...d.data(), docId: d.id })));

      // Exam registrations for this student
      const examSnap = await db.collection('studentExamRegistrations').doc(myId).get();
      if (examSnap.exists) {
        setExamRegistrations(examSnap.data());
      }

      setLoading(false);
    } catch (e) {
      console.error('Data fetch error:', e);
      setLoading(false);
    }
  };

  fetchData();
}, [mySchool, myGrade, myId]);


    // Calculate profile completion (same logic as Profile page)
  const calculateCompletion = () => {
    const baseProfile = studentProfile || {
      grade: myGrade,
      school: mySchool
    };

    const requiredFields = [
      'firstName', 'lastName', 'email', 'phone', 'dob', 'grade', 'category',
      'stream', 'school', 'fatherName', 'motherName', 'fatherOccupation',
      'motherOccupation', 'fatherEducation', 'motherEducation', 'familyIncome',
      'address', 'state', 'district', 'pincode', 'whatsappNumber', 'percentage10th'
    ];

    const filled = requiredFields.filter(
      field => baseProfile[field] && String(baseProfile[field]).trim() !== ''
    ).length;

    return Math.round((filled / requiredFields.length) * 100);
  };
    // üîÑ Keep student profile in sync so banner and card match
  useEffect(() => {
    if (!myId) return;

    const unsubscribe = db.collection('studentProfiles')
      .doc(myId)
      .onSnapshot(
        (doc) => {
          if (doc.exists) {
            setStudentProfile(doc.data());
          } else {
            setStudentProfile(null);
          }
        },
        (err) => {
          console.error('Profile listener error:', err);
        }
      );

    return () => unsubscribe();
  }, [myId]);

  // Fetch teacher feedbacks and check if notification needed
  useEffect(() => {
    const fetchFeedbackData = async () => {
      try {
        // Fetch all feedbacks for this student
        const feedbackSnap = await db.collection('teacherFeedback')
          .where('studentId', '==', myId)
          .get();
        setTeacherFeedbacks(feedbackSnap.docs.map(d => ({ ...d.data(), id: d.id })));

        // Check if 2 months have passed since last feedback
        if (studentProfile?.lastFeedbackDate) {
          const lastDate = new Date(studentProfile.lastFeedbackDate);
          const now = new Date();
          const diffMonths = (now.getFullYear() - lastDate.getFullYear()) * 12 + 
                            (now.getMonth() - lastDate.getMonth());
          
          if (diffMonths >= 2) {
            // Show notification after 2 seconds
            setTimeout(() => setShowFeedbackNotification(true), 2000);
          }
        } else {
          // No feedback ever given, show notification
          setTimeout(() => setShowFeedbackNotification(true), 2000);
        }
      } catch (error) {
        console.error('Error fetching feedback data:', error);
      }
    };

    if (myId && studentProfile) {
      fetchFeedbackData();
    }
  }, [myId, studentProfile]);

  // Calculate average rating for a teacher
  const getTeacherAverageRating = (teacherDocId) => {
    const teacherFeedbackList = teacherFeedbacks.filter(f => f.teacherId === teacherDocId);
    if (teacherFeedbackList.length === 0) return null;
    
    const sum = teacherFeedbackList.reduce((acc, f) => acc + (f.averageRating || 0), 0);
    return sum / teacherFeedbackList.length;
  };

  const handleTeacherClick = (teacher) => {
    setSelectedTeacher(teacher);
    setShowTeacherProfile(true);
  };

  const handleGiveFeedback = () => {
    setShowTeacherProfile(false);
    setShowFeedbackForm(true);
  };

  const handleFeedbackSubmitSuccess = () => {
    // Refresh feedback data
    const fetchFeedbackData = async () => {
      const feedbackSnap = await db.collection('teacherFeedback')
        .where('studentId', '==', myId)
        .get();
      setTeacherFeedbacks(feedbackSnap.docs.map(d => ({ ...d.data(), id: d.id })));
    };
    fetchFeedbackData();
  };

  const profileCompletion = calculateCompletion();
  
  // Debug logging
  console.log('=== STUDENT PROFILE DEBUG ===');
  console.log('üìä Profile Completion:', profileCompletion + '%');
  console.log('üë§ Student Data:', studentProfile);
  console.log('üî¢ Student ID:', myId);
  console.log('üè´ School:', mySchool);
  console.log('üìö Grade:', myGrade);
  console.log('============================');

  if (loading) {
    return <div className="text-center py-8">Loading profile...</div>;
  }
  return (
    <div className="min-h-screen bg-gray-50 flex flex-col">
      <nav className="avanti-gradient shadow-lg sticky top-0 z-50">
        <div className="max-w-7xl mx-auto px-4 py-4">
          <div className="flex justify-between items-center">
            <div className="flex items-center gap-3">
              <img src={AVANTI_LOGO} alt="Avanti" className="w-12 h-12"/>
              <div>
                <h1 className="text-2xl font-bold text-white">Student Dashboard</h1>
                <p className="text-sm text-white opacity-90">{mySchool}</p>
              </div>
            </div>
            <div className="flex items-center gap-4">
              <div className="text-right hidden sm:block">
                <p className="text-white font-semibold">{currentUser.name}</p>
                <p className="text-sm text-white opacity-90">Class {myGrade} ‚Ä¢ ID: {myId}</p>
              </div>
              <button onClick={handleLogout} className="px-4 py-2 bg-white text-gray-800 rounded-xl font-semibold">
                Logout
              </button>
            </div>
          </div>
        </div>
      </nav>

      {/* Profile Completion Warning */}
      {profileCompletion < 100 && (
        <div className="bg-red-500 text-white text-center py-3 px-4">
          <p className="font-bold">
            ‚ö†Ô∏è Your profile is {profileCompletion}% complete. Please complete your profile!
          </p>
        </div>
      )}

      <div className="flex-1 max-w-7xl mx-auto px-4 py-6 w-full">
        <div className="flex gap-3 mb-6 overflow-x-auto pb-2">
          {['dashboard', 'profile', 'curriculum', 'attendance', 'assets', 'exams'].map(tab => (
            <button key={tab} onClick={() => setActiveTab(tab)} 
              className={`px-6 py-3 rounded-xl font-semibold whitespace-nowrap ${activeTab === tab ? 'avanti-gradient text-white' : 'bg-white'}`}>
              {tab === 'dashboard' && 'üìä Dashboard'}
              {tab === 'profile' && 'üë§ My Profile'}
              {tab === 'curriculum' && 'üìö Curriculum'}
              {tab === 'attendance' && '‚úÖ Attendance'}
              {tab === 'assets' && 'üì¶ My Assets'}
              {tab === 'exams' && 'üìù Exam Registration'}
            </button>
          ))}
        </div>

                {/* Dashboard Tab */}
        {activeTab === 'dashboard' && (
          <div className="space-y-6">
            <h2 className="text-3xl font-bold">Welcome, {currentUser.name}! üëã</h2>

            {/* Top stats cards */}
            <div className="grid md:grid-cols-5 gap-4">
              <div className="stat-card bg-blue-500 text-white">
                <div className="text-sm opacity-90">My School</div>
                <div className="text-xl font-bold">{mySchool}</div>
              </div>

              <div className="stat-card bg-green-500 text-white">
                <div className="text-sm opacity-90">My Class</div>
                <div className="text-2xl font-bold">Class {myGrade}</div>
              </div>

              <div className="stat-card bg-purple-500 text-white">
                <div className="text-sm opacity-90">Profile Complete</div>
                <div className="text-2xl font-bold">{profileCompletion}%</div>
              </div>

              <div className="stat-card bg-green-500 text-white">
                <div className="text-sm opacity-90">Days Present</div>
                <div className="text-2xl font-bold">
                  {studentAttendance.filter(a => a.status === 'Present').length}
                </div>
              </div>

              <div className="stat-card bg-red-500 text-white">
                <div className="text-sm opacity-90">Days Absent</div>
                <div className="text-2xl font-bold">
                  {studentAttendance.filter(a => a.status === 'Absent').length}
                </div>
              </div>
            </div>

            {/* My Teachers */}
            <div className="bg-white p-6 rounded-2xl shadow-lg">
              <h3 className="text-2xl font-bold mb-4">üë®‚Äçüè´ My Teachers</h3>
              {teachers.length === 0 ? (
                <p className="text-gray-500 text-center py-4">No teachers found</p>
              ) : (
                <div className="grid md:grid-cols-2 gap-4">
                  {SUBJECTS.map(subject => {
                    // Find active (non-archived) teacher for this subject
                    const teacher = teachers.find(t => t.subject === subject && !t.isArchived);
                    const archivedTeacher = teachers.find(t => t.subject === subject && t.isArchived);
                    const averageRating = teacher ? getTeacherAverageRating(teacher.docId) : null;
                    
                    // Determine display status
                    const isVacant = !teacher;
                    const wasArchived = !teacher && archivedTeacher;
                    
                    return (
                      <div 
                        key={subject} 
                        className={`teacher-card border-2 rounded-xl p-4 ${
                          isVacant ? 'bg-yellow-50 border-yellow-300' : ''
                        }`}
                        onClick={() => teacher && !teacher.isArchived && handleTeacherClick(teacher)}
                      >
                        <div className="font-bold text-lg">{subject}</div>
                        <div className="flex items-center justify-between">
                          <div className={isVacant ? 'text-orange-600 font-medium' : 'text-gray-600'}>
                            {teacher ? teacher.name : (
                              <span>
                                üî∏ Vacant
                                {wasArchived && (
                                  <span className="text-xs text-gray-500 ml-1">(Previously: {archivedTeacher.name})</span>
                                )}
                              </span>
                            )}
                          </div>
                          {averageRating && (
                            <div className="flex items-center gap-2">
                              <span className="text-yellow-500 font-bold">‚òÖ</span>
                              <span className="font-semibold">{averageRating.toFixed(1)}</span>
                            </div>
                          )}
                        </div>
                        {teacher && !teacher.isArchived && (
                          <div className="text-sm text-blue-600 mt-2">Click to view profile ‚Üí</div>
                        )}
                        {isVacant && (
                          <div className="text-sm text-orange-500 mt-2">New teacher to be assigned</div>
                        )}
                      </div>
                    );
                  })}
                </div>
              )}
            </div>

            {/* Pending Chapters */}
            <div className="bg-white p-6 rounded-2xl shadow-lg">
              <h3 className="text-2xl font-bold mb-4">üìö Pending Chapters</h3>
              {SUBJECTS.map(subject => {
                const docId = `${mySchool}_${subject}_${myGrade}`;
                const chapters = curriculum[docId]?.chapters || [];
                const pendingChapters = chapters.filter(ch => {
                  const progressId = `${mySchool}_${ch.id}`;
                  const prog = chapterProgress[progressId] || {};
                  return prog.completed !== 'Yes';
                });

                if (pendingChapters.length === 0) return null;

                return (
                  <div key={subject} className="mb-4">
                    <h4 className="font-bold text-lg mb-2">{subject} ({pendingChapters.length} pending)</h4>
                    <ul className="list-disc list-inside space-y-1">
                      {pendingChapters.slice(0, 5).map(ch => (
                        <li key={ch.id} className="text-gray-700">{ch.name}</li>
                      ))}
                      {pendingChapters.length > 5 && (
                        <li className="text-gray-500 italic">...and {pendingChapters.length - 5} more</li>
                      )}
                    </ul>
                  </div>
                );
              })}
            </div>
          </div>
        )}

        {/* Profile Tab */}
{activeTab === 'profile' && (
  <StudentProfileForm
    currentUser={currentUser}
    onProfileUpdated={(updatedProfile) => setStudentProfile(updatedProfile)}
  />
)}


        {/* Curriculum Tab */}
        {activeTab === 'curriculum' && (
          <StudentCurriculumWithPriority 
            mySchool={mySchool}
            myGrade={myGrade}
            curriculum={curriculum}
            chapterProgress={chapterProgress}
          />
        )}

        {/* Attendance Tab */}
        {activeTab === 'attendance' && (
          <div className="space-y-6">
            <h2 className="text-3xl font-bold">‚úÖ My Attendance Record</h2>
            <div className="bg-white p-6 rounded-2xl shadow-lg">
              <div className="overflow-x-auto">
                <table className="w-full">
                  <thead className="avanti-gradient-light">
                    <tr>
                      <th className="p-3 text-left">Date</th>
                      <th className="p-3 text-left">Status</th>
                      <th className="p-3 text-left">Remarks</th>
                    </tr>
                  </thead>
                  <tbody>
                    {studentAttendance.length === 0 ? (
                      <tr><td colSpan="3" className="p-8 text-center text-gray-500">No attendance records</td></tr>
                    ) : (
                      studentAttendance.map((record, idx) => (
                        <tr key={idx} className="border-b hover:bg-gray-50">
                          <td className="p-3">{record.date}</td>
                          <td className="p-3">
                            <span className={`px-3 py-1 rounded-full text-sm font-bold ${
                              record.status === 'Present' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'
                            }`}>
                              {record.status}
                            </span>
                          </td>
                          <td className="p-3 text-sm">{record.remarks || '‚Äî'}</td>
                        </tr>
                      ))
                    )}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        )}

        {/* Exams Tab */}
        {activeTab === 'exams' && <StudentExamRegistration currentUser={currentUser} />}

        {/* Assets Tab */}
        {activeTab === 'assets' && <StudentAssets currentUser={currentUser} />}
      </div>

      {/* Teacher Profile Modal */}
      {showTeacherProfile && selectedTeacher && (
        <TeacherProfileModal
          teacher={selectedTeacher}
          onClose={() => setShowTeacherProfile(false)}
          onGiveFeedback={handleGiveFeedback}
          averageRating={getTeacherAverageRating(selectedTeacher.docId)}
        />
      )}

      {/* Teacher Feedback Form */}
      {showFeedbackForm && selectedTeacher && (
        <TeacherFeedbackForm
          teacher={selectedTeacher}
          studentId={myId}
          studentInfo={currentUser}
          onClose={() => setShowFeedbackForm(false)}
          onSubmitSuccess={handleFeedbackSubmitSuccess}
        />
      )}

      {/* Feedback Notification */}
      {showFeedbackNotification && (
        <FeedbackNotification
          onClose={() => setShowFeedbackNotification(false)}
          onGiveFeedback={() => {
            setShowFeedbackNotification(false);
            setActiveTab('dashboard');
          }}
        />
      )}

      <footer className="bg-gray-800 text-white text-center py-4 mt-auto">
        <p>Made by Anand with ‚ù§Ô∏è</p>
      </footer>
    </div>
  );
}

// ========================================
// 2FA (TWO-FACTOR AUTHENTICATION) HELPERS
// ========================================

// Generate a new TOTP secret for 2FA
function generate2FASecret(email) {
  const secret = new OTPAuth.Secret({ size: 20 });
  return secret.base32;
}

// Generate TOTP URI for QR code
function generate2FAURI(email, secret) {
  const totp = new OTPAuth.TOTP({
    issuer: 'Avanti',
label: email.split('@')[0],
    algorithm: 'SHA1',
    digits: 6,
    period: 30,
    secret: OTPAuth.Secret.fromBase32(secret)
  });
  return totp.toString();
}

// Verify a TOTP code
function verify2FACode(secret, code) {
  try {
    const totp = new OTPAuth.TOTP({
      issuer: 'Avanti Curriculum Tracker',
      algorithm: 'SHA1',
      digits: 6,
      period: 30,
      secret: OTPAuth.Secret.fromBase32(secret)
    });
    // Allow 2 windows of time drift (60 seconds before/after) for users in remote areas with poor signal
    // This helps when phone clocks are slightly out of sync or network is slow
    const delta = totp.validate({ token: code, window: 2 });
    return delta !== null;
  } catch (e) {
    console.error('2FA verification error:', e);
    return false;
  }
}

// Generate backup codes
function generateBackupCodes(count = 8) {
  const codes = [];
  for (let i = 0; i < count; i++) {
    const code = Math.random().toString(36).substring(2, 6).toUpperCase() + 
                 '-' + 
                 Math.random().toString(36).substring(2, 6).toUpperCase();
    codes.push(code);
  }
  return codes;
}

// Hash a backup code for storage (simple hash for demo - in production use bcrypt)
function hashBackupCode(code) {
  let hash = 0;
  const str = code.replace('-', '').toUpperCase();
  for (let i = 0; i < str.length; i++) {
    const char = str.charCodeAt(i);
    hash = ((hash << 5) - hash) + char;
    hash = hash & hash;
  }
  return Math.abs(hash).toString(16);
}

// Verify a backup code
function verifyBackupCode(inputCode, hashedCodes) {
  const inputHash = hashBackupCode(inputCode);
  const index = hashedCodes.findIndex(h => h.hash === inputHash && !h.used);
  return index;
}

// ========================================
// DEVICE TRUST MANAGEMENT FOR 2FA
// ========================================

// Generate a unique device ID
function generateDeviceId() {
  const array = new Uint8Array(32);
  crypto.getRandomValues(array);
  return Array.from(array, byte => byte.toString(16).padStart(2, '0')).join('');
}

// Get or create device ID for this browser
// ‚úÖ IMPROVED: Multiple storage fallbacks including IndexedDB for PWA/APK
function getDeviceId() {
  try {
    // Try localStorage first (fastest)
    let deviceId = localStorage.getItem('avanti_device_id');
    
    // If not in localStorage, try sessionStorage (survives tab refresh)
    if (!deviceId) {
      deviceId = sessionStorage.getItem('avanti_device_id');
      if (deviceId) {
        // Restore to localStorage
        try { localStorage.setItem('avanti_device_id', deviceId); } catch(e) {}
      }
    }
    
    // If still not found, try to get from a cookie (survives localStorage clear)
    if (!deviceId) {
      const cookies = document.cookie.split(';');
      for (let c of cookies) {
        const [key, value] = c.trim().split('=');
        if (key === 'avanti_device_id' && value) {
          deviceId = value;
          // Restore to localStorage and sessionStorage
          try { 
            localStorage.setItem('avanti_device_id', deviceId);
            sessionStorage.setItem('avanti_device_id', deviceId);
          } catch(e) {}
          break;
        }
      }
    }
    
    // Generate new ID if none exists
    if (!deviceId) {
      deviceId = generateDeviceId();
    }
    
    // Store in all locations for maximum persistence
    try { 
      localStorage.setItem('avanti_device_id', deviceId);
      sessionStorage.setItem('avanti_device_id', deviceId);
      // Set cookie that expires in 90 days (increased from 30)
      const expires = new Date(Date.now() + 90*24*60*60*1000).toUTCString();
      document.cookie = `avanti_device_id=${deviceId};expires=${expires};path=/;SameSite=Strict`;
      // ‚úÖ NEW: Also save to IndexedDB for PWA/APK persistence
      if (window.persistentStorage) {
        window.persistentStorage.setItem('avanti_device_id', deviceId).catch(() => {});
      }
    } catch(e) {
      console.warn('[getDeviceId] Cannot save device ID:', e);
    }
    
    return deviceId;
  } catch(e) {
    // On iOS private browsing, localStorage throws
    console.warn('[getDeviceId] localStorage error, using session ID');
    // Try to get from sessionStorage at least
    try {
      let sessionDeviceId = sessionStorage.getItem('avanti_device_id');
      if (!sessionDeviceId) {
        sessionDeviceId = 'session_' + generateDeviceId();
        sessionStorage.setItem('avanti_device_id', sessionDeviceId);
      }
      return sessionDeviceId;
    } catch(e2) {
      return 'temp_' + generateDeviceId();
    }
  }
}

// ‚úÖ NEW: Async version to restore device ID from IndexedDB on app startup
async function restoreDeviceIdFromIDB() {
  try {
    if (!window.persistentStorage) return;
    const storedId = await window.persistentStorage.getItem('avanti_device_id');
    if (storedId) {
      // Restore to all storage mechanisms
      try {
        localStorage.setItem('avanti_device_id', storedId);
        sessionStorage.setItem('avanti_device_id', storedId);
        const expires = new Date(Date.now() + 90*24*60*60*1000).toUTCString();
        document.cookie = `avanti_device_id=${storedId};expires=${expires};path=/;SameSite=Strict`;
        console.log('‚úÖ Device ID restored from IndexedDB');
      } catch(e) {}
    }
  } catch(e) {
    console.log('[restoreDeviceId] Could not restore from IDB:', e);
  }
}

// Run restoration on load
restoreDeviceIdFromIDB();

// Check if current device is trusted for a user
async function isDeviceTrusted(userId) {
  try {
    const deviceId = getDeviceId();
    console.log('üîç Checking device trust for:', userId, 'Device ID:', deviceId.substring(0, 8) + '...');
    
    const trustedDevicesDoc = await db.collection('trustedDevices').doc(userId).get();
    
    if (!trustedDevicesDoc.exists) {
      console.log('‚ùå No trusted devices document found for user');
      return false;
    }
    
    const devices = trustedDevicesDoc.data().devices || [];
    console.log('üì± Found', devices.length, 'trusted devices for user');
    
    const trustedDevice = devices.find(d => d.deviceId === deviceId && d.active);
    
    if (trustedDevice) {
      // Check if device trust has expired (15 days)
      const trustDate = new Date(trustedDevice.trustedAt);
      const now = new Date();
      const daysDiff = (now - trustDate) / (1000 * 60 * 60 * 24);
      
      if (daysDiff > 15) {
        // Trust expired after 15 days, remove device
        console.log('‚è∞ Device trust expired after 15 days, requiring 2FA again');
        await removeDeviceTrust(userId, deviceId);
        return false;
      }
      console.log('‚úÖ Device trusted, days remaining:', Math.round(15 - daysDiff));
      return true;
    }
    
    // Device not found in trusted list - log partial IDs for debugging
    console.log('‚ùå Device not in trusted list. Looking for:', deviceId.substring(0, 12));
    devices.forEach((d, i) => {
      console.log(`   Device ${i+1}: ${d.deviceId?.substring(0, 12)}... active:${d.active}`);
    });
    
    return false;
  } catch (e) {
    console.error('Error checking device trust:', e);
    return false;
  }
}

// Add current device as trusted for a user
async function addDeviceTrust(userId, userEmail) {
  try {
    const deviceId = getDeviceId();
    console.log('üîê Adding device trust for:', userId, 'Device:', deviceId.substring(0, 8) + '...');
    
    const deviceInfo = {
      deviceId: deviceId,
      trustedAt: new Date().toISOString(),
      userAgent: navigator.userAgent.substring(0, 200),
      platform: navigator.platform || 'unknown',
      active: true
    };
    
    const docRef = db.collection('trustedDevices').doc(userId);
    const doc = await docRef.get();
    
    if (doc.exists) {
      const devices = doc.data().devices || [];
      // Remove any existing entry for this device
      const filteredDevices = devices.filter(d => d.deviceId !== deviceId);
      // Add new trust (keep max 5 devices)
      const updatedDevices = [...filteredDevices.slice(-4), deviceInfo];
      await docRef.update({ devices: updatedDevices, userEmail: userEmail, lastTrustUpdate: new Date().toISOString() });
      console.log('‚úÖ Device trust updated, total trusted devices:', updatedDevices.length);
    } else {
      await docRef.set({ 
        devices: [deviceInfo], 
        userEmail: userEmail,
        createdAt: new Date().toISOString(),
        lastTrustUpdate: new Date().toISOString()
      });
      console.log('‚úÖ New device trust created');
    }
    
    // Verify the trust was saved
    const verifyDoc = await docRef.get();
    if (verifyDoc.exists) {
      const savedDevices = verifyDoc.data().devices || [];
      const found = savedDevices.find(d => d.deviceId === deviceId);
      if (found) {
        console.log('‚úÖ Device trust verified in Firestore');
      } else {
        console.warn('‚ö†Ô∏è Device trust not found after saving!');
      }
    }
    
    return true;
  } catch (e) {
    console.error('Error adding device trust:', e);
    return false;
  }
}

// Remove device trust
async function removeDeviceTrust(userId, deviceId) {
  try {
    const docRef = db.collection('trustedDevices').doc(userId);
    const doc = await docRef.get();
    
    if (doc.exists) {
      const devices = doc.data().devices || [];
      const updatedDevices = devices.filter(d => d.deviceId !== deviceId);
      await docRef.update({ devices: updatedDevices });
    }
    return true;
  } catch (e) {
    console.error('Error removing device trust:', e);
    return false;
  }
}

// Remove all device trusts for a user (used when resetting 2FA)
async function removeAllDeviceTrusts(userId) {
  try {
    await db.collection('trustedDevices').doc(userId).delete();
    return true;
  } catch (e) {
    console.error('Error removing all device trusts:', e);
    return false;
  }
}

// 2FA Setup Modal Component
function TwoFactorSetupModal({ user, onClose, onSetupComplete }) {
  const [step, setStep] = useState(1); // 1: Show QR, 2: Verify code, 3: Show backup codes
  const [secret, setSecret] = useState('');
  const [qrUri, setQrUri] = useState('');
  const [verificationCode, setVerificationCode] = useState('');
  const [backupCodes, setBackupCodes] = useState([]);
  const [error, setError] = useState('');
  const [saving, setSaving] = useState(false);
  const qrRef = useRef(null);
  const qrInstance = useRef(null);

  useEffect(() => {
    // Generate secret on mount
    const newSecret = generate2FASecret(user.email);
    const uri = generate2FAURI(user.email, newSecret);
    setSecret(newSecret);
    setQrUri(uri);
  }, [user.email]);

  useEffect(() => {
    // Generate QR code
    if (qrRef.current && qrUri && step === 1) {
      // Clear previous QR code
      qrRef.current.innerHTML = '';
      qrInstance.current = new QRCode(qrRef.current, {
        text: qrUri,
        width: 200,
        height: 200,
        colorDark: '#000000',
        colorLight: '#ffffff',
        correctLevel: QRCode.CorrectLevel.L
      });
    }
  }, [qrUri, step]);

  const handleVerifyCode = () => {
    setError('');
    if (!verificationCode || verificationCode.length !== 6) {
      setError('Please enter a 6-digit code');
      return;
    }

    if (verify2FACode(secret, verificationCode)) {
      // Generate backup codes
      const codes = generateBackupCodes(8);
      setBackupCodes(codes);
      setStep(3);
    } else {
      setError('Invalid code. Please try again.');
    }
  };

  const handleComplete = async () => {
    setSaving(true);
    try {
      // Hash backup codes for storage
      const hashedBackupCodes = backupCodes.map(code => ({
        hash: hashBackupCode(code),
        used: false
      }));

      // Determine collection based on user type
      let collection = 'teachers';
      let docId = user.afid || user.docId;
      
      if (user.role) {
        collection = 'managers';
        docId = user.docId || user.uid;
      }

      // Save 2FA settings to Firestore
      await db.collection('twoFactorAuth').doc(docId).set({
        enabled: true,
        secret: secret, // In production, encrypt this!
        backupCodes: hashedBackupCodes,
        setupAt: new Date().toISOString(),
        userEmail: user.email,
        userType: user.role ? 'manager' : 'teacher'
      });

      // Update user's 2FA status
      await db.collection(collection).doc(docId).update({
        twoFactorEnabled: true,
        twoFactorSetupAt: new Date().toISOString()
      });

      onSetupComplete();
    } catch (e) {
      console.error('Error saving 2FA settings:', e);
      setError('Failed to save 2FA settings: ' + e.message);
    } finally {
      setSaving(false);
    }
  };

  return (
    <div className="modal-overlay" onClick={onClose}>
      <div className="modal-content max-w-lg" onClick={e => e.stopPropagation()}>
        <div className="flex justify-between items-center mb-4">
          <h3 className="text-2xl font-bold">üîê Setup Two-Factor Authentication</h3>
          <button onClick={onClose} className="text-2xl text-gray-400 hover:text-gray-600">√ó</button>
        </div>

        {step === 1 && (
          <div className="space-y-4">
            <div className="bg-blue-50 border-2 border-blue-200 p-4 rounded-xl">
              <p className="text-blue-800 font-semibold mb-2">Step 1: Scan QR Code</p>
              <p className="text-sm text-blue-600">
                Open your authenticator app (Google Authenticator, Microsoft Authenticator, Authy, etc.) and scan this QR code.
              </p>
            </div>

            <div className="flex justify-center p-4 bg-white rounded-xl border-2">
              <div ref={qrRef}></div>
            </div>

            <div className="bg-gray-50 p-4 rounded-xl">
              <p className="text-sm font-semibold mb-2">Can't scan? Enter this code manually:</p>
              <code className="block bg-white p-3 rounded-lg text-sm font-mono break-all border">
                {secret}
              </code>
            </div>

            <button
              onClick={() => setStep(2)}
              className="w-full py-3 bg-blue-600 text-white rounded-xl font-semibold hover:bg-blue-700"
            >
              Next: Verify Code ‚Üí
            </button>
          </div>
        )}

        {step === 2 && (
          <div className="space-y-4">
            <div className="bg-green-50 border-2 border-green-200 p-4 rounded-xl">
              <p className="text-green-800 font-semibold mb-2">Step 2: Verify Setup</p>
              <p className="text-sm text-green-600">
                Enter the 6-digit code from your authenticator app to confirm setup.
              </p>
            </div>

            <div>
              <label className="block text-sm font-bold mb-2">Verification Code</label>
              <input
                type="text"
                value={verificationCode}
                onChange={e => setVerificationCode(e.target.value.replace(/\D/g, '').slice(0, 6))}
                placeholder="Enter 6-digit code"
                className="w-full px-4 py-3 border-2 rounded-xl text-center text-2xl font-mono tracking-widest"
                maxLength={6}
                autoFocus
              />
            </div>

            {error && (
              <div className="bg-red-50 border-2 border-red-200 p-3 rounded-xl text-red-700 text-sm">
                {error}
              </div>
            )}

            <div className="flex gap-3">
              <button
                onClick={() => setStep(1)}
                className="flex-1 py-3 bg-gray-200 rounded-xl font-semibold hover:bg-gray-300"
              >
                ‚Üê Back
              </button>
              <button
                onClick={handleVerifyCode}
                className="flex-1 py-3 bg-green-600 text-white rounded-xl font-semibold hover:bg-green-700"
              >
                Verify Code
              </button>
            </div>
          </div>
        )}

        {step === 3 && (
          <div className="space-y-4">
            <div className="bg-yellow-50 border-2 border-yellow-200 p-4 rounded-xl">
              <p className="text-yellow-800 font-semibold mb-2">‚ö†Ô∏è Step 3: Save Backup Codes</p>
              <p className="text-sm text-yellow-700">
                Save these backup codes in a safe place. You can use them to login if you lose access to your authenticator app. Each code can only be used once.
              </p>
            </div>

            <div className="bg-white border-2 p-4 rounded-xl">
              <div className="grid grid-cols-2 gap-2">
                {backupCodes.map((code, i) => (
                  <div key={i} className="font-mono text-center py-2 bg-gray-100 rounded-lg">
                    {code}
                  </div>
                ))}
              </div>
            </div>

            <button
              onClick={() => {
                const codesText = backupCodes.join('\n');
                const blob = new Blob([`Avanti Curriculum Tracker - Backup Codes\n\nEmail: ${user.email}\nGenerated: ${new Date().toLocaleString()}\n\nBackup Codes:\n${codesText}\n\nKeep these codes safe! Each code can only be used once.`], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'avanti-2fa-backup-codes.txt';
                a.click();
              }}
              className="w-full py-3 bg-gray-200 rounded-xl font-semibold hover:bg-gray-300"
            >
              üì• Download Backup Codes
            </button>

            {error && (
              <div className="bg-red-50 border-2 border-red-200 p-3 rounded-xl text-red-700 text-sm">
                {error}
              </div>
            )}

            <button
              onClick={handleComplete}
              disabled={saving}
              className="w-full py-3 bg-green-600 text-white rounded-xl font-semibold hover:bg-green-700 disabled:opacity-50"
            >
              {saving ? 'Saving...' : '‚úì Complete Setup'}
            </button>
          </div>
        )}
      </div>
    </div>
  );
}

// 2FA Verification Modal (shown during login)
function TwoFactorVerifyModal({ user, onVerified, onCancel, onUseBackupCode }) {
  const [code, setCode] = useState('');
  const [error, setError] = useState('');
  const [verifying, setVerifying] = useState(false);
  const [showBackupInput, setShowBackupInput] = useState(false);
  const [backupCode, setBackupCode] = useState('');
  const [retryCount, setRetryCount] = useState(0);

  const handleVerify = async (inputCode) => {
    const codeToVerify = inputCode || code;
    setError('');
    if (!codeToVerify || codeToVerify.length !== 6) {
      setError('Please enter a 6-digit code');
      return;
    }

    setVerifying(true);
    try {
      // Get 2FA settings from Firestore
      const docId = user.afid || user.docId || user.uid || user.id;
      const twoFADoc = await db.collection('twoFactorAuth').doc(docId).get();
      
      if (!twoFADoc.exists) {
        setError('2FA not configured. Please contact admin.');
        return;
      }

      const twoFAData = twoFADoc.data();
      
      if (verify2FACode(twoFAData.secret, codeToVerify)) {
        onVerified();
      } else {
        setRetryCount(prev => prev + 1);
        if (retryCount >= 2) {
          setError('Code invalid. Tip: Wait for a new code to appear in your app, then enter it immediately.');
        } else {
          setError('Invalid code. Please check your authenticator app and try again.');
        }
        setCode(''); // Clear for retry
      }
    } catch (e) {
      console.error('2FA verification error:', e);
      if (e.message?.includes('network') || e.message?.includes('timeout')) {
        setError('Network issue. Please check your connection and try again.');
      } else {
        setError('Verification failed: ' + e.message);
      }
    } finally {
      setVerifying(false);
    }
  };

  // Auto-submit when 6 digits are entered
  const handleCodeChange = (e) => {
    const newCode = e.target.value.replace(/\D/g, '').slice(0, 6);
    setCode(newCode);
    if (newCode.length === 6) {
      // Small delay to show the full code before submitting
      setTimeout(() => handleVerify(newCode), 200);
    }
  };

  const handleBackupCodeVerify = async () => {
    setError('');
    if (!backupCode) {
      setError('Please enter a backup code');
      return;
    }

    setVerifying(true);
    try {
      const docId = user.afid || user.docId || user.uid || user.id;
      const twoFADoc = await db.collection('twoFactorAuth').doc(docId).get();
      
      if (!twoFADoc.exists) {
        setError('2FA not configured. Please contact admin.');
        return;
      }

      const twoFAData = twoFADoc.data();
      const backupCodes = twoFAData.backupCodes || [];
      
      const codeIndex = verifyBackupCode(backupCode, backupCodes);
      
      if (codeIndex >= 0) {
        // Mark the backup code as used
        backupCodes[codeIndex].used = true;
        await db.collection('twoFactorAuth').doc(docId).update({
          backupCodes: backupCodes
        });
        onVerified();
      } else {
        setError('Invalid or already used backup code.');
      }
    } catch (e) {
      console.error('Backup code verification error:', e);
      setError('Verification failed: ' + e.message);
    } finally {
      setVerifying(false);
    }
  };

  return (
    <div className="modal-overlay">
      <div className="modal-content max-w-md">
        <div className="text-center mb-6">
          <div className="text-5xl mb-3">üîê</div>
          <h3 className="text-2xl font-bold">Two-Factor Authentication</h3>
          <p className="text-gray-600 mt-2">Enter the code from your authenticator app</p>
        </div>

        {!showBackupInput ? (
          <div className="space-y-4">
            {/* Helpful tip for remote users */}
            <div className="bg-blue-50 border border-blue-200 p-3 rounded-xl text-sm text-blue-700">
              üí° <strong>Tip:</strong> Code changes every 30 seconds. Enter it as soon as you see it.
            </div>
            
            {/* Device trust info */}
            <div className="bg-green-50 border border-green-200 p-3 rounded-xl text-sm text-green-700">
              ‚úÖ This device will be remembered for <strong>15 days</strong> after verification.
            </div>

            <input
              type="text"
              inputMode="numeric"
              pattern="[0-9]*"
              value={code}
              onChange={handleCodeChange}
              placeholder="000000"
              className="w-full px-4 py-4 border-2 rounded-xl text-center text-3xl font-mono tracking-widest"
              maxLength={6}
              autoFocus
              autoComplete="one-time-code"
              disabled={verifying}
            />

            {error && (
              <div className="bg-red-50 border-2 border-red-200 p-3 rounded-xl text-red-700 text-sm text-center">
                {error}
              </div>
            )}

            {verifying && (
              <div className="text-center text-gray-600">
                <div className="inline-block animate-spin mr-2">‚è≥</div>
                Verifying...
              </div>
            )}

            <button
              onClick={() => handleVerify()}
              disabled={verifying || code.length !== 6}
              className="w-full py-3 bg-blue-600 text-white rounded-xl font-semibold hover:bg-blue-700 disabled:opacity-50"
            >
              {verifying ? 'Verifying...' : 'Verify'}
            </button>

            <div className="text-center">
              <button
                onClick={() => setShowBackupInput(true)}
                className="text-blue-600 text-sm hover:underline"
              >
                Lost your phone? Use a backup code
              </button>
            </div>

            <button
              onClick={onCancel}
              className="w-full py-3 bg-gray-200 rounded-xl font-semibold hover:bg-gray-300"
            >
              Cancel Login
            </button>
          </div>
        ) : (
          <div className="space-y-4">
            <div className="bg-yellow-50 border-2 border-yellow-200 p-3 rounded-xl text-sm">
              <p className="text-yellow-800 font-semibold">Using Backup Code</p>
              <p className="text-yellow-700">Enter one of your saved backup codes. Each code can only be used once.</p>
            </div>

            <input
              type="text"
              value={backupCode}
              onChange={e => setBackupCode(e.target.value.toUpperCase())}
              placeholder="XXXX-XXXX"
              className="w-full px-4 py-4 border-2 rounded-xl text-center text-xl font-mono tracking-wider"
              autoFocus
              onKeyPress={e => e.key === 'Enter' && handleBackupCodeVerify()}
            />

            {error && (
              <div className="bg-red-50 border-2 border-red-200 p-3 rounded-xl text-red-700 text-sm text-center">
                {error}
              </div>
            )}

            <button
              onClick={handleBackupCodeVerify}
              disabled={verifying}
              className="w-full py-3 bg-green-600 text-white rounded-xl font-semibold hover:bg-green-700 disabled:opacity-50"
            >
              {verifying ? 'Verifying...' : 'Use Backup Code'}
            </button>

            <button
              onClick={() => {setShowBackupInput(false); setError('');}}
              className="w-full py-3 bg-gray-200 rounded-xl font-semibold hover:bg-gray-300"
            >
              ‚Üê Back to Code Entry
            </button>
          </div>
        )}
      </div>
    </div>
  );
}

// Admin 2FA Management Component (for Super Admin to reset 2FA)
function Admin2FAManagement({ teachers, managers }) {
  const [searchTerm, setSearchTerm] = useState('');
  const [filterType, setFilterType] = useState('All');
  const [twoFAUsers, setTwoFAUsers] = useState({});
  const [loading, setLoading] = useState(true);
  const [resetting, setResetting] = useState(null);
  const [apcs, setApcs] = useState([]);

  useEffect(() => {
    const fetch2FAStatus = async () => {
      try {
        // Fetch 2FA status
        const twoFASnap = await db.collection('twoFactorAuth').get();
        const status = {};
        twoFASnap.docs.forEach(doc => {
          status[doc.id] = doc.data();
        });
        setTwoFAUsers(status);
        
        // Fetch APCs
        const apcsSnap = await db.collection('apcs').get();
        setApcs(apcsSnap.docs.map(d => ({ ...d.data(), id: d.id })));
      } catch (e) {
        console.error('Error fetching 2FA status:', e);
      } finally {
        setLoading(false);
      }
    };
    fetch2FAStatus();
  }, []);

  const allUsers = [
    ...teachers.map(t => ({ ...t, type: 'Teacher', docId: t.afid, twoFADocId: t.afid })),
    ...managers.map(m => ({ ...m, type: ROLE_LABELS[m.role] || 'Manager', docId: m.docId, twoFADocId: m.docId || m.uid || m.id })),
    ...apcs.map(a => ({ ...a, type: 'APC', docId: a.id, twoFADocId: a.id }))
  ];

  const filteredUsers = allUsers.filter(user => {
    if (filterType !== 'All' && user.type !== filterType) return false;
    if (searchTerm && !user.name?.toLowerCase().includes(searchTerm.toLowerCase()) && 
        !user.email?.toLowerCase().includes(searchTerm.toLowerCase())) return false;
    return true;
  });

  const handleReset2FA = async (user) => {
    if (!confirm(`Reset 2FA for ${user.name}?\n\nThis will disable their 2FA and remove all trusted devices. They will need to set it up again on next login.`)) return;
    
    setResetting(user.docId);
    try {
      // Find the actual 2FA document ID by checking all possible IDs
      const possibleIds = [user.twoFADocId, user.docId, user.id, user.uid, user.afid].filter(Boolean);
      let actualTwoFADocId = null;
      
      for (const id of possibleIds) {
        const doc = await db.collection('twoFactorAuth').doc(id).get();
        if (doc.exists) {
          actualTwoFADocId = id;
          break;
        }
      }
      
      if (actualTwoFADocId) {
        // Delete 2FA document
        await db.collection('twoFactorAuth').doc(actualTwoFADocId).delete();
        // Remove all trusted devices for this user
        await removeAllDeviceTrusts(actualTwoFADocId);
      }
      
      // Update user's 2FA status
      const collection = user.type === 'Teacher' ? 'teachers' : user.type === 'APC' ? 'apcs' : 'managers';
      const userDocId = user.docId || user.afid || user.id;
      await db.collection(collection).doc(userDocId).update({
        twoFactorEnabled: false,
        twoFactorResetAt: new Date().toISOString()
      });

      // Update local state - remove all possible IDs
      setTwoFAUsers(prev => {
        const updated = { ...prev };
        possibleIds.forEach(id => { delete updated[id]; });
        return updated;
      });

      alert(`‚úÖ 2FA reset for ${user.name}. They will need to set up 2FA again on next login from any device.`);
    } catch (e) {
      console.error('Error resetting 2FA:', e);
      alert('Failed to reset 2FA: ' + e.message);
    } finally {
      setResetting(null);
    }
  };

  if (loading) {
    return (
      <div className="text-center py-8">
        <div className="text-4xl mb-4">‚è≥</div>
        <p>Loading 2FA status...</p>
      </div>
    );
  }

  // Calculate enabled count by checking multiple possible IDs for each user
  const enabledCount = allUsers.filter(user => {
    const possibleIds = [user.twoFADocId, user.docId, user.id, user.uid, user.afid].filter(Boolean);
    return possibleIds.some(id => twoFAUsers[id]?.enabled);
  }).length;
  const pendingCount = allUsers.length - enabledCount;

  return (
    <div className="space-y-6">
      <h2 className="text-3xl font-bold">üîê Two-Factor Authentication Management</h2>

      {/* Stats */}
      <div className="grid md:grid-cols-3 gap-4">
        <div className="bg-gradient-to-r from-green-500 to-green-600 text-white p-4 rounded-xl">
          <div className="text-sm opacity-90">2FA Enabled</div>
          <div className="text-3xl font-bold">{enabledCount}</div>
        </div>
        <div className="bg-gradient-to-r from-orange-500 to-orange-600 text-white p-4 rounded-xl">
          <div className="text-sm opacity-90">2FA Pending Setup</div>
          <div className="text-3xl font-bold">{pendingCount}</div>
        </div>
        <div className="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-4 rounded-xl">
          <div className="text-sm opacity-90">Total Users</div>
          <div className="text-3xl font-bold">{allUsers.length}</div>
        </div>
      </div>

      {/* Filters */}
      <div className="bg-white p-4 rounded-xl shadow">
        <div className="grid md:grid-cols-2 gap-4">
          <div>
            <label className="block text-sm font-bold mb-2">Search</label>
            <input
              type="text"
              value={searchTerm}
              onChange={e => setSearchTerm(e.target.value)}
              placeholder="Search by name or email..."
              className="w-full border-2 px-4 py-2 rounded-xl"
            />
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">User Type</label>
            <select
              value={filterType}
              onChange={e => setFilterType(e.target.value)}
              className="w-full border-2 px-4 py-2 rounded-xl"
            >
              <option value="All">All Users</option>
              <option value="Teacher">Teachers</option>
              <option value="Super Admin">Super Admins</option>
              <option value="Associate Program Head">Program Heads</option>
              <option value="Program Manager">Program Managers</option>
              <option value="Associate Program Manager">APMs</option>
            </select>
          </div>
        </div>
      </div>

      {/* Users Table */}
      <div className="bg-white p-6 rounded-xl shadow overflow-x-auto">
        <table className="w-full">
          <thead className="avanti-gradient-light">
            <tr>
              <th className="p-3 text-left">Name</th>
              <th className="p-3 text-left">Email</th>
              <th className="p-3 text-left">Type</th>
              <th className="p-3 text-center">2FA Status</th>
              <th className="p-3 text-left">Actions</th>
            </tr>
          </thead>
          <tbody>
            {filteredUsers.map(user => {
              // Try multiple possible IDs for 2FA status lookup
              const possibleIds = [user.twoFADocId, user.docId, user.id, user.uid, user.afid].filter(Boolean);
              const twoFA = possibleIds.map(id => twoFAUsers[id]).find(t => t) || null;
              const isEnabled = twoFA?.enabled;
              
              return (
                <tr key={user.docId} className="border-b hover:bg-gray-50">
                  <td className="p-3 font-semibold">{user.name}</td>
                  <td className="p-3 text-sm">{user.email}</td>
                  <td className="p-3">
                    <span className={`px-2 py-1 rounded-full text-xs font-bold ${
                      user.type === 'Teacher' ? 'bg-blue-100 text-blue-700' :
                      user.type === 'Super Admin' ? 'bg-purple-100 text-purple-700' :
                      'bg-green-100 text-green-700'
                    }`}>
                      {user.type}
                    </span>
                  </td>
                  <td className="p-3 text-center">
                    {isEnabled ? (
                      <span className="px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm font-bold">
                        ‚úì Enabled
                      </span>
                    ) : (
                      <span className="px-3 py-1 bg-yellow-100 text-yellow-700 rounded-full text-sm font-bold">
                        ‚è≥ Pending
                      </span>
                    )}
                  </td>
                  <td className="p-3">
                    {isEnabled && (
                      <button
                        onClick={() => handleReset2FA(user)}
                        disabled={resetting === user.docId}
                        className="px-4 py-2 bg-red-500 text-white rounded-lg text-sm font-semibold hover:bg-red-600 disabled:opacity-50"
                      >
                        {resetting === user.docId ? 'Resetting...' : 'üîÑ Reset 2FA'}
                      </button>
                    )}
                  </td>
                </tr>
              );
            })}
          </tbody>
        </table>
      </div>
    </div>
  );
}

// Network Status Indicator for low-connectivity areas
function NetworkStatus() {
  const [isOnline, setIsOnline] = useState(navigator.onLine);
  const [connectionType, setConnectionType] = useState('');
  const [showBanner, setShowBanner] = useState(false);
  
  useEffect(() => {
    const handleOnline = () => {
      setIsOnline(true);
      setShowBanner(true);
      setTimeout(() => setShowBanner(false), 3000);
    };
    
    const handleOffline = () => {
      setIsOnline(false);
      setShowBanner(true);
    };
    
    // Check connection type if available
    const updateConnectionType = () => {
      if ('connection' in navigator) {
        const conn = navigator.connection;
        setConnectionType(conn?.effectiveType || '');
      }
    };
    
    window.addEventListener('online', handleOnline);
    window.addEventListener('offline', handleOffline);
    
    if ('connection' in navigator) {
      navigator.connection.addEventListener('change', updateConnectionType);
      updateConnectionType();
    }
    
    return () => {
      window.removeEventListener('online', handleOnline);
      window.removeEventListener('offline', handleOffline);
      if ('connection' in navigator) {
        navigator.connection.removeEventListener('change', updateConnectionType);
      }
    };
  }, []);
  
  // Show slow connection warning for 2g or slow-2g
  const isSlowConnection = connectionType === '2g' || connectionType === 'slow-2g';
  
  if (!showBanner && isOnline && !isSlowConnection) return null;
  
  return (
    <div className={`fixed bottom-4 left-4 right-4 md:left-auto md:right-4 md:w-auto z-50 px-4 py-3 rounded-xl shadow-lg flex items-center gap-3 text-sm font-medium transition-all ${
      !isOnline 
        ? 'bg-red-500 text-white' 
        : isSlowConnection 
          ? 'bg-yellow-500 text-black' 
          : 'bg-green-500 text-white'
    }`}>
      <span className="text-lg">
        {!isOnline ? 'üì°' : isSlowConnection ? 'üêå' : '‚úì'}
      </span>
      <div>
        <div className="font-bold">
          {!isOnline ? 'No Internet Connection' : isSlowConnection ? 'Slow Connection' : 'Back Online!'}
        </div>
        <div className="text-xs opacity-90">
          {!isOnline 
            ? 'Changes will sync when connected' 
            : isSlowConnection 
              ? 'Data may take longer to load' 
              : 'All data synced successfully'
          }
        </div>
      </div>
      {(isOnline && !isSlowConnection) && (
        <button 
          onClick={() => setShowBanner(false)} 
          className="ml-2 text-white/80 hover:text-white"
        >
          ‚úï
        </button>
      )}
    </div>
  );
}

// ========================================
// DATA FRESHNESS INDICATOR COMPONENT
// Shows connection status, data freshness, and pending sync (for low-connectivity JNV areas)
// ========================================
function DataFreshnessIndicator() {
  const [isStale, setIsStale] = useState(false);
  const [lastUpdateTime, setLastUpdateTime] = useState(null);
  const [isRefreshing, setIsRefreshing] = useState(false);
  const [showDetails, setShowDetails] = useState(false);
  const [connectionQuality, setConnectionQuality] = useState('unknown');
  const [isOnline, setIsOnline] = useState(navigator.onLine);
  const [pendingCount, setPendingCount] = useState(0);
  
  useEffect(() => {
    // Check data freshness periodically
    const checkStatus = () => {
      // Data freshness
      if (window.DataCacheManager) {
        const attendanceFreshness = window.DataCacheManager.getFreshness('studentAttendance_' + (window._currentUserSchool || 'all'));
        const isDataStale = attendanceFreshness === 'stale';
        setIsStale(isDataStale);
        
        const timestamp = window.DataCacheManager._cacheTimestamps['studentAttendance_' + (window._currentUserSchool || 'all')];
        if (timestamp) {
          setLastUpdateTime(timestamp);
        }
      }
      
      // Connection quality
      if (window.ConnectionManager) {
        setConnectionQuality(window.ConnectionManager.getQuality());
        setIsOnline(window.ConnectionManager.isOnline());
      } else {
        setIsOnline(navigator.onLine);
      }
      
      // Pending operations
      if (window.OfflineQueue) {
        setPendingCount(window.OfflineQueue.getPendingCount());
      }
    };
    
    checkStatus();
    const interval = setInterval(checkStatus, 10000); // Check every 10 seconds
    
    // Listen for updates
    const handleCacheUpdate = () => {
      checkStatus();
      setIsRefreshing(false);
    };
    window.addEventListener('dataCacheUpdated', handleCacheUpdate);
    window.addEventListener('connectionRestored', checkStatus);
    window.addEventListener('connectionLost', checkStatus);
    
    return () => {
      clearInterval(interval);
      window.removeEventListener('dataCacheUpdated', handleCacheUpdate);
      window.removeEventListener('connectionRestored', checkStatus);
      window.removeEventListener('connectionLost', checkStatus);
    };
  }, []);
  
  const handleRefresh = async () => {
    setIsRefreshing(true);
    window._forceRefresh = true;
    
    try {
      // First try to sync pending operations
      if (window.OfflineQueue && pendingCount > 0) {
        await window.OfflineQueue.processQueue();
      }
      
      // Trigger page reload to force fresh data
      window.location.reload();
    } catch(e) {
      console.error('Refresh failed:', e);
      setIsRefreshing(false);
    }
    
    setTimeout(() => { window._forceRefresh = false; }, 5000);
  };
  
  const getTimeAgo = (timestamp) => {
    if (!timestamp) return 'Unknown';
    const seconds = Math.floor((Date.now() - timestamp) / 1000);
    if (seconds < 60) return 'Just now';
    if (seconds < 3600) return Math.floor(seconds / 60) + 'm ago';
    if (seconds < 86400) return Math.floor(seconds / 3600) + 'h ago';
    return Math.floor(seconds / 86400) + 'd ago';
  };
  
  const getConnectionIcon = () => {
    if (!isOnline) return 'üì¥';
    if (connectionQuality === 'good') return 'üì∂';
    if (connectionQuality === 'slow') return 'üì∂';
    if (connectionQuality === 'very-slow') return 'üêå';
    return 'üì°';
  };
  
  const getConnectionColor = () => {
    if (!isOnline) return 'bg-red-500';
    if (connectionQuality === 'good') return 'bg-green-500';
    if (connectionQuality === 'slow') return 'bg-yellow-500';
    if (connectionQuality === 'very-slow') return 'bg-orange-500';
    return 'bg-gray-500';
  };
  
  // Always show if offline or has pending operations
  const shouldShow = !isOnline || isStale || isRefreshing || pendingCount > 0 || connectionQuality === 'very-slow';
  if (!shouldShow) return null;
  
  return (
    <div className="fixed bottom-20 right-4 z-40">
      <div 
        className={`px-3 py-2 rounded-lg shadow-lg text-sm cursor-pointer transition-all ${getConnectionColor()} text-white`}
        onClick={() => setShowDetails(!showDetails)}
      >
        <div className="flex items-center gap-2">
          {isRefreshing ? (
            <>
              <div className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
              <span>Syncing...</span>
            </>
          ) : (
            <>
              <span>{getConnectionIcon()}</span>
              <span>
                {!isOnline ? 'Offline' : 
                 connectionQuality === 'very-slow' ? 'Slow Network' :
                 isStale ? `Data: ${getTimeAgo(lastUpdateTime)}` : 'Online'}
              </span>
              {pendingCount > 0 && (
                <span className="bg-white text-red-500 px-1.5 rounded-full text-xs font-bold">{pendingCount}</span>
              )}
            </>
          )}
        </div>
      </div>
      
      {showDetails && (
        <div className="mt-2 bg-white rounded-lg shadow-lg p-3 text-sm border border-gray-200">
          <div className="text-gray-700 mb-3">
            <div className="flex items-center justify-between mb-2">
              <strong>üì° Network Status</strong>
              <span className={`px-2 py-0.5 rounded text-xs font-bold ${
                isOnline ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'
              }`}>
                {isOnline ? 'Connected' : 'Disconnected'}
              </span>
            </div>
            
            {connectionQuality && connectionQuality !== 'unknown' && (
              <div className="text-xs text-gray-500 mb-2">
                Speed: <span className={`font-bold ${
                  connectionQuality === 'good' ? 'text-green-600' :
                  connectionQuality === 'slow' ? 'text-yellow-600' : 'text-red-600'
                }`}>
                  {connectionQuality === 'good' ? 'Good' :
                   connectionQuality === 'slow' ? 'Slow' : 'Very Slow'}
                </span>
              </div>
            )}
            
            {lastUpdateTime && (
              <div className="text-xs text-gray-500 mb-2">
                Last sync: <span className="font-medium">{getTimeAgo(lastUpdateTime)}</span>
              </div>
            )}
            
            {pendingCount > 0 && (
              <div className="bg-yellow-50 border border-yellow-200 rounded p-2 mb-2">
                <span className="text-yellow-700 text-xs">
                  ‚è≥ {pendingCount} operation(s) waiting to sync
                </span>
              </div>
            )}
            
            {!isOnline && (
              <p className="text-xs text-gray-500 mt-1 bg-gray-50 p-2 rounded">
                You're offline. Data is saved locally and will sync when connected.
              </p>
            )}
          </div>
          
          <button
            onClick={handleRefresh}
            disabled={isRefreshing}
            className="w-full px-3 py-2 bg-blue-500 text-white rounded-lg font-medium disabled:opacity-50 flex items-center justify-center gap-2"
          >
            {isRefreshing ? (
              <>
                <div className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                Syncing...
              </>
            ) : (
              <>üîÑ Refresh Now</>
            )}
          </button>
        </div>
      )}
    </div>
  );
}

// ========================================
// ONLINE STATUS CARD COMPONENT
// ========================================
function OnlineStatusCard({ currentUser }) {
  const [onlineCount, setOnlineCount] = useState(0);
  const [isVisible, setIsVisible] = useState(true);
  const [onlineUsers, setOnlineUsers] = useState({});
  
  useEffect(() => {
    if (!currentUser) return;
    
    // Initialize presence system with userId AND userName for better tracking
    const userId = currentUser.afid || currentUser.uid || currentUser.email || currentUser.name;
    const userName = currentUser.name || '';
    
    PresenceSystem.init(userId, userName);
    
    // Subscribe to presence updates
    const unsubscribe = PresenceSystem.subscribe((users) => {
      setOnlineUsers(users);
      setOnlineCount(Object.keys(users).length);
    });
    
    return () => {
      unsubscribe();
      PresenceSystem.cleanup();
    };
  }, [currentUser]);
  
  if (!isVisible) return null;
  
  const totalUsers = 100; // Approximate total users
  const offlineCount = Math.max(0, totalUsers - onlineCount);
  
  return (
    <div className="online-status-card">
      <button className="close-btn" onClick={() => setIsVisible(false)}>‚úï</button>
      <div className="text-xs text-gray-400 mb-2 font-semibold">TEAM STATUS</div>
      <div className="status-row">
        <div className="status-dot online"></div>
        <span className="text-green-400 font-bold">{onlineCount}</span>
        <span className="text-gray-400 text-sm">Online</span>
      </div>
      <div className="status-row">
        <div className="status-dot offline"></div>
        <span className="text-gray-500 font-bold">{offlineCount}</span>
        <span className="text-gray-400 text-sm">Offline</span>
      </div>
    </div>
  );
}

// ========================================
// MENTION INPUT COMPONENT
// ========================================
function MentionInput({ value, onChange, placeholder, allMembers, className, onSubmit }) {
  const [showDropdown, setShowDropdown] = useState(false);
  const [mentionQuery, setMentionQuery] = useState('');
  const [mentionStart, setMentionStart] = useState(null);
  const [highlightedIndex, setHighlightedIndex] = useState(0);
  const inputRef = useRef(null);
  
  // Filter members based on mention query
  const filteredMembers = useMemo(() => {
    if (!mentionQuery) return [];
    
    const query = mentionQuery.toLowerCase();
    
    // Add @everyone option at the top
    let results = [];
    if ('everyone'.includes(query)) {
      results.push({ id: 'everyone', name: 'everyone', isEveryone: true });
    }
    
    // Filter actual members
    const memberResults = (allMembers || [])
      .filter(m => m.name?.toLowerCase().includes(query))
      .slice(0, 5);
    
    return [...results, ...memberResults];
  }, [mentionQuery, allMembers]);
  
  const handleInputChange = (e) => {
    const newValue = e.target.value;
    const cursorPos = e.target.selectionStart;
    
    // Check for @ symbol
    const textBeforeCursor = newValue.slice(0, cursorPos);
    const lastAtIndex = textBeforeCursor.lastIndexOf('@');
    
    if (lastAtIndex !== -1) {
      const textAfterAt = textBeforeCursor.slice(lastAtIndex + 1);
      // Check if there's a space between @ and cursor (which means mention is complete)
      if (!textAfterAt.includes(' ')) {
        setMentionQuery(textAfterAt);
        setMentionStart(lastAtIndex);
        setShowDropdown(true);
        setHighlightedIndex(0);
      } else {
        setShowDropdown(false);
      }
    } else {
      setShowDropdown(false);
    }
    
    onChange(newValue);
  };
  
  const selectMention = (member) => {
    if (mentionStart === null) return;
    
    const beforeMention = value.slice(0, mentionStart);
    const afterCursor = value.slice(mentionStart + mentionQuery.length + 1);
    const mention = member.isEveryone ? '@everyone ' : `@${member.name} `;
    
    const newValue = beforeMention + mention + afterCursor;
    onChange(newValue);
    setShowDropdown(false);
    setMentionQuery('');
    setMentionStart(null);
    
    // Focus back on input
    setTimeout(() => {
      if (inputRef.current) {
        inputRef.current.focus();
        const newPos = beforeMention.length + mention.length;
        inputRef.current.setSelectionRange(newPos, newPos);
      }
    }, 0);
  };
  
  const handleKeyDown = (e) => {
    if (!showDropdown || filteredMembers.length === 0) {
      if (e.key === 'Enter' && onSubmit && value.trim()) {
        e.preventDefault();
        onSubmit();
      }
      return;
    }
    
    if (e.key === 'ArrowDown') {
      e.preventDefault();
      setHighlightedIndex(i => Math.min(i + 1, filteredMembers.length - 1));
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      setHighlightedIndex(i => Math.max(i - 1, 0));
    } else if (e.key === 'Enter' || e.key === 'Tab') {
      e.preventDefault();
      selectMention(filteredMembers[highlightedIndex]);
    } else if (e.key === 'Escape') {
      setShowDropdown(false);
    }
  };
  
  // Parse and render mentions in display
  const renderWithMentions = (text) => {
    if (!text) return text;
    
    const parts = text.split(/(@\w+(?:\s\w+)?)/g);
    return parts.map((part, i) => {
      if (part.startsWith('@')) {
        const isEveryone = part.toLowerCase() === '@everyone';
        return (
          <span key={i} className={`mention-tag ${isEveryone ? 'mention-everyone' : ''}`}>
            {part}
          </span>
        );
      }
      return part;
    });
  };
  
  return (
    <div className="mention-input-container">
      {showDropdown && filteredMembers.length > 0 && (
        <div className="mention-dropdown">
          {filteredMembers.map((member, idx) => (
            <div
              key={member.id || member.afid || idx}
              className={`mention-dropdown-item ${idx === highlightedIndex ? 'highlighted' : ''}`}
              onClick={() => selectMention(member)}
            >
              {member.isEveryone ? (
                <>
                  <div className="avatar" style={{ background: 'linear-gradient(135deg, #ef4444, #f59e0b)' }}>@</div>
                  <div>
                    <div className="font-semibold text-red-600">@everyone</div>
                    <div className="text-xs text-gray-500">Notify all team members</div>
                  </div>
                </>
              ) : (
                <>
                  {member.profilePhoto ? (
                    <img src={member.profilePhoto} alt="" className="w-8 h-8 rounded-full object-cover" />
                  ) : (
                    <div className="avatar">{member.name?.charAt(0)}</div>
                  )}
                  <div>
                    <div className="font-semibold">{member.name}</div>
                    <div className="text-xs text-gray-500">{member.school || member.role}</div>
                  </div>
                </>
              )}
            </div>
          ))}
        </div>
      )}
      <input
        ref={inputRef}
        type="text"
        value={value}
        onChange={handleInputChange}
        onKeyDown={handleKeyDown}
        placeholder={placeholder}
        className={className}
      />
    </div>
  );
}

// ========================================
// MENTION TEXTAREA COMPONENT (for posts)
// ========================================
function MentionTextarea({ value, onChange, placeholder, allMembers, className, rows }) {
  const [showDropdown, setShowDropdown] = useState(false);
  const [mentionQuery, setMentionQuery] = useState('');
  const [mentionStart, setMentionStart] = useState(null);
  const [highlightedIndex, setHighlightedIndex] = useState(0);
  const textareaRef = useRef(null);
  
  // Filter members based on mention query
  const filteredMembers = useMemo(() => {
    if (!mentionQuery) return [];
    
    const query = mentionQuery.toLowerCase();
    
    // Add @everyone option at the top
    let results = [];
    if ('everyone'.includes(query)) {
      results.push({ id: 'everyone', name: 'everyone', isEveryone: true });
    }
    
    // Filter actual members
    const memberResults = (allMembers || [])
      .filter(m => m.name?.toLowerCase().includes(query))
      .slice(0, 5);
    
    return [...results, ...memberResults];
  }, [mentionQuery, allMembers]);
  
  const handleInputChange = (e) => {
    const newValue = e.target.value;
    const cursorPos = e.target.selectionStart;
    
    // Check for @ symbol
    const textBeforeCursor = newValue.slice(0, cursorPos);
    const lastAtIndex = textBeforeCursor.lastIndexOf('@');
    
    if (lastAtIndex !== -1) {
      const textAfterAt = textBeforeCursor.slice(lastAtIndex + 1);
      // Check if there's a space between @ and cursor (which means mention is complete)
      if (!textAfterAt.includes(' ') && !textAfterAt.includes('\n')) {
        setMentionQuery(textAfterAt);
        setMentionStart(lastAtIndex);
        setShowDropdown(true);
        setHighlightedIndex(0);
      } else {
        setShowDropdown(false);
      }
    } else {
      setShowDropdown(false);
    }
    
    onChange(newValue);
  };
  
  const selectMention = (member) => {
    if (mentionStart === null) return;
    
    const beforeMention = value.slice(0, mentionStart);
    const afterCursor = value.slice(mentionStart + mentionQuery.length + 1);
    const mention = member.isEveryone ? '@everyone ' : `@${member.name} `;
    
    const newValue = beforeMention + mention + afterCursor;
    onChange(newValue);
    setShowDropdown(false);
    setMentionQuery('');
    setMentionStart(null);
    
    // Focus back on textarea
    setTimeout(() => {
      if (textareaRef.current) {
        textareaRef.current.focus();
        const newPos = beforeMention.length + mention.length;
        textareaRef.current.setSelectionRange(newPos, newPos);
      }
    }, 0);
  };
  
  const handleKeyDown = (e) => {
    if (!showDropdown || filteredMembers.length === 0) return;
    
    if (e.key === 'ArrowDown') {
      e.preventDefault();
      setHighlightedIndex(i => Math.min(i + 1, filteredMembers.length - 1));
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      setHighlightedIndex(i => Math.max(i - 1, 0));
    } else if (e.key === 'Enter' || e.key === 'Tab') {
      e.preventDefault();
      selectMention(filteredMembers[highlightedIndex]);
    } else if (e.key === 'Escape') {
      setShowDropdown(false);
    }
  };
  
  return (
    <div className="mention-input-container">
      {showDropdown && filteredMembers.length > 0 && (
        <div className="mention-dropdown" style={{ bottom: 'auto', top: '100%', marginTop: '4px', marginBottom: '0' }}>
          {filteredMembers.map((member, idx) => (
            <div
              key={member.id || member.afid || idx}
              className={`mention-dropdown-item ${idx === highlightedIndex ? 'highlighted' : ''}`}
              onClick={() => selectMention(member)}
            >
              {member.isEveryone ? (
                <>
                  <div className="avatar" style={{ background: 'linear-gradient(135deg, #ef4444, #f59e0b)' }}>@</div>
                  <div>
                    <div className="font-semibold text-red-600">@everyone</div>
                    <div className="text-xs text-gray-500">Notify all team members</div>
                  </div>
                </>
              ) : (
                <>
                  {member.profilePhoto ? (
                    <img src={member.profilePhoto} alt="" className="w-8 h-8 rounded-full object-cover" />
                  ) : (
                    <div className="avatar">{member.name?.charAt(0)}</div>
                  )}
                  <div>
                    <div className="font-semibold">{member.name}</div>
                    <div className="text-xs text-gray-500">{member.school || member.role}</div>
                  </div>
                </>
              )}
            </div>
          ))}
        </div>
      )}
      <textarea
        ref={textareaRef}
        value={value}
        onChange={handleInputChange}
        onKeyDown={handleKeyDown}
        placeholder={placeholder}
        className={className}
        rows={rows}
        autoFocus
      />
    </div>
  );
}

// ========================================
// REACTION WITH TOOLTIP COMPONENT
// ========================================
function ReactionButton({ emoji, count, isActive, onClick, reactedBy, allMembers }) {
  const [showTooltip, setShowTooltip] = useState(false);
  
  // Get names of people who reacted - improved lookup
  const getReactorNames = () => {
    if (!reactedBy || reactedBy.length === 0) return '';
    
    const names = reactedBy.map(userId => {
      if (!userId) return 'Someone';
      
      const userIdLower = String(userId).toLowerCase();
      
      // Try multiple matching strategies
      const member = (allMembers || []).find(m => {
        // Direct matches
        if (m.afid && String(m.afid).toLowerCase() === userIdLower) return true;
        if (m.uid && String(m.uid).toLowerCase() === userIdLower) return true;
        if (m.id && String(m.id).toLowerCase() === userIdLower) return true;
        if (m.email && String(m.email).toLowerCase() === userIdLower) return true;
        
        // Partial matches (in case ID is stored differently)
        if (m.afid && userIdLower.includes(String(m.afid).toLowerCase())) return true;
        if (m.email && userIdLower.includes(String(m.email).toLowerCase().split('@')[0])) return true;
        
        // Match by name if userId looks like a name
        if (m.name && String(m.name).toLowerCase() === userIdLower) return true;
        
        return false;
      });
      
      return member?.name || userId.split('@')[0] || 'Someone';
    }).slice(0, 5);
    
    if (reactedBy.length > 5) {
      names.push(`+${reactedBy.length - 5} more`);
    }
    
    return names.join(', ');
  };
  
  const tooltipText = getReactorNames();
  
  return (
    <div 
      className="reaction-btn-wrapper"
      onMouseEnter={() => setShowTooltip(true)}
      onMouseLeave={() => setShowTooltip(false)}
    >
      {showTooltip && tooltipText && (
        <div className="reaction-tooltip">{tooltipText}</div>
      )}
      <button
        onClick={onClick}
        className={`emoji-btn ${isActive ? 'active' : ''}`}
      >
        {emoji} {count || ''}
      </button>
    </div>
  );
}

// ========================================
// LAST ACTIVE BADGE COMPONENT
// ========================================
function LastActiveBadge({ userId }) {
  const [isOnline, setIsOnline] = useState(false);
  const [lastSeen, setLastSeen] = useState('Never');
  
  useEffect(() => {
    if (!userId) return;
    
    // Initial check
    const checkPresence = () => {
      setIsOnline(PresenceSystem.isOnline(userId));
      setLastSeen(PresenceSystem.formatLastSeen(userId));
    };
    
    checkPresence();
    
    // Subscribe to presence updates
    const unsubscribe = PresenceSystem.subscribe(() => {
      checkPresence();
    });
    
    // Also poll every 10 seconds for updates
    const interval = setInterval(checkPresence, 10000);
    
    return () => {
      unsubscribe();
      clearInterval(interval);
    };
  }, [userId]);
  
  return (
    <span className={`last-active-badge ${isOnline ? 'online' : ''}`}>
      <span style={{ width: '6px', height: '6px', borderRadius: '50%', background: isOnline ? '#10b981' : '#9ca3af', display: 'inline-block' }}></span>
      {isOnline ? 'Online' : lastSeen}
    </span>
  );
}

// ========================================
// PROFILE COMPLETION BANNER COMPONENT
// ========================================
function ProfileCompletionBanner({ currentUser, onNavigateToProfile }) {
  const [isDismissed, setIsDismissed] = useState(false);
  const [showDetails, setShowDetails] = useState(false);
  
  // List of roles that don't need profile completion (managers/admins/directors)
  const managerRoles = ['Super Admin', 'Program Head', 'Program Manager', 'Associate Program Manager', 'PM', 'PH', 'APM', 'Admin', 'Director', 'Associate Director', 'Training Department', 'director', 'assoc_director', 'training'];
  
  // Check if current user is a manager/admin
  const isManager = currentUser?.role && managerRoles.some(role => 
    currentUser.role.toLowerCase().includes(role.toLowerCase()) ||
    role.toLowerCase().includes(currentUser.role.toLowerCase())
  );
  
  // Required fields for teacher/manager profile
  const requiredFields = [
    { key: 'name', label: 'Full Name' },
    { key: 'email', label: 'Email Address' },
    { key: 'phone', label: 'Phone Number' },
    { key: 'whatsapp', label: 'WhatsApp Number' },
    { key: 'dob', label: 'Date of Birth' },
    { key: 'dateOfBirth', label: 'Date of Birth' }, // Alternative field name
    { key: 'school', label: 'School/Centre' },
    { key: 'subject', label: 'Subject' },
    { key: 'profilePhoto', label: 'Profile Photo' },
    { key: 'joiningDate', label: 'Joining Date' },
    { key: 'qualification', label: 'Qualification' },
    { key: 'address', label: 'Address' },
    { key: 'emergencyContact', label: 'Emergency Contact' },
    { key: 'bloodGroup', label: 'Blood Group' }
  ];
  
  // Calculate completion
  const calculateCompletion = () => {
    if (!currentUser) return { percentage: 0, filled: [], missing: [] };
    
    const filled = [];
    const missing = [];
    const checkedKeys = new Set(); // Avoid duplicate field counting
    
    requiredFields.forEach(field => {
      // Skip if we already counted this field (e.g., dob vs dateOfBirth)
      if (field.key === 'dateOfBirth' && checkedKeys.has('dob')) return;
      if (field.key === 'dob' && checkedKeys.has('dateOfBirth')) return;
      
      const value = currentUser[field.key];
      const hasValue = value && String(value).trim() !== '' && value !== 'null' && value !== 'undefined';
      
      if (hasValue) {
        filled.push(field);
        checkedKeys.add(field.key);
      } else if (!checkedKeys.has(field.key)) {
        // Only add to missing if alternative field wasn't filled
        if (field.key === 'dob' || field.key === 'dateOfBirth') {
          const altValue = currentUser[field.key === 'dob' ? 'dateOfBirth' : 'dob'];
          if (!altValue || String(altValue).trim() === '') {
            missing.push(field);
          }
        } else {
          missing.push(field);
        }
        checkedKeys.add(field.key);
      }
    });
    
    // Normalize - count dob/dateOfBirth as one field
    const totalFields = 13; // Actual unique fields
    const filledCount = Math.min(filled.length, totalFields);
    const percentage = Math.round((filledCount / totalFields) * 100);
    
    return { percentage, filled, missing };
  };
  
  const { percentage, filled, missing } = calculateCompletion();
  
  // Don't show if 100% complete or dismissed for today
  const dismissKey = `profileBannerDismissed_${currentUser?.afid || currentUser?.uid}_${new Date().toDateString()}`;
  
  useEffect(() => {
    const wasDismissed = localStorage.getItem(dismissKey);
    if (wasDismissed) {
      setIsDismissed(true);
    }
  }, [dismissKey]);
  
  const handleDismiss = () => {
    localStorage.setItem(dismissKey, 'true');
    setIsDismissed(true);
  };
  
  // Don't show if complete or dismissed
  if (percentage >= 100 || isDismissed) return null;
  
  // Don't show profile completion banner for managers/admins
  // They don't have a dedicated profile page - only teachers need to complete profiles
  if (isManager) return null;
  
  // Determine urgency color
  const getUrgencyColor = () => {
    if (percentage < 30) return 'from-red-500 to-red-600';
    if (percentage < 60) return 'from-orange-500 to-amber-500';
    if (percentage < 80) return 'from-yellow-500 to-amber-400';
    return 'from-blue-500 to-indigo-500';
  };
  
  const getProgressColor = () => {
    if (percentage < 30) return 'bg-red-500';
    if (percentage < 60) return 'bg-orange-500';
    if (percentage < 80) return 'bg-yellow-500';
    return 'bg-blue-500';
  };
  
  return (
    <div className={`mb-4 bg-gradient-to-r ${getUrgencyColor()} rounded-2xl p-4 shadow-lg text-white relative overflow-hidden`}>
      {/* Background decoration */}
      <div className="absolute top-0 right-0 w-32 h-32 bg-white opacity-10 rounded-full -mr-16 -mt-16"></div>
      <div className="absolute bottom-0 left-0 w-24 h-24 bg-white opacity-10 rounded-full -ml-12 -mb-12"></div>
      
      {/* Close button */}
      <button 
        onClick={handleDismiss}
        className="absolute top-2 right-2 w-6 h-6 bg-white bg-opacity-20 rounded-full flex items-center justify-center hover:bg-opacity-30 transition-all text-sm"
        title="Dismiss for today"
      >
        ‚úï
      </button>
      
      <div className="relative z-10">
        <div className="flex items-center gap-3 mb-3">
          <div className="text-3xl">
            {percentage < 30 ? '‚ö†Ô∏è' : percentage < 60 ? 'üìù' : percentage < 80 ? 'üìã' : '‚ú®'}
          </div>
          <div className="flex-1">
            <h3 className="font-bold text-lg">Complete Your Profile</h3>
            <p className="text-sm opacity-90">
              Your profile is {percentage}% complete. {missing.length} field{missing.length !== 1 ? 's' : ''} remaining.
            </p>
          </div>
          <div className="text-right">
            <div className="text-3xl font-bold">{percentage}%</div>
          </div>
        </div>
        
        {/* Progress bar */}
        <div className="bg-white bg-opacity-30 rounded-full h-3 mb-3 overflow-hidden">
          <div 
            className={`h-full ${getProgressColor()} rounded-full transition-all duration-500`}
            style={{ width: `${percentage}%` }}
          />
        </div>
        
        {/* Missing fields - collapsible */}
        <div className="flex items-center justify-between">
          <button 
            onClick={() => setShowDetails(!showDetails)}
            className="text-sm bg-white bg-opacity-20 px-3 py-1 rounded-lg hover:bg-opacity-30 transition-all"
          >
            {showDetails ? '‚ñ≤ Hide Details' : '‚ñº Show Missing Fields'}
          </button>
          
          <button 
            onClick={() => onNavigateToProfile && onNavigateToProfile()}
            className="bg-white text-gray-800 px-4 py-2 rounded-xl font-bold hover:bg-opacity-90 transition-all shadow-lg flex items-center gap-2"
          >
            <span>Complete Now</span>
            <span>‚Üí</span>
          </button>
        </div>
        
        {/* Expandable missing fields list */}
        {showDetails && missing.length > 0 && (
          <div className="mt-3 bg-white bg-opacity-20 rounded-xl p-3">
            <p className="text-sm font-semibold mb-2">Missing Information:</p>
            <div className="flex flex-wrap gap-2">
              {missing.map((field, idx) => (
                <span 
                  key={idx}
                  className="bg-white bg-opacity-30 px-2 py-1 rounded-lg text-xs font-medium"
                >
                  {field.label}
                </span>
              ))}
            </div>
          </div>
        )}
      </div>
    </div>
  );
}

// ========================================
// PROFILE COMPLETION CARD (For Dashboard)
// ========================================
function ProfileCompletionCard({ currentUser, onNavigateToProfile }) {
  // List of roles that don't need profile completion (managers/admins/directors)
  const managerRoles = ['Super Admin', 'Program Head', 'Program Manager', 'Associate Program Manager', 'PM', 'PH', 'APM', 'Admin', 'Director', 'Associate Director', 'Training Department', 'director', 'assoc_director', 'training'];
  
  // Check if current user is a manager/admin
  const isManager = currentUser?.role && managerRoles.some(role => 
    currentUser.role.toLowerCase().includes(role.toLowerCase()) ||
    role.toLowerCase().includes(currentUser.role.toLowerCase())
  );
  
  // Don't show profile completion card for managers/admins
  if (isManager) return null;
  
  // Required fields for teacher/manager profile
  const requiredFields = [
    'name', 'email', 'phone', 'whatsapp', 'dob', 'dateOfBirth', 'school', 
    'subject', 'profilePhoto', 'joiningDate', 'qualification', 'address', 
    'emergencyContact', 'bloodGroup'
  ];
  
  // Calculate completion
  const calculateCompletion = () => {
    if (!currentUser) return 0;
    
    let filled = 0;
    const checkedDob = currentUser.dob || currentUser.dateOfBirth;
    
    if (currentUser.name) filled++;
    if (currentUser.email) filled++;
    if (currentUser.phone) filled++;
    if (currentUser.whatsapp) filled++;
    if (checkedDob) filled++;
    if (currentUser.school) filled++;
    if (currentUser.subject) filled++;
    if (currentUser.profilePhoto) filled++;
    if (currentUser.joiningDate) filled++;
    if (currentUser.qualification) filled++;
    if (currentUser.address) filled++;
    if (currentUser.emergencyContact) filled++;
    if (currentUser.bloodGroup) filled++;
    
    return Math.round((filled / 13) * 100);
  };
  
  const percentage = calculateCompletion();
  
  // If complete, show success card
  if (percentage >= 100) {
    return (
      <div className="bg-gradient-to-br from-green-50 to-emerald-100 border-2 border-green-200 rounded-2xl p-4 shadow-lg">
        <div className="flex items-center gap-3">
          <div className="w-12 h-12 bg-green-500 rounded-full flex items-center justify-center text-white text-2xl">
            ‚úì
          </div>
          <div>
            <h3 className="font-bold text-green-800">Profile Complete!</h3>
            <p className="text-sm text-green-600">Your profile is 100% complete</p>
          </div>
        </div>
      </div>
    );
  }
  
  // Determine color based on completion
  const getColor = () => {
    if (percentage < 30) return { bg: 'from-red-50 to-red-100', border: 'border-red-200', text: 'text-red-700', progress: 'bg-red-500' };
    if (percentage < 60) return { bg: 'from-orange-50 to-amber-100', border: 'border-orange-200', text: 'text-orange-700', progress: 'bg-orange-500' };
    if (percentage < 80) return { bg: 'from-yellow-50 to-amber-100', border: 'border-yellow-200', text: 'text-yellow-700', progress: 'bg-yellow-500' };
    return { bg: 'from-blue-50 to-indigo-100', border: 'border-blue-200', text: 'text-blue-700', progress: 'bg-blue-500' };
  };
  
  const colors = getColor();
  
  return (
    <div className={`bg-gradient-to-br ${colors.bg} border-2 ${colors.border} rounded-2xl p-4 shadow-lg cursor-pointer hover:shadow-xl transition-all`}
         onClick={() => onNavigateToProfile && onNavigateToProfile()}>
      <div className="flex items-center justify-between mb-3">
        <div className="flex items-center gap-3">
          <div className={`w-12 h-12 ${colors.progress} rounded-full flex items-center justify-center text-white font-bold`}>
            {percentage}%
          </div>
          <div>
            <h3 className={`font-bold ${colors.text}`}>Profile Completion</h3>
            <p className={`text-sm ${colors.text} opacity-80`}>Click to complete your profile</p>
          </div>
        </div>
        <span className="text-2xl">‚Üí</span>
      </div>
      
      {/* Progress bar */}
      <div className="bg-white rounded-full h-2 overflow-hidden">
        <div 
          className={`h-full ${colors.progress} rounded-full transition-all duration-500`}
          style={{ width: `${percentage}%` }}
        />
      </div>
    </div>
  );
}

function App(){const[currentUser,setCurrentUser]=useState(null);const[isAdmin,setIsAdmin]=useState(false);const[isSuperAdmin,setIsSuperAdmin]=useState(false);const[managerProfile,setManagerProfile]=useState(null);const[activeTab,setActiveTab]=useState('overview');const[loginForm,setLoginForm]=useState({email:'',password:'',studentId:'',loginType:'teacher'});const[loading,setLoading]=useState(true);const[authLoading,setAuthLoading]=useState(false);const[loginProgress,setLoginProgress]=useState('');const[teachers,setTeachers]=useState([]);const[curriculum,setCurriculum]=useState({});const[chapterProgress,setChapterProgress]=useState({});const[students,setStudents]=useState([]);const[managers,setManagers]=useState([]);const[accessibleSchools,setAccessibleSchools]=useState([]);const[academicYearSettings,setAcademicYearSettings]=useState(null);
const[precomputedRankings,setPrecomputedRankings]=useState(null); // ‚úÖ COST FIX: Pre-computed rankings (1 doc instead of hundreds)
const[studentAttendance,setStudentAttendance]=useState([]);
const[teacherAttendance,setTeacherAttendance]=useState([]);
const[leaveAdjustments,setLeaveAdjustments]=useState({});
const[schoolInfo,setSchoolInfo]=useState([]);
const[isSidebarOpen,setIsSidebarOpen]=useState(false);               
const[showConfetti,setShowConfetti]=useState(false);const[celebrationMessage,setCelebrationMessage]=useState('');
const[floatingCelebration,setFloatingCelebration]=useState(null); // Floating birthday/anniversary card

// 2FA State
const[pending2FAUser,setPending2FAUser]=useState(null); // User waiting for 2FA verification
const[show2FAVerify,setShow2FAVerify]=useState(false); // Show 2FA verification modal
const[show2FASetup,setShow2FASetup]=useState(false); // Show 2FA setup modal for new users
const[needs2FASetup,setNeeds2FASetup]=useState(false); // Flag if user needs to set up 2FA

// Login Sound - play when user logs in
const prevUserRef = useRef(null);
useEffect(() => {
  // Play sound when user logs in (currentUser changes from null to a value)
  if (currentUser && !prevUserRef.current && !loading) {
    try {
      const audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();
      
      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);
      
      // Pleasant login sound - two quick ascending tones
      oscillator.frequency.value = 600;
      oscillator.type = 'sine';
      gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.15);
      oscillator.start(audioContext.currentTime);
      oscillator.stop(audioContext.currentTime + 0.15);
      
      // Second higher tone
      setTimeout(() => {
        try {
          const osc2 = audioContext.createOscillator();
          const gain2 = audioContext.createGain();
          osc2.connect(gain2);
          gain2.connect(audioContext.destination);
          osc2.frequency.value = 800;
          osc2.type = 'sine';
          gain2.gain.setValueAtTime(0.2, audioContext.currentTime);
          gain2.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
          osc2.start(audioContext.currentTime);
          osc2.stop(audioContext.currentTime + 0.2);
        } catch(e) {}
      }, 100);
      
      console.log('üîî Login sound played');
    } catch(e) {
      console.log('Could not play login sound:', e);
    }
  }
  prevUserRef.current = currentUser;
}, [currentUser, loading]);

// Check for team birthdays/anniversaries and show floating card
useEffect(() => {
  if (!currentUser || loading) return;
  
  // Check if user has already dismissed today's floating card
  const dismissedKey = 'floatingCelebrationDismissed_' + new Date().toDateString();
  if (localStorage.getItem(dismissedKey)) return;
  
  const checkTeamCelebrations = async () => {
    try {
      const today = new Date();
      const todayMonth = today.getMonth();
      const todayDate = today.getDate();
      
      // Load all team members
      const [teachersSnap, managersSnap, apcsSnap] = await Promise.all([
        db.collection('teachers').get(),
        db.collection('managers').where('status', '==', 'active').get(),
        db.collection('apcs').get()
      ]);
      
      const allMembers = [
        ...teachersSnap.docs.map(d => ({ id: d.id, ...d.data(), type: 'teacher' })),
        ...managersSnap.docs.map(d => ({ id: d.id, ...d.data(), type: 'manager' })),
        ...apcsSnap.docs.map(d => ({ id: d.id, ...d.data(), type: 'apc' }))
      ].filter(m => m.name && m.name.toLowerCase() !== 'vacant' && !m.isArchived);
      
      // Find today's birthdays (excluding current user)
      const todayBirthdays = allMembers.filter(m => {
        if (m.afid === currentUser.afid || m.id === currentUser.afid) return false;
        const dobField = m.dateOfBirth || m.dob;
        if (!dobField) return false;
        const dob = new Date(dobField);
        return dob.getMonth() === todayMonth && dob.getDate() === todayDate;
      });
      
      // Find today's work anniversaries (excluding current user)
      const todayAnniversaries = allMembers.filter(m => {
        if (m.afid === currentUser.afid || m.id === currentUser.afid) return false;
        if (!m.joiningDate) return false;
        const j = new Date(m.joiningDate);
        if (j.getFullYear() >= today.getFullYear()) return false;
        return j.getMonth() === todayMonth && j.getDate() === todayDate;
      }).map(m => ({
        ...m,
        years: today.getFullYear() - new Date(m.joiningDate).getFullYear()
      }));
      
      // Show floating card for first birthday or anniversary found
      if (todayBirthdays.length > 0) {
        const person = todayBirthdays[0];
        setFloatingCelebration({
          type: 'birthday',
          person: person,
          total: todayBirthdays.length
        });
      } else if (todayAnniversaries.length > 0) {
        const person = todayAnniversaries[0];
        setFloatingCelebration({
          type: 'anniversary',
          person: person,
          years: person.years,
          total: todayAnniversaries.length
        });
      }
    } catch (e) {
      console.log('Could not check team celebrations:', e);
    }
  };
  
  // Delay check to avoid blocking initial load
  const timer = setTimeout(checkTeamCelebrations, 2000);
  return () => clearTimeout(timer);
}, [currentUser, loading]);

// Helper function to get accessible schools for a manager (supports 4-level hierarchy)
const getAccessibleSchools = useCallback((managerData, allManagers) => {
  if (!managerData) {
    console.warn('‚ö†Ô∏è getAccessibleSchools: No manager data provided');
    return [];
  }
  
  console.log('üìä Calculating accessible schools for:', managerData.name, 'Role:', managerData.role);
  console.log('üìä Manager directSchools:', managerData.directSchools);
  
  // ‚úÖ FIX: Directors and Associate Directors have access to ALL schools
  if (managerData.viewAllSchools || managerData.role === 'director' || managerData.role === 'assoc_director' || managerData.role === 'training') {
    console.log('üìä Manager has viewAllSchools access, returning ALL schools:', SCHOOLS.length);
    return [...SCHOOLS];
  }
  
  let schools = [...(managerData.directSchools || [])];
  console.log('üìä Starting with directSchools:', schools.length, schools);
  
  // Recursive function to get all reportees at all levels
  const getAllReportees = (managerId) => {
    const directReportees = allManagers.filter(m => m.reportsTo === managerId && m.status === 'active');
    let allReportees = [...directReportees];
    directReportees.forEach(reportee => {
      allReportees = [...allReportees, ...getAllReportees(reportee.id)];
    });
    return allReportees;
  };
  
  // If not APM, include schools from all reportees (recursive)
  if (managerData.role !== MANAGER_ROLES.APM) {
    const reportees = getAllReportees(managerData.id);
    console.log('üìä Found reportees:', reportees.length, reportees.map(r => r.name));
    reportees.forEach(reportee => {
      schools = [...schools, ...(reportee.directSchools || [])];
    });
  }
  
  // Remove duplicates
  const uniqueSchools = [...new Set(schools)];
  console.log('üìä Final accessible schools:', uniqueSchools.length, uniqueSchools);
  
  // If no schools found, log warning (they'll see empty data - admin needs to assign schools)
  if (uniqueSchools.length === 0) {
    console.warn('‚ö†Ô∏è No schools found for this manager. Please contact admin to assign schools.');
  }
  
  return uniqueSchools;
}, []);

useEffect(()=>{const unsubscribe=auth.onAuthStateChanged(async(user)=>{if(user){
  // ‚úÖ CHECK FOR STUDENT FIRST (anonymous auth users)
  // Students use anonymous auth, so check localStorage/IndexedDB for student session
  if (user.isAnonymous) {
    // ‚úÖ IMPROVED: Try multiple storage sources for PWA/APK persistence
    let studentSession = typeof window.safeStorage !== 'undefined' 
      ? window.safeStorage.getItem('studentSession')
      : (function() { try { return localStorage.getItem('studentSession'); } catch(e) { return null; } })();
    
    // ‚úÖ NEW: If not in localStorage, try IndexedDB (for PWA/APK)
    if (!studentSession && window.persistentStorage) {
      try {
        studentSession = await window.persistentStorage.getItem('studentSession');
        // Restore to localStorage if found in IndexedDB
        if (studentSession) {
          console.log('‚úÖ Restored student session from IndexedDB');
          try { localStorage.setItem('studentSession', studentSession); } catch(e) {}
        }
      } catch(e) {}
    }
    
    if (studentSession) {
      try {
        const studentData = JSON.parse(studentSession);
        console.log('‚úÖ Student detected via anonymous auth:', studentData.name);
        setCurrentUser(studentData);
        setIsAdmin(false);
        setActiveTab('dashboard');
        setLoading(false);
        setAuthLoading(false);
        setLoginProgress('');
        return; // Exit early - don't check for teacher/manager
      } catch(e) {
        console.error('Failed to parse student session:', e);
        if (typeof window.safeStorage !== 'undefined') {
          window.safeStorage.removeItem('studentSession');
        } else {
          try { localStorage.removeItem('studentSession'); } catch(e) {}
        }
        if (window.persistentStorage) {
          window.persistentStorage.removeItem('studentSession').catch(() => {});
        }
      }
    }
    // No student session but anonymous user - sign out
    console.log('Anonymous user without student session - signing out');
    await auth.signOut();
    setLoading(false);
    return;
  }
  
  // Check for Super Admin first
  if(user.email==='admin@avantifellows.org'){
    // Check 2FA for Super Admin
    const twoFADoc = await db.collection('twoFactorAuth').doc('SUPER_ADMIN').get();
    if (twoFADoc.exists && twoFADoc.data().enabled) {
      // 2FA is enabled - check if device is trusted
      const deviceTrusted = await isDeviceTrusted('SUPER_ADMIN');
      if (deviceTrusted) {
        // Device is trusted, skip 2FA verification
        console.log('‚úÖ Trusted device - skipping 2FA for Super Admin');
        setIsSuperAdmin(true);
        setIsAdmin(true);
        const allManagersSnap = await db.collection('managers').where('status','==','active').get();
        const allManagers = allManagersSnap.docs.map(d=>({...d.data(),id:d.id}));
        setManagers(allManagers);
        const aySnap = await db.collection('system').doc('academicYear').get();
        if(aySnap.exists) setAcademicYearSettings(aySnap.data());
        setAccessibleSchools([...SCHOOLS]);
        setCurrentUser({name:'Super Administrator',email:user.email,afid:'SUPER_ADMIN',school:'Admin',role:MANAGER_ROLES.SUPER_ADMIN});
        setActiveTab('managers');
        setLoading(false);
        setAuthLoading(false);
        setLoginProgress('');
        return;
      }
      // Device not trusted, need to verify 2FA
      setPending2FAUser({
        name: 'Super Administrator',
        email: user.email,
        afid: 'SUPER_ADMIN',
        docId: 'SUPER_ADMIN',
        school: 'Admin',
        role: MANAGER_ROLES.SUPER_ADMIN,
        userType: 'superadmin'
      });
      setShow2FAVerify(true);
      setLoading(false);
      setAuthLoading(false);
      setLoginProgress('');
      return;
    } else {
      // 2FA not set up yet - require setup
      setPending2FAUser({
        name: 'Super Administrator',
        email: user.email,
        afid: 'SUPER_ADMIN',
        docId: 'SUPER_ADMIN',
        school: 'Admin',
        role: MANAGER_ROLES.SUPER_ADMIN,
        userType: 'superadmin'
      });
      setShow2FASetup(true);
      setNeeds2FASetup(true);
      setLoading(false);
      setAuthLoading(false);
      setLoginProgress('');
      return;
    }
  }else{
  // Check if user is a manager/APH/PM/APM
  const managerSnapshot=await db.collection('managers').where('email','==',user.email).where('status','==','active').limit(1).get();
  if(!managerSnapshot.empty){
    const managerData={...managerSnapshot.docs[0].data(),id:managerSnapshot.docs[0].id,docId:managerSnapshot.docs[0].id};
    
    // Check 2FA for manager
    const twoFADoc = await db.collection('twoFactorAuth').doc(managerData.id).get();
    if (twoFADoc.exists && twoFADoc.data().enabled) {
      // 2FA is enabled - check if device is trusted
      const deviceTrusted = await isDeviceTrusted(managerData.id);
      if (deviceTrusted) {
        // Device is trusted, skip 2FA verification
        console.log('‚úÖ Trusted device - skipping 2FA for manager:', managerData.name);
        setManagerProfile(managerData);
        const allManagersSnap = await db.collection('managers').where('status','==','active').get();
        const allManagers = allManagersSnap.docs.map(d=>({...d.data(),id:d.id}));
        setManagers(allManagers);
        const aySnap = await db.collection('system').doc('academicYear').get();
        if(aySnap.exists) setAcademicYearSettings(aySnap.data());
        const schools = getAccessibleSchools(managerData, allManagers);
        setAccessibleSchools(schools);
        setIsAdmin(true);
        setIsSuperAdmin(false);
        setCurrentUser({
          name: managerData.name,
          email: user.email,
          afid: managerData.id,
          docId: managerData.docId,
          school: schools[0] || 'Admin',
          role: managerData.role,
          directSchools: managerData.directSchools || [],
          userType: 'manager',
          isAdmin: true
        });
        // ‚úÖ NEW: Cache session for faster future logins
        const sessionToCache = {
          name: managerData.name,
          email: user.email,
          afid: managerData.id,
          id: managerData.id,
          docId: managerData.docId,
          school: schools[0] || 'Admin',
          role: managerData.role,
          directSchools: managerData.directSchools || [],
          userType: 'manager',
          isAdmin: true,
          loginTime: Date.now()
        };
        try {
          window.safeStorage?.setItem('teacherSession', JSON.stringify(sessionToCache));
          window.persistentStorage?.setItem('teacherSession', JSON.stringify(sessionToCache)).catch(() => {});
        } catch(e) {}
        setActiveTab('analytics');
        setLoading(false);
        setAuthLoading(false);
        setLoginProgress('');
        return;
      }
      // Device not trusted, need to verify 2FA
      setPending2FAUser({
        ...managerData,
        userType: 'manager'
      });
      setShow2FAVerify(true);
      setLoading(false);
      setAuthLoading(false);
      setLoginProgress('');
      return;
    } else {
      // 2FA not set up yet - require setup for managers
      setPending2FAUser({
        ...managerData,
        userType: 'manager'
      });
      setShow2FASetup(true);
      setNeeds2FASetup(true);
      setLoading(false);
      setAuthLoading(false);
      setLoginProgress('');
      return;
    }
  } else {
    // Check if teacher (includes APCs since they're in the teachers collection with role='apc')
    const teacherSnapshot=await db.collection('teachers').where('email','==',user.email).limit(1).get();
    if(!teacherSnapshot.empty){
      const rawTeacherData=teacherSnapshot.docs[0].data();
      // Set userType based on role field
      const userType = rawTeacherData.role === 'apc' ? 'apc' : 'teacher';
      const teacherData={...rawTeacherData, docId:teacherSnapshot.docs[0].id, userType: userType};
      
      // Check 2FA for teacher/APC
      const twoFADoc = await db.collection('twoFactorAuth').doc(teacherData.afid).get();
      if (twoFADoc.exists && twoFADoc.data().enabled) {
        // 2FA is enabled - check if device is trusted
        const deviceTrusted = await isDeviceTrusted(teacherData.afid);
        if (deviceTrusted) {
          // Device is trusted, skip 2FA verification
          console.log('‚úÖ Trusted device - skipping 2FA for ' + userType + ':', teacherData.name);
          // ‚úÖ NEW: Cache session for faster future logins
          const sessionToCache = {...teacherData, loginTime: Date.now()};
          try {
            window.safeStorage?.setItem('teacherSession', JSON.stringify(sessionToCache));
            window.persistentStorage?.setItem('teacherSession', JSON.stringify(sessionToCache)).catch(() => {});
          } catch(e) {}
          setCurrentUser(teacherData);
          setIsAdmin(false);
          setActiveTab('overview');
          // Birthday/Anniversary celebrations (only for teachers, not APCs)
          if(userType === 'teacher' && teacherData.dob){
            const d = new Date(teacherData.dob);
            const now = new Date();
            if(d.getMonth() === now.getMonth() && d.getDate() === now.getDate()){
              setShowConfetti(true);
              setCelebrationMessage(`üéÇ Happy Birthday, ${teacherData.name}!`);
              setTimeout(() => {setShowConfetti(false);setCelebrationMessage('')}, 8000);
            }
          }
          if(userType === 'teacher' && teacherData.joiningDate){
            const j = new Date(teacherData.joiningDate);
            const now = new Date();
            if(j.getMonth() === now.getMonth() && j.getDate() === now.getDate() && j.getFullYear() < now.getFullYear()){
              const years = now.getFullYear() - j.getFullYear();
              setShowConfetti(true);
              setCelebrationMessage(`üéâ Happy ${years} Year Work Anniversary, ${teacherData.name}!`);
              setTimeout(() => {setShowConfetti(false);setCelebrationMessage('')}, 8000);
            }
          }
          setLoading(false);
          setAuthLoading(false);
          setLoginProgress('');
          return;
        }
        // Device not trusted, need to verify 2FA
        setPending2FAUser({
          ...teacherData,
          userType: userType
        });
        setShow2FAVerify(true);
        setLoading(false);
        setAuthLoading(false);
        setLoginProgress('');
        return;
      } else {
        // 2FA not set up yet - require setup for teachers/APCs
        setPending2FAUser({
          ...teacherData,
          userType: userType
        });
        setShow2FASetup(true);
        setNeeds2FASetup(true);
        setLoading(false);
        setAuthLoading(false);
        setLoginProgress('');
        return;
      }
    }else{alert('User profile not found. Please contact admin.');await auth.signOut();setAuthLoading(false);setLoginProgress('')}
  }
}}else{
  // Check for student session in localStorage
  // ‚úÖ iOS FIX: Use safe storage wrapper
  const studentSession = typeof window.safeStorage !== 'undefined' 
    ? window.safeStorage.getItem('studentSession')
    : (function() { try { return localStorage.getItem('studentSession'); } catch(e) { return null; } })();
  if(studentSession){
    try{
      const studentData=JSON.parse(studentSession);
      console.log('‚úÖ Restored student session:',studentData);
      // ‚úÖ Sign in anonymously to restore Firebase Auth for students
      if (!auth.currentUser) {
        await auth.signInAnonymously();
        console.log('‚úÖ Anonymous auth restored for student');
      }
      setCurrentUser(studentData);
      setIsAdmin(false);
      setActiveTab('dashboard');
    }catch(e){
      console.error('Failed to restore student session:',e);
      if (typeof window.safeStorage !== 'undefined') {
        window.safeStorage.removeItem('studentSession');
      } else {
        try { localStorage.removeItem('studentSession'); } catch(e) {}
      }
    }
  }else{
    setCurrentUser(null);
    setIsAdmin(false);
  }
}
setLoading(false)});return()=>unsubscribe()},[getAccessibleSchools]);

// ‚úÖ PERFORMANCE FIX: Hide instant HTML loader once React takes over
useEffect(() => {
  // Small delay to ensure smooth transition
  const timer = setTimeout(() => {
    if (typeof window.hideInstantLoader === 'function') {
      window.hideInstantLoader();
    }
  }, 100);
  return () => clearTimeout(timer);
}, []);

// ‚úÖ CRITICAL FIX: Safety timeout - Allow 45 seconds for data loading in remote JNV areas
// This is longer because we now use 20-30 second timeouts for critical data
useEffect(() => {
  if (loading) {
    const safetyTimeout = setTimeout(() => {
      console.warn('[Safety] Force stopping infinite loading after 45 seconds');
      setLoading(false);
      setAuthLoading(false);
      setLoginProgress('');
      // Show cached data if available
      if (window.DataCacheManager) {
        console.log('üì¶ Showing cached data after timeout');
      }
    }, 45000); // ‚úÖ Increased from 12s to 45s to allow for slow networks
    return () => clearTimeout(safetyTimeout);
  }
}, [loading]);

  // ‚úÖ OPTIMIZED: Fetch data once on load, refresh only when needed
  // ‚úÖ PERFORMANCE FIX: Split into critical and non-critical data loads
useEffect(() => {
  // ‚úÖ NEW: Try to load cached data immediately for instant display
  const loadCachedData = () => {
    try {
      const cached = localStorage.getItem('cachedAppData');
      if (cached) {
        const data = JSON.parse(cached);
        // Only use cache if less than 5 minutes old
        if (data.timestamp && (Date.now() - data.timestamp) < 5 * 60 * 1000) {
          console.log('‚ö° Loading cached data for instant display');
          if (data.teachers) setTeachers(data.teachers);
          if (data.curriculum) setCurriculum(data.curriculum);
          if (data.chapterProgress) setChapterProgress(data.chapterProgress);
          if (data.managers) setManagers(data.managers);
          return true;
        }
      }
    } catch(e) { console.log('Cache load failed:', e); }
    return false;
  };
  
  const fetchData = async () => {
    try {
      // ‚úÖ PERFORMANCE: Load cached data first for instant UI
      const hasCachedData = loadCachedData();
      
      // ‚úÖ COST FIX: Determine if user needs ALL data or just their school's data
      // Admins need all data, teachers only need their school
      const userSchool = currentUser?.school;
      const userIsAdmin = currentUser && (
        currentUser.email === 'admin@avantifellows.org' ||
        currentUser.role === 'super_admin' ||
        currentUser.role === 'program_head' ||
        currentUser.role === 'program_manager' ||
        currentUser.role === 'associate_program_manager' ||
        currentUser.role === 'aph' ||
        currentUser.role === 'pm' ||
        currentUser.role === 'apm' ||
        // ‚úÖ FIX: Include Directors/Training - they need ALL data access (view-only)
        currentUser.role === 'director' ||
        currentUser.role === 'assoc_director' ||
        currentUser.role === 'training'
      );
      
      const thirtyDaysAgo = new Date(Date.now() - 30*24*60*60*1000).toISOString().split('T')[0];
      
      // ‚úÖ PERFORMANCE FIX: Fetch CRITICAL data first (teachers, curriculum, managers)
      // These are needed to display the main UI
      console.log('üìä Fetching critical data...');
      const criticalStartTime = Date.now();
      
      // ‚úÖ FIX: Helper function to handle index errors gracefully
      const fetchWithIndexFallback = async (optimizedQuery, fallbackQuery, filterFn, queryName) => {
        try {
          return await optimizedQuery;
        } catch (e) {
          if (e.message && e.message.includes('index')) {
            console.warn(`‚ö†Ô∏è ${queryName}: Index not ready, using fallback query`);
            const fallbackSnap = await fallbackQuery;
            // Filter client-side
            return {
              docs: fallbackSnap.docs.filter(doc => filterFn(doc.data()))
            };
          }
          throw e;
        }
      };
      
      // ========================================
      // ‚úÖ CRITICAL FIX: Enhanced data loading with Cache-First strategy
      // Solves "Dashboard showing 0" issue in low-connectivity JNV areas
      // ========================================
      
      // Store user school globally for cache key generation
      window._currentUserSchool = userSchool || 'admin';
      
      // ‚úÖ STEP 1: Load from cache IMMEDIATELY (shows data instantly)
      console.log('üì¶ Loading cached data first for instant display...');
      let usedCache = false;
      
      try {
        // Try to load cached data immediately
        const cachedTeachers = await window.DataCacheManager.loadFromCache('teachers_' + (userSchool || 'all'));
        const cachedCurriculum = await window.DataCacheManager.loadFromCache('curriculum');
        const cachedStudentAtt = await window.DataCacheManager.loadFromCache('studentAttendance_' + (userSchool || 'all'));
        const cachedTeacherAtt = await window.DataCacheManager.loadFromCache('teacherAttendance_' + (userSchool || 'all'));
        const cachedProgress = await window.DataCacheManager.loadFromCache('chapterProgress');
        
        if (cachedTeachers?.docs?.length || cachedCurriculum?.docs?.length || 
            cachedStudentAtt?.docs?.length || cachedTeacherAtt?.docs?.length) {
          console.log('‚úÖ Found cached data - displaying immediately');
          usedCache = true;
          
          // Set cached data immediately (users see data instantly!)
          if (cachedTeachers?.docs) {
            const teachersData = cachedTeachers.docs.map(d => ({ ...d.data, docId: d.id }));
            setTeachers(teachersData);
          }
          if (cachedCurriculum?.docs) {
            const currMap = {};
            cachedCurriculum.docs.forEach(d => { currMap[d.id] = d.data; });
            setCurriculum(currMap);
          }
          if (cachedStudentAtt?.docs) {
            setStudentAttendance(cachedStudentAtt.docs.map(d => ({ ...d.data, docId: d.id })));
          }
          if (cachedTeacherAtt?.docs) {
            setTeacherAttendance(cachedTeacherAtt.docs.map(d => ({ ...d.data, docId: d.id })));
          }
          if (cachedProgress?.docs) {
            const progressMap = {};
            cachedProgress.docs.forEach(d => { progressMap[d.id] = d.data; });
            setChapterProgress(progressMap);
          }
        }
      } catch(cacheError) {
        console.log('Cache load skipped:', cacheError.message);
      }
      
      // ‚úÖ Enhanced timeoutPromise with longer timeouts for remote areas
      const timeoutPromise = (promise, ms = 20000, fallback = { docs: [] }) => {
        return Promise.race([
          promise,
          new Promise((_, reject) => setTimeout(() => {
            console.warn('‚è±Ô∏è Firebase query timeout after', ms, 'ms - will use cache');
            reject(new Error('timeout'));
          }, ms))
        ]).catch(e => {
          console.warn('Query failed:', e.message, '- checking cache fallback');
          return fallback;
        });
      };
      
      // ‚úÖ STAGE 1: Critical data (needed for UI to work)
      if (window._logLoadTime) window._logLoadTime('Starting critical data fetch');
      
      let teachersQuery;
      if (userIsAdmin || !userSchool) {
        teachersQuery = db.collection('teachers').get();
      } else {
        teachersQuery = db.collection('teachers').where('school', '==', userSchool).get();
      }
      
      // ‚úÖ INCREASED TIMEOUTS: 20 seconds for critical, 30 seconds for secondary
      const [teachersSnap, curriculumSnap, managersSnap, aySnap] = await Promise.all([
        timeoutPromise(teachersQuery, 20000),
        timeoutPromise(db.collection('curriculum').get(), 20000),
        timeoutPromise(db.collection('managers').where('status','==','active').get(), 15000),
        timeoutPromise(db.collection('system').doc('academicYear').get(), 10000, { exists: false })
      ]);
      
      if (window._logLoadTime) window._logLoadTime('Critical data loaded');
      console.log('‚úÖ Critical data loaded in', Date.now() - criticalStartTime, 'ms');
      
      // Process and set critical data immediately
      const teachersData = teachersSnap.docs?.map(d => ({ ...d.data(), docId: d.id })) || [];
      if (teachersData.length > 0 || !usedCache) {
        setTeachers(teachersData);
        // Save to cache for next time
        window.DataCacheManager.saveToCache('teachers_' + (userSchool || 'all'), {
          docs: teachersSnap.docs?.map(d => ({ id: d.id, data: d.data() })) || []
        });
      }
      
      const currMap = {};
      curriculumSnap.docs?.forEach(doc => { currMap[doc.id] = doc.data(); });
      if (Object.keys(currMap).length > 0 || !usedCache) {
        setCurriculum(currMap);
        window.DataCacheManager.saveToCache('curriculum', {
          docs: curriculumSnap.docs?.map(d => ({ id: d.id, data: d.data() })) || []
        });
      }
      
      const managersData = managersSnap.docs?.map(d => ({ ...d.data(), id: d.id })) || [];
      setManagers(managersData);
      
      if (aySnap.exists) setAcademicYearSettings(aySnap.data());
      
      // ‚úÖ Cache critical data for faster next load
      try {
        localStorage.setItem('cachedAppData', JSON.stringify({
          teachers: teachersData.slice(0, 50), // Limit cache size
          curriculum: currMap,
          managers: managersData,
          timestamp: Date.now()
        }));
      } catch(e) { console.log('Cache save failed:', e); }
      
      // ‚úÖ STAGE 2: Secondary data (load in background)
      console.log('üìä Fetching secondary data...');
      
      let progressQuery, studentAttQuery, teacherAttQuery;
      
      if (userIsAdmin || !userSchool) {
        progressQuery = db.collection('chapterProgress').get();
        studentAttQuery = db.collection('studentAttendance')
          .where('date', '>=', thirtyDaysAgo)
          .get();
        teacherAttQuery = db.collection('teacherAttendance')
          .where('date', '>=', thirtyDaysAgo)
          .get();
      } else {
        progressQuery = db.collection('chapterProgress').get();
        studentAttQuery = fetchWithIndexFallback(
          db.collection('studentAttendance')
            .where('school', '==', userSchool)
            .where('date', '>=', thirtyDaysAgo)
            .get(),
          db.collection('studentAttendance')
            .where('date', '>=', thirtyDaysAgo)
            .get(),
          (data) => data.school === userSchool,
          'studentAttendance'
        );
        teacherAttQuery = fetchWithIndexFallback(
          db.collection('teacherAttendance')
            .where('school', '==', userSchool)
            .where('date', '>=', thirtyDaysAgo)
            .get(),
          db.collection('teacherAttendance')
            .where('date', '>=', thirtyDaysAgo)
            .get(),
          (data) => data.school === userSchool,
          'teacherAttendance'
        );
      }
      
      // ‚úÖ CRITICAL FIX: 30 second timeouts for attendance data (prevents "showing 0" issue)
      const [progressSnap, studentAttSnap, teacherAttSnap, schoolInfoSnap, leaveAdjSnap, schoolsSnap, rankingsSnap] = await Promise.all([
        timeoutPromise(progressQuery, 25000),
        timeoutPromise(studentAttQuery, 30000), // ‚úÖ LONGER: Attendance is critical
        timeoutPromise(teacherAttQuery, 30000), // ‚úÖ LONGER: Attendance is critical
        timeoutPromise(db.collection('schoolInfo').get(), 20000),
        timeoutPromise(db.collection('leaveAdjustments').get(), 15000),
        timeoutPromise(db.collection('schoolsList').get(), 15000),
        timeoutPromise(db.collection('system').doc('schoolRankings').get(), 10000, { exists: false })
      ]);
      
      if (window._logLoadTime) window._logLoadTime('Secondary data loaded');

      // ‚úÖ COST FIX: Process pre-computed rankings first
      if (rankingsSnap.exists) {
        setPrecomputedRankings(rankingsSnap.data());
        console.log('‚úÖ Loaded pre-computed rankings');
      } else {
        console.log('‚ö†Ô∏è No pre-computed rankings found - computing now...');
      }

      // Process chapter progress - ALL schools needed for rankings
      // ‚úÖ FIX: Don't filter - rankings need all schools' data to show correctly
      const progressMap = {};
      (progressSnap.docs || []).forEach(d => {
        progressMap[d.id] = d.data();
      });
      setChapterProgress(progressMap);

      // ‚úÖ FIXED: Fetch students based on user type
      // For admins: fetch ALL students (they need to see everything)
      // For teachers: fetch only their school's students (cost savings)
      let studentsData = [];
      
      if (currentUser && currentUser.userType !== 'student') {
        if (userIsAdmin) {
          // ‚úÖ ADMIN: Fetch ALL students (they need full visibility)
          console.log('üìä Admin detected - fetching ALL students');
          const allStudentsSnap = await db.collection('students').get();
          studentsData = allStudentsSnap.docs.map(d => {
            const data = d.data();
            let studentId = data.id;
            if (!studentId) {
              const parts = d.id.split('_');
              studentId = parts[parts.length - 1];
            }
            return { ...data, id: studentId, docId: d.id };
          });
          console.log('‚úÖ Admin loaded ALL', studentsData.length, 'students');
        } else {
          // ‚úÖ TEACHER: Fetch only their school's students (cost savings)
          const teacherSchool = currentUser.school;
          console.log('üìä Teacher detected - fetching students for:', teacherSchool);
          
          try {
            // Try optimized query first
            const schoolStudentsSnap = await db.collection('students')
              .where('school', '==', teacherSchool)
              .get();
            studentsData = schoolStudentsSnap.docs.map(d => {
              const data = d.data();
              let studentId = data.id;
              if (!studentId) {
                const parts = d.id.split('_');
                studentId = parts[parts.length - 1];
              }
              return { ...data, id: studentId, docId: d.id };
            });
            console.log('‚úÖ Teacher loaded', studentsData.length, 'students for', teacherSchool);
            
            // ‚úÖ FIX: If no students found, try fetching all and filtering client-side
            // This handles case-sensitivity and other data inconsistencies
            if (studentsData.length === 0) {
              console.log('‚ö†Ô∏è No students found with exact match, trying case-insensitive search...');
              const allStudentsSnap = await db.collection('students').get();
              const teacherSchoolLower = (teacherSchool || '').toString().trim().toLowerCase();
              studentsData = allStudentsSnap.docs
                .filter(d => {
                  const studentSchool = (d.data().school || '').toString().trim().toLowerCase();
                  return studentSchool === teacherSchoolLower;
                })
                .map(d => {
                  const data = d.data();
                  let studentId = data.id;
                  if (!studentId) {
                    const parts = d.id.split('_');
                    studentId = parts[parts.length - 1];
                  }
                  return { ...data, id: studentId, docId: d.id };
                });
              console.log('‚úÖ Case-insensitive search found', studentsData.length, 'students');
              
              // Log school name mismatch for debugging
              if (studentsData.length > 0 && allStudentsSnap.docs.length > 0) {
                const sampleSchools = Array.from(new Set(allStudentsSnap.docs.map(d => d.data().school))).slice(0, 5);
                console.log('üìã Sample school names in database:', sampleSchools);
                console.log('üìã Teacher school name:', teacherSchool);
              }
            }
          } catch (e) {
            console.error('‚ùå Error fetching students:', e);
            // Fallback: fetch all and filter
            console.log('‚ö†Ô∏è Fallback: Fetching all students and filtering...');
            const allStudentsSnap = await db.collection('students').get();
            const teacherSchoolLower = (teacherSchool || '').toString().trim().toLowerCase();
            studentsData = allStudentsSnap.docs
              .filter(d => {
                const studentSchool = (d.data().school || '').toString().trim().toLowerCase();
                return studentSchool === teacherSchoolLower;
              })
              .map(d => {
                const data = d.data();
                let studentId = data.id;
                if (!studentId) {
                  const parts = d.id.split('_');
                  studentId = parts[parts.length - 1];
                }
                return { ...data, id: studentId, docId: d.id };
              });
            console.log('‚úÖ Fallback loaded', studentsData.length, 'students');
          }
        }
      }
      setStudents(studentsData);

      // ‚úÖ CRITICAL FIX: Process attendance with caching to prevent "showing 0" issue
      const studentAttData = (studentAttSnap.docs || []).map(d => ({ ...d.data(), docId: d.id }));
      const teacherAttData = (teacherAttSnap.docs || []).map(d => ({ ...d.data(), docId: d.id }));
      
      // Only update if we got fresh data (prevents overwriting cache with empty array on timeout)
      if (studentAttData.length > 0 || !usedCache) {
        setStudentAttendance(studentAttData);
        // Save to cache for next time
        window.DataCacheManager.saveToCache('studentAttendance_' + (userSchool || 'all'), {
          docs: (studentAttSnap.docs || []).map(d => ({ id: d.id, data: d.data() }))
        });
        console.log('‚úÖ Student attendance loaded:', studentAttData.length, 'records');
      } else {
        console.log('‚ö†Ô∏è Student attendance query returned empty - keeping cached data');
      }
      
      if (teacherAttData.length > 0 || !usedCache) {
        setTeacherAttendance(teacherAttData);
        // Save to cache for next time
        window.DataCacheManager.saveToCache('teacherAttendance_' + (userSchool || 'all'), {
          docs: (teacherAttSnap.docs || []).map(d => ({ id: d.id, data: d.data() }))
        });
        console.log('‚úÖ Teacher attendance loaded:', teacherAttData.length, 'records');
      } else {
        console.log('‚ö†Ô∏è Teacher attendance query returned empty - keeping cached data');
      }
      
      // ‚úÖ Save chapter progress to cache
      const progressData = (progressSnap.docs || []).map(d => ({ id: d.id, data: d.data() }));
      if (progressData.length > 0) {
        window.DataCacheManager.saveToCache('chapterProgress', { docs: progressData });
      }
      
      // Process school info - ‚úÖ FIX: Add debugging and null safety
      const schoolInfoData = (schoolInfoSnap.docs || []).map(d => ({ ...d.data(), docId: d.id }));
      console.log('üìä School Info loaded:', schoolInfoData.length, 'records');
      if (schoolInfoData.length > 0) {
        console.log('üìä Sample school info schools:', schoolInfoData.slice(0, 3).map(s => s.school));
      }
      setSchoolInfo(schoolInfoData);
      
      // Process leave adjustments (keyed by teacher AFID)
      const adjMap = {};
      (leaveAdjSnap.docs || []).forEach(d => { adjMap[d.id] = d.data() });
      setLeaveAdjustments(adjMap);
      
      // Note: Managers already set in critical data load above
      
      // Process dynamic schools list - ‚úÖ FIX: Add null safety
      if (schoolsSnap && schoolsSnap.docs && schoolsSnap.docs.length > 0) {
        const schoolsData = schoolsSnap.docs.map(d => d.data().name).filter(Boolean);
        if (schoolsData.length > 0) {
          SCHOOLS = schoolsData; // Update global SCHOOLS array
        }
      }
      
      // Note: Academic year settings already set in critical data load above
      
      console.log('‚úÖ All data loaded successfully');

    } catch (e) {
      console.error('Data fetch error:', e);
      // ‚úÖ FIX: Don't fail silently - users should see cached data if available
    }
  };

  fetchData();

  // ‚úÖ COST FIX: Refresh data every 15 minutes instead of 5 minutes (saves ~‚Çπ8,000/month)
  // Data will still update when users make changes via individual operations
  const interval = setInterval(fetchData, 15 * 60 * 1000);
  return () => clearInterval(interval);
}, [currentUser]); // Re-run when user changes to fetch correct school's students

// ‚úÖ COST FIX: Initialize rankings if they don't exist (one-time setup)
useEffect(() => {
  if (currentUser && !loading && precomputedRankings === null) {
    // Check if we're an admin - only admins should trigger the initial computation
    const isAdmin = currentUser.email === 'admin@avantifellows.org' ||
      currentUser.role === 'super_admin' || currentUser.role === 'program_head' ||
      currentUser.role === 'program_manager' || currentUser.role === 'associate_program_manager';
    
    if (isAdmin) {
      console.log('üìä Rankings not found - initializing for the first time...');
      computeAndSaveRankings();
    }
  }
}, [currentUser, loading, precomputedRankings, computeAndSaveRankings]);

const handleLogin=async()=>{
  setAuthLoading(true);
  setLoginProgress('Connecting...');
  try{
    const email=(loginForm.email||'').trim().toLowerCase();
    const password=loginForm.password;
    const studentId=(loginForm.studentId||'').trim();
    const loginType=loginForm.loginType||'teacher';
    
    if(loginType==='student'){
      // STUDENT LOGIN
      if(!studentId||!password){
        alert('Please enter Student ID and password');
        setAuthLoading(false);
        setLoginProgress('');
        return;
      }
      if(password!=='pass123'){
        alert('Invalid password. Default password is: pass123');
        setAuthLoading(false);
        setLoginProgress('');
        return;
      }
      
      try {
        setLoginProgress('Authenticating...');
        // ‚úÖ STEP 1: Sign in anonymously to get Firebase Auth credentials
        // This allows students to access Firestore collections
        // ‚úÖ PERFORMANCE: Reduced timeout from 15s to 8s for faster login
        const authPromise = auth.signInAnonymously();
        const authResult = await Promise.race([
          authPromise,
          new Promise((_, reject) => setTimeout(() => reject(new Error('Connection timeout. Please check your internet.')), 8000))
        ]);
        console.log('‚úÖ Anonymous auth successful');
        
        setLoginProgress('Finding student...');
        // ‚úÖ STEP 2: Now query students collection (with auth)
        const snap = await db.collection('students')
  .where('id', '==', studentId)
  .limit(1)
  .get();

if (snap.empty) {
  alert('Student ID not found. Please contact your teacher.');
  await auth.signOut(); // Sign out anonymous user
  setAuthLoading(false);
  setLoginProgress('');
  return;
}

const doc = snap.docs[0];
const foundStudent = { ...doc.data(), docId: doc.id };
        console.log('‚úÖ Found student:', foundStudent);
        
        if(foundStudent){
          setLoginProgress('Loading dashboard...');
          const studentUser = {
            ...foundStudent,
            userType:'student',
            studentId:studentId,
            loginTime: Date.now() // ‚úÖ Track login time
          };
          // ‚úÖ IMPROVED: Save to multiple storage mechanisms for PWA/APK persistence
          const sessionStr = JSON.stringify(studentUser);
          if (typeof window.safeStorage !== 'undefined') {
            window.safeStorage.setItem('studentSession', sessionStr);
          } else {
            try { localStorage.setItem('studentSession', sessionStr); } catch(e) {}
          }
          // ‚úÖ NEW: Also save to IndexedDB for PWA/APK persistence
          if (window.persistentStorage) {
            window.persistentStorage.setItem('studentSession', sessionStr).catch(() => {});
          }
          setCurrentUser(studentUser);
          setIsAdmin(false);
          setActiveTab('dashboard');
          setAuthLoading(false);
          setLoginProgress('');
        }else{
          alert('Student ID not found. Please contact your teacher.');
          setAuthLoading(false);
          setLoginProgress('');
          return;
        }
      } catch(e) {
        console.error('Student login error:', e);
        alert('Login failed: ' + (e.message || 'Please check your internet connection'));
        setAuthLoading(false);
        setLoginProgress('');
        return;
      }
    }else{
      // TEACHER/ADMIN LOGIN (existing code)
      if(!email||!password){
        alert('Please enter email and password');
        setAuthLoading(false);
        setLoginProgress('');
        return;
      }
      setLoginProgress('Authenticating...');
      // ‚úÖ PERFORMANCE: Reduced timeout from 15s to 8s for faster login experience
      const authPromise = auth.signInWithEmailAndPassword(email,password);
      await Promise.race([
        authPromise,
        new Promise((_, reject) => setTimeout(() => reject(new Error('Connection timeout. Please check your internet.')), 8000))
      ]);
      setLoginProgress('Loading profile...');
      // Note: setAuthLoading(false) will be called by onAuthStateChanged
    }
  }catch(e){
    console.error('login error',e);
    const errorMsg = e.code === 'auth/wrong-password' ? 'Incorrect password' :
                     e.code === 'auth/user-not-found' ? 'User not found' :
                     e.code === 'auth/too-many-requests' ? 'Too many attempts. Try again later.' :
                     e.message || 'Login failed. Please try again.';
    alert(errorMsg);
    setAuthLoading(false);
    setLoginProgress('');
  }
};
const handleLogout=async()=>{
  try{
    // Clear student session from localStorage
    // ‚úÖ iOS FIX: Use safe storage wrapper
    if (typeof window.safeStorage !== 'undefined') {
      window.safeStorage.removeItem('studentSession');
      window.safeStorage.removeItem('teacherSession'); // ‚úÖ NEW: Clear teacher cache too
    } else {
      try { 
        localStorage.removeItem('studentSession'); 
        localStorage.removeItem('teacherSession'); // ‚úÖ NEW
      } catch(e) {}
    }
    // ‚úÖ NEW: Clear from IndexedDB too
    if (window.persistentStorage) {
      window.persistentStorage.removeItem('studentSession').catch(() => {});
      window.persistentStorage.removeItem('teacherSession').catch(() => {});
    }
    // Clear 2FA states
    setPending2FAUser(null);
    setShow2FAVerify(false);
    setShow2FASetup(false);
    setNeeds2FASetup(false);
    // Clear login progress
    setLoginProgress('');
    // For teachers/admins who use Firebase Auth
    if(auth.currentUser){
      await auth.signOut();
    }
    // Reset state for all users (including students)
    setCurrentUser(null);
    setIsAdmin(false);
    setActiveTab('overview');
    setLoginForm({loginType:'teacher',email:'',password:'',studentId:''});
  }catch(e){
    console.error('logout error',e);
  }
};

// Complete 2FA verification and finish login
const complete2FAVerification = async () => {
  if (!pending2FAUser) return;
  
  const user = pending2FAUser;
  
  // Add device trust after successful 2FA verification
  const userId = user.userType === 'superadmin' ? 'SUPER_ADMIN' : 
                 user.userType === 'manager' ? user.id : 
                 user.userType === 'apc' ? (user.id || user.docId) :
                 user.afid;
  await addDeviceTrust(userId, user.email);
  console.log('‚úÖ Device trusted after 2FA verification for:', user.email);
  
  if (user.userType === 'superadmin') {
    setIsSuperAdmin(true);
    setIsAdmin(true);
    // Fetch all managers
    const allManagersSnap = await db.collection('managers').where('status','==','active').get();
    const allManagers = allManagersSnap.docs.map(d=>({...d.data(),id:d.id}));
    setManagers(allManagers);
    // Fetch academic year settings
    const aySnap = await db.collection('system').doc('academicYear').get();
    if(aySnap.exists) setAcademicYearSettings(aySnap.data());
    // Super admin sees all schools
    setAccessibleSchools([...SCHOOLS]);
    setCurrentUser({name:'Super Administrator',email:user.email,afid:'SUPER_ADMIN',school:'Admin',role:MANAGER_ROLES.SUPER_ADMIN});
    setActiveTab('managers');
  } else if (user.userType === 'manager') {
    setManagerProfile(user);
    // Fetch all managers to calculate accessible schools
    const allManagersSnap = await db.collection('managers').where('status','==','active').get();
    const allManagers = allManagersSnap.docs.map(d=>({...d.data(),id:d.id}));
    setManagers(allManagers);
    // Fetch academic year settings
    const aySnap = await db.collection('system').doc('academicYear').get();
    if(aySnap.exists) setAcademicYearSettings(aySnap.data());
    const schools = getAccessibleSchools(user, allManagers);
    setAccessibleSchools(schools);
    setIsAdmin(true);
    setIsSuperAdmin(false);
    setCurrentUser({
      name: user.name,
      email: user.email,
      afid: user.id,
      docId: user.docId,
      school: schools[0] || 'Admin',
      role: user.role,
      directSchools: user.directSchools || []
    });
    setActiveTab('analytics');
  } else if (user.userType === 'teacher') {
    setCurrentUser(user);
    setIsAdmin(false);
    setActiveTab('overview');
    // Birthday/Anniversary celebrations
    if(user.dob){
      const d = new Date(user.dob);
      const now = new Date();
      if(d.getMonth() === now.getMonth() && d.getDate() === now.getDate()){
        setShowConfetti(true);
        setCelebrationMessage(`üéÇ Happy Birthday, ${user.name}!`);
        setTimeout(() => {setShowConfetti(false);setCelebrationMessage('')}, 8000);
      }
    }
    if(user.joiningDate){
      const j = new Date(user.joiningDate);
      const now = new Date();
      if(j.getMonth() === now.getMonth() && j.getDate() === now.getDate() && j.getFullYear() < now.getFullYear()){
        const years = now.getFullYear() - j.getFullYear();
        setShowConfetti(true);
        setCelebrationMessage(`üéâ Happy ${years} Year Work Anniversary, ${user.name}!`);
        setTimeout(() => {setShowConfetti(false);setCelebrationMessage('')}, 8000);
      }
    }
  } else if (user.userType === 'apc') {
    // APC login
    setCurrentUser(user);
    setIsAdmin(false);
    setActiveTab('overview');
    console.log('‚úÖ APC login completed:', user.name);
  }
  
  // Clear 2FA states
  setPending2FAUser(null);
  setShow2FAVerify(false);
  setShow2FASetup(false);
  setNeeds2FASetup(false);
};

// Handle 2FA setup completion
const handle2FASetupComplete = async () => {
  // Add device trust after successful 2FA setup
  if (pending2FAUser) {
    const userId = pending2FAUser.userType === 'superadmin' ? 'SUPER_ADMIN' : 
                   pending2FAUser.userType === 'manager' ? pending2FAUser.id : 
                   pending2FAUser.userType === 'apc' ? (pending2FAUser.id || pending2FAUser.docId) :
                   pending2FAUser.afid;
    await addDeviceTrust(userId, pending2FAUser.email);
    console.log('‚úÖ Device trusted after 2FA setup for:', pending2FAUser.email);
  }
  
  setShow2FASetup(false);
  setNeeds2FASetup(false);
  // After setup, complete the login
  complete2FAVerification();
};

// Cancel 2FA and logout
const cancel2FA = async () => {
  setPending2FAUser(null);
  setShow2FAVerify(false);
  setShow2FASetup(false);
  setNeeds2FASetup(false);
  if(auth.currentUser){
    await auth.signOut();
  }
  setCurrentUser(null);
  setIsAdmin(false);
};
// ‚úÖ COST FIX: Compute and save school rankings to a single document
// This avoids loading ALL schools' data - teachers only fetch this 1 document
const computeAndSaveRankings = useCallback(async () => {
  try {
    console.log('üìä Computing school rankings...');
    // Fetch all curriculum and progress (server-side, not stored in state)
    const [currSnap, progSnap] = await Promise.all([
      db.collection('curriculum').get(),
      db.collection('chapterProgress').get()
    ]);
    
    // Build temporary maps
    const currMap = {};
    currSnap.docs.forEach(doc => { currMap[doc.id] = doc.data(); });
    const progMap = {};
    progSnap.docs.forEach(doc => { progMap[doc.id] = doc.data(); });
    
    // Calculate rankings for each school
    const rankings = SCHOOLS.map(school => {
      let total = 0, completed = 0;
      SUBJECTS.forEach(subject => {
        ['11', '12'].forEach(grade => {
          const docId = `${school}_${subject}_${grade}`;
          const chapters = currMap[docId]?.chapters || [];
          chapters.forEach(ch => {
            total++;
            const progressId = `${school}_${ch.id}`;
            const prog = progMap[progressId] || {};
            if (prog.completed === 'Yes') completed++;
          });
        });
      });
      return { school, total, completed, percentage: total ? Math.round((completed / total) * 100) : 0 };
    });
    
    // Sort by percentage descending
    rankings.sort((a, b) => b.percentage - a.percentage);
    
    // Save to Firestore (single document)
    await db.collection('system').doc('schoolRankings').set({
      rankings: rankings,
      updatedAt: new Date().toISOString(),
      totalSchools: SCHOOLS.length
    });
    
    console.log('‚úÖ Rankings saved successfully');
    
    // Update local state
    setPrecomputedRankings({ rankings, updatedAt: new Date().toISOString() });
    
    return rankings;
  } catch (e) {
    console.error('Rankings computation error:', e);
    return null;
  }
}, []);

const updateChapterProgress = useCallback(async (school, chapterId, field, value) => {
  try {
    const progressId = `${school}_${chapterId}`;
    const prev = chapterProgress[progressId] || {};

    const updated = {
      ...prev,
      [field]: value,
      school,
      chapterId,
      updatedAt: new Date().toISOString(),
    };

    // üîÑ Write to Firestore
    await db.collection('chapterProgress').doc(progressId).set(updated, { merge: true });

    // üîÑ Update local state so dropdowns/Yes‚ÄìNo change immediately
    setChapterProgress(prevMap => ({
      ...prevMap,
      [progressId]: updated,
    }));

    // ‚úÖ COST FIX: Update rankings when chapter completion changes
    if (field === 'completed') {
      // Debounce rankings update - wait 2 seconds to batch multiple updates
      if (window._rankingsUpdateTimeout) clearTimeout(window._rankingsUpdateTimeout);
      window._rankingsUpdateTimeout = setTimeout(() => {
        computeAndSaveRankings();
      }, 2000);
    }

    // üéâ Optional celebration when a chapter is marked completed
    if (
      (field === 'completed' && (value === 'Yes' || value === true)) ||
      updated.completed === 'Yes' || updated.completed === true
    ) {
      setCelebrationMessage('üéâ Chapter marked as completed!');
      setShowConfetti(true);
      setTimeout(() => {
        setShowConfetti(false);
        setCelebrationMessage('');
      }, 5000);
    }
  } catch (e) {
    console.error('Update error', e);
    alert('Failed to update: ' + e.message);
  }
}, [chapterProgress, computeAndSaveRankings]);

const addChapter=async(school,subject,grade,chapter)=>{try{const docId=`${school}_${subject}_${grade}`;const doc=await db.collection('curriculum').doc(docId).get();const existing=doc.exists?(doc.data().chapters||[]):[];chapter.id=`${subject.charAt(0)}${grade}-${existing.length+1}-${Date.now().toString().slice(-4)}`;const updated=[...existing,chapter];await db.collection('curriculum').doc(docId).set({chapters:updated});alert('Chapter added successfully!')}catch(e){console.error('Add error',e);alert('Failed to add: '+e.message)}};
const updateChapter=async(school,subject,grade,chapterId,updates)=>{try{const docId=`${school}_${subject}_${grade}`;const doc=await db.collection('curriculum').doc(docId).get();const existing=doc.exists?(doc.data().chapters||[]):[];const index=existing.findIndex(ch=>ch.id===chapterId);if(index===-1){alert('Chapter not found');return}existing[index]={...existing[index],...updates};await db.collection('curriculum').doc(docId).set({chapters:existing});alert('Chapter updated successfully!')}catch(e){console.error('Update error',e);alert('Failed to update: '+e.message)}};
const deleteChapter=async(school,subject,grade,chapterId)=>{if(!confirm('Delete this chapter?'))return;try{const docId=`${school}_${subject}_${grade}`;const doc=await db.collection('curriculum').doc(docId).get();const existing=doc.exists?(doc.data().chapters||[]):[];const updated=existing.filter(ch=>ch.id!==chapterId);await db.collection('curriculum').doc(docId).set({chapters:updated});alert('Chapter deleted successfully')}catch(e){console.error('Delete error',e);alert('Failed to delete: '+e.message)}};
function Confetti() {
  const primary = ['#F97316', '#FACC15', '#22C55E', '#0EA5E9', '#6366F1', '#EC4899'];
  const secondary = ['#FDBA74', '#FDE68A', '#86EFAC', '#7DD3FC', '#A5B4FC', '#F9A8D4'];
  const pieces = 120;

  return (
    <div className="fixed inset-0 pointer-events-none z-[9999]">
      {Array.from({ length: pieces }).map((_, i) => {
        const colorIndex = Math.floor(Math.random() * primary.length);
        const left = Math.random() * 100;
        const size = 6 + Math.random() * 10;
        const delay = Math.random() * 1.2;
        const duration = 2.4 + Math.random() * 1.2;
        const isCircle = Math.random() > 0.6;

        return (
          <div
            key={i}
            className="confetti-piece"
            style={{
              left: `${left}%`,
              top: '-40px',
              width: `${size * 1.8}px`,
              height: `${size}px`,
              background: `linear-gradient(135deg, ${primary[colorIndex]}, ${secondary[colorIndex]})`,
              borderRadius: isCircle ? '999px' : '6px',
              boxShadow: '0 0 0 1px rgba(255,255,255,0.5)',
              animationDelay: `${delay}s`,
              animationDuration: `${duration}s`,
              opacity: 0.95,
            }}
          />
        );
      })}
    </div>
  );
}
if(loading){return(<div className="min-h-screen avanti-gradient flex items-center justify-center"><div className="text-center"><img src={AVANTI_LOGO} alt="Avanti Fellows" className="w-20 h-20 mx-auto mb-4 animate-bounce"/><div className="text-white text-2xl font-bold">Loading...</div></div></div>)}

// Show 2FA Setup Modal if needed
if(show2FASetup && pending2FAUser){
  return(
    <div className="min-h-screen avanti-gradient flex items-center justify-center p-4">
      <TwoFactorSetupModal
        user={pending2FAUser}
        onClose={cancel2FA}
        onSetupComplete={handle2FASetupComplete}
      />
    </div>
  );
}

// Show 2FA Verification Modal if needed
if(show2FAVerify && pending2FAUser){
  return(
    <div className="min-h-screen avanti-gradient flex items-center justify-center p-4">
      <TwoFactorVerifyModal
        user={pending2FAUser}
        onVerified={complete2FAVerification}
        onCancel={cancel2FA}
      />
    </div>
  );
}

if(!currentUser){
  return(
    <div className="min-h-screen avanti-gradient flex items-center justify-center p-4">
      <div className="bg-white rounded-3xl shadow-2xl p-10 w-full max-w-md">
        <div className="text-center mb-8">
          <img src={AVANTI_LOGO} alt="Avanti Fellows" className="w-20 h-20 mx-auto mb-4"/>
          <h1 className="text-4xl font-bold text-gray-800 mb-2">Curriculum Tracker</h1>
          <p className="text-gray-600 mt-3">Avanti Fellows</p>
        </div>
        
        {/* LOGIN TYPE SELECTOR - NEW */}
        <div className="flex gap-2 mb-6">
          <button
            onClick={()=>setLoginForm({...loginForm,loginType:'teacher'})}
            className={`flex-1 py-3 rounded-xl font-semibold ${loginForm.loginType==='teacher'?'bg-blue-600 text-white':'bg-gray-200'}`}
          >
            üë®‚Äçüè´ Teacher
          </button>
          <button
            onClick={()=>setLoginForm({...loginForm,loginType:'student'})}
            className={`flex-1 py-3 rounded-xl font-semibold ${loginForm.loginType==='student'?'bg-green-600 text-white':'bg-gray-200'}`}
          >
            üë®‚Äçüéì Student
          </button>
        </div>

        <div className="space-y-5">
          {loginForm.loginType==='student'?(
            <>
              <input type="text" className="w-full px-5 py-4 border-2 border-gray-300 rounded-xl text-lg" value={loginForm.studentId||''} onChange={e=>setLoginForm({...loginForm,studentId:e.target.value})} placeholder="Student ID"/>
              <input type="password" className="w-full px-5 py-4 border-2 border-gray-300 rounded-xl text-lg" value={loginForm.password} onChange={e=>setLoginForm({...loginForm,password:e.target.value})} placeholder="Password (pass123)" onKeyPress={e=>e.key==='Enter'&&handleLogin()}/>
              <p className="text-sm text-gray-600 text-center">Default password: <strong>pass123</strong></p>
            </>
          ):(
            <>
              <input type="email" className="w-full px-5 py-4 border-2 border-gray-300 rounded-xl text-lg" value={loginForm.email} onChange={e=>setLoginForm({...loginForm,email:e.target.value})} placeholder="Email"/>
              <input type="password" className="w-full px-5 py-4 border-2 border-gray-300 rounded-xl text-lg" value={loginForm.password} onChange={e=>setLoginForm({...loginForm,password:e.target.value})} placeholder="Password" onKeyPress={e=>e.key==='Enter'&&handleLogin()}/>
            </>
          )}
          <button onClick={handleLogin} disabled={authLoading} className="w-full avanti-gradient text-white py-4 rounded-xl font-bold text-lg disabled:opacity-70 transition-all">
            {authLoading ? (
              <span className="login-spinner">
                <span className="login-spinner-icon"></span>
                <span className="login-progress-text">{loginProgress || 'Please wait...'}</span>
              </span>
            ) : 'Login'}
          </button>
        </div>
      </div>
    </div>
  );
}

// ‚úÖ Check if student is logged in
if(currentUser && currentUser.userType === 'student') {
  return <StudentDashboard currentUser={currentUser} handleLogout={handleLogout} />;
}

return (<>{currentUser && <OnlineStatusCard currentUser={currentUser} />}{currentUser && <DataFreshnessIndicator />}{isAdmin?<AdminView currentUser={currentUser} handleLogout={handleLogout} teachers={teachers} students={students} curriculum={curriculum} chapterProgress={chapterProgress} studentAttendance={studentAttendance} teacherAttendance={teacherAttendance} schoolInfo={schoolInfo} addChapter={addChapter} updateChapter={updateChapter} deleteChapter={deleteChapter} leaveAdjustments={leaveAdjustments} setLeaveAdjustments={setLeaveAdjustments} managers={managers} isSuperAdmin={isSuperAdmin} accessibleSchools={accessibleSchools} academicYearSettings={academicYearSettings} floatingCelebration={floatingCelebration} setFloatingCelebration={setFloatingCelebration}/>:<TeacherView currentUser={currentUser} handleLogout={handleLogout} showConfetti={showConfetti} Confetti={Confetti} celebrationMessage={celebrationMessage} teachers={teachers} students={students} curriculum={curriculum} chapterProgress={chapterProgress} studentAttendance={studentAttendance} teacherAttendance={teacherAttendance} schoolInfo={schoolInfo} setSchoolInfo={setSchoolInfo} updateChapterProgress={updateChapterProgress} activeTab={activeTab} setActiveTab={setActiveTab} leaveAdjustments={leaveAdjustments} floatingCelebration={floatingCelebration} setFloatingCelebration={setFloatingCelebration} precomputedRankings={precomputedRankings} managers={managers}/>}</>);
}

// ========================================
// ADMIN STUDENT PROFILES VIEW
// ========================================
function AdminStudentProfiles({ accessibleSchools = SCHOOLS, isSuperAdmin = true, isDirector = false }){
  const[studentProfiles,setStudentProfiles]=useState([]);
  const[filterSchool,setFilterSchool]=useState('All');
  const[filterGrade,setFilterGrade]=useState('All');
  const categoryChartRef = useRef(null);
  const genderChartRef = useRef(null);
  const streamChartRef = useRef(null);
  const schoolDistChartRef = useRef(null);
  const chartInstances = useRef({});
  
  // ‚úÖ FIX: Directors get full data access like Super Admin
  const hasFullDataAccess = isSuperAdmin || isDirector;
  
  // Filter schools based on access
  const availableSchools = hasFullDataAccess ? SCHOOLS : accessibleSchools;

  useEffect(()=>{
    const fetchData=async()=>{
      const profilesSnap=await db.collection('studentProfiles').get();
      let profiles = profilesSnap.docs.map(d=>({...d.data(),id:d.id}));
      // Filter by accessible schools for managers (not for Directors/Super Admin)
      if (!hasFullDataAccess) {
        profiles = profiles.filter(p => accessibleSchools.includes(p.school));
      }
      setStudentProfiles(profiles);
    };
    fetchData();
  },[hasFullDataAccess, accessibleSchools]);

  const filteredProfiles=studentProfiles.filter(p=>{
    if(filterSchool!=='All'&&p.school!==filterSchool)return false;
    if(filterGrade!=='All'&&p.grade!==filterGrade)return false;
    return true;
  });

  // Calculate statistics for graphs
  const stats = useMemo(() => {
    const categoryCount = {};
    const genderCount = { Male: 0, Female: 0, Other: 0 };
    const streamCount = { JEE: 0, NEET: 0, Other: 0 };
    const categoryByGender = {};
    const schoolCount = {};
    
    filteredProfiles.forEach(p => {
      // Category count
      const cat = p.category || 'Not Specified';
      categoryCount[cat] = (categoryCount[cat] || 0) + 1;
      
      // Gender count
      let gender = p.gender || 'Other';
      if (gender === 'Male' || gender === 'Female') {
        genderCount[gender]++;
      } else {
        genderCount.Other++;
      }
      
      // Stream count
      const stream = p.stream || 'Other';
      if (stream === 'JEE' || stream === 'NEET') {
        streamCount[stream]++;
      } else {
        streamCount.Other++;
      }
      
      // Category by gender breakdown
      if (!categoryByGender[cat]) {
        categoryByGender[cat] = { Male: 0, Female: 0, Other: 0 };
      }
      if (gender === 'Male' || gender === 'Female') {
        categoryByGender[cat][gender]++;
      } else {
        categoryByGender[cat].Other++;
      }
      
      // School count
      const school = p.school || 'Unknown';
      schoolCount[school] = (schoolCount[school] || 0) + 1;
    });
    
    return { categoryCount, genderCount, streamCount, categoryByGender, schoolCount };
  }, [filteredProfiles]);

  // Draw charts
  useEffect(() => {
    // Destroy existing charts
    Object.values(chartInstances.current).forEach(chart => {
      if (chart) chart.destroy();
    });
    chartInstances.current = {};

    // Category Distribution Pie Chart
    if (categoryChartRef.current && Object.keys(stats.categoryCount).length > 0) {
      const ctx = categoryChartRef.current.getContext('2d');
      const labels = Object.keys(stats.categoryCount);
      const data = Object.values(stats.categoryCount);
      const colors = ['#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', '#EC4899', '#14B8A6'];
      
      chartInstances.current.category = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: labels,
          datasets: [{
            data: data,
            backgroundColor: colors.slice(0, labels.length),
            borderWidth: 2,
            borderColor: '#fff'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: { display: true, text: 'Category Distribution', font: { size: 16, weight: 'bold' } },
            legend: { position: 'bottom', labels: { padding: 15 } }
          }
        }
      });
    }

    // Gender Distribution Pie Chart
    if (genderChartRef.current) {
      const ctx = genderChartRef.current.getContext('2d');
      chartInstances.current.gender = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['Male', 'Female', 'Other'],
          datasets: [{
            data: [stats.genderCount.Male, stats.genderCount.Female, stats.genderCount.Other],
            backgroundColor: ['#6366F1', '#EC4899', '#9CA3AF'],
            borderWidth: 2,
            borderColor: '#fff'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: { display: true, text: 'Gender Distribution', font: { size: 16, weight: 'bold' } },
            legend: { position: 'bottom', labels: { padding: 15 } }
          }
        }
      });
    }

    // Category by Gender Bar Chart
    if (streamChartRef.current && Object.keys(stats.categoryByGender).length > 0) {
      const ctx = streamChartRef.current.getContext('2d');
      const categories = Object.keys(stats.categoryByGender);
      
      chartInstances.current.stream = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: categories,
          datasets: [
            {
              label: 'Male',
              data: categories.map(cat => stats.categoryByGender[cat].Male),
              backgroundColor: '#6366F1',
              borderRadius: 4
            },
            {
              label: 'Female',
              data: categories.map(cat => stats.categoryByGender[cat].Female),
              backgroundColor: '#EC4899',
              borderRadius: 4
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: { display: true, text: 'Category-wise Gender Distribution', font: { size: 16, weight: 'bold' } },
            legend: { position: 'bottom' }
          },
          scales: {
            x: { stacked: false },
            y: { beginAtZero: true, ticks: { stepSize: 1 } }
          }
        }
      });
    }

    // School Distribution Bar Chart
    if (schoolDistChartRef.current && Object.keys(stats.schoolCount).length > 0) {
      const ctx = schoolDistChartRef.current.getContext('2d');
      const schools = Object.keys(stats.schoolCount);
      const counts = Object.values(stats.schoolCount);
      
      chartInstances.current.schoolDist = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: schools.map(s => s.replace('CoE ', '').replace('JNV ', '')),
          datasets: [{
            label: 'Students',
            data: counts,
            backgroundColor: '#F4B41A',
            borderRadius: 4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: { display: true, text: 'School-wise Distribution', font: { size: 16, weight: 'bold' } },
            legend: { display: false }
          },
          scales: {
            y: { beginAtZero: true, ticks: { stepSize: 1 } }
          }
        }
      });
    }

    return () => {
      Object.values(chartInstances.current).forEach(chart => {
        if (chart) chart.destroy();
      });
    };
  }, [stats]);

  const handleExport=()=>{
    const exportData=filteredProfiles.map(p=>({
      'Student ID':p.studentId,
      'First Name':p.firstName,
      'Last Name':p.lastName,
      'Email':p.email,
      'Phone':p.phone,
      'DOB':p.dob,
      'Grade':p.grade,
      'Category':p.category,
      'Stream':p.stream,
      'School':p.school,
      'Father Name':p.fatherName,
      'Father Occupation':p.fatherOccupation,
      'Father Education':p.fatherEducation,
      'Mother Name':p.motherName,
      'Mother Occupation':p.motherOccupation,
      'Mother Education':p.motherEducation,
      'Family Income':p.familyIncome,
      'Address':p.address,
      'State':p.state,
      'District':p.district,
      'Pincode':p.pincode,
      'WhatsApp':p.whatsappNumber,
      '10th %':p.percentage10th,
      '11th %':p.percentage11th||'N/A'
    }));
    exportToExcel(exportData,'student_profiles');
  };

  return(
    <div className="space-y-6">
      <div className="flex justify-between items-center flex-wrap gap-4">
        <div>
          <h2 className="text-3xl font-bold">üë®‚Äçüéì Student Profiles ({filteredProfiles.length})</h2>
          {!isSuperAdmin && (
            <p className="text-sm text-gray-500 mt-1">Showing profiles for your assigned schools</p>
          )}
        </div>
        <button onClick={handleExport} className="px-6 py-3 bg-green-600 text-white rounded-xl font-semibold">
          üì• Export to Excel
        </button>
      </div>

      <div className="bg-white p-6 rounded-2xl shadow-lg">
        <h3 className="text-xl font-bold mb-4">üîç Filters</h3>
        <div className="grid md:grid-cols-2 gap-4">
          <div>
            <label className="block text-sm font-bold mb-2">School</label>
            <select value={filterSchool} onChange={e=>setFilterSchool(e.target.value)} className="w-full border-2 px-4 py-3 rounded-xl">
              <option value="All">All Schools</option>
              {availableSchools.map(s=><option key={s} value={s}>{s}</option>)}
            </select>
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">Grade</label>
            <select value={filterGrade} onChange={e=>setFilterGrade(e.target.value)} className="w-full border-2 px-4 py-3 rounded-xl">
              <option value="All">All Grades</option>
              <option value="11">Class 11</option>
              <option value="12">Class 12</option>
            </select>
          </div>
        </div>
      </div>

      {/* Summary Statistics Cards */}
      <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div className="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-4 rounded-xl shadow-lg">
          <div className="text-sm opacity-90">Total Profiles</div>
          <div className="text-3xl font-bold">{filteredProfiles.length}</div>
        </div>
        <div className="bg-gradient-to-r from-indigo-500 to-purple-600 text-white p-4 rounded-xl shadow-lg">
          <div className="text-sm opacity-90">Male Students</div>
          <div className="text-3xl font-bold">{stats.genderCount.Male}</div>
          <div className="text-xs opacity-75">{filteredProfiles.length > 0 ? Math.round((stats.genderCount.Male / filteredProfiles.length) * 100) : 0}%</div>
        </div>
        <div className="bg-gradient-to-r from-pink-500 to-rose-600 text-white p-4 rounded-xl shadow-lg">
          <div className="text-sm opacity-90">Female Students</div>
          <div className="text-3xl font-bold">{stats.genderCount.Female}</div>
          <div className="text-xs opacity-75">{filteredProfiles.length > 0 ? Math.round((stats.genderCount.Female / filteredProfiles.length) * 100) : 0}%</div>
        </div>
        <div className="bg-gradient-to-r from-green-500 to-emerald-600 text-white p-4 rounded-xl shadow-lg">
          <div className="text-sm opacity-90">Categories</div>
          <div className="text-3xl font-bold">{Object.keys(stats.categoryCount).length}</div>
        </div>
      </div>

      {/* Charts Section */}
      {filteredProfiles.length > 0 && (
        <div className="grid md:grid-cols-2 gap-6">
          <div className="bg-white p-6 rounded-2xl shadow-lg">
            <div style={{ height: '300px' }}>
              <canvas ref={categoryChartRef}></canvas>
            </div>
          </div>
          <div className="bg-white p-6 rounded-2xl shadow-lg">
            <div style={{ height: '300px' }}>
              <canvas ref={genderChartRef}></canvas>
            </div>
          </div>
          <div className="bg-white p-6 rounded-2xl shadow-lg">
            <div style={{ height: '300px' }}>
              <canvas ref={streamChartRef}></canvas>
            </div>
          </div>
          <div className="bg-white p-6 rounded-2xl shadow-lg">
            <div style={{ height: '300px' }}>
              <canvas ref={schoolDistChartRef}></canvas>
            </div>
          </div>
        </div>
      )}

      {/* Category Breakdown Table */}
      <div className="bg-white p-6 rounded-2xl shadow-lg">
        <h3 className="text-xl font-bold mb-4">üìä Category-wise Breakdown</h3>
        <div className="overflow-x-auto">
          <table className="w-full">
            <thead className="avanti-gradient-light">
              <tr>
                <th className="p-3 text-left">Category</th>
                <th className="p-3 text-center">Male</th>
                <th className="p-3 text-center">Female</th>
                <th className="p-3 text-center">Total</th>
                <th className="p-3 text-center">%</th>
              </tr>
            </thead>
            <tbody>
              {Object.entries(stats.categoryByGender).map(([cat, counts]) => (
                <tr key={cat} className="border-b hover:bg-gray-50">
                  <td className="p-3 font-semibold">{cat}</td>
                  <td className="p-3 text-center text-indigo-600 font-bold">{counts.Male}</td>
                  <td className="p-3 text-center text-pink-600 font-bold">{counts.Female}</td>
                  <td className="p-3 text-center font-bold">{counts.Male + counts.Female + counts.Other}</td>
                  <td className="p-3 text-center">
                    {filteredProfiles.length > 0 
                      ? Math.round(((counts.Male + counts.Female + counts.Other) / filteredProfiles.length) * 100) 
                      : 0}%
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </div>

      <div className="bg-white p-6 rounded-2xl shadow-lg overflow-x-auto">
        <h3 className="text-xl font-bold mb-4">üìã Student Profiles List</h3>
        <table className="w-full">
          <thead className="avanti-gradient-light">
            <tr>
              <th className="p-3 text-left">Student ID</th>
              <th className="p-3 text-left">Name</th>
              <th className="p-3 text-left">Grade</th>
              <th className="p-3 text-left">School</th>
              <th className="p-3 text-left">Stream</th>
              <th className="p-3 text-left">Category</th>
              <th className="p-3 text-left">10th %</th>
              <th className="p-3 text-left">Contact</th>
            </tr>
          </thead>
          <tbody>
            {filteredProfiles.length===0?(
              <tr><td colSpan="8" className="p-8 text-center text-gray-500">No student profiles found</td></tr>
            ):filteredProfiles.map(profile=>
              <tr key={profile.id} className="border-b hover:bg-gray-50">
                <td className="p-3 font-mono">{profile.studentId}</td>
                <td className="p-3 font-semibold">{profile.firstName} {profile.lastName}</td>
                <td className="p-3">{profile.grade}th</td>
                <td className="p-3">{profile.school}</td>
                <td className="p-3">{profile.stream}</td>
                <td className="p-3">
                  <span className={`px-2 py-1 rounded text-xs font-semibold ${
                    profile.category === 'General' ? 'bg-blue-100 text-blue-700' :
                    profile.category === 'OBC' ? 'bg-green-100 text-green-700' :
                    profile.category === 'SC' ? 'bg-yellow-100 text-yellow-700' :
                    profile.category === 'ST' ? 'bg-orange-100 text-orange-700' :
                    profile.category === 'General EWS' ? 'bg-purple-100 text-purple-700' :
                    'bg-gray-100 text-gray-700'
                  }`}>
                    {profile.category || 'N/A'}
                  </span>
                </td>
                <td className="p-3">{profile.percentage10th}%</td>
                <td className="p-3 text-sm">{profile.phone}</td>
              </tr>
            )}
          </tbody>
        </table>
      </div>
    </div>
  );
}

// ========================================
// APC SYLLABUS VIEW (View-Only)
// ========================================
function APCSyllabusView({ grade, currentUser, curriculum, chapterProgress, teachers }) {
  const [selectedSubject, setSelectedSubject] = useState('All');
  const [expandedChapters, setExpandedChapters] = useState({});
  const [priorityFilter, setPriorityFilter] = useState('all');
  
  const mySchool = currentUser.school;
  const subjects = ['Physics', 'Chemistry', 'Mathematics', 'Biology'];
  
  // Get all teachers for this school to show their subjects
  const schoolTeachers = teachers.filter(t => t.school === mySchool);
  const availableSubjects = [...new Set(schoolTeachers.map(t => t.subject).filter(Boolean))];
  
  // Get chapters for all subjects or selected subject
  const getChaptersForSubject = (subject) => {
    const docId = `${mySchool}_${subject}_${grade}`;
    return (curriculum[docId]?.chapters || []).map(ch => ({
      ...ch,
      subject,
      progressId: `${mySchool}_${ch.id}`
    }));
  };
  
  const allChapters = selectedSubject === 'All' 
    ? availableSubjects.flatMap(getChaptersForSubject)
    : getChaptersForSubject(selectedSubject);
  
  // Filter by priority
  const chapters = priorityFilter === 'all' 
    ? allChapters 
    : allChapters.filter(ch => (ch.priority || 'high') === priorityFilter);
  
  // Count chapters by priority
  const priorityCounts = {
    all: allChapters.length,
    high: allChapters.filter(ch => ch.priority === 'high' || !ch.priority).length,
    medium: allChapters.filter(ch => ch.priority === 'medium').length,
    low: allChapters.filter(ch => ch.priority === 'low').length
  };
  
  // Calculate stats
  const completedCount = chapters.filter(ch => {
    const prog = chapterProgress[ch.progressId] || {};
    return prog.completed === 'Yes';
  }).length;
  
  const progressPercentage = chapters.length > 0 ? Math.round((completedCount / chapters.length) * 100) : 0;

  return (
    <div className="space-y-6">
      <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div>
          <h2 className="text-3xl font-bold">üìö Class {grade} Syllabus</h2>
          <p className="text-gray-600 mt-1">View-only access for {mySchool}</p>
          <span className="inline-block mt-2 px-3 py-1 bg-teal-100 text-teal-700 rounded-full text-sm font-semibold">
            üë§ APC View
          </span>
        </div>
        
        {/* Subject Filter */}
        <div className="flex items-center gap-3">
          <label className="font-semibold">Subject:</label>
          <select
            value={selectedSubject}
            onChange={(e) => setSelectedSubject(e.target.value)}
            className="px-4 py-2 border-2 rounded-xl font-semibold"
          >
            <option value="All">All Subjects</option>
            {availableSubjects.map(sub => (
              <option key={sub} value={sub}>{sub}</option>
            ))}
          </select>
        </div>
      </div>
      
      {/* Stats Card */}
      <div className="bg-white p-6 rounded-2xl shadow-lg">
        <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
          <div className="text-center p-4 bg-blue-50 rounded-xl">
            <div className="text-3xl font-bold text-blue-600">{chapters.length}</div>
            <div className="text-sm text-gray-600">Total Chapters</div>
          </div>
          <div className="text-center p-4 bg-green-50 rounded-xl">
            <div className="text-3xl font-bold text-green-600">{completedCount}</div>
            <div className="text-sm text-gray-600">Completed</div>
          </div>
          <div className="text-center p-4 bg-orange-50 rounded-xl">
            <div className="text-3xl font-bold text-orange-600">{chapters.length - completedCount}</div>
            <div className="text-sm text-gray-600">Pending</div>
          </div>
          <div className="text-center p-4 bg-purple-50 rounded-xl">
            <div className="text-3xl font-bold text-purple-600">{progressPercentage}%</div>
            <div className="text-sm text-gray-600">Progress</div>
          </div>
        </div>
      </div>
      
      {/* Priority Filter */}
      <div className="bg-white p-4 rounded-2xl shadow-lg">
        <div className="flex flex-wrap items-center gap-3">
          <span className="font-bold text-gray-700">üéØ Filter by Priority:</span>
          <div className="flex flex-wrap gap-2">
            <button onClick={() => setPriorityFilter('all')}
              className={`px-4 py-2 rounded-xl font-semibold transition-all ${
                priorityFilter === 'all' ? 'bg-gray-800 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
              }`}>üìã All ({priorityCounts.all})</button>
            <button onClick={() => setPriorityFilter('high')}
              className={`px-4 py-2 rounded-xl font-semibold transition-all ${
                priorityFilter === 'high' ? 'bg-green-500 text-white' : 'bg-green-50 text-green-700 hover:bg-green-100'
              }`}>üü¢ High ({priorityCounts.high})</button>
            <button onClick={() => setPriorityFilter('medium')}
              className={`px-4 py-2 rounded-xl font-semibold transition-all ${
                priorityFilter === 'medium' ? 'bg-yellow-500 text-white' : 'bg-yellow-50 text-yellow-700 hover:bg-yellow-100'
              }`}>üü° Medium ({priorityCounts.medium})</button>
            <button onClick={() => setPriorityFilter('low')}
              className={`px-4 py-2 rounded-xl font-semibold transition-all ${
                priorityFilter === 'low' ? 'bg-red-500 text-white' : 'bg-red-50 text-red-700 hover:bg-red-100'
              }`}>üî¥ Low ({priorityCounts.low})</button>
          </div>
        </div>
      </div>
      
      {/* Chapters Grid */}
      {chapters.length === 0 ? (
        <div className="bg-white p-8 rounded-2xl text-center">
          <p className="text-gray-600">No chapters found for the selected filters.</p>
        </div>
      ) : (
        <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
          {chapters.map((chapter, idx) => {
            const prog = chapterProgress[chapter.progressId] || {};
            const completedTopics = prog.completedTopics || [];
            const allTopics = chapter.topics || [];
            const progress = allTopics.length ? Math.round((completedTopics.length / allTopics.length) * 100) : 0;
            const isExpanded = expandedChapters[chapter.id + chapter.subject];
            const isCompleted = prog.completed === 'Yes';
            
            return (
              <div key={idx} className={`rounded-2xl shadow-lg p-5 transition-all ${
                isCompleted ? 'bg-gradient-to-br from-green-50 to-emerald-50 border-2 border-green-300' :
                progress > 50 ? 'bg-gradient-to-br from-yellow-50 to-amber-50 border-2 border-yellow-300' :
                'bg-white border-2 border-gray-200'
              }`}>
                <div className="flex justify-between items-start mb-3 gap-3">
                  <div className="flex-1 min-w-0">
                    <div className="flex items-center gap-2 mb-1">
                      <span className={`px-2 py-1 text-xs font-bold rounded ${
                        chapter.subject === 'Physics' ? 'bg-blue-100 text-blue-700' :
                        chapter.subject === 'Chemistry' ? 'bg-purple-100 text-purple-700' :
                        chapter.subject === 'Mathematics' ? 'bg-red-100 text-red-700' :
                        'bg-green-100 text-green-700'
                      }`}>{chapter.subject}</span>
                      {isCompleted && <span className="text-green-600">‚úÖ</span>}
                    </div>
                    <h3 className="text-lg font-bold break-words">{chapter.name}</h3>
                    <div className="mt-2">
                      {(chapter.priority === 'high' || !chapter.priority) && (
                        <span className="priority-badge priority-high text-xs">üü¢ High Priority</span>
                      )}
                      {chapter.priority === 'medium' && (
                        <span className="priority-badge priority-medium text-xs">üü° Medium Priority</span>
                      )}
                      {chapter.priority === 'low' && (
                        <span className="priority-badge priority-low text-xs">üî¥ Low Priority</span>
                      )}
                    </div>
                  </div>
                  <button 
                    onClick={() => setExpandedChapters(prev => ({...prev, [chapter.id + chapter.subject]: !prev[chapter.id + chapter.subject]}))}
                    className="text-sm px-3 py-1 bg-gray-100 rounded-lg font-semibold flex-shrink-0"
                  >
                    {isExpanded ? '‚ñ≤' : '‚ñº'}
                  </button>
                </div>
                
                {/* Progress Bar */}
                <div className="space-y-2">
                  <div className="flex justify-between text-sm">
                    <span className="font-semibold">Topics Progress</span>
                    <span className="font-bold">{completedTopics.length}/{allTopics.length}</span>
                  </div>
                  <div className="h-2 bg-gray-200 rounded-full">
                    <div className="h-2 bg-gradient-to-r from-yellow-400 to-orange-500 rounded-full transition-all" 
                         style={{width: `${progress}%`}}/>
                  </div>
                </div>
                
                {isExpanded && (
                  <div className="mt-4 space-y-3">
                    {/* Topics List (View Only) */}
                    <div className="bg-gray-50 p-3 rounded-lg max-h-40 overflow-y-auto">
                      <p className="text-sm font-bold mb-2">Topics:</p>
                      {allTopics.map((topic, tidx) => {
                        const topicName = typeof topic === 'string' ? topic : topic.name;
                        const isChecked = completedTopics.includes(topicName) || completedTopics.includes(topic);
                        return (
                          <div key={tidx} className={`text-sm py-1 ${isChecked ? 'text-gray-500 line-through' : ''}`}>
                            {isChecked ? '‚úÖ' : '‚¨ú'} {topicName}
                          </div>
                        );
                      })}
                    </div>
                    
                    {/* Details */}
                    <div className="grid grid-cols-2 gap-2 text-sm">
                      <div className="bg-gray-50 p-2 rounded">
                        <span className="font-bold">Target:</span> {chapter.targetDate || '‚Äî'}
                      </div>
                      <div className="bg-gray-50 p-2 rounded">
                        <span className="font-bold">Completed:</span> {prog.completionDate || '‚Äî'}
                      </div>
                      <div className="bg-gray-50 p-2 rounded">
                        <span className="font-bold">Test:</span> {prog.testConducted || 'No'}
                      </div>
                      <div className="bg-gray-50 p-2 rounded">
                        <span className="font-bold">Status:</span> {prog.completed || 'No'}
                      </div>
                    </div>
                    
                    {prog.notes && (
                      <div className="bg-yellow-50 p-2 rounded text-sm">
                        <span className="font-bold">Notes:</span> {prog.notes}
                      </div>
                    )}
                  </div>
                )}
              </div>
            );
          })}
        </div>
      )}
    </div>
  );
}

// ========================================
// APC TEACHER ATTENDANCE VIEW
// ========================================
function APCTeacherAttendanceView({ currentUser, teachers, teacherAttendance, leaveAdjustments }) {
  const [selectedDate, setSelectedDate] = useState(new Date().toISOString().split('T')[0]);
  const [selectedMonth, setSelectedMonth] = useState(new Date().toISOString().slice(0, 7));
  const [viewMode, setViewMode] = useState('daily'); // 'daily' or 'monthly'
  
  const mySchool = currentUser.school;
  
  // Filter teachers for this school (exclude APCs from attendance list)
  const schoolTeachers = teachers.filter(t => t.school === mySchool && !t.isArchived && t.role !== 'apc');
  
  // Get attendance for selected date - check both teacherId and afid for compatibility
  const getDailyAttendance = () => {
    return teacherAttendance.filter(att => att.date === selectedDate && att.school === mySchool);
  };
  
  // Get monthly attendance summary
  const getMonthlyAttendance = () => {
    const monthStart = selectedMonth + '-01';
    const monthEnd = selectedMonth + '-31';
    return teacherAttendance.filter(att => 
      att.school === mySchool && 
      att.date >= monthStart && 
      att.date <= monthEnd
    );
  };
  
  const dailyAttendance = getDailyAttendance();
  const monthlyAttendance = getMonthlyAttendance();
  
  // Calculate stats
  const presentToday = dailyAttendance.filter(a => a.status === 'Present').length;
  const absentToday = schoolTeachers.length - presentToday;
  
  // Monthly stats per teacher - check both teacherId and afid
  const getTeacherMonthlyStats = (teacherAfid) => {
    const teacherAtt = monthlyAttendance.filter(a => a.teacherId === teacherAfid || a.afid === teacherAfid);
    const present = teacherAtt.filter(a => a.status === 'Present').length;
    const leaves = teacherAtt.filter(a => a.status !== 'Present').length;
    return { present, leaves, total: teacherAtt.length };
  };
  
  // Find attendance for a teacher - check both teacherId and afid
  const findTeacherAttendance = (teacherAfid) => {
    return dailyAttendance.find(a => a.teacherId === teacherAfid || a.afid === teacherAfid);
  };

  return (
    <div className="space-y-6">
      <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div>
          <h2 className="text-3xl font-bold">üë®‚Äçüè´ Teacher Attendance</h2>
          <p className="text-gray-600 mt-1">{mySchool} - View Only</p>
          <span className="inline-block mt-2 px-3 py-1 bg-teal-100 text-teal-700 rounded-full text-sm font-semibold">
            üë§ APC View
          </span>
        </div>
        
        {/* View Mode Toggle */}
        <div className="flex items-center gap-2">
          <button
            onClick={() => setViewMode('daily')}
            className={`px-4 py-2 rounded-xl font-semibold ${
              viewMode === 'daily' ? 'bg-blue-600 text-white' : 'bg-gray-200'
            }`}
          >üìÖ Daily View</button>
          <button
            onClick={() => setViewMode('monthly')}
            className={`px-4 py-2 rounded-xl font-semibold ${
              viewMode === 'monthly' ? 'bg-blue-600 text-white' : 'bg-gray-200'
            }`}
          >üìä Monthly View</button>
        </div>
      </div>
      
      {viewMode === 'daily' ? (
        <>
          {/* Date Selector */}
          <div className="bg-white p-4 rounded-2xl shadow-lg">
            <div className="flex flex-wrap items-center gap-4">
              <label className="font-bold">Select Date:</label>
              <input
                type="date"
                value={selectedDate}
                onChange={(e) => setSelectedDate(e.target.value)}
                className="px-4 py-2 border-2 rounded-xl"
              />
              <div className="flex gap-2">
                <button onClick={() => {
                  const d = new Date(selectedDate);
                  d.setDate(d.getDate() - 1);
                  setSelectedDate(d.toISOString().split('T')[0]);
                }} className="px-3 py-2 bg-gray-200 rounded-lg">‚óÄ Prev</button>
                <button onClick={() => setSelectedDate(new Date().toISOString().split('T')[0])} 
                  className="px-3 py-2 bg-blue-100 text-blue-700 rounded-lg font-semibold">Today</button>
                <button onClick={() => {
                  const d = new Date(selectedDate);
                  d.setDate(d.getDate() + 1);
                  setSelectedDate(d.toISOString().split('T')[0]);
                }} className="px-3 py-2 bg-gray-200 rounded-lg">Next ‚ñ∂</button>
              </div>
            </div>
          </div>
          
          {/* Daily Stats */}
          <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div className="bg-white p-4 rounded-xl shadow text-center">
              <div className="text-3xl font-bold text-blue-600">{schoolTeachers.length}</div>
              <div className="text-sm text-gray-600">Total Teachers</div>
            </div>
            <div className="bg-green-50 p-4 rounded-xl shadow text-center">
              <div className="text-3xl font-bold text-green-600">{presentToday}</div>
              <div className="text-sm text-gray-600">Present</div>
            </div>
            <div className="bg-red-50 p-4 rounded-xl shadow text-center">
              <div className="text-3xl font-bold text-red-600">{absentToday}</div>
              <div className="text-sm text-gray-600">Absent/Leave</div>
            </div>
            <div className="bg-purple-50 p-4 rounded-xl shadow text-center">
              <div className="text-3xl font-bold text-purple-600">
                {schoolTeachers.length > 0 ? Math.round((presentToday / schoolTeachers.length) * 100) : 0}%
              </div>
              <div className="text-sm text-gray-600">Attendance Rate</div>
            </div>
          </div>
          
          {/* Daily Attendance Table */}
          <div className="bg-white rounded-2xl shadow-lg overflow-hidden">
            <table className="w-full">
              <thead className="bg-gray-100">
                <tr>
                  <th className="p-4 text-left">Teacher</th>
                  <th className="p-4 text-left">Subject</th>
                  <th className="p-4 text-left">Status</th>
                  <th className="p-4 text-left">Check-in Time</th>
                </tr>
              </thead>
              <tbody>
                {schoolTeachers.map(teacher => {
                  const att = findTeacherAttendance(teacher.afid);
                  return (
                    <tr key={teacher.afid} className="border-b hover:bg-gray-50">
                      <td className="p-4">
                        <div className="font-semibold">{teacher.name}</div>
                        <div className="text-xs text-gray-500">{teacher.afid}</div>
                      </td>
                      <td className="p-4">{teacher.subject}</td>
                      <td className="p-4">
                        {att ? (
                          <span className={`px-3 py-1 rounded-full text-sm font-semibold ${
                            att.status === 'Present' ? 'bg-green-100 text-green-700' : 'bg-orange-100 text-orange-700'
                          }`}>
                            {att.status}
                          </span>
                        ) : (
                          <span className="px-3 py-1 rounded-full text-sm font-semibold bg-gray-100 text-gray-500">
                            Not Marked
                          </span>
                        )}
                      </td>
                      <td className="p-4 text-sm text-gray-600">
                        {att?.punchInTime || att?.checkInTime || '‚Äî'}
                      </td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </div>
        </>
      ) : (
        <>
          {/* Month Selector */}
          <div className="bg-white p-4 rounded-2xl shadow-lg">
            <div className="flex flex-wrap items-center gap-4">
              <label className="font-bold">Select Month:</label>
              <input
                type="month"
                value={selectedMonth}
                onChange={(e) => setSelectedMonth(e.target.value)}
                className="px-4 py-2 border-2 rounded-xl"
              />
            </div>
          </div>
          
          {/* Monthly Summary Table */}
          <div className="bg-white rounded-2xl shadow-lg overflow-hidden">
            <table className="w-full">
              <thead className="bg-gray-100">
                <tr>
                  <th className="p-4 text-left">Teacher</th>
                  <th className="p-4 text-left">Subject</th>
                  <th className="p-4 text-center">Days Present</th>
                  <th className="p-4 text-center">Days Leave</th>
                  <th className="p-4 text-center">Attendance %</th>
                </tr>
              </thead>
              <tbody>
                {schoolTeachers.map(teacher => {
                  const stats = getTeacherMonthlyStats(teacher.afid);
                  const percentage = stats.total > 0 ? Math.round((stats.present / stats.total) * 100) : 0;
                  return (
                    <tr key={teacher.afid} className="border-b hover:bg-gray-50">
                      <td className="p-4">
                        <div className="font-semibold">{teacher.name}</div>
                        <div className="text-xs text-gray-500">{teacher.afid}</div>
                      </td>
                      <td className="p-4">{teacher.subject}</td>
                      <td className="p-4 text-center">
                        <span className="font-bold text-green-600">{stats.present}</span>
                      </td>
                      <td className="p-4 text-center">
                        <span className="font-bold text-orange-600">{stats.leaves}</span>
                      </td>
                      <td className="p-4 text-center">
                        <span className={`px-3 py-1 rounded-full text-sm font-bold ${
                          percentage >= 90 ? 'bg-green-100 text-green-700' :
                          percentage >= 75 ? 'bg-yellow-100 text-yellow-700' :
                          'bg-red-100 text-red-700'
                        }`}>
                          {percentage}%
                        </span>
                      </td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </div>
        </>
      )}
    </div>
  );
}

function TeacherView({
  currentUser,
  handleLogout,
  showConfetti,
  Confetti,
  celebrationMessage,
  teachers,
  students,
  curriculum,
  chapterProgress,
  studentAttendance,
  teacherAttendance,
  schoolInfo,
  setSchoolInfo,
  updateChapterProgress,
  activeTab,
  setActiveTab,
  leaveAdjustments,
  floatingCelebration,
  setFloatingCelebration,
  precomputedRankings,
  managers = []
}) {
  // Check if user is an APC
  const isAPC = currentUser.userType === 'apc' || currentUser.role === 'apc' || currentUser.role === MANAGER_ROLES.APC;
  
  // Different tabs for APC vs Teacher - with FontAwesome icons
  const teacherTabs = isAPC ? [
    { id: 'overview', label: 'Dashboard', icon: <i className="fa-solid fa-chart-line"></i> },
    { id: 'analytics', label: 'Analytics', icon: <i className="fa-solid fa-chart-pie"></i> },
    { id: 'syllabus11', label: 'Class 11 Syllabus', icon: <i className="fa-solid fa-book"></i> },
    { id: 'syllabus12', label: 'Class 12 Syllabus', icon: <i className="fa-solid fa-book-open"></i> },
    { id: 'directory', label: 'Directory', icon: <i className="fa-solid fa-address-book"></i> },
    { id: 'socialwall', label: 'Social Wall', icon: <i className="fa-solid fa-comments"></i> },
    { id: 'attendance', label: 'Student Attendance', icon: <i className="fa-solid fa-clipboard-check"></i> },
    { id: 'attendancedash', label: 'Attendance Dashboard', icon: <i className="fa-solid fa-calendar-check"></i> },
    { id: 'myattendance', label: 'My Attendance', icon: <i className="fa-solid fa-clock"></i> },
    { id: 'teacherattview', label: 'Teacher Attendance', icon: <i className="fa-solid fa-chalkboard-user"></i> },
    { id: 'assets', label: 'Asset Management', icon: <i className="fa-solid fa-boxes-stacked"></i> },
    { id: 'schoolinfo', label: 'School Info', icon: <i className="fa-solid fa-school"></i> },
    { id: 'examstats', label: 'Exam Stats', icon: <i className="fa-solid fa-graduation-cap"></i> },
    { id: 'timesheet', label: 'Timesheet', icon: <i className="fa-solid fa-clock"></i> },
    { id: 'roadmap', label: 'Roadmap', icon: <i className="fa-solid fa-map"></i> }
  ] : [
    { id: 'overview', label: 'Dashboard', icon: <i className="fa-solid fa-chart-line"></i> },
    { id: 'analytics', label: 'Analytics', icon: <i className="fa-solid fa-chart-pie"></i> },
    { id: 'class11', label: 'Class 11', icon: <i className="fa-solid fa-book"></i> },
    { id: 'class12', label: 'Class 12', icon: <i className="fa-solid fa-book-open"></i> },
    { id: 'directory', label: 'Directory', icon: <i className="fa-solid fa-address-book"></i> },
    { id: 'socialwall', label: 'Social Wall', icon: <i className="fa-solid fa-comments"></i> },
    { id: 'attendance', label: 'Student Attendance', icon: <i className="fa-solid fa-clipboard-check"></i> },
    { id: 'attendancedash', label: 'Attendance Dashboard', icon: <i className="fa-solid fa-calendar-check"></i> },
    { id: 'myattendance', label: 'My Attendance', icon: <i className="fa-solid fa-clock"></i> },
    { id: 'assets', label: 'Asset Management', icon: <i className="fa-solid fa-boxes-stacked"></i> },
    { id: 'schoolinfo', label: 'School Info', icon: <i className="fa-solid fa-school"></i> },
    { id: 'examstats', label: 'Exam Stats', icon: <i className="fa-solid fa-graduation-cap"></i> },
    { id: 'myprofile', label: 'My Profile', icon: <i className="fa-solid fa-user"></i> },
    { id: 'timesheet', label: 'Timesheet', icon: <i className="fa-solid fa-clock"></i> },
    { id: 'roadmap', label: 'Roadmap', icon: <i className="fa-solid fa-map"></i> }
  ];

  const [sidebarCollapsed, setSidebarCollapsed] = useState(false);
  const [sidebarHovering, setSidebarHovering] = useState(false);
  const [isMobileSidebarOpen, setIsMobileSidebarOpen] = useState(false);
  const [isMobileMoreOpen, setIsMobileMoreOpen] = useState(false);
  const [isMobile, setIsMobile] = useState(window.innerWidth <= 768);
  const [darkMode, setDarkMode] = useState(() => {
    // Check localStorage for saved preference
    const saved = localStorage.getItem('darkMode');
    return saved === 'true';
  });
  
  // Detect mobile screen size
  useEffect(() => {
    const checkMobile = () => setIsMobile(window.innerWidth <= 768);
    checkMobile();
    window.addEventListener('resize', checkMobile);
    return () => window.removeEventListener('resize', checkMobile);
  }, []);
  
  // Apply dark mode to document
  useEffect(() => {
    document.documentElement.setAttribute('data-theme', darkMode ? 'dark' : 'light');
    localStorage.setItem('darkMode', darkMode);
  }, [darkMode]);
  
  // Handle navigation and auto-close on mobile
  const handleTabClick = (tabId) => {
    setActiveTab(tabId);
    // Close sidebar and more menu on mobile after navigation
    if (window.innerWidth < 768) {
      setIsMobileSidebarOpen(false);
      setIsMobileMoreOpen(false);
    }
  };
  
  // Swipe gesture detection
  useEffect(() => {
    let touchStartX = 0;
    let touchEndX = 0;
    
    const handleTouchStart = (e) => {
      touchStartX = e.changedTouches[0].screenX;
    };
    
    const handleTouchEnd = (e) => {
      touchEndX = e.changedTouches[0].screenX;
      handleSwipe();
    };
    
    const handleSwipe = () => {
      const swipeThreshold = 50;
      if (touchEndX - touchStartX > swipeThreshold && touchStartX < 50) {
        // Swipe right from left edge - open sidebar
        setIsMobileSidebarOpen(true);
      } else if (touchStartX - touchEndX > swipeThreshold) {
        // Swipe left - close sidebar
        setIsMobileSidebarOpen(false);
      }
    };
    
    document.addEventListener('touchstart', handleTouchStart);
    document.addEventListener('touchend', handleTouchEnd);
    
    return () => {
      document.removeEventListener('touchstart', handleTouchStart);
      document.removeEventListener('touchend', handleTouchEnd);
    };
  }, []);

  return (
    <div className="min-h-screen bg-gray-50">
      {showConfetti && <Confetti />}

      {/* Floating Celebration Card */}
      {floatingCelebration && (
        <div className={`floating-celebration-card ${floatingCelebration.type === 'anniversary' ? 'anniversary' : ''}`}>
          <button 
            className="close-btn" 
            onClick={() => {
              localStorage.setItem('floatingCelebrationDismissed_' + new Date().toDateString(), 'true');
              setFloatingCelebration(null);
            }}
          >√ó</button>
          <span className="confetti" style={{top: '5px', left: '10px'}}>üéâ</span>
          <span className="confetti" style={{top: '10px', right: '40px', animationDelay: '0.5s'}}>‚ú®</span>
          <span className="confetti" style={{bottom: '10px', left: '30px', animationDelay: '1s'}}>üéä</span>
          <div className="celebration-content">
            <div className="avatar">
              {floatingCelebration.person?.profilePhoto ? (
                <img src={floatingCelebration.person.profilePhoto} alt="" />
              ) : (
                floatingCelebration.type === 'birthday' ? 'üéÇ' : 'üéâ'
              )}
            </div>
            <div className="info">
              <h4>{floatingCelebration.type === 'birthday' ? 'üéÇ Birthday Today!' : 'üéâ Work Anniversary!'}</h4>
              <h3>{floatingCelebration.person?.name}</h3>
              <p>
                {floatingCelebration.type === 'birthday' 
                  ? 'Wish them a Happy Birthday! üéà' 
                  : `Completing ${floatingCelebration.years} year${floatingCelebration.years > 1 ? 's' : ''} at Avanti! üíê`}
              </p>
              {floatingCelebration.total > 1 && (
                <p style={{marginTop: '4px', opacity: '0.7'}}>
                  +{floatingCelebration.total - 1} more {floatingCelebration.type === 'birthday' ? 'birthday' : 'anniversary'}{floatingCelebration.total > 2 ? 's' : ''} today
                </p>
              )}
            </div>
          </div>
        </div>
      )}

      {/* PWA install helper */}
      <InstallPrompt />
      
      {/* ========== MOBILE FIXED HEADER ========== */}
      {isMobile && (
        <header 
          style={{
            position: 'fixed',
            top: 0,
            left: 0,
            right: 0,
            height: '56px',
            background: '#1a1a2e',
            zIndex: 1001,
            padding: '0 16px',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'space-between',
            boxShadow: '0 2px 10px rgba(0,0,0,0.2)'
          }}
        >
          <button
            onClick={() => setIsMobileSidebarOpen(!isMobileSidebarOpen)}
            style={{
              width: '44px',
              height: '44px',
              background: 'linear-gradient(135deg, #F4B41A 0%, #E8B039 100%)',
              border: 'none',
              borderRadius: '10px',
              color: 'white',
              fontSize: '20px',
              cursor: 'pointer',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center'
            }}
          >
            <i className={`fa-solid ${isMobileSidebarOpen ? 'fa-times' : 'fa-bars'}`}></i>
          </button>
          <div style={{color: 'white', fontWeight: 600, fontSize: '16px', display: 'flex', alignItems: 'center', gap: '8px'}}>
            <div style={{width: '32px', height: '32px', background: 'linear-gradient(135deg, #F4B41A 0%, #E8B039 100%)', borderRadius: '8px', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '16px'}}>üìö</div>
            <span>Curriculum Tracker</span>
          </div>
          <div style={{width: '44px'}}></div>
        </header>
      )}

      {/* Sidebar Hover Zone (for auto-expand on desktop) */}
      {!isMobile && sidebarCollapsed && (
        <div 
          className="sidebar-hover-zone"
          onMouseEnter={() => setSidebarHovering(true)}
        />
      )}
      
      {/* Mobile Sidebar Overlay */}
      <div 
        className={`mobile-sidebar-overlay ${isMobileSidebarOpen ? 'active' : ''}`}
        onClick={() => setIsMobileSidebarOpen(false)}
      />

      {/* Modern Vertical Sidebar */}
      <div 
        className={`sidebar ${sidebarCollapsed ? 'collapsed' : 'expanded'} ${isMobileSidebarOpen ? 'mobile-open' : ''} ${sidebarHovering ? 'hovering' : ''}`}
        onMouseEnter={() => !isMobile && sidebarCollapsed && setSidebarHovering(true)}
        onMouseLeave={() => !isMobile && setSidebarHovering(false)}
      >
        <div className="sidebar-header">
          <div className="sidebar-logo">
            <div className="sidebar-logo-icon">üìö</div>
            <span className="sidebar-logo-text">Curriculum Tracker</span>
          </div>
          <button
            onClick={() => setSidebarCollapsed(!sidebarCollapsed)}
            className="sidebar-toggle"
          >
            <i className={`fa-solid ${sidebarCollapsed ? 'fa-chevron-right' : 'fa-chevron-left'}`}></i>
          </button>
        </div>

        <div className="sidebar-nav">
          {teacherTabs.map((tab) => (
            <div
              key={tab.id}
              onClick={() => handleTabClick(tab.id)}
              className={`sidebar-item ${activeTab === tab.id ? 'active' : ''}`}
              data-tooltip={tab.label}
            >
              <span className="sidebar-icon">{tab.icon}</span>
              <span className="sidebar-label">{tab.label}</span>
            </div>
          ))}
        </div>

        <div className="sidebar-footer">
          {/* Dark Mode Toggle */}
          {!sidebarCollapsed && (
            <div className="theme-toggle-container">
              <i className={`fa-solid ${darkMode ? 'fa-moon' : 'fa-sun'}`} style={{color: darkMode ? '#F4B41A' : '#6b7280'}}></i>
              <div 
                className={`theme-toggle ${darkMode ? 'dark' : ''}`}
                onClick={() => setDarkMode(!darkMode)}
              >
                <div className="theme-toggle-slider">
                  {darkMode ? 'üåô' : '‚òÄÔ∏è'}
                </div>
              </div>
              <span style={{color: 'rgba(255,255,255,0.6)', fontSize: '12px'}}>{darkMode ? 'Dark' : 'Light'}</span>
            </div>
          )}
          {sidebarCollapsed && (
            <div 
              className="sidebar-item" 
              onClick={() => setDarkMode(!darkMode)}
              style={{justifyContent: 'center', cursor: 'pointer'}}
              data-tooltip={darkMode ? 'Light Mode' : 'Dark Mode'}
            >
              <i className={`fa-solid ${darkMode ? 'fa-sun' : 'fa-moon'}`} style={{color: '#F4B41A'}}></i>
            </div>
          )}
          
          {!sidebarCollapsed && (
            <div className="text-gray-400 text-sm mb-3 px-1 mt-2">
              <p className="font-semibold text-white">{currentUser.name}</p>
              <p className="text-xs">{currentUser.school}</p>
              {isAPC && (
                <span className="inline-block mt-1 px-2 py-0.5 bg-yellow-500/20 text-yellow-400 rounded text-xs font-semibold">
                  <i className="fa-solid fa-clipboard-list mr-1"></i> APC
                </span>
              )}
            </div>
          )}
          <button onClick={handleLogout} className="sidebar-logout">
            <i className="fa-solid fa-right-from-bracket"></i>
            <span>Logout</span>
          </button>
        </div>
      </div>

      {/* Main content */}
      <div 
        className={`main-content ${sidebarCollapsed ? 'sidebar-collapsed' : 'sidebar-expanded'}`}
        style={isMobile ? {marginLeft: 0, paddingTop: '70px', paddingBottom: '20px'} : {}}
      >
        {celebrationMessage && (
          <div className="avanti-gradient text-white text-center py-4 text-xl font-bold">
            {celebrationMessage}
          </div>
        )}

        <div className="px-4 py-6">
        
        {/* Profile Completion Banner - Shows when profile is incomplete */}
        <ProfileCompletionBanner 
          currentUser={currentUser} 
          onNavigateToProfile={() => setActiveTab('myprofile')} 
        />

        {/* Tab content */}
        {activeTab === 'overview' && (
          <TeacherOverview
            currentUser={currentUser}
            teachers={teachers}
            students={students}
            curriculum={curriculum}
            chapterProgress={chapterProgress}
            studentAttendance={studentAttendance}
            teacherAttendance={teacherAttendance}
            schoolInfo={schoolInfo}
            onNavigateToProfile={() => setActiveTab('myprofile')}
            precomputedRankings={precomputedRankings}
          />
        )}

        {activeTab === 'analytics' && (
          <TeacherAnalytics
            currentUser={currentUser}
            curriculum={curriculum}
            chapterProgress={chapterProgress}
          />
        )}

        {activeTab === 'class11' && (
  <TeacherCurriculum
    grade="11"
    currentUser={currentUser}
    curriculum={curriculum}
    chapterProgress={chapterProgress}
    updateChapterProgress={updateChapterProgress}
  />
)}

        {activeTab === 'class12' && (
  <TeacherCurriculum
    grade="12"
    currentUser={currentUser}
    curriculum={curriculum}
    chapterProgress={chapterProgress}
    updateChapterProgress={updateChapterProgress}
  />
)}

        {/* APC View-Only Syllabus Views */}
        {activeTab === 'syllabus11' && (
          <APCSyllabusView
            grade="11"
            currentUser={currentUser}
            curriculum={curriculum}
            chapterProgress={chapterProgress}
            teachers={teachers}
          />
        )}

        {activeTab === 'syllabus12' && (
          <APCSyllabusView
            grade="12"
            currentUser={currentUser}
            curriculum={curriculum}
            chapterProgress={chapterProgress}
            teachers={teachers}
          />
        )}

        {/* APC Teacher Attendance View */}
        {activeTab === 'teacherattview' && (
          <APCTeacherAttendanceView
            currentUser={currentUser}
            teachers={teachers}
            teacherAttendance={teacherAttendance}
            leaveAdjustments={leaveAdjustments}
          />
        )}

        {activeTab === 'directory' && (
          <OrgChartDirectory teachers={teachers} currentUser={currentUser} />
        )}

        {activeTab === 'myprofile' && (
          <TeacherSelfProfile currentUser={currentUser} teachers={teachers} />
        )}

        {activeTab === 'attendance' && (
          <StudentAttendanceView
            currentUser={currentUser}
            students={students}
            studentAttendance={studentAttendance}
          />
        )}

        {activeTab === 'attendancedash' && (
          <TeacherAttendanceDashboard
            currentUser={currentUser}
            students={students}
            teachers={teachers}
            studentAttendance={studentAttendance}
            teacherAttendance={teacherAttendance}
          />
        )}

        {activeTab === 'myattendance' && (
          <TeacherAttendanceView
            currentUser={currentUser}
            teacherAttendance={teacherAttendance}
            leaveAdjustments={leaveAdjustments}
          />
        )}

        {activeTab === 'schoolinfo' && (
          <SchoolInfoView currentUser={currentUser} schoolInfo={schoolInfo} setSchoolInfo={setSchoolInfo} />
        )}

        {activeTab === 'examstats' && <TeacherExamStats currentUser={currentUser} />}

        {activeTab === 'assets' && (
          <AssetManagement currentUser={currentUser} students={students} />
        )}

        {activeTab === 'socialwall' && (
          <SocialWall teachers={teachers} currentUser={currentUser} />
        )}

        {activeTab === 'roadmap' && (
          <RoadmapPage currentUser={currentUser} />
        )}

        {activeTab === 'timesheet' && (
          <TimesheetPage 
            currentUser={currentUser} 
            teachers={teachers} 
            curriculum={curriculum}
            isAdmin={false}
            accessibleSchools={[currentUser.school]}
            managers={managers}
          />
        )}
        </div>
      </div>

      <footer className="bg-gray-800 text-white text-center py-4">
        <p>Made by Anand with ‚ù§Ô∏è</p>
      </footer>
    </div>
  );
}

// ========================================
// ADMIN EXAM REGISTRATION STATISTICS
// ========================================
function AdminExamStats({ accessibleSchools = [], isSuperAdmin = false, isDirector = false }) {
  const [examRegistrations, setExamRegistrations] = useState([]);
  const [students, setStudents] = useState([]);

  const [filterSchool, setFilterSchool] = useState('All');
  const [filterGrade, setFilterGrade] = useState('All');
  const [filterGender, setFilterGender] = useState('All');
  const [filterStatus, setFilterStatus] = useState('All'); // Completed / Partial / NotDone / NeedHelp
  const [filterExam, setFilterExam] = useState('All');

  // ‚úÖ FIX: Directors get full data access like Super Admin
  const hasFullDataAccess = isSuperAdmin || isDirector;

  useEffect(() => {
    const fetchData = async () => {
      const regsSnap = await db.collection('studentExamRegistrations').get();
      setExamRegistrations(regsSnap.docs.map(d => ({ ...d.data(), id: d.id })));

      // ‚úÖ FIXED: Fetch ALL students for admins
      console.log('üìä [ExamStats] Fetching students, hasFullDataAccess:', hasFullDataAccess);
      const studentsSnap = await db.collection('students').get();
      const studentsData = studentsSnap.docs.map(d => {
        const data = d.data();
        let studentId = data.id;
        if (!studentId) {
          const parts = d.id.split('_');
          studentId = parts[parts.length - 1];
        }
        return { ...data, id: studentId, docId: d.id };
      });
      console.log('‚úÖ [ExamStats] Loaded', studentsData.length, 'students');
      setStudents(studentsData);
    };
    fetchData();
  }, [hasFullDataAccess]);

  // ‚úÖ FIX: Use only accessible schools for dropdown - Directors get all schools
  const schoolOptions = hasFullDataAccess ? SCHOOLS : accessibleSchools;
  
  // ‚úÖ FIX: Filter students by accessible schools first - Directors see all
  const accessibleStudents = hasFullDataAccess ? students : students.filter(s => accessibleSchools.includes(s.school));
  
  const gradeOptions = Array.from(new Set(accessibleStudents.map(s => s.grade).filter(Boolean))).sort();
  const genderOptions = Array.from(new Set(accessibleStudents.map(s => s.gender).filter(Boolean))).sort();
  const examOptions = Array.from(
    new Set(examRegistrations.flatMap(r => (r.exams || []).map(e => e.examName)).filter(Boolean))
  ).sort();

  const filteredStudents = accessibleStudents.filter(s => {
    if (filterSchool !== 'All' && s.school !== filterSchool) return false;
    if (filterGrade !== 'All' && s.grade !== filterGrade) return false;
    if (filterGender !== 'All' && (s.gender || '') !== filterGender) return false;
    return true;
  });

  // Get all student IDs who have at least one exam registration
  const studentsWithAnyReg = new Set();
  examRegistrations.forEach(reg => {
    const student = filteredStudents.find(s => s.id === reg.studentId);
    if (student && reg.exams && reg.exams.length > 0) {
      studentsWithAnyReg.add(reg.studentId);
    }
  });

  // Calculate pending students (those without any registration)
  const pendingStudentsList = filteredStudents.filter(s => !studentsWithAnyReg.has(s.id));

  const detailRows = [];
  
  // If Pending filter is selected, show students without registrations
  if (filterStatus === 'Pending') {
    pendingStudentsList.forEach(student => {
      detailRows.push({ 
        student, 
        reg: { studentId: student.id, studentName: student.name }, 
        exam: { examName: 'No Registration', registrationStatus: 'Pending', needSupport: 'No' },
        isPending: true
      });
    });
  } else {
    // Normal filtering for students with registrations
    examRegistrations.forEach(reg => {
      const student = filteredStudents.find(s => s.id === reg.studentId);
      if (!student) return;
      (reg.exams || []).forEach(exam => {
        if (filterExam !== 'All' && exam.examName !== filterExam) return;
        if (filterStatus === 'Completed' && exam.registrationStatus !== 'Yes') return;
        if (filterStatus === 'Partial' && exam.registrationStatus !== 'Partially') return;
        if (filterStatus === 'NotDone' && exam.registrationStatus !== 'No') return;
        if (filterStatus === 'NeedHelp' && exam.needSupport !== 'Yes') return;
        detailRows.push({ student, reg, exam, isPending: false });
      });
    });
  }

  const totalStudents = filteredStudents.length;
  const studentsWithRegs = studentsWithAnyReg.size;
  const pendingStudents = pendingStudentsList.length;

  const examStats = {};
  // Only calculate exam stats when not showing pending
  if (filterStatus !== 'Pending') {
    detailRows.forEach(({ exam }) => {
      const name = exam.examName || 'Other';
      if (!examStats[name]) {
        examStats[name] = { completed: 0, partial: 0, notCompleted: 0, needSupport: 0 };
      }
      if (exam.registrationStatus === 'Yes') examStats[name].completed++;
      if (exam.registrationStatus === 'Partially') examStats[name].partial++;
      if (exam.registrationStatus === 'No') examStats[name].notCompleted++;
      if (exam.needSupport === 'Yes') examStats[name].needSupport++;
    });
  }

  const handleExport = () => {
    const exportData = detailRows.map(({ student, reg, exam, isPending }) => ({
      'Student ID': reg.studentId || student.id,
      'Student Name': reg.studentName || student.name,
      'School': student.school,
      'Grade': student.grade,
      'Gender': student.gender || '-',
      'Exam Name': isPending ? 'No Registration' : exam.examName,
      'Registration Status': isPending ? 'Pending' : exam.registrationStatus,
      'Registration Number': isPending ? '-' : (exam.registrationNumber || '-'),
      'Password': isPending ? '-' : (exam.password || '-'),
      'Email Used': isPending ? '-' : (exam.emailUsed || '-'),
      'Phone Number Used': isPending ? '-' : (exam.phoneUsed || '-'),
      'Need Support': isPending ? '-' : exam.needSupport,
      'Support Type': isPending ? '-' : (exam.supportType || '-'),
      'Reason Not Completed': isPending ? '-' : (exam.reasonNotCompleted || '-'),
      'Last Updated': isPending ? '-' : (reg.updatedAt ? new Date(reg.updatedAt).toLocaleDateString() : '-')
    }));

    if (exportData.length === 0) {
      alert('No data to export!');
      return;
    }
    exportToExcel(exportData, 'exam_registrations_detailed');
  };

  return (
    <div className="space-y-6">
      <div className="flex justify-between items-center">
        <h2 className="text-3xl font-bold">üìä Exam Registration Statistics</h2>
        <button
          onClick={handleExport}
          className="px-6 py-3 bg-green-600 text-white rounded-xl font-semibold"
        >
          üì• Export
        </button>
      </div>

      {/* Filters */}
      <div className="bg-white p-6 rounded-2xl shadow-lg">
        <h3 className="text-xl font-bold mb-4">üîç Filters</h3>
        <div className="grid md:grid-cols-3 gap-4">
          <div>
            <label className="block text-sm font-bold mb-2">School</label>
            <select
              value={filterSchool}
              onChange={e => setFilterSchool(e.target.value)}
              disabled={!isEditing}
              className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"
            >
              <option value="All">All Schools</option>
              {schoolOptions.map(s => (
                <option key={s} value={s}>{s}</option>
              ))}
            </select>
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">Grade</label>
            <select
              value={filterGrade}
              onChange={e => setFilterGrade(e.target.value)}
              disabled={!isEditing}
              className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"
            >
              <option value="All">All Grades</option>
              <option value="11">Class 11</option>
              <option value="12">Class 12</option>
            </select>
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">Gender</label>
            <select
              value={filterGender}
              onChange={e => setFilterGender(e.target.value)}
              disabled={!isEditing}
              className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"
            >
              <option value="All">All</option>
              {genderOptions.map(g => (
                <option key={g} value={g}>{g}</option>
              ))}
            </select>
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">Exam Name</label>
            <select
              value={filterExam}
              onChange={e => setFilterExam(e.target.value)}
              disabled={!isEditing}
              className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"
            >
              <option value="All">All Exams</option>
              {examOptions.map(name => (
                <option key={name} value={name}>{name}</option>
              ))}
            </select>
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">Status</label>
            <select
              value={filterStatus}
              onChange={e => setFilterStatus(e.target.value)}
              disabled={!isEditing}
              className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"
            >
              <option value="All">All</option>
              <option value="Completed">Completed</option>
              <option value="Partial">Partial</option>
              <option value="NotDone">Not Done</option>
              <option value="NeedHelp">Need Help</option>
              <option value="Pending">Pending (No Registration)</option>
            </select>
          </div>
        </div>
      </div>

      {/* Summary cards */}
      <div className="grid md:grid-cols-3 gap-4">
        <div 
          className="stat-card bg-blue-500 text-white cursor-pointer hover:bg-blue-600 transition-colors"
          onClick={() => setFilterStatus('All')}
        >
          <div className="text-sm opacity-90">Total Students</div>
          <div className="text-5xl font-bold">{totalStudents}</div>
        </div>
        <div 
          className="stat-card bg-green-500 text-white cursor-pointer hover:bg-green-600 transition-colors"
          onClick={() => setFilterStatus('All')}
        >
          <div className="text-sm opacity-90">Registered for Exams</div>
          <div className="text-5xl font-bold">{studentsWithRegs}</div>
        </div>
        <div 
          className="stat-card bg-orange-500 text-white cursor-pointer hover:bg-orange-600 transition-colors"
          onClick={() => setFilterStatus('Pending')}
        >
          <div className="text-sm opacity-90">Pending Registration</div>
          <div className="text-5xl font-bold">{pendingStudents}</div>
          <div className="text-xs opacity-75 mt-1">Click to view list</div>
        </div>
      </div>

      {/* Exam-wise status */}
      <div className="bg-white p-6 rounded-2xl shadow-lg">
        <h3 className="text-xl font-bold mb-4">üìã Exam-wise Registration Status</h3>
        <div className="overflow-x-auto">
          <table className="w-full">
            <thead className="avanti-gradient-light">
              <tr>
                <th className="p-3 text-left">Exam</th>
                <th className="p-3 text-center">Completed</th>
                <th className="p-3 text-center">Partial</th>
                <th className="p-3 text-center">Not Started</th>
                <th className="p-3 text-center">Need Support</th>
              </tr>
            </thead>
            <tbody>
              {Object.keys(examStats).length === 0 ? (
                <tr>
                  <td colSpan="5" className="p-8 text-center text-gray-500">
                    No exam registrations yet
                  </td>
                </tr>
              ) : (
                Object.entries(examStats).map(([examName, stats]) => (
                  <tr key={examName} className="border-b hover:bg-gray-50">
                    <td className="p-3 font-semibold">{examName}</td>
                    <td className="p-3 text-center">
                      <span className="px-3 py-1 rounded-full bg-green-100 text-green-700 font-bold">
                        {stats.completed}
                      </span>
                    </td>
                    <td className="p-3 text-center">
                      <span className="px-3 py-1 rounded-full bg-yellow-100 text-yellow-700 font-bold">
                        {stats.partial}
                      </span>
                    </td>
                    <td className="p-3 text-center">
                      <span className="px-3 py-1 rounded-full bg-red-100 text-red-700 font-bold">
                        {stats.notCompleted}
                      </span>
                    </td>
                    <td className="p-3 text-center">
                      <span className="px-3 py-1 rounded-full bg-orange-100 text-orange-700 font-bold">
                        {stats.needSupport}
                      </span>
                    </td>
                  </tr>
                ))
              )}
            </tbody>
          </table>
        </div>
      </div>

      {/* Student-wise details */}
      <div className="bg-white p-6 rounded-2xl shadow-lg">
        <h3 className="text-xl font-bold mb-4">üßë‚Äçüéì Student-wise Exam Registrations</h3>
        <div className="overflow-x-auto">
          <table className="w-full text-sm">
            <thead className="bg-gray-100">
              <tr>
                <th className="p-3 text-left">Student ID</th>
                <th className="p-3 text-left">Name</th>
                <th className="p-3 text-left">School</th>
                <th className="p-3 text-left">Grade</th>
                <th className="p-3 text-left">Gender</th>
                <th className="p-3 text-left">Exam</th>
                <th className="p-3 text-left">Status</th>
                <th className="p-3 text-left">Need Help</th>
                <th className="p-3 text-left">Reg. No.</th>
                <th className="p-3 text-left">Email</th>
                <th className="p-3 text-left">Phone</th>
              </tr>
            </thead>
            <tbody>
              {detailRows.length === 0 ? (
                <tr>
                  <td colSpan="11" className="p-6 text-center text-gray-500">
                    No exam registrations with current filters.
                  </td>
                </tr>
              ) : (
                detailRows.map((row, idx) => {
                  const status = row.exam.registrationStatus || 'No';
                  const needHelp = row.exam.needSupport === 'Yes';
                  const isPending = row.isPending;
                  return (
                    <tr key={idx} className="border-b hover:bg-gray-50">
                      <td className="p-3">{row.student.id}</td>
                      <td className="p-3">{row.student.name}</td>
                      <td className="p-3">{row.student.school}</td>
                      <td className="p-3">{row.student.grade}</td>
                      <td className="p-3">{row.student.gender || '‚Äî'}</td>
                      <td className="p-3">{isPending ? '‚Äî' : row.exam.examName}</td>
                      <td className="p-3">
                        {isPending && <span className="px-3 py-1 rounded-full bg-gray-100 text-gray-700 font-semibold">Pending</span>}
                        {!isPending && status === 'Yes' && <span className="px-3 py-1 rounded-full bg-green-100 text-green-700 font-semibold">Completed</span>}
                        {!isPending && status === 'Partially' && <span className="px-3 py-1 rounded-full bg-yellow-100 text-yellow-700 font-semibold">Partial</span>}
                        {!isPending && status === 'No' && <span className="px-3 py-1 rounded-full bg-red-100 text-red-700 font-semibold">Not Done</span>}
                      </td>
                      <td className="p-3">
                        {isPending ? '‚Äî' : (needHelp ? (
                          <span className="px-3 py-1 rounded-full bg-orange-100 text-orange-700 font-semibold">Yes</span>
                        ) : (
                          'No'
                        ))}
                      </td>
                      <td className="p-3">{isPending ? '‚Äî' : (row.exam.registrationNumber || '‚Äî')}</td>
                      <td className="p-3">{isPending ? '‚Äî' : (row.exam.emailUsed || '‚Äî')}</td>
                      <td className="p-3">{isPending ? '‚Äî' : (row.exam.phoneUsed || '‚Äî')}</td>
                    </tr>
                  );
                })
              )}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  );
}

// ========================================
// MANAGER MANAGEMENT COMPONENT (4-Level Hierarchy)
// ========================================
function ManagerManagement({ managers, currentUser, isSuperAdmin }) {
  const [showModal, setShowModal] = useState(false);
  const [editingManager, setEditingManager] = useState(null);
  const [form, setForm] = useState({
    name: '',
    email: '',
    afCode: '',
    role: MANAGER_ROLES.APH,
    reportsTo: '',
    directSchools: [],
    phone: '',
    status: 'active',
    dateOfBirth: '',
    joiningDate: '',
    whatsapp: '',
    profilePhoto: ''
  });
  const [uploadingPhoto, setUploadingPhoto] = useState(false);
  const [filterRole, setFilterRole] = useState('All');
  const [searchQuery, setSearchQuery] = useState('');
  const [allSchools, setAllSchools] = useState([...SCHOOLS]);
  const [newSchoolName, setNewSchoolName] = useState('');
  const [showSchoolModal, setShowSchoolModal] = useState(false);

  // Fetch schools from Firebase
  useEffect(() => {
    const fetchSchools = async () => {
      const schoolsSnap = await db.collection('schoolsList').get();
      if (!schoolsSnap.empty) {
        const schoolsData = schoolsSnap.docs.map(d => d.data().name).filter(Boolean);
        if (schoolsData.length > 0) {
          setAllSchools(schoolsData);
        }
      }
    };
    fetchSchools();
  }, []);

  // Get managers by role for dropdown options
  const getManagersByRole = (role) => managers.filter(m => m.role === role && m.status === 'active');
  
  // Get valid "reports to" options based on selected role
  const getReportsToOptions = (role) => {
    switch(role) {
      case MANAGER_ROLES.DIRECTOR: return []; // Director reports to no one
      case MANAGER_ROLES.ASSOC_DIRECTOR: return []; // Associate Director reports to no one
      case MANAGER_ROLES.TRAINING: return []; // Training Department reports to no one
      case MANAGER_ROLES.APH: return []; // APH reports to Super Admin (no selection needed)
      case MANAGER_ROLES.PM: return getManagersByRole(MANAGER_ROLES.APH); // PM reports to APH
      case MANAGER_ROLES.APM: return getManagersByRole(MANAGER_ROLES.PM); // APM reports to PM
      default: return [];
    }
  };

  // Filter managers
  const filteredManagers = managers.filter(m => {
    if (filterRole !== 'All' && m.role !== filterRole) return false;
    if (searchQuery && !m.name?.toLowerCase().includes(searchQuery.toLowerCase()) && 
        !m.email?.toLowerCase().includes(searchQuery.toLowerCase())) return false;
    return true;
  });

  // Recursive function to get all reportees
  const getAllReportees = (managerId) => {
    const directReportees = managers.filter(m => m.reportsTo === managerId);
    let allReportees = [...directReportees];
    directReportees.forEach(r => {
      allReportees = [...allReportees, ...getAllReportees(r.id)];
    });
    return allReportees;
  };

  // Get direct reportees
  const getDirectReportees = (managerId) => {
    return managers.filter(m => m.reportsTo === managerId);
  };

  // Get manager name by ID
  const getManagerName = (managerId) => {
    const manager = managers.find(m => m.id === managerId);
    return manager ? manager.name : 'Super Admin';
  };

  // Calculate total schools for a manager (direct + all reportees)
  const getTotalSchools = (manager) => {
    let schools = [...(manager.directSchools || [])];
    const reportees = getAllReportees(manager.id);
    reportees.forEach(r => {
      schools = [...schools, ...(r.directSchools || [])];
    });
    return [...new Set(schools)];
  };

  const openAddModal = () => {
    setEditingManager(null);
    setForm({
      name: '',
      email: '',
      afCode: '',
      role: MANAGER_ROLES.APH,
      reportsTo: '',
      directSchools: [],
      phone: '',
      whatsapp: '',
      status: 'active',
      dateOfBirth: '',
      joiningDate: '',
      profilePhoto: ''
    });
    setShowModal(true);
  };

  const openEditModal = (manager) => {
    setEditingManager(manager);
    setForm({
      name: manager.name || '',
      email: manager.email || '',
      afCode: manager.afCode || '',
      role: manager.role || MANAGER_ROLES.APH,
      reportsTo: manager.reportsTo || '',
      directSchools: manager.directSchools || [],
      phone: manager.phone || '',
      whatsapp: manager.whatsapp || '',
      status: manager.status || 'active',
      dateOfBirth: manager.dateOfBirth || '',
      joiningDate: manager.joiningDate || '',
      profilePhoto: manager.profilePhoto || ''
    });
    setShowModal(true);
  };

  // Handle manager profile photo upload with compression
  const handleManagerPhotoUpload = async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    // Validate type
    if (!['image/jpeg', 'image/png', 'image/webp'].includes(file.type)) {
      alert('Only JPG, PNG, or WebP allowed');
      return;
    }
    
    setUploadingPhoto(true);
    
    // Compress image for faster upload
    // ‚úÖ FIX: Added error handling and timeout to prevent infinite loading
    const compressProfilePhoto = (file) => {
      return new Promise((resolve) => {
        // ‚úÖ FIX: Add timeout to prevent infinite loading (10 seconds max)
        const timeoutId = setTimeout(() => {
          console.warn('[compressProfilePhoto] Timeout - returning original file');
          resolve(file);
        }, 10000);
        
        // If already small, use as-is
        if (file.size < 200 * 1024) {
          clearTimeout(timeoutId);
          resolve(file);
          return;
        }
        
        try {
          const reader = new FileReader();
          
          // ‚úÖ FIX: Handle FileReader errors
          reader.onerror = () => {
            clearTimeout(timeoutId);
            console.warn('[compressProfilePhoto] FileReader error');
            resolve(file);
          };
          
          reader.onload = (e) => {
            const img = new Image();
            
            // ‚úÖ FIX: Handle image load errors
            img.onerror = () => {
              clearTimeout(timeoutId);
              console.warn('[compressProfilePhoto] Image load error');
              resolve(file);
            };
            
            img.onload = () => {
              try {
                const canvas = document.createElement('canvas');
                const maxSize = 400; // Profile photos don't need to be large
                let width = img.width;
                let height = img.height;
                
                if (width > maxSize || height > maxSize) {
                  if (width > height) {
                    height = (height * maxSize) / width;
                    width = maxSize;
                  } else {
                    width = (width * maxSize) / height;
                    height = maxSize;
                  }
                }
                
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                if (!ctx) {
                  clearTimeout(timeoutId);
                  resolve(file);
                  return;
                }
                ctx.drawImage(img, 0, 0, width, height);
                
                canvas.toBlob((blob) => {
                  clearTimeout(timeoutId);
                  if (!blob) {
                    console.warn('[compressProfilePhoto] toBlob returned null');
                    resolve(file);
                    return;
                  }
                  const compressedFile = new File([blob], file.name, { type: 'image/jpeg' });
                  console.log('Profile photo compressed:', (file.size/1024).toFixed(1) + 'KB ‚Üí', (compressedFile.size/1024).toFixed(1) + 'KB');
                  resolve(compressedFile);
                }, 'image/jpeg', 0.7);
              } catch (canvasError) {
                clearTimeout(timeoutId);
                console.warn('[compressProfilePhoto] Canvas error:', canvasError);
                resolve(file);
              }
            };
            img.src = e.target.result;
          };
          reader.readAsDataURL(file);
        } catch (error) {
          clearTimeout(timeoutId);
          console.warn('[compressProfilePhoto] Error:', error);
          resolve(file);
        }
      });
    };
    
    try {
      // Compress first
      const compressedFile = await compressProfilePhoto(file);
      
      // Show preview immediately
      const reader = new FileReader();
      reader.onload = async (readerEvent) => {
        const base64 = readerEvent.target.result;
        setForm(prev => ({ ...prev, profilePhoto: base64 }));
        
        try {
          const safeFileName = `manager_${Date.now()}.jpg`;
          const storageRef = firebase.storage().ref(`profile-photos/${safeFileName}`);
          
          // Upload compressed file
          const uploadTask = storageRef.put(compressedFile);
          
          await new Promise((resolve, reject) => {
            uploadTask.on('state_changed',
              (snapshot) => {
                const progress = Math.round((snapshot.bytesTransferred / snapshot.totalBytes) * 100);
                console.log('[Manager Photo] Upload progress:', progress + '%');
              },
              (error) => {
                console.error('[Manager Photo] Upload error:', error);
                reject(error);
              },
              async () => {
                try {
                  const url = await storageRef.getDownloadURL();
                  setForm(prev => ({ ...prev, profilePhoto: url }));
                  resolve(url);
                } catch (urlError) {
                  reject(urlError);
                }
              }
            );
          });
          
          alert('‚úÖ Photo uploaded successfully!');
        } catch (err) {
          console.error('Upload error:', err);
          alert('‚ö†Ô∏è Photo saved locally. Cloud upload may have failed, but you can still continue.');
        } finally {
          setUploadingPhoto(false);
        }
      };
      reader.onerror = () => {
        alert('Failed to read image file');
        setUploadingPhoto(false);
      };
      reader.readAsDataURL(compressedFile);
    } catch (err) {
      console.error('Compression error:', err);
      setUploadingPhoto(false);
      alert('Failed to process image');
    }
  };

  const handleSubmit = async () => {
    if (!form.name || !form.email) {
      alert('Please fill in required fields');
      return;
    }
    
    // Validate reports to for PM and APM (not for Directors/APH)
    if ((form.role === MANAGER_ROLES.PM || form.role === MANAGER_ROLES.APM) && !form.reportsTo) {
      alert('Please select who this person reports to');
      return;
    }
    
    // ‚úÖ Directors don't need schools - they have view-all access
    const isDirectorRole = form.role === 'director' || form.role === 'assoc_director' || form.role === 'training';

    try {
      const managerData = {
        name: form.name,
        email: form.email.toLowerCase(),
        afCode: form.afCode || null,
        role: form.role,
        reportsTo: (form.role === MANAGER_ROLES.APH || isDirectorRole) ? null : form.reportsTo,
        directSchools: isDirectorRole ? [] : form.directSchools, // Directors have all-access
        viewAllSchools: isDirectorRole, // ‚úÖ Flag for Directors to see all data
        canApprove: !isDirectorRole, // ‚úÖ Directors cannot approve timesheets
        phone: form.phone,
        whatsapp: form.whatsapp || null,
        status: form.status,
        dateOfBirth: form.dateOfBirth || null,
        joiningDate: form.joiningDate || null,
        profilePhoto: form.profilePhoto || null,
        updatedAt: new Date().toISOString()
      };

      if (editingManager) {
        await db.collection('managers').doc(editingManager.id).update(managerData);
        alert('‚úÖ Updated successfully!');
      } else {
        managerData.createdAt = new Date().toISOString();
        await db.collection('managers').add(managerData);
        
        alert(`‚úÖ ${ROLE_LABELS[form.role]} added successfully!\n\n` +
              `üìß Email: ${form.email}\n\n` +
              `‚ö†Ô∏è IMPORTANT: Create Firebase Auth user:\n` +
              `1. Firebase Console ‚Üí Authentication ‚Üí Users\n` +
              `2. Click "Add user"\n` +
              `3. Enter: ${form.email}\n` +
              `4. Set password and share with them`);
      }
      
      setShowModal(false);
      window.location.reload();
    } catch (e) {
      alert('Failed: ' + e.message);
    }
  };

  const handleDeactivate = async (manager) => {
    if (!confirm(`Deactivate ${manager.name}?\n\nThey will lose access to the system.`)) return;
    
    try {
      await db.collection('managers').doc(manager.id).update({
        status: 'inactive',
        deactivatedAt: new Date().toISOString()
      });
      alert('‚úÖ Deactivated');
      window.location.reload();
    } catch (e) {
      alert('Failed: ' + e.message);
    }
  };

  const handleReactivate = async (manager) => {
    try {
      await db.collection('managers').doc(manager.id).update({
        status: 'active',
        reactivatedAt: new Date().toISOString()
      });
      alert('‚úÖ Reactivated');
      window.location.reload();
    } catch (e) {
      alert('Failed: ' + e.message);
    }
  };

  const handleAddSchool = async () => {
    if (!newSchoolName.trim()) {
      alert('Please enter a school name');
      return;
    }
    
    if (allSchools.includes(newSchoolName.trim())) {
      alert('This school already exists');
      return;
    }

    try {
      await db.collection('schoolsList').add({
        name: newSchoolName.trim(),
        createdAt: new Date().toISOString(),
        createdBy: currentUser.email
      });
      
      setAllSchools([...allSchools, newSchoolName.trim()]);
      setNewSchoolName('');
      alert('‚úÖ School added!');
    } catch (e) {
      alert('Failed: ' + e.message);
    }
  };

  const handleRemoveSchool = async (schoolName) => {
    if (!confirm(`Remove "${schoolName}"?\n\n‚ö†Ô∏è Existing data will NOT be deleted.`)) return;
    
    try {
      const schoolsSnap = await db.collection('schoolsList').where('name', '==', schoolName).get();
      if (!schoolsSnap.empty) {
        await schoolsSnap.docs[0].ref.delete();
      }
      setAllSchools(allSchools.filter(s => s !== schoolName));
      alert('‚úÖ School removed');
    } catch (e) {
      alert('Failed: ' + e.message);
    }
  };

  const toggleSchoolSelection = (school) => {
    if (form.directSchools.includes(school)) {
      setForm({ ...form, directSchools: form.directSchools.filter(s => s !== school) });
    } else {
      setForm({ ...form, directSchools: [...form.directSchools, school] });
    }
  };

  // Render hierarchy card recursively
  const renderManagerCard = (manager, level = 0) => {
    const colors = ROLE_COLORS[manager.role] || ROLE_COLORS['apm'];
    const reportees = getDirectReportees(manager.id);
    const totalSchools = getTotalSchools(manager);
    
    return (
      <div key={manager.id} className={`${level > 0 ? 'ml-4 md:ml-8 mt-2' : ''}`}>
        <div className={`border-2 ${colors.border} rounded-xl p-4 ${colors.bg}`}>
          <div className="flex items-start justify-between flex-wrap gap-2">
            <div className="flex-1 min-w-0">
              <div className="flex items-center gap-2 flex-wrap">
                <span className="text-2xl">{manager.role === MANAGER_ROLES.APH ? 'üëî' : manager.role === MANAGER_ROLES.PM ? 'üë®‚Äçüíº' : 'üë§'}</span>
                <span className="text-xl font-bold">{manager.name}</span>
                <span className={`px-3 py-1 ${colors.bg} ${colors.text} text-xs rounded-full font-bold border ${colors.border}`}>
                  {ROLE_LABELS[manager.role]}
                </span>
                {manager.status !== 'active' && (
                  <span className="px-3 py-1 bg-red-500 text-white text-xs rounded-full font-bold">INACTIVE</span>
                )}
              </div>
              <div className="text-sm text-gray-600 mt-1">üìß {manager.email}</div>
              {manager.reportsTo && (
                <div className="text-sm text-gray-500 mt-1">‚Ü≥ Reports to: {getManagerName(manager.reportsTo)}</div>
              )}
              <div className="mt-2">
                <span className="text-sm font-semibold">Direct Schools:</span>
                <div className="flex flex-wrap gap-2 mt-1">
                  {(manager.directSchools || []).map(school => (
                    <span key={school} className="px-2 py-1 bg-white text-sm rounded border">üè´ {school}</span>
                  ))}
                  {(!manager.directSchools || manager.directSchools.length === 0) && (
                    <span className="text-gray-400 text-sm">No schools assigned</span>
                  )}
                </div>
              </div>
              {reportees.length > 0 && (
                <div className="mt-2 text-sm text-green-600 font-semibold">
                  üìä Total Access: {totalSchools.length} schools (via {reportees.length} reportees)
                </div>
              )}
            </div>
            {isSuperAdmin && (
              <div className="flex gap-2">
                <button onClick={() => openEditModal(manager)} className="px-3 py-1 bg-yellow-400 rounded-lg font-semibold text-sm">Edit</button>
                {manager.status === 'active' ? (
                  <button onClick={() => handleDeactivate(manager)} className="px-3 py-1 bg-red-500 text-white rounded-lg font-semibold text-sm">Deactivate</button>
                ) : (
                  <button onClick={() => handleReactivate(manager)} className="px-3 py-1 bg-green-500 text-white rounded-lg font-semibold text-sm">Reactivate</button>
                )}
              </div>
            )}
          </div>
        </div>
        {/* Render reportees */}
        {reportees.map(reportee => renderManagerCard(reportee, level + 1))}
      </div>
    );
  };

  // Get top-level managers (APHs - report to no one)
  const topLevelManagers = managers.filter(m => m.role === MANAGER_ROLES.APH && m.status === 'active');
  
  // Get unassigned managers (PM/APM without valid reportsTo)
  const unassignedManagers = managers.filter(m => 
    (m.role === MANAGER_ROLES.PM || m.role === MANAGER_ROLES.APM) && 
    !m.reportsTo && 
    m.status === 'active'
  );

  return (
    <div className="space-y-6">
      <div className="flex justify-between items-center flex-wrap gap-4">
        <h2 className="text-3xl font-bold">üë• Manager & School Management</h2>
        <div className="flex gap-3">
          {isSuperAdmin && (
            <>
              <button onClick={() => setShowSchoolModal(true)} className="px-6 py-3 bg-green-600 text-white rounded-xl font-semibold">
                üè´ Manage Schools
              </button>
              <button onClick={openAddModal} className="px-6 py-3 bg-blue-600 text-white rounded-xl font-semibold">
                + Add Manager
              </button>
            </>
          )}
        </div>
      </div>

      {/* Role Legend */}
      <div className="bg-white p-4 rounded-xl shadow-lg">
        <h3 className="font-bold mb-3">üìã Role Hierarchy</h3>
        <div className="flex flex-wrap gap-3">
          <span className="px-3 py-2 bg-purple-100 text-purple-700 rounded-lg text-sm font-semibold border border-purple-200">üëë Super Admin</span>
          <span className="text-gray-400">‚Üí</span>
          <span className="px-3 py-2 bg-blue-100 text-blue-700 rounded-lg text-sm font-semibold border border-blue-200">üëî PH (Program Head)</span>
          <span className="text-gray-400">‚Üí</span>
          <span className="px-3 py-2 bg-green-100 text-green-700 rounded-lg text-sm font-semibold border border-green-200">üë®‚Äçüíº PM (Program Manager)</span>
          <span className="text-gray-400">‚Üí</span>
          <span className="px-3 py-2 bg-orange-100 text-orange-700 rounded-lg text-sm font-semibold border border-orange-200">üë§ APM (Associate Program Manager)</span>
        </div>
      </div>

      {/* Filters */}
      <div className="bg-white p-6 rounded-2xl shadow-lg">
        <h3 className="text-xl font-bold mb-4">üîç Filters</h3>
        <div className="grid md:grid-cols-2 gap-4">
          <div>
            <label className="block text-sm font-bold mb-2">Search</label>
            <input 
              type="text" 
              value={searchQuery} 
              onChange={e => setSearchQuery(e.target.value)}
              placeholder="Search by name or email..."
              className="w-full border-2 px-4 py-3 rounded-xl"
            />
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">Role</label>
            <select 
              value={filterRole} 
              onChange={e => setFilterRole(e.target.value)}
              className="w-full border-2 px-4 py-3 rounded-xl"
            >
              <option value="All">All Roles</option>
              <option value={MANAGER_ROLES.DIRECTOR}>Director</option>
              <option value={MANAGER_ROLES.ASSOC_DIRECTOR}>Associate Director</option>
              <option value={MANAGER_ROLES.TRAINING}>Training Department</option>
              <option value={MANAGER_ROLES.APH}>Program Head (PH)</option>
              <option value={MANAGER_ROLES.PM}>Program Manager (PM)</option>
              <option value={MANAGER_ROLES.APM}>Associate Program Manager (APM)</option>
            </select>
          </div>
        </div>
      </div>

      {/* Hierarchy View */}
      <div className="bg-white p-6 rounded-2xl shadow-lg">
        <h3 className="text-xl font-bold mb-4">üìä Organization Hierarchy</h3>
        <p className="text-sm text-gray-600 mb-4">Director ‚Üí Associate Director ‚Üí Program Head ‚Üí Program Manager ‚Üí Associate Program Manager</p>
        <div className="space-y-4">
          {/* Super Admin Card */}
          <div className="border-2 border-purple-200 rounded-xl p-4 bg-purple-50">
            <div className="flex items-center gap-2">
              <span className="text-2xl">üëë</span>
              <span className="text-xl font-bold">Super Administrator</span>
              <span className="px-3 py-1 bg-purple-600 text-white text-xs rounded-full font-bold">SUPER ADMIN</span>
            </div>
            <div className="text-sm text-gray-600 mt-1">üìß admin@avantifellows.org</div>
            <div className="text-sm text-green-600 font-semibold mt-2">üìä Full Access: All Schools</div>
          </div>
          
          {/* Directors (view-only) */}
          {managers.filter(m => m.role === 'director' && m.status === 'active').map(director => (
            <div key={director.id} className="border-2 border-indigo-200 rounded-xl p-4 bg-indigo-50 ml-4">
              <div className="flex items-center gap-2">
                <span className="text-2xl">üéØ</span>
                <span className="text-xl font-bold">{director.name}</span>
                <span className="px-3 py-1 bg-indigo-600 text-white text-xs rounded-full font-bold">DIRECTOR</span>
                <span className="px-2 py-1 bg-blue-100 text-blue-600 text-xs rounded-full">View Only</span>
              </div>
              <div className="text-sm text-gray-600 mt-1">üìß {director.email}</div>
              <div className="text-sm text-green-600 font-semibold mt-2">üìä View Access: All Schools</div>
            </div>
          ))}
          
          {/* Associate Directors (view-only) */}
          {managers.filter(m => m.role === 'assoc_director' && m.status === 'active').map(assocDir => (
            <div key={assocDir.id} className="border-2 border-violet-200 rounded-xl p-4 bg-violet-50 ml-4">
              <div className="flex items-center gap-2">
                <span className="text-2xl">üéñÔ∏è</span>
                <span className="text-xl font-bold">{assocDir.name}</span>
                <span className="px-3 py-1 bg-violet-600 text-white text-xs rounded-full font-bold">ASSOCIATE DIRECTOR</span>
                <span className="px-2 py-1 bg-blue-100 text-blue-600 text-xs rounded-full">View Only</span>
              </div>
              <div className="text-sm text-gray-600 mt-1">üìß {assocDir.email}</div>
              <div className="text-sm text-green-600 font-semibold mt-2">üìä View Access: All Schools</div>
            </div>
          ))}
          
          {/* Training Department (view-only) */}
          {managers.filter(m => m.role === 'training' && m.status === 'active').map(trainer => (
            <div key={trainer.id} className="border-2 border-cyan-200 rounded-xl p-4 bg-cyan-50 ml-4">
              <div className="flex items-center gap-2">
                <span className="text-2xl">üìö</span>
                <span className="text-xl font-bold">{trainer.name}</span>
                <span className="px-3 py-1 bg-cyan-600 text-white text-xs rounded-full font-bold">TRAINING DEPARTMENT</span>
                <span className="px-2 py-1 bg-blue-100 text-blue-600 text-xs rounded-full">View Only</span>
              </div>
              <div className="text-sm text-gray-600 mt-1">üìß {trainer.email}</div>
              <div className="text-sm text-green-600 font-semibold mt-2">üìä View Access: All Schools</div>
            </div>
          ))}
          
          {/* APHs and their tree */}
          {topLevelManagers.map(manager => renderManagerCard(manager))}
          
          {/* Unassigned Managers Warning */}
          {unassignedManagers.length > 0 && (
            <div className="border-2 border-red-200 rounded-xl p-4 bg-red-50">
              <div className="text-lg font-bold text-red-700 mb-2">‚ö†Ô∏è Unassigned Managers ({unassignedManagers.length})</div>
              <p className="text-sm text-red-600 mb-3">These managers don't have anyone to report to. Please assign them.</p>
              {unassignedManagers.map(m => (
                <div key={m.id} className="border border-red-300 rounded-lg p-3 bg-white mb-2">
                  <div className="flex items-center gap-2">
                    <span className="font-bold">{m.name}</span>
                    <span className={`px-2 py-1 ${ROLE_COLORS[m.role]?.bg} ${ROLE_COLORS[m.role]?.text} text-xs rounded-full font-bold`}>
                      {ROLE_LABELS[m.role]}
                    </span>
                  </div>
                  <button onClick={() => openEditModal(m)} className="mt-2 px-3 py-1 bg-yellow-400 rounded-lg font-semibold text-sm">
                    Assign Manager
                  </button>
                </div>
              ))}
            </div>
          )}
          
          {topLevelManagers.length === 0 && (
            <div className="text-center py-8 text-gray-500">
              <p>No managers found. Click "+ Add Manager" to add your first Program Head.</p>
            </div>
          )}
        </div>
      </div>

      {/* Table View */}
      <div className="bg-white p-6 rounded-2xl shadow-lg overflow-x-auto">
        <h3 className="text-xl font-bold mb-4">üìã All Staff ({filteredManagers.length})</h3>
        <table className="w-full">
          <thead className="avanti-gradient-light">
            <tr>
              <th className="p-3 text-left">Name</th>
              <th className="p-3 text-left">Email</th>
              <th className="p-3 text-left">Role</th>
              <th className="p-3 text-left">Reports To</th>
              <th className="p-3 text-left">Direct Schools</th>
              <th className="p-3 text-left">Total Access</th>
              <th className="p-3 text-left">Status</th>
              {isSuperAdmin && <th className="p-3 text-left">Actions</th>}
            </tr>
          </thead>
          <tbody>
            {filteredManagers.length === 0 ? (
              <tr><td colSpan={isSuperAdmin ? 8 : 7} className="p-8 text-center text-gray-500">No managers found</td></tr>
            ) : (
              filteredManagers.map(manager => (
                <tr key={manager.id} className="border-b hover:bg-gray-50">
                  <td className="p-3 font-semibold">{manager.name}</td>
                  <td className="p-3 text-sm">{manager.email}</td>
                  <td className="p-3">
                    <span className={`px-3 py-1 rounded-full text-xs font-bold ${ROLE_COLORS[manager.role]?.bg} ${ROLE_COLORS[manager.role]?.text}`}>
                      {ROLE_LABELS[manager.role]}
                    </span>
                  </td>
                  <td className="p-3">{manager.reportsTo ? getManagerName(manager.reportsTo) : 'Super Admin'}</td>
                  <td className="p-3">
                    <div className="flex flex-wrap gap-1">
                      {(manager.directSchools || []).slice(0, 2).map(s => (
                        <span key={s} className="px-2 py-1 bg-gray-100 text-xs rounded">{s}</span>
                      ))}
                      {(manager.directSchools || []).length > 2 && (
                        <span className="px-2 py-1 bg-gray-200 text-xs rounded">+{manager.directSchools.length - 2}</span>
                      )}
                    </div>
                  </td>
                  <td className="p-3 font-bold">{getTotalSchools(manager).length}</td>
                  <td className="p-3">
                    <span className={`px-3 py-1 rounded-full text-xs font-bold ${
                      manager.status === 'active' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'
                    }`}>
                      {manager.status === 'active' ? 'Active' : 'Inactive'}
                    </span>
                  </td>
                  {isSuperAdmin && (
                    <td className="p-3">
                      <button onClick={() => openEditModal(manager)} className="px-3 py-1 bg-yellow-400 rounded-lg font-semibold text-sm">Edit</button>
                    </td>
                  )}
                </tr>
              ))
            )}
          </tbody>
        </table>
      </div>

      {/* Add/Edit Modal */}
      {showModal && (
        <div className="modal-overlay" onClick={() => setShowModal(false)}>
          <div className="modal-content max-w-2xl" onClick={e => e.stopPropagation()}>
            <h3 className="text-2xl font-bold mb-4">{editingManager ? 'Edit Staff Member' : 'Add New Staff Member'}</h3>
            <div className="space-y-4">
              <div className="grid md:grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-bold mb-1">Full Name *</label>
                  <input 
                    type="text" 
                    value={form.name} 
                    onChange={e => setForm({ ...form, name: e.target.value })}
                    className="w-full border-2 px-3 py-2 rounded-lg"
                    placeholder="e.g., Anand Joshi"
                  />
                </div>
                <div>
                  <label className="block text-sm font-bold mb-1">Email *</label>
                  <input 
                    type="email" 
                    value={form.email} 
                    onChange={e => setForm({ ...form, email: e.target.value })}
                    className="w-full border-2 px-3 py-2 rounded-lg"
                    placeholder="e.g., anand@avantifellows.org"
                  />
                </div>
              </div>

              <div className="grid md:grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-bold mb-1">AF Code (e.g. AF355)</label>
                  <input 
                    type="text" 
                    value={form.afCode || ''} 
                    onChange={e => setForm({ ...form, afCode: e.target.value })}
                    className="w-full border-2 px-3 py-2 rounded-lg"
                    placeholder="e.g., AF355"
                  />
                </div>
                <div>
                  <label className="block text-sm font-bold mb-1">Phone</label>
                  <input 
                    type="tel" 
                    value={form.phone} 
                    onChange={e => setForm({ ...form, phone: e.target.value })}
                    className="w-full border-2 px-3 py-2 rounded-lg"
                    placeholder="e.g., 9876543210"
                  />
                </div>
              </div>

              <div className="grid md:grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-bold mb-1">WhatsApp Number</label>
                  <input 
                    type="tel" 
                    value={form.whatsapp || ''} 
                    onChange={e => setForm({ ...form, whatsapp: e.target.value })}
                    className="w-full border-2 px-3 py-2 rounded-lg"
                    placeholder="e.g., 9876543210"
                  />
                </div>
                <div>
                  <label className="block text-sm font-bold mb-1">üéÇ Date of Birth</label>
                  <input 
                    type="date" 
                    value={form.dateOfBirth || ''} 
                    onChange={e => setForm({ ...form, dateOfBirth: e.target.value })}
                    className="w-full border-2 px-3 py-2 rounded-lg"
                  />
                  <p className="text-xs text-gray-500 mt-1">For birthday celebrations</p>
                </div>
              </div>

              <div className="grid md:grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-bold mb-1">üìÖ Joining Date</label>
                  <input 
                    type="date" 
                    value={form.joiningDate || ''} 
                    onChange={e => setForm({ ...form, joiningDate: e.target.value })}
                    className="w-full border-2 px-3 py-2 rounded-lg"
                  />
                  <p className="text-xs text-gray-500 mt-1">For work anniversary celebrations</p>
                </div>
                <div>
                  <label className="block text-sm font-bold mb-1">üì∑ Profile Photo</label>
                  <div className="flex items-center gap-3">
                    {form.profilePhoto && (
                      <img src={form.profilePhoto} alt="" className="w-14 h-14 rounded-full object-cover border-2 border-pink-300" />
                    )}
                    <div className="flex-1">
                      <input
                        type="file"
                        accept="image/jpeg,image/png,image/webp"
                        onChange={handleManagerPhotoUpload}
                        className="w-full text-sm border-2 px-2 py-1.5 rounded-lg"
                        disabled={uploadingPhoto}
                      />
                      {uploadingPhoto && <p className="text-xs text-blue-600 mt-1">‚è≥ Uploading...</p>}
                    </div>
                  </div>
                  <p className="text-xs text-gray-500 mt-1">Max 1MB, JPG/PNG/WebP</p>
                </div>
              </div>

              <div className="grid md:grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-bold mb-1">Role *</label>
                  <select 
                    value={form.role} 
                    onChange={e => setForm({ ...form, role: e.target.value, reportsTo: '' })}
                    className="w-full border-2 px-3 py-2 rounded-lg"
                  >
                    <option value={MANAGER_ROLES.DIRECTOR}>Director (View Only)</option>
                    <option value={MANAGER_ROLES.ASSOC_DIRECTOR}>Associate Director (View Only)</option>
                    <option value={MANAGER_ROLES.TRAINING}>Training Department (View Only)</option>
                    <option value={MANAGER_ROLES.APH}>Program Head (PH)</option>
                    <option value={MANAGER_ROLES.PM}>Program Manager (PM)</option>
                    <option value={MANAGER_ROLES.APM}>Associate Program Manager (APM)</option>
                  </select>
                  {(form.role === 'director' || form.role === 'assoc_director' || form.role === 'training') && (
                    <p className="text-xs text-blue-600 mt-1">‚ö†Ô∏è This role has view-only access to all data. They cannot approve timesheets.</p>
                  )}
                </div>
              </div>

              {(form.role === MANAGER_ROLES.PM || form.role === MANAGER_ROLES.APM) && (
                <div>
                  <label className="block text-sm font-bold mb-1">
                    Reports To ({form.role === MANAGER_ROLES.PM ? 'PH' : 'PM'}) *
                  </label>
                  <select 
                    value={form.reportsTo} 
                    onChange={e => setForm({ ...form, reportsTo: e.target.value })}
                    className="w-full border-2 px-3 py-2 rounded-lg"
                  >
                    <option value="">Select {form.role === MANAGER_ROLES.PM ? 'Program Head' : 'Program Manager'}</option>
                    {getReportsToOptions(form.role).map(m => (
                      <option key={m.id} value={m.id}>{m.name} ({ROLE_LABELS[m.role]})</option>
                    ))}
                  </select>
                  <p className="text-xs text-gray-600 mt-1">
                    {form.role === MANAGER_ROLES.PM 
                      ? 'The PH will see all schools assigned to this PM and their APMs'
                      : 'The PM will see all schools assigned to this APM'}
                  </p>
                </div>
              )}

              {/* Directors/Training have access to all schools, so no need to select */}
              {(form.role === 'director' || form.role === 'assoc_director' || form.role === 'training') ? (
                <div className="bg-blue-50 border-2 border-blue-200 rounded-lg p-4">
                  <p className="text-blue-700 font-semibold">üìä All Schools Access</p>
                  <p className="text-sm text-blue-600 mt-1">This role has view-only access to all schools. No need to assign specific schools.</p>
                </div>
              ) : (
              <div>
                <label className="block text-sm font-bold mb-2">Assign Schools *</label>
                <div className="border-2 rounded-lg p-3 max-h-48 overflow-y-auto">
                  {allSchools.map(school => (
                    <label key={school} className="flex items-center gap-2 p-2 hover:bg-gray-50 cursor-pointer">
                      <input 
                        type="checkbox"
                        checked={form.directSchools.includes(school)}
                        onChange={() => toggleSchoolSelection(school)}
                        className="cursor-pointer"
                      />
                      <span>{school}</span>
                    </label>
                  ))}
                  {allSchools.length === 0 && (
                    <p className="text-gray-500 text-center py-4">No schools available. Add schools first.</p>
                  )}
                </div>
                <p className="text-xs text-gray-600 mt-1">Selected: {form.directSchools.length} school(s)</p>
              </div>
              )}

              <div className="flex gap-3">
                <button onClick={handleSubmit} className="flex-1 avanti-gradient text-white py-3 rounded-xl font-bold">
                  {editingManager ? 'Update' : 'Add Staff Member'}
                </button>
                <button onClick={() => setShowModal(false)} className="px-6 py-3 bg-gray-200 rounded-xl font-bold">Cancel</button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Manage Schools Modal */}
      {showSchoolModal && (
        <div className="modal-overlay" onClick={() => setShowSchoolModal(false)}>
          <div className="modal-content" onClick={e => e.stopPropagation()}>
            <h3 className="text-2xl font-bold mb-4">üè´ Manage Schools</h3>
            
            <div className="mb-4">
              <label className="block text-sm font-bold mb-2">Add New School</label>
              <div className="flex gap-2">
                <input 
                  type="text"
                  value={newSchoolName}
                  onChange={e => setNewSchoolName(e.target.value)}
                  placeholder="e.g., JNV Mumbai"
                  className="flex-1 border-2 px-3 py-2 rounded-lg"
                />
                <button onClick={handleAddSchool} className="px-4 py-2 bg-green-600 text-white rounded-lg font-semibold">Add</button>
              </div>
            </div>

            <div>
              <label className="block text-sm font-bold mb-2">Current Schools ({allSchools.length})</label>
              <div className="border-2 rounded-lg max-h-64 overflow-y-auto">
                {allSchools.map(school => (
                  <div key={school} className="flex items-center justify-between p-3 border-b hover:bg-gray-50">
                    <span className="font-medium">üè´ {school}</span>
                    <button onClick={() => handleRemoveSchool(school)} className="px-3 py-1 bg-red-100 text-red-600 rounded-lg text-sm font-semibold hover:bg-red-200">Remove</button>
                  </div>
                ))}
                {allSchools.length === 0 && <p className="text-gray-500 text-center py-4">No schools added yet.</p>}
              </div>
            </div>

            <button onClick={() => setShowSchoolModal(false)} className="w-full mt-4 px-6 py-3 bg-gray-200 rounded-xl font-bold">Close</button>
          </div>
        </div>
      )}
    </div>
  );
}

// ========================================
// APC MANAGEMENT COMPONENT
// ========================================
function APCManagement() {
  const [apcs, setApcs] = useState([]);
  const [showModal, setShowModal] = useState(false);
  const [editingApc, setEditingApc] = useState(null);
  const [loading, setLoading] = useState(true);
  const [form, setForm] = useState({
    name: '',
    email: '',
    phone: '',
    school: ''
  });

  // Fetch APCs on mount
  useEffect(() => {
    const fetchApcs = async () => {
      try {
        const snapshot = await db.collection('apcs').get();
        setApcs(snapshot.docs.map(d => ({ ...d.data(), id: d.id })));
      } catch (e) {
        console.error('Error fetching APCs:', e);
      }
      setLoading(false);
    };
    fetchApcs();
  }, []);

  const resetForm = () => {
    setForm({ name: '', email: '', phone: '', school: '' });
    setEditingApc(null);
  };

  const handleSubmit = async () => {
    if (!form.name || !form.email || !form.school) {
      alert('Please fill in all required fields (Name, Email, School)');
      return;
    }

    // Validate email format
    if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(form.email)) {
      alert('Please enter a valid email address');
      return;
    }

    try {
      if (editingApc) {
        // Update existing APC
        await db.collection('apcs').doc(editingApc.id).update({
          name: form.name,
          email: form.email.toLowerCase().trim(),
          phone: form.phone,
          school: form.school,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        setApcs(apcs.map(a => a.id === editingApc.id ? { ...a, ...form, email: form.email.toLowerCase().trim() } : a));
        alert('‚úÖ APC updated successfully!');
      } else {
        // Check if email already exists
        const existingEmail = await db.collection('apcs').where('email', '==', form.email.toLowerCase().trim()).get();
        if (!existingEmail.empty) {
          alert('An APC with this email already exists');
          return;
        }
        
        // Add new APC
        const docRef = await db.collection('apcs').add({
          name: form.name,
          email: form.email.toLowerCase().trim(),
          phone: form.phone,
          school: form.school,
          status: 'active',
          role: 'apc',
          userType: 'apc',
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        setApcs([...apcs, { id: docRef.id, ...form, email: form.email.toLowerCase().trim(), status: 'active' }]);
        alert(`‚úÖ APC added successfully!\n\nName: ${form.name}\nEmail: ${form.email}\nSchool: ${form.school}\n\nNote: The APC can login using Firebase Auth. Make sure their account is created in Firebase Authentication.`);
      }
      setShowModal(false);
      resetForm();
    } catch (e) {
      console.error('Error saving APC:', e);
      alert('Error saving APC: ' + e.message);
    }
  };

  const handleEdit = (apc) => {
    setForm({
      name: apc.name || '',
      email: apc.email || '',
      phone: apc.phone || '',
      school: apc.school || ''
    });
    setEditingApc(apc);
    setShowModal(true);
  };

  const handleToggleStatus = async (apc) => {
    const newStatus = apc.status === 'active' ? 'inactive' : 'active';
    if (!confirm(`${newStatus === 'inactive' ? 'Deactivate' : 'Activate'} ${apc.name}?`)) return;
    
    try {
      await db.collection('apcs').doc(apc.id).update({
        status: newStatus,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      setApcs(apcs.map(a => a.id === apc.id ? { ...a, status: newStatus } : a));
      alert(`‚úÖ APC ${newStatus === 'active' ? 'activated' : 'deactivated'} successfully!`);
    } catch (e) {
      console.error('Error updating status:', e);
      alert('Error updating status: ' + e.message);
    }
  };

  const handleDelete = async (apc) => {
    if (!confirm(`‚ö†Ô∏è Delete ${apc.name}? This action cannot be undone.`)) return;
    
    try {
      await db.collection('apcs').doc(apc.id).delete();
      setApcs(apcs.filter(a => a.id !== apc.id));
      alert('‚úÖ APC deleted successfully!');
    } catch (e) {
      console.error('Error deleting APC:', e);
      alert('Error deleting APC: ' + e.message);
    }
  };

  const activeApcs = apcs.filter(a => a.status === 'active');
  const inactiveApcs = apcs.filter(a => a.status === 'inactive');

  if (loading) {
    return (
      <div className="flex items-center justify-center p-12">
        <div className="text-xl">Loading APCs...</div>
      </div>
    );
  }

  return (
    <div className="space-y-6">
      <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div>
          <h2 className="text-3xl font-bold">üìã APC Management</h2>
          <p className="text-gray-600 mt-1">Manage Academic Program Coordinators</p>
        </div>
        <button
          onClick={() => { resetForm(); setShowModal(true); }}
          className="px-6 py-3 bg-teal-600 text-white rounded-xl font-bold hover:bg-teal-700 transition"
        >
          ‚ûï Add New APC
        </button>
      </div>

      {/* Info Card */}
      <div className="bg-teal-50 border-2 border-teal-200 rounded-2xl p-6">
        <h3 className="text-lg font-bold text-teal-800 mb-2">‚ÑπÔ∏è About APCs</h3>
        <p className="text-teal-700 text-sm">
          Academic Program Coordinators (APCs) have school-level access to:
        </p>
        <ul className="mt-2 text-teal-700 text-sm space-y-1">
          <li>‚úÖ View syllabus/curriculum progress (all subjects)</li>
          <li>‚úÖ Mark student attendance</li>
          <li>‚úÖ View teacher attendance</li>
          <li>‚úÖ View analytics and dashboards</li>
          <li>‚ùå Cannot edit curriculum or chapters</li>
          <li>‚ùå Cannot add/edit teachers or students</li>
        </ul>
      </div>

      {/* Stats */}
      <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
        <div className="bg-white p-4 rounded-xl shadow text-center">
          <div className="text-3xl font-bold text-teal-600">{apcs.length}</div>
          <div className="text-sm text-gray-600">Total APCs</div>
        </div>
        <div className="bg-green-50 p-4 rounded-xl shadow text-center">
          <div className="text-3xl font-bold text-green-600">{activeApcs.length}</div>
          <div className="text-sm text-gray-600">Active</div>
        </div>
        <div className="bg-gray-50 p-4 rounded-xl shadow text-center">
          <div className="text-3xl font-bold text-gray-600">{inactiveApcs.length}</div>
          <div className="text-sm text-gray-600">Inactive</div>
        </div>
      </div>

      {/* APCs List */}
      <div className="bg-white rounded-2xl shadow-lg overflow-hidden">
        <table className="w-full">
          <thead className="bg-gray-100">
            <tr>
              <th className="p-4 text-left">Name</th>
              <th className="p-4 text-left">Email</th>
              <th className="p-4 text-left">School</th>
              <th className="p-4 text-left">Phone</th>
              <th className="p-4 text-left">Status</th>
              <th className="p-4 text-left">Actions</th>
            </tr>
          </thead>
          <tbody>
            {apcs.length === 0 ? (
              <tr>
                <td colSpan="6" className="p-8 text-center text-gray-500">
                  No APCs added yet. Click "Add New APC" to get started.
                </td>
              </tr>
            ) : (
              apcs.map(apc => (
                <tr key={apc.id} className={`border-b hover:bg-gray-50 ${apc.status === 'inactive' ? 'opacity-50' : ''}`}>
                  <td className="p-4">
                    <div className="font-semibold">{apc.name}</div>
                  </td>
                  <td className="p-4 text-sm">{apc.email}</td>
                  <td className="p-4">
                    <span className="px-3 py-1 bg-teal-100 text-teal-700 rounded-full text-sm font-semibold">
                      {apc.school}
                    </span>
                  </td>
                  <td className="p-4 text-sm">{apc.phone || '‚Äî'}</td>
                  <td className="p-4">
                    <span className={`px-3 py-1 rounded-full text-sm font-semibold ${
                      apc.status === 'active' ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-600'
                    }`}>
                      {apc.status === 'active' ? '‚úÖ Active' : '‚è∏Ô∏è Inactive'}
                    </span>
                  </td>
                  <td className="p-4">
                    <div className="flex gap-2">
                      <button
                        onClick={() => handleEdit(apc)}
                        className="px-3 py-1 bg-blue-100 text-blue-700 rounded-lg text-sm font-semibold hover:bg-blue-200"
                      >
                        ‚úèÔ∏è Edit
                      </button>
                      <button
                        onClick={() => handleToggleStatus(apc)}
                        className={`px-3 py-1 rounded-lg text-sm font-semibold ${
                          apc.status === 'active' 
                            ? 'bg-orange-100 text-orange-700 hover:bg-orange-200' 
                            : 'bg-green-100 text-green-700 hover:bg-green-200'
                        }`}
                      >
                        {apc.status === 'active' ? '‚è∏Ô∏è Deactivate' : '‚ñ∂Ô∏è Activate'}
                      </button>
                      <button
                        onClick={() => handleDelete(apc)}
                        className="px-3 py-1 bg-red-100 text-red-700 rounded-lg text-sm font-semibold hover:bg-red-200"
                      >
                        üóëÔ∏è
                      </button>
                    </div>
                  </td>
                </tr>
              ))
            )}
          </tbody>
        </table>
      </div>

      {/* Add/Edit Modal */}
      {showModal && (
        <div className="modal-overlay" onClick={() => setShowModal(false)}>
          <div className="modal-content" onClick={e => e.stopPropagation()}>
            <h3 className="text-2xl font-bold mb-4">
              {editingApc ? '‚úèÔ∏è Edit APC' : '‚ûï Add New APC'}
            </h3>

            <div className="space-y-4">
              <div>
                <label className="block text-sm font-bold mb-2">Name *</label>
                <input
                  type="text"
                  value={form.name}
                  onChange={e => setForm({ ...form, name: e.target.value })}
                  placeholder="e.g., Ramesh Kumar"
                  className="w-full border-2 px-4 py-3 rounded-xl"
                />
              </div>

              <div>
                <label className="block text-sm font-bold mb-2">Email *</label>
                <input
                  type="email"
                  value={form.email}
                  onChange={e => setForm({ ...form, email: e.target.value })}
                  placeholder="e.g., ramesh@example.com"
                  className="w-full border-2 px-4 py-3 rounded-xl"
                />
                <p className="text-xs text-gray-600 mt-1">
                  This email must be registered in Firebase Authentication for login
                </p>
              </div>

              <div>
                <label className="block text-sm font-bold mb-2">Phone</label>
                <input
                  type="tel"
                  value={form.phone}
                  onChange={e => setForm({ ...form, phone: e.target.value })}
                  placeholder="e.g., 9876543210"
                  className="w-full border-2 px-4 py-3 rounded-xl"
                />
              </div>

              <div>
                <label className="block text-sm font-bold mb-2">School *</label>
                <select
                  value={form.school}
                  onChange={e => setForm({ ...form, school: e.target.value })}
                  className="w-full border-2 px-4 py-3 rounded-xl"
                >
                  <option value="">Select School</option>
                  {SCHOOLS.map(school => (
                    <option key={school} value={school}>{school}</option>
                  ))}
                </select>
              </div>

              <div className="flex gap-3 pt-4">
                <button
                  onClick={handleSubmit}
                  className="flex-1 bg-teal-600 text-white py-3 rounded-xl font-bold hover:bg-teal-700"
                >
                  {editingApc ? 'üíæ Update APC' : '‚ûï Add APC'}
                </button>
                <button
                  onClick={() => { setShowModal(false); resetForm(); }}
                  className="px-6 py-3 bg-gray-200 rounded-xl font-bold"
                >
                  Cancel
                </button>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

// ========================================
// ACADEMIC YEAR MANAGEMENT COMPONENT
// ========================================
function AcademicYearManagement({ teachers, students, curriculum, chapterProgress, studentAttendance, teacherAttendance, academicYearSettings }) {
  const [currentAY, setCurrentAY] = useState(academicYearSettings?.currentYear || CURRENT_ACADEMIC_YEAR);
  const [isTransitioning, setIsTransitioning] = useState(false);
  const [transitionProgress, setTransitionProgress] = useState(0);
  const [transitionLog, setTransitionLog] = useState([]);
  const [showConfirmModal, setShowConfirmModal] = useState(false);
  const [newAcademicYear, setNewAcademicYear] = useState('');
  const [archivedYears, setArchivedYears] = useState([]);

  useEffect(() => {
    // Fetch archived years
    const fetchArchived = async () => {
      const archiveSnap = await db.collection('archives').get();
      const years = [...new Set(archiveSnap.docs.map(d => d.data().academicYear))].filter(Boolean);
      setArchivedYears(years);
    };
    fetchArchived();
  }, []);

  // Calculate next academic year
  const getNextAcademicYear = () => {
    const parts = currentAY.split('-');
    const startYear = parseInt(parts[0]) + 1;
    return `${startYear}-${startYear + 1}`;
  };

  // Count students by grade
  const studentsByGrade = useMemo(() => {
    const counts = { '11': 0, '12': 0 };
    students.forEach(s => {
      if (s.grade === '11' || s.grade === 11) counts['11']++;
      if (s.grade === '12' || s.grade === 12) counts['12']++;
    });
    return counts;
  }, [students]);

  const addLog = (message) => {
    setTransitionLog(prev => [...prev, `${new Date().toLocaleTimeString()} - ${message}`]);
  };

  const startTransition = async () => {
    if (!newAcademicYear || !newAcademicYear.match(/^\d{4}-\d{4}$/)) {
      alert('Please enter a valid academic year (e.g., 2025-2026)');
      return;
    }

    setShowConfirmModal(false);
    setIsTransitioning(true);
    setTransitionProgress(0);
    setTransitionLog([]);

    try {
      addLog('üöÄ Starting academic year transition...');
      addLog(`üìÖ From: ${currentAY} ‚Üí To: ${newAcademicYear}`);

      // Step 1: Archive Curriculum Progress (10%)
      addLog('üìö Step 1: Archiving curriculum progress...');
      setTransitionProgress(5);
      
      const progressSnap = await db.collection('chapterProgress').get();
      const batch1 = db.batch();
      let progressCount = 0;
      
      progressSnap.docs.forEach(doc => {
        const archiveRef = db.collection('archives').doc(`chapterProgress_${currentAY}_${doc.id}`);
        batch1.set(archiveRef, {
          ...doc.data(),
          academicYear: currentAY,
          archivedAt: new Date().toISOString(),
          originalDocId: doc.id,
          type: 'chapterProgress'
        });
        progressCount++;
      });
      await batch1.commit();
      addLog(`‚úÖ Archived ${progressCount} curriculum progress records`);
      setTransitionProgress(15);

      // Step 2: Archive Student Attendance (20%)
      addLog('üìä Step 2: Archiving student attendance...');
      const studentAttSnap = await db.collection('studentAttendance').get();
      const batch2 = db.batch();
      let studentAttCount = 0;
      
      studentAttSnap.docs.forEach(doc => {
        const archiveRef = db.collection('archives').doc(`studentAttendance_${currentAY}_${doc.id}`);
        batch2.set(archiveRef, {
          ...doc.data(),
          academicYear: currentAY,
          archivedAt: new Date().toISOString(),
          originalDocId: doc.id,
          type: 'studentAttendance'
        });
        studentAttCount++;
      });
      await batch2.commit();
      addLog(`‚úÖ Archived ${studentAttCount} student attendance records`);
      setTransitionProgress(30);

      // Step 3: Archive Teacher Attendance (30%)
      addLog('üë• Step 3: Archiving teacher attendance...');
      const teacherAttSnap = await db.collection('teacherAttendance').get();
      const batch3 = db.batch();
      let teacherAttCount = 0;
      
      teacherAttSnap.docs.forEach(doc => {
        const archiveRef = db.collection('archives').doc(`teacherAttendance_${currentAY}_${doc.id}`);
        batch3.set(archiveRef, {
          ...doc.data(),
          academicYear: currentAY,
          archivedAt: new Date().toISOString(),
          originalDocId: doc.id,
          type: 'teacherAttendance'
        });
        teacherAttCount++;
      });
      await batch3.commit();
      addLog(`‚úÖ Archived ${teacherAttCount} teacher attendance records`);
      setTransitionProgress(40);

      // Step 4: Archive Student Feedback (40%)
      addLog('üí¨ Step 4: Archiving student feedback...');
      const feedbackSnap = await db.collection('teacherFeedback').get();
      const batch4 = db.batch();
      let feedbackCount = 0;
      
      feedbackSnap.docs.forEach(doc => {
        const archiveRef = db.collection('archives').doc(`teacherFeedback_${currentAY}_${doc.id}`);
        batch4.set(archiveRef, {
          ...doc.data(),
          academicYear: currentAY,
          archivedAt: new Date().toISOString(),
          originalDocId: doc.id,
          type: 'teacherFeedback'
        });
        feedbackCount++;
      });
      await batch4.commit();
      addLog(`‚úÖ Archived ${feedbackCount} feedback records`);
      setTransitionProgress(50);

      // Step 5: Archive Exam Registrations (50%)
      addLog('üìù Step 5: Archiving exam registrations...');
      const examSnap = await db.collection('studentExamRegistrations').get();
      const batch5 = db.batch();
      let examCount = 0;
      
      examSnap.docs.forEach(doc => {
        const archiveRef = db.collection('archives').doc(`examRegistrations_${currentAY}_${doc.id}`);
        batch5.set(archiveRef, {
          ...doc.data(),
          academicYear: currentAY,
          archivedAt: new Date().toISOString(),
          originalDocId: doc.id,
          type: 'examRegistrations'
        });
        examCount++;
      });
      await batch5.commit();
      addLog(`‚úÖ Archived ${examCount} exam registration records`);
      setTransitionProgress(60);

      // Step 6: Save Teacher History (60%)
      addLog('üìà Step 6: Saving teacher performance history...');
      const teachersSnap = await db.collection('teachers').get();
      const batch6 = db.batch();
      
      for (const teacherDoc of teachersSnap.docs) {
        const teacher = teacherDoc.data();
        
        // Calculate teacher metrics for this year
        const teacherProgress = progressSnap.docs.filter(p => {
          const data = p.data();
          return data.school === teacher.school && data.subject === teacher.subject;
        });
        
        const totalChapters = teacherProgress.length;
        const completedChapters = teacherProgress.filter(p => p.data().completed === 'Yes').length;
        const onTimeChapters = teacherProgress.filter(p => {
          const data = p.data();
          if (data.completed !== 'Yes') return false;
          const completed = new Date(data.completedDate);
          const expected = new Date(data.expectedDate);
          return completed <= expected;
        }).length;
        
        // Get feedback for this teacher
        const teacherFeedback = feedbackSnap.docs.filter(f => f.data().teacherAfid === teacher.afid);
        const avgRating = teacherFeedback.length > 0 
          ? teacherFeedback.reduce((sum, f) => sum + (f.data().rating || 0), 0) / teacherFeedback.length 
          : 0;
        
        // Get attendance
        const teacherAtt = teacherAttSnap.docs.filter(a => a.data().afid === teacher.afid);
        const presentDays = teacherAtt.filter(a => a.data().status === 'Present').length;
        const totalWorkDays = teacherAtt.length;
        
        const historyRef = db.collection('teacherHistory').doc(`${teacher.afid}_${currentAY}`);
        batch6.set(historyRef, {
          afid: teacher.afid,
          name: teacher.name,
          email: teacher.email,
          school: teacher.school,
          subject: teacher.subject,
          academicYear: currentAY,
          metrics: {
            totalChapters,
            completedChapters,
            completionRate: totalChapters > 0 ? Math.round((completedChapters / totalChapters) * 100) : 0,
            onTimeChapters,
            onTimeRate: completedChapters > 0 ? Math.round((onTimeChapters / completedChapters) * 100) : 0,
            delayedChapters: completedChapters - onTimeChapters,
            feedbackCount: teacherFeedback.length,
            avgFeedbackRating: Math.round(avgRating * 10) / 10,
            presentDays,
            totalWorkDays,
            attendanceRate: totalWorkDays > 0 ? Math.round((presentDays / totalWorkDays) * 100) : 0
          },
          savedAt: new Date().toISOString()
        });
      }
      await batch6.commit();
      addLog(`‚úÖ Saved history for ${teachersSnap.docs.length} teachers`);
      setTransitionProgress(70);

      // Step 7: Promote 11th ‚Üí 12th (70%)
      addLog('üéì Step 7: Promoting 11th grade to 12th...');
      const studentsSnap = await db.collection('students').get();
      const batch7 = db.batch();
      let promoted11to12 = 0;
      
      studentsSnap.docs.forEach(doc => {
        const student = doc.data();
        if (student.grade === '11' || student.grade === 11) {
          batch7.update(doc.ref, { 
            grade: '12',
            previousGrade: '11',
            promotedAt: new Date().toISOString(),
            promotedInYear: newAcademicYear
          });
          promoted11to12++;
        }
      });
      await batch7.commit();
      addLog(`‚úÖ Promoted ${promoted11to12} students from 11th to 12th`);
      setTransitionProgress(80);

      // Step 8: Move 12th ‚Üí Alumni (80%)
      addLog('üéì Step 8: Moving 12th grade to Alumni...');
      const batch8 = db.batch();
      let movedToAlumni = 0;
      
      studentsSnap.docs.forEach(doc => {
        const student = doc.data();
        if (student.grade === '12' || student.grade === 12) {
          // Create alumni record
          const alumniRef = db.collection('alumni').doc(doc.id);
          batch8.set(alumniRef, {
            ...student,
            grade: 'Alumni',
            graduatedYear: currentAY,
            movedToAlumniAt: new Date().toISOString(),
            status: 'alumni'
          });
          // Delete from active students
          batch8.delete(doc.ref);
          movedToAlumni++;
        }
      });
      await batch8.commit();
      addLog(`‚úÖ Moved ${movedToAlumni} students to Alumni`);
      setTransitionProgress(90);

      // Step 9: Clear current year data (90%)
      addLog('üßπ Step 9: Clearing current year operational data...');
      
      // Clear chapter progress for fresh start
      const batch9 = db.batch();
      progressSnap.docs.forEach(doc => {
        batch9.delete(doc.ref);
      });
      await batch9.commit();
      addLog('‚úÖ Cleared chapter progress for fresh start');
      
      // Clear attendance for new year
      const batch10 = db.batch();
      studentAttSnap.docs.forEach(doc => batch10.delete(doc.ref));
      teacherAttSnap.docs.forEach(doc => batch10.delete(doc.ref));
      await batch10.commit();
      addLog('‚úÖ Cleared attendance records');
      
      // Clear feedback
      const batch11 = db.batch();
      feedbackSnap.docs.forEach(doc => batch11.delete(doc.ref));
      await batch11.commit();
      addLog('‚úÖ Cleared feedback records');
      
      setTransitionProgress(95);

      // Step 10: Update system settings (100%)
      addLog('‚öôÔ∏è Step 10: Updating system settings...');
      await db.collection('system').doc('academicYear').set({
        currentYear: newAcademicYear,
        previousYear: currentAY,
        transitionDate: new Date().toISOString(),
        transitionBy: 'admin@avantifellows.org'
      });
      
      setTransitionProgress(100);
      addLog('üéâ Academic year transition completed successfully!');
      addLog(`üìÖ Current academic year is now: ${newAcademicYear}`);
      
      setTimeout(() => {
        alert(`‚úÖ Academic Year Transition Complete!\n\nFrom: ${currentAY}\nTo: ${newAcademicYear}\n\nSummary:\n‚Ä¢ ${progressCount} curriculum records archived\n‚Ä¢ ${studentAttCount + teacherAttCount} attendance records archived\n‚Ä¢ ${feedbackCount} feedback records archived\n‚Ä¢ ${promoted11to12} students promoted to 12th\n‚Ä¢ ${movedToAlumni} students moved to Alumni\n\nPlease refresh the page.`);
        window.location.reload();
      }, 2000);

    } catch (error) {
      console.error('Transition error:', error);
      addLog(`‚ùå Error: ${error.message}`);
      alert('Transition failed: ' + error.message);
    } finally {
      setIsTransitioning(false);
    }
  };

  return (
    <div className="space-y-6">
      <div className="flex justify-between items-center flex-wrap gap-4">
        <h2 className="text-3xl font-bold">üìÖ Academic Year Management</h2>
      </div>

      {/* Current Status */}
      <div className="bg-white p-6 rounded-2xl shadow-lg">
        <h3 className="text-xl font-bold mb-4">üìä Current Status</h3>
        <div className="grid md:grid-cols-4 gap-4">
          <div className="bg-blue-50 p-4 rounded-xl border-2 border-blue-200">
            <div className="text-3xl font-bold text-blue-600">{currentAY}</div>
            <div className="text-sm text-blue-700">Current Academic Year</div>
          </div>
          <div className="bg-green-50 p-4 rounded-xl border-2 border-green-200">
            <div className="text-3xl font-bold text-green-600">{studentsByGrade['11']}</div>
            <div className="text-sm text-green-700">11th Grade Students</div>
          </div>
          <div className="bg-orange-50 p-4 rounded-xl border-2 border-orange-200">
            <div className="text-3xl font-bold text-orange-600">{studentsByGrade['12']}</div>
            <div className="text-sm text-orange-700">12th Grade Students</div>
          </div>
          <div className="bg-purple-50 p-4 rounded-xl border-2 border-purple-200">
            <div className="text-3xl font-bold text-purple-600">{teachers.length}</div>
            <div className="text-sm text-purple-700">Active Teachers</div>
          </div>
        </div>
      </div>

      {/* Transition Section */}
      <div className="bg-white p-6 rounded-2xl shadow-lg">
        <h3 className="text-xl font-bold mb-4">üîÑ Start New Academic Year</h3>
        
        <div className="bg-yellow-50 border-2 border-yellow-200 rounded-xl p-4 mb-4">
          <div className="font-bold text-yellow-800 mb-2">‚ö†Ô∏è Important: This action will:</div>
          <ul className="text-sm text-yellow-700 space-y-1">
            <li>‚úÖ Archive all curriculum progress, attendance, feedback, and exam data</li>
            <li>‚úÖ Save teacher performance history for the current year</li>
            <li>‚úÖ Promote 11th grade students to 12th grade ({studentsByGrade['11']} students)</li>
            <li>‚úÖ Move 12th grade students to Alumni ({studentsByGrade['12']} students)</li>
            <li>‚úÖ Clear operational data for fresh start</li>
            <li>‚ùå Teachers and their profiles will remain unchanged</li>
          </ul>
        </div>

        <div className="flex items-end gap-4 flex-wrap">
          <div className="flex-1 min-w-64">
            <label className="block text-sm font-bold mb-2">New Academic Year *</label>
            <input 
              type="text"
              value={newAcademicYear}
              onChange={e => setNewAcademicYear(e.target.value)}
              placeholder={getNextAcademicYear()}
              className="w-full border-2 px-4 py-3 rounded-xl text-lg"
              disabled={isTransitioning}
            />
            <p className="text-xs text-gray-500 mt-1">Format: YYYY-YYYY (e.g., {getNextAcademicYear()})</p>
          </div>
          <button 
            onClick={() => setShowConfirmModal(true)}
            disabled={isTransitioning || !newAcademicYear}
            className={`px-8 py-3 rounded-xl font-bold text-white ${
              isTransitioning ? 'bg-gray-400' : 'bg-red-600 hover:bg-red-700'
            }`}
          >
            {isTransitioning ? '‚è≥ Processing...' : 'üöÄ Start Transition'}
          </button>
        </div>
      </div>

      {/* Progress Section */}
      {isTransitioning && (
        <div className="bg-white p-6 rounded-2xl shadow-lg">
          <h3 className="text-xl font-bold mb-4">üìà Transition Progress</h3>
          <div className="mb-4">
            <div className="flex justify-between mb-2">
              <span className="font-semibold">Progress</span>
              <span className="font-bold">{transitionProgress}%</span>
            </div>
            <div className="w-full bg-gray-200 rounded-full h-4">
              <div 
                className="bg-green-500 h-4 rounded-full transition-all duration-500"
                style={{ width: `${transitionProgress}%` }}
              ></div>
            </div>
          </div>
          <div className="bg-gray-900 text-green-400 p-4 rounded-xl font-mono text-sm max-h-64 overflow-y-auto">
            {transitionLog.map((log, i) => (
              <div key={i}>{log}</div>
            ))}
          </div>
        </div>
      )}

      {/* Archive History */}
      <div className="bg-white p-6 rounded-2xl shadow-lg">
        <h3 className="text-xl font-bold mb-4">üìö Archived Academic Years</h3>
        {archivedYears.length === 0 ? (
          <p className="text-gray-500">No archived years yet.</p>
        ) : (
          <div className="flex flex-wrap gap-3">
            {archivedYears.map(year => (
              <div key={year} className="px-4 py-2 bg-gray-100 rounded-xl font-semibold">
                üìÖ {year}
              </div>
            ))}
          </div>
        )}
      </div>

      {/* Confirm Modal */}
      {showConfirmModal && (
        <div className="modal-overlay" onClick={() => setShowConfirmModal(false)}>
          <div className="modal-content max-w-lg" onClick={e => e.stopPropagation()}>
            <h3 className="text-2xl font-bold mb-4 text-red-600">‚ö†Ô∏è Confirm Academic Year Transition</h3>
            <div className="space-y-4">
              <p className="font-semibold">You are about to transition from:</p>
              <div className="text-center text-2xl font-bold">
                {currentAY} ‚Üí {newAcademicYear}
              </div>
              
              <div className="bg-red-50 border border-red-200 rounded-lg p-4 text-sm">
                <div className="font-bold text-red-700 mb-2">This action cannot be undone!</div>
                <ul className="text-red-600 space-y-1">
                  <li>‚Ä¢ All current year data will be archived</li>
                  <li>‚Ä¢ {studentsByGrade['11']} students will be promoted to 12th</li>
                  <li>‚Ä¢ {studentsByGrade['12']} students will become alumni</li>
                  <li>‚Ä¢ Operational data will be cleared</li>
                </ul>
              </div>

              <div className="flex gap-3">
                <button 
                  onClick={startTransition}
                  className="flex-1 bg-red-600 text-white py-3 rounded-xl font-bold hover:bg-red-700"
                >
                  Yes, Start Transition
                </button>
                <button 
                  onClick={() => setShowConfirmModal(false)}
                  className="flex-1 bg-gray-200 py-3 rounded-xl font-bold"
                >
                  Cancel
                </button>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

// ========================================
// TEACHER HISTORY COMPONENT
// ========================================
function TeacherHistoryView({ teachers }) {
  const [selectedTeacher, setSelectedTeacher] = useState(null);
  const [teacherHistory, setTeacherHistory] = useState([]);
  const [loading, setLoading] = useState(false);
  const [searchQuery, setSearchQuery] = useState('');
  const [selectedSchool, setSelectedSchool] = useState('All');

  const filteredTeachers = teachers.filter(t => {
    if (selectedSchool !== 'All' && t.school !== selectedSchool) return false;
    if (searchQuery && !t.name?.toLowerCase().includes(searchQuery.toLowerCase())) return false;
    return true;
  });

  const loadTeacherHistory = async (teacher) => {
    setSelectedTeacher(teacher);
    setLoading(true);
    try {
      const historySnap = await db.collection('teacherHistory')
        .where('afid', '==', teacher.afid)
        .orderBy('academicYear', 'desc')
        .get();
      
      setTeacherHistory(historySnap.docs.map(d => d.data()));
    } catch (e) {
      console.error('Error loading history:', e);
      setTeacherHistory([]);
    }
    setLoading(false);
  };

  return (
    <div className="space-y-6">
      <h2 className="text-3xl font-bold">üìà Teacher Performance History</h2>

      {/* Filters */}
      <div className="bg-white p-6 rounded-2xl shadow-lg">
        <div className="grid md:grid-cols-2 gap-4">
          <div>
            <label className="block text-sm font-bold mb-2">Search Teacher</label>
            <input 
              type="text"
              value={searchQuery}
              onChange={e => setSearchQuery(e.target.value)}
              placeholder="Search by name..."
              className="w-full border-2 px-4 py-3 rounded-xl"
            />
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">School</label>
            <select 
              value={selectedSchool}
              onChange={e => setSelectedSchool(e.target.value)}
              className="w-full border-2 px-4 py-3 rounded-xl"
            >
              <option value="All">All Schools</option>
              {SCHOOLS.map(s => <option key={s} value={s}>{s}</option>)}
            </select>
          </div>
        </div>
      </div>

      <div className="grid md:grid-cols-3 gap-6">
        {/* Teacher List */}
        <div className="bg-white p-6 rounded-2xl shadow-lg">
          <h3 className="text-xl font-bold mb-4">üë• Teachers ({filteredTeachers.length})</h3>
          <div className="space-y-2 max-h-96 overflow-y-auto">
            {filteredTeachers.map(teacher => (
              <div 
                key={teacher.afid}
                onClick={() => loadTeacherHistory(teacher)}
                className={`p-3 rounded-xl cursor-pointer transition ${
                  selectedTeacher?.afid === teacher.afid 
                    ? 'bg-yellow-100 border-2 border-yellow-400' 
                    : 'bg-gray-50 hover:bg-gray-100 border-2 border-transparent'
                }`}
              >
                <div className="font-bold">{teacher.name}</div>
                <div className="text-sm text-gray-600">{teacher.school} ‚Ä¢ {teacher.subject}</div>
              </div>
            ))}
          </div>
        </div>

        {/* History Details */}
        <div className="md:col-span-2 bg-white p-6 rounded-2xl shadow-lg">
          <h3 className="text-xl font-bold mb-4">
            üìä Performance History 
            {selectedTeacher && <span className="text-gray-500 font-normal ml-2">- {selectedTeacher.name}</span>}
          </h3>
          
          {!selectedTeacher ? (
            <div className="text-center py-12 text-gray-500">
              <div className="text-4xl mb-4">üëÜ</div>
              <p>Select a teacher to view their performance history</p>
            </div>
          ) : loading ? (
            <div className="text-center py-12">
              <div className="animate-spin text-4xl">‚è≥</div>
              <p className="mt-4 text-gray-500">Loading history...</p>
            </div>
          ) : teacherHistory.length === 0 ? (
            <div className="text-center py-12 text-gray-500">
              <div className="text-4xl mb-4">üì≠</div>
              <p>No historical data available for this teacher.</p>
              <p className="text-sm mt-2">History will be saved when an academic year transition occurs.</p>
            </div>
          ) : (
            <div className="space-y-4">
              {teacherHistory.map(history => (
                <div key={history.academicYear} className="border-2 border-gray-200 rounded-xl p-4">
                  <div className="flex items-center justify-between mb-4">
                    <div className="text-xl font-bold text-blue-600">üìÖ {history.academicYear}</div>
                    <div className="text-sm text-gray-500">üè´ {history.school} ‚Ä¢ {history.subject}</div>
                  </div>
                  
                  <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div className="bg-green-50 p-3 rounded-lg text-center">
                      <div className="text-2xl font-bold text-green-600">{history.metrics?.completionRate || 0}%</div>
                      <div className="text-xs text-green-700">Curriculum Completion</div>
                    </div>
                    <div className="bg-blue-50 p-3 rounded-lg text-center">
                      <div className="text-2xl font-bold text-blue-600">{history.metrics?.onTimeRate || 0}%</div>
                      <div className="text-xs text-blue-700">On-Time Rate</div>
                    </div>
                    <div className="bg-yellow-50 p-3 rounded-lg text-center">
                      <div className="text-2xl font-bold text-yellow-600">{history.metrics?.avgFeedbackRating || '-'}</div>
                      <div className="text-xs text-yellow-700">Avg Feedback ({history.metrics?.feedbackCount || 0})</div>
                    </div>
                    <div className="bg-purple-50 p-3 rounded-lg text-center">
                      <div className="text-2xl font-bold text-purple-600">{history.metrics?.attendanceRate || 0}%</div>
                      <div className="text-xs text-purple-700">Attendance Rate</div>
                    </div>
                  </div>

                  <div className="mt-4 grid grid-cols-3 gap-4 text-sm">
                    <div>
                      <span className="text-gray-500">Chapters:</span>
                      <span className="font-semibold ml-2">{history.metrics?.completedChapters || 0}/{history.metrics?.totalChapters || 0}</span>
                    </div>
                    <div>
                      <span className="text-gray-500">On-Time:</span>
                      <span className="font-semibold ml-2 text-green-600">{history.metrics?.onTimeChapters || 0}</span>
                    </div>
                    <div>
                      <span className="text-gray-500">Delayed:</span>
                      <span className="font-semibold ml-2 text-red-600">{history.metrics?.delayedChapters || 0}</span>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>
      </div>
    </div>
  );
}

function AdminView({
  currentUser,
  handleLogout,
  teachers,
  students,
  curriculum,
  chapterProgress,
  studentAttendance,
  teacherAttendance,
  schoolInfo,
  addChapter,
  updateChapter,
  deleteChapter,
  leaveAdjustments,
  setLeaveAdjustments,
  managers,
  isSuperAdmin,
  accessibleSchools,
  academicYearSettings,
  floatingCelebration,
  setFloatingCelebration
}) {
  const [activeTab, setActiveTab] = useState(isSuperAdmin ? 'managers' : 'analytics');
  const [sidebarCollapsed, setSidebarCollapsed] = useState(false);
  const [sidebarHovering, setSidebarHovering] = useState(false);
  const [isMobileSidebarOpen, setIsMobileSidebarOpen] = useState(false);
  const [isMobile, setIsMobile] = useState(window.innerWidth <= 768);
  const [darkMode, setDarkMode] = useState(() => {
    const saved = localStorage.getItem('darkMode');
    return saved === 'true';
  });
  
  // ‚úÖ FIX: Check if user is Director/Associate Director/Training (view-only but full data access to ALL schools)
  const isDirector = currentUser?.role === 'director' || currentUser?.role === 'assoc_director' || currentUser?.role === 'training';
  
  // Only Super Admin and Directors see ALL schools
  // PMs/APMs see only their assigned schools (via accessibleSchools)
  const hasFullDataAccess = isSuperAdmin || isDirector;
  
  // Detect mobile screen size
  useEffect(() => {
    const checkMobile = () => setIsMobile(window.innerWidth <= 768);
    checkMobile();
    window.addEventListener('resize', checkMobile);
    return () => window.removeEventListener('resize', checkMobile);
  }, []);
  
  // Apply dark mode to document
  useEffect(() => {
    document.documentElement.setAttribute('data-theme', darkMode ? 'dark' : 'light');
    localStorage.setItem('darkMode', darkMode);
  }, [darkMode]);

  // ‚úÖ FIX: Case-insensitive school matching helper
  const schoolMatches = (itemSchool, allowedSchools) => {
    if (!itemSchool || !allowedSchools || allowedSchools.length === 0) return false;
    const itemSchoolLower = (itemSchool || '').toString().toLowerCase().trim();
    return allowedSchools.some(s => (s || '').toString().toLowerCase().trim() === itemSchoolLower);
  };

  // ‚úÖ FIX: Filter data based on access
  // Super Admin & Directors see ALL data
  // PMs/APMs see only their accessibleSchools (direct + reportees' schools)
  const filteredTeachers = hasFullDataAccess ? teachers : teachers.filter(t => schoolMatches(t.school, accessibleSchools));
  const filteredStudents = hasFullDataAccess ? students : students.filter(s => schoolMatches(s.school, accessibleSchools));
  const filteredStudentAttendance = hasFullDataAccess ? studentAttendance : studentAttendance.filter(a => schoolMatches(a.school, accessibleSchools));
  const filteredTeacherAttendance = hasFullDataAccess ? teacherAttendance : teacherAttendance.filter(a => schoolMatches(a.school, accessibleSchools));
  const filteredSchoolInfo = hasFullDataAccess ? schoolInfo : schoolInfo.filter(s => schoolMatches(s.school, accessibleSchools));
  
  // ‚úÖ DEBUG: Log filtered data counts
  console.log('üìä AdminView Data:', {
    hasFullDataAccess,
    accessibleSchools,
    teachers: teachers.length,
    filteredTeachers: filteredTeachers.length,
    students: students.length,
    filteredStudents: filteredStudents.length,
    studentAttendance: studentAttendance.length,
    filteredStudentAttendance: filteredStudentAttendance.length,
    schoolInfo: schoolInfo.length,
    filteredSchoolInfo: filteredSchoolInfo.length,
    schoolInfoSchools: schoolInfo.map(s => s.school)
  });

  // ‚úÖ FIX: Get available schools for dropdowns
  // Directors see all schools, PMs/APMs see only their accessible schools
  const availableSchools = hasFullDataAccess ? SCHOOLS : accessibleSchools;

  const adminTabs = [
    ...(isSuperAdmin ? [
      { id: 'managers', label: 'Managers', icon: <i className="fa-solid fa-user-tie"></i> },
      { id: 'academicyear', label: 'Academic Year', icon: <i className="fa-solid fa-calendar"></i> },
      { id: '2fa-management', label: '2FA Management', icon: <i className="fa-solid fa-shield-halved"></i> },
      { id: 'settings', label: 'Settings', icon: <i className="fa-solid fa-gear"></i> },
    ] : []),
    { id: 'teachers', label: 'Teachers', icon: <i className="fa-solid fa-users"></i> },
    { id: 'teacherhistory', label: 'Teacher History', icon: <i className="fa-solid fa-chart-line"></i> },
    // Students tab - Super Admin has full access, Managers have view-only access
    { id: 'students', label: 'Students', icon: <i className="fa-solid fa-user-graduate"></i> },
    { id: 'directory', label: 'Directory', icon: <i className="fa-solid fa-address-book"></i> },
    { id: 'socialwall', label: 'Social Wall', icon: <i className="fa-solid fa-comments"></i> },
    { id: 'observations', label: 'Class Observations', icon: <i className="fa-solid fa-eye"></i> },
    // Curriculum Management - only for Super Admin (contains add/edit/delete chapters)
    ...(isSuperAdmin ? [
      { id: 'curriculum', label: 'Curriculum', icon: <i className="fa-solid fa-book"></i> },
    ] : []),
    { id: 'analytics', label: 'Analytics', icon: <i className="fa-solid fa-chart-pie"></i> },
    // Chapter Details - removed for non-Super Admin as requested
    ...(isSuperAdmin ? [
      { id: 'chapter-details', label: 'Chapter Details', icon: <i className="fa-solid fa-list-check"></i> },
    ] : []),
    { id: 'attendance', label: 'Attendance Analytics', icon: <i className="fa-solid fa-calendar-check"></i> },
    { id: 'assets', label: 'Asset Management', icon: <i className="fa-solid fa-boxes-stacked"></i> },
    { id: 'schoolinfo', label: 'School Info', icon: <i className="fa-solid fa-school"></i> },
    // Student Profiles - for viewing student demographics with graphs
    { id: 'studentprofiles', label: 'Student Profiles', icon: <i className="fa-solid fa-id-card"></i> },
    { id: 'examstats', label: 'Exam Statistics', icon: <i className="fa-solid fa-graduation-cap"></i> },
    { id: 'studentfeedback', label: 'Student Feedback', icon: <i className="fa-solid fa-message"></i> },
    { id: 'timesheet', label: 'Timesheet', icon: <i className="fa-solid fa-clock"></i> },
    { id: 'roadmap', label: 'Roadmap', icon: <i className="fa-solid fa-map"></i> }
  ];
  
  // Handle navigation and auto-close on mobile
  const handleTabClick = (tabId) => {
    setActiveTab(tabId);
    // Close sidebar on mobile after navigation
    if (window.innerWidth < 768) {
      setIsMobileSidebarOpen(false);
    }
  };
  
  // Swipe gesture detection
  useEffect(() => {
    let touchStartX = 0;
    let touchEndX = 0;
    
    const handleTouchStart = (e) => {
      touchStartX = e.changedTouches[0].screenX;
    };
    
    const handleTouchEnd = (e) => {
      touchEndX = e.changedTouches[0].screenX;
      handleSwipe();
    };
    
    const handleSwipe = () => {
      const swipeThreshold = 50;
      if (touchEndX - touchStartX > swipeThreshold && touchStartX < 50) {
        // Swipe right from left edge - open sidebar
        setIsMobileSidebarOpen(true);
      } else if (touchStartX - touchEndX > swipeThreshold) {
        // Swipe left - close sidebar
        setIsMobileSidebarOpen(false);
      }
    };
    
    document.addEventListener('touchstart', handleTouchStart);
    document.addEventListener('touchend', handleTouchEnd);
    
    return () => {
      document.removeEventListener('touchstart', handleTouchStart);
      document.removeEventListener('touchend', handleTouchEnd);
    };
  }, []);

  return (
    <div className="min-h-screen bg-gray-50">
      <InstallPrompt />
      
      {/* ========== MOBILE FIXED HEADER ========== */}
      {isMobile && (
        <header 
          style={{
            position: 'fixed',
            top: 0,
            left: 0,
            right: 0,
            height: '56px',
            background: '#1a1a2e',
            zIndex: 1001,
            padding: '0 16px',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'space-between',
            boxShadow: '0 2px 10px rgba(0,0,0,0.2)'
          }}
        >
          <button
            onClick={() => setIsMobileSidebarOpen(!isMobileSidebarOpen)}
            style={{
              width: '44px',
              height: '44px',
              background: 'linear-gradient(135deg, #F4B41A 0%, #E8B039 100%)',
              border: 'none',
              borderRadius: '10px',
              color: 'white',
              fontSize: '20px',
              cursor: 'pointer',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center'
            }}
          >
            <i className={`fa-solid ${isMobileSidebarOpen ? 'fa-times' : 'fa-bars'}`}></i>
          </button>
          <div style={{color: 'white', fontWeight: 600, fontSize: '16px', display: 'flex', alignItems: 'center', gap: '8px'}}>
            <div style={{width: '32px', height: '32px', background: 'linear-gradient(135deg, #F4B41A 0%, #E8B039 100%)', borderRadius: '8px', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '16px'}}>
              {isSuperAdmin ? 'üëë' : 'üõ°Ô∏è'}
            </div>
            <span>{isSuperAdmin ? 'Admin Panel' : 'Manager'}</span>
          </div>
          <div style={{width: '44px'}}></div>
        </header>
      )}
      
      {/* Floating Celebration Card for Admin */}
      {floatingCelebration && (
        <div className={`floating-celebration-card ${floatingCelebration.type === 'anniversary' ? 'anniversary' : ''}`}>
          <button 
            className="close-btn" 
            onClick={() => {
              localStorage.setItem('floatingCelebrationDismissed_' + new Date().toDateString(), 'true');
              setFloatingCelebration(null);
            }}
          >√ó</button>
          <span className="confetti" style={{top: '5px', left: '10px'}}>üéâ</span>
          <span className="confetti" style={{top: '10px', right: '40px', animationDelay: '0.5s'}}>‚ú®</span>
          <span className="confetti" style={{bottom: '10px', left: '30px', animationDelay: '1s'}}>üéä</span>
          <div className="celebration-content">
            <div className="avatar">
              {floatingCelebration.person?.profilePhoto ? (
                <img src={floatingCelebration.person.profilePhoto} alt="" />
              ) : (
                floatingCelebration.type === 'birthday' ? 'üéÇ' : 'üéâ'
              )}
            </div>
            <div className="info">
              <h4>{floatingCelebration.type === 'birthday' ? 'üéÇ Birthday Today!' : 'üéâ Work Anniversary!'}</h4>
              <h3>{floatingCelebration.person?.name}</h3>
              <p>
                {floatingCelebration.type === 'birthday' 
                  ? 'Wish them a Happy Birthday! üéà' 
                  : `Completing ${floatingCelebration.years} year${floatingCelebration.years > 1 ? 's' : ''} at Avanti! üíê`}
              </p>
              {floatingCelebration.total > 1 && (
                <p style={{marginTop: '4px', opacity: '0.7'}}>
                  +{floatingCelebration.total - 1} more {floatingCelebration.type === 'birthday' ? 'birthday' : 'anniversary'}{floatingCelebration.total > 2 ? 's' : ''} today
                </p>
              )}
            </div>
          </div>
        </div>
      )}
      
      {/* Sidebar Hover Zone (for auto-expand on desktop) */}
      {!isMobile && sidebarCollapsed && (
        <div 
          className="sidebar-hover-zone"
          onMouseEnter={() => setSidebarHovering(true)}
        />
      )}
      
      {/* Mobile Sidebar Overlay */}
      <div 
        className={`mobile-sidebar-overlay ${isMobileSidebarOpen ? 'active' : ''}`}
        onClick={() => setIsMobileSidebarOpen(false)}
      />

      {/* Modern Vertical Sidebar */}
      <div 
        className={`sidebar ${sidebarCollapsed ? 'collapsed' : 'expanded'} ${isMobileSidebarOpen ? 'mobile-open' : ''} ${sidebarHovering ? 'hovering' : ''}`}
        onMouseEnter={() => !isMobile && sidebarCollapsed && setSidebarHovering(true)}
        onMouseLeave={() => !isMobile && setSidebarHovering(false)}
      >
        <div className="sidebar-header">
          <div className="sidebar-logo">
            <div className="sidebar-logo-icon">
              {isSuperAdmin ? 'üëë' : 'üõ°Ô∏è'}
            </div>
            <div className="sidebar-logo-text">
              <div style={{fontWeight: 700}}>{isSuperAdmin ? 'Super Admin' : ROLE_LABELS[currentUser.role] || 'Admin'}</div>
              <div style={{fontSize: '0.7rem', opacity: 0.7}}>{currentUser.name}</div>
            </div>
          </div>
          <button
            onClick={() => setSidebarCollapsed(!sidebarCollapsed)}
            className="sidebar-toggle"
          >
            <i className={`fa-solid ${sidebarCollapsed ? 'fa-chevron-right' : 'fa-chevron-left'}`}></i>
          </button>
        </div>

        <div className="sidebar-nav">
          {adminTabs.map((tab) => (
            <div
              key={tab.id}
              onClick={() => handleTabClick(tab.id)}
              className={`sidebar-item ${activeTab === tab.id ? 'active' : ''}`}
              data-tooltip={tab.label}
            >
              <span className="sidebar-icon">{tab.icon}</span>
              <span className="sidebar-label">{tab.label}</span>
            </div>
          ))}
        </div>

        <div className="sidebar-footer">
          {/* Dark Mode Toggle */}
          {!sidebarCollapsed && (
            <div className="theme-toggle-container">
              <i className={`fa-solid ${darkMode ? 'fa-moon' : 'fa-sun'}`} style={{color: darkMode ? '#F4B41A' : '#6b7280'}}></i>
              <div 
                className={`theme-toggle ${darkMode ? 'dark' : ''}`}
                onClick={() => setDarkMode(!darkMode)}
              >
                <div className="theme-toggle-slider">
                  {darkMode ? 'üåô' : '‚òÄÔ∏è'}
                </div>
              </div>
              <span style={{color: 'rgba(255,255,255,0.6)', fontSize: '12px'}}>{darkMode ? 'Dark' : 'Light'}</span>
            </div>
          )}
          {sidebarCollapsed && (
            <div 
              className="sidebar-item" 
              onClick={() => setDarkMode(!darkMode)}
              style={{justifyContent: 'center', cursor: 'pointer'}}
              data-tooltip={darkMode ? 'Light Mode' : 'Dark Mode'}
            >
              <i className={`fa-solid ${darkMode ? 'fa-sun' : 'fa-moon'}`} style={{color: '#F4B41A'}}></i>
            </div>
          )}
          
          {!sidebarCollapsed && !isSuperAdmin && (
            <div className="text-gray-400 text-xs mb-2 px-1 mt-2">
              <i className="fa-solid fa-school mr-1"></i> 
              Access: {availableSchools.length} Schools
            </div>
          )}
          <button onClick={handleLogout} className="sidebar-logout">
            <i className="fa-solid fa-right-from-bracket"></i>
            <span>Logout</span>
          </button>
        </div>
      </div>

      {/* Main content */}
      <div 
        className={`main-content ${sidebarCollapsed ? 'sidebar-collapsed' : 'sidebar-expanded'}`}
        style={isMobile ? {marginLeft: 0, paddingTop: '70px', paddingBottom: '20px'} : {}}
      >
        <div className="px-4 py-6">
        
        {/* Profile Completion Banner for Managers - Shows when profile incomplete */}
        <ProfileCompletionBanner 
          currentUser={currentUser} 
          onNavigateToProfile={() => alert('Please update your profile from Settings or contact Super Admin')} 
        />

        {/* Tab Content */}
        {activeTab === 'managers' && isSuperAdmin && (
          <ManagerManagement managers={managers} currentUser={currentUser} isSuperAdmin={isSuperAdmin} />
        )}

        {activeTab === 'academicyear' && isSuperAdmin && (
          <AcademicYearManagement 
            teachers={teachers} 
            students={students} 
            curriculum={curriculum}
            chapterProgress={chapterProgress}
            studentAttendance={studentAttendance}
            teacherAttendance={teacherAttendance}
            academicYearSettings={academicYearSettings}
          />
        )}

        {activeTab === '2fa-management' && isSuperAdmin && (
          <Admin2FAManagement teachers={filteredTeachers} managers={managers} />
        )}

        {activeTab === 'teachers' && <TeacherManagement teachers={filteredTeachers} teacherAttendance={filteredTeacherAttendance} leaveAdjustments={leaveAdjustments} setLeaveAdjustments={setLeaveAdjustments} isSuperAdmin={isSuperAdmin} isDirector={isDirector} />}

        {activeTab === 'teacherhistory' && <TeacherHistoryView teachers={filteredTeachers} />}

        {activeTab === 'students' && <StudentManagement students={filteredStudents} isSuperAdmin={isSuperAdmin} isDirector={isDirector} accessibleSchools={availableSchools} />}

        {activeTab === 'directory' && (
          <OrgChartDirectory teachers={teachers} currentUser={currentUser} allEmployeesAccess={true} />
        )}

        {activeTab === 'socialwall' && (
          <SocialWall teachers={teachers} currentUser={currentUser} allMembers={true} />
        )}

        {activeTab === 'roadmap' && (
          <RoadmapPage currentUser={currentUser} />
        )}

        {activeTab === 'timesheet' && (
          <TimesheetPage 
            currentUser={currentUser} 
            teachers={filteredTeachers} 
            curriculum={curriculum}
            isAdmin={true}
            isSuperAdmin={isSuperAdmin}
            isDirector={isDirector}
            accessibleSchools={availableSchools}
            managers={managers}
          />
        )}

        {activeTab === 'observations' && (
          <AdminClassroomObservations teachers={filteredTeachers} currentUser={currentUser} />
        )}

        {activeTab === 'curriculum' && (
          <AdminCurriculum
            curriculum={curriculum}
            addChapter={addChapter}
            updateChapter={updateChapter}
            deleteChapter={deleteChapter}
          />
        )}

        {activeTab === 'analytics' && (
          <AdminAnalytics
            teachers={filteredTeachers}
            curriculum={curriculum}
            chapterProgress={chapterProgress}
            accessibleSchools={availableSchools}
            isSuperAdmin={isSuperAdmin}
            isDirector={isDirector}
          />
        )}

        {activeTab === 'chapter-details' && (
          <AdminChapterDetails
            curriculum={curriculum}
            chapterProgress={chapterProgress}
            teachers={filteredTeachers}
          />
        )}

        {activeTab === 'attendance' && (
          <AdminAttendanceAnalytics
            students={filteredStudents}
            teachers={filteredTeachers}
            studentAttendance={filteredStudentAttendance}
            teacherAttendance={filteredTeacherAttendance}
            accessibleSchools={availableSchools}
            isSuperAdmin={isSuperAdmin}
            isDirector={isDirector}
          />
        )}

        {activeTab === 'schoolinfo' && (
          <AdminSchoolInfo schoolInfo={filteredSchoolInfo} />
        )}

        {activeTab === 'assets' && (
          <AdminAssetManagement accessibleSchools={availableSchools} isSuperAdmin={isSuperAdmin} isDirector={isDirector} />
        )}

        {activeTab === 'birthdays' && <AdminBirthdays teachers={filteredTeachers} />}

        {activeTab === 'studentprofiles' && <AdminStudentProfiles accessibleSchools={availableSchools} isSuperAdmin={isSuperAdmin} isDirector={isDirector} />}

        {activeTab === 'settings' && isSuperAdmin && <AdminSettings />}

        {activeTab === 'examstats' && <AdminExamStats accessibleSchools={availableSchools} isSuperAdmin={isSuperAdmin} isDirector={isDirector} />}
        
        {activeTab === 'studentfeedback' && <StudentFeedbackView accessibleSchools={availableSchools} isSuperAdmin={isSuperAdmin} isDirector={isDirector} />}
        </div>
      </div>

      <footer className="bg-gray-800 text-white text-center py-4">
        <p>Made by Anand with ‚ù§Ô∏è</p>
      </footer>
    </div>
  );
}
function TeacherOverview({currentUser,curriculum,chapterProgress,teachers,teacherAttendance,studentAttendance,onNavigateToProfile,precomputedRankings}){const mySchool=currentUser.school;const mySubject=currentUser.subject;

// Calculate school rankings from curriculum and progress data
const schoolRankings=useMemo(()=>{
  const rankings=SCHOOLS.map(school=>{
    let total=0,completed=0;
    SUBJECTS.forEach(subject=>{
      ['11','12'].forEach(grade=>{
        const docId=`${school}_${subject}_${grade}`;
        const chapters=curriculum[docId]?.chapters||[];
        chapters.forEach(ch=>{
          total++;
          const progressId=`${school}_${ch.id}`;
          const prog=chapterProgress[progressId]||{};
          if(prog.completed==='Yes') completed++;
        })
      })
    });
    return{school,total,completed,percentage:total?Math.round((completed/total)*100):0}
  });
  rankings.sort((a,b)=>b.percentage-a.percentage);
  return rankings;
},[curriculum,chapterProgress]);

  const subjectRankings=useMemo(()=>{
  const rankings=SUBJECTS.map(subject=>{
    let total=0,completed=0;
    ['11','12'].forEach(grade=>{
      const docId=`${mySchool}_${subject}_${grade}`;
      const chapters=curriculum[docId]?.chapters||[];
      chapters.forEach(ch=>{
        total++;
        const progressId=`${mySchool}_${ch.id}`;
        const prog=chapterProgress[progressId]||{};
        // ‚úÖ Count when chapter completed
        if(prog.completed==='Yes'){
          completed++
        }
      })
    });
    return{subject,total,completed,percentage:total?Math.round((completed/total)*100):0}
  })
  .filter(rank=>rank.total>0);
  rankings.sort((a,b)=>b.percentage-a.percentage);
  return rankings
},[curriculum,chapterProgress,mySchool]);const mySchoolRank=schoolRankings.findIndex(r=>r.school===mySchool)+1;const laggingSubject=subjectRankings[subjectRankings.length-1];return(<div className="space-y-6"><h2 className="text-3xl font-bold">Dashboard Overview</h2>

{/* Profile Completion Card - Shows when profile incomplete */}
<ProfileCompletionCard currentUser={currentUser} onNavigateToProfile={onNavigateToProfile} />

<div className="grid md:grid-cols-4 gap-4"><div className="stat-card avanti-gradient text-white"><div className="text-sm opacity-90">Your School Rank</div><div className="text-5xl font-bold">#{mySchoolRank}</div><div className="text-sm mt-2">Out of {SCHOOLS.length} schools</div></div><div className="stat-card bg-gradient-to-br from-green-500 to-emerald-600 text-white"><div className="text-sm opacity-90">Best Performing School</div><div className="text-2xl font-bold mt-2">{schoolRankings[0]?.school}</div><div className="text-sm mt-2">{schoolRankings[0]?.percentage}% completed</div></div><div className="stat-card bg-gradient-to-br from-orange-500 to-red-600 text-white"><div className="text-sm opacity-90">Lagging Subject (Your School)</div><div className="text-2xl font-bold mt-2">{laggingSubject?.subject}</div><div className="text-sm mt-2">{laggingSubject?.percentage}% completed</div></div></div><div className="bg-white p-6 rounded-2xl shadow-lg"><h3 className="text-2xl font-bold mb-4">üèÜ School Rankings</h3><div className="space-y-3">{schoolRankings.map((rank,index)=><div key={rank.school} className={`ranking-card ${index===0?'ranking-1':index===1?'ranking-2':index===2?'ranking-3':''} ${rank.school===mySchool?'bg-yellow-50':''}`}><div className="flex justify-between items-center"><div className="flex items-center gap-4"><div className="text-2xl font-bold text-gray-400">#{index+1}</div><div><div className="font-bold text-lg">{rank.school} {rank.school===mySchool&&'‚≠ê'}</div><div className="text-sm text-gray-600">{rank.completed} / {rank.total} chapters completed</div></div></div><div className="text-3xl font-bold" style={{color:'var(--avanti-red)'}}>{rank.percentage}%</div></div></div>)}</div></div><div className="bg-white p-6 rounded-2xl shadow-lg"><h3 className="text-2xl font-bold mb-4">üìö Subject Performance in {mySchool}</h3><div className="grid md:grid-cols-2 gap-4">{subjectRankings.map(rank=><div key={rank.subject} className="border-2 rounded-xl p-4"><div className="flex justify-between items-center mb-2"><div className="font-bold text-lg">{rank.subject}</div><div className="text-2xl font-bold" style={{color:'var(--avanti-red)'}}>{rank.percentage}%</div></div><div className="h-2 bg-gray-200 rounded-full"><div className="h-2 avanti-gradient rounded-full" style={{width:`${rank.percentage}%`}}/></div><div className="text-sm text-gray-600 mt-2">{rank.completed} / {rank.total} chapters</div></div>)}</div></div><div className="stat-card bg-gradient-to-br from-purple-500 to-pink-600 text-white">
  <div className="text-sm opacity-90">My Attendance (This Month)</div>
  <div className="text-2xl font-bold mt-2">
    {teacherAttendance.filter(a=>a.teacherId===currentUser.afid&&getMonthYear(a.date)===getMonthYear(getTodayDate())).length} days
  </div>
  <div className="text-sm mt-2">Marked this month</div>
  <div className="bg-white p-6 rounded-2xl shadow-lg">
  <h3 className="text-2xl font-bold mb-4">üìä Quick Attendance Overview</h3>
  <div className="grid md:grid-cols-2 gap-4">
    <div className="border-2 rounded-xl p-4">
      <h4 className="font-bold mb-2">Today's Student Attendance</h4>
      <p className="text-sm text-gray-600">
        Present: <strong className="text-green-600">
          {studentAttendance.filter(a=>a.date===getTodayDate()&&a.school===currentUser.school&&a.status==='Present').length}
        </strong>
      </p>
      <p className="text-sm text-gray-600">
        Absent: <strong className="text-red-600">
          {studentAttendance.filter(a=>a.date===getTodayDate()&&a.school===currentUser.school&&a.status==='Absent').length}
        </strong>
      </p>
    </div>
    <div className="border-2 rounded-xl p-4">
      <h4 className="font-bold mb-2">My Attendance Status</h4>
      {teacherAttendance.find(a=>a.teacherId===currentUser.afid&&a.date===getTodayDate())?
        <div className="text-sm">
          <p className="text-green-600 font-bold">‚úì Marked for today</p>
          <p className="text-gray-600">
            Status: {teacherAttendance.find(a=>a.teacherId===currentUser.afid&&a.date===getTodayDate()).status}
          </p>
        </div>
      :
        <p className="text-orange-600 font-bold">‚ö†Ô∏è Not marked yet</p>
      }
    </div>
  </div>
</div>
  <div className="bg-white p-6 rounded-2xl shadow-lg">
  <h3 className="text-2xl font-bold mb-4">‚è∞ Today's Punch-In Times - {mySchool}</h3>
  <div className="space-y-2 max-h-96 overflow-y-auto">
    {teachers
      .filter(t=>t.school===mySchool && !t.isArchived)
      .map(teacher=>{
        const todayAttendance=teacherAttendance.find(
          a=>a.teacherId===teacher.afid&&a.date===getTodayDate()
        );
        return(
          <div key={teacher.afid} className={`p-4 rounded-xl border-2 ${
            teacher.afid===currentUser.afid?'bg-yellow-50 border-yellow-400':'bg-gray-50 border-gray-200'
          }`}>
            <div className="flex justify-between items-center">
              <div className="flex-1">
                <div className="font-bold text-lg">
                  {teacher.name} {teacher.afid===currentUser.afid&&'(You)'}
                </div>
                <div className="text-sm text-gray-600">{teacher.subject}</div>
              </div>
              <div className="text-right">
                {todayAttendance?(
                  <>
                    <div className={`text-2xl font-bold ${
                      todayAttendance.status==='Present'?'text-green-600':'text-orange-600'
                    }`}>
                      ‚è∞ {todayAttendance.punchInTime||'--:--'}
                    </div>
                    <div className={`text-xs font-semibold ${
                      todayAttendance.status==='Present'?'text-green-600':'text-orange-600'
                    }`}>
                      {todayAttendance.status}
                    </div>
                  </>
                ):(
                  <div className="text-gray-400 font-semibold">Not Marked</div>
                )}
              </div>
            </div>
          </div>
        );
      })
    }
  </div>
</div>
</div></div>)}
// ========================================
// CLASS VIEW COMPONENT (for Class 11 & 12 tabs)
// ========================================
function ClassView({grade, currentUser, curriculum, chapterProgress, updateChapterProgress}) {
  const [expandedChapters, setExpandedChapters] = useState({});
  const [currentDate] = useState(new Date().toISOString().split('T')[0]);

  /// Filter curriculum for the specific grade and teacher's subject
  const gradeCurriculum = useMemo(() => {
    const filtered = {};
    Object.keys(curriculum).forEach(subject => {
      if (currentUser.subject === 'All' || subject === currentUser.subject) {
        const chapters = (curriculum[subject] || []).filter(
          ch => String(ch.grade) === String(grade) || ch.grade === `Class ${grade}`
        );
        if (chapters.length > 0) {
          filtered[subject] = chapters;
        }
      }
    });
    return filtered;
  }, [curriculum, grade, currentUser.subject]);

  // Get progress for specific chapter
  const getChapterProgress = (chapterId) => {
    return chapterProgress[currentUser.school]?.[chapterId] || {};
  };

  // Toggle chapter expansion
  const toggleChapter = (chapterId) => {
    setExpandedChapters(prev => ({
      ...prev,
      [chapterId]: !prev[chapterId]
    }));
  };

  // Calculate status based on dates
  const getChapterStatus = (chapter) => {
    const progress = getChapterProgress(chapter.id);
    if (progress.completed) return 'completed';
    
    const today = new Date(currentDate);
    const plannedEnd = new Date(chapter.plannedEndDate);
    
    if (today > plannedEnd) return 'delayed';
    return 'pending';
  };

  // Count chapters by status
  const getStatusCounts = () => {
    let completed = 0, delayed = 0, pending = 0;
    Object.values(gradeCurriculum).forEach(chapters => {
      chapters.forEach(chapter => {
        const status = getChapterStatus(chapter);
        if (status === 'completed') completed++;
        else if (status === 'delayed') delayed++;
        else pending++;
      });
    });
    return { completed, delayed, pending };
  };

  const statusCounts = getStatusCounts();
  const totalChapters = statusCounts.completed + statusCounts.delayed + statusCounts.pending;

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex justify-between items-center">
        <h2 className="text-3xl font-bold">üìö Class {grade} Curriculum</h2>
        <div className="text-sm text-gray-600">
          Subject: <span className="font-bold">{currentUser.subject}</span>
        </div>
      </div>

      {/* Summary Cards */}
      <div className="grid md:grid-cols-4 gap-4">
        <div className="stat-card bg-blue-500 text-white">
          <div className="text-sm opacity-90">Total Chapters</div>
          <div className="text-4xl font-bold">{totalChapters}</div>
        </div>
        <div className="stat-card bg-green-500 text-white">
          <div className="text-sm opacity-90">‚úì Completed</div>
          <div className="text-4xl font-bold">{statusCounts.completed}</div>
        </div>
        <div className="stat-card bg-orange-500 text-white">
          <div className="text-sm opacity-90">‚ö† Delayed</div>
          <div className="text-4xl font-bold">{statusCounts.delayed}</div>
        </div>
        <div className="stat-card bg-red-500 text-white">
          <div className="text-sm opacity-90">‚è≥ Pending</div>
          <div className="text-4xl font-bold">{statusCounts.pending}</div>
        </div>
      </div>

      {/* Chapters by Subject */}
      {Object.keys(gradeCurriculum).length === 0 ? (
        <div className="bg-white p-12 rounded-2xl shadow-lg text-center">
          <div className="text-6xl mb-4">üì≠</div>
          <p className="text-xl text-gray-600">No chapters found for Class {grade}</p>
        </div>
      ) : (
        Object.keys(gradeCurriculum).map(subject => {
          const chapters = gradeCurriculum[subject];
          if (chapters.length === 0) return null;

          return (
            <div key={subject} className="bg-white p-6 rounded-2xl shadow-lg">
              <h3 className="text-2xl font-bold mb-4 text-blue-600">
                {subject} ({chapters.length} chapters)
              </h3>
              
              <div className="space-y-4">
                {chapters.map(chapter => {
                  const progress = getChapterProgress(chapter.id);
                  const status = getChapterStatus(chapter);
                  const isExpanded = expandedChapters[chapter.id];

                  return (
                    <div
                      key={chapter.id}
                      className={`chapter-card ${status} border-2 rounded-xl p-4`}
                    >
                      {/* Chapter Header */}
                      <div 
                        className="flex justify-between items-start cursor-pointer gap-3"
                        onClick={() => toggleChapter(chapter.id)}
                      >
                        <div className="flex-1 min-w-0">
                          <div className="flex flex-wrap items-center gap-3 mb-2">
                            <h4 className="text-lg font-bold break-words">{chapter.name}</h4>
                            <span className={`status-badge status-${status} flex-shrink-0`}>
                              {status === 'completed' ? '‚úì Done' : 
                               status === 'delayed' ? '‚ö† Delayed' : '‚è≥ Pending'}
                            </span>
                          </div>
                          <div className="text-sm text-gray-600 space-y-1">
                            <div><strong>Duration:</strong> {chapter.duration} days</div>
                            <div><strong>Planned:</strong> {chapter.plannedStartDate} ‚Üí {chapter.plannedEndDate}</div>
                            {progress.actualStartDate && (
                              <div><strong>Actual Start:</strong> {progress.actualStartDate}</div>
                            )}
                            {progress.completed && progress.actualEndDate && (
                              <div><strong>Actual End:</strong> {progress.actualEndDate}</div>
                            )}
                          </div>
                        </div>
                        <button className="text-2xl flex-shrink-0">
                          {isExpanded ? '‚ñ≤' : '‚ñº'}
                        </button>
                      </div>

                      {/* Expanded Details */}
                      {isExpanded && (
                        <div className="mt-4 pt-4 border-t-2 chapter-details">
                          <div className="grid md:grid-cols-2 gap-4 mb-4">
                            {/* Actual Start Date */}
                            <div>
                              <label className="block text-sm font-semibold mb-2">
                                Actual Start Date
                              </label>
                              <input
                                type="date"
                                value={progress.actualStartDate || ''}
                                onChange={(e) => {
                                  updateChapterProgress(chapter.id, {
                                    ...progress,
                                    actualStartDate: e.target.value
                                  });
                                }}
                                className="w-full px-3 py-2 border-2 rounded-lg"
                              />
                            </div>

                            {/* Actual End Date */}
                            <div>
                              <label className="block text-sm font-semibold mb-2">
                                Actual End Date
                              </label>
                              <input
                                type="date"
                                value={progress.actualEndDate || ''}
                                onChange={(e) => {
                                  updateChapterProgress(chapter.id, {
                                    ...progress,
                                    actualEndDate: e.target.value
                                  });
                                }}
                                className="w-full px-3 py-2 border-2 rounded-lg"
                              />
                            </div>
                          </div>

                          {/* Completion Checkbox */}
                          <label className="flex items-center gap-3 p-3 bg-gray-50 rounded-lg cursor-pointer">
                            <input
                              type="checkbox"
                              checked={progress.completed || false}
                              onChange={(e) => {
                                updateChapterProgress(chapter.id, {
                                  ...progress,
                                  completed: e.target.checked,
                                  actualEndDate: e.target.checked && !progress.actualEndDate 
                                    ? currentDate 
                                    : progress.actualEndDate
                                });
                              }}
                            />
                            <span className="font-semibold">Mark as Completed</span>
                          </label>

                          {/* Notes */}
                          <div className="mt-4">
                            <label className="block text-sm font-semibold mb-2">
                              Notes / Remarks
                            </label>
                            <textarea
                              value={progress.notes || ''}
                              onChange={(e) => {
                                updateChapterProgress(chapter.id, {
                                  ...progress,
                                  notes: e.target.value
                                });
                              }}
                              className="w-full px-3 py-2 border-2 rounded-lg"
                              rows="3"
                              placeholder="Add any notes about this chapter..."
                            />
                          </div>
                        </div>
                      )}
                    </div>
                  );
                })}
              </div>
            </div>
          );
        })
      )}
    </div>
  );
}    
function TeacherAnalytics({currentUser,curriculum,chapterProgress}){
  const chart1Ref=useRef(null);
  const chart2Ref=useRef(null);
  const chart3Ref=useRef(null);
  const chart4Ref=useRef(null);
  const chart5Ref=useRef(null);
  
  const chartInstances=useRef({});
  
  const mySchool=currentUser.school;
  const mySubject=currentUser.subject;
  
  // My school data
  const myData=useMemo(()=>{
    const data={
      11:{total:0,completed:0,testsCompleted:0,testsPending:0},
      12:{total:0,completed:0,testsCompleted:0,testsPending:0}
    };
    let totalDays=0;
    let chaptersWithDates=0;
    
    ['11','12'].forEach(grade=>{
      const docId=`${mySchool}_${mySubject}_${grade}`;
      const chapters=curriculum[docId]?.chapters||[];
      chapters.forEach(ch=>{
        data[grade].total++;
        const progressId=`${mySchool}_${ch.id}`;
        const prog=chapterProgress[progressId]||{};
        
        if(prog.completed==='Yes'){
          data[grade].completed++;
          
          if(prog.testConducted==='Yes'){
            data[grade].testsCompleted++;
          }else{
            data[grade].testsPending++;
          }
          
          if(prog.completionDate&&ch.targetDate){
            const target=new Date(ch.targetDate);
            const completion=new Date(prog.completionDate);
            const days=Math.abs(Math.ceil((completion-target)/(1000*60*60*24)));
            totalDays+=days;
            chaptersWithDates++;
          }
        }
      })
    });
    
    const avgDays=chaptersWithDates?Math.round(totalDays/chaptersWithDates):0;
    return{...data,avgDays};
  },[curriculum,chapterProgress,mySchool,mySubject]);

  // All schools comparison data
  const allSchoolsData=useMemo(()=>{
    const data={};
    SCHOOLS.forEach(school=>{
      data[school]={
        11:{total:0,completed:0,testsCompleted:0},
        12:{total:0,completed:0,testsCompleted:0}
      };
      
      ['11','12'].forEach(grade=>{
        const docId=`${school}_${mySubject}_${grade}`;
        const chapters=curriculum[docId]?.chapters||[];
        chapters.forEach(ch=>{
          data[school][grade].total++;
          const progressId=`${school}_${ch.id}`;
          const prog=chapterProgress[progressId]||{};
          if(prog.completed==='Yes'){
            data[school][grade].completed++;
            if(prog.testConducted==='Yes'){
              data[school][grade].testsCompleted++;
            }
          }
        })
      });
    });
    return data;
  },[curriculum,chapterProgress,mySubject]);

  useEffect(()=>{
    Object.values(chartInstances.current).forEach(c=>c&&c.destroy());
    chartInstances.current={};

    // Chart 1: My Chapter Progress (11th & 12th)
    if(chart1Ref.current){
      const ctx=chart1Ref.current.getContext('2d');
      chartInstances.current.chart1=new Chart(ctx,{
        type:'bar',
        data:{
          labels:['Class 11','Class 12'],
          datasets:[{
            label:'Completed',
            data:[myData[11].completed,myData[12].completed],
            backgroundColor:'#10B981'
          },{
            label:'Pending',
            data:[
              myData[11].total-myData[11].completed,
              myData[12].total-myData[12].completed
            ],
            backgroundColor:'#F59E0B'
          }]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            title:{display:true,text:'My Chapter Progress',font:{size:16,weight:'bold'}},
            legend:{position:'bottom'}
          },
          scales:{x:{stacked:true},y:{stacked:true,beginAtZero:true}}
        }
      });
    }

    // Chart 2: My Tests Status (11th & 12th)
    if(chart2Ref.current){
      const ctx=chart2Ref.current.getContext('2d');
      chartInstances.current.chart2=new Chart(ctx,{
        type:'bar',
        data:{
          labels:['Class 11','Class 12'],
          datasets:[{
            label:'Tests Completed',
            data:[myData[11].testsCompleted,myData[12].testsCompleted],
            backgroundColor:'#3B82F6'
          },{
            label:'Tests Pending',
            data:[myData[11].testsPending,myData[12].testsPending],
            backgroundColor:'#EF4444'
          }]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            title:{display:true,text:'My Tests Status',font:{size:16,weight:'bold'}},
            legend:{position:'bottom'}
          },
          scales:{y:{beginAtZero:true}}
        }
      });
    }

    // Chart 3: Class 11 - School Comparison
    if(chart3Ref.current){
      const ctx=chart3Ref.current.getContext('2d');
      chartInstances.current.chart3=new Chart(ctx,{
        type:'bar',
        data:{
          labels:SCHOOLS,
          datasets:[{
            label:'Chapters Completed',
            data:SCHOOLS.map(s=>allSchoolsData[s][11].completed),
            backgroundColor:SCHOOLS.map(s=>s===mySchool?'#C8342E':'#10B981'),
            borderWidth:SCHOOLS.map(s=>s===mySchool?3:0),
            borderColor:'#000'
          }]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            title:{display:true,text:`Class 11 ${mySubject} - School Comparison`,font:{size:16,weight:'bold'}},
            legend:{display:false}
          },
          scales:{y:{beginAtZero:true}}
        }
      });
    }

    // Chart 4: Class 12 - School Comparison
    if(chart4Ref.current){
      const ctx=chart4Ref.current.getContext('2d');
      chartInstances.current.chart4=new Chart(ctx,{
        type:'bar',
        data:{
          labels:SCHOOLS,
          datasets:[{
            label:'Chapters Completed',
            data:SCHOOLS.map(s=>allSchoolsData[s][12].completed),
            backgroundColor:SCHOOLS.map(s=>s===mySchool?'#C8342E':'#10B981'),
            borderWidth:SCHOOLS.map(s=>s===mySchool?3:0),
            borderColor:'#000'
          }]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            title:{display:true,text:`Class 12 ${mySubject} - School Comparison`,font:{size:16,weight:'bold'}},
            legend:{display:false}
          },
          scales:{y:{beginAtZero:true}}
        }
      });
    }

    // Chart 5: Tests Comparison - All Schools
    if(chart5Ref.current){
      const ctx=chart5Ref.current.getContext('2d');
      chartInstances.current.chart5=new Chart(ctx,{
        type:'bar',
        data:{
          labels:SCHOOLS,
          datasets:[
            {
              label:'Class 11 Tests',
              data:SCHOOLS.map(s=>allSchoolsData[s][11].testsCompleted),
              backgroundColor:'#3B82F6'
            },
            {
              label:'Class 12 Tests',
              data:SCHOOLS.map(s=>allSchoolsData[s][12].testsCompleted),
              backgroundColor:'#8B5CF6'
            }
          ]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            title:{display:true,text:`${mySubject} Tests Completed - School Comparison`,font:{size:16,weight:'bold'}},
            legend:{position:'bottom'}
          },
          scales:{y:{beginAtZero:true}}
        }
      });
    }

    return()=>{
      Object.values(chartInstances.current).forEach(c=>c&&c.destroy());
    };
  },[myData,allSchoolsData,mySchool,mySubject]);

  const handleExport=()=>{
    // Create workbook with multiple sheets
    const wb = XLSX.utils.book_new();
    
    // Sheet 1: Summary
    const summaryData=[
      {
        Grade:'Class 11',
        'Total Chapters':myData[11].total,
        'Completed':myData[11].completed,
        'Tests Completed':myData[11].testsCompleted,
        'Tests Pending':myData[11].testsPending,
        'Completion %':myData[11].total?Math.round((myData[11].completed/myData[11].total)*100):0
      },
      {
        Grade:'Class 12',
        'Total Chapters':myData[12].total,
        'Completed':myData[12].completed,
        'Tests Completed':myData[12].testsCompleted,
        'Tests Pending':myData[12].testsPending,
        'Completion %':myData[12].total?Math.round((myData[12].completed/myData[12].total)*100):0
      }
    ];
    const wsSummary = XLSX.utils.json_to_sheet(summaryData);
    XLSX.utils.book_append_sheet(wb, wsSummary, "Summary");
    
    // Sheet 2: Chapter Details with Completion Dates
    const chapterDetailsData = [];
    ['11','12'].forEach(grade=>{
      const docId=`${mySchool}_${mySubject}_${grade}`;
      const chapters=curriculum[docId]?.chapters||[];
      chapters.forEach((ch, idx)=>{
        const progressId=`${mySchool}_${ch.id}`;
        const prog=chapterProgress[progressId]||{};
        
        // Calculate days difference if both dates exist
        let daysDiff = '‚Äî';
        if(prog.completionDate && ch.targetDate) {
          const target = new Date(ch.targetDate);
          const completion = new Date(prog.completionDate);
          const diff = Math.ceil((completion - target) / (1000 * 60 * 60 * 24));
          daysDiff = diff > 0 ? `+${diff} days (Late)` : diff < 0 ? `${diff} days (Early)` : 'On Time';
        }
        
        chapterDetailsData.push({
          'S.No': idx + 1,
          'Grade': `Class ${grade}`,
          'Chapter Name': ch.name || '‚Äî',
          'Topics': ch.topics ? ch.topics.join(', ') : '‚Äî',
          'Target Date': ch.targetDate || '‚Äî',
          'Completed': prog.completed || 'No',
          'Completion Date': prog.completionDate || '‚Äî',
          'Days Difference': daysDiff,
          'Test Conducted': prog.testConducted || 'No',
          'Notes': prog.notes || '‚Äî'
        });
      });
    });
    
    if(chapterDetailsData.length > 0) {
      const wsChapters = XLSX.utils.json_to_sheet(chapterDetailsData);
      XLSX.utils.book_append_sheet(wb, wsChapters, "Chapter Details");
    }
    
    // Sheet 3: School Comparison (for reference)
    const comparisonData = SCHOOLS.map(school => {
      const s11 = allSchoolsData[school]?.[11] || {total:0,completed:0,testsCompleted:0};
      const s12 = allSchoolsData[school]?.[12] || {total:0,completed:0,testsCompleted:0};
      return {
        'School': school,
        'Class 11 Total': s11.total,
        'Class 11 Completed': s11.completed,
        'Class 11 Tests': s11.testsCompleted,
        'Class 12 Total': s12.total,
        'Class 12 Completed': s12.completed,
        'Class 12 Tests': s12.testsCompleted,
        'Overall %': (s11.total + s12.total) ? Math.round(((s11.completed + s12.completed) / (s11.total + s12.total)) * 100) : 0
      };
    });
    const wsComparison = XLSX.utils.json_to_sheet(comparisonData);
    XLSX.utils.book_append_sheet(wb, wsComparison, "School Comparison");
    
    // Download the workbook
    XLSX.writeFile(wb,`${mySubject}_analytics_${mySchool}_${new Date().toISOString().slice(0,10)}.xlsx`);
  };

  return(
    <div className="space-y-6">
      <div className="flex justify-between items-center">
        <h2 className="text-3xl font-bold">My Analytics - {mySubject}</h2>
        <button onClick={handleExport} className="px-6 py-3 bg-green-600 text-white rounded-xl font-semibold">
          üìä Export to Excel
        </button>
      </div>

      <div className="grid grid-cols-2 md:grid-cols-5 gap-4">
        <div className="stat-card">
          <div className="text-sm text-gray-600">Avg Days per Chapter</div>
          <div className="text-4xl font-bold">{myData.avgDays}</div>
        </div>
        <div className="stat-card bg-green-500 text-white">
          <div className="text-sm opacity-90">Class 11 Completed</div>
          <div className="text-4xl font-bold">{myData[11].completed}/{myData[11].total}</div>
          <div className="text-sm opacity-90">
            {myData[11].total?Math.round((myData[11].completed/myData[11].total)*100):0}%
          </div>
        </div>
        <div className="stat-card bg-green-500 text-white">
          <div className="text-sm opacity-90">Class 12 Completed</div>
          <div className="text-4xl font-bold">{myData[12].completed}/{myData[12].total}</div>
          <div className="text-sm opacity-90">
            {myData[12].total?Math.round((myData[12].completed/myData[12].total)*100):0}%
          </div>
        </div>
        <div className="stat-card bg-blue-500 text-white">
          <div className="text-sm opacity-90">Tests Completed</div>
          <div className="text-4xl font-bold">
            {myData[11].testsCompleted+myData[12].testsCompleted}
          </div>
        </div>
        <div className="stat-card bg-red-500 text-white">
          <div className="text-sm opacity-90">Tests Pending</div>
          <div className="text-4xl font-bold">
            {myData[11].testsPending+myData[12].testsPending}
          </div>
        </div>
      </div>

      <div className="grid md:grid-cols-2 gap-6">
        <div className="bg-white p-6 rounded-2xl shadow-lg" style={{height:'400px'}}>
          <canvas ref={chart1Ref}></canvas>
        </div>
        <div className="bg-white p-6 rounded-2xl shadow-lg" style={{height:'400px'}}>
          <canvas ref={chart2Ref}></canvas>
        </div>
      </div>

      <div className="bg-white p-6 rounded-2xl shadow-lg" style={{height:'400px'}}>
        <canvas ref={chart5Ref}></canvas>
      </div>

      <div className="grid md:grid-cols-2 gap-6">
        <div className="bg-white p-6 rounded-2xl shadow-lg" style={{height:'400px'}}>
          <canvas ref={chart3Ref}></canvas>
        </div>
        <div className="bg-white p-6 rounded-2xl shadow-lg" style={{height:'400px'}}>
          <canvas ref={chart4Ref}></canvas>
        </div>
      </div>
    </div>
  );
}

// ========================================
// STUDENT CURRICULUM WITH PRIORITY FILTER
// ========================================
function StudentCurriculumWithPriority({mySchool, myGrade, curriculum, chapterProgress}) {
  const [priorityFilter, setPriorityFilter] = useState('all');
  const [selectedSubject, setSelectedSubject] = useState('All');

  // Get all chapters with their subjects for filtering
  const getAllChaptersWithSubject = () => {
    let allChapters = [];
    SUBJECTS.forEach(subject => {
      const docId = `${mySchool}_${subject}_${myGrade}`;
      const chapters = curriculum[docId]?.chapters || [];
      chapters.forEach(chapter => {
        const progressId = `${mySchool}_${chapter.id}`;
        const prog = chapterProgress[progressId] || {};
        const status = getChapterStatus(chapter, prog);
        allChapters.push({
          ...chapter,
          subject,
          prog,
          status
        });
      });
    });
    return allChapters;
  };

  const allChapters = getAllChaptersWithSubject();

  // Count chapters by priority
  const priorityCounts = {
    all: allChapters.length,
    high: allChapters.filter(ch => ch.priority === 'high' || !ch.priority).length,
    medium: allChapters.filter(ch => ch.priority === 'medium').length,
    low: allChapters.filter(ch => ch.priority === 'low').length
  };

  return (
    <div className="space-y-6">
      <h2 className="text-3xl font-bold">üìö My Curriculum - Class {myGrade}</h2>
      
      {/* Priority Filter Section */}
      <div className="bg-white p-4 rounded-2xl shadow-lg">
        <div className="flex flex-wrap items-center gap-3">
          <span className="font-bold text-gray-700">üéØ Filter by Priority:</span>
          <div className="flex flex-wrap gap-2">
            <button
              onClick={() => setPriorityFilter('all')}
              className={`px-4 py-2 rounded-xl font-semibold transition-all ${
                priorityFilter === 'all' 
                  ? 'bg-gray-800 text-white shadow-lg' 
                  : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
              }`}
            >
              üìã All ({priorityCounts.all})
            </button>
            <button
              onClick={() => setPriorityFilter('high')}
              className={`px-4 py-2 rounded-xl font-semibold transition-all ${
                priorityFilter === 'high' 
                  ? 'bg-gradient-to-r from-green-500 to-emerald-500 text-white shadow-lg' 
                  : 'bg-green-50 text-green-700 hover:bg-green-100 border border-green-200'
              }`}
            >
              üü¢ High ({priorityCounts.high})
            </button>
            <button
              onClick={() => setPriorityFilter('medium')}
              className={`px-4 py-2 rounded-xl font-semibold transition-all ${
                priorityFilter === 'medium' 
                  ? 'bg-gradient-to-r from-yellow-500 to-amber-500 text-white shadow-lg' 
                  : 'bg-yellow-50 text-yellow-700 hover:bg-yellow-100 border border-yellow-200'
              }`}
            >
              üü° Medium ({priorityCounts.medium})
            </button>
            <button
              onClick={() => setPriorityFilter('low')}
              className={`px-4 py-2 rounded-xl font-semibold transition-all ${
                priorityFilter === 'low' 
                  ? 'bg-gradient-to-r from-red-500 to-rose-500 text-white shadow-lg' 
                  : 'bg-red-50 text-red-700 hover:bg-red-100 border border-red-200'
              }`}
            >
              üî¥ Low ({priorityCounts.low})
            </button>
          </div>
        </div>
        
        {/* Subject Filter */}
        <div className="flex flex-wrap items-center gap-3 mt-3 pt-3 border-t">
          <span className="font-bold text-gray-700">üìö Subject:</span>
          <select
            value={selectedSubject}
            onChange={(e) => setSelectedSubject(e.target.value)}
            className="border-2 px-4 py-2 rounded-xl font-semibold"
          >
            <option value="All">All Subjects</option>
            {SUBJECTS.map(s => <option key={s} value={s}>{s}</option>)}
          </select>
        </div>
      </div>

      {/* Chapters Display */}
      {SUBJECTS.filter(subject => selectedSubject === 'All' || subject === selectedSubject).map(subject => {
        const docId = `${mySchool}_${subject}_${myGrade}`;
        let chapters = curriculum[docId]?.chapters || [];
        
        // Apply priority filter
        if (priorityFilter !== 'all') {
          chapters = chapters.filter(chapter => {
            const chPriority = chapter.priority || 'high'; // default to high if not set
            return chPriority === priorityFilter;
          });
        }
        
        // Don't show subject section if no chapters match filter
        if (chapters.length === 0 && priorityFilter !== 'all') return null;
        
        return (
          <div key={subject} className="bg-white p-6 rounded-2xl shadow-lg">
            <h3 className="text-2xl font-bold mb-4">{subject}</h3>
            {chapters.length === 0 ? (
              <p className="text-gray-500">
                {priorityFilter !== 'all' 
                  ? `No ${priorityFilter} priority chapters` 
                  : 'No chapters available'}
              </p>
            ) : (
              <div className="space-y-3">
                {chapters.map(chapter => {
                  const progressId = `${mySchool}_${chapter.id}`;
                  const prog = chapterProgress[progressId] || {};
                  const status = getChapterStatus(chapter, prog);
                  const chPriority = chapter.priority || 'high';
                  
                  return (
                    <div key={chapter.id} className="border-2 rounded-xl p-4 hover:shadow-md transition-all">
                      <div className="flex justify-between items-start">
                        <div className="flex-1">
                          <div className="flex items-center gap-3 flex-wrap">
                            <h4 className="font-bold text-lg">{chapter.name}</h4>
                            {/* Priority Badge */}
                            {chPriority === 'high' && (
                              <span className="priority-badge priority-high text-xs">üü¢ High Priority</span>
                            )}
                            {chPriority === 'medium' && (
                              <span className="priority-badge priority-medium text-xs">üü° Medium Priority</span>
                            )}
                            {chPriority === 'low' && (
                              <span className="priority-badge priority-low text-xs">üî¥ Low Priority</span>
                            )}
                          </div>
                          <div className="text-sm text-gray-600 mt-2">
                            üìÖ Target: {chapter.targetDate || 'Not set'}
                          </div>
                          {/* Show topics count if available */}
                          {chapter.topics && chapter.topics.length > 0 && (
                            <div className="text-sm text-gray-500 mt-1">
                              üìù {chapter.topics.length} topic{chapter.topics.length > 1 ? 's' : ''}
                            </div>
                          )}
                        </div>
                        <div className={`status-badge ${status.class}`}>
                          {status.label}
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>
            )}
          </div>
        );
      })}
    </div>
  );
}

function TeacherCurriculum({grade,currentUser,curriculum,chapterProgress,updateChapterProgress}){
  const[expandedChapters,setExpandedChapters]=useState({});
  const[priorityFilter,setPriorityFilter]=useState('all');
  const mySchool=currentUser.school;
  const mySubject=currentUser.subject;
  const docId=`${mySchool}_${mySubject}_${grade}`;
  const allChapters=curriculum[docId]?.chapters||[];
  
  // Filter chapters by priority
  const chapters = priorityFilter === 'all' 
    ? allChapters 
    : allChapters.filter(ch => {
        const chPriority = ch.priority || 'high'; // default to high if not set
        return chPriority === priorityFilter;
      });

  // Count chapters by priority
  const priorityCounts = {
    all: allChapters.length,
    high: allChapters.filter(ch => ch.priority === 'high' || !ch.priority).length,
    medium: allChapters.filter(ch => ch.priority === 'medium').length,
    low: allChapters.filter(ch => ch.priority === 'low').length
  };

  const handleCompletedChange=(chapterId,value)=>{
  updateChapterProgress(mySchool,chapterId,'completed',value);
};

  return(
    <div className="space-y-6">
      <h2 className="text-3xl font-bold">Class {grade} - {mySubject}</h2>
      
      {/* Priority Filter for Teachers */}
      <div className="bg-white p-4 rounded-2xl shadow-lg">
        <div className="flex flex-wrap items-center gap-3">
          <span className="font-bold text-gray-700">üéØ Filter by Priority:</span>
          <div className="flex flex-wrap gap-2">
            <button
              onClick={() => setPriorityFilter('all')}
              className={`px-4 py-2 rounded-xl font-semibold transition-all ${
                priorityFilter === 'all' 
                  ? 'bg-gray-800 text-white shadow-lg' 
                  : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
              }`}
            >
              üìã All ({priorityCounts.all})
            </button>
            <button
              onClick={() => setPriorityFilter('high')}
              className={`px-4 py-2 rounded-xl font-semibold transition-all ${
                priorityFilter === 'high' 
                  ? 'bg-gradient-to-r from-green-500 to-emerald-500 text-white shadow-lg' 
                  : 'bg-green-50 text-green-700 hover:bg-green-100 border border-green-200'
              }`}
            >
              üü¢ High ({priorityCounts.high})
            </button>
            <button
              onClick={() => setPriorityFilter('medium')}
              className={`px-4 py-2 rounded-xl font-semibold transition-all ${
                priorityFilter === 'medium' 
                  ? 'bg-gradient-to-r from-yellow-500 to-amber-500 text-white shadow-lg' 
                  : 'bg-yellow-50 text-yellow-700 hover:bg-yellow-100 border border-yellow-200'
              }`}
            >
              üü° Medium ({priorityCounts.medium})
            </button>
            <button
              onClick={() => setPriorityFilter('low')}
              className={`px-4 py-2 rounded-xl font-semibold transition-all ${
                priorityFilter === 'low' 
                  ? 'bg-gradient-to-r from-red-500 to-rose-500 text-white shadow-lg' 
                  : 'bg-red-50 text-red-700 hover:bg-red-100 border border-red-200'
              }`}
            >
              üî¥ Low ({priorityCounts.low})
            </button>
          </div>
        </div>
      </div>
      
      {chapters.length===0?
        <div className="bg-white p-8 rounded-2xl text-center">
          <p className="text-gray-600">
            {priorityFilter !== 'all' 
              ? `No ${priorityFilter} priority chapters available.` 
              : 'No chapters available. Contact admin.'}
          </p>
        </div>
      :
        <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
          {chapters.map(chapter=>{
            const progressId=`${mySchool}_${chapter.id}`;
            const prog=chapterProgress[progressId]||{};
            const completedTopics=prog.completedTopics||[];
            const allTopics=chapter.topics||[];
            const progress=allTopics.length?Math.round((completedTopics.length/allTopics.length)*100):0;
            const isExpanded=expandedChapters[chapter.id];
            const status=getChapterStatus(chapter,prog);

            return(
              <div className={`chapter-card ${status.color} rounded-2xl shadow-lg p-5`}>
  <div className="flex justify-between items-start mb-3 gap-3">
    <div className="flex-1 min-w-0">
      <h3 className="text-xl font-bold mb-2 break-words">{chapter.name}</h3>
      <div>
        {(chapter.priority==='high'||!chapter.priority)&&(
          <span className="priority-badge priority-high text-xs">
            üü¢ High Priority
          </span>
        )}
        {chapter.priority==='medium'&&(
          <span className="priority-badge priority-medium text-xs">
            üü° Medium Priority
          </span>
        )}
        {chapter.priority==='low'&&(
          <span className="priority-badge priority-low text-xs">
            üî¥ Low Priority
          </span>
        )}
      </div>
    </div>
    <button 
      onClick={(e)=>{
        e.preventDefault();
        e.stopPropagation();
        setExpandedChapters(prev=>({...prev,[chapter.id]:!prev[chapter.id]}));
      }} 
      className="text-sm px-3 py-1 bg-white rounded-lg font-semibold flex-shrink-0"
    >
      {isExpanded?'‚ñ≤':'‚ñº'}
    </button>
  </div>

                <div className={`status-badge ${status.class} mb-3`}>{status.label}</div>

                <div className="space-y-3">
                  <div>
                    <div className="flex justify-between text-sm mb-1">
                      <span className="font-semibold">Topics</span>
                      <span className="font-bold">{completedTopics.length}/{allTopics.length}</span>
                    </div>
                    <div className="h-2 bg-gray-200 rounded-full">
                      <div className="h-2 avanti-gradient rounded-full transition-all" style={{width:`${progress}%`}}/>
                    </div>
                  </div>

                  {isExpanded&&(
                    <>
                      <div className="space-y-2 max-h-40 overflow-y-auto bg-white p-2 rounded-lg">
                        {allTopics.map((topic,idx)=>{
                          // Support both old string format and new object format
                          const topicName = typeof topic === 'string' ? topic : topic.name;
                          const topicPriority = typeof topic === 'string' ? 'medium' : (topic.priority || 'medium');
                          const topicKey = typeof topic === 'string' ? topic : topic.name;
                          const checked = completedTopics.includes(topicKey) || completedTopics.includes(topic);
                          const priorityIcon = topicPriority === 'high' ? 'üü¢' : topicPriority === 'medium' ? 'üü°' : 'üî¥';
                          return(
                            <label 
  key={idx} 
  className="flex items-start gap-2 cursor-pointer p-2 hover:bg-gray-50 rounded"
  onClick={(e)=>e.stopPropagation()}
>
  <input 
    type="checkbox" 
    checked={checked}
    className="mt-1 flex-shrink-0"
    onClick={(e)=>e.stopPropagation()}
    onChange={(e)=>{
      e.stopPropagation();
      const updated=e.target.checked?[...completedTopics,topicKey]:completedTopics.filter(t=>t!==topicKey && t!==topic);
      updateChapterProgress(mySchool,chapter.id,'completedTopics',updated);
    }}
  />
                              <span className={`text-sm flex-1 break-words ${checked?'line-through text-gray-500':'font-medium'}`}>
                                {topicName}
                              </span>
                              <span className="text-xs flex-shrink-0 mt-1">{priorityIcon}</span>
                            </label>
                          );
                        })}
                      </div>
                      <div className="bg-white p-3 rounded-lg">
      <label className="block text-sm font-bold mb-1">Chapter Priority</label>
      <div>
        {(chapter.priority==='high'||!chapter.priority)&&(
          <span className="priority-badge priority-high text-sm">üü¢ High Priority</span>
        )}
        {chapter.priority==='medium'&&(
          <span className="priority-badge priority-medium text-sm">üü° Medium Priority</span>
        )}
        {chapter.priority==='low'&&(
          <span className="priority-badge priority-low text-sm">üî¥ Low Priority</span>
        )}
      </div>
    </div>

                      <div className="bg-white p-3 rounded-lg">
                        <label className="block text-sm font-bold mb-1">Target Date</label>
                        <div className="text-sm">{chapter.targetDate||'‚Äî'}</div>
                      </div>

                      <div className="bg-white p-3 rounded-lg">
                        <label className="block text-sm font-bold mb-1">Completion Date *</label>
                        <input 
  type="date" 
  value={prog.completionDate||''} 
  onClick={(e)=>e.stopPropagation()}
  onChange={(e)=>{
    e.stopPropagation();
    updateChapterProgress(mySchool,chapter.id,'completionDate',e.target.value);
  }}
  className="w-full border-2 px-3 py-2 rounded-lg cursor-pointer"
/>
                      </div>

                      <div className="bg-white p-3 rounded-lg">
                        <label className="block text-sm font-bold mb-1">Test Conducted? *</label>
                        <select 
  value={prog.testConducted||'No'} 
  onClick={(e)=>e.stopPropagation()}
  onChange={(e)=>{
    e.stopPropagation();
    updateChapterProgress(mySchool,chapter.id,'testConducted',e.target.value);
  }}
  className="w-full border-2 px-3 py-2 rounded-lg cursor-pointer"
>
                          <option value="No">No</option>
                          <option value="Yes">Yes</option>
                        </select>
                      </div>

                      <div className="bg-white p-3 rounded-lg">
                        <label className="block text-sm font-bold mb-1">Chapter Completed? *</label>
                        <select 
  value={prog.completed||'No'} 
  onClick={(e)=>e.stopPropagation()}
  onChange={(e)=>{
    e.stopPropagation();
    handleCompletedChange(chapter.id,e.target.value);
  }}
  className="w-full border-2 px-3 py-2 rounded-lg cursor-pointer"
>
                          <option value="No">No</option>
                          <option value="Yes">Yes</option>
                        </select>
                      </div>

                      <div className="bg-white p-3 rounded-lg">
                        <label className="block text-sm font-bold mb-1">Notes</label>
                        <textarea 
  value={prog.notes||''} 
  onClick={(e)=>e.stopPropagation()}
  onChange={(e)=>{
    e.stopPropagation();
    updateChapterProgress(mySchool,chapter.id,'notes',e.target.value);
  }}
  className="w-full border-2 px-3 py-2 rounded-lg cursor-text" 
  rows="2" 
  placeholder="Add notes..."
/>
                      </div>
                    </>
                  )}
                </div>
              </div>
            );
          })}
        </div>
      }
    </div>
  );
}

function BirthdaysPage({teachers}){const todayBirthdays=useMemo(()=>getBirthdays(teachers,'today'),[teachers]);const weekBirthdays=useMemo(()=>getBirthdays(teachers,'week'),[teachers]);const monthBirthdays=useMemo(()=>getBirthdays(teachers,'month'),[teachers]);const todayAnniversaries=useMemo(()=>getAnniversaries(teachers,'today'),[teachers]);const weekAnniversaries=useMemo(()=>getAnniversaries(teachers,'week'),[teachers]);return(<div className="space-y-6"><h2 className="text-3xl font-bold">üéâ Celebrations</h2><div className="grid md:grid-cols-2 gap-6"><>{todayBirthdays.length>0&&<div className="birthday-card p-6 rounded-2xl"><h3 className="text-2xl font-bold text-white mb-4">üéÇ Today's Birthdays</h3>{todayBirthdays.map(t=><div key={t.id} className="bg-white p-4 rounded-lg mb-2"><div className="font-bold text-lg">{t.name}</div><div className="text-sm text-gray-600">{t.school}</div></div>)}</div>}{todayAnniversaries.length>0&&<div className="birthday-card p-6 rounded-2xl"><h3 className="text-2xl font-bold text-white mb-4">üéâ Today's Anniversaries</h3>{todayAnniversaries.map(t=>{const years=new Date().getFullYear()-new Date(t.joiningDate).getFullYear();return(<div key={t.id} className="bg-white p-4 rounded-lg mb-2"><div className="font-bold text-lg">{t.name}</div><div className="text-sm text-gray-600">{years} Years at Avanti</div></div>)})}</div>}</></div><div className="grid md:grid-cols-2 gap-6"><div className="bg-white p-6 rounded-2xl shadow-lg"><h3 className="text-xl font-bold mb-4">This Week's Birthdays</h3>{weekBirthdays.length===0?<p className="text-gray-500">No birthdays this week</p>:<div className="space-y-2">{weekBirthdays.map(t=><div key={t.id} className="p-3 bg-gray-50 rounded-lg"><div className="font-semibold">{t.name}</div><div className="text-sm text-gray-600">{new Date(t.dob).toLocaleDateString(undefined,{month:'short',day:'numeric'})}</div></div>)}</div>}</div><div className="bg-white p-6 rounded-2xl shadow-lg"><h3 className="text-xl font-bold mb-4">This Month's Birthdays</h3>{monthBirthdays.length===0?<p className="text-gray-500">No birthdays this month</p>:<div className="space-y-2 max-h-96 overflow-y-auto">{monthBirthdays.map(t=><div key={t.id} className="p-3 bg-gray-50 rounded-lg"><div className="font-semibold">{t.name}</div><div className="text-sm text-gray-600">{new Date(t.dob).toLocaleDateString(undefined,{month:'short',day:'numeric'})}</div></div>)}</div>}</div></div></div>)}

function TeacherManagement({teachers, teacherAttendance, leaveAdjustments, setLeaveAdjustments, isSuperAdmin = false}){
  const[showModal,setShowModal]=useState(false);
  const[editingTeacher,setEditingTeacher]=useState(null);
  const[showLeaveModal,setShowLeaveModal]=useState(false);
  const[selectedTeacherLeave,setSelectedTeacherLeave]=useState(null);
  const[isEditingLeave,setIsEditingLeave]=useState(false);
  const[leaveForm,setLeaveForm]=useState({entitled: 0, maternity: 0, paternity: 0});
  const[savingLeave,setSavingLeave]=useState(false);
  const[form,setForm]=useState({name:'',afid:'',afCode:'',email:'',password:'',dob:'',joiningDate:'',subject:'',school:'',phone:'',role:'teacher'});
  
  // Archive functionality
  const[showArchiveModal,setShowArchiveModal]=useState(false);
  const[teacherToArchive,setTeacherToArchive]=useState(null);
  const[archiveReason,setArchiveReason]=useState('');
  const[archiveNotes,setArchiveNotes]=useState('');
  const[archiving,setArchiving]=useState(false);
  const[showArchivedTeachers,setShowArchivedTeachers]=useState(false);
  
  // NEW: Bulk Import functionality
  const[showBulkImport,setShowBulkImport]=useState(false);
  const[isImporting,setIsImporting]=useState(false);
  const[importResults,setImportResults]=useState(null);
  const bulkFileInputRef=useRef(null);
  
  // NEW: Bulk CSV Import Handler
  const handleBulkCSVImport = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    Papa.parse(file, {
      complete: async (results) => {
        try {
          setIsImporting(true);
          setImportResults(null);
          const rows = results.data;
          
          if (rows.length < 2) {
            alert('CSV file is empty or has no data rows');
            setIsImporting(false);
            return;
          }
          
          const teachersToAdd = [];
          const errors = [];
          const firebaseAuthList = [];
          
          rows.forEach((row, index) => {
            if (index === 0) return; // Skip header
            
            // Expected columns: AFID, AF Code, Name, Email, Password, Subject, School, DOB, Joining Date, Phone
            const afid = row[0] ? row[0].trim() : '';
            const afCode = row[1] ? row[1].trim() : '';
            const name = row[2] ? row[2].trim() : '';
            const email = row[3] ? row[3].trim().toLowerCase() : '';
            const password = row[4] ? row[4].trim() : '';
            const subject = row[5] ? row[5].trim() : '';
            const school = row[6] ? row[6].trim() : '';
            const dob = row[7] ? row[7].trim() : '';
            const joiningDate = row[8] ? row[8].trim() : '';
            const phone = row[9] ? row[9].trim() : '';
            
            // Validate required fields
            if (!afid || !name || !email || !subject || !school) {
              if (afid || name || email) { // Only report error if row has some data
                errors.push(`Row ${index + 1}: Missing required fields (AFID, Name, Email, Subject, or School)`);
              }
              return;
            }
            
            // Validate subject
            if (!SUBJECTS.includes(subject)) {
              errors.push(`Row ${index + 1}: Invalid subject "${subject}". Must be one of: ${SUBJECTS.join(', ')}`);
              return;
            }
            
            // Validate school
            if (!SCHOOLS.includes(school)) {
              errors.push(`Row ${index + 1}: Invalid school "${school}". Must be one of: ${SCHOOLS.join(', ')}`);
              return;
            }
            
            // Check for duplicate AFID in current batch
            if (teachersToAdd.some(t => t.afid === afid)) {
              errors.push(`Row ${index + 1}: Duplicate AFID "${afid}" in CSV`);
              return;
            }
            
            teachersToAdd.push({
              afid,
              afCode: afCode || null,
              name,
              email,
              subject,
              school,
              dob: dob || null,
              joiningDate: joiningDate || null,
              phone: phone || null,
              isArchived: false
            });
            
            if (password) {
              firebaseAuthList.push({ email, password, name, afid });
            }
          });
          
          if (teachersToAdd.length === 0) {
            alert('No valid teachers found in CSV.\n\nErrors:\n' + errors.join('\n'));
            setIsImporting(false);
            return;
          }
          
          // Check for existing teachers
          const existingAFIDs = teachers.map(t => t.afid);
          const duplicates = teachersToAdd.filter(t => existingAFIDs.includes(t.afid));
          
          if (duplicates.length > 0) {
            const proceed = confirm(`‚ö†Ô∏è Warning: ${duplicates.length} teacher(s) already exist with these AFIDs:\n${duplicates.map(d => `‚Ä¢ ${d.afid} - ${d.name}`).join('\n')}\n\nDo you want to UPDATE these existing teachers?\n\nClick OK to update existing + add new, or Cancel to abort.`);
            if (!proceed) {
              setIsImporting(false);
              if (bulkFileInputRef.current) bulkFileInputRef.current.value = '';
              return;
            }
          }
          
          // Save to Firestore
          let successCount = 0;
          let failCount = 0;
          
          for (const teacher of teachersToAdd) {
            try {
              await db.collection('teachers').doc(teacher.afid).set(teacher);
              successCount++;
            } catch (err) {
              failCount++;
              errors.push(`Failed to save ${teacher.name} (${teacher.afid}): ${err.message}`);
            }
          }
          
          setIsImporting(false);
          
          // Show results
          setImportResults({
            success: successCount,
            failed: failCount,
            errors,
            firebaseAuth: firebaseAuthList
          });
          
          if (bulkFileInputRef.current) bulkFileInputRef.current.value = '';
          
        } catch (e) {
          setIsImporting(false);
          alert('Import failed: ' + e.message);
        }
      },
      error: () => {
        setIsImporting(false);
        alert('Failed to parse CSV file');
      }
    });
  };
  
  const openAddModal=()=>{setEditingTeacher(null);setForm({name:'',afid:'',afCode:'',email:'',password:'',dob:'',joiningDate:'',subject:'',school:'',phone:'',role:'teacher'});setShowModal(true)};
  const openEditModal=teacher=>{setEditingTeacher(teacher);setForm({...teacher,password:'',role:teacher.role||'teacher'});setShowModal(true)};
  
  const openLeaveModal=(teacher)=>{
    const balance = calculateLeaveBalance(teacherAttendance || [], teacher.afid, leaveAdjustments || {});
    const currentAdj = leaveAdjustments[teacher.afid] || { entitled: 0, maternity: 0, paternity: 0 };
    setSelectedTeacherLeave({teacher, balance});
    setLeaveForm({
      entitled: currentAdj.entitled || 0,
      maternity: currentAdj.maternity || 0,
      paternity: currentAdj.paternity || 0
    });
    setIsEditingLeave(false);
    setShowLeaveModal(true);
  };
  
  const handleSaveLeaveAdjustment = async () => {
    if (!selectedTeacherLeave) return;
    
    setSavingLeave(true);
    try {
      const teacherId = selectedTeacherLeave.teacher.afid;
      await db.collection('leaveAdjustments').doc(teacherId).set({
        entitled: parseInt(leaveForm.entitled) || 0,
        maternity: parseInt(leaveForm.maternity) || 0,
        paternity: parseInt(leaveForm.paternity) || 0,
        updatedAt: new Date().toISOString(),
        updatedBy: 'admin'
      });
      
      // Update local state
      setLeaveAdjustments(prev => ({
        ...prev,
        [teacherId]: {
          entitled: parseInt(leaveForm.entitled) || 0,
          maternity: parseInt(leaveForm.maternity) || 0,
          paternity: parseInt(leaveForm.paternity) || 0
        }
      }));
      
      // Recalculate balance with new adjustments
      const newBalance = calculateLeaveBalance(
        teacherAttendance || [], 
        teacherId, 
        {
          ...leaveAdjustments,
          [teacherId]: {
            entitled: parseInt(leaveForm.entitled) || 0,
            maternity: parseInt(leaveForm.maternity) || 0,
            paternity: parseInt(leaveForm.paternity) || 0
          }
        }
      );
      setSelectedTeacherLeave({...selectedTeacherLeave, balance: newBalance});
      
      setIsEditingLeave(false);
      alert('Leave adjustment saved successfully!');
    } catch (e) {
      alert('Failed to save: ' + e.message);
    } finally {
      setSavingLeave(false);
    }
  };
  
  const handleSave=async()=>{if(!form.afid||!form.name||!form.email||!form.subject||!form.school){alert('Please fill all required fields (AFID, Name, Email, Subject, School)');return}try{await db.collection('teachers').doc(form.afid).set({afid:form.afid,afCode:form.afCode||null,name:form.name,email:form.email.toLowerCase(),subject:form.subject,school:form.school,dob:form.dob||null,joiningDate:form.joiningDate||null,phone:form.phone||null,role:form.role||'teacher',isArchived:form.isArchived||false,archiveReason:form.archiveReason||null,archiveNotes:form.archiveNotes||null,archivedAt:form.archivedAt||null});if(!editingTeacher&&form.password){alert(`Teacher added!\n\nCREATE FIREBASE AUTH:\n1. Firebase Console ‚Üí Authentication\n2. Add User\n3. Email: ${form.email}\n4. Password: ${form.password}`)}else{alert(form.role==='apc'?'APC updated!':'Teacher updated!')}setShowModal(false)}catch(e){alert('Failed: '+e.message)}};
  
  // Open archive modal
  const openArchiveModal = (teacher) => {
    setTeacherToArchive(teacher);
    setArchiveReason('');
    setArchiveNotes('');
    setShowArchiveModal(true);
  };
  
  // Handle archive teacher
  const handleArchive = async () => {
    if (!archiveReason) {
      alert('Please select a reason for archiving');
      return;
    }
    
    setArchiving(true);
    try {
      await db.collection('teachers').doc(teacherToArchive.afid).update({
        isArchived: true,
        archiveReason: archiveReason,
        archiveNotes: archiveNotes || '',
        archivedAt: new Date().toISOString(),
        archivedBy: 'admin'
      });
      
      alert(`‚úÖ ${teacherToArchive.name} has been archived.\n\nReason: ${archiveReason}\n\n‚Ä¢ All curriculum data is preserved\n‚Ä¢ Student feedback history is preserved\n‚Ä¢ A new teacher can be assigned to continue`);
      setShowArchiveModal(false);
      setTeacherToArchive(null);
    } catch (e) {
      alert('Failed to archive: ' + e.message);
    } finally {
      setArchiving(false);
    }
  };
  
  // Restore archived teacher
  const handleRestore = async (teacher) => {
    if (!confirm(`Restore ${teacher.name} as an active teacher?`)) return;
    
    try {
      await db.collection('teachers').doc(teacher.afid).update({
        isArchived: false,
        archiveReason: null,
        archiveNotes: null,
        archivedAt: null,
        archivedBy: null,
        restoredAt: new Date().toISOString()
      });
      alert(`‚úÖ ${teacher.name} has been restored as an active teacher.`);
    } catch (e) {
      alert('Failed to restore: ' + e.message);
    }
  };
  
  // Permanently delete (only for archived teachers)
  const handlePermanentDelete = async (teacher) => {
    if (!confirm(`‚ö†Ô∏è PERMANENT DELETE\n\nAre you sure you want to permanently delete ${teacher.name}?\n\nThis action cannot be undone.\nNote: Historical data (feedback, observations) will remain but show "Deleted Teacher".`)) return;
    
    try {
      await db.collection('teachers').doc(teacher.afid).delete();
      alert('Teacher permanently deleted.');
    } catch (e) {
      alert('Failed to delete: ' + e.message);
    }
  };
  
  // Filter teachers based on archive status
  const activeTeachers = teachers.filter(t => !t.isArchived);
  const archivedTeachers = teachers.filter(t => t.isArchived);
  
  // Helper to get leave balance for display
  const getLeaveBalanceDisplay = (teacherId) => {
    const balance = calculateLeaveBalance(teacherAttendance || [], teacherId, leaveAdjustments || {});
    return balance;
  };
  
  return(
    <div className="space-y-6">
      <div className="flex justify-between items-center flex-wrap gap-4">
        <h2 className="text-3xl font-bold">Teacher Management</h2>
        <div className="flex items-center gap-4">
          {/* Toggle for archived teachers */}
          <label className="flex items-center gap-2 cursor-pointer">
            <input 
              type="checkbox" 
              checked={showArchivedTeachers}
              onChange={e => setShowArchivedTeachers(e.target.checked)}
              className="w-5 h-5"
            />
            <span className="text-sm font-medium">
              Show Archived ({archivedTeachers.length})
            </span>
          </label>
          {isSuperAdmin && (
            <button onClick={openAddModal} className="px-6 py-3 bg-blue-600 text-white rounded-xl font-semibold">+ Add Teacher</button>
          )}
        </div>
      </div>
      
      {/* NEW: Bulk Import Section */}
      {isSuperAdmin && (
        <div className="bg-white p-6 rounded-2xl shadow-lg border-2 border-purple-200">
          <div className="flex justify-between items-center mb-4">
            <h3 className="text-xl font-bold text-purple-700">üì§ Bulk Import Teachers</h3>
            <button 
              onClick={() => setShowBulkImport(!showBulkImport)} 
              className="px-4 py-2 bg-purple-100 text-purple-700 rounded-lg font-semibold hover:bg-purple-200"
            >
              {showBulkImport ? '‚ñ≤ Hide' : '‚ñº Expand'}
            </button>
          </div>
          
          {showBulkImport && (
            <div className="space-y-4">
              {/* CSV Format Guide */}
              <div className="p-4 bg-purple-50 border-2 border-purple-200 rounded-xl">
                <p className="font-bold text-purple-800 mb-2">üìã CSV Format (10 columns):</p>
                <div className="text-sm text-purple-700 space-y-1">
                  <p><strong>Column A:</strong> AFID * (unique identifier)</p>
                  <p><strong>Column B:</strong> AF Code (e.g., AF355)</p>
                  <p><strong>Column C:</strong> Name *</p>
                  <p><strong>Column D:</strong> Email *</p>
                  <p><strong>Column E:</strong> Password (for new teachers - you'll need to create in Firebase Auth)</p>
                  <p><strong>Column F:</strong> Subject * (Physics, Chemistry, Mathematics, Biology)</p>
                  <p><strong>Column G:</strong> School * (must match exactly: {SCHOOLS.join(', ')})</p>
                  <p><strong>Column H:</strong> Date of Birth (YYYY-MM-DD)</p>
                  <p><strong>Column I:</strong> Joining Date (YYYY-MM-DD)</p>
                  <p><strong>Column J:</strong> Phone</p>
                </div>
                <p className="text-xs text-purple-600 mt-2">* Required fields</p>
              </div>
              
              {/* Sample CSV Table */}
              <div className="bg-white p-3 rounded-lg text-xs font-mono overflow-x-auto border">
                <table className="w-full border-collapse">
                  <thead>
                    <tr className="bg-gray-100">
                      <th className="border p-1 text-left">AFID</th>
                      <th className="border p-1 text-left">AF Code</th>
                      <th className="border p-1 text-left">Name</th>
                      <th className="border p-1 text-left">Email</th>
                      <th className="border p-1 text-left">Password</th>
                      <th className="border p-1 text-left">Subject</th>
                      <th className="border p-1 text-left">School</th>
                      <th className="border p-1 text-left">DOB</th>
                      <th className="border p-1 text-left">Joining</th>
                      <th className="border p-1 text-left">Phone</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td className="border p-1">T001</td>
                      <td className="border p-1">AF355</td>
                      <td className="border p-1">Rahul Sharma</td>
                      <td className="border p-1">rahul@avanti.org</td>
                      <td className="border p-1">pass123</td>
                      <td className="border p-1">Physics</td>
                      <td className="border p-1">CoE Barwani</td>
                      <td className="border p-1">1990-05-15</td>
                      <td className="border p-1">2023-06-01</td>
                      <td className="border p-1">9876543210</td>
                    </tr>
                    <tr className="bg-gray-50">
                      <td className="border p-1">T002</td>
                      <td className="border p-1">AF356</td>
                      <td className="border p-1">Priya Patel</td>
                      <td className="border p-1">priya@avanti.org</td>
                      <td className="border p-1">pass456</td>
                      <td className="border p-1">Chemistry</td>
                      <td className="border p-1">CoE Bundi</td>
                      <td className="border p-1">1992-08-20</td>
                      <td className="border p-1">2024-01-15</td>
                      <td className="border p-1">9876543211</td>
                    </tr>
                  </tbody>
                </table>
              </div>
              
              {/* Import Button */}
              <div className="flex gap-3">
                <label className={`flex-1 px-6 py-4 ${!isImporting ? 'bg-purple-600 hover:bg-purple-700 cursor-pointer' : 'bg-gray-400 cursor-not-allowed'} text-white rounded-xl font-semibold text-center transition-all`}>
                  {isImporting ? (
                    <span className="flex items-center justify-center gap-2">
                      <svg className="animate-spin h-5 w-5" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" fill="none"/><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/></svg>
                      Importing Teachers...
                    </span>
                  ) : (
                    'üì§ Select CSV File to Import'
                  )}
                  <input 
                    ref={bulkFileInputRef} 
                    type="file" 
                    accept=".csv" 
                    onChange={handleBulkCSVImport} 
                    disabled={isImporting}
                    className="hidden"
                  />
                </label>
              </div>
              
              {/* Import Results */}
              {importResults && (
                <div className={`p-4 rounded-xl ${importResults.failed > 0 ? 'bg-yellow-50 border-2 border-yellow-300' : 'bg-green-50 border-2 border-green-300'}`}>
                  <h4 className="font-bold text-lg mb-2">
                    {importResults.failed > 0 ? '‚ö†Ô∏è Import Completed with Warnings' : '‚úÖ Import Successful!'}
                  </h4>
                  <div className="space-y-2 text-sm">
                    <p className="text-green-700">‚úì {importResults.success} teacher(s) imported successfully</p>
                    {importResults.failed > 0 && (
                      <p className="text-red-700">‚úó {importResults.failed} teacher(s) failed</p>
                    )}
                    
                    {importResults.errors.length > 0 && (
                      <div className="mt-3 p-3 bg-red-50 rounded-lg">
                        <p className="font-bold text-red-700 mb-1">Errors:</p>
                        <ul className="text-red-600 text-xs space-y-1 max-h-32 overflow-y-auto">
                          {importResults.errors.map((err, i) => <li key={i}>‚Ä¢ {err}</li>)}
                        </ul>
                      </div>
                    )}
                    
                    {importResults.firebaseAuth.length > 0 && (
                      <div className="mt-3 p-3 bg-blue-50 rounded-lg">
                        <p className="font-bold text-blue-700 mb-2">üîê Firebase Authentication Required:</p>
                        <p className="text-blue-600 text-xs mb-2">Create these users in Firebase Console ‚Üí Authentication ‚Üí Add User:</p>
                        <div className="bg-white rounded p-2 max-h-40 overflow-y-auto">
                          <table className="w-full text-xs">
                            <thead>
                              <tr className="bg-gray-100">
                                <th className="p-1 text-left">Email</th>
                                <th className="p-1 text-left">Password</th>
                                <th className="p-1 text-left">Name</th>
                              </tr>
                            </thead>
                            <tbody>
                              {importResults.firebaseAuth.map((auth, i) => (
                                <tr key={i} className="border-b">
                                  <td className="p-1 font-mono">{auth.email}</td>
                                  <td className="p-1 font-mono">{auth.password}</td>
                                  <td className="p-1">{auth.name}</td>
                                </tr>
                              ))}
                            </tbody>
                          </table>
                        </div>
                      </div>
                    )}
                  </div>
                  <button 
                    onClick={() => setImportResults(null)} 
                    className="mt-3 px-4 py-2 bg-gray-200 rounded-lg text-sm font-medium hover:bg-gray-300"
                  >
                    Dismiss
                  </button>
                </div>
              )}
            </div>
          )}
        </div>
      )}
      
      {/* Active Teachers Table */}
      <div className="bg-white p-6 rounded-2xl shadow-lg overflow-x-auto">
        <h3 className="text-lg font-bold mb-4 text-green-600">‚úÖ Active Teachers & APCs ({activeTeachers.length})</h3>
        <table className="w-full">
          <thead className="avanti-gradient-light">
            <tr>
              <th className="p-3 text-left">AFID</th>
              <th className="p-3 text-left">AF Code</th>
              <th className="p-3 text-left">Name</th>
              <th className="p-3 text-left">Role</th>
              <th className="p-3 text-left">Email</th>
              <th className="p-3 text-left">Subject</th>
              <th className="p-3 text-left">School</th>
              <th className="p-3 text-center">Leave Balance</th>
              <th className="p-3 text-left">Actions</th>
            </tr>
          </thead>
          <tbody>
            {activeTeachers.map(t => {
              const balance = getLeaveBalanceDisplay(t.afid);
              return (
                <tr key={t.id} className="border-b hover:bg-gray-50">
                  <td className="p-3 font-mono">{t.afid}</td>
                  <td className="p-3 font-mono text-blue-600">{t.afCode || '‚Äî'}</td>
                  <td className="p-3">{t.name}</td>
                  <td className="p-3">
                    <span className={`px-2 py-1 rounded-full text-xs font-semibold ${
                      t.role === 'apc' 
                        ? 'bg-teal-100 text-teal-700' 
                        : 'bg-blue-100 text-blue-700'
                    }`}>
                      {t.role === 'apc' ? 'üìã APC' : 'üë®‚Äçüè´ Teacher'}
                    </span>
                  </td>
                  <td className="p-3 text-sm">{t.email}</td>
                  <td className="p-3">{t.subject}</td>
                  <td className="p-3">{t.school}</td>
                  <td className="p-3">
                    <button 
                      onClick={() => openLeaveModal(t)}
                      className="flex flex-col items-center gap-1 w-full hover:bg-gray-100 p-2 rounded-lg transition-colors"
                    >
                      <div className="flex gap-2 text-xs">
                        <span className="px-2 py-0.5 bg-blue-100 text-blue-700 rounded-full" title="Entitled Leave">
                          E: {balance.entitled.remaining}/{balance.entitled.total}
                        </span>
                      </div>
                      <div className="flex gap-2 text-xs">
                        <span className="px-2 py-0.5 bg-pink-100 text-pink-700 rounded-full" title="Maternity Leave">
                          M: {balance.maternity.remaining}
                        </span>
                        <span className="px-2 py-0.5 bg-purple-100 text-purple-700 rounded-full" title="Paternity Leave">
                          P: {balance.paternity.remaining}
                        </span>
                      </div>
                      <span className="text-xs text-gray-400">Click to view/edit</span>
                    </button>
                  </td>
                  <td className="p-3">
                    {isSuperAdmin ? (
                      <div className="flex gap-2">
                        <button onClick={()=>openEditModal(t)} className="px-3 py-1 bg-yellow-400 rounded-lg">Edit</button>
                        <button onClick={()=>openArchiveModal(t)} className="px-3 py-1 bg-orange-500 text-white rounded-lg" title="Archive instead of delete">Archive</button>
                      </div>
                    ) : (
                      <span className="text-gray-400 text-sm">View Only</span>
                    )}
                  </td>
                </tr>
              );
            })}
          </tbody>
        </table>
      </div>
      
      {/* Archived Teachers Table (Conditional) */}
      {showArchivedTeachers && archivedTeachers.length > 0 && (
        <div className="bg-white p-6 rounded-2xl shadow-lg overflow-x-auto border-2 border-red-200">
          <h3 className="text-lg font-bold mb-4 text-red-600">üì¶ Archived Teachers ({archivedTeachers.length})</h3>
          <table className="w-full">
            <thead className="bg-red-50">
              <tr>
                <th className="p-3 text-left">AFID</th>
                <th className="p-3 text-left">Name</th>
                <th className="p-3 text-left">Subject</th>
                <th className="p-3 text-left">School</th>
                <th className="p-3 text-left">Archive Reason</th>
                <th className="p-3 text-left">Archived Date</th>
                <th className="p-3 text-left">Actions</th>
              </tr>
            </thead>
            <tbody>
              {archivedTeachers.map(t => (
                <tr key={t.id} className="border-b bg-red-50/50 hover:bg-red-100/50">
                  <td className="p-3 font-mono text-red-700">{t.afid}</td>
                  <td className="p-3 text-red-700 font-medium">{t.name}</td>
                  <td className="p-3 text-red-600">{t.subject}</td>
                  <td className="p-3 text-red-600">{t.school}</td>
                  <td className="p-3">
                    <span className={`px-2 py-1 rounded-full text-xs font-bold ${
                      t.archiveReason === 'Resigned' ? 'bg-yellow-100 text-yellow-800' :
                      t.archiveReason === 'Removed' ? 'bg-red-100 text-red-800' :
                      t.archiveReason === 'Transferred' ? 'bg-blue-100 text-blue-800' :
                      'bg-gray-100 text-gray-800'
                    }`}>
                      {t.archiveReason || 'Unknown'}
                    </span>
                    {t.archiveNotes && (
                      <div className="text-xs text-gray-500 mt-1" title={t.archiveNotes}>
                        üìù {t.archiveNotes.length > 30 ? t.archiveNotes.slice(0, 30) + '...' : t.archiveNotes}
                      </div>
                    )}
                  </td>
                  <td className="p-3 text-sm text-gray-600">
                    {t.archivedAt ? new Date(t.archivedAt).toLocaleDateString() : '‚Äî'}
                  </td>
                  <td className="p-3">
                    {isSuperAdmin && (
                      <div className="flex gap-2">
                        <button onClick={() => handleRestore(t)} className="px-3 py-1 bg-green-500 text-white rounded-lg text-sm">Restore</button>
                        <button onClick={() => handlePermanentDelete(t)} className="px-3 py-1 bg-red-600 text-white rounded-lg text-sm">Delete</button>
                      </div>
                    )}
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      )}
      
      {/* Leave Balance Modal */}
      {showLeaveModal && selectedTeacherLeave && (
        <div className="modal-overlay" onClick={() => {setShowLeaveModal(false); setIsEditingLeave(false);}}>
          <div className="modal-content max-w-lg" onClick={e => e.stopPropagation()}>
            <div className="flex justify-between items-center mb-4">
              <h3 className="text-2xl font-bold">üìä Leave Balance - {selectedTeacherLeave.teacher.name}</h3>
              {!isEditingLeave && (
                <button 
                  onClick={() => setIsEditingLeave(true)}
                  className="px-4 py-2 bg-yellow-400 rounded-lg font-semibold text-sm"
                >
                  ‚úèÔ∏è Edit
                </button>
              )}
            </div>
            
            {isEditingLeave ? (
              /* Edit Mode */
              <div className="space-y-4">
                <div className="bg-yellow-50 p-4 rounded-xl border-2 border-yellow-300 mb-4">
                  <p className="text-sm text-yellow-800">
                    <strong>üìù Adjust Prior Leaves:</strong> Enter the number of leaves already taken before this system was implemented. These will be added to the system-tracked leaves.
                  </p>
                </div>
                
                {/* Entitled Leave Edit */}
                <div className="bg-blue-50 p-4 rounded-xl border-2 border-blue-200">
                  <label className="block font-bold text-blue-800 mb-2">Entitled Leave (Prior Adjustment)</label>
                  <div className="flex items-center gap-3">
                    <input 
                      type="number" 
                      min="0" 
                      max="35"
                      value={leaveForm.entitled}
                      onChange={e => setLeaveForm({...leaveForm, entitled: Math.min(35, Math.max(0, parseInt(e.target.value) || 0))})}
                      className="w-24 border-2 px-3 py-2 rounded-lg text-center font-bold text-lg"
                    />
                    <span className="text-blue-700">days taken before system</span>
                  </div>
                  <p className="text-xs text-blue-600 mt-2">Max: 35 days (Personal, Sick, Emergency combined)</p>
                </div>
                
                {/* Maternity Leave Edit */}
                <div className="bg-pink-50 p-4 rounded-xl border-2 border-pink-200">
                  <label className="block font-bold text-pink-800 mb-2">Maternity Leave (Prior Adjustment)</label>
                  <div className="flex items-center gap-3">
                    <input 
                      type="number" 
                      min="0" 
                      max="180"
                      value={leaveForm.maternity}
                      onChange={e => setLeaveForm({...leaveForm, maternity: Math.min(180, Math.max(0, parseInt(e.target.value) || 0))})}
                      className="w-24 border-2 px-3 py-2 rounded-lg text-center font-bold text-lg"
                    />
                    <span className="text-pink-700">days taken before system</span>
                  </div>
                  <p className="text-xs text-pink-600 mt-2">Max: 180 days</p>
                </div>
                
                {/* Paternity Leave Edit */}
                <div className="bg-purple-50 p-4 rounded-xl border-2 border-purple-200">
                  <label className="block font-bold text-purple-800 mb-2">Paternity Leave (Prior Adjustment)</label>
                  <div className="flex items-center gap-3">
                    <input 
                      type="number" 
                      min="0" 
                      max="15"
                      value={leaveForm.paternity}
                      onChange={e => setLeaveForm({...leaveForm, paternity: Math.min(15, Math.max(0, parseInt(e.target.value) || 0))})}
                      className="w-24 border-2 px-3 py-2 rounded-lg text-center font-bold text-lg"
                    />
                    <span className="text-purple-700">days taken before system</span>
                  </div>
                  <p className="text-xs text-purple-600 mt-2">Max: 15 days</p>
                </div>
                
                <div className="flex gap-3 mt-6">
                  <button 
                    onClick={handleSaveLeaveAdjustment}
                    disabled={savingLeave}
                    className="flex-1 avanti-gradient text-white py-3 rounded-xl font-semibold disabled:opacity-50"
                  >
                    {savingLeave ? 'Saving...' : 'üíæ Save Adjustment'}
                  </button>
                  <button 
                    onClick={() => {
                      setIsEditingLeave(false);
                      const currentAdj = leaveAdjustments[selectedTeacherLeave.teacher.afid] || { entitled: 0, maternity: 0, paternity: 0 };
                      setLeaveForm({
                        entitled: currentAdj.entitled || 0,
                        maternity: currentAdj.maternity || 0,
                        paternity: currentAdj.paternity || 0
                      });
                    }}
                    className="flex-1 bg-gray-300 py-3 rounded-xl font-semibold"
                  >
                    Cancel
                  </button>
                </div>
              </div>
            ) : (
              /* View Mode */
              <div className="space-y-4">
                {/* Entitled Leave */}
                <div className="bg-blue-50 p-4 rounded-xl border-2 border-blue-200">
                  <div className="flex justify-between items-center mb-2">
                    <span className="font-bold text-blue-800">Entitled Leave</span>
                    <span className="text-2xl font-bold text-blue-600">
                      {selectedTeacherLeave.balance.entitled.remaining}/{selectedTeacherLeave.balance.entitled.total}
                    </span>
                  </div>
                  <div className="flex justify-between text-sm text-blue-700">
                    <span>Used: {selectedTeacherLeave.balance.entitled.used} days</span>
                    <span>Remaining: {selectedTeacherLeave.balance.entitled.remaining} days</span>
                  </div>
                  {selectedTeacherLeave.balance.entitled.adjustment > 0 && (
                    <div className="text-xs text-blue-600 mt-1">
                      (includes {selectedTeacherLeave.balance.entitled.adjustment} prior adjustment)
                    </div>
                  )}
                  <div className="mt-2 bg-blue-200 rounded-full h-3">
                    <div 
                      className="bg-blue-500 h-3 rounded-full transition-all" 
                      style={{width: `${(selectedTeacherLeave.balance.entitled.remaining/selectedTeacherLeave.balance.entitled.total)*100}%`}}
                    />
                  </div>
                  <p className="text-xs text-blue-600 mt-2">Includes: Personal Leave, Sick Leave, Emergency Leave</p>
                </div>
                
                {/* Maternity Leave */}
                <div className="bg-pink-50 p-4 rounded-xl border-2 border-pink-200">
                  <div className="flex justify-between items-center mb-2">
                    <span className="font-bold text-pink-800">Maternity Leave</span>
                    <span className="text-2xl font-bold text-pink-600">
                      {selectedTeacherLeave.balance.maternity.remaining}/{selectedTeacherLeave.balance.maternity.total}
                    </span>
                  </div>
                  <div className="flex justify-between text-sm text-pink-700">
                    <span>Used: {selectedTeacherLeave.balance.maternity.used} days</span>
                    <span>Remaining: {selectedTeacherLeave.balance.maternity.remaining} days</span>
                  </div>
                  {selectedTeacherLeave.balance.maternity.adjustment > 0 && (
                    <div className="text-xs text-pink-600 mt-1">
                      (includes {selectedTeacherLeave.balance.maternity.adjustment} prior adjustment)
                    </div>
                  )}
                  <div className="mt-2 bg-pink-200 rounded-full h-3">
                    <div 
                      className="bg-pink-500 h-3 rounded-full transition-all" 
                      style={{width: `${(selectedTeacherLeave.balance.maternity.remaining/selectedTeacherLeave.balance.maternity.total)*100}%`}}
                    />
                  </div>
                </div>
                
                {/* Paternity Leave */}
                <div className="bg-purple-50 p-4 rounded-xl border-2 border-purple-200">
                  <div className="flex justify-between items-center mb-2">
                    <span className="font-bold text-purple-800">Paternity Leave</span>
                    <span className="text-2xl font-bold text-purple-600">
                      {selectedTeacherLeave.balance.paternity.remaining}/{selectedTeacherLeave.balance.paternity.total}
                    </span>
                  </div>
                  <div className="flex justify-between text-sm text-purple-700">
                    <span>Used: {selectedTeacherLeave.balance.paternity.used} days</span>
                    <span>Remaining: {selectedTeacherLeave.balance.paternity.remaining} days</span>
                  </div>
                  {selectedTeacherLeave.balance.paternity.adjustment > 0 && (
                    <div className="text-xs text-purple-600 mt-1">
                      (includes {selectedTeacherLeave.balance.paternity.adjustment} prior adjustment)
                    </div>
                  )}
                  <div className="mt-2 bg-purple-200 rounded-full h-3">
                    <div 
                      className="bg-purple-500 h-3 rounded-full transition-all" 
                      style={{width: `${(selectedTeacherLeave.balance.paternity.remaining/selectedTeacherLeave.balance.paternity.total)*100}%`}}
                    />
                  </div>
                </div>
                
                <button 
                  onClick={() => {setShowLeaveModal(false); setIsEditingLeave(false);}}
                  className="w-full mt-6 bg-gray-300 py-3 rounded-xl font-semibold"
                >
                  Close
                </button>
              </div>
            )}
          </div>
        </div>
      )}
      
      {/* Archive Teacher Modal */}
      {showArchiveModal && teacherToArchive && (
        <div className="modal-overlay" onClick={() => setShowArchiveModal(false)}>
          <div className="modal-content max-w-md" onClick={e => e.stopPropagation()}>
            <div className="text-center mb-6">
              <div className="text-5xl mb-3">üì¶</div>
              <h3 className="text-2xl font-bold text-gray-800">Archive Teacher</h3>
              <p className="text-gray-600 mt-2">
                You are about to archive <strong className="text-red-600">{teacherToArchive.name}</strong>
              </p>
            </div>
            
            <div className="bg-blue-50 p-4 rounded-xl mb-4 text-sm">
              <p className="font-bold text-blue-800 mb-2">üìå What happens when you archive:</p>
              <ul className="space-y-1 text-blue-700">
                <li>‚úÖ All curriculum data is <strong>preserved</strong></li>
                <li>‚úÖ Student feedback history is <strong>preserved</strong></li>
                <li>‚úÖ Teacher appears as "Archived" in directory</li>
                <li>‚úÖ Students see "Vacant" for this subject</li>
                <li>‚úÖ New teacher can continue from where they left off</li>
              </ul>
            </div>
            
            <div className="space-y-4">
              <div>
                <label className="block font-bold mb-2 text-gray-700">
                  Reason for Archiving <span className="text-red-500">*</span>
                </label>
                <select
                  value={archiveReason}
                  onChange={e => setArchiveReason(e.target.value)}
                  className="w-full border-2 px-4 py-3 rounded-xl"
                  required
                >
                  <option value="">-- Select Reason --</option>
                  <option value="Resigned">üòî Resigned</option>
                  <option value="Removed">‚ùå Removed</option>
                  <option value="Transferred">üîÑ Transferred to another program</option>
                  <option value="On Long Leave">üèñÔ∏è On Long Leave</option>
                  <option value="Other">üìù Other</option>
                </select>
              </div>
              
              <div>
                <label className="block font-bold mb-2 text-gray-700">Additional Notes (Optional)</label>
                <textarea
                  value={archiveNotes}
                  onChange={e => setArchiveNotes(e.target.value)}
                  placeholder="E.g., Resigned for personal reasons, effective date, etc."
                  className="w-full border-2 px-4 py-3 rounded-xl resize-none"
                  rows="3"
                />
              </div>
            </div>
            
            <div className="flex gap-3 mt-6">
              <button
                onClick={() => setShowArchiveModal(false)}
                className="flex-1 bg-gray-300 py-3 rounded-xl font-semibold"
                disabled={archiving}
              >
                Cancel
              </button>
              <button
                onClick={handleArchive}
                disabled={!archiveReason || archiving}
                className={`flex-1 py-3 rounded-xl font-semibold text-white ${
                  !archiveReason || archiving ? 'bg-gray-400 cursor-not-allowed' : 'bg-orange-500 hover:bg-orange-600'
                }`}
              >
                {archiving ? '‚è≥ Archiving...' : 'üì¶ Archive Teacher'}
              </button>
            </div>
          </div>
        </div>
      )}
      
      {/* Add/Edit Teacher Modal */}
      {showModal && (
        <div className="modal-overlay" onClick={() => setShowModal(false)}>
          <div className="modal-content" onClick={e => e.stopPropagation()}>
            <h3 className="text-2xl font-bold mb-4">{editingTeacher ? 'Edit Teacher' : 'Add New Teacher'}</h3>
            <div className="space-y-4">
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-bold mb-1">AFID *</label>
                  <input type="text" value={form.afid} onChange={e => setForm({...form, afid: e.target.value})} disabled={!!editingTeacher} className="w-full border-2 px-3 py-2 rounded-lg"/>
                </div>
                <div>
                  <label className="block text-sm font-bold mb-1">AF Code (e.g. AF355)</label>
                  <input type="text" value={form.afCode || ''} onChange={e => setForm({...form, afCode: e.target.value})} placeholder="AF355" className="w-full border-2 px-3 py-2 rounded-lg"/>
                </div>
              </div>
              <div>
                <label className="block text-sm font-bold mb-1">Name *</label>
                <input type="text" value={form.name} onChange={e => setForm({...form, name: e.target.value})} className="w-full border-2 px-3 py-2 rounded-lg"/>
              </div>
              <div>
                <label className="block text-sm font-bold mb-1">Email *</label>
                <input type="email" value={form.email} onChange={e => setForm({...form, email: e.target.value})} className="w-full border-2 px-3 py-2 rounded-lg"/>
              </div>
              {!editingTeacher && (
                <div>
                  <label className="block text-sm font-bold mb-1">Password *</label>
                  <input type="password" value={form.password} onChange={e => setForm({...form, password: e.target.value})} className="w-full border-2 px-3 py-2 rounded-lg"/>
                </div>
              )}
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-bold mb-1">Subject *</label>
                  <select value={form.subject} onChange={e => setForm({...form, subject: e.target.value})} className="w-full border-2 px-3 py-2 rounded-lg">
                    <option value="">Select</option>
                    {SUBJECTS.map(s => <option key={s} value={s}>{s}</option>)}
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-bold mb-1">School *</label>
                  <select value={form.school} onChange={e => setForm({...form, school: e.target.value})} className="w-full border-2 px-3 py-2 rounded-lg">
                    <option value="">Select</option>
                    {SCHOOLS.map(s => <option key={s} value={s}>{s}</option>)}
                  </select>
                </div>
              </div>
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-bold mb-1">Date of Birth</label>
                  <input type="date" value={form.dob} onChange={e => setForm({...form, dob: e.target.value})} className="w-full border-2 px-3 py-2 rounded-lg"/>
                </div>
                <div>
                  <label className="block text-sm font-bold mb-1">Joining Date</label>
                  <input type="date" value={form.joiningDate} onChange={e => setForm({...form, joiningDate: e.target.value})} className="w-full border-2 px-3 py-2 rounded-lg"/>
                </div>
              </div>
              <div>
                <label className="block text-sm font-bold mb-1">Phone</label>
                <input type="text" value={form.phone} onChange={e => setForm({...form, phone: e.target.value})} className="w-full border-2 px-3 py-2 rounded-lg"/>
              </div>
              <div>
                <label className="block text-sm font-bold mb-1">Role *</label>
                <select value={form.role || 'teacher'} onChange={e => setForm({...form, role: e.target.value})} className="w-full border-2 px-3 py-2 rounded-lg">
                  <option value="teacher">üë®‚Äçüè´ Teacher</option>
                  <option value="apc">üìã APC (Academic Program Coordinator)</option>
                </select>
                {form.role === 'apc' && (
                  <p className="text-xs text-teal-600 mt-1">
                    ‚ÑπÔ∏è APC can view all subjects, mark student attendance, view teacher attendance, but cannot edit curriculum.
                  </p>
                )}
              </div>
              <div className="flex gap-3">
                <button onClick={handleSave} className="flex-1 avanti-gradient text-white py-3 rounded-xl font-semibold">Save</button>
                <button onClick={() => setShowModal(false)} className="flex-1 bg-gray-300 py-3 rounded-xl font-semibold">Cancel</button>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

function AdminCurriculum({curriculum,addChapter,updateChapter,deleteChapter}){const[selectedSchool,setSelectedSchool]=useState(SCHOOLS[0]);const[selectedSubject,setSelectedSubject]=useState(SUBJECTS[0]);const[selectedGrade,setSelectedGrade]=useState('11');const[showAddForm,setShowAddForm]=useState(false);const[editingChapter,setEditingChapter]=useState(null);const[chapterForm,setChapterForm]=useState({name:'',topics:[],targetDate:'',priority:'medium'});const[newTopic,setNewTopic]=useState('');const fileInputRef=useRef(null);
// NEW: Multi-school selection for bulk CSV import
const[selectedSchoolsForImport,setSelectedSchoolsForImport]=useState([SCHOOLS[0]]);
const[importSubject,setImportSubject]=useState(SUBJECTS[0]);
const[importGrade,setImportGrade]=useState('11');
const[showBulkImport,setShowBulkImport]=useState(false);
const[isImporting,setIsImporting]=useState(false);
// NEW: Bulk delete selection
const[selectedChaptersForDelete,setSelectedChaptersForDelete]=useState([]);
const[isDeleting,setIsDeleting]=useState(false);

const toggleSchoolSelection=(school)=>{
  setSelectedSchoolsForImport(prev=>
    prev.includes(school)?prev.filter(s=>s!==school):[...prev,school]
  );
};
const selectAllSchools=()=>setSelectedSchoolsForImport([...SCHOOLS]);
const deselectAllSchools=()=>setSelectedSchoolsForImport([]);

// NEW: Bulk delete handlers
const toggleChapterSelection=(chapterId)=>{
  setSelectedChaptersForDelete(prev=>
    prev.includes(chapterId)?prev.filter(id=>id!==chapterId):[...prev,chapterId]
  );
};
const selectAllChapters=()=>{
  const docId=`${selectedSchool}_${selectedSubject}_${selectedGrade}`;
  const chapters=curriculum[docId]?.chapters||[];
  setSelectedChaptersForDelete(chapters.map(ch=>ch.id));
};
const deselectAllChapters=()=>setSelectedChaptersForDelete([]);

const handleBulkDelete=async()=>{
  if(selectedChaptersForDelete.length===0){
    alert('Please select chapters to delete');
    return;
  }
  const count=selectedChaptersForDelete.length;
  if(!confirm(`Are you sure you want to delete ${count} chapter${count>1?'s':''}? This action cannot be undone.`))return;
  
  setIsDeleting(true);
  try{
    const docId=`${selectedSchool}_${selectedSubject}_${selectedGrade}`;
    const doc=await db.collection('curriculum').doc(docId).get();
    const existing=doc.exists?(doc.data().chapters||[]):[];
    const updated=existing.filter(ch=>!selectedChaptersForDelete.includes(ch.id));
    await db.collection('curriculum').doc(docId).set({chapters:updated});
    setSelectedChaptersForDelete([]);
    alert(`‚úÖ Successfully deleted ${count} chapter${count>1?'s':''}`);
  }catch(e){
    console.error('Bulk delete error',e);
    alert('Failed to delete chapters: '+e.message);
  }finally{
    setIsDeleting(false);
  }
};

// Clear selection when school/subject/grade changes
React.useEffect(()=>{
  setSelectedChaptersForDelete([]);
},[selectedSchool,selectedSubject,selectedGrade]);

const docId=`${selectedSchool}_${selectedSubject}_${selectedGrade}`;const chapters=curriculum[docId]?.chapters||[];const handleSaveChapter=()=>{if(!chapterForm.name){alert('Chapter name is required');return}if(editingChapter){updateChapter(selectedSchool,selectedSubject,selectedGrade,editingChapter.id,chapterForm);setEditingChapter(null)}else{addChapter(selectedSchool,selectedSubject,selectedGrade,chapterForm)}setChapterForm({name:'',topics:[],targetDate:'',priority:'medium'});setShowAddForm(false)};const handleEditChapter=chapter=>{setEditingChapter(chapter);
  // Convert old string topics to new object format if needed
  const convertedTopics = (chapter.topics||[]).map(t => 
    typeof t === 'string' ? {name: t, priority: 'medium'} : t
  );
  setChapterForm({
  name:chapter.name,
  topics:convertedTopics,
  targetDate:chapter.targetDate||'',
  priority:chapter.priority||'medium'
});setShowAddForm(true)};const handleAddTopic=()=>{if(!newTopic.trim())return;setChapterForm({...chapterForm,topics:[...chapterForm.topics,{name:newTopic.trim(),priority:'medium'}]});setNewTopic('')};

// NEW: Enhanced CSV Import with multi-school support
const handleCSVImport=e=>{
  const file=e.target.files[0];
  if(!file)return;

  // Validate school selection
  if(selectedSchoolsForImport.length===0){
    alert('Please select at least one school');
    if(fileInputRef.current)fileInputRef.current.value='';
    return;
  }

  Papa.parse(file,{
    complete:async results=>{
      try{
        setIsImporting(true);
        const rows=results.data;
        if(rows.length<2){
          alert('CSV file is empty');
          setIsImporting(false);
          return;
        }

        let currentChapter=null;
        const chaptersToAdd=[];

        rows.forEach((row,index)=>{
          if(index===0)return; // Skip header

          const chapterName=row[0]?row[0].trim():'';
          const topicName=row[1]?row[1].trim():'';
          const targetDate=row[2]?row[2].trim():''; // Column C for target date
          const chapterPriorityRaw=row[3]?row[3].trim().toLowerCase():''; // Column D for Chapter Priority
          const topicPriorityRaw=row[4]?row[4].trim().toLowerCase():''; // Column E for Topic Priority

          // Parse chapter priority - accept variations like "High", "HIGH", "high", "H", "1", etc.
          let chapterPriority='medium'; // default
          if(chapterPriorityRaw==='high'||chapterPriorityRaw==='h'||chapterPriorityRaw==='1'||chapterPriorityRaw==='üü¢'){
            chapterPriority='high';
          }else if(chapterPriorityRaw==='medium'||chapterPriorityRaw==='med'||chapterPriorityRaw==='m'||chapterPriorityRaw==='2'||chapterPriorityRaw==='üü°'){
            chapterPriority='medium';
          }else if(chapterPriorityRaw==='low'||chapterPriorityRaw==='l'||chapterPriorityRaw==='3'||chapterPriorityRaw==='üî¥'){
            chapterPriority='low';
          }
          
          // Parse topic priority separately
          let topicPriority='medium'; // default
          if(topicPriorityRaw==='high'||topicPriorityRaw==='h'||topicPriorityRaw==='1'||topicPriorityRaw==='üü¢'){
            topicPriority='high';
          }else if(topicPriorityRaw==='medium'||topicPriorityRaw==='med'||topicPriorityRaw==='m'||topicPriorityRaw==='2'||topicPriorityRaw==='üü°'){
            topicPriority='medium';
          }else if(topicPriorityRaw==='low'||topicPriorityRaw==='l'||topicPriorityRaw==='3'||topicPriorityRaw==='üî¥'){
            topicPriority='low';
          }

          if(chapterName){
            // New chapter row - chapter gets its own priority from Column D
            if(currentChapter){
              chaptersToAdd.push(currentChapter);
            }
            currentChapter={
              name:chapterName,
              topics:topicName?[{name:topicName,priority:topicPriority}]:[], // Topic gets Column E priority
              targetDate:targetDate||'',
              priority:chapterPriority // Chapter-level priority from Column D
            };
          }else if(topicName&&currentChapter){
            // Topic row - each topic gets its own priority from Column E
            currentChapter.topics.push({name:topicName,priority:topicPriority});
          }
        });

        if(currentChapter){
          chaptersToAdd.push(currentChapter);
        }

        if(chaptersToAdd.length===0){
          alert('No valid chapters found in CSV');
          setIsImporting(false);
          return;
        }

        // NEW: Import to ALL selected schools
        let totalImported = 0;
        const failedSchools = [];
        
        for(const school of selectedSchoolsForImport){
          try{
            for(const chapter of chaptersToAdd){
              await addChapter(school,importSubject,importGrade,chapter);
            }
            totalImported++;
          }catch(err){
            failedSchools.push(school);
            console.error(`Failed to import to ${school}:`,err);
          }
        }

        setIsImporting(false);
        
        if(failedSchools.length > 0){
          alert(`Imported ${chaptersToAdd.length} chapters to ${totalImported} schools.\nFailed for: ${failedSchools.join(', ')}`);
        }else{
          alert(`‚úÖ Successfully imported ${chaptersToAdd.length} chapters to ${selectedSchoolsForImport.length} school(s):\n${selectedSchoolsForImport.join(', ')}`);
        }
        
        if(fileInputRef.current)fileInputRef.current.value='';
      }catch(e){
        setIsImporting(false);
        alert('Import failed: '+e.message);
      }
    },
    error:()=>{
      setIsImporting(false);
      alert('Failed to parse CSV');
    }
  });
};

return(<div className="space-y-6"><h2 className="text-3xl font-bold">Curriculum Management</h2>

{/* NEW: Bulk Import Section with Multi-School Checkboxes */}
<div className="bg-white p-6 rounded-2xl shadow-lg border-2 border-green-200">
  <div className="flex justify-between items-center mb-4">
    <h3 className="text-xl font-bold text-green-700">üì§ Bulk Import Curriculum</h3>
    <button 
      onClick={()=>setShowBulkImport(!showBulkImport)} 
      className="px-4 py-2 bg-green-100 text-green-700 rounded-lg font-semibold hover:bg-green-200"
    >
      {showBulkImport ? '‚ñ≤ Hide' : '‚ñº Expand'}
    </button>
  </div>
  
  {showBulkImport && (
    <div className="space-y-4">
      {/* School Checkboxes */}
      <div>
        <div className="flex justify-between items-center mb-2">
          <label className="block text-sm font-bold">Select Schools (can select multiple)</label>
          <div className="flex gap-2">
            <button onClick={selectAllSchools} className="text-xs px-3 py-1 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200">Select All</button>
            <button onClick={deselectAllSchools} className="text-xs px-3 py-1 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200">Clear All</button>
          </div>
        </div>
        <div className="grid grid-cols-2 md:grid-cols-3 gap-2 p-3 bg-gray-50 rounded-xl">
          {SCHOOLS.map(school=>(
            <label key={school} className={`flex items-center gap-2 p-2 rounded-lg cursor-pointer transition-all ${selectedSchoolsForImport.includes(school)?'bg-green-100 border-2 border-green-400':'bg-white border-2 border-gray-200 hover:border-gray-300'}`}>
              <input 
                type="checkbox" 
                checked={selectedSchoolsForImport.includes(school)}
                onChange={()=>toggleSchoolSelection(school)}
                className="w-5 h-5"
              />
              <span className={`text-sm font-medium ${selectedSchoolsForImport.includes(school)?'text-green-700':'text-gray-700'}`}>{school}</span>
            </label>
          ))}
        </div>
        <p className="text-xs text-gray-500 mt-1">Selected: {selectedSchoolsForImport.length} school(s)</p>
      </div>
      
      {/* Subject and Grade */}
      <div className="grid md:grid-cols-2 gap-4">
        <div>
          <label className="block text-sm font-bold mb-2">Subject</label>
          <select value={importSubject} onChange={e=>setImportSubject(e.target.value)} className="w-full border-2 px-4 py-3 rounded-xl">
            {SUBJECTS.map(s=><option key={s} value={s}>{s}</option>)}
          </select>
        </div>
        <div>
          <label className="block text-sm font-bold mb-2">Grade</label>
          <select value={importGrade} onChange={e=>setImportGrade(e.target.value)} className="w-full border-2 px-4 py-3 rounded-xl">
            <option value="11">Class 11</option>
            <option value="12">Class 12</option>
          </select>
        </div>
      </div>
      
      {/* Import Button */}
      <div className="flex gap-3">
        <label className={`flex-1 px-6 py-4 ${selectedSchoolsForImport.length>0&&!isImporting?'bg-green-600 hover:bg-green-700 cursor-pointer':'bg-gray-400 cursor-not-allowed'} text-white rounded-xl font-semibold text-center transition-all`}>
          {isImporting ? (
            <span className="flex items-center justify-center gap-2">
              <svg className="animate-spin h-5 w-5" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" fill="none"/><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/></svg>
              Importing...
            </span>
          ) : (
            `üì§ Import CSV to ${selectedSchoolsForImport.length} School(s)`
          )}
          <input 
            ref={fileInputRef} 
            type="file" 
            accept=".csv" 
            onChange={handleCSVImport} 
            disabled={selectedSchoolsForImport.length===0||isImporting}
            className="hidden"
          />
        </label>
      </div>
      
      {selectedSchoolsForImport.length > 0 && (
        <div className="p-3 bg-green-50 rounded-xl">
          <p className="text-sm text-green-700"><strong>Will import to:</strong> {selectedSchoolsForImport.join(', ')}</p>
          <p className="text-sm text-green-600"><strong>Subject:</strong> {importSubject} | <strong>Grade:</strong> Class {importGrade}</p>
        </div>
      )}
    </div>
  )}
</div>

{/* Existing View/Edit Section */}
<div className="bg-white p-6 rounded-2xl shadow-lg">
<h3 className="text-lg font-bold text-gray-700 mb-4">üìù View & Edit Chapters</h3>
<div className="grid md:grid-cols-3 gap-4 mb-4"><div><label className="block text-sm font-bold mb-2">School</label><select value={selectedSchool} onChange={e=>setSelectedSchool(e.target.value)} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed">{SCHOOLS.map(s=><option key={s} value={s}>{s}</option>)}</select></div><div><label className="block text-sm font-bold mb-2">Subject</label><select value={selectedSubject} onChange={e=>setSelectedSubject(e.target.value)} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed">{SUBJECTS.map(s=><option key={s} value={s}>{s}</option>)}</select></div><div><label className="block text-sm font-bold mb-2">Grade</label><select value={selectedGrade} onChange={e=>setSelectedGrade(e.target.value)} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"><option value="11">Class 11</option><option value="12">Class 12</option></select></div></div><div className="flex gap-3"><button onClick={()=>{setEditingChapter(null);setChapterForm({name:'',topics:[],targetDate:'',priority:'medium'});setShowAddForm(!showAddForm)}} className="px-6 py-3 bg-blue-600 text-white rounded-xl font-semibold">{showAddForm?'Cancel':'+ Add Chapter'}</button></div>

{/* CSV Format Guide */}
<div className="mt-4 p-4 bg-blue-50 border-2 border-blue-200 rounded-xl">
  <p className="font-bold text-blue-800 mb-2">üìã CSV Import Format (5 columns) - Separate Chapter & Topic Priorities:</p>
  <div className="text-sm text-blue-700 space-y-1">
    <p><strong>Column A:</strong> Chapter Name (leave blank for topics under same chapter)</p>
    <p><strong>Column B:</strong> Topic Name</p>
    <p><strong>Column C:</strong> Target Date (YYYY-MM-DD format, only for chapter rows)</p>
    <p><strong>Column D:</strong> <span className="text-purple-700 font-bold">Chapter Priority</span> (High, Medium, Low) - <span className="font-bold text-purple-600">Only for chapter rows!</span></p>
    <p><strong>Column E:</strong> <span className="text-green-700 font-bold">Topic Priority</span> (High, Medium, Low) - <span className="font-bold text-green-600">For each topic!</span></p>
  </div>
  <div className="mt-3 bg-white p-3 rounded-lg text-xs font-mono overflow-x-auto">
    <table className="w-full border-collapse">
      <thead>
        <tr className="bg-gray-100">
          <th className="border p-1 text-left">Chapter Name</th>
          <th className="border p-1 text-left">Topic Name</th>
          <th className="border p-1 text-left">Target Date</th>
          <th className="border p-1 text-left text-purple-700">Chapter Priority</th>
          <th className="border p-1 text-left text-green-700">Topic Priority</th>
        </tr>
      </thead>
      <tbody>
        <tr className="bg-green-50"><td className="border p-1 font-bold">Laws of Motion</td><td className="border p-1">Newton's First Law</td><td className="border p-1">2025-02-15</td><td className="border p-1 text-purple-700 font-bold">High</td><td className="border p-1 text-green-700">High</td></tr>
        <tr><td className="border p-1"></td><td className="border p-1">Newton's Second Law</td><td className="border p-1"></td><td className="border p-1 text-gray-400">-</td><td className="border p-1 text-green-700">High</td></tr>
        <tr><td className="border p-1"></td><td className="border p-1">Newton's Third Law</td><td className="border p-1"></td><td className="border p-1 text-gray-400">-</td><td className="border p-1 text-yellow-700">Medium</td></tr>
        <tr className="bg-yellow-50"><td className="border p-1 font-bold">Thermodynamics</td><td className="border p-1">First Law</td><td className="border p-1">2025-03-01</td><td className="border p-1 text-purple-700 font-bold">Medium</td><td className="border p-1 text-yellow-700">Medium</td></tr>
        <tr><td className="border p-1"></td><td className="border p-1">Second Law</td><td className="border p-1"></td><td className="border p-1 text-gray-400">-</td><td className="border p-1 text-red-700">Low</td></tr>
        <tr><td className="border p-1"></td><td className="border p-1">Carnot Engine</td><td className="border p-1"></td><td className="border p-1 text-gray-400">-</td><td className="border p-1 text-green-700">High</td></tr>
      </tbody>
    </table>
  </div>
  <div className="mt-2 space-y-1 text-xs">
    <p className="text-blue-600">üí° <strong>Priority accepts:</strong> High/H/1 (üü¢), Medium/Med/M/2 (üü°), Low/L/3 (üî¥). Default is Medium.</p>
    <p className="text-purple-700">üìÇ <strong>Column D (Chapter Priority):</strong> Set priority for the entire chapter. Only needed on chapter rows (where Column A has a value).</p>
    <p className="text-green-700">üìù <strong>Column E (Topic Priority):</strong> Set priority for each individual topic. Can be different from chapter priority!</p>
  </div>
</div>

</div>{showAddForm&&<div className="bg-white p-6 rounded-2xl shadow-lg"><h4 className="text-xl font-bold mb-4">{editingChapter?'Edit Chapter':'Add New Chapter'}</h4><div className="space-y-4"><div><label className="block text-sm font-bold mb-2">Chapter Name *</label><input type="text" value={chapterForm.name} onChange={e=>setChapterForm({...chapterForm,name:e.target.value})} className="w-full border-2 px-4 py-3 rounded-xl"/></div><div><label className="block text-sm font-bold mb-2">Target Date</label><input type="date" value={chapterForm.targetDate} onChange={e=>setChapterForm({...chapterForm,targetDate:e.target.value})} className="w-full border-2 px-4 py-3 rounded-xl"/></div><div>
  <label className="block text-sm font-bold mb-2">Priority Level</label>
  <select 
    value={chapterForm.priority||'medium'} 
    onChange={e=>setChapterForm({...chapterForm,priority:e.target.value})} 
    className="w-full border-2 px-4 py-3 rounded-xl"
  >
    <option value="high">üü¢ High Priority</option>
    <option value="medium">üü° Medium Priority</option>
    <option value="low">üî¥ Low Priority</option>
  </select>
</div><div><label className="block text-sm font-bold mb-2">Topics</label><div className="flex gap-2 mb-3"><input type="text" value={newTopic} onChange={e=>setNewTopic(e.target.value)} onKeyPress={e=>e.key==='Enter'&&handleAddTopic()} className="flex-1 border-2 px-4 py-3 rounded-xl" placeholder="Enter topic"/><button onClick={handleAddTopic} className="px-6 py-3 bg-blue-600 text-white rounded-xl">Add</button></div><div className="space-y-2">{chapterForm.topics.map((topic,idx)=>{
  const topicName = typeof topic === 'string' ? topic : topic.name;
  const topicPriority = typeof topic === 'string' ? 'medium' : (topic.priority || 'medium');
  return (
    <div key={idx} className="flex justify-between items-center p-3 bg-gray-50 rounded-lg gap-2">
      <span className="flex-1">{topicName}</span>
      <select 
        value={topicPriority}
        onChange={(e)=>{
          const updated = [...chapterForm.topics];
          updated[idx] = {name: topicName, priority: e.target.value};
          setChapterForm({...chapterForm, topics: updated});
        }}
        className="border px-2 py-1 rounded-lg text-sm"
      >
        <option value="high">üü¢ High</option>
        <option value="medium">üü° Medium</option>
        <option value="low">üî¥ Low</option>
      </select>
      <button onClick={()=>{const updated=chapterForm.topics.filter((_,i)=>i!==idx);setChapterForm({...chapterForm,topics:updated})}} className="px-3 py-1 bg-red-500 text-white rounded-lg">Remove</button>
    </div>
  );
})}</div></div><button onClick={handleSaveChapter} className="px-6 py-3 avanti-gradient text-white rounded-xl font-semibold">{editingChapter?'Update Chapter':'Save Chapter'}</button></div></div>}<div className="bg-white p-6 rounded-2xl shadow-lg"><div className="flex flex-wrap justify-between items-center gap-3 mb-4"><h4 className="text-xl font-bold">{selectedSchool} - {selectedSubject} - Class {selectedGrade} ({chapters.length} chapters)</h4>{chapters.length>0&&<div className="flex flex-wrap gap-2 items-center"><span className="text-sm text-gray-600 mr-2">{selectedChaptersForDelete.length} selected</span><button onClick={selectAllChapters} className="px-3 py-1 bg-blue-100 text-blue-700 rounded-lg text-sm font-semibold hover:bg-blue-200">Select All</button><button onClick={deselectAllChapters} className="px-3 py-1 bg-gray-100 text-gray-700 rounded-lg text-sm font-semibold hover:bg-gray-200">Deselect All</button><button onClick={handleBulkDelete} disabled={selectedChaptersForDelete.length===0||isDeleting} className={`px-4 py-1 rounded-lg text-sm font-semibold ${selectedChaptersForDelete.length===0?'bg-gray-200 text-gray-400 cursor-not-allowed':'bg-red-500 text-white hover:bg-red-600'}`}>{isDeleting?'Deleting...':'üóëÔ∏è Delete Selected ('+selectedChaptersForDelete.length+')'}</button></div>}</div>{chapters.length===0?<p className="text-gray-500 text-center py-8">No chapters yet</p>:<div className="space-y-3">{chapters.map(ch=><div key={ch.id} className={`border-2 rounded-xl p-4 hover:bg-gray-50 ${selectedChaptersForDelete.includes(ch.id)?'bg-red-50 border-red-300':''}`}><div className="flex justify-between items-start"><div className="flex items-start gap-3"><input type="checkbox" checked={selectedChaptersForDelete.includes(ch.id)} onChange={()=>toggleChapterSelection(ch.id)} className="mt-1 w-5 h-5 cursor-pointer"/><div className="flex-1"><h5 className="font-bold text-lg">{ch.name}</h5><p className="text-sm text-gray-600">Target: {ch.targetDate||'Not set'} | Topics: {ch.topics?.length||0}</p><div className="mt-2">
    {(ch.priority==='high'||!ch.priority)&&(
      <span className="priority-badge priority-high text-xs">üü¢ High Priority</span>
    )}
    {ch.priority==='medium'&&(
      <span className="priority-badge priority-medium text-xs">üü° Medium Priority</span>
    )}
    {ch.priority==='low'&&(
      <span className="priority-badge priority-low text-xs">üî¥ Low Priority</span>
    )}
  </div>{ch.topics&&ch.topics.length>0&&<ul className="text-xs text-gray-600 ml-4 mt-2">{ch.topics.map((t,i)=>{
    const topicName = typeof t === 'string' ? t : t.name;
    const topicPriority = typeof t === 'string' ? 'medium' : (t.priority || 'medium');
    const priorityIcon = topicPriority === 'high' ? 'üü¢' : topicPriority === 'medium' ? 'üü°' : 'üî¥';
    return <li key={i}>‚Ä¢ {topicName} <span className="ml-1">{priorityIcon}</span></li>;
  })}</ul>}</div></div><div className="flex gap-2 mt-2 md:mt-0 flex-shrink-0"><button onClick={()=>handleEditChapter(ch)} className="px-3 py-1 bg-yellow-400 rounded-lg">Edit</button><button onClick={()=>deleteChapter(selectedSchool,selectedSubject,selectedGrade,ch.id)} className="px-3 py-1 bg-red-500 text-white rounded-lg">Delete</button></div></div></div>)}</div>}</div></div>)}
function AdminAnalytics({teachers,curriculum,chapterProgress,accessibleSchools = SCHOOLS,isSuperAdmin = false, isDirector = false}){
  // ‚úÖ FIX: Directors and PMs get full data access - for this component, use props since currentUser isn't passed
  // Note: If caller passes isDirector=true for PMs, they get full access
  const hasFullDataAccess = isSuperAdmin || isDirector;
  
  // ‚úÖ FIX: Case-insensitive school matching helper
  const schoolMatchesFilter = (itemSchool, selectedSchools) => {
    if (!selectedSchools || selectedSchools.length === 0) return false;
    if (!itemSchool) return false;
    const itemSchoolLower = itemSchool.toString().toLowerCase().trim();
    return selectedSchools.some(s => s && s.toString().toLowerCase().trim() === itemSchoolLower);
  };
  
  // Available schools for dropdown
  const availableSchoolOptions = hasFullDataAccess ? SCHOOLS : accessibleSchools;
  
  // Multi-select: Use arrays instead of single values
  const initialSchools = hasFullDataAccess ? [...SCHOOLS] : [...accessibleSchools];
  const[filterSchools,setFilterSchools]=useState(initialSchools);
  const[filterGrade,setFilterGrade]=useState('All');
  const[filterTeachers,setFilterTeachers]=useState([]);

  // Filter teachers based on selected schools
  const availableTeachers = useMemo(() => {
    if (filterSchools.length === 0) return [];
    return teachers.filter(t => schoolMatchesFilter(t.school, filterSchools));
  }, [teachers, filterSchools]);

  // Reset teacher selection when schools change
  React.useEffect(() => {
    const validTeachers = filterTeachers.filter(afid => 
      availableTeachers.some(t => t.afid === afid)
    );
    if (validTeachers.length !== filterTeachers.length) {
      setFilterTeachers(validTeachers);
    }
  }, [availableTeachers]);

  const chart1Ref=useRef(null);
  const chart2Ref=useRef(null);
  const chart3Ref=useRef(null);
  const chart4Ref=useRef(null);
  const chart5Ref=useRef(null);
  const chart6Ref=useRef(null);
  const chart7Ref=useRef(null);
  const chart8Ref=useRef(null);

  const chartInstances=useRef({});

  const filteredData=useMemo(()=>{
  const data={
    totalChapters:0,
    completedChapters:0,
    delayedChapters:0,
    aheadChapters:0,
    testsCompleted:0,
    testsPending:0,
    schoolData:{},
    subjectData:{},
    gradeData:{},
    teacherData:{},
    statusData:{ahead:0,ontrack:0,delayed:0,pending:0},
    testData:{completed:0,pending:0}
  };

  // Multi-select: Use selected schools array directly
  const schoolsToProcess = filterSchools.length > 0 ? filterSchools : [];
  const gradesToProcess=filterGrade==='All'?['11','12']:[filterGrade];
  // Multi-select: Filter teachers based on selection - use case-insensitive matching
  const teachersFiltered = filterTeachers.length === 0 
    ? teachers.filter(t => schoolMatchesFilter(t.school, schoolsToProcess))
    : teachers.filter(t => filterTeachers.includes(t.afid));

  schoolsToProcess.forEach(school=>{
    if(!data.schoolData[school]){
      data.schoolData[school]={total:0,completed:0,delayed:0,ahead:0,tests:0,testsPending:0};
    }

    SUBJECTS.forEach(subject=>{
      if(!data.subjectData[subject]){
        data.subjectData[subject]={total:0,completed:0,testsCompleted:0,testsPending:0};
      }

      gradesToProcess.forEach(grade=>{
        if(!data.gradeData[grade]){
          data.gradeData[grade]={total:0,completed:0,testsCompleted:0,testsPending:0};
        }

        const docId=`${school}_${subject}_${grade}`;
        const chapters=curriculum[docId]?.chapters||[];

        // ‚úÖ FIX: Use case-insensitive matching for teacher school
        const relevantTeachers=teachersFiltered.filter(t=>t.school?.toLowerCase()===school?.toLowerCase()&&t.subject===subject);
        if(filterTeachers.length>0&&relevantTeachers.length===0)return;

        chapters.forEach(ch=>{
          data.totalChapters++;
          data.schoolData[school].total++;
          data.subjectData[subject].total++;
          data.gradeData[grade].total++;

          const progressId=`${school}_${ch.id}`;
          const prog=chapterProgress[progressId]||{};
          const status=getChapterStatus(ch,prog);

          if(prog.completed==='Yes'){
            data.completedChapters++;
            data.schoolData[school].completed++;
            data.subjectData[subject].completed++;
            data.gradeData[grade].completed++;

            if(prog.testConducted==='Yes'){
              data.testsCompleted++;
              data.schoolData[school].tests++;
              data.subjectData[subject].testsCompleted++;
              data.gradeData[grade].testsCompleted++;
              data.testData.completed++;
            }else{
              data.testsPending++;
              data.schoolData[school].testsPending++;
              data.subjectData[subject].testsPending++;
              data.gradeData[grade].testsPending++;
              data.testData.pending++;
            }

            if(status.class==='status-ahead'){
              data.aheadChapters++;
              data.schoolData[school].ahead++;
              data.statusData.ahead++;
            }else if(status.class==='status-ontrack'){
              data.statusData.ontrack++;
            }
          }

          if(status.label.includes('Delayed')){
            data.delayedChapters++;
            data.schoolData[school].delayed++;
            data.statusData.delayed++;
          }

          if(status.label==='Pending'){
            data.statusData.pending++;
          }
        });
      });
    });
  });

  teachersFiltered.forEach(teacher=>{
    if(!data.teacherData[teacher.afid]){
      data.teacherData[teacher.afid]={name:teacher.name,total:0,completed:0};
    }
  });

  return data;
},[curriculum,chapterProgress,teachers,filterSchools,filterGrade,filterTeachers]);

  useEffect(()=>{
    Object.values(chartInstances.current).forEach(chart=>{
      if(chart)chart.destroy();
    });
    chartInstances.current={};

    if(chart1Ref.current){
      const ctx=chart1Ref.current.getContext('2d');
      const schools=Object.keys(filteredData.schoolData);
      chartInstances.current.chart1=new Chart(ctx,{
        type:'bar',
        data:{
          labels:schools,
          datasets:[{
            label:'Completion %',
            data:schools.map(s=>{
              const d=filteredData.schoolData[s];
              return d.total?Math.round((d.completed/d.total)*100):0;
            }),
            backgroundColor:'#C8342E',
            borderRadius:8
          }]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            title:{display:true,text:'School-wise Completion %',font:{size:16,weight:'bold'}},
            legend:{display:false}
          },
          scales:{y:{beginAtZero:true,max:100,ticks:{callback:v=>v+'%'}}}
        }
      });
    }

    if(chart2Ref.current){
      const ctx=chart2Ref.current.getContext('2d');
      const subjects=Object.keys(filteredData.subjectData);
      chartInstances.current.chart2=new Chart(ctx,{
        type:'pie',
        data:{
          labels:subjects,
          datasets:[{
            data:subjects.map(s=>filteredData.subjectData[s].completed),
            backgroundColor:['#D4A574','#5B8A8A','#7BA3A3','#C17A6E'],
            borderWidth:2,
            borderColor:'#fff'
          }]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            title:{display:true,text:'Completed Chapters by Subject',font:{size:16,weight:'bold'}},
            legend:{position:'bottom'}
          }
        }
      });
    }

    if(chart3Ref.current){
      const ctx=chart3Ref.current.getContext('2d');
      const grades=Object.keys(filteredData.gradeData);
      chartInstances.current.chart3=new Chart(ctx,{
        type:'bar',
        data:{
          labels:grades.map(g=>`Class ${g}`),
          datasets:[
            {
              label:'Completed',
              data:grades.map(g=>filteredData.gradeData[g].completed),
              backgroundColor:'#5B8A8A'
            },
            {
              label:'Pending',
              data:grades.map(g=>filteredData.gradeData[g].total-filteredData.gradeData[g].completed),
              backgroundColor:'#D4A574'
            }
          ]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            title:{display:true,text:'Grade-wise Progress',font:{size:16,weight:'bold'}},
            legend:{position:'bottom'}
          },
          scales:{x:{stacked:true},y:{stacked:true,beginAtZero:true}}
        }
      });
    }

    if(chart4Ref.current){
      const ctx=chart4Ref.current.getContext('2d');
      chartInstances.current.chart4=new Chart(ctx,{
        type:'doughnut',
        data:{
          labels:['Completed','Pending','Delayed'],
          datasets:[{
            data:[
              filteredData.completedChapters,
              filteredData.totalChapters-filteredData.completedChapters-filteredData.delayedChapters,
              filteredData.delayedChapters
            ],
            backgroundColor:['#5B8A8A','#D4A574','#C17A6E'],
            borderWidth:2,
            borderColor:'#fff'
          }]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            title:{display:true,text:'Overall Chapter Status',font:{size:16,weight:'bold'}},
            legend:{position:'bottom'}
          }
        }
      });
    }

    if(chart5Ref.current){
      const ctx=chart5Ref.current.getContext('2d');
      chartInstances.current.chart5=new Chart(ctx,{
        type:'pie',
        data:{
          labels:['Tests Completed','Tests Pending'],
          datasets:[{
            data:[filteredData.testsCompleted,filteredData.testsPending],
            backgroundColor:['#5B8A8A','#D4A574'],
            borderWidth:2,
            borderColor:'#fff'
          }]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            title:{display:true,text:'Chapter Tests Status',font:{size:16,weight:'bold'}},
            legend:{position:'bottom'}
          }
        }
      });
    }

    if(chart6Ref.current){
      const ctx=chart6Ref.current.getContext('2d');
      chartInstances.current.chart6=new Chart(ctx,{
        type:'bar',
        data:{
          labels:['Ahead','On Track','Delayed','Pending'],
          datasets:[{
            label:'Chapters',
            data:[
              filteredData.statusData.ahead,
              filteredData.statusData.ontrack,
              filteredData.statusData.delayed,
              filteredData.statusData.pending
            ],
            backgroundColor:['#5B8A8A','#7BA3A3','#D4A574','#C17A6E'],
            borderRadius:8
          }]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            title:{display:true,text:'Performance Status Distribution',font:{size:16,weight:'bold'}},
            legend:{display:false}
          },
          scales:{y:{beginAtZero:true}}
        }
      });
    }

    if(chart7Ref.current){
      const ctx=chart7Ref.current.getContext('2d');
      const schools=Object.keys(filteredData.schoolData);
      chartInstances.current.chart7=new Chart(ctx,{
        type:'bar',
        data:{
          labels:schools,
          datasets:[{
            label:'Delayed Chapters',
            data:schools.map(s=>filteredData.schoolData[s].delayed),
            backgroundColor:'#C17A6E',
            borderRadius:6
          }]
        },
        options:{
          indexAxis:'y',
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            title:{display:true,text:'Delayed Chapters by School',font:{size:16,weight:'bold'}},
            legend:{display:false}
          },
          scales:{x:{beginAtZero:true}}
        }
      });
    }

    if(chart8Ref.current){
      const ctx=chart8Ref.current.getContext('2d');
      const subjects=Object.keys(filteredData.subjectData);
      chartInstances.current.chart8=new Chart(ctx,{
        type:'doughnut',
        data:{
          labels:subjects.map(s=>`${s} - ${filteredData.subjectData[s].total?Math.round((filteredData.subjectData[s].completed/filteredData.subjectData[s].total)*100):0}%`),
          datasets:[{
            data:subjects.map(s=>filteredData.subjectData[s].completed),
            backgroundColor:['#D4A574','#5B8A8A','#7BA3A3','#C17A6E'],
            borderWidth:2,
            borderColor:'#fff'
          }]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            title:{display:true,text:'Subject-wise Completion Rate',font:{size:16,weight:'bold'}},
            legend:{position:'bottom'}
          }
        }
      });
    }

    return()=>{
      Object.values(chartInstances.current).forEach(chart=>{
        if(chart)chart.destroy();
      });
    };
  },[filteredData]);

  const handleExport=()=>{
    // Create workbook with multiple sheets
    const wb = XLSX.utils.book_new();
    
    // Sheet 1: School-wise Summary
    const schoolData = Object.keys(filteredData.schoolData).map(school=>({
      School: school,
      'Total Chapters': filteredData.schoolData[school].total,
      'Completed': filteredData.schoolData[school].completed,
      'Delayed': filteredData.schoolData[school].delayed,
      'Ahead': filteredData.schoolData[school].ahead,
      'Tests Completed': filteredData.schoolData[school].tests,
      'Tests Pending': filteredData.schoolData[school].testsPending,
      'Completion %': filteredData.schoolData[school].total ? Math.round((filteredData.schoolData[school].completed/filteredData.schoolData[school].total)*100) : 0
    }));
    const wsSchool = XLSX.utils.json_to_sheet(schoolData);
    XLSX.utils.book_append_sheet(wb, wsSchool, "School Summary");
    
    // Sheet 2: Subject-wise Summary
    const subjectData = Object.keys(filteredData.subjectData).map(subject=>({
      Subject: subject,
      'Total Chapters': filteredData.subjectData[subject].total,
      'Completed': filteredData.subjectData[subject].completed,
      'Tests Completed': filteredData.subjectData[subject].testsCompleted,
      'Tests Pending': filteredData.subjectData[subject].testsPending,
      'Completion %': filteredData.subjectData[subject].total ? Math.round((filteredData.subjectData[subject].completed/filteredData.subjectData[subject].total)*100) : 0
    }));
    const wsSubject = XLSX.utils.json_to_sheet(subjectData);
    XLSX.utils.book_append_sheet(wb, wsSubject, "Subject Summary");
    
    // Sheet 3: Grade-wise Summary
    const gradeData = Object.keys(filteredData.gradeData).map(grade=>({
      Grade: `Class ${grade}`,
      'Total Chapters': filteredData.gradeData[grade].total,
      'Completed': filteredData.gradeData[grade].completed,
      'Tests Completed': filteredData.gradeData[grade].testsCompleted,
      'Tests Pending': filteredData.gradeData[grade].testsPending,
      'Completion %': filteredData.gradeData[grade].total ? Math.round((filteredData.gradeData[grade].completed/filteredData.gradeData[grade].total)*100) : 0
    }));
    const wsGrade = XLSX.utils.json_to_sheet(gradeData);
    XLSX.utils.book_append_sheet(wb, wsGrade, "Grade Summary");
    
    // Sheet 4: Teacher-wise Detailed Data
    const teacherDetailedData = [];
    const teachersToExport = filterTeachers.length > 0 
      ? teachers.filter(t => filterTeachers.includes(t.afid))
      : teachers.filter(t => filterSchools.includes(t.school));
    
    teachersToExport.forEach(teacher => {
      const gradesToProcess = filterGrade === 'All' ? ['11', '12'] : [filterGrade];
      let teacherTotal = 0, teacherCompleted = 0, teacherTests = 0, teacherDelayed = 0;
      
      gradesToProcess.forEach(grade => {
        const docId = `${teacher.school}_${teacher.subject}_${grade}`;
        const chapters = curriculum[docId]?.chapters || [];
        
        chapters.forEach(ch => {
          teacherTotal++;
          const progressId = `${teacher.school}_${ch.id}`;
          const prog = chapterProgress[progressId] || {};
          const status = getChapterStatus(ch, prog);
          
          if (prog.completed === 'Yes') {
            teacherCompleted++;
            if (prog.testConducted === 'Yes') teacherTests++;
          }
          if (status.label.includes('Delayed')) teacherDelayed++;
        });
      });
      
      if (teacherTotal > 0) {
        teacherDetailedData.push({
          'Teacher Name': teacher.name,
          'AFID': teacher.afid,
          'School': teacher.school,
          'Subject': teacher.subject,
          'Total Chapters': teacherTotal,
          'Completed': teacherCompleted,
          'Delayed': teacherDelayed,
          'Tests Completed': teacherTests,
          'Tests Pending': teacherCompleted - teacherTests,
          'Completion %': Math.round((teacherCompleted/teacherTotal)*100)
        });
      }
    });
    
    if (teacherDetailedData.length > 0) {
      const wsTeacher = XLSX.utils.json_to_sheet(teacherDetailedData);
      XLSX.utils.book_append_sheet(wb, wsTeacher, "Teacher Summary");
    }
    
    // Sheet 5: Chapter Details with Completion Dates
    const chapterDetailsData = [];
    const schoolsToProcess = filterSchools.length > 0 ? filterSchools : [];
    const gradesToProcess = filterGrade === 'All' ? ['11', '12'] : [filterGrade];
    
    schoolsToProcess.forEach(school => {
      SUBJECTS.forEach(subject => {
        gradesToProcess.forEach(grade => {
          const docId = `${school}_${subject}_${grade}`;
          const chapters = curriculum[docId]?.chapters || [];
          
          chapters.forEach((ch, idx) => {
            const progressId = `${school}_${ch.id}`;
            const prog = chapterProgress[progressId] || {};
            const status = getChapterStatus(ch, prog);
            
            // Calculate days difference if both dates exist
            let daysDiff = '‚Äî';
            if(prog.completionDate && ch.targetDate) {
              const target = new Date(ch.targetDate);
              const completion = new Date(prog.completionDate);
              const diff = Math.ceil((completion - target) / (1000 * 60 * 60 * 24));
              daysDiff = diff > 0 ? `+${diff} days (Late)` : diff < 0 ? `${diff} days (Early)` : 'On Time';
            }
            
            // Find teacher for this school/subject
            const teacher = teachers.find(t => 
              t.school?.toLowerCase() === school?.toLowerCase() && t.subject === subject
            );
            
            chapterDetailsData.push({
              'School': school,
              'Subject': subject,
              'Grade': `Class ${grade}`,
              'Teacher': teacher?.name || '‚Äî',
              'Chapter Name': ch.name || '‚Äî',
              'Target Date': ch.targetDate || '‚Äî',
              'Completed': prog.completed || 'No',
              'Completion Date': prog.completionDate || '‚Äî',
              'Days Difference': daysDiff,
              'Status': status.label,
              'Test Conducted': prog.testConducted || 'No',
              'Notes': prog.notes || '‚Äî'
            });
          });
        });
      });
    });
    
    if (chapterDetailsData.length > 0) {
      const wsChapterDetails = XLSX.utils.json_to_sheet(chapterDetailsData);
      XLSX.utils.book_append_sheet(wb, wsChapterDetails, "Chapter Details");
    }
    
    // Sheet 6: Overall Summary
    const overallData = [{
      'Total Chapters': filteredData.totalChapters,
      'Completed': filteredData.completedChapters,
      'Delayed': filteredData.delayedChapters,
      'Ahead': filteredData.aheadChapters,
      'Tests Completed': filteredData.testsCompleted,
      'Tests Pending': filteredData.testsPending,
      'Overall Completion %': filteredData.totalChapters ? Math.round((filteredData.completedChapters/filteredData.totalChapters)*100) : 0,
      'Schools Selected': filterSchools.join(', '),
      'Grade Filter': filterGrade,
      'Teachers Selected': filterTeachers.length === 0 ? 'All' : filterTeachers.length + ' teachers'
    }];
    const wsOverall = XLSX.utils.json_to_sheet(overallData);
    XLSX.utils.book_append_sheet(wb, wsOverall, "Overall Summary");
    
    // Save the workbook
    XLSX.writeFile(wb, `analytics_report_${new Date().toISOString().slice(0,10)}.xlsx`);
  };

  return(
    <div className="space-y-6">
      <div className="flex justify-between items-center">
        <h2 className="text-3xl font-bold">üìä Analytics Dashboard</h2>
        <button onClick={handleExport} className="px-6 py-3 bg-green-600 text-white rounded-xl font-semibold">
          üì• Export Filtered Data
        </button>
      </div>

      <div className="bg-white p-6 rounded-2xl shadow-lg">
        <h3 className="text-xl font-bold mb-4">üîç Filters (Apply to All Charts)</h3>
        <div className="grid md:grid-cols-3 gap-4">
          <div>
            <label className="block text-sm font-bold mb-2">Schools ({filterSchools.length}/{availableSchoolOptions.length})</label>
            <MultiSelectDropdown
              options={availableSchoolOptions}
              selected={filterSchools}
              onChange={setFilterSchools}
              placeholder="Select Schools..."
            />
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">Grade</label>
            <select 
              value={filterGrade} 
              onChange={e=>setFilterGrade(e.target.value)}
              className="w-full border-2 px-4 py-3 rounded-xl"
            >
              <option value="All">All Grades</option>
              <option value="11">Class 11</option>
              <option value="12">Class 12</option>
            </select>
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">Teachers ({filterTeachers.length === 0 ? 'All' : filterTeachers.length}/{availableTeachers.length})</label>
            <MultiSelectDropdown
              options={availableTeachers}
              selected={filterTeachers}
              onChange={setFilterTeachers}
              placeholder="All Teachers"
              getOptionLabel={(t) => `${t.name} (${t.school})`}
              getOptionValue={(t) => t.afid}
              disabled={filterSchools.length === 0}
            />
          </div>
        </div>
        {filterSchools.length === 0 && (
          <p className="text-orange-600 mt-2 text-sm">‚ö†Ô∏è Please select at least one school to see data</p>
        )}
      </div>

      <div className="bg-white p-6 rounded-2xl shadow-lg">
        <h3 className="text-xl font-bold mb-4">üìä Overall Progress Summary</h3>
        <div className="grid grid-cols-2 md:grid-cols-5 gap-4">
          <div className="stat-card avanti-gradient text-white">
            <div className="text-sm opacity-90">Total Chapters</div>
            <div className="text-4xl font-bold">{filteredData.totalChapters}</div>
          </div>
          <div className="stat-card bg-green-500 text-white">
            <div className="text-sm opacity-90">Completed</div>
            <div className="text-3xl font-bold">{filteredData.completedChapters}/{filteredData.totalChapters}</div>
            <div className="text-lg font-semibold mt-1">
              {filteredData.totalChapters?Math.round((filteredData.completedChapters/filteredData.totalChapters)*100):0}%
            </div>
          </div>
          <div className="stat-card bg-blue-500 text-white">
            <div className="text-sm opacity-90">Tests Completed</div>
            <div className="text-3xl font-bold">{filteredData.testsCompleted}/{filteredData.completedChapters}</div>
            <div className="text-lg font-semibold mt-1">
              {filteredData.completedChapters?Math.round((filteredData.testsCompleted/filteredData.completedChapters)*100):0}%
            </div>
          </div>
          <div className="stat-card bg-purple-500 text-white">
            <div className="text-sm opacity-90">Tests Pending</div>
            <div className="text-4xl font-bold">{filteredData.testsPending}</div>
          </div>
          <div className="stat-card bg-orange-500 text-white">
            <div className="text-sm opacity-90">Delayed</div>
            <div className="text-3xl font-bold">{filteredData.delayedChapters}</div>
          </div>
        </div>
      </div>

      <div className="bg-white p-6 rounded-2xl shadow-lg">
        <h3 className="text-xl font-bold mb-4">üìö Grade-wise Breakdown</h3>
        <div className="grid md:grid-cols-2 gap-6">
          <div className="border-4 border-green-500 rounded-2xl p-6 bg-gradient-to-br from-green-50 to-emerald-50">
            <h4 className="text-2xl font-bold text-green-800 mb-4">üìó Class 11</h4>
            <div className="space-y-3">
              <div className="flex justify-between items-center p-3 bg-white rounded-lg shadow">
                <span className="font-semibold">Total Chapters:</span>
                <span className="text-2xl font-bold text-gray-800">{filteredData.gradeData['11']?.total||0}</span>
              </div>
              <div className="flex justify-between items-center p-3 bg-white rounded-lg shadow">
                <span className="font-semibold">Completed:</span>
                <span className="text-2xl font-bold text-green-600">{filteredData.gradeData['11']?.completed||0}</span>
              </div>
              <div className="flex justify-between items-center p-3 bg-white rounded-lg shadow">
                <span className="font-semibold">Tests Completed:</span>
                <span className="text-2xl font-bold text-blue-600">{filteredData.gradeData['11']?.testsCompleted||0}</span>
              </div>
              <div className="flex justify-between items-center p-3 bg-white rounded-lg shadow">
                <span className="font-semibold">Tests Pending:</span>
                <span className="text-2xl font-bold text-red-600">{filteredData.gradeData['11']?.testsPending||0}</span>
              </div>
              <div className="mt-4 p-4 bg-green-600 text-white rounded-xl text-center">
                <div className="text-sm opacity-90">Completion Rate</div>
                <div className="text-4xl font-bold">
                  {filteredData.gradeData['11']?.total?Math.round((filteredData.gradeData['11'].completed/filteredData.gradeData['11'].total)*100):0}%
                </div>
              </div>
            </div>
          </div>

          <div className="border-4 border-blue-500 rounded-2xl p-6 bg-gradient-to-br from-blue-50 to-cyan-50">
            <h4 className="text-2xl font-bold text-blue-800 mb-4">üìò Class 12</h4>
            <div className="space-y-3">
              <div className="flex justify-between items-center p-3 bg-white rounded-lg shadow">
                <span className="font-semibold">Total Chapters:</span>
                <span className="text-2xl font-bold text-gray-800">{filteredData.gradeData['12']?.total||0}</span>
              </div>
              <div className="flex justify-between items-center p-3 bg-white rounded-lg shadow">
                <span className="font-semibold">Completed:</span>
                <span className="text-2xl font-bold text-green-600">{filteredData.gradeData['12']?.completed||0}</span>
              </div>
              <div className="flex justify-between items-center p-3 bg-white rounded-lg shadow">
                <span className="font-semibold">Tests Completed:</span>
                <span className="text-2xl font-bold text-blue-600">{filteredData.gradeData['12']?.testsCompleted||0}</span>
              </div>
              <div className="flex justify-between items-center p-3 bg-white rounded-lg shadow">
                <span className="font-semibold">Tests Pending:</span>
                <span className="text-2xl font-bold text-red-600">{filteredData.gradeData['12']?.testsPending||0}</span>
              </div>
              <div className="mt-4 p-4 bg-blue-600 text-white rounded-xl text-center">
                <div className="text-sm opacity-90">Completion Rate</div>
                <div className="text-4xl font-bold">
                  {filteredData.gradeData['12']?.total?Math.round((filteredData.gradeData['12'].completed/filteredData.gradeData['12'].total)*100):0}%
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div className="grid md:grid-cols-2 lg:grid-cols-2 gap-6">
        <div className="bg-white p-6 rounded-2xl shadow-lg" style={{height:'350px'}}>
          <canvas ref={chart1Ref}></canvas>
        </div>
        <div className="bg-white p-6 rounded-2xl shadow-lg" style={{height:'350px'}}>
          <canvas ref={chart2Ref}></canvas>
        </div>
        <div className="bg-white p-6 rounded-2xl shadow-lg" style={{height:'350px'}}>
          <canvas ref={chart3Ref}></canvas>
        </div>
        <div className="bg-white p-6 rounded-2xl shadow-lg" style={{height:'350px'}}>
          <canvas ref={chart4Ref}></canvas>
        </div>
        <div className="bg-white p-6 rounded-2xl shadow-lg" style={{height:'350px'}}>
          <canvas ref={chart5Ref}></canvas>
        </div>
        <div className="bg-white p-6 rounded-2xl shadow-lg" style={{height:'350px'}}>
          <canvas ref={chart6Ref}></canvas>
        </div>
        <div className="bg-white p-6 rounded-2xl shadow-lg" style={{height:'350px'}}>
          <canvas ref={chart7Ref}></canvas>
        </div>
        <div className="bg-white p-6 rounded-2xl shadow-lg" style={{height:'350px'}}>
          <canvas ref={chart8Ref}></canvas>
        </div>
      </div>
    </div>
  );
}

function AdminChapterDetails({curriculum,chapterProgress}){const[filterSchool,setFilterSchool]=useState('All');const[filterSubject,setFilterSubject]=useState('All');const[filterGrade,setFilterGrade]=useState('All');const chapterDetails=useMemo(()=>{const details=[];const schoolsToProcess=filterSchool==='All'?SCHOOLS:[filterSchool];const subjectsToProcess=filterSubject==='All'?SUBJECTS:[filterSubject];const gradesToProcess=filterGrade==='All'?['11','12']:[filterGrade];schoolsToProcess.forEach(school=>{subjectsToProcess.forEach(subject=>{gradesToProcess.forEach(grade=>{const docId=`${school}_${subject}_${grade}`;const chapters=curriculum[docId]?.chapters||[];chapters.forEach(ch=>{const progressId=`${school}_${ch.id}`;const prog=chapterProgress[progressId]||{};details.push({school,subject,grade:`Class ${grade}`,chapterName:ch.name,targetDate:ch.targetDate||'‚Äî',completed:prog.completed||'No',completionDate:prog.completionDate||'‚Äî',testConducted:prog.testConducted||'No',notes:prog.notes||'‚Äî'})})})})});return details},[curriculum,chapterProgress,filterSchool,filterSubject,filterGrade]);const handleExport=()=>{exportToExcel(chapterDetails,'chapter_details')};return(<div className="space-y-6"><div className="flex justify-between items-center"><h2 className="text-3xl font-bold">Chapter Details</h2><button onClick={handleExport} className="px-6 py-3 bg-green-600 text-white rounded-xl font-semibold">üìä Export to Excel</button></div><div className="bg-white p-6 rounded-2xl shadow-lg"><h3 className="font-bold mb-4">Filters</h3><div className="grid md:grid-cols-3 gap-4"><div><label className="block text-sm font-bold mb-2">School</label><select value={filterSchool} onChange={e=>setFilterSchool(e.target.value)} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"><option value="All">All Schools</option>{SCHOOLS.map(s=><option key={s} value={s}>{s}</option>)}</select></div><div><label className="block text-sm font-bold mb-2">Subject</label><select value={filterSubject} onChange={e=>setFilterSubject(e.target.value)} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"><option value="All">All Subjects</option>{SUBJECTS.map(s=><option key={s} value={s}>{s}</option>)}</select></div><div><label className="block text-sm font-bold mb-2">Grade</label><select value={filterGrade} onChange={e=>setFilterGrade(e.target.value)} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"><option value="All">All Grades</option><option value="11">Class 11</option><option value="12">Class 12</option></select></div></div></div><div className="bg-white p-6 rounded-2xl shadow-lg overflow-x-auto"><h3 className="font-bold mb-4">All Chapters ({chapterDetails.length})</h3><table className="w-full"><thead className="avanti-gradient-light"><tr><th className="p-3 text-left">School</th><th className="p-3 text-left">Subject</th><th className="p-3 text-left">Grade</th><th className="p-3 text-left">Chapter Name</th><th className="p-3 text-left">Target Date</th><th className="p-3 text-left">Completed</th><th className="p-3 text-left">Completion Date</th><th className="p-3 text-left">Test Conducted</th><th className="p-3 text-left">Notes</th></tr></thead><tbody>{chapterDetails.length===0?<tr><td colSpan="9" className="p-8 text-center text-gray-500">No chapters found</td></tr>:chapterDetails.map((ch,idx)=><tr key={idx} className="border-b hover:bg-gray-50"><td className="p-3">{ch.school}</td><td className="p-3">{ch.subject}</td><td className="p-3">{ch.grade}</td><td className="p-3 font-semibold">{ch.chapterName}</td><td className="p-3 text-sm">{ch.targetDate}</td><td className="p-3"><span className={`px-2 py-1 rounded-full text-xs font-bold ${ch.completed==='Yes'?'bg-green-100 text-green-700':'bg-gray-100'}`}>{ch.completed}</span></td><td className="p-3 text-sm">{ch.completionDate}</td><td className="p-3"><span className={`px-2 py-1 rounded-full text-xs font-bold ${ch.testConducted==='Yes'?'bg-blue-100 text-blue-700':'bg-orange-100 text-orange-700'}`}>{ch.testConducted}</span></td><td className="p-3 text-sm">{ch.notes}</td></tr>)}</tbody></table></div></div>)}
// ========================================
// ========================================
// ADMIN SETTINGS COMPONENT
// ========================================
function AdminSettings() {
  const [settings, setSettings] = useState({
    // Feature Access Settings
    managerCanViewStudents: true,
    managerCanViewStudentProfiles: true,
    managerCanViewAnalytics: true,
    managerCanViewAttendance: true,
    managerCanViewObservations: true,
    managerCanExportData: true,
    teacherCanEditOwnAttendance: false,
    studentCanViewFeedback: true,
    
    // Notification Settings
    enableEmailNotifications: true,
    enablePushNotifications: true,
    notifyOnNewTeacher: true,
    notifyOnNewStudent: true,
    notifyOnAttendanceAlert: true,
    
    // Data Settings
    autoArchiveAfterDays: 365,
    dataRetentionMonths: 24,
    
    // App Settings
    appName: 'Curriculum Tracker',
    primaryColor: '#F4B41A',
    enableDarkMode: false,
    showWelcomeMessage: true,
    maintenanceMode: false
  });
  
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [successMessage, setSuccessMessage] = useState('');
  
  // Load settings from Firestore
  useEffect(() => {
    const loadSettings = async () => {
      try {
        const doc = await db.collection('app_settings').doc('global').get();
        if (doc.exists) {
          setSettings(prev => ({ ...prev, ...doc.data() }));
        }
        setLoading(false);
      } catch (e) {
        console.error('Error loading settings:', e);
        setLoading(false);
      }
    };
    loadSettings();
  }, []);
  
  const handleSave = async () => {
    setSaving(true);
    try {
      await db.collection('app_settings').doc('global').set({
        ...settings,
        updatedAt: new Date().toISOString()
      });
      setSuccessMessage('‚úÖ Settings saved successfully!');
      setTimeout(() => setSuccessMessage(''), 3000);
    } catch (e) {
      console.error('Error saving settings:', e);
      alert('‚ùå Error saving settings: ' + e.message);
    }
    setSaving(false);
  };
  
  const ToggleSwitch = ({ checked, onChange, label, description }) => (
    <div className="flex items-center justify-between py-3 border-b border-gray-100 last:border-0">
      <div>
        <div className="font-medium text-gray-800">{label}</div>
        {description && <div className="text-sm text-gray-500">{description}</div>}
      </div>
      <button
        onClick={() => onChange(!checked)}
        className={`relative inline-flex h-6 w-11 items-center rounded-full transition-colors ${
          checked ? 'bg-green-500' : 'bg-gray-300'
        }`}
      >
        <span
          className={`inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${
            checked ? 'translate-x-6' : 'translate-x-1'
          }`}
        />
      </button>
    </div>
  );
  
  if (loading) {
    return (
      <div className="text-center py-12">
        <div className="animate-spin text-4xl mb-4">‚è≥</div>
        <p>Loading settings...</p>
      </div>
    );
  }
  
  return (
    <div className="space-y-6">
      <div className="flex justify-between items-center">
        <div>
          <h2 className="text-3xl font-bold">‚öôÔ∏è Admin Settings</h2>
          <p className="text-gray-500 mt-1">Configure application settings and access controls</p>
        </div>
        <button
          onClick={handleSave}
          disabled={saving}
          className="px-6 py-3 bg-green-600 text-white rounded-xl font-semibold disabled:opacity-50"
        >
          {saving ? 'üíæ Saving...' : 'üíæ Save Settings'}
        </button>
      </div>
      
      {successMessage && (
        <div className="bg-green-50 border-2 border-green-300 p-4 rounded-xl text-green-800 font-semibold">
          {successMessage}
        </div>
      )}
      
      {/* Manager Access Controls */}
      <div className="bg-white p-6 rounded-2xl shadow-lg">
        <h3 className="text-xl font-bold mb-4 flex items-center gap-2">
          üëî Manager Access Controls
        </h3>
        <p className="text-sm text-gray-500 mb-4">Configure what managers (PM, APM, APH) can access</p>
        
        <ToggleSwitch
          checked={settings.managerCanViewStudents}
          onChange={(val) => setSettings({ ...settings, managerCanViewStudents: val })}
          label="View Student Management"
          description="Allow managers to view student list (read-only)"
        />
        <ToggleSwitch
          checked={settings.managerCanViewStudentProfiles}
          onChange={(val) => setSettings({ ...settings, managerCanViewStudentProfiles: val })}
          label="View Student Profiles"
          description="Allow managers to view detailed student profiles with demographics"
        />
        <ToggleSwitch
          checked={settings.managerCanViewAnalytics}
          onChange={(val) => setSettings({ ...settings, managerCanViewAnalytics: val })}
          label="View Analytics"
          description="Allow managers to access analytics dashboards"
        />
        <ToggleSwitch
          checked={settings.managerCanViewAttendance}
          onChange={(val) => setSettings({ ...settings, managerCanViewAttendance: val })}
          label="View Attendance"
          description="Allow managers to view attendance records"
        />
        <ToggleSwitch
          checked={settings.managerCanViewObservations}
          onChange={(val) => setSettings({ ...settings, managerCanViewObservations: val })}
          label="View Classroom Observations"
          description="Allow managers to view and create classroom observations"
        />
        <ToggleSwitch
          checked={settings.managerCanExportData}
          onChange={(val) => setSettings({ ...settings, managerCanExportData: val })}
          label="Export Data"
          description="Allow managers to export data to Excel/CSV"
        />
      </div>
      
      {/* Teacher Settings */}
      <div className="bg-white p-6 rounded-2xl shadow-lg">
        <h3 className="text-xl font-bold mb-4 flex items-center gap-2">
          üë• Teacher Settings
        </h3>
        
        <ToggleSwitch
          checked={settings.teacherCanEditOwnAttendance}
          onChange={(val) => setSettings({ ...settings, teacherCanEditOwnAttendance: val })}
          label="Edit Own Attendance"
          description="Allow teachers to modify their own attendance records"
        />
      </div>
      
      {/* Student Settings */}
      <div className="bg-white p-6 rounded-2xl shadow-lg">
        <h3 className="text-xl font-bold mb-4 flex items-center gap-2">
          üéì Student Settings
        </h3>
        
        <ToggleSwitch
          checked={settings.studentCanViewFeedback}
          onChange={(val) => setSettings({ ...settings, studentCanViewFeedback: val })}
          label="View Feedback Results"
          description="Allow students to view feedback summary for their teachers"
        />
      </div>
      
      {/* Notification Settings */}
      <div className="bg-white p-6 rounded-2xl shadow-lg">
        <h3 className="text-xl font-bold mb-4 flex items-center gap-2">
          üîî Notification Settings
        </h3>
        
        <ToggleSwitch
          checked={settings.enableEmailNotifications}
          onChange={(val) => setSettings({ ...settings, enableEmailNotifications: val })}
          label="Email Notifications"
          description="Enable email notifications for important events"
        />
        <ToggleSwitch
          checked={settings.enablePushNotifications}
          onChange={(val) => setSettings({ ...settings, enablePushNotifications: val })}
          label="Push Notifications"
          description="Enable browser push notifications"
        />
        <ToggleSwitch
          checked={settings.notifyOnNewTeacher}
          onChange={(val) => setSettings({ ...settings, notifyOnNewTeacher: val })}
          label="New Teacher Alert"
          description="Notify when a new teacher is added"
        />
        <ToggleSwitch
          checked={settings.notifyOnNewStudent}
          onChange={(val) => setSettings({ ...settings, notifyOnNewStudent: val })}
          label="New Student Alert"
          description="Notify when new students are added"
        />
        <ToggleSwitch
          checked={settings.notifyOnAttendanceAlert}
          onChange={(val) => setSettings({ ...settings, notifyOnAttendanceAlert: val })}
          label="Attendance Alerts"
          description="Notify when attendance drops below threshold"
        />
      </div>
      
      {/* Data Management */}
      <div className="bg-white p-6 rounded-2xl shadow-lg">
        <h3 className="text-xl font-bold mb-4 flex items-center gap-2">
          üóÑÔ∏è Data Management
        </h3>
        
        <div className="grid md:grid-cols-2 gap-4">
          <div>
            <label className="block text-sm font-bold mb-2">Auto-archive after (days)</label>
            <input
              type="number"
              value={settings.autoArchiveAfterDays}
              onChange={(e) => setSettings({ ...settings, autoArchiveAfterDays: parseInt(e.target.value) || 365 })}
              className="w-full border-2 px-4 py-3 rounded-xl"
              min="30"
              max="730"
            />
            <p className="text-xs text-gray-500 mt-1">Old data will be archived after this many days</p>
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">Data retention (months)</label>
            <input
              type="number"
              value={settings.dataRetentionMonths}
              onChange={(e) => setSettings({ ...settings, dataRetentionMonths: parseInt(e.target.value) || 24 })}
              className="w-full border-2 px-4 py-3 rounded-xl"
              min="6"
              max="60"
            />
            <p className="text-xs text-gray-500 mt-1">Archived data will be retained for this duration</p>
          </div>
        </div>
      </div>
      
      {/* App Customization */}
      <div className="bg-white p-6 rounded-2xl shadow-lg">
        <h3 className="text-xl font-bold mb-4 flex items-center gap-2">
          üé® App Customization
        </h3>
        
        <div className="grid md:grid-cols-2 gap-4 mb-4">
          <div>
            <label className="block text-sm font-bold mb-2">App Name</label>
            <input
              type="text"
              value={settings.appName}
              onChange={(e) => setSettings({ ...settings, appName: e.target.value })}
              className="w-full border-2 px-4 py-3 rounded-xl"
            />
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">Primary Color</label>
            <div className="flex gap-2">
              <input
                type="color"
                value={settings.primaryColor}
                onChange={(e) => setSettings({ ...settings, primaryColor: e.target.value })}
                className="w-16 h-12 border-2 rounded-xl cursor-pointer"
              />
              <input
                type="text"
                value={settings.primaryColor}
                onChange={(e) => setSettings({ ...settings, primaryColor: e.target.value })}
                className="flex-1 border-2 px-4 py-3 rounded-xl font-mono"
              />
            </div>
          </div>
        </div>
        
        <ToggleSwitch
          checked={settings.showWelcomeMessage}
          onChange={(val) => setSettings({ ...settings, showWelcomeMessage: val })}
          label="Show Welcome Message"
          description="Display welcome message on dashboard"
        />
        <ToggleSwitch
          checked={settings.enableDarkMode}
          onChange={(val) => setSettings({ ...settings, enableDarkMode: val })}
          label="Enable Dark Mode Option"
          description="Allow users to switch to dark mode (coming soon)"
        />
      </div>
      
      {/* Maintenance Mode */}
      <div className="bg-white p-6 rounded-2xl shadow-lg border-2 border-red-200">
        <h3 className="text-xl font-bold mb-4 flex items-center gap-2 text-red-600">
          üöß Maintenance Mode
        </h3>
        
        <ToggleSwitch
          checked={settings.maintenanceMode}
          onChange={(val) => setSettings({ ...settings, maintenanceMode: val })}
          label="Enable Maintenance Mode"
          description="‚ö†Ô∏è When enabled, only Super Admins can access the application"
        />
        
        {settings.maintenanceMode && (
          <div className="mt-4 p-4 bg-red-50 rounded-xl text-red-800">
            <strong>‚ö†Ô∏è Warning:</strong> Maintenance mode is enabled. All users except Super Admins will see a maintenance message.
          </div>
        )}
      </div>
      
      {/* System Information */}
      <div className="bg-gray-50 p-6 rounded-2xl">
        <h3 className="text-xl font-bold mb-4">üìä System Information</h3>
        <div className="grid md:grid-cols-3 gap-4 text-sm">
          <div className="bg-white p-4 rounded-xl">
            <div className="text-gray-500">Version</div>
            <div className="font-bold text-lg">2.0.0</div>
          </div>
          <div className="bg-white p-4 rounded-xl">
            <div className="text-gray-500">Last Updated</div>
            <div className="font-bold text-lg">{new Date().toLocaleDateString()}</div>
          </div>
          <div className="bg-white p-4 rounded-xl">
            <div className="text-gray-500">Database</div>
            <div className="font-bold text-lg">Firebase Firestore</div>
          </div>
        </div>
      </div>
    </div>
  );
}

// ========================================
// ADMIN ASSET MANAGEMENT - VIEW ACROSS SCHOOLS
// ========================================
function AdminAssetManagement({ accessibleSchools = [], isSuperAdmin = false, isDirector = false }) {
  const [assets, setAssets] = useState([]);
  const [assignments, setAssignments] = useState([]);
  const [loading, setLoading] = useState(true);
  const [filterSchool, setFilterSchool] = useState('All');
  const [filterType, setFilterType] = useState('all');
  const [filterStatus, setFilterStatus] = useState('all');
  const [searchTerm, setSearchTerm] = useState('');
  const [activeSubTab, setActiveSubTab] = useState('overview');

  // ‚úÖ FIX: Directors get full data access like Super Admin
  const hasFullDataAccess = isSuperAdmin || isDirector;

  useEffect(() => {
    const fetchData = async () => {
      try {
        // Fetch assets from all accessible schools
        let allAssets = [];
        let allAssignments = [];
        
        const schoolsToFetch = hasFullDataAccess ? SCHOOLS : accessibleSchools;
        
        for (const school of schoolsToFetch) {
          const assetsSnap = await db.collection('assets').where('school', '==', school).get();
          allAssets = [...allAssets, ...assetsSnap.docs.map(d => ({ ...d.data(), docId: d.id }))];
          
          const assignmentsSnap = await db.collection('assetAssignments').where('school', '==', school).get();
          allAssignments = [...allAssignments, ...assignmentsSnap.docs.map(d => ({ ...d.data(), docId: d.id }))];
        }
        
        setAssets(allAssets);
        setAssignments(allAssignments);
        setLoading(false);
      } catch (error) {
        console.error('Error fetching assets:', error);
        setLoading(false);
      }
    };
    fetchData();
  }, [accessibleSchools, hasFullDataAccess]);

  const filteredAssets = useMemo(() => {
    return assets.filter(asset => {
      if (filterSchool !== 'All' && asset.school !== filterSchool) return false;
      if (filterType !== 'all' && asset.assetType !== filterType) return false;
      if (filterStatus !== 'all' && asset.status !== filterStatus) return false;
      if (searchTerm) {
        const search = searchTerm.toLowerCase();
        return asset.title?.toLowerCase().includes(search) || 
          asset.author?.toLowerCase().includes(search) ||
          asset.barcode?.includes(search) ||
          asset.currentAssignee?.studentName?.toLowerCase().includes(search);
      }
      return true;
    });
  }, [assets, filterSchool, filterType, filterStatus, searchTerm]);

  const stats = useMemo(() => {
    const filtered = filterSchool === 'All' ? assets : assets.filter(a => a.school === filterSchool);
    return {
      total: filtered.length,
      available: filtered.filter(a => a.status === 'available').length,
      assigned: filtered.filter(a => a.status === 'assigned').length,
      books: filtered.filter(a => a.assetType === 'book').length,
      chromebooks: filtered.filter(a => a.assetType === 'chromebook').length
    };
  }, [assets, filterSchool]);

  const schoolStats = useMemo(() => {
    const schoolsToShow = hasFullDataAccess ? SCHOOLS : accessibleSchools;
    return schoolsToShow.map(school => {
      const schoolAssets = assets.filter(a => a.school === school);
      return {
        school,
        total: schoolAssets.length,
        available: schoolAssets.filter(a => a.status === 'available').length,
        assigned: schoolAssets.filter(a => a.status === 'assigned').length,
        books: schoolAssets.filter(a => a.assetType === 'book').length,
        chromebooks: schoolAssets.filter(a => a.assetType === 'chromebook').length
      };
    });
  }, [assets, accessibleSchools, isSuperAdmin]);

  if (loading) return <div className="text-center py-8">Loading assets...</div>;

  const schoolsToShow = hasFullDataAccess ? SCHOOLS : accessibleSchools;

  return (
    <div className="space-y-6">
      <h2 className="text-3xl font-bold">üì¶ Asset Management (All Schools)</h2>

      {/* School Filter */}
      <div className="bg-white p-4 rounded-xl shadow-lg">
        <div className="grid md:grid-cols-5 gap-4">
          <select value={filterSchool} onChange={(e) => setFilterSchool(e.target.value)} className="border-2 px-4 py-2 rounded-xl">
            <option value="All">All Schools</option>
            {schoolsToShow.map(school => <option key={school} value={school}>{school}</option>)}
          </select>
          <input type="text" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} placeholder="Search assets..." className="border-2 px-4 py-2 rounded-xl" />
          <select value={filterType} onChange={(e) => setFilterType(e.target.value)} className="border-2 px-4 py-2 rounded-xl">
            <option value="all">All Types</option>
            <option value="book">Books</option>
            <option value="chromebook">Chromebooks</option>
          </select>
          <select value={filterStatus} onChange={(e) => setFilterStatus(e.target.value)} className="border-2 px-4 py-2 rounded-xl">
            <option value="all">All Status</option>
            <option value="available">Available</option>
            <option value="assigned">Assigned</option>
          </select>
          <button onClick={() => { setFilterSchool('All'); setSearchTerm(''); setFilterType('all'); setFilterStatus('all'); }} className="px-4 py-2 bg-gray-200 rounded-xl">Clear</button>
        </div>
      </div>

      {/* Overall Stats */}
      <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
        <div className="stat-card bg-gradient-to-br from-blue-500 to-blue-600 text-white"><div className="text-sm opacity-90">Total</div><div className="text-3xl font-bold">{stats.total}</div></div>
        <div className="stat-card bg-gradient-to-br from-green-500 to-green-600 text-white"><div className="text-sm opacity-90">Available</div><div className="text-3xl font-bold">{stats.available}</div></div>
        <div className="stat-card bg-gradient-to-br from-yellow-500 to-yellow-600 text-white"><div className="text-sm opacity-90">Assigned</div><div className="text-3xl font-bold">{stats.assigned}</div></div>
        <div className="stat-card bg-gradient-to-br from-purple-500 to-purple-600 text-white"><div className="text-sm opacity-90">Books</div><div className="text-3xl font-bold">{stats.books}</div></div>
        <div className="stat-card bg-gradient-to-br from-teal-500 to-teal-600 text-white"><div className="text-sm opacity-90">Chromebooks</div><div className="text-3xl font-bold">{stats.chromebooks}</div></div>
      </div>

      {/* Sub Tabs */}
      <div className="flex gap-2 overflow-x-auto pb-2">
        {['overview', 'inventory', 'history', 'byschool'].map(tab => (
          <button key={tab} onClick={() => setActiveSubTab(tab)} className={`px-4 py-2 rounded-xl font-semibold whitespace-nowrap ${activeSubTab === tab ? 'avanti-gradient text-white' : 'bg-white'}`}>
            {tab === 'overview' && 'üìä Overview'}
            {tab === 'inventory' && 'üì¶ All Assets'}
            {tab === 'history' && 'üìú History'}
            {tab === 'byschool' && 'üè´ By School'}
          </button>
        ))}
      </div>

      {/* Overview Tab */}
      {activeSubTab === 'overview' && (
        <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
          {schoolStats.map(ss => (
            <div key={ss.school} className="bg-white p-6 rounded-xl shadow-lg">
              <h3 className="font-bold text-lg mb-4">{ss.school}</h3>
              <div className="grid grid-cols-3 gap-2 text-center">
                <div className="p-2 bg-blue-50 rounded-lg">
                  <div className="text-2xl font-bold text-blue-600">{ss.total}</div>
                  <div className="text-xs text-gray-600">Total</div>
                </div>
                <div className="p-2 bg-green-50 rounded-lg">
                  <div className="text-2xl font-bold text-green-600">{ss.available}</div>
                  <div className="text-xs text-gray-600">Available</div>
                </div>
                <div className="p-2 bg-yellow-50 rounded-lg">
                  <div className="text-2xl font-bold text-yellow-600">{ss.assigned}</div>
                  <div className="text-xs text-gray-600">Assigned</div>
                </div>
              </div>
            </div>
          ))}
        </div>
      )}

      {/* Inventory Tab */}
      {activeSubTab === 'inventory' && (
        <div className="bg-white p-6 rounded-xl shadow-lg overflow-x-auto">
          <table className="w-full">
            <thead className="avanti-gradient-light">
              <tr>
                <th className="p-3 text-left">Title</th>
                <th className="p-3 text-left">Type</th>
                <th className="p-3 text-left">School</th>
                <th className="p-3 text-left">Status</th>
                <th className="p-3 text-left">Assigned To</th>
                <th className="p-3 text-left">Copy #</th>
              </tr>
            </thead>
            <tbody>
              {filteredAssets.length === 0 ? (
                <tr><td colSpan="6" className="p-8 text-center text-gray-500">No assets found</td></tr>
              ) : filteredAssets.slice(0, 100).map(asset => (
                <tr key={asset.docId} className="border-b hover:bg-gray-50">
                  <td className="p-3">
                    <div className="font-semibold">{asset.title}</div>
                    {asset.author && <div className="text-xs text-gray-500">by {asset.author}</div>}
                  </td>
                  <td className="p-3">{asset.assetType === 'book' ? 'üìö Book' : 'üíª Chromebook'}</td>
                  <td className="p-3 text-sm">{asset.school}</td>
                  <td className="p-3">
                    <span className={`asset-badge badge-${asset.status}`}>{asset.status}</span>
                  </td>
                  <td className="p-3 text-sm">{asset.currentAssignee?.studentName || '-'}</td>
                  <td className="p-3 text-sm">{asset.copyNumber || 1}</td>
                </tr>
              ))}
            </tbody>
          </table>
          {filteredAssets.length > 100 && <p className="text-center text-gray-500 mt-4">Showing first 100 of {filteredAssets.length} assets</p>}
        </div>
      )}

      {/* History Tab - Shows all returned assets */}
      {activeSubTab === 'history' && (
        <div className="bg-white p-6 rounded-xl shadow-lg">
          <h3 className="font-bold text-xl mb-4">üìú Assignment History</h3>
          {assignments.filter(a => a.status === 'returned').length === 0 ? (
            <p className="text-center py-8 text-gray-500">No returned assets yet</p>
          ) : (
            <div className="overflow-x-auto">
              <table className="w-full">
                <thead className="avanti-gradient-light">
                  <tr>
                    <th className="p-3 text-left">Asset</th>
                    <th className="p-3 text-left">School</th>
                    <th className="p-3 text-left">Student</th>
                    <th className="p-3 text-left">Assigned Date</th>
                    <th className="p-3 text-left">Return Date</th>
                    <th className="p-3 text-left">Duration</th>
                  </tr>
                </thead>
                <tbody>
                  {assignments.filter(a => a.status === 'returned').sort((a, b) => new Date(b.returnedDate) - new Date(a.returnedDate)).slice(0, 100).map(a => {
                    const assignedDate = new Date(a.assignedDate);
                    const returnedDate = new Date(a.returnedDate);
                    const daysHeld = Math.ceil((returnedDate - assignedDate) / (1000 * 60 * 60 * 24));
                    return (
                      <tr key={a.docId} className="border-b hover:bg-gray-50">
                        <td className="p-3 font-semibold">{a.assetTitle}</td>
                        <td className="p-3 text-sm">{a.school}</td>
                        <td className="p-3">{a.studentName} (Class {a.studentClass})</td>
                        <td className="p-3 text-sm">{assignedDate.toLocaleDateString()}</td>
                        <td className="p-3 text-sm">{returnedDate.toLocaleDateString()}</td>
                        <td className="p-3"><span className="px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm">{daysHeld} days</span></td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>
            </div>
          )}
        </div>
      )}

      {/* By School Tab */}
      {activeSubTab === 'byschool' && (
        <div className="bg-white p-6 rounded-xl shadow-lg overflow-x-auto">
          <table className="w-full">
            <thead className="avanti-gradient-light">
              <tr>
                <th className="p-3 text-left">School</th>
                <th className="p-3 text-center">Total</th>
                <th className="p-3 text-center">Books</th>
                <th className="p-3 text-center">Chromebooks</th>
                <th className="p-3 text-center">Available</th>
                <th className="p-3 text-center">Assigned</th>
              </tr>
            </thead>
            <tbody>
              {schoolStats.map(ss => (
                <tr key={ss.school} className="border-b hover:bg-gray-50">
                  <td className="p-3 font-semibold">{ss.school}</td>
                  <td className="p-3 text-center font-bold">{ss.total}</td>
                  <td className="p-3 text-center">{ss.books}</td>
                  <td className="p-3 text-center">{ss.chromebooks}</td>
                  <td className="p-3 text-center text-green-600 font-semibold">{ss.available}</td>
                  <td className="p-3 text-center text-yellow-600 font-semibold">{ss.assigned}</td>
                </tr>
              ))}
              <tr className="bg-gray-100 font-bold">
                <td className="p-3">TOTAL</td>
                <td className="p-3 text-center">{schoolStats.reduce((s, ss) => s + ss.total, 0)}</td>
                <td className="p-3 text-center">{schoolStats.reduce((s, ss) => s + ss.books, 0)}</td>
                <td className="p-3 text-center">{schoolStats.reduce((s, ss) => s + ss.chromebooks, 0)}</td>
                <td className="p-3 text-center text-green-600">{schoolStats.reduce((s, ss) => s + ss.available, 0)}</td>
                <td className="p-3 text-center text-yellow-600">{schoolStats.reduce((s, ss) => s + ss.assigned, 0)}</td>
              </tr>
            </tbody>
          </table>
        </div>
      )}
    </div>
  );
}

function AdminBirthdays({teachers}){const todayBirthdays=useMemo(()=>getBirthdays(teachers,'today'),[teachers]);const weekBirthdays=useMemo(()=>getBirthdays(teachers,'week'),[teachers]);const monthBirthdays=useMemo(()=>getBirthdays(teachers,'month'),[teachers]);const todayAnniversaries=useMemo(()=>getAnniversaries(teachers,'today'),[teachers]);const weekAnniversaries=useMemo(()=>getAnniversaries(teachers,'week'),[teachers]);const monthAnniversaries=useMemo(()=>getAnniversaries(teachers,'month'),[teachers]);return(<div className="space-y-6"><h2 className="text-3xl font-bold">üéâ Celebrations</h2><div className="grid md:grid-cols-2 gap-6"><>{todayBirthdays.length>0&&<div className="birthday-card p-6 rounded-2xl"><h3 className="text-2xl font-bold text-white mb-4">üéÇ Today's Birthdays</h3>{todayBirthdays.map(t=><div key={t.id} className="bg-white p-4 rounded-lg mb-2"><div className="font-bold text-lg">{t.name}</div><div className="text-sm text-gray-600">{t.school} - {t.subject}</div></div>)}</div>}{todayAnniversaries.length>0&&<div className="birthday-card p-6 rounded-2xl"><h3 className="text-2xl font-bold text-white mb-4">üéâ Today's Work Anniversaries</h3>{todayAnniversaries.map(t=>{const years=new Date().getFullYear()-new Date(t.joiningDate).getFullYear();return(<div key={t.id} className="bg-white p-4 rounded-lg mb-2"><div className="font-bold text-lg">{t.name}</div><div className="text-sm text-gray-600">{years} Years - {t.school}</div></div>)})}</div>}</></div><div className="grid md:grid-cols-3 gap-6"><div className="bg-white p-6 rounded-2xl shadow-lg"><h3 className="text-xl font-bold mb-4">This Week</h3>{weekBirthdays.length===0&&weekAnniversaries.length===0?<p className="text-gray-500">No celebrations</p>:<div className="space-y-2"><>{weekBirthdays.map(t=><div key={t.id} className="p-3 bg-blue-50 rounded-lg"><div className="font-semibold">üéÇ {t.name}</div><div className="text-sm text-gray-600">{new Date(t.dob).toLocaleDateString(undefined,{month:'short',day:'numeric'})}</div></div>)}{weekAnniversaries.map(t=><div key={t.id} className="p-3 bg-green-50 rounded-lg"><div className="font-semibold">üéâ {t.name}</div><div className="text-sm text-gray-600">Work Anniversary</div></div>)}</></div>}</div><div className="bg-white p-6 rounded-2xl shadow-lg"><h3 className="text-xl font-bold mb-4">This Month - Birthdays</h3>{monthBirthdays.length===0?<p className="text-gray-500">No birthdays</p>:<div className="space-y-2 max-h-96 overflow-y-auto">{monthBirthdays.map(t=><div key={t.id} className="p-3 bg-gray-50 rounded-lg"><div className="font-semibold">{t.name}</div><div className="text-sm text-gray-600">{new Date(t.dob).toLocaleDateString(undefined,{month:'short',day:'numeric'})}</div></div>)}</div>}</div><div className="bg-white p-6 rounded-2xl shadow-lg"><h3 className="text-xl font-bold mb-4">This Month - Anniversaries</h3>{monthAnniversaries.length===0?<p className="text-gray-500">No anniversaries</p>:<div className="space-y-2 max-h-96 overflow-y-auto">{monthAnniversaries.map(t=>{const years=new Date().getFullYear()-new Date(t.joiningDate).getFullYear();return(<div key={t.id} className="p-3 bg-gray-50 rounded-lg"><div className="font-semibold">{t.name}</div><div className="text-sm text-gray-600">{years} Years</div></div>)})}</div>}</div></div></div>)}
function StudentManagement({students, isSuperAdmin = true, isDirector = false, accessibleSchools = SCHOOLS}){
  const[showModal,setShowModal]=useState(false);
  const[editingStudent,setEditingStudent]=useState(null);
  const[form,setForm]=useState({school:'',grade:'',name:'',gender:'',id:''});
  const[selectedStudents,setSelectedStudents]=useState([]);
  const[filterSchool,setFilterSchool]=useState('All');
  const[filterGrade,setFilterGrade]=useState('All');
  const[selectAll,setSelectAll]=useState(false);
  const[searchQuery,setSearchQuery]=useState('');
  const fileInputRef=useRef(null);
  const updateIdFileRef=useRef(null);
  
  // ‚úÖ FIX: Directors get full data access like Super Admin
  const hasFullDataAccess = isSuperAdmin || isDirector;
  
  // Filter schools based on access
  const availableSchools = hasFullDataAccess ? SCHOOLS : accessibleSchools;

  const filteredStudents=students
  .filter(s=>{
    // First filter by accessible schools for managers (Directors see all)
    if(!hasFullDataAccess && !accessibleSchools.includes(s.school)) return false;
    if(filterSchool!=='All'&&s.school!==filterSchool)return false;
    if(filterGrade!=='All'&&s.grade!==filterGrade)return false;
    if(searchQuery && !s.name?.toLowerCase().includes(searchQuery.toLowerCase()) && !s.id?.toLowerCase().includes(searchQuery.toLowerCase()))return false;
    return true;
  })
  .sort((a,b)=>a.name.localeCompare(b.name));

  const handleSave=async()=>{
  if(!form.school||!form.grade||!form.name||!form.gender||!form.id){
    alert('‚ö†Ô∏è Please fill all required fields:\n\n‚Ä¢ School\n‚Ä¢ Student ID\n‚Ä¢ Grade\n‚Ä¢ Name\n‚Ä¢ Gender');
    return;
  }
  
  try{
    const newDocId = `${form.school.replace(/\s+/g,'_')}_${form.id}`;
    
    if(editingStudent){
      // ============ EDITING EXISTING STUDENT ============
      const oldDocId = `${editingStudent.school.replace(/\s+/g,'_')}_${editingStudent.id}`;
      
      console.log('üìù Editing student:');
      console.log('  Old Doc ID:', oldDocId);
      console.log('  New Doc ID:', newDocId);
      
      // Check if student ID or school changed
      if(newDocId !== oldDocId){
        console.log('üîÑ ID or School changed - need to delete old doc');
        
        // Check if new ID already exists
        const existingDoc = await db.collection('students').doc(newDocId).get();
        if(existingDoc.exists){
          alert('‚ùå This Student ID already exists in this school!\n\nPlease use a different Student ID.');
          return;
        }
        
        // Delete old document
        console.log('üóëÔ∏è Deleting old document:', oldDocId);
        await db.collection('students').doc(oldDocId).delete();
      }
      
      // Save with new/same document ID
      console.log('üíæ Saving to:', newDocId);
      await db.collection('students').doc(newDocId).set({
        school: form.school,
        grade: form.grade,
        name: form.name,
        gender: form.gender,
        id: form.id,
        updatedAt: new Date().toISOString()
      });
      
      alert('‚úÖ Student updated successfully!');
      
    } else {
      // ============ ADDING NEW STUDENT ============
      console.log('‚ûï Adding new student:', newDocId);
      
      // Check if student already exists
      const existingDoc = await db.collection('students').doc(newDocId).get();
      if(existingDoc.exists){
        alert('‚ùå This Student ID already exists!\n\nStudent ID: ' + form.id + '\nSchool: ' + form.school);
        return;
      }
      
      // Create new student
      await db.collection('students').doc(newDocId).set({
        school: form.school,
        grade: form.grade,
        name: form.name,
        gender: form.gender,
        id: form.id,
        createdAt: new Date().toISOString()
      });
      
      alert('‚úÖ Student added successfully!\n\nüìù Login Details:\nStudent ID: ' + form.id + '\nPassword: pass123');
    }
    
    // Close modal and reset form
    setShowModal(false);
    setEditingStudent(null);
    setForm({school:'',grade:'',name:'',gender:'',id:''});
    
    // Reload to show changes
    console.log('üîÑ Reloading page...');
    setTimeout(() => window.location.reload(), 500);
    
  } catch(e) {
    console.error('‚ùå Save error:', e);
    alert('Failed to save student:\n\n' + e.message);
  }
};

  const openAddModal=()=>{
    setEditingStudent(null);
    setForm({school:'',grade:'',name:'',gender:'',id:''});
    setShowModal(true);
  };

  const openEditModal=(student)=>{
  console.log('Editing student:', student); // ‚úÖ Debug log
  
  setEditingStudent(student); // ‚úÖ Store entire student object
  setForm({
    school:student.school,
    grade:student.grade,
    name:student.name,
    gender:student.gender,
    id:student.id
  });
  setShowModal(true);
};

  const handleSelectAll=()=>{
    if(selectAll){
      setSelectedStudents([]);
      setSelectAll(false);
    }else{
      setSelectedStudents(filteredStudents.map(s=>s.docId));
      setSelectAll(true);
    }
  };

  const handleSelectStudent=(studentId)=>{
    if(selectedStudents.includes(studentId)){
      setSelectedStudents(selectedStudents.filter(id=>id!==studentId));
    }else{
      setSelectedStudents([...selectedStudents,studentId]);
    }
  };

  const handleBulkDelete=async()=>{
    if(selectedStudents.length===0){
      alert('Please select students to delete');
      return;
    }
    if(!confirm(`Delete ${selectedStudents.length} selected students?`))return;
    
    try{
      const batch=db.batch();
      selectedStudents.forEach(id=>{
        batch.delete(db.collection('students').doc(id));
      });
      await batch.commit();
      alert(`${selectedStudents.length} students deleted!`);
      setSelectedStudents([]);
      setSelectAll(false);
      window.location.reload();
    }catch(e){
      alert('Failed: '+e.message);
    }
  };

  const handleBulkUpdateSchool=async()=>{
    if(selectedStudents.length===0){
      alert('Please select students first');
      return;
    }
    const newSchool=prompt('Enter new school name:');
    if(!newSchool||!SCHOOLS.includes(newSchool)){
      alert('Invalid school name');
      return;
    }
    if(!confirm(`Update school to "${newSchool}" for ${selectedStudents.length} students?`))return;

    try{
      const batch=db.batch();
      selectedStudents.forEach(id=>{
        batch.update(db.collection('students').doc(id),{school:newSchool,updatedAt:new Date().toISOString()});
      });
      await batch.commit();
      alert(`${selectedStudents.length} students updated!`);
      setSelectedStudents([]);
      setSelectAll(false);
    }catch(e){
      alert('Failed: '+e.message);
    }
  };

  const handleBulkUpdateGrade=async()=>{
    if(selectedStudents.length===0){
      alert('Please select students first');
      return;
    }
    const newGrade=prompt('Enter new grade (11 or 12):');
    if(!newGrade||!['11','12'].includes(newGrade)){
      alert('Invalid grade. Must be 11 or 12');
      return;
    }
    if(!confirm(`Update grade to "${newGrade}" for ${selectedStudents.length} students?`))return;

    try{
      const batch=db.batch();
      selectedStudents.forEach(id=>{
        batch.update(db.collection('students').doc(id),{grade:newGrade,updatedAt:new Date().toISOString()});
      });
      await batch.commit();
      alert(`${selectedStudents.length} students updated!`);
      setSelectedStudents([]);
      setSelectAll(false);
    }catch(e){
      alert('Failed: '+e.message);
    }
  };

  const handleCSVImport=e=>{
    const file=e.target.files[0];
    if(!file)return;

    Papa.parse(file,{
      complete:async results=>{
        try{
          const rows=results.data;
          if(rows.length<2){
            alert('CSV file is empty');
            return;
          }

          let imported=0;
          let skipped=0;
          const errors=[];
          
          for(let i=1;i<rows.length;i++){
            const row=rows[i];
            const school=row[0]?row[0].trim():'';
            const studentId=row[1]?row[1].trim():'';
            const grade=row[2]?row[2].trim():'';
            const name=row[3]?row[3].trim():'';
            const gender=row[4]?row[4].trim():'';

            if(!school||!studentId||!grade||!name||!gender){
              errors.push(`Row ${i+1}: Missing required fields`);
              skipped++;
              continue;
            }

            // Check if student ID already exists
            const existingSnap=await db.collection('students').where('id','==',studentId).limit(1).get();
            if(!existingSnap.empty){
              errors.push(`Row ${i+1}: Student ID "${studentId}" already exists`);
              skipped++;
              continue;
            }

            // ‚úÖ Use compound key instead of .add()
const docId = `${school.replace(/\s+/g, '_')}_${studentId}`;
await db.collection('students').doc(docId).set({
  school,
  grade,
  name,
  gender,
  id: studentId,
  createdAt: new Date().toISOString()
});
            imported++;
          }

          let message=`‚úÖ Imported ${imported} students!`;
          if(skipped>0){
            message+=`\n‚ö†Ô∏è Skipped ${skipped} students`;
            if(errors.length>0){
              message+='\n\nErrors:\n'+errors.slice(0,5).join('\n');
              if(errors.length>5)message+=`\n... and ${errors.length-5} more`;
            }
          }
          message+='\n\nüìù Students can login with:\nStudent ID + Password: pass123';
          alert(message);
          
          if(fileInputRef.current)fileInputRef.current.value='';
        }catch(e){
          alert('Import failed: '+e.message);
        }
      },
      error:()=>alert('Failed to parse CSV')
    });
  };

  // ‚úÖ NEW: Bulk Update Student IDs
  const handleBulkUpdateIDs=e=>{
    const file=e.target.files[0];
    if(!file)return;

    Papa.parse(file,{
      complete:async results=>{
        try{
          const rows=results.data;
          if(rows.length<2){
            alert('CSV file is empty');
            return;
          }

          let updated=0;
          let notFound=0;
          const errors=[];
          const updateLog=[];
          
          for(let i=1;i<rows.length;i++){
            const row=rows[i];
            const schoolName=row[0]?row[0].trim():'';
            const studentName=row[1]?row[1].trim():'';
            const grade=row[2]?row[2].trim():'';
            const newStudentId=row[3]?row[3].trim():'';

            if(!schoolName||!studentName||!grade||!newStudentId){
              errors.push(`Row ${i+1}: Missing required fields (School, Name, Grade, Student ID)`);
              notFound++;
              continue;
            }

            // Find student by School + Name + Grade (exact match)
            const querySnap=await db.collection('students')
              .where('school','==',schoolName)
              .where('name','==',studentName)
              .where('grade','==',grade)
              .limit(1)
              .get();

            if(querySnap.empty){
              errors.push(`Row ${i+1}: Student "${studentName}" not found in ${schoolName}, Grade ${grade}`);
              notFound++;
              continue;
            }

            // Update the student ID
            const studentDoc=querySnap.docs[0];
            const oldId=studentDoc.data().id||'(blank)';
            
            await studentDoc.ref.update({
              id: newStudentId,
              updatedAt: new Date().toISOString()
            });
            
            updated++;
            updateLog.push(`‚úÖ ${studentName} (${schoolName}): ${oldId} ‚Üí ${newStudentId}`);
          }

          let message=`‚úÖ Updated ${updated} Student IDs!`;
          if(notFound>0){
            message+=`\n‚ö†Ô∏è ${notFound} students not found`;
          }
          
          if(updateLog.length>0){
            message+='\n\nüìù Updates:\n'+updateLog.slice(0,10).join('\n');
            if(updateLog.length>10)message+=`\n... and ${updateLog.length-10} more`;
          }
          
          if(errors.length>0){
            message+='\n\n‚ùå Errors:\n'+errors.slice(0,5).join('\n');
            if(errors.length>5)message+=`\n... and ${errors.length-5} more`;
          }
          
          alert(message);
          
          if(updateIdFileRef.current)updateIdFileRef.current.value='';
          window.location.reload(); // Refresh to show updated IDs
        }catch(e){
          alert('Update failed: '+e.message);
        }
      },
      error:()=>alert('Failed to parse CSV')
    });
  };

  const handleDelete = async (student) => {
  if (!confirm(`‚ö†Ô∏è Delete ${student.name}?\n\nStudent ID: ${student.id}\nSchool: ${student.school}\n\nThis action cannot be undone!`)) return;
  
  try {
    console.log('=== DELETE ATTEMPT ===');
    console.log('Student object:', student);
    
    // Try multiple document ID formats
    const formats = [
      `${student.school.replace(/\s+/g, '_')}_${student.id}`,
      `${student.school}_${student.id}`,
      student.docId
    ];
    
    console.log('Trying document IDs:', formats);
    
    let deleted = false;
    
    for (const docId of formats) {
      if (!docId) continue;
      
      const docRef = db.collection('students').doc(docId);
      const docSnap = await docRef.get();
      
      if (docSnap.exists) {
        console.log('‚úÖ Found document:', docId);
        await docRef.delete();
        deleted = true;
        break;
      } else {
        console.log('‚ùå Not found:', docId);
      }
    }
    
    if (deleted) {
      alert('‚úÖ Student deleted successfully!');
      window.location.reload();
    } else {
      alert('‚ùå Error: Could not find student document.\n\nPlease contact support.');
      console.error('Tried formats:', formats);
    }
    
  } catch (e) {
    console.error('Delete error:', e);
    alert('Failed to delete:\n\n' + e.message);
  }
};

  const handleExport=()=>{
    const exportData=students.map(s=>({
      School:s.school,
      'Student ID':s.id,
      Grade:s.grade,
      Name:s.name,
      Gender:s.gender
    }));
    exportToExcel(exportData,'students_list');
  };

  return(
    <div className="space-y-6">
      <div className="flex justify-between items-center flex-wrap gap-4">
        <div>
          <h2 className="text-3xl font-bold">Student Management</h2>
          {!isSuperAdmin && (
            <p className="text-sm text-gray-500 mt-1">üëÅÔ∏è View Only Mode - Contact Super Admin for modifications</p>
          )}
        </div>
        <div className="flex gap-3 flex-wrap">
          {isSuperAdmin && (
            <>
              <button onClick={openAddModal} className="px-6 py-3 bg-blue-600 text-white rounded-xl font-semibold">
                + Add Student
              </button>
              <label className="px-6 py-3 bg-green-600 text-white rounded-xl font-semibold cursor-pointer">
                üì§ Import CSV
                <input ref={fileInputRef} type="file" accept=".csv" onChange={handleCSVImport} className="hidden"/>
              </label>
              <label className="px-6 py-3 bg-orange-600 text-white rounded-xl font-semibold cursor-pointer">
                üîÑ Update Student IDs
                <input ref={updateIdFileRef} type="file" accept=".csv" onChange={handleBulkUpdateIDs} className="hidden"/>
              </label>
            </>
          )}
          <button onClick={handleExport} className="px-6 py-3 bg-purple-600 text-white rounded-xl font-semibold">
            üì• Export
          </button>
        </div>
      </div>

      {isSuperAdmin && selectedStudents.length>0&&(
        <div className="bg-blue-50 border-2 border-blue-300 p-4 rounded-xl">
          <div className="flex justify-between items-center">
            <div className="font-bold text-blue-800">
              {selectedStudents.length} student(s) selected
            </div>
            <div className="flex gap-2">
              <button onClick={handleBulkUpdateSchool} className="px-4 py-2 bg-blue-600 text-white rounded-lg font-semibold">
                üè´ Change School
              </button>
              <button onClick={handleBulkUpdateGrade} className="px-4 py-2 bg-green-600 text-white rounded-lg font-semibold">
                üìö Change Grade
              </button>
              <button onClick={handleBulkDelete} className="px-4 py-2 bg-red-600 text-white rounded-lg font-semibold">
                üóëÔ∏è Delete Selected
              </button>
              <button onClick={()=>{setSelectedStudents([]);setSelectAll(false)}} className="px-4 py-2 bg-gray-400 text-white rounded-lg font-semibold">
                Cancel
              </button>
            </div>
          </div>
        </div>
      )}

      <div className="bg-white p-6 rounded-2xl shadow-lg">
        <h3 className="text-xl font-bold mb-4">üîç Filters & Search</h3>
        <div className="grid md:grid-cols-3 gap-4">
          <div>
            <label className="block text-sm font-bold mb-2">Search</label>
            <input 
              type="text" 
              value={searchQuery} 
              onChange={e=>setSearchQuery(e.target.value)} 
              placeholder="Search by name or ID..." 
              className="w-full border-2 px-4 py-3 rounded-xl"
            />
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">School</label>
            <select value={filterSchool} onChange={e=>{setFilterSchool(e.target.value);setSelectedStudents([]);setSelectAll(false)}} className="w-full border-2 px-4 py-3 rounded-xl">
              <option value="All">All Schools</option>
              {availableSchools.map(s=><option key={s} value={s}>{s}</option>)}
            </select>
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">Grade</label>
            <select value={filterGrade} onChange={e=>{setFilterGrade(e.target.value);setSelectedStudents([]);setSelectAll(false)}} className="w-full border-2 px-4 py-3 rounded-xl">
              <option value="All">All Grades</option>
              <option value="11">Class 11</option>
              <option value="12">Class 12</option>
            </select>
          </div>
        </div>
      </div>

      {/* Summary Cards */}
      <div className="grid grid-cols-3 gap-4">
        <div className="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-4 rounded-xl shadow-lg">
          <div className="text-sm opacity-90">Total Students</div>
          <div className="text-3xl font-bold">{filteredStudents.length}</div>
          <div className="text-xs opacity-75 mt-1">Filtered results</div>
        </div>
        <div className="bg-gradient-to-r from-indigo-500 to-purple-600 text-white p-4 rounded-xl shadow-lg">
          <div className="text-sm opacity-90">Male</div>
          <div className="text-3xl font-bold">{filteredStudents.filter(s => s.gender === 'Male').length}</div>
          <div className="text-xs opacity-75 mt-1">{filteredStudents.length > 0 ? Math.round((filteredStudents.filter(s => s.gender === 'Male').length / filteredStudents.length) * 100) : 0}%</div>
        </div>
        <div className="bg-gradient-to-r from-pink-500 to-rose-600 text-white p-4 rounded-xl shadow-lg">
          <div className="text-sm opacity-90">Female</div>
          <div className="text-3xl font-bold">{filteredStudents.filter(s => s.gender === 'Female').length}</div>
          <div className="text-xs opacity-75 mt-1">{filteredStudents.length > 0 ? Math.round((filteredStudents.filter(s => s.gender === 'Female').length / filteredStudents.length) * 100) : 0}%</div>
        </div>
      </div>

      {isSuperAdmin && (
        <>
          <div className="bg-white p-4 rounded-xl border-2 border-gray-200">
            <p className="text-sm text-gray-600">
              <strong>üìã Import New Students CSV Format (5 columns):</strong>
              <br/>School Name, Student ID, Grade, Student Name, Gender
              <br/><br/>
              <strong>‚úÖ Example Row:</strong>
              <br/>CoE Barwani, STU001, 11, Raj Kumar, Male
              <br/><br/>
              <strong>üîê Login Info:</strong> Students use their Student ID + Password: <span className="font-mono bg-yellow-100 px-2 py-1 rounded">pass123</span>
            </p>
          </div>

          <div className="bg-orange-50 p-4 rounded-xl border-2 border-orange-300">
            <p className="text-sm text-gray-600">
              <strong>üîÑ Update Student IDs CSV Format (4 columns):</strong>
              <br/>School Name, Student Name, Grade, Student ID
              <br/><br/>
              <strong>‚úÖ Example Row:</strong>
              <br/>CoE Bundi, Aaditya Raj Dhawan, Class 12, 2754059028
              <br/><br/>
              <strong>‚ö° How it works:</strong> System finds existing student by matching School + Name + Grade, then updates only the Student ID field.
            </p>
          </div>
        </>
      )}

      <div className="bg-white p-6 rounded-2xl shadow-lg overflow-x-auto">
        <h3 className="font-bold mb-4">
          Showing {filteredStudents.length} of {students.length} Students
        </h3>
        <table className="w-full">
          <thead className="avanti-gradient-light">
            <tr>
              {isSuperAdmin && (
                <th className="p-3">
                  <input 
                    type="checkbox" 
                    checked={selectAll&&filteredStudents.length>0} 
                    onChange={handleSelectAll}
                    className="cursor-pointer"
                  />
                </th>
              )}
              <th className="p-3 text-left">School</th>
              <th className="p-3 text-left">Student ID</th>
              <th className="p-3 text-left">Grade</th>
              <th className="p-3 text-left">Name</th>
              <th className="p-3 text-left">Gender</th>
              {isSuperAdmin && <th className="p-3 text-left">Actions</th>}
            </tr>
          </thead>
          <tbody>
            {filteredStudents.length===0?(
              <tr>
                <td colSpan={isSuperAdmin ? "7" : "5"} className="p-8 text-center text-gray-500">
                  No students found
                </td>
              </tr>
            ):(
              filteredStudents.map(s=>
                <tr key={s.docId} className={`border-b hover:bg-gray-50 ${selectedStudents.includes(s.docId)?'bg-blue-50':''}`}>
                  {isSuperAdmin && (
                    <td className="p-3">
                      <input 
                        type="checkbox" 
                        checked={selectedStudents.includes(s.docId)}
                        onChange={()=>handleSelectStudent(s.docId)}
                        className="cursor-pointer"
                      />
                    </td>
                  )}
                  <td className="p-3">{s.school}</td>
                  <td className="p-3">
                    <span className="font-mono bg-blue-100 px-2 py-1 rounded font-bold">
                      {s.id}
                    </span>
                  </td>
                  <td className="p-3">Class {s.grade}</td>
                  <td className="p-3 font-semibold">{s.name}</td>
                  <td className="p-3">{s.gender}</td>
                  {isSuperAdmin && (
                    <td className="p-3">
                      <div className="flex gap-2">
                        <button onClick={()=>openEditModal(s)} className="px-3 py-1 bg-yellow-400 rounded-lg font-semibold">
                          Edit
                        </button>
                        <button onClick={()=>handleDelete(s)} className="px-3 py-1 bg-red-500 text-white rounded-lg font-semibold">
                          Delete
                        </button>
                      </div>
                    </td>
                  )}
                </tr>
              )
            )}
          </tbody>
        </table>
      </div>

      {isSuperAdmin && showModal&&(
        <div className="modal-overlay" onClick={()=>{setShowModal(false);setEditingStudent(null)}}>
          <div className="modal-content" onClick={e=>e.stopPropagation()}>
            <h3 className="text-2xl font-bold mb-4">{editingStudent?'Edit Student':'Add New Student'}</h3>
            <div className="space-y-4">
              <div>
                <label className="block text-sm font-bold mb-1">School *</label>
                <select value={form.school} onChange={e=>setForm({...form,school:e.target.value})} className="w-full border-2 px-3 py-2 rounded-lg">
                  <option value="">Select</option>
                  {SCHOOLS.map(s=><option key={s} value={s}>{s}</option>)}
                </select>
              </div>
              <div>
                <label className="block text-sm font-bold mb-1">Student ID * (For Login)</label>
                <input 
                  type="text" 
                  value={form.id} 
                  onChange={e=>setForm({...form,id:e.target.value})} 
                  placeholder="e.g., STU001"
                  className="w-full border-2 px-3 py-2 rounded-lg"
                />
                <p className="text-xs text-gray-600 mt-1">This will be used for student login</p>
              </div>
              <div>
                <label className="block text-sm font-bold mb-1">Grade *</label>
                <select value={form.grade} onChange={e=>setForm({...form,grade:e.target.value})} className="w-full border-2 px-3 py-2 rounded-lg">
                  <option value="">Select</option>
                  <option value="11">Class 11</option>
                  <option value="12">Class 12</option>
                </select>
              </div>
              <div>
                <label className="block text-sm font-bold mb-1">Name *</label>
                <input type="text" value={form.name} onChange={e=>setForm({...form,name:e.target.value})} className="w-full border-2 px-3 py-2 rounded-lg"/>
              </div>
              <div>
                <label className="block text-sm font-bold mb-1">Gender *</label>
                <select value={form.gender} onChange={e=>setForm({...form,gender:e.target.value})} className="w-full border-2 px-3 py-2 rounded-lg">
                  <option value="">Select</option>
                  {GENDERS.map(g=><option key={g} value={g}>{g}</option>)}
                </select>
              </div>
              {!editingStudent&&(
                <div className="bg-blue-50 border-2 border-blue-300 p-3 rounded-lg">
                  <p className="text-sm text-blue-800">
                    <strong>üîê Login Credentials:</strong>
                    <br/>Student ID: <span className="font-mono">{form.id||'(will be generated)'}</span>
                    <br/>Password: <span className="font-mono bg-yellow-100 px-2 py-1 rounded">pass123</span>
                  </p>
                </div>
              )}
              <div className="flex gap-3">
                <button onClick={handleSave} className="flex-1 avanti-gradient text-white py-3 rounded-xl font-semibold">
                  Save
                </button>
                <button onClick={()=>{setShowModal(false);setEditingStudent(null);setForm({school:'',grade:'',name:'',gender:'',id:''})}} className="flex-1 bg-gray-300 py-3 rounded-xl font-semibold">
                  Cancel
                </button>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

// ========================================
// TEACHER ATTENDANCE DASHBOARD
// ========================================
function TeacherAttendanceDashboard({currentUser,students,teachers,studentAttendance,teacherAttendance}){
  const[filterGrade,setFilterGrade]=useState('All');
  const[filterSubject,setFilterSubject]=useState('All');
  const today = getTodayDate();
  const[startDate,setStartDate]=useState(today);
  const[endDate,setEndDate]=useState(today);

  const mySchool=currentUser.school;

  const chart1Ref=useRef(null);
  const chart2Ref=useRef(null);
  const chart3Ref=useRef(null);
  const chartInstances=useRef({});

  const filteredStudentAttendance=useMemo(()=>{
    return studentAttendance.filter(a=>{
      if(a.school!==mySchool)return false;
      if(filterGrade!=='All'&&a.grade!==filterGrade)return false;
      if(a.date<startDate||a.date>endDate)return false;
      return true;
    });
  },[studentAttendance,mySchool,filterGrade,startDate,endDate]);

  const filteredTeacherAttendance=useMemo(()=>{
    return teacherAttendance.filter(a=>{
      if(a.school!==mySchool)return false;
      if(filterSubject!=='All'){
        const teacher=teachers.find(t=>t.afid===a.teacherId);
        if(!teacher||teacher.subject!==filterSubject)return false;
      }
      if(a.date<startDate||a.date>endDate)return false;
      return true;
    });
  },[teacherAttendance,mySchool,teachers,filterSubject,startDate,endDate]);

  const dailyStats=useMemo(()=>{
    const stats={};
    filteredStudentAttendance.forEach(a=>{
      if(!stats[a.date]){
        stats[a.date]={present:0,absent:0};
      }
      if(a.status==='Present'){
        stats[a.date].present++;
      }else{
        stats[a.date].absent++;
      }
    });
    return stats;
  },[filteredStudentAttendance]);

  const gradeStats=useMemo(()=>{
    const stats={'11':{present:0,absent:0},'12':{present:0,absent:0}};
    filteredStudentAttendance.forEach(a=>{
      if(stats[a.grade]){
        if(a.status==='Present'){
          stats[a.grade].present++;
        }else{
          stats[a.grade].absent++;
        }
      }
    });
    return stats;
  },[filteredStudentAttendance]);

  const teacherStats=useMemo(()=>{
    const present=filteredTeacherAttendance.filter(a=>a.status==='Present').length;
    const onLeave=filteredTeacherAttendance.filter(a=>a.status==='On Leave').length;
    return{present,onLeave};
  },[filteredTeacherAttendance]);

  useEffect(()=>{
    Object.values(chartInstances.current).forEach(chart=>{
      if(chart)chart.destroy();
    });
    chartInstances.current={};

    if(chart1Ref.current){
      const ctx=chart1Ref.current.getContext('2d');
      const dates=Object.keys(dailyStats).sort();
      chartInstances.current.chart1=new Chart(ctx,{
        type:'line',
        data:{
          labels:dates.map(d=>new Date(d).getDate()+'/'+String(new Date(d).getMonth()+1)),
          datasets:[
            {
              label:'Present',
              data:dates.map(d=>dailyStats[d].present),
              borderColor:'#10B981',
              backgroundColor:'rgba(16,185,129,0.1)',
              tension:0.4,
              fill:true
            },
            {
              label:'Absent',
              data:dates.map(d=>dailyStats[d].absent),
              borderColor:'#EF4444',
              backgroundColor:'rgba(239,68,68,0.1)',
              tension:0.4,
              fill:true
            }
          ]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            title:{display:true,text:'Daily Student Attendance Trend',font:{size:16,weight:'bold'}},
            legend:{position:'bottom'}
          },
          scales:{y:{beginAtZero:true}}
        }
      });
    }

    if(chart2Ref.current){
      const ctx=chart2Ref.current.getContext('2d');
      chartInstances.current.chart2=new Chart(ctx,{
        type:'bar',
        data:{
          labels:['Class 11','Class 12'],
          datasets:[
            {
              label:'Present',
              data:[gradeStats['11'].present,gradeStats['12'].present],
              backgroundColor:'#10B981'
            },
            {
              label:'Absent',
              data:[gradeStats['11'].absent,gradeStats['12'].absent],
              backgroundColor:'#EF4444'
            }
          ]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            title:{display:true,text:'Grade-wise Attendance',font:{size:16,weight:'bold'}},
            legend:{position:'bottom'}
          },
          scales:{y:{beginAtZero:true}}
        }
      });
    }

    if(chart3Ref.current){
      const ctx=chart3Ref.current.getContext('2d');
      chartInstances.current.chart3=new Chart(ctx,{
        type:'pie',
        data:{
          labels:['Present','On Leave'],
          datasets:[{
            data:[teacherStats.present,teacherStats.onLeave],
            backgroundColor:['#5B8A8A','#D4A574'],
            borderWidth:2,
            borderColor:'#fff'
          }]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            title:{display:true,text:'Teacher Attendance',font:{size:16,weight:'bold'}},
            legend:{position:'bottom'}
          }
        }
      });
    }

    return()=>{
      Object.values(chartInstances.current).forEach(chart=>{
        if(chart)chart.destroy();
      });
    };
  },[dailyStats,gradeStats,teacherStats]);

  const handleExportStudents=()=>{
    const exportData=filteredStudentAttendance.map(a=>({
      Date:a.date,
      Grade:a.grade,
      'Student Name':a.studentName,
      Status:a.status,
      Remarks:a.remarks||'',
      'Marked By':a.markedBy
    }));
    exportToExcel(exportData,`student_attendance_${mySchool}_${startDate}_to_${endDate}`);
  };

  const handleExportTeachers=()=>{
    const exportData=filteredTeacherAttendance.map(a=>({
      Date:a.date,
      'Teacher Name':a.teacherName,
      'Punch-In Time':a.punchInTime||'Not recorded',
      Status:a.status,
      Reason:a.reason,
      Location:a.location
    }));
    exportToExcel(exportData,`teacher_attendance_${mySchool}_${startDate}_to_${endDate}`);
  };

  return(
    <div className="space-y-6">
      <div className="flex justify-between items-center">
        <h2 className="text-3xl font-bold">üìä Attendance Dashboard - {mySchool}</h2>
      </div>

      <div className="bg-white p-6 rounded-2xl shadow-lg">
        <h3 className="text-xl font-bold mb-4">üîç Filters</h3>
        <div className="grid md:grid-cols-4 gap-4">
          <div>
            <label className="block text-sm font-bold mb-2">Student Grade</label>
            <select value={filterGrade} onChange={e=>setFilterGrade(e.target.value)} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed">
              <option value="All">All Grades</option>
              <option value="11">Class 11</option>
              <option value="12">Class 12</option>
            </select>
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">Teacher Subject</label>
            <select value={filterSubject} onChange={e=>setFilterSubject(e.target.value)} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed">
              <option value="All">All Subjects</option>
              {SUBJECTS.map(s=><option key={s} value={s}>{s}</option>)}
            </select>
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">Start Date</label>
            <input type="date" value={startDate} onChange={e=>setStartDate(e.target.value)} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"/>
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">End Date</label>
            <input type="date" value={endDate} onChange={e=>setEndDate(e.target.value)} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"/>
          </div>
        </div>
        <div className="flex gap-3 mt-4">
          <button onClick={handleExportStudents} className="px-6 py-3 bg-green-600 text-white rounded-xl font-semibold">
            üì• Export Student Attendance
          </button>
          <button onClick={handleExportTeachers} className="px-6 py-3 bg-blue-600 text-white rounded-xl font-semibold">
            üì• Export Teacher Attendance
          </button>
        </div>
      </div>

      <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div className="stat-card bg-green-500 text-white">
          <div className="text-sm opacity-90">Students Present</div>
          <div className="text-4xl font-bold">{filteredStudentAttendance.filter(a=>a.status==='Present').length}</div>
        </div>
        <div className="stat-card bg-red-500 text-white">
          <div className="text-sm opacity-90">Students Absent</div>
          <div className="text-4xl font-bold">{filteredStudentAttendance.filter(a=>a.status==='Absent').length}</div>
        </div>
        <div className="stat-card bg-blue-500 text-white">
          <div className="text-sm opacity-90">Teachers Present</div>
          <div className="text-4xl font-bold">{teacherStats.present}</div>
        </div>
        <div className="stat-card bg-orange-500 text-white">
          <div className="text-sm opacity-90">Teachers on Leave</div>
          <div className="text-4xl font-bold">{teacherStats.onLeave}</div>
        </div>
      </div>

      <div className="grid md:grid-cols-2 gap-6">
        <div className="bg-white p-6 rounded-2xl shadow-lg" style={{height:'350px'}}>
          <canvas ref={chart1Ref}></canvas>
        </div>
        <div className="bg-white p-6 rounded-2xl shadow-lg" style={{height:'350px'}}>
          <canvas ref={chart2Ref}></canvas>
        </div>
      </div>

      <div className="bg-white p-6 rounded-2xl shadow-lg" style={{height:'350px'}}>
        <canvas ref={chart3Ref}></canvas>
      </div>

      <div className="grid md:grid-cols-2 gap-6">
        <div className="bg-white p-6 rounded-2xl shadow-lg">
          <h3 className="text-xl font-bold mb-4">üìã Recent Student Attendance</h3>
          <div className="overflow-x-auto max-h-96">
            <table className="w-full">
              <thead className="avanti-gradient-light sticky top-0">
                <tr>
                  <th className="p-3 text-left">Date</th>
                  <th className="p-3 text-left">Grade</th>
                  <th className="p-3 text-left">Student</th>
                  <th className="p-3 text-left">Status</th>
                </tr>
              </thead>
              <tbody>
                {filteredStudentAttendance.slice(0,50).map((a,idx)=>
                  <tr key={idx} className="border-b hover:bg-gray-50">
                    <td className="p-3 text-sm">{a.date}</td>
                    <td className="p-3">{a.grade}</td>
                    <td className="p-3 font-semibold">{a.studentName}</td>
                    <td className="p-3">
                      <span className={`px-2 py-1 rounded-full text-xs font-bold ${a.status==='Present'?'bg-green-100 text-green-700':'bg-red-100 text-red-700'}`}>
                        {a.status}
                      </span>
                    </td>
                  </tr>
                )}
              </tbody>
            </table>
          </div>
        </div>

        <div className="bg-white p-6 rounded-2xl shadow-lg">
          <h3 className="text-xl font-bold mb-4">üë• Teacher Attendance Records</h3>
          <div className="overflow-x-auto max-h-96">
            <table className="w-full">
              <thead className="avanti-gradient-light sticky top-0">
                <tr>
                  <th className="p-3 text-left">Date</th>
                  <th className="p-3 text-left">Teacher</th>
                  <th className="p-3 text-left">Punch-In</th>
                  <th className="p-3 text-left">Status</th>
                  <th className="p-3 text-left">Reason</th>
                </tr>
              </thead>
              <tbody>
                {filteredTeacherAttendance.slice(0,50).map((a,idx)=>
                  <tr key={idx} className="border-b hover:bg-gray-50">
                    <td className="p-3 text-sm">{a.date}</td>
                    <td className="p-3 font-semibold">{a.teacherName}</td>
                    <td className="p-3">
                      <span className="font-mono font-bold text-blue-600">
                        ‚è∞ {a.punchInTime||'--:--'}
                      </span>
                    </td>
                    <td className="p-3">
                      <span className={`px-2 py-1 rounded-full text-xs font-bold ${a.status==='Present'?'bg-green-100 text-green-700':'bg-orange-100 text-orange-700'}`}>
                        {a.status}
                      </span>
                    </td>
                    <td className="p-3 text-sm">{a.reason}</td>
                  </tr>
                )}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  );
}
// ========================================
// REMARKS MODAL FOR ABSENT STUDENTS
// ========================================
function RemarksModal({student,onSave,onClose}){
  const[selectedRemark,setSelectedRemark]=useState('Sick Leave');
  const[customRemark,setCustomRemark]=useState('');

  const ABSENCE_REASONS=[
    'Sick Leave',
    'Went Home for Festival',
    'Family Emergency',
    'Medical Appointment',
    'Personal Reason',
    'Staff Ward',
    'Others'
  ];

  const handleSave=()=>{
    const finalRemark=selectedRemark==='Others'?customRemark:selectedRemark;
    if(selectedRemark==='Others'&&!customRemark.trim()){
      alert('Please enter a custom reason');
      return;
    }
    onSave(finalRemark);
  };

  return(
    <div className="modal-overlay" onClick={onClose}>
      <div className="modal-content" onClick={e=>e.stopPropagation()}>
        <h3 className="text-2xl font-bold mb-4">üìù Absence Remarks</h3>
        <p className="text-gray-600 mb-4">Student: <strong>{student.name}</strong></p>
        
        <div className="space-y-4">
          <div>
            <label className="block text-sm font-bold mb-2">Reason for Absence *</label>
            <select 
              value={selectedRemark} 
              onChange={e=>setSelectedRemark(e.target.value)} 
              disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"
            >
              {ABSENCE_REASONS.map(reason=>
                <option key={reason} value={reason}>{reason}</option>
              )}
            </select>
          </div>

          {selectedRemark==='Others'&&(
            <div>
              <label className="block text-sm font-bold mb-2">Please Specify *</label>
              <textarea
                value={customRemark}
                onChange={e=>setCustomRemark(e.target.value)}
                className="w-full border-2 px-4 py-3 rounded-xl"
                rows="3"
                placeholder="Enter custom reason..."
              />
            </div>
          )}

          <div className="flex gap-3 mt-6">
            <button 
              onClick={handleSave} 
              className="flex-1 bg-red-500 text-white py-3 rounded-xl font-semibold"
            >
              Mark Absent
            </button>
            <button 
              onClick={onClose} 
              className="flex-1 bg-gray-300 py-3 rounded-xl font-semibold"
            >
              Cancel
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}    
// ========================================
// STUDENT ATTENDANCE VIEW (FOR TEACHERS)
// ========================================
function StudentAttendanceView({currentUser,students,studentAttendance}){
  const[selectedGrade,setSelectedGrade]=useState('11');
  const[selectedDate,setSelectedDate]=useState(getTodayDate());
  const[attendanceMap,setAttendanceMap]=useState({});
  const[showRemarksModal,setShowRemarksModal]=useState(false);
  const[selectedStudent,setSelectedStudent]=useState(null);
  const[lockStatus,setLockStatus]=useState({11: false, 12: false}); // Track lock status for each grade
  const[lockInfo,setLockInfo]=useState({11: null, 12: null}); // Track lock info for each grade
  const[isLoading,setIsLoading]=useState(false);
  const[isMarkingAll,setIsMarkingAll]=useState(false);
  const[markingProgress,setMarkingProgress]=useState({current:0,total:0});
  
  // Current grade lock status
  const isLocked = lockStatus[selectedGrade] || false;
  const currentLockInfo = lockInfo[selectedGrade] || null;

  const mySchool=currentUser.school;
  
  // ‚úÖ FIX: Case-insensitive and trim school name matching to handle data inconsistencies
  const normalizeSchool = (school) => (school || '').toString().trim().toLowerCase();
  const mySchoolNormalized = normalizeSchool(mySchool);
  
  const filteredStudents=students
  .filter(s => {
    const studentSchoolNormalized = normalizeSchool(s.school);
    const gradeMatches = String(s.grade) === String(selectedGrade);
    const schoolMatches = studentSchoolNormalized === mySchoolNormalized;
    return schoolMatches && gradeMatches;
  })
  .sort((a,b)=>a.name.localeCompare(b.name));

  console.log('StudentAttendanceView Debug:',{
    mySchool,
    mySchoolNormalized,
    selectedGrade,
    totalStudents:students.length,
    filteredCount:filteredStudents.length,
    allSchools:Array.from(new Set(students.map(s=>s.school))),
    allGrades:Array.from(new Set(students.map(s=>s.grade))),
    sampleStudents: students.slice(0,3).map(s=>({school:s.school, grade:s.grade, name:s.name}))
  });

  useEffect(()=>{
    const map={};
    studentAttendance
      .filter(a=>a.date===selectedDate&&a.school===mySchool&&a.grade===selectedGrade)
      .forEach(a=>{
        map[a.studentId]=a.status;
      });
    setAttendanceMap(map);
    
    // ‚úÖ Check lock status for BOTH grades
    checkAllLocks();
  }, [selectedDate, mySchool, studentAttendance]);
  
  // Check when grade changes
  useEffect(()=>{
    const map={};
    studentAttendance
      .filter(a=>a.date===selectedDate&&a.school===mySchool&&a.grade===selectedGrade)
      .forEach(a=>{
        map[a.studentId]=a.status;
      });
    setAttendanceMap(map);
  }, [selectedGrade]);
  
  const checkAllLocks=async()=>{
    try{
      const newLockStatus = {11: false, 12: false};
      const newLockInfo = {11: null, 12: null};
      
      // Check lock for both grades
      for (const grade of ['11', '12']) {
        const lockId=`${mySchool}_${grade}_${selectedDate}`;
        const lockDoc=await db.collection('attendanceLocks').doc(lockId).get();
        
        if(lockDoc.exists){
          newLockStatus[grade] = true;
          newLockInfo[grade] = lockDoc.data();
        }
      }
      
      setLockStatus(newLockStatus);
      setLockInfo(newLockInfo);
    }catch(e){
      console.error('Error checking locks:',e);
    }
  };
  
  const lockAttendance=async()=>{
    const confirmation=confirm(`Are you sure you want to lock attendance for Class ${selectedGrade} on ${selectedDate}?\n\nOnce locked:\n- No teacher can mark or change attendance for Class ${selectedGrade}\n- Only admins can unlock it\n\nThis prevents duplicate entries.`);
    
    if(!confirmation)return;
    
    try{
      setIsLoading(true);
      const lockId=`${mySchool}_${selectedGrade}_${selectedDate}`;
      
      await db.collection('attendanceLocks').doc(lockId).set({
        school:mySchool,
        grade:selectedGrade,
        date:selectedDate,
        lockedBy:currentUser.afid,
        lockedAt:new Date().toISOString(),
        lockedByName:currentUser.name||currentUser.afid
      });
      
      alert(`‚úÖ Attendance locked for Class ${selectedGrade}!\n\nNo one can modify attendance for Class ${selectedGrade} on this date now.`);
      checkAllLocks();
    }catch(e){
      alert('Failed to lock: '+e.message);
    }finally{
      setIsLoading(false);
    }
  };
  
  const unlockAttendance=async()=>{
    if(currentUser.role!=='admin'){
      alert('Only admins can unlock attendance.');
      return;
    }
    
    const confirmation=confirm(`Are you sure you want to unlock attendance for Class ${selectedGrade}?\n\nTeachers will be able to mark/modify attendance for Class ${selectedGrade} again.`);
    
    if(!confirmation)return;
    
    try{
      setIsLoading(true);
      const lockId=`${mySchool}_${selectedGrade}_${selectedDate}`;
      await db.collection('attendanceLocks').doc(lockId).delete();
      
      alert(`‚úÖ Attendance unlocked for Class ${selectedGrade}!`);
      checkAllLocks();
    }catch(e){
      alert('Failed to unlock: '+e.message);
    }finally{
      setIsLoading(false);
    }
  };
  const handleAttendanceChange=async(studentId,status,remarks='')=>{
    // ‚úÖ CHECK IF LOCKED
        if (isLocked) {
      const lockedBy = currentLockInfo?.lockedByName || 'Unknown';
      const lockedAt = currentLockInfo?.lockedAt
        ? new Date(currentLockInfo.lockedAt).toLocaleString()
        : 'Unknown time';

      alert(
        `‚ùå Attendance is locked for Class ${selectedGrade} on this date!\n\n` +
        `Locked by: ${lockedBy}\n` +
        `Locked at: ${lockedAt}\n\n` +
        'Contact admin to unlock.'
      );
      return;
    }
    
    try{
  // ‚úÖ UPDATE UI FIRST (Optimistic update)
  setAttendanceMap(prev=>({...prev,[studentId]:status}));
  
  // ‚úÖ Prepare attendance data
  const docId=`${mySchool}_${selectedGrade}_${studentId}_${selectedDate}`;
  const attendanceData = {
    school:mySchool,
    grade:selectedGrade,
    studentId,
    studentName:filteredStudents.find(s=>s.id===studentId)?.name||'',
    date:selectedDate,
    status,
    remarks:status==='Absent'?remarks:'',
    markedBy:currentUser.afid,
    markedAt:new Date().toISOString(),
    docId: docId
  };
  
  // ‚úÖ MODERN: Use ConnectionManager for better offline detection
  const isOnline = window.ConnectionManager ? 
    window.ConnectionManager.isOnline() : 
    (window.isPWAOnline ? window.isPWAOnline() : navigator.onLine);
  
  let savedSuccessfully = false;
  
  if (!isOnline) {
    // OFFLINE - Queue for later sync
    if (window.OfflineQueue) {
      window.OfflineQueue.add({
        type: 'attendance',
        docId: docId,
        data: attendanceData
      });
      console.log('üìù Attendance queued for offline sync:', docId);
    } else if (window.saveAttendanceOffline) {
      await window.saveAttendanceOffline(attendanceData);
    }
    // Show non-intrusive notification
    if (window.showPWAToast) window.showPWAToast('Saved offline - will sync when online', 'warning');
    savedSuccessfully = true;
  } else {
    // ONLINE - Save to Firebase with retry
    try {
      if (window.retryWithBackoff) {
        await window.retryWithBackoff(
          () => db.collection('studentAttendance').doc(docId).set(attendanceData),
          { maxRetries: 2, baseDelay: 500 }
        );
      } else {
        await db.collection('studentAttendance').doc(docId).set(attendanceData);
      }
      savedSuccessfully = true;
      console.log('‚úÖ Attendance saved:', docId);
    } catch (firebaseError) {
      // Firebase failed, queue for offline sync
      console.warn('Firebase save failed, queuing offline:', firebaseError.message);
      if (window.OfflineQueue) {
        window.OfflineQueue.add({
          type: 'attendance',
          docId: docId,
          data: attendanceData
        });
        savedSuccessfully = true;
        if (window.showPWAToast) window.showPWAToast('Network slow - saved locally', 'warning');
      } else {
        throw firebaseError;
      }
    }
  }
  
  // ‚úÖ CRITICAL FIX: Update the global attendance cache immediately
  // This ensures the dashboard shows the correct count right away
  if (savedSuccessfully && window.DataCacheManager) {
    try {
      const cacheKey = 'studentAttendance_' + (mySchool || 'all');
      const cachedData = await window.DataCacheManager.loadFromCache(cacheKey);
      if (cachedData?.docs) {
        // Update or add the attendance record in cache
        const existingIndex = cachedData.docs.findIndex(d => d.id === docId);
        if (existingIndex >= 0) {
          cachedData.docs[existingIndex].data = attendanceData;
        } else {
          cachedData.docs.push({ id: docId, data: attendanceData });
        }
        await window.DataCacheManager.saveToCache(cacheKey, cachedData);
        console.log('‚úÖ Attendance cache updated for:', docId);
      }
    } catch (cacheErr) {
      console.log('Cache update skipped:', cacheErr.message);
    }
  }
  
}catch(e){
  // ‚úÖ Try offline queue if all else fails
  try {
    const docId=`${mySchool}_${selectedGrade}_${studentId}_${selectedDate}`;
    const attendanceData = {
      school:mySchool,
      grade:selectedGrade,
      studentId,
      studentName:filteredStudents.find(s=>s.id===studentId)?.name||'',
      date:selectedDate,
      status,
      remarks:status==='Absent'?remarks:'',
      markedBy:currentUser.afid,
      markedAt:new Date().toISOString(),
      docId: docId
    };
    
    if (window.OfflineQueue) {
      window.OfflineQueue.add({
        type: 'attendance',
        docId: docId,
        data: attendanceData
      });
      if (window.showPWAToast) window.showPWAToast('Saved locally - will sync later', 'warning');
    } else if (window.saveAttendanceOffline) {
      await window.saveAttendanceOffline(attendanceData);
      if (window.showPWAToast) window.showPWAToast('Network error - saved offline', 'warning');
    } else {
      throw e;
    }
  } catch (offlineErr) {
    // ‚úÖ Rollback UI if all saves fail
    setAttendanceMap(prev=>({...prev,[studentId]:prev[studentId]||''}));
    alert('Failed to save: '+e.message);
  }
}
};

  const handleSelectAll=async()=>{
    // ‚úÖ CHECK IF LOCKED
        if (isLocked) {
      const lockedBy = lockInfo?.lockedByName || 'Unknown';
      const lockedAt = lockInfo?.lockedAt
        ? new Date(lockInfo.lockedAt).toLocaleString()
        : 'Unknown time';

      alert(
        '‚ùå Attendance is locked for this date!\n\n' +
        `Locked by: ${lockedBy}\n` +
        `Locked at: ${lockedAt}\n\n` +
        'Contact admin to unlock.'
      );
      return;
    }
    
    // ‚úÖ SHOW LOADING OVERLAY
    setIsMarkingAll(true);
    setMarkingProgress({current:0,total:filteredStudents.length});
    
    try{
      let completed=0;
      for(const student of filteredStudents){
  const docId=`${mySchool}_${selectedGrade}_${student.id}_${selectedDate}`;
  const attendanceData = {
    school:mySchool,
    grade:selectedGrade,
    studentId:student.id,
    studentName:student.name,
    date:selectedDate,
    status:'Present',
    markedBy:currentUser.afid,
    markedAt:new Date().toISOString(),
    docId: docId
  };
  
  // ‚úÖ PWA: Check if online or offline
  if (window.isPWAOnline && !window.isPWAOnline()) {
    await window.saveAttendanceOffline(attendanceData);
  } else {
    try {
      await db.collection('studentAttendance').doc(docId).set(attendanceData);
    } catch (err) {
      // Fallback to offline if Firebase fails
      if (window.saveAttendanceOffline) {
        await window.saveAttendanceOffline(attendanceData);
      }
    }
  }
  completed++;
  setMarkingProgress({current:completed,total:filteredStudents.length});
}

// Show toast if saved offline
if (window.isPWAOnline && !window.isPWAOnline()) {
  if (window.showPWAToast) window.showPWAToast(`${filteredStudents.length} students saved offline`, 'warning');
}
      const newMap={};
      filteredStudents.forEach(s=>newMap[s.id]='Present');
      setAttendanceMap(newMap);
      alert('All students marked present!');
    }catch(e){
      alert('Failed: '+e.message);
    }finally{
      // ‚úÖ HIDE LOADING OVERLAY
      setIsMarkingAll(false);
      setMarkingProgress({current:0,total:0});
    }
  };

  return(
    <div className="space-y-6">
      {/* ‚úÖ FULL-SCREEN LOADING OVERLAY FOR MARK ALL PRESENT */}
      {isMarkingAll&&(
        <div style={{
          position:'fixed',
          top:0,
          left:0,
          right:0,
          bottom:0,
          backgroundColor:'rgba(0,0,0,0.7)',
          display:'flex',
          flexDirection:'column',
          alignItems:'center',
          justifyContent:'center',
          zIndex:99999
        }}>
          <div style={{
            backgroundColor:'white',
            padding:'2rem',
            borderRadius:'1rem',
            textAlign:'center',
            maxWidth:'90%',
            width:'320px',
            boxShadow:'0 20px 60px rgba(0,0,0,0.3)'
          }}>
            {/* Spinner */}
            <div style={{
              width:'60px',
              height:'60px',
              border:'4px solid #e5e7eb',
              borderTopColor:'#10b981',
              borderRadius:'50%',
              animation:'spin 1s linear infinite',
              margin:'0 auto 1rem'
            }}></div>
            <div style={{fontSize:'1.25rem',fontWeight:'bold',color:'#1f2937',marginBottom:'0.5rem'}}>
              Marking Attendance...
            </div>
            <div style={{fontSize:'1rem',color:'#6b7280',marginBottom:'1rem'}}>
              Please wait, do not close this page
            </div>
            {/* Progress indicator */}
            <div style={{
              width:'100%',
              height:'8px',
              backgroundColor:'#e5e7eb',
              borderRadius:'4px',
              overflow:'hidden',
              marginBottom:'0.5rem'
            }}>
              <div style={{
                width:`${markingProgress.total>0?(markingProgress.current/markingProgress.total)*100:0}%`,
                height:'100%',
                backgroundColor:'#10b981',
                transition:'width 0.3s ease'
              }}></div>
            </div>
            <div style={{fontSize:'0.875rem',color:'#6b7280'}}>
              {markingProgress.current} of {markingProgress.total} students
            </div>
          </div>
        </div>
      )}
      
      <h2 className="text-3xl font-bold">Student Attendance - {mySchool}</h2>

      {/* ‚úÖ GRADE LOCK STATUS OVERVIEW */}
      <div className="grid grid-cols-2 gap-4">
        <div className={`p-4 rounded-xl border-2 ${lockStatus['11'] ? 'bg-red-50 border-red-300' : 'bg-green-50 border-green-300'}`}>
          <div className="flex items-center justify-between">
            <div>
              <span className="font-bold text-lg">Class 11</span>
              <span className={`ml-2 px-2 py-1 rounded text-sm font-semibold ${lockStatus['11'] ? 'bg-red-200 text-red-800' : 'bg-green-200 text-green-800'}`}>
                {lockStatus['11'] ? 'üîí Locked' : 'üîì Unlocked'}
              </span>
            </div>
            {lockStatus['11'] && lockInfo['11'] && (
              <div className="text-xs text-gray-600">
                by {lockInfo['11'].lockedByName}
              </div>
            )}
          </div>
        </div>
        <div className={`p-4 rounded-xl border-2 ${lockStatus['12'] ? 'bg-red-50 border-red-300' : 'bg-green-50 border-green-300'}`}>
          <div className="flex items-center justify-between">
            <div>
              <span className="font-bold text-lg">Class 12</span>
              <span className={`ml-2 px-2 py-1 rounded text-sm font-semibold ${lockStatus['12'] ? 'bg-red-200 text-red-800' : 'bg-green-200 text-green-800'}`}>
                {lockStatus['12'] ? 'üîí Locked' : 'üîì Unlocked'}
              </span>
            </div>
            {lockStatus['12'] && lockInfo['12'] && (
              <div className="text-xs text-gray-600">
                by {lockInfo['12'].lockedByName}
              </div>
            )}
          </div>
        </div>
      </div>

      {/* ‚úÖ LOCK STATUS BANNER FOR SELECTED GRADE */}
      {isLocked&&(
        <div className="bg-red-100 border-2 border-red-500 p-4 rounded-xl">
          <div className="flex items-center justify-between">
            <div>
              <div className="font-bold text-red-800">üîí Attendance is LOCKED for Class {selectedGrade}</div>
              <div className="text-sm text-red-700 mt-1">
                Locked by: <strong>{currentLockInfo?.lockedByName || 'Unknown'}</strong> on {currentLockInfo?.lockedAt ? new Date(currentLockInfo.lockedAt).toLocaleString() : 'Unknown date'}
              </div>
              <div className="text-sm text-red-700">No changes can be made to Class {selectedGrade} attendance for this date.</div>
            </div>
            {currentUser.role==='admin'&&(
              <button 
                onClick={unlockAttendance} 
                disabled={isLoading}
                className="px-6 py-3 bg-yellow-600 hover:bg-yellow-700 text-white rounded-xl font-semibold disabled:opacity-50">
                {isLoading?'Unlocking...':'üîì Unlock Class '+selectedGrade}
              </button>
            )}
          </div>
        </div>
      )}

      {/* ‚úÖ SUCCESS BANNER WHEN UNLOCKED */}
      {!isLocked&&selectedDate===getTodayDate()&&(
        <div className="bg-green-100 border-2 border-green-500 p-4 rounded-xl">
          <div className="flex items-center justify-between">
            <div>
              <div className="font-bold text-green-800">‚úÖ Class {selectedGrade} Attendance is UNLOCKED</div>
              <div className="text-sm text-green-700 mt-1">
                You can mark/modify attendance for Class {selectedGrade}. Remember to lock it after completion to prevent duplicates.
              </div>
            </div>
            <button 
              onClick={lockAttendance} 
              disabled={isLoading}
              className="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-semibold disabled:opacity-50">
              {isLoading?'Locking...':'üîí Lock Class '+selectedGrade}
            </button>
          </div>
        </div>
      )}

      <div className="bg-white p-6 rounded-2xl shadow-lg">
        <div className="grid md:grid-cols-3 gap-4 mb-4">
          <div>
            <label className="block text-sm font-bold mb-2">Grade</label>
            <select value={selectedGrade} onChange={e=>setSelectedGrade(e.target.value)} className="w-full border-2 px-4 py-3 rounded-xl">
              <option value="11">Class 11 {lockStatus['11'] ? 'üîí' : ''}</option>
              <option value="12">Class 12 {lockStatus['12'] ? 'üîí' : ''}</option>
            </select>
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">Date</label>
            <input type="date" value={selectedDate} onChange={e=>setSelectedDate(e.target.value)} className="w-full border-2 px-4 py-3 rounded-xl"/>
          </div>
          <div className="flex items-end">
            <button 
              onClick={handleSelectAll} 
              disabled={isLocked||isMarkingAll}
              className="w-full px-6 py-3 bg-green-600 text-white rounded-xl font-semibold disabled:opacity-50 disabled:cursor-not-allowed">
              {isMarkingAll?'‚è≥ Marking...':'‚úÖ Mark All Present'}
            </button>
          </div>
        </div>
      </div>

      <div className="bg-white p-6 rounded-2xl shadow-lg">
        <h3 className="font-bold mb-4">Students ({filteredStudents.length})</h3>
        {filteredStudents.length===0?
          <div className="text-center py-8">
            <p className="text-gray-500 mb-4">No students found</p>
            {students.length > 0 && (
              <div className="text-sm text-amber-600 bg-amber-50 p-4 rounded-xl">
                <p className="font-semibold mb-2">‚ö†Ô∏è Debug Info:</p>
                <p>Total students in database: {students.length}</p>
                <p>Your school: "{mySchool}"</p>
                <p>Selected grade: Class {selectedGrade}</p>
                <p className="mt-2 text-xs">Schools in database: {Array.from(new Set(students.map(s=>s.school))).join(', ')}</p>
                <p className="text-xs mt-1">If your school name doesn't match exactly, contact admin to update student records.</p>
              </div>
            )}
          </div>
        :
          <div className="space-y-2">
            {filteredStudents.map(student=>
              <div key={student.id} className="flex items-center justify-between p-4 border-2 rounded-xl hover:bg-gray-50">
                <div className="flex-1">
                  <div className="font-semibold text-lg">{student.name}</div>
                  <div className="text-sm text-gray-600">{student.gender}</div>
                  {attendanceMap[student.id]==='Absent'&&(
                    <div className="text-xs text-red-600 mt-1">
                      üìù {studentAttendance.find(a=>a.studentId===student.id&&a.date===selectedDate)?.remarks||'No reason provided'}
                    </div>
                  )}
                </div>
                <div className="flex gap-2">
                  <button 
                    onClick={()=>handleAttendanceChange(student.id,'Present')}
                    disabled={isLocked}
                    className={`px-6 py-2 rounded-lg font-semibold disabled:opacity-50 disabled:cursor-not-allowed ${attendanceMap[student.id]==='Present'?'bg-green-500 text-white':'bg-gray-200'}`}
                  >
                    ‚úì Present
                  </button>
                  <button 
                    onClick={()=>{
                      if(!isLocked){
                        setSelectedStudent(student);
                        setShowRemarksModal(true);
                      }
                    }}
                    disabled={isLocked}
                    className={`px-6 py-2 rounded-lg font-semibold disabled:opacity-50 disabled:cursor-not-allowed ${attendanceMap[student.id]==='Absent'?'bg-red-500 text-white':'bg-gray-200'}`}
                  >
                    ‚úó Absent
                  </button>
                </div>
              </div>
            )}
          </div>
        }
      </div>

      {showRemarksModal&&selectedStudent&&(
        <RemarksModal
          student={selectedStudent}
          onSave={(remarks)=>{
            handleAttendanceChange(selectedStudent.id,'Absent',remarks);
            setShowRemarksModal(false);
            setSelectedStudent(null);
          }}
          onClose={()=>{
            setShowRemarksModal(false);
            setSelectedStudent(null);
          }}
        />
      )}
    </div>
  );
}

// ========================================
// TEACHER ATTENDANCE VIEW
// ========================================
function TeacherAttendanceView({currentUser,teacherAttendance,leaveAdjustments}){
  const[selectedDate,setSelectedDate]=useState(getTodayDate());
  const[endDate,setEndDate]=useState(getTodayDate());
  const[isDateRange,setIsDateRange]=useState(false);
  const[status,setStatus]=useState('Present');
  const[reason,setReason]=useState('Present');
  const[location,setLocation]=useState('');
  const[fetchingLocation,setFetchingLocation]=useState(false);
  const[submitting,setSubmitting]=useState(false);
  
  // ‚úÖ FIX: Track locally submitted attendance to update leave balance immediately
  const[localSubmittedAttendance,setLocalSubmittedAttendance]=useState([]);
  
  // ‚úÖ FIX: Track GPS verification status
  const[gpsVerified,setGpsVerified]=useState(false);

  // ‚úÖ FIX: Calculate allowed date range (today and previous 2 days only)
  const today = new Date();
  const maxDate = getTodayDate(); // Today - no future dates allowed
  const minDate = useMemo(() => {
    const d = new Date();
    d.setDate(d.getDate() - 2); // 2 days before today
    return d.toISOString().split('T')[0];
  }, []);

  // ‚úÖ FIX: Merge prop attendance with locally submitted attendance
  const allAttendance = useMemo(() => {
    const merged = [...teacherAttendance];
    localSubmittedAttendance.forEach(local => {
      // Only add if not already in the main list
      if (!merged.some(a => a.teacherId === local.teacherId && a.date === local.date)) {
        merged.push(local);
      }
    });
    return merged;
  }, [teacherAttendance, localSubmittedAttendance]);

  const todayRecord=allAttendance.find(a=>a.teacherId===currentUser.afid&&a.date===selectedDate);
  
  // ‚úÖ FIX: Check if attendance already exists for selected date (prevents modification)
  const hasExistingAttendance = useMemo(() => {
    return allAttendance.some(a => a.teacherId === currentUser.afid && a.date === selectedDate);
  }, [allAttendance, currentUser.afid, selectedDate]);
  
  // ‚úÖ FIX: Calculate leave balance using merged attendance data
  const leaveBalance = useMemo(() => {
    return calculateLeaveBalance(allAttendance, currentUser.afid, leaveAdjustments || {});
  }, [allAttendance, currentUser.afid, leaveAdjustments]);

  useEffect(()=>{
    if(todayRecord){
      setStatus(todayRecord.status);
      setReason(todayRecord.reason||'Present');
      setLocation(todayRecord.location||'');
      setGpsVerified(true); // Already marked, so GPS was verified
    }
  },[todayRecord]);

  // Reset date range when switching back to Present
  useEffect(() => {
    if (status === 'Present') {
      setIsDateRange(false);
      setEndDate(selectedDate);
    }
  }, [status, selectedDate]);
  
  // ‚úÖ FIX: Reset GPS verification when status changes
  useEffect(() => {
    if (status === 'On Leave') {
      setGpsVerified(true); // GPS not required for leave
      setLocation('Leave - GPS not required');
    } else {
      setGpsVerified(false);
      setLocation('');
    }
  }, [status]);

  const getLocation=()=>{
    setFetchingLocation(true);
    if(navigator.geolocation){
      navigator.geolocation.getCurrentPosition(
        position=>{
          const lat = position.coords.latitude.toFixed(6);
          const lng = position.coords.longitude.toFixed(6);
          const accuracy = Math.round(position.coords.accuracy);
          const loc=`${lat}, ${lng} (¬±${accuracy}m)`;
          setLocation(loc);
          setGpsVerified(true); // ‚úÖ Mark GPS as verified
          setFetchingLocation(false);
        },
        (error)=>{
          let errorMsg = 'Unable to fetch location. ';
          switch(error.code) {
            case error.PERMISSION_DENIED:
              errorMsg += 'Please enable location permission in your browser/phone settings.';
              break;
            case error.POSITION_UNAVAILABLE:
              errorMsg += 'Location information unavailable. Please try again.';
              break;
            case error.TIMEOUT:
              errorMsg += 'Location request timed out. Please try again.';
              break;
            default:
              errorMsg += 'Please try again.';
          }
          alert(errorMsg);
          setFetchingLocation(false);
        },
        {
          enableHighAccuracy: true,
          timeout: 15000,
          maximumAge: 0
        }
      );
    }else{
      alert('Geolocation not supported by your browser');
      setFetchingLocation(false);
    }
  };

  // Generate array of dates between start and end
  const getDateRange = (start, end) => {
    const dates = [];
    let currentDate = new Date(start);
    const endDateObj = new Date(end);
    
    while (currentDate <= endDateObj) {
      dates.push(currentDate.toISOString().split('T')[0]);
      currentDate.setDate(currentDate.getDate() + 1);
    }
    return dates;
  };

  // Calculate how many days will be marked
  const daysToMark = useMemo(() => {
    if (!isDateRange || status === 'Present') return 1;
    return getDateRange(selectedDate, endDate).length;
  }, [isDateRange, selectedDate, endDate, status]);

  const handleSubmit=async()=>{
    if(status!=='Present'&&!reason){
      alert('Please select a reason');
      return;
    }
    
    // ‚úÖ FIX: Require GPS verification for Present status
    if(status === 'Present' && !gpsVerified){
      alert('üìç GPS verification required!\n\nPlease click "Get GPS Location" button to verify your location before marking attendance.');
      return;
    }

    // Validate date range
    if (isDateRange && endDate < selectedDate) {
      alert('End date must be after or equal to start date');
      return;
    }

    // Check leave balance for entitled leaves
    if (status === 'On Leave') {
      if (ENTITLED_LEAVE_TYPES.includes(reason) && daysToMark > leaveBalance.entitled.remaining) {
        const proceed = confirm(`Warning: You only have ${leaveBalance.entitled.remaining} entitled leave days remaining, but you're marking ${daysToMark} days.\n\nDo you want to continue?`);
        if (!proceed) return;
      }
      if (MATERNITY_LEAVE_TYPES.includes(reason) && daysToMark > leaveBalance.maternity.remaining) {
        const proceed = confirm(`Warning: You only have ${leaveBalance.maternity.remaining} maternity leave days remaining, but you're marking ${daysToMark} days.\n\nDo you want to continue?`);
        if (!proceed) return;
      }
      if (PATERNITY_LEAVE_TYPES.includes(reason) && daysToMark > leaveBalance.paternity.remaining) {
        const proceed = confirm(`Warning: You only have ${leaveBalance.paternity.remaining} paternity leave days remaining, but you're marking ${daysToMark} days.\n\nDo you want to continue?`);
        if (!proceed) return;
      }
    }

    setSubmitting(true);
    
    try{
      const now=new Date();
      const punchInTime=now.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:true});
      
      // If date range is enabled for leave, mark all dates
      const datesToMark = (isDateRange && status === 'On Leave') 
        ? getDateRange(selectedDate, endDate)
        : [selectedDate];
      
      // Create batch for multiple dates
      const batch = db.batch();
      
      // ‚úÖ FIX: Prepare local records to update leave balance immediately
      const newLocalRecords = [];
      
      datesToMark.forEach(date => {
        const docId = `${currentUser.afid}_${date}`;
        const docRef = db.collection('teacherAttendance').doc(docId);
        const recordData = {
          teacherId: currentUser.afid,
          teacherName: currentUser.name,
          school: currentUser.school,
          date: date,
          status,
          reason: status === 'Present' ? 'Present' : reason,
          location: location || 'Not provided',
          punchInTime: date === getTodayDate() ? punchInTime : 'Leave applied',
          markedAt: new Date().toISOString(),
          // Store date range info for reference
          isPartOfRange: datesToMark.length > 1,
          rangeStart: datesToMark.length > 1 ? selectedDate : null,
          rangeEnd: datesToMark.length > 1 ? endDate : null,
          gpsVerified: gpsVerified // ‚úÖ Track if GPS was verified
        };
        batch.set(docRef, recordData);
        newLocalRecords.push(recordData);
      });
      
      await batch.commit();
      
      // ‚úÖ FIX: Update local state to reflect new attendance immediately
      setLocalSubmittedAttendance(prev => [...prev, ...newLocalRecords]);
      
      if (datesToMark.length > 1) {
        alert(`‚úÖ Leave marked for ${datesToMark.length} days!\nFrom: ${selectedDate}\nTo: ${endDate}\n\nYour leave balance has been updated.`);
      } else {
        alert(`‚úÖ Attendance marked!\nPunch-in time: ${punchInTime}\nLocation: ${location}`);
      }
      
      // Reset date range after successful submission
      setIsDateRange(false);
      setEndDate(selectedDate);
      
    }catch(e){
      alert('Failed: '+e.message);
    } finally {
      setSubmitting(false);
    }
  };

  return(
    <div className="space-y-6">
      <h2 className="text-3xl font-bold">My Attendance</h2>

      {/* Leave Balance Cards */}
      <div className="grid md:grid-cols-3 gap-4">
        <div className="bg-white p-4 rounded-xl shadow-lg border-l-4 border-blue-500">
          <div className="flex justify-between items-center">
            <div>
              <p className="text-sm text-gray-600">Entitled Leave</p>
              <p className="text-2xl font-bold text-blue-600">{leaveBalance.entitled.remaining}/{leaveBalance.entitled.total}</p>
            </div>
            <div className="text-right">
              <span className="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded-full">
                Used: {leaveBalance.entitled.used}
              </span>
            </div>
          </div>
          <div className="mt-2 bg-gray-200 rounded-full h-2">
            <div 
              className="bg-blue-500 h-2 rounded-full transition-all" 
              style={{width: `${(leaveBalance.entitled.remaining/leaveBalance.entitled.total)*100}%`}}
            />
          </div>
        </div>
        
        <div className="bg-white p-4 rounded-xl shadow-lg border-l-4 border-pink-500">
          <div className="flex justify-between items-center">
            <div>
              <p className="text-sm text-gray-600">Maternity Leave</p>
              <p className="text-2xl font-bold text-pink-600">{leaveBalance.maternity.remaining}/{leaveBalance.maternity.total}</p>
            </div>
            <div className="text-right">
              <span className="text-xs bg-pink-100 text-pink-700 px-2 py-1 rounded-full">
                Used: {leaveBalance.maternity.used}
              </span>
            </div>
          </div>
          <div className="mt-2 bg-gray-200 rounded-full h-2">
            <div 
              className="bg-pink-500 h-2 rounded-full transition-all" 
              style={{width: `${(leaveBalance.maternity.remaining/leaveBalance.maternity.total)*100}%`}}
            />
          </div>
        </div>
        
        <div className="bg-white p-4 rounded-xl shadow-lg border-l-4 border-purple-500">
          <div className="flex justify-between items-center">
            <div>
              <p className="text-sm text-gray-600">Paternity Leave</p>
              <p className="text-2xl font-bold text-purple-600">{leaveBalance.paternity.remaining}/{leaveBalance.paternity.total}</p>
            </div>
            <div className="text-right">
              <span className="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded-full">
                Used: {leaveBalance.paternity.used}
              </span>
            </div>
          </div>
          <div className="mt-2 bg-gray-200 rounded-full h-2">
            <div 
              className="bg-purple-500 h-2 rounded-full transition-all" 
              style={{width: `${(leaveBalance.paternity.remaining/leaveBalance.paternity.total)*100}%`}}
            />
          </div>
        </div>
      </div>

      <div className="bg-white p-6 rounded-2xl shadow-lg max-w-2xl mx-auto">
        <div className="space-y-4">
          <div>
            <label className="block text-sm font-bold mb-2">Status *</label>
            <div className="flex gap-3">
              <button 
                onClick={()=>{setStatus('Present');setReason('Present')}}
                className={`flex-1 py-3 rounded-xl font-semibold ${status==='Present'?'bg-green-500 text-white':'bg-gray-200'}`}
              >
                ‚úì Present
              </button>
              <button 
                onClick={()=>setStatus('On Leave')}
                className={`flex-1 py-3 rounded-xl font-semibold ${status==='On Leave'?'bg-orange-500 text-white':'bg-gray-200'}`}
              >
                üìÖ On Leave
              </button>
            </div>
          </div>

          {status==='On Leave'&&(
            <>
              <div>
                <label className="block text-sm font-bold mb-2">Reason *</label>
                <select value={reason} onChange={e=>setReason(e.target.value)} className="w-full border-2 px-4 py-3 rounded-xl">
                  {LEAVE_REASONS.filter(r=>r!=='Present').map(r=><option key={r} value={r}>{r}</option>)}
                </select>
              </div>
              
              {/* Date Range Toggle */}
              <div className="bg-blue-50 p-4 rounded-xl border-2 border-blue-200">
                <label className="flex items-center gap-3 cursor-pointer">
                  <input 
                    type="checkbox" 
                    checked={isDateRange}
                    onChange={e => {
                      setIsDateRange(e.target.checked);
                      if (!e.target.checked) {
                        setEndDate(selectedDate);
                      }
                    }}
                    className="w-5 h-5 rounded"
                  />
                  <span className="font-semibold text-blue-800">Apply leave for multiple days</span>
                </label>
                <p className="text-sm text-blue-600 mt-1 ml-8">Enable this if you're taking 2 or more days of leave</p>
              </div>
            </>
          )}

          <div className={`grid ${isDateRange && status === 'On Leave' ? 'md:grid-cols-2' : 'grid-cols-1'} gap-4`}>
            <div>
              <label className="block text-sm font-bold mb-2">
                {isDateRange && status === 'On Leave' ? 'Start Date' : 'Date'}
              </label>
              <input 
                type="date" 
                value={selectedDate} 
                min={minDate}
                max={maxDate}
                onChange={e => {
                  setSelectedDate(e.target.value);
                  if (!isDateRange || e.target.value > endDate) {
                    setEndDate(e.target.value);
                  }
                }} 
                className="w-full border-2 px-4 py-3 rounded-xl"
              />
              <p className="text-xs text-gray-500 mt-1">üìÖ You can mark attendance for today and previous 2 days only</p>
            </div>
            
            {isDateRange && status === 'On Leave' && (
              <div>
                <label className="block text-sm font-bold mb-2">End Date</label>
                <input 
                  type="date" 
                  value={endDate} 
                  min={selectedDate}
                  max={maxDate}
                  onChange={e => setEndDate(e.target.value)} 
                  className="w-full border-2 px-4 py-3 rounded-xl"
                />
              </div>
            )}
          </div>

          {isDateRange && status === 'On Leave' && daysToMark > 0 && (
            <div className="bg-yellow-50 p-4 rounded-xl border-2 border-yellow-300">
              <p className="font-semibold text-yellow-800">
                üìÖ {daysToMark} day{daysToMark > 1 ? 's' : ''} will be marked as {reason}
              </p>
              <p className="text-sm text-yellow-700 mt-1">
                From {selectedDate} to {endDate}
              </p>
            </div>
          )}

          {status === 'Present' && (
            <div>
              <label className="block text-sm font-bold mb-2">
                üìç GPS Location <span className="text-red-500">*</span>
                {gpsVerified && <span className="text-green-600 text-xs ml-2">‚úì Verified</span>}
              </label>
              
              {/* ‚úÖ FIX: GPS requirement notice */}
              <div className="bg-blue-50 p-3 rounded-xl border-2 border-blue-200 mb-3">
                <p className="text-sm text-blue-800 font-semibold">üìç GPS verification is mandatory</p>
                <p className="text-xs text-blue-600 mt-1">You must fetch your GPS location to mark attendance. Manual entry is not allowed.</p>
              </div>
              
              <div className="flex gap-2">
                {/* ‚úÖ FIX: Location field is now read-only */}
                <input 
                  type="text" 
                  value={location} 
                  readOnly
                  className="flex-1 border-2 px-4 py-3 rounded-xl bg-gray-100 cursor-not-allowed" 
                  placeholder="Click 'Get GPS Location' button ‚Üí"
                />
                <button 
                  onClick={getLocation} 
                  disabled={fetchingLocation || gpsVerified} 
                  className={`px-6 py-3 rounded-xl font-semibold disabled:opacity-50 transition-all ${
                    gpsVerified 
                      ? 'bg-green-600 text-white' 
                      : 'bg-blue-600 text-white hover:bg-blue-700'
                  }`}
                >
                  {fetchingLocation ? 'üìç Fetching...' : gpsVerified ? '‚úì GPS Verified' : 'üìç Get GPS Location'}
                </button>
              </div>
              
              {location && gpsVerified && (
                <div className="mt-2 p-2 bg-green-50 rounded-lg border border-green-200">
                  <p className="text-sm text-green-700">‚úì Location captured: {location}</p>
                </div>
              )}
              
              {!gpsVerified && (
                <p className="text-xs text-red-500 mt-2">‚ö†Ô∏è Please click "Get GPS Location" to verify your location before submitting</p>
              )}
            </div>
          )}

          {/* ‚úÖ FIX: Show warning if attendance already exists */}
          {hasExistingAttendance && (
            <div className="bg-amber-50 p-4 rounded-xl border-2 border-amber-300">
              <p className="font-semibold text-amber-800">üîí Attendance already marked for {selectedDate}</p>
              <p className="text-sm text-amber-700 mt-1">Once attendance is submitted, it cannot be modified. Please contact your admin if you need to make changes.</p>
            </div>
          )}

          <button 
            onClick={handleSubmit} 
            disabled={submitting || hasExistingAttendance || (status === 'Present' && !gpsVerified)}
            className={`w-full py-4 rounded-xl font-bold text-lg disabled:opacity-50 disabled:cursor-not-allowed transition-all ${
              hasExistingAttendance 
                ? 'bg-gray-400 text-white' 
                : (status === 'Present' && !gpsVerified)
                  ? 'bg-red-400 text-white'
                  : 'avanti-gradient text-white'
            }`}
          >
            {submitting 
              ? 'Submitting...' 
              : hasExistingAttendance 
                ? 'üîí Already Marked (No Changes Allowed)' 
                : (status === 'Present' && !gpsVerified)
                  ? 'üìç GPS Verification Required'
                  : (isDateRange && status === 'On Leave' 
                    ? `Submit Leave (${daysToMark} days)` 
                    : 'Submit Attendance')}
          </button>

          {todayRecord&&(
            <div className="mt-6 p-4 bg-green-50 border-2 border-green-200 rounded-xl">
              <h4 className="font-bold text-green-800 mb-2">‚úì Already Marked for {selectedDate}</h4>
              <p><strong>Status:</strong> {todayRecord.status}</p>
              <p><strong>Reason:</strong> {todayRecord.reason}</p>
              <p><strong>Punch-in Time:</strong> ‚è∞ {todayRecord.punchInTime||'Not recorded'}</p>
              <p><strong>Location:</strong> {todayRecord.location}</p>
              {todayRecord.gpsVerified && <p className="text-xs text-green-600 mt-1">‚úì GPS Verified</p>}
            </div>
          )}
        </div>
      </div>
    </div>
  );
}

// ========================================
// ADMIN ATTENDANCE ANALYTICS
// ========================================
function AdminAttendanceAnalytics({students,teachers,studentAttendance,teacherAttendance,accessibleSchools=[],isSuperAdmin=false,isDirector=false}){
  // ‚úÖ FIX: Directors get full data access like Super Admin
  const hasFullDataAccess = isSuperAdmin || isDirector;
  
  // Use accessible schools for dropdown
  const schoolOptions = hasFullDataAccess ? SCHOOLS : accessibleSchools;
  
  // ‚úÖ FIX: Case-insensitive school matching helper
  const schoolMatchesFilter = (itemSchool, selectedSchools) => {
    if (!selectedSchools || selectedSchools.length === 0) return true;
    if (!itemSchool) return false;
    const itemSchoolLower = itemSchool.toString().toLowerCase().trim();
    return selectedSchools.some(s => s && s.toString().toLowerCase().trim() === itemSchoolLower);
  };
  
  // Multi-select: Initialize with all schools selected
  const[filterSchools,setFilterSchools]=useState([...schoolOptions]);
  const[filterGrade,setFilterGrade]=useState('All');
  const[startDate,setStartDate]=useState(getTodayDate().slice(0,7)+'-01');
  const[endDate,setEndDate]=useState(getTodayDate());
  const[selectedDate,setSelectedDate]=useState(getTodayDate());
  
  // Lock Management State
  const[attendanceLocks,setAttendanceLocks]=useState([]);
  const[loadingLocks,setLoadingLocks]=useState(false);
  const[showLockManagement,setShowLockManagement]=useState(false);
  const[lockFilterSchool,setLockFilterSchool]=useState('All');
  const[lockFilterDate,setLockFilterDate]=useState(getTodayDate());

  const chart1Ref=useRef(null);
  const chart2Ref=useRef(null);
  const chart3Ref=useRef(null);
  const chart4Ref=useRef(null);

  const chartInstances=useRef({});
  
  // Load attendance locks
  const loadAttendanceLocks=async()=>{
    setLoadingLocks(true);
    try{
      let query = db.collection('attendanceLocks').orderBy('lockedAt', 'desc').limit(100);
      const snapshot = await query.get();
      const locks = snapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data()
      }));
      setAttendanceLocks(locks);
    }catch(e){
      console.error('Error loading locks:', e);
    }
    setLoadingLocks(false);
  };
  
  // Load locks when component mounts or when lock management is opened
  useEffect(()=>{
    if(showLockManagement){
      loadAttendanceLocks();
    }
  },[showLockManagement]);
  
  // Unlock attendance
  const handleUnlock=async(lockId, school, grade, date)=>{
    const confirmation = confirm(`Are you sure you want to unlock attendance for:\n\nSchool: ${school}\nClass: ${grade}\nDate: ${date}\n\nTeachers will be able to modify attendance again.`);
    
    if(!confirmation)return;
    
    try{
      await db.collection('attendanceLocks').doc(lockId).delete();
      alert('‚úÖ Attendance unlocked successfully!');
      loadAttendanceLocks();
    }catch(e){
      alert('Failed to unlock: '+e.message);
    }
  };
  
  // Filter locks for display
  const filteredLocks = attendanceLocks.filter(lock => {
    if(lockFilterSchool !== 'All' && lock.school?.toLowerCase() !== lockFilterSchool?.toLowerCase()) return false;
    if(lockFilterDate && lock.date !== lockFilterDate) return false;
    // Also filter by accessible schools for non-super admins (Directors see all)
    if(!hasFullDataAccess && !schoolMatchesFilter(lock.school, accessibleSchools)) return false;
    return true;
  });

  const filteredStudentAttendance=useMemo(()=>{
    return studentAttendance.filter(a=>{
      if(!schoolMatchesFilter(a.school, filterSchools))return false;
      if(filterGrade!=='All'&&a.grade!==filterGrade)return false;
      if(a.date<startDate||a.date>endDate)return false;
      return true;
    });
  },[studentAttendance,filterSchools,filterGrade,startDate,endDate]);

  const filteredTeacherAttendance=useMemo(()=>{
    return teacherAttendance.filter(a=>{
      if(!schoolMatchesFilter(a.school, filterSchools))return false;
      if(a.date<startDate||a.date>endDate)return false;
      return true;
    });
  },[teacherAttendance,filterSchools,startDate,endDate]);

  const todayStats=useMemo(()=>{
  const studentRecords=studentAttendance.filter(a=>{
    if(a.date!==selectedDate)return false;
    if(!schoolMatchesFilter(a.school, filterSchools))return false;
    if(filterGrade!=='All'&&a.grade!==filterGrade)return false;
    return true;
  });
  const teacherRecords=teacherAttendance.filter(a=>{
    if(a.date!==selectedDate)return false;
    if(!schoolMatchesFilter(a.school, filterSchools))return false;
    return true;
  });
  return{
    studentPresent:studentRecords.filter(r=>r.status==='Present').length,
    studentAbsent:studentRecords.filter(r=>r.status==='Absent').length,
    teacherPresent:teacherRecords.filter(r=>r.status==='Present').length,
    teacherAbsent:teacherRecords.filter(r=>r.status==='On Leave').length
  };
},[studentAttendance,teacherAttendance,selectedDate,filterSchools,filterGrade]);

  const genderStats=useMemo(()=>{
    const stats={Male:{present:0,absent:0},Female:{present:0,absent:0},Other:{present:0,absent:0}};
    filteredStudentAttendance.forEach(a=>{
      const student=students.find(s=>s.id===a.studentId);
      if(student&&stats[student.gender]){
        if(a.status==='Present'){
          stats[student.gender].present++;
        }else{
          stats[student.gender].absent++;
        }
      }
    });
    return stats;
  },[filteredStudentAttendance,students]);

  const monthlyDayStats=useMemo(()=>{
    const stats={};
    filteredStudentAttendance.forEach(a=>{
      if(!stats[a.date]){
        stats[a.date]={present:0,absent:0};
      }
      if(a.status==='Present'){
        stats[a.date].present++;
      }else{
        stats[a.date].absent++;
      }
    });
    return stats;
  },[filteredStudentAttendance]);

  useEffect(()=>{
    Object.values(chartInstances.current).forEach(chart=>{
      if(chart)chart.destroy();
    });
    chartInstances.current={};

    // Chart 1: Daily Student Attendance (Line)
    if(chart1Ref.current){
      const ctx=chart1Ref.current.getContext('2d');
      const dates=Object.keys(monthlyDayStats).sort();
      chartInstances.current.chart1=new Chart(ctx,{
        type:'line',
        data:{
          labels:dates.map(d=>new Date(d).getDate()),
          datasets:[
            {
              label:'Present',
              data:dates.map(d=>monthlyDayStats[d].present),
              borderColor:'#10B981',
              backgroundColor:'rgba(16,185,129,0.1)',
              tension:0.4,
              fill:true
            },
            {
              label:'Absent',
              data:dates.map(d=>monthlyDayStats[d].absent),
              borderColor:'#EF4444',
              backgroundColor:'rgba(239,68,68,0.1)',
              tension:0.4,
              fill:true
            }
          ]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            title:{display:true,text:'Daily Student Attendance (Month)',font:{size:16,weight:'bold'}},
            legend:{position:'bottom'}
          },
          scales:{
            y:{beginAtZero:true}
          }
        }
      });
    }

    // Chart 2: Gender-wise Attendance (Bar)
    if(chart2Ref.current){
      const ctx=chart2Ref.current.getContext('2d');
      const genders=Object.keys(genderStats);
      chartInstances.current.chart2=new Chart(ctx,{
        type:'bar',
        data:{
          labels:genders,
          datasets:[
            {
              label:'Present',
              data:genders.map(g=>genderStats[g].present),
              backgroundColor:'#10B981'
            },
            {
              label:'Absent',
              data:genders.map(g=>genderStats[g].absent),
              backgroundColor:'#EF4444'
            }
          ]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            title:{display:true,text:'Gender-wise Student Attendance',font:{size:16,weight:'bold'}},
            legend:{position:'bottom'}
          },
          scales:{
            y:{beginAtZero:true}
          }
        }
      });
    }

    // Chart 3: Teacher Attendance Status (Pie)
    if(chart3Ref.current){
      const ctx=chart3Ref.current.getContext('2d');
      const present=filteredTeacherAttendance.filter(a=>a.status==='Present').length;
      const onLeave=filteredTeacherAttendance.filter(a=>a.status==='On Leave').length;
      chartInstances.current.chart3=new Chart(ctx,{
        type:'pie',
        data:{
          labels:['Present','On Leave'],
          datasets:[{
            data:[present,onLeave],
            backgroundColor:['#5B8A8A','#D4A574'],
            borderWidth:2,
            borderColor:'#fff'
          }]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            title:{display:true,text:'Teacher Attendance Status (Month)',font:{size:16,weight:'bold'}},
            legend:{position:'bottom'}
          }
        }
      });
    }

    // Chart 4: Overall Student Attendance (Doughnut)
    if(chart4Ref.current){
      const ctx=chart4Ref.current.getContext('2d');
      const present=filteredStudentAttendance.filter(a=>a.status==='Present').length;
      const absent=filteredStudentAttendance.filter(a=>a.status==='Absent').length;
      chartInstances.current.chart4=new Chart(ctx,{
        type:'doughnut',
        data:{
          labels:['Present','Absent'],
          datasets:[{
            data:[present,absent],
            backgroundColor:['#5B8A8A','#C17A6E'],
            borderWidth:2,
            borderColor:'#fff'
          }]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            title:{display:true,text:'Overall Student Attendance (Month)',font:{size:16,weight:'bold'}},
            legend:{position:'bottom'}
          }
        }
      });
    }
    
    return()=>{
      Object.values(chartInstances.current).forEach(chart=>{
        if(chart)chart.destroy();
      });
    };
  },[monthlyDayStats,genderStats,filteredTeacherAttendance,filteredStudentAttendance]);

  const handleExportStudents=()=>{
    const exportData=filteredStudentAttendance.map(a=>({
      Date:a.date,
      School:a.school,
      Grade:a.grade,
      'Student Name':a.studentName,
      Status:a.status,
      Remarks:a.remarks||'',
      'Marked By':a.markedBy
    }));
    exportToExcel(exportData,`student_attendance_${startDate}_to_${endDate}`);
  };

  const handleExportTeachers=()=>{
    const exportData=filteredTeacherAttendance.map(a=>({
      Date:a.date,
      'Teacher Name':a.teacherName,
      School:a.school,
      'Punch-In Time':a.punchInTime||'Not recorded',
      Status:a.status,
      Reason:a.reason,
      Location:a.location
    }));
    exportToExcel(exportData,`teacher_attendance_${startDate}_to_${endDate}`);
  };

  return(
    <div className="space-y-6">
      <div className="flex justify-between items-center flex-wrap gap-4">
        <h2 className="text-3xl font-bold">üìä Attendance Analytics</h2>
        <div className="flex gap-2 flex-wrap">
          <button 
            onClick={()=>setShowLockManagement(!showLockManagement)} 
            className={`px-4 py-2 rounded-xl font-semibold ${showLockManagement ? 'bg-yellow-600 text-white' : 'bg-yellow-100 text-yellow-800 border-2 border-yellow-400'}`}
          >
            üîê Manage Locks
          </button>
          <button onClick={handleExportStudents} className="px-4 py-2 bg-green-600 text-white rounded-xl font-semibold">
            üì• Export Students
          </button>
          <button onClick={handleExportTeachers} className="px-4 py-2 bg-blue-600 text-white rounded-xl font-semibold">
            üì• Export Teachers
          </button>
        </div>
      </div>

      {/* ‚úÖ ATTENDANCE LOCK MANAGEMENT SECTION */}
      {showLockManagement && (
        <div className="bg-white p-6 rounded-2xl shadow-lg border-2 border-yellow-300">
          <div className="flex justify-between items-center mb-4">
            <h3 className="text-xl font-bold flex items-center gap-2">
              üîê Attendance Lock Management
            </h3>
            <button 
              onClick={loadAttendanceLocks}
              disabled={loadingLocks}
              className="px-4 py-2 bg-gray-200 rounded-lg font-semibold"
            >
              {loadingLocks ? '‚è≥ Loading...' : 'üîÑ Refresh'}
            </button>
          </div>
          
          <p className="text-sm text-gray-600 mb-4">
            View and manage attendance locks. When attendance is locked, teachers cannot modify it. 
            Use this section to unlock attendance when needed.
          </p>
          
          {/* Lock Filters */}
          <div className="grid md:grid-cols-3 gap-4 mb-4">
            <div>
              <label className="block text-sm font-bold mb-2">Filter by School</label>
              <select 
                value={lockFilterSchool} 
                onChange={e=>setLockFilterSchool(e.target.value)}
                className="w-full border-2 px-4 py-3 rounded-xl"
              >
                <option value="All">All Schools</option>
                {schoolOptions.map(s=><option key={s} value={s}>{s}</option>)}
              </select>
            </div>
            <div>
              <label className="block text-sm font-bold mb-2">Filter by Date</label>
              <input 
                type="date" 
                value={lockFilterDate} 
                onChange={e=>setLockFilterDate(e.target.value)}
                className="w-full border-2 px-4 py-3 rounded-xl"
              />
            </div>
            <div className="flex items-end">
              <button 
                onClick={()=>setLockFilterDate('')}
                className="w-full px-4 py-3 bg-gray-200 rounded-xl font-semibold"
              >
                Show All Dates
              </button>
            </div>
          </div>
          
          {/* Locks Table */}
          {loadingLocks ? (
            <div className="text-center py-8">
              <div className="animate-spin text-4xl mb-2">‚è≥</div>
              <p>Loading attendance locks...</p>
            </div>
          ) : filteredLocks.length === 0 ? (
            <div className="text-center py-8 text-gray-500">
              <div className="text-4xl mb-2">üîì</div>
              <p>No attendance locks found for the selected filters.</p>
            </div>
          ) : (
            <div className="overflow-x-auto">
              <table className="w-full">
                <thead className="bg-yellow-100">
                  <tr>
                    <th className="p-3 text-left">School</th>
                    <th className="p-3 text-left">Grade</th>
                    <th className="p-3 text-left">Date</th>
                    <th className="p-3 text-left">Locked By</th>
                    <th className="p-3 text-left">Locked At</th>
                    <th className="p-3 text-left">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {filteredLocks.map(lock => (
                    <tr key={lock.id} className="border-b hover:bg-gray-50">
                      <td className="p-3">{lock.school}</td>
                      <td className="p-3">
                        <span className="px-2 py-1 bg-blue-100 text-blue-800 rounded font-semibold">
                          Class {lock.grade}
                        </span>
                      </td>
                      <td className="p-3 font-mono">{lock.date}</td>
                      <td className="p-3">{lock.lockedByName || lock.lockedBy}</td>
                      <td className="p-3 text-sm">
                        {lock.lockedAt ? new Date(lock.lockedAt).toLocaleString() : 'Unknown'}
                      </td>
                      <td className="p-3">
                        <button 
                          onClick={()=>handleUnlock(lock.id, lock.school, lock.grade, lock.date)}
                          className="px-4 py-2 bg-red-500 text-white rounded-lg font-semibold hover:bg-red-600"
                        >
                          üîì Unlock
                        </button>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
              <div className="mt-4 text-sm text-gray-500">
                Showing {filteredLocks.length} lock(s)
              </div>
            </div>
          )}
        </div>
      )}

      <div className="bg-white p-6 rounded-2xl shadow-lg">
        <h3 className="text-xl font-bold mb-4">üîç Filters</h3>
        <div className="grid md:grid-cols-5 gap-4">
          <div>
            <label className="block text-sm font-bold mb-2">Schools ({filterSchools.length}/{schoolOptions.length})</label>
            <MultiSelectDropdown
              options={schoolOptions}
              selected={filterSchools}
              onChange={setFilterSchools}
              placeholder="Select Schools..."
            />
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">Grade</label>
            <select value={filterGrade} onChange={e=>setFilterGrade(e.target.value)} className="w-full border-2 px-4 py-3 rounded-xl">
              <option value="All">All Grades</option>
              <option value="11">Class 11</option>
              <option value="12">Class 12</option>
            </select>
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">Start Date</label>
            <input type="date" value={startDate} onChange={e=>setStartDate(e.target.value)} className="w-full border-2 px-4 py-3 rounded-xl"/>
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">End Date</label>
            <input type="date" value={endDate} onChange={e=>setEndDate(e.target.value)} className="w-full border-2 px-4 py-3 rounded-xl"/>
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">Today's View</label>
            <input type="date" value={selectedDate} onChange={e=>setSelectedDate(e.target.value)} className="w-full border-2 px-4 py-3 rounded-xl"/>
          </div>
        </div>
      </div>

      <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div className="stat-card bg-green-500 text-white">
          <div className="text-sm opacity-90">Students Present Today</div>
          <div className="text-4xl font-bold">{todayStats.studentPresent}</div>
        </div>
        <div className="stat-card bg-red-500 text-white">
          <div className="text-sm opacity-90">Students Absent Today</div>
          <div className="text-4xl font-bold">{todayStats.studentAbsent}</div>
        </div>
        <div className="stat-card bg-blue-500 text-white">
          <div className="text-sm opacity-90">Teachers Present Today</div>
          <div className="text-4xl font-bold">{todayStats.teacherPresent}</div>
        </div>
        <div className="stat-card bg-orange-500 text-white">
          <div className="text-sm opacity-90">Teachers on Leave Today</div>
          <div className="text-4xl font-bold">{todayStats.teacherAbsent}</div>
        </div>
      </div>

      <div className="grid md:grid-cols-2 gap-6">
        <div className="bg-white p-6 rounded-2xl shadow-lg" style={{height:'350px'}}>
          <canvas ref={chart1Ref}></canvas>
        </div>
        <div className="bg-white p-6 rounded-2xl shadow-lg" style={{height:'350px'}}>
          <canvas ref={chart2Ref}></canvas>
        </div>
        <div className="bg-white p-6 rounded-2xl shadow-lg" style={{height:'350px'}}>
          <canvas ref={chart3Ref}></canvas>
        </div>
        <div className="bg-white p-6 rounded-2xl shadow-lg" style={{height:'350px'}}>
          <canvas ref={chart4Ref}></canvas>
        </div>
      </div>

      <div className="bg-white p-6 rounded-2xl shadow-lg">
        <h3 className="text-xl font-bold mb-4">üìã Detailed Teacher Attendance</h3>
        <div className="overflow-x-auto">
          <table className="w-full">
            <thead className="avanti-gradient-light">
                <tr>
                  <th className="p-3 text-left">Date</th>
                  <th className="p-3 text-left">Teacher</th>
                  <th className="p-3 text-left">School</th>
                  <th className="p-3 text-left">Punch-In Time</th>
                  <th className="p-3 text-left">Status</th>
                  <th className="p-3 text-left">Reason</th>
                  <th className="p-3 text-left">Location</th>
                </tr>
              </thead>
            <tbody>
              {filteredTeacherAttendance.length===0?
                <tr><td colSpan="7" className="p-8 text-center text-gray-500">No records found</td></tr>
              :
                filteredTeacherAttendance.slice(0,50).map((a,idx)=>
                  <tr key={idx} className="border-b hover:bg-gray-50">
                    <td className="p-3 text-sm">{a.date}</td>
                    <td className="p-3 font-semibold">{a.teacherName}</td>
                    <td className="p-3">{a.school}</td>
                    <td className="p-3">
                      <span className="font-mono font-bold text-blue-600 text-lg">
                        ‚è∞ {a.punchInTime||'--:--'}
                      </span>
                    </td>
                    <td className="p-3">
                      <span className={`px-2 py-1 rounded-full text-xs font-bold ${a.status==='Present'?'bg-green-100 text-green-700':'bg-orange-100 text-orange-700'}`}>
                        {a.status}
                      </span>
                    </td>
                    <td className="p-3 text-sm">{a.reason}</td>
                    <td className="p-3 text-sm">üìç {a.location}</td>
                  </tr>
                )
              }
            </tbody>
          </table>
        </div>
      </div>
    </div>
  );
}
// ========================================
// SCHOOL INFO VIEW (FOR TEACHERS)
// ========================================
function SchoolInfoView({currentUser,schoolInfo,setSchoolInfo}){
  const mySchool=currentUser.school;
  const existingInfo=schoolInfo.find(info=>info.school===mySchool);
  const[isEditing,setIsEditing]=useState(false);
  const[isSaving,setIsSaving]=useState(false);
  
  const[formData,setFormData]=useState({
    // Principal Info
    principalName:'',
    principalPhone:'',
    principalEmail:'',
    // Vice Principal Info
    vicePrincipalName:'',
    vicePrincipalPhone:'',
    vicePrincipalEmail:'',
    // Avanti Coordinator
    coordinatorName:'',
    coordinatorPhone:'',
    coordinatorEmail:'',
    // WiFi Info
    wifiInClassroom:'No',
    wifiInstalledBy:'',
    wifiWorking:'No',
    wifiMonthlyBill:'',
    wifiConnectionType:'',
    wifiNetworkName:'',
    bothClassesWifi:'No',
    // Modules - Class 11
    modules11Received:'',
    modules11Distributed:'',
    modules11Stock:'',
    modules11Remarks:'',
    // Modules - Class 12
    modules12Received:'',
    modules12Distributed:'',
    modules12Stock:'',
    modules12Remarks:'',
    // Reference Books
    referenceBooks:[],
    // Chromebooks - Class 11
    chromebooks11Distributed:'No',
    chromebooks11Count:'',
    chromebooks11Working:'',
    chromebooks11Brand:'',
    chromebooks11DistributedDate:'',
    chromebooks11TestMethod:'',
    chromebooks11JNVLabAccess:'',
    chromebooks11JNVCount:'',
    // Chromebooks - Class 12
    chromebooks12Distributed:'No',
    chromebooks12Count:'',
    chromebooks12Working:'',
    chromebooks12Brand:'',
    chromebooks12DistributedDate:'',
    chromebooks12TestMethod:'',
    chromebooks12JNVLabAccess:'',
    chromebooks12JNVCount:'',
    // Printer
    printerAvailable:'No',
    printerWorking:'No',
    printerBrand:'',
    printerIssuedDate:'',
    // Other Assets
    otherAssets:[],
    // Meeting Minutes
    meetingMinutes:[]
  });

  // ‚úÖ FIX: Properly merge existing data with defaults to prevent undefined errors
  useEffect(()=>{
    if(existingInfo){
      // Merge existing data with default values to handle missing fields
      setFormData(prev => ({
        ...prev,  // Keep default values
        ...existingInfo,  // Override with existing values
        // Ensure arrays are always arrays
        referenceBooks: existingInfo.referenceBooks || [],
        otherAssets: existingInfo.otherAssets || [],
        meetingMinutes: existingInfo.meetingMinutes || []
      }));
      setIsEditing(false);
    }else{
      setIsEditing(true);
    }
  },[existingInfo]);

  const handleAddBook=()=>{
    setFormData({
      ...formData,
      referenceBooks:[...formData.referenceBooks,{
        bookName:'',
        publisher:'',
        author:'',
        price:'',
        inStock:'',
        distributed:''
      }]
    });
  };

  const handleRemoveBook=(index)=>{
    const updated=[...formData.referenceBooks];
    updated.splice(index,1);
    setFormData({...formData,referenceBooks:updated});
  };

  const handleBookChange=(index,field,value)=>{
    const updated=[...formData.referenceBooks];
    updated[index][field]=value;
    setFormData({...formData,referenceBooks:updated});
  };

  const handleAddAsset=()=>{
    setFormData({
      ...formData,
      otherAssets:[...formData.otherAssets,{
        assetName:'',
        assetQuantity:'',
        assetCondition:'',
        assetNotes:''
      }]
    });
  };

  const handleRemoveAsset=(index)=>{
    const updated=[...formData.otherAssets];
    updated.splice(index,1);
    setFormData({...formData,otherAssets:updated});
  };

  const handleAssetChange=(index,field,value)=>{
    const updated=[...formData.otherAssets];
    updated[index][field]=value;
    setFormData({...formData,otherAssets:updated});
  };

  // Meeting Minutes handlers
  const handleAddMeeting=()=>{
    setFormData({
      ...formData,
      meetingMinutes:[{
        meetingDate:new Date().toISOString().split('T')[0],
        meetingTime:new Date().toLocaleTimeString('en-IN', {hour:'2-digit', minute:'2-digit', hour12:false}),
        attendees:'',
        discussedPoints:'',
        actionPoints:'',
        updatedBy:currentUser.name,
        updatedAt:new Date().toISOString()
      }, ...(formData.meetingMinutes || [])]
    });
  };

  const handleRemoveMeeting=(index)=>{
    const updated=[...(formData.meetingMinutes || [])];
    updated.splice(index,1);
    setFormData({...formData,meetingMinutes:updated});
  };

  const handleMeetingChange=(index,field,value)=>{
    const updated=[...(formData.meetingMinutes || [])];
    updated[index][field]=value;
    updated[index].updatedBy=currentUser.name;
    updated[index].updatedAt=new Date().toISOString();
    setFormData({...formData,meetingMinutes:updated});
  };

  const handleSubmit = async () => {
  // Validation for mandatory fields
  const requiredFields = [
    { field: 'principalName', label: 'Principal Name' },
    { field: 'principalPhone', label: 'Principal Phone Number' },
    { field: 'principalEmail', label: 'Principal Email ID' },
    { field: 'vicePrincipalName', label: 'Vice Principal Name' },
    { field: 'vicePrincipalPhone', label: 'Vice Principal Phone Number' },
    { field: 'vicePrincipalEmail', label: 'Vice Principal Email ID' },
    { field: 'coordinatorName', label: 'Avanti Coordinator Name' },
    { field: 'coordinatorPhone', label: 'Avanti Coordinator Phone Number' },
    { field: 'coordinatorEmail', label: 'Avanti Coordinator Email ID' }
  ];
  
  const missingFields = [];
  for (const { field, label } of requiredFields) {
    if (!formData[field] || formData[field].toString().trim() === '') {
      missingFields.push(label);
    }
  }
  
  // Validate phone numbers (10 digits)
  const phoneFields = [
    { field: 'principalPhone', label: 'Principal Phone' },
    { field: 'vicePrincipalPhone', label: 'Vice Principal Phone' },
    { field: 'coordinatorPhone', label: 'Coordinator Phone' }
  ];
  
  const invalidPhones = [];
  for (const { field, label } of phoneFields) {
    const phone = formData[field]?.toString().replace(/\D/g, '');
    if (phone && phone.length !== 10) {
      invalidPhones.push(label + ' (must be 10 digits)');
    }
  }
  
  // Validate email format
  const emailFields = [
    { field: 'principalEmail', label: 'Principal Email' },
    { field: 'vicePrincipalEmail', label: 'Vice Principal Email' },
    { field: 'coordinatorEmail', label: 'Coordinator Email' }
  ];
  
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  const invalidEmails = [];
  for (const { field, label } of emailFields) {
    if (formData[field] && !emailRegex.test(formData[field])) {
      invalidEmails.push(label + ' (invalid format)');
    }
  }
  
  // Show all validation errors
  let errorMessage = '';
  if (missingFields.length > 0) {
    errorMessage += '‚ùå Missing required fields:\n‚Ä¢ ' + missingFields.join('\n‚Ä¢ ') + '\n\n';
  }
  if (invalidPhones.length > 0) {
    errorMessage += '‚ùå Invalid phone numbers:\n‚Ä¢ ' + invalidPhones.join('\n‚Ä¢ ') + '\n\n';
  }
  if (invalidEmails.length > 0) {
    errorMessage += '‚ùå Invalid email addresses:\n‚Ä¢ ' + invalidEmails.join('\n‚Ä¢ ');
  }
  
  if (errorMessage) {
    alert(errorMessage);
    return;
  }
  
  setIsSaving(true);
  try {
    const docId = mySchool.replace(/\s+/g, '_');
    const now = new Date().toISOString();
    const userId = currentUser.afid || currentUser.id || currentUser.docId || currentUser.email;

    const historyEntry = {
      updatedBy: userId,
      updatedByName: currentUser.name,
      updatedAt: now
    };

    const dataToSave = {
      ...formData,
      school: mySchool,
      updatedBy: userId,
      updatedByName: currentUser.name,
      updatedAt: now
    };

    await db.collection('schoolInfo').doc(docId).set({
      ...dataToSave,
      updateHistory: firebase.firestore.FieldValue.arrayUnion(historyEntry)
    }, { merge: true });

    // ‚úÖ FIX: Update parent state with new data so form displays correctly
    const existingHistory = existingInfo?.updateHistory || [];
    const updatedInfo = {
      ...dataToSave,
      docId: docId,
      updateHistory: [...existingHistory, historyEntry]
    };
    
    setSchoolInfo(prev => {
      const idx = prev.findIndex(s => s.school === mySchool);
      if (idx >= 0) {
        const updated = [...prev];
        updated[idx] = updatedInfo;
        return updated;
      } else {
        return [...prev, updatedInfo];
      }
    });

    setIsEditing(false);
    setIsSaving(false);
    alert('‚úÖ School information saved successfully!');
  } catch (e) {
    console.error('Save error:', e);
    setIsSaving(false);
    alert('‚ùå Failed to save: ' + e.message);
  }
};


  // Generate month/year options
  const generateMonthYearOptions=()=>{
    const options=[];
    for(let year=2022;year<=2025;year++){
      for(let month=1;month<=12;month++){
        const monthName=new Date(year,month-1).toLocaleString('default',{month:'long'});
        options.push(`${monthName} ${year}`);
      }
    }
    return options;
  };

  return(
  <div className="space-y-6">
    <div className="flex justify-between items-center">
      <h2 className="text-3xl font-bold">üè´ School Information - {mySchool}</h2>
      {!isEditing && existingInfo && (
        <button onClick={()=>setIsEditing(true)} className="px-6 py-3 bg-blue-600 text-white rounded-xl font-semibold hover:bg-blue-700">
          ‚úèÔ∏è Edit Information
        </button>
      )}
      {isEditing && existingInfo && (
        <button onClick={()=>{setFormData({...existingInfo});setIsEditing(false);}} className="px-6 py-3 bg-gray-600 text-white rounded-xl font-semibold hover:bg-gray-700">
          ‚ùå Cancel
        </button>
      )}
    </div>

    {existingInfo && (
      <div className="bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded-xl text-sm">
        <div>
          Last updated:{' '}
          {existingInfo.updatedAt
            ? new Date(existingInfo.updatedAt).toLocaleString()
            : 'Not filled yet'}
          {existingInfo.updatedByName && (
            <> by <span className="font-semibold">{existingInfo.updatedByName}</span></>
          )}
        </div>

        {existingInfo.updateHistory && existingInfo.updateHistory.length > 0 && (
          <div className="mt-2">
            <div className="font-semibold mb-1">Edit History (Newest First)</div>
            <ul className="max-h-32 overflow-y-auto space-y-1">
              {existingInfo.updateHistory
                .slice()
                .sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt))
                .map((entry, idx) => (
                  <li key={idx}>
                    {new Date(entry.updatedAt).toLocaleString()} ‚Äî {entry.updatedByName || entry.updatedBy}
                  </li>
                ))}
            </ul>
          </div>
        )}
      </div>
    )}

    <div className="bg-white p-6 rounded-2xl shadow-lg space-y-6">

        
        {/* Principal Information */}
        <div className="border-4 border-blue-500 rounded-2xl p-6 bg-blue-50">
          <h3 className="text-2xl font-bold mb-4 text-blue-800">üë®‚Äçüíº Principal Information</h3>
          <div className="grid md:grid-cols-3 gap-4">
            <div>
              <label className="block text-sm font-bold mb-2">Principal Name *</label>
              <input type="text" value={formData.principalName} onChange={e=>setFormData({...formData,principalName:e.target.value})} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"/>
            </div>
            <div>
              <label className="block text-sm font-bold mb-2">Phone Number *</label>
              <input type="tel" value={formData.principalPhone} onChange={e=>setFormData({...formData,principalPhone:e.target.value})} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"/>
            </div>
            <div>
              <label className="block text-sm font-bold mb-2">Email ID *</label>
              <input type="email" value={formData.principalEmail} onChange={e=>setFormData({...formData,principalEmail:e.target.value})} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"/>
            </div>
          </div>
        </div>

        {/* Vice Principal Information */}
        <div className="border-4 border-green-500 rounded-2xl p-6 bg-green-50">
          <h3 className="text-2xl font-bold mb-4 text-green-800">üë®‚Äçüíº Vice Principal Information</h3>
          <div className="grid md:grid-cols-3 gap-4">
            <div>
              <label className="block text-sm font-bold mb-2">Vice Principal Name *</label>
              <input type="text" value={formData.vicePrincipalName} onChange={e=>setFormData({...formData,vicePrincipalName:e.target.value})} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"/>
            </div>
            <div>
              <label className="block text-sm font-bold mb-2">Phone Number *</label>
              <input type="tel" value={formData.vicePrincipalPhone} onChange={e=>setFormData({...formData,vicePrincipalPhone:e.target.value})} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"/>
            </div>
            <div>
              <label className="block text-sm font-bold mb-2">Email ID *</label>
              <input type="email" value={formData.vicePrincipalEmail} onChange={e=>setFormData({...formData,vicePrincipalEmail:e.target.value})} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"/>
            </div>
          </div>
        </div>

        {/* Avanti Coordinator Information */}
        <div className="border-4 border-orange-500 rounded-2xl p-6 bg-orange-50">
          <h3 className="text-2xl font-bold mb-4 text-orange-800">üë®‚Äçüíº Avanti Coordinator Information</h3>
          <div className="grid md:grid-cols-3 gap-4">
            <div>
              <label className="block text-sm font-bold mb-2">Coordinator Name *</label>
              <input type="text" value={formData.coordinatorName} onChange={e=>setFormData({...formData,coordinatorName:e.target.value})} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"/>
            </div>
            <div>
              <label className="block text-sm font-bold mb-2">Phone Number *</label>
              <input type="tel" value={formData.coordinatorPhone} onChange={e=>setFormData({...formData,coordinatorPhone:e.target.value})} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"/>
            </div>
            <div>
              <label className="block text-sm font-bold mb-2">Email ID *</label>
              <input type="email" value={formData.coordinatorEmail} onChange={e=>setFormData({...formData,coordinatorEmail:e.target.value})} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"/>
            </div>
          </div>
        </div>

        {/* WiFi Information */}
        <div className="border-4 border-purple-500 rounded-2xl p-6 bg-purple-50">
          <h3 className="text-2xl font-bold mb-4 text-purple-800">üì∂ WiFi Connection Details</h3>
          <div className="grid md:grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-bold mb-2">WiFi in Classroom? *</label>
              <select value={formData.wifiInClassroom} onChange={e=>setFormData({...formData,wifiInClassroom:e.target.value})} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed">
                <option value="No">No</option>
                <option value="Yes">Yes</option>
              </select>
            </div>
            {formData.wifiInClassroom==='Yes'&&(
              <>
                <div>
                  <label className="block text-sm font-bold mb-2">Installed By *</label>
                  <select value={formData.wifiInstalledBy} onChange={e=>setFormData({...formData,wifiInstalledBy:e.target.value})} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed">
                    <option value="">Select</option>
                    <option value="Avanti">Avanti</option>
                    <option value="JNV">JNV</option>
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-bold mb-2">Working Condition? *</label>
                  <select value={formData.wifiWorking} onChange={e=>setFormData({...formData,wifiWorking:e.target.value})} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed">
                    <option value="No">No</option>
                    <option value="Yes">Yes</option>
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-bold mb-2">Monthly Bill Amount *</label>
                  <input type="text" value={formData.wifiMonthlyBill} onChange={e=>setFormData({...formData,wifiMonthlyBill:e.target.value})} disabled={!isEditing} placeholder="‚Çπ Amount" className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"/>
                </div>
                <div>
                  <label className="block text-sm font-bold mb-2">Connection Type *</label>
                  <select value={formData.wifiConnectionType} onChange={e=>setFormData({...formData,wifiConnectionType:e.target.value})} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed">
                    <option value="">Select</option>
                    <option value="Postpaid">Postpaid</option>
                    <option value="Prepaid">Prepaid</option>
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-bold mb-2">Network Name *</label>
                  <select value={formData.wifiNetworkName} onChange={e=>setFormData({...formData,wifiNetworkName:e.target.value})} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed">
                    <option value="">Select</option>
                    <option value="Airtel">Airtel</option>
                    <option value="Jio">Jio</option>
                    <option value="Local">Local</option>
                    <option value="BSNL">BSNL</option>
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-bold mb-2">Both 11th & 12th have WiFi? *</label>
                  <select value={formData.bothClassesWifi} onChange={e=>setFormData({...formData,bothClassesWifi:e.target.value})} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed">
                    <option value="No">No</option>
                    <option value="Yes">Yes</option>
                  </select>
                </div>
              </>
            )}
          </div>
        </div>

        {/* Modules - Class 11 */}
        <div className="border-4 border-green-500 rounded-2xl p-6 bg-green-50">
          <h3 className="text-2xl font-bold mb-4 text-green-800">üìö Modules - Class 11th</h3>
          <div className="grid md:grid-cols-3 gap-4">
            <div>
              <label className="block text-sm font-bold mb-2">Modules Received (AY 2025-26) *</label>
              <input type="number" min="0" value={formData.modules11Received} onChange={e=>setFormData({...formData,modules11Received:e.target.value})} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed" placeholder="Enter number only"/>
            </div>
            <div>
              <label className="block text-sm font-bold mb-2">Modules Distributed to 11th *</label>
              <input type="number" min="0" value={formData.modules11Distributed} onChange={e=>setFormData({...formData,modules11Distributed:e.target.value})} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed" placeholder="Enter number only"/>
            </div>
            <div>
              <label className="block text-sm font-bold mb-2">Modules in Stock (11th) *</label>
              <input type="number" min="0" value={formData.modules11Stock} onChange={e=>setFormData({...formData,modules11Stock:e.target.value})} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed" placeholder="Enter number only"/>
            </div>
          </div>
          <div className="mt-4">
            <label className="block text-sm font-bold mb-2">üìù Remarks for Class 11th Modules</label>
            <textarea value={formData.modules11Remarks||''} onChange={e=>setFormData({...formData,modules11Remarks:e.target.value})} disabled={!isEditing} placeholder="Add any remarks about 11th class modules here..." className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed" rows="2"/>
          </div>
        </div>

        {/* Modules - Class 12 */}
        <div className="border-4 border-blue-500 rounded-2xl p-6 bg-blue-50">
          <h3 className="text-2xl font-bold mb-4 text-blue-800">üìö Modules - Class 12th</h3>
          <div className="grid md:grid-cols-3 gap-4">
            <div>
              <label className="block text-sm font-bold mb-2">Modules Received (AY 2025-26) *</label>
              <input type="number" min="0" value={formData.modules12Received} onChange={e=>setFormData({...formData,modules12Received:e.target.value})} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed" placeholder="Enter number only"/>
            </div>
            <div>
              <label className="block text-sm font-bold mb-2">Modules Distributed to 12th *</label>
              <input type="number" min="0" value={formData.modules12Distributed} onChange={e=>setFormData({...formData,modules12Distributed:e.target.value})} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed" placeholder="Enter number only"/>
            </div>
            <div>
              <label className="block text-sm font-bold mb-2">Modules in Stock (12th) *</label>
              <input type="number" min="0" value={formData.modules12Stock} onChange={e=>setFormData({...formData,modules12Stock:e.target.value})} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed" placeholder="Enter number only"/>
            </div>
          </div>
          <div className="mt-4">
            <label className="block text-sm font-bold mb-2">üìù Remarks for Class 12th Modules</label>
            <textarea value={formData.modules12Remarks||''} onChange={e=>setFormData({...formData,modules12Remarks:e.target.value})} disabled={!isEditing} placeholder="Add any remarks about 12th class modules here..." className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed" rows="2"/>
          </div>
        </div>

        {/* Reference Books */}
        <div className="border-4 border-yellow-500 rounded-2xl p-6 bg-yellow-50">
          <div className="flex justify-between items-center mb-4">
            <h3 className="text-2xl font-bold text-yellow-800">üìñ Other Reference Books (AY 2025-26)</h3>
            {isEditing && (
              <button onClick={handleAddBook} className="px-6 py-3 bg-yellow-600 text-white rounded-xl font-semibold">
                + Add Book
              </button>
            )}
          </div>
          {formData.referenceBooks.map((book,idx)=>
            <div key={idx} className="bg-white p-4 rounded-xl mb-4 border-2 border-yellow-300">
              <div className="flex justify-between items-center mb-3">
                <h4 className="font-bold text-lg">Book {idx+1}</h4>
                {isEditing && (
                    <button onClick={()=>handleRemoveBook(idx)} className="px-4 py-2 bg-red-500 text-white rounded-lg">
                      Remove
                    </button>
                  )}
              </div>
              <div className="grid md:grid-cols-3 gap-4">
                <div>
                  <label className="block text-sm font-bold mb-2">Book Name *</label>
                  <input type="text" value={book.bookName} onChange={e=>handleBookChange(idx,'bookName',e.target.value)} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"/>
                </div>
                <div>
                  <label className="block text-sm font-bold mb-2">Publisher Name *</label>
                  <input type="text" value={book.publisher} onChange={e=>handleBookChange(idx,'publisher',e.target.value)} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"/>
                </div>
                <div>
                  <label className="block text-sm font-bold mb-2">Author Name *</label>
                  <input type="text" value={book.author} onChange={e=>handleBookChange(idx,'author',e.target.value)} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"/>
                </div>
                <div>
                  <label className="block text-sm font-bold mb-2">Price *</label>
                  <input type="text" value={book.price} onChange={e=>handleBookChange(idx,'price',e.target.value)} placeholder="‚Çπ Amount" disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"/>
                </div>
                <div>
                  <label className="block text-sm font-bold mb-2">In Stock *</label>
                  <input type="number" value={book.inStock} onChange={e=>handleBookChange(idx,'inStock',e.target.value)} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"/>
                </div>
                <div>
                  <label className="block text-sm font-bold mb-2">Distributed *</label>
                  <input type="number" value={book.distributed} onChange={e=>handleBookChange(idx,'distributed',e.target.value)} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"/>
                </div>
              </div>
            </div>
          )}
        </div>

        {/* Chromebooks - Class 11 */}
        <div className="border-4 border-indigo-500 rounded-2xl p-6 bg-indigo-50">
          <h3 className="text-2xl font-bold mb-4 text-indigo-800">üíª Chromebooks/Laptops - Class 11th</h3>
          <div className="grid md:grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-bold mb-2">Distributed from Avanti? *</label>
              <select value={formData.chromebooks11Distributed} onChange={e=>setFormData({...formData,chromebooks11Distributed:e.target.value})} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed">
                <option value="No">No</option>
                <option value="Yes">Yes</option>
              </select>
            </div>
            {formData.chromebooks11Distributed==='Yes'?(
              <>
                <div>
                  <label className="block text-sm font-bold mb-2">Number Distributed *</label>
                  <input type="number" min="0" value={formData.chromebooks11Count} onChange={e=>setFormData({...formData,chromebooks11Count:e.target.value})} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed" placeholder="Enter number only"/>
                </div>
                <div>
                  <label className="block text-sm font-bold mb-2">Working Condition *</label>
                  <input type="number" min="0" value={formData.chromebooks11Working} onChange={e=>setFormData({...formData,chromebooks11Working:e.target.value})} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed" placeholder="Enter number only"/>
                </div>
                <div>
                  <label className="block text-sm font-bold mb-2">Brand Name *</label>
                  <input type="text" value={formData.chromebooks11Brand} onChange={e=>setFormData({...formData,chromebooks11Brand:e.target.value})} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"/>
                </div>
                <div className="md:col-span-2">
                  <label className="block text-sm font-bold mb-2">When Distributed? *</label>
                  <select value={formData.chromebooks11DistributedDate} onChange={e=>setFormData({...formData,chromebooks11DistributedDate:e.target.value})} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed">
                    <option value="">Select Month & Year</option>
                    {generateMonthYearOptions().map(opt=><option key={opt} value={opt}>{opt}</option>)}
                  </select>
                </div>
              </>
            ):(
              <>
                <div className="md:col-span-2">
                  <label className="block text-sm font-bold mb-2">How do you conduct tests? *</label>
                  <textarea value={formData.chromebooks11TestMethod} onChange={e=>setFormData({...formData,chromebooks11TestMethod:e.target.value})} disabled={!isEditing} rows="3" className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"/>
                </div>
                <div>
                  <label className="block text-sm font-bold mb-2">JNV Computer Lab/Tablets Accessible? *</label>
                  <input type="text" value={formData.chromebooks11JNVLabAccess} onChange={e=>setFormData({...formData,chromebooks11JNVLabAccess:e.target.value})} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"/>
                </div>
                <div>
                  <label className="block text-sm font-bold mb-2">How many tabs/computers in JNV? *</label>
                  <input type="number" min="0" value={formData.chromebooks11JNVCount} onChange={e=>setFormData({...formData,chromebooks11JNVCount:e.target.value})} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed" placeholder="Enter number only"/>
                </div>
              </>
            )}
          </div>
        </div>

        {/* Chromebooks - Class 12 */}
        <div className="border-4 border-pink-500 rounded-2xl p-6 bg-pink-50">
          <h3 className="text-2xl font-bold mb-4 text-pink-800">üíª Chromebooks/Laptops - Class 12th</h3>
          <div className="grid md:grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-bold mb-2">Distributed from Avanti? *</label>
              <select value={formData.chromebooks12Distributed} onChange={e=>setFormData({...formData,chromebooks12Distributed:e.target.value})} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed">
                <option value="No">No</option>
                <option value="Yes">Yes</option>
              </select>
            </div>
            {formData.chromebooks12Distributed==='Yes'?(
              <>
                <div>
                  <label className="block text-sm font-bold mb-2">Number Distributed *</label>
                  <input type="number" min="0" value={formData.chromebooks12Count} onChange={e=>setFormData({...formData,chromebooks12Count:e.target.value})} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed" placeholder="Enter number only"/>
                </div>
                <div>
                  <label className="block text-sm font-bold mb-2">Working Condition *</label>
                  <input type="number" min="0" value={formData.chromebooks12Working} onChange={e=>setFormData({...formData,chromebooks12Working:e.target.value})} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed" placeholder="Enter number only"/>
                </div>
                <div>
                  <label className="block text-sm font-bold mb-2">Brand Name *</label>
                  <input type="text" value={formData.chromebooks12Brand} onChange={e=>setFormData({...formData,chromebooks12Brand:e.target.value})} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"/>
                </div>
                <div className="md:col-span-2">
                  <label className="block text-sm font-bold mb-2">When Distributed? *</label>
                  <select value={formData.chromebooks12DistributedDate} onChange={e=>setFormData({...formData,chromebooks12DistributedDate:e.target.value})} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed">
                    <option value="">Select Month & Year</option>
                    {generateMonthYearOptions().map(opt=><option key={opt} value={opt}>{opt}</option>)}
                  </select>
                </div>
              </>
            ):(
              <>
                <div className="md:col-span-2">
                  <label className="block text-sm font-bold mb-2">How do you conduct tests? *</label>
                  <textarea value={formData.chromebooks12TestMethod} onChange={e=>setFormData({...formData,chromebooks12TestMethod:e.target.value})} disabled={!isEditing} rows="3" className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"/>
                </div>
                <div>
                  <label className="block text-sm font-bold mb-2">JNV Computer Lab/Tablets Accessible? *</label>
                  <input type="text" value={formData.chromebooks12JNVLabAccess} onChange={e=>setFormData({...formData,chromebooks12JNVLabAccess:e.target.value})} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"/>
                </div>
                <div>
                  <label className="block text-sm font-bold mb-2">How many tabs/computers in JNV? *</label>
                  <input type="number" min="0" value={formData.chromebooks12JNVCount} onChange={e=>setFormData({...formData,chromebooks12JNVCount:e.target.value})} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed" placeholder="Enter number only"/>
                </div>
              </>
            )}
          </div>
        </div>

        {/* Printer Information */}
        <div className="border-4 border-cyan-500 rounded-2xl p-6 bg-cyan-50">
          <h3 className="text-2xl font-bold mb-4 text-cyan-800">üñ®Ô∏è Printer Information</h3>
          <div className="grid md:grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-bold mb-2">Printer Available? *</label>
              <select value={formData.printerAvailable} onChange={e=>setFormData({...formData,printerAvailable:e.target.value})} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed">
                <option value="No">No</option>
                <option value="Yes">Yes</option>
              </select>
            </div>
            {formData.printerAvailable==='Yes'&&(
              <>
                <div>
                  <label className="block text-sm font-bold mb-2">Working Condition? *</label>
                  <select value={formData.printerWorking} onChange={e=>setFormData({...formData,printerWorking:e.target.value})} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed">
                    <option value="No">No</option>
                    <option value="Yes">Yes</option>
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-bold mb-2">Printer Brand *</label>
                  <input type="text" value={formData.printerBrand} onChange={e=>setFormData({...formData,printerBrand:e.target.value})} disabled={!isEditing} placeholder="e.g., HP, Canon, Epson" className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"/>
                </div>
                <div>
                  <label className="block text-sm font-bold mb-2">When Issued? *</label>
                  <select value={formData.printerIssuedDate} onChange={e=>setFormData({...formData,printerIssuedDate:e.target.value})} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed">
                    <option value="">Select Month & Year</option>
                    {generateMonthYearOptions().map(opt=><option key={opt} value={opt}>{opt}</option>)}
                  </select>
                </div>
              </>
            )}
          </div>
        </div>

        {/* Other Assets */}
        <div className="border-4 border-teal-500 rounded-2xl p-6 bg-teal-50">
          <div className="flex justify-between items-center mb-4">
            <h3 className="text-2xl font-bold text-teal-800">üì¶ Other Assets</h3>
            {isEditing && (
              <button onClick={handleAddAsset} className="px-6 py-3 bg-teal-600 text-white rounded-xl font-semibold">
                + Add Asset
              </button>
            )}
          </div>
          {formData.otherAssets.length===0?(
            <p className="text-gray-600 text-center py-4">No other assets added yet. Click "+ Add Asset" to add.</p>
          ):(
            formData.otherAssets.map((asset,idx)=>
              <div key={idx} className="bg-white p-4 rounded-xl mb-4 border-2 border-teal-300">
                <div className="flex justify-between items-center mb-3">
                  <h4 className="font-bold text-lg">Asset {idx+1}</h4>
                  {isEditing && (
                    <button onClick={()=>handleRemoveAsset(idx)} className="px-4 py-2 bg-red-500 text-white rounded-lg">
                      Remove
                    </button>
                  )}
                </div>
                <div className="grid md:grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-bold mb-2">Asset Name *</label>
                    <input type="text" value={asset.assetName} onChange={e=>handleAssetChange(idx,'assetName',e.target.value)} placeholder="e.g., Projector, Whiteboard" disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"/>
                  </div>
                  <div>
                    <label className="block text-sm font-bold mb-2">Quantity *</label>
                    <input type="number" value={asset.assetQuantity} onChange={e=>handleAssetChange(idx,'assetQuantity',e.target.value)} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"/>
                  </div>
                  <div>
                    <label className="block text-sm font-bold mb-2">Condition *</label>
                    <select value={asset.assetCondition} onChange={e=>handleAssetChange(idx,'assetCondition',e.target.value)} disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed">
                      <option value="">Select</option>
                      <option value="Working">Working</option>
                      <option value="Not Working">Not Working</option>
                      <option value="Needs Repair">Needs Repair</option>
                    </select>
                  </div>
                  <div>
                    <label className="block text-sm font-bold mb-2">Notes</label>
                    <input type="text" value={asset.assetNotes} onChange={e=>handleAssetChange(idx,'assetNotes',e.target.value)} placeholder="Additional details" disabled={!isEditing} className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"/>
                  </div>
                </div>
              </div>
            )
          )}
        </div>

        {/* Meeting Minutes Section */}
        <div className="bg-white p-6 rounded-2xl shadow-lg mt-6">
          <div className="flex justify-between items-center mb-4">
            <h3 className="text-xl font-bold text-purple-700">üìù Minutes of Meeting</h3>
            {isEditing && (
              <button onClick={handleAddMeeting} className="px-4 py-2 bg-purple-600 text-white rounded-xl font-semibold">
                + Add New Meeting
              </button>
            )}
          </div>
          
          {(formData.meetingMinutes || []).length === 0 ? (
            <p className="text-gray-500 text-center py-4">No meeting records yet</p>
          ) : (
            <div className="space-y-4">
              {(formData.meetingMinutes || []).map((meeting, idx) => (
                <div key={idx} className="border-2 border-purple-200 rounded-xl p-4 bg-purple-50">
                  <div className="flex justify-between items-start mb-3">
                    <div className="flex gap-4 items-center">
                      <span className="px-3 py-1 bg-purple-600 text-white rounded-full text-sm font-semibold">
                        Meeting #{(formData.meetingMinutes || []).length - idx}
                      </span>
                      <span className="text-sm text-gray-500">
                        Last updated: {meeting.updatedAt ? new Date(meeting.updatedAt).toLocaleString() : 'N/A'} by {meeting.updatedBy || 'Unknown'}
                      </span>
                    </div>
                    {isEditing && (
                      <button onClick={() => handleRemoveMeeting(idx)} className="px-3 py-1 bg-red-500 text-white rounded-lg text-sm">
                        Remove
                      </button>
                    )}
                  </div>
                  
                  <div className="grid md:grid-cols-2 gap-4 mb-4">
                    <div>
                      <label className="block text-sm font-bold mb-2">üìÖ Date *</label>
                      <input 
                        type="date" 
                        value={meeting.meetingDate || ''} 
                        onChange={e => handleMeetingChange(idx, 'meetingDate', e.target.value)} 
                        disabled={!isEditing} 
                        className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-bold mb-2">üïê Time *</label>
                      <input 
                        type="time" 
                        value={meeting.meetingTime || ''} 
                        onChange={e => handleMeetingChange(idx, 'meetingTime', e.target.value)} 
                        disabled={!isEditing} 
                        className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"
                      />
                    </div>
                  </div>
                  
                  <div className="mb-4">
                    <label className="block text-sm font-bold mb-2">üë• Attendees *</label>
                    <input 
                      type="text" 
                      value={meeting.attendees || ''} 
                      onChange={e => handleMeetingChange(idx, 'attendees', e.target.value)} 
                      placeholder="e.g., Principal, Vice Principal, Team Lead, Teacher A, Teacher B"
                      disabled={!isEditing} 
                      className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"
                    />
                  </div>
                  
                  <div className="mb-4">
                    <label className="block text-sm font-bold mb-2">üí¨ Discussed Points *</label>
                    <textarea 
                      value={meeting.discussedPoints || ''} 
                      onChange={e => handleMeetingChange(idx, 'discussedPoints', e.target.value)} 
                      placeholder="Enter the key points discussed in the meeting..."
                      disabled={!isEditing} 
                      className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"
                      rows="4"
                    />
                  </div>
                  
                  <div>
                    <label className="block text-sm font-bold mb-2">‚úÖ Action Points</label>
                    <textarea 
                      value={meeting.actionPoints || ''} 
                      onChange={e => handleMeetingChange(idx, 'actionPoints', e.target.value)} 
                      placeholder="Enter action items and next steps..."
                      disabled={!isEditing} 
                      className="w-full border-2 px-4 py-3 rounded-xl disabled:bg-gray-100 disabled:cursor-not-allowed"
                      rows="3"
                    />
                  </div>
                  
                  {/* PDF Export Button */}
                  {!isEditing && meeting.meetingDate && (
                    <div className="mt-4 pt-3 border-t border-purple-200">
                      <button
                        onClick={() => {
                          const printWindow = window.open('', '_blank');
                          const meetingNum = (formData.meetingMinutes || []).length - idx;
                          const dateStr = meeting.meetingDate ? new Date(meeting.meetingDate).toLocaleDateString('en-IN', { weekday: 'long', day: '2-digit', month: 'long', year: 'numeric' }) : 'Not specified';
                          const timeStr = meeting.meetingTime || 'Not specified';
                          const attendeesStr = meeting.attendees || 'Not specified';
                          const discussedStr = (meeting.discussedPoints || 'No discussion points recorded').replace(/\n/g, '<br>');
                          const actionStr = (meeting.actionPoints || 'No action items recorded').replace(/\n/g, '<br>');
                          const updatedStr = meeting.updatedAt ? new Date(meeting.updatedAt).toLocaleString('en-IN') : 'N/A';
                          const updatedByStr = meeting.updatedBy ? ' by <strong>' + meeting.updatedBy + '</strong>' : '';
                          const nowStr = new Date().toLocaleString('en-IN');
                          
                          printWindow.document.write(
                            '<!DOCTYPE html><html><head><title>Meeting Minutes - ' + mySchool + '</title>' +
                            '<style>@media print { @page { margin: 1cm; size: A4; } body { -webkit-print-color-adjust: exact; print-color-adjust: exact; } }' +
                            'body { font-family: Arial, sans-serif; padding: 20px; color: #333; max-width: 800px; margin: 0 auto; }' +
                            '.header { display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 3px solid #7C3AED; padding-bottom: 15px; margin-bottom: 20px; }' +
                            '.logo { font-size: 24px; font-weight: bold; color: #7C3AED; }' +
                            '.meeting-badge { background: #7C3AED; color: white; padding: 8px 16px; border-radius: 20px; font-size: 14px; }' +
                            '.info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }' +
                            '.info-item { padding: 12px; background: #F9FAFB; border-radius: 8px; border-left: 4px solid #7C3AED; }' +
                            '.info-item label { font-size: 11px; color: #6B7280; text-transform: uppercase; display: block; margin-bottom: 4px; }' +
                            '.info-item span { font-weight: bold; color: #1F2937; font-size: 14px; }' +
                            '.section { margin-top: 20px; padding: 15px; background: #FAF5FF; border-radius: 8px; border: 1px solid #E9D5FF; }' +
                            '.section-title { font-weight: bold; color: #7C3AED; margin-bottom: 10px; font-size: 14px; }' +
                            '.section-content { white-space: pre-wrap; line-height: 1.8; font-size: 13px; color: #374151; }' +
                            '.footer { margin-top: 30px; padding-top: 15px; border-top: 2px solid #E9D5FF; font-size: 11px; color: #6B7280; display: flex; justify-content: space-between; }' +
                            '</style></head><body>' +
                            '<div class="header"><div><div class="logo">‡§Ö‡§µ‡§Ç‡§§‡•Ä Avanti Fellows</div>' +
                            '<h1 style="margin: 10px 0 5px; font-size: 22px; color: #1F2937;">Minutes of Meeting</h1>' +
                            '<p style="margin: 0; color: #6B7280; font-size: 14px;">üè´ ' + mySchool + '</p></div>' +
                            '<div class="meeting-badge">Meeting #' + meetingNum + '</div></div>' +
                            '<div class="info-grid"><div class="info-item"><label>üìÖ Date</label><span>' + dateStr + '</span></div>' +
                            '<div class="info-item"><label>üïê Time</label><span>' + timeStr + '</span></div></div>' +
                            '<div class="section"><div class="section-title">üë• Attendees</div><div class="section-content">' + attendeesStr + '</div></div>' +
                            '<div class="section"><div class="section-title">üí¨ Discussion Points</div><div class="section-content">' + discussedStr + '</div></div>' +
                            '<div class="section" style="background: #F0FDF4; border-color: #BBF7D0;"><div class="section-title" style="color: #059669;">‚úÖ Action Items</div><div class="section-content">' + actionStr + '</div></div>' +
                            '<div class="footer"><div><strong>Last Updated:</strong> ' + updatedStr + updatedByStr + '</div><div>Generated on: ' + nowStr + '</div></div>' +
                            '<script>window.onload = function() { setTimeout(function() { window.print(); }, 500); }</scr' + 'ipt></body></html>'
                          );
                          printWindow.document.close();
                        }}
                        className="px-4 py-2 bg-purple-600 text-white rounded-lg font-semibold text-sm hover:bg-purple-700 flex items-center gap-2"
                      >
                        üìÑ Export to PDF
                      </button>
                    </div>
                  )}
                </div>
              ))}
            </div>
          )}
        </div>

        {isEditing && (
        <button onClick={handleSubmit} disabled={isSaving} className={`w-full text-white py-4 rounded-xl font-bold text-xl ${isSaving ? 'bg-gray-400 cursor-not-allowed' : 'avanti-gradient hover:opacity-90'}`}>
          {isSaving ? '‚è≥ Saving...' : 'üíæ Save School Information'}
        </button>
      )}
      </div>
    </div>
  );
}

// ========================================
// ADMIN SCHOOL INFO VIEW
// ========================================
function AdminSchoolInfo({schoolInfo}){
  const handleExport=()=>{
    const exportData=schoolInfo.map(info=>({
      School:info.school,
      'Principal Name':info.principalName,
      'Principal Phone':info.principalPhone,
      'Principal Email':info.principalEmail,
      'Vice Principal Name':info.vicePrincipalName,
      'Vice Principal Phone':info.vicePrincipalPhone,
      'Vice Principal Email':info.vicePrincipalEmail,
      'Coordinator Name':info.coordinatorName,
      'Coordinator Phone':info.coordinatorPhone,
      'Coordinator Email':info.coordinatorEmail,
      'WiFi in Classroom':info.wifiInClassroom,
      'WiFi Installed By':info.wifiInstalledBy,
      'WiFi Working':info.wifiWorking,
      'WiFi Monthly Bill':info.wifiMonthlyBill,
      'WiFi Connection Type':info.wifiConnectionType,
      'WiFi Network Name':info.wifiNetworkName,
      'Both Classes WiFi':info.bothClassesWifi,
      'Modules 11 Received':info.modules11Received,
      'Modules 11 Distributed':info.modules11Distributed,
      'Modules 11 Stock':info.modules11Stock,
      'Modules 11 Remarks':info.modules11Remarks||'',
      'Modules 12 Received':info.modules12Received,
      'Modules 12 Distributed':info.modules12Distributed,
      'Modules 12 Stock':info.modules12Stock,
      'Modules 12 Remarks':info.modules12Remarks||'',
      'Chromebooks 11 Distributed':info.chromebooks11Distributed,
      'Chromebooks 11 Count':info.chromebooks11Count,
      'Chromebooks 11 Working':info.chromebooks11Working,
      'Chromebooks 11 Brand':info.chromebooks11Brand,
      'Chromebooks 11 Date':info.chromebooks11DistributedDate,
      'Chromebooks 12 Distributed':info.chromebooks12Distributed,
      'Chromebooks 12 Count':info.chromebooks12Count,
      'Chromebooks 12 Working':info.chromebooks12Working,
      'Chromebooks 12 Brand':info.chromebooks12Brand,
      'Chromebooks 12 Date':info.chromebooks12DistributedDate,
      'Printer Available':info.printerAvailable,
      'Printer Working':info.printerWorking,
      'Printer Brand':info.printerBrand,
      'Printer Issued Date':info.printerIssuedDate,
      'Other Assets Count':info.otherAssets?info.otherAssets.length:0,
      'Last Updated':info.updatedAt?new Date(info.updatedAt).toLocaleString():''
    }));
    exportToExcel(exportData,'school_information');
  };

  return(
    <div className="space-y-6">
      <div className="flex justify-between items-center">
        <h2 className="text-3xl font-bold">üè´ School Information</h2>
        <button onClick={handleExport} className="px-6 py-3 bg-green-600 text-white rounded-xl font-semibold">
          üì• Export to Excel
        </button>
      </div>

      {schoolInfo.length===0?(
        <div className="bg-white p-8 rounded-2xl text-center">
          <p className="text-gray-600">No school information available yet. Teachers need to fill the forms.</p>
        </div>
      ):(
        <div className="space-y-6">
          {schoolInfo.map(info=>
            <div key={info.id} className="bg-white p-6 rounded-2xl shadow-lg">
              <div className="flex justify-between items-center mb-2">
  <h3 className="text-2xl font-bold">{info.school}</h3>
  <div className="text-right text-sm text-gray-600">
    <div>
      Last updated:{' '}
      {info.updatedAt ? new Date(info.updatedAt).toLocaleString() : 'N/A'}
    </div>
    {info.updatedByName && (
      <div>By: {info.updatedByName} ({info.updatedBy})</div>
    )}
  </div>
</div>

{info.updateHistory && info.updateHistory.length > 0 && (
  <div className="mb-4 bg-yellow-50 border-l-4 border-yellow-400 p-3 rounded">
    <div className="font-semibold mb-1">Edit history</div>
    <ul className="text-xs max-h-32 overflow-y-auto space-y-1">
      {info.updateHistory
        .slice()
        .sort((a, b) => new Date(a.updatedAt) - new Date(b.updatedAt))
        .map((entry, idx) => (
          <li key={idx}>
            {new Date(entry.updatedAt).toLocaleString()} ‚Äî {entry.updatedByName || entry.updatedBy}
          </li>
        ))}
    </ul>
  </div>
)}

              {/* Principal Info */}
              <div className="border-2 border-blue-300 rounded-xl p-4 mb-4 bg-blue-50">
                <h4 className="font-bold text-lg mb-3 text-blue-800">üë®‚Äçüíº Principal</h4>
                <div className="grid md:grid-cols-3 gap-3 text-sm">
                  <div><strong>Name:</strong> {info.principalName||'‚Äî'}</div>
                  <div><strong>Phone:</strong> {info.principalPhone||'‚Äî'}</div>
                  <div><strong>Email:</strong> {info.principalEmail||'‚Äî'}</div>
                </div>
              </div>

              {/* Vice Principal Info */}
              <div className="border-2 border-green-300 rounded-xl p-4 mb-4 bg-green-50">
                <h4 className="font-bold text-lg mb-3 text-green-800">üë®‚Äçüíº Vice Principal</h4>
                <div className="grid md:grid-cols-3 gap-3 text-sm">
                  <div><strong>Name:</strong> {info.vicePrincipalName||'‚Äî'}</div>
                  <div><strong>Phone:</strong> {info.vicePrincipalPhone||'‚Äî'}</div>
                  <div><strong>Email:</strong> {info.vicePrincipalEmail||'‚Äî'}</div>
                </div>
              </div>

              {/* Avanti Coordinator Info */}
              <div className="border-2 border-orange-300 rounded-xl p-4 mb-4 bg-orange-50">
                <h4 className="font-bold text-lg mb-3 text-orange-800">üë®‚Äçüíº Avanti Coordinator</h4>
                <div className="grid md:grid-cols-3 gap-3 text-sm">
                  <div><strong>Name:</strong> {info.coordinatorName||'‚Äî'}</div>
                  <div><strong>Phone:</strong> {info.coordinatorPhone||'‚Äî'}</div>
                  <div><strong>Email:</strong> {info.coordinatorEmail||'‚Äî'}</div>
                </div>
              </div>

              {/* WiFi Info */}
              <div className="border-2 border-purple-300 rounded-xl p-4 mb-4 bg-purple-50">
                <h4 className="font-bold text-lg mb-3 text-purple-800">üì∂ WiFi Connection</h4>
                <div className="grid md:grid-cols-3 gap-3 text-sm">
                  <div><strong>WiFi Available:</strong> {info.wifiInClassroom||'‚Äî'}</div>
                  {info.wifiInClassroom==='Yes'&&(
                    <>
                      <div><strong>Installed By:</strong> {info.wifiInstalledBy||'‚Äî'}</div>
                      <div><strong>Working:</strong> {info.wifiWorking||'‚Äî'}</div>
                      <div><strong>Monthly Bill:</strong> ‚Çπ{info.wifiMonthlyBill||'‚Äî'}</div>
                      <div><strong>Connection Type:</strong> {info.wifiConnectionType||'‚Äî'}</div>
                      <div><strong>Network:</strong> {info.wifiNetworkName||'‚Äî'}</div>
                      <div><strong>Both Classes WiFi:</strong> {info.bothClassesWifi||'‚Äî'}</div>
                    </>
                  )}
                </div>
              </div>

              {/* Modules Info */}
              <div className="grid md:grid-cols-2 gap-4 mb-4">
                <div className="border-2 border-green-300 rounded-xl p-4 bg-green-50">
                  <h4 className="font-bold text-lg mb-3 text-green-800">üìö Modules - Class 11</h4>
                  <div className="space-y-2 text-sm">
                    <div><strong>Received:</strong> {info.modules11Received||'‚Äî'}</div>
                    <div><strong>Distributed:</strong> {info.modules11Distributed||'‚Äî'}</div>
                    <div><strong>In Stock:</strong> {info.modules11Stock||'‚Äî'}</div>
                    {info.modules11Remarks && <div className="mt-2 p-2 bg-white rounded border border-green-200"><strong>üìù Remarks:</strong> {info.modules11Remarks}</div>}
                  </div>
                </div>
                <div className="border-2 border-blue-300 rounded-xl p-4 bg-blue-50">
                  <h4 className="font-bold text-lg mb-3 text-blue-800">üìö Modules - Class 12</h4>
                  <div className="space-y-2 text-sm">
                    <div><strong>Received:</strong> {info.modules12Received||'‚Äî'}</div>
                    <div><strong>Distributed:</strong> {info.modules12Distributed||'‚Äî'}</div>
                    <div><strong>In Stock:</strong> {info.modules12Stock||'‚Äî'}</div>
                    {info.modules12Remarks && <div className="mt-2 p-2 bg-white rounded border border-blue-200"><strong>üìù Remarks:</strong> {info.modules12Remarks}</div>}
                  </div>
                </div>
              </div>

              {/* Reference Books */}
              {info.referenceBooks&&info.referenceBooks.length>0&&(
                <div className="border-2 border-yellow-300 rounded-xl p-4 mb-4 bg-yellow-50">
                  <h4 className="font-bold text-lg mb-3 text-yellow-800">üìñ Reference Books</h4>
                  <div className="overflow-x-auto">
                    <table className="w-full text-sm">
                      <thead className="bg-yellow-200">
                        <tr>
                          <th className="p-2 text-left">Book Name</th>
                          <th className="p-2 text-left">Publisher</th>
                          <th className="p-2 text-left">Author</th>
                          <th className="p-2 text-left">Price</th>
                          <th className="p-2 text-left">In Stock</th>
                          <th className="p-2 text-left">Distributed</th>
                        </tr>
                      </thead>
                      <tbody>
                        {info.referenceBooks.map((book,idx)=>
                          <tr key={idx} className="border-b border-yellow-200">
                            <td className="p-2">{book.bookName||'‚Äî'}</td>
                            <td className="p-2">{book.publisher||'‚Äî'}</td>
                            <td className="p-2">{book.author||'‚Äî'}</td>
                            <td className="p-2">‚Çπ{book.price||'‚Äî'}</td>
                            <td className="p-2">{book.inStock||'‚Äî'}</td>
                            <td className="p-2">{book.distributed||'‚Äî'}</td>
                          </tr>
                        )}
                      </tbody>
                    </table>
                  </div>
                </div>
              )}

              {/* Chromebooks Info */}
              <div className="grid md:grid-cols-2 gap-4 mb-4">
                <div className="border-2 border-indigo-300 rounded-xl p-4 bg-indigo-50">
                  <h4 className="font-bold text-lg mb-3 text-indigo-800">üíª Chromebooks - Class 11</h4>
                  <div className="space-y-2 text-sm">
                    <div><strong>Distributed from Avanti:</strong> {info.chromebooks11Distributed||'‚Äî'}</div>
                    {info.chromebooks11Distributed==='Yes'?(
                      <>
                        <div><strong>Count:</strong> {info.chromebooks11Count||'‚Äî'}</div>
                        <div><strong>Working:</strong> {info.chromebooks11Working||'‚Äî'}</div>
                        <div><strong>Brand:</strong> {info.chromebooks11Brand||'‚Äî'}</div>
                        <div><strong>Distributed:</strong> {info.chromebooks11DistributedDate||'‚Äî'}</div>
                      </>
                    ):(
                      <>
                        <div><strong>Test Method:</strong> {info.chromebooks11TestMethod||'‚Äî'}</div>
                        <div><strong>JNV Lab Access:</strong> {info.chromebooks11JNVLabAccess||'‚Äî'}</div>
                        <div><strong>JNV Devices:</strong> {info.chromebooks11JNVCount||'‚Äî'}</div>
                      </>
                    )}
                  </div>
                </div>
                <div className="border-2 border-pink-300 rounded-xl p-4 bg-pink-50">
                  <h4 className="font-bold text-lg mb-3 text-pink-800">üíª Chromebooks - Class 12</h4>
                  <div className="space-y-2 text-sm">
                    <div><strong>Distributed from Avanti:</strong> {info.chromebooks12Distributed||'‚Äî'}</div>
                    {info.chromebooks12Distributed==='Yes'?(
                      <>
                        <div><strong>Count:</strong> {info.chromebooks12Count||'‚Äî'}</div>
                        <div><strong>Working:</strong> {info.chromebooks12Working||'‚Äî'}</div>
                        <div><strong>Brand:</strong> {info.chromebooks12Brand||'‚Äî'}</div>
                        <div><strong>Distributed:</strong> {info.chromebooks12DistributedDate||'‚Äî'}</div>
                      </>
                    ):(
                      <>
                        <div><strong>Test Method:</strong> {info.chromebooks12TestMethod||'‚Äî'}</div>
                        <div><strong>JNV Lab Access:</strong> {info.chromebooks12JNVLabAccess||'‚Äî'}</div>
                        <div><strong>JNV Devices:</strong> {info.chromebooks12JNVCount||'‚Äî'}</div>
                      </>
                    )}
                  </div>
                </div>
              </div>

              {/* Printer Info */}
              <div className="border-2 border-cyan-300 rounded-xl p-4 mb-4 bg-cyan-50">
                <h4 className="font-bold text-lg mb-3 text-cyan-800">üñ®Ô∏è Printer</h4>
                <div className="grid md:grid-cols-2 gap-3 text-sm">
                  <div><strong>Printer Available:</strong> {info.printerAvailable||'‚Äî'}</div>
                  {info.printerAvailable==='Yes'&&(
                    <>
                      <div><strong>Working:</strong> {info.printerWorking||'‚Äî'}</div>
                      <div><strong>Brand:</strong> {info.printerBrand||'‚Äî'}</div>
                      <div><strong>Issued:</strong> {info.printerIssuedDate||'‚Äî'}</div>
                    </>
                  )}
                </div>
              </div>

              {/* Other Assets */}
              {info.otherAssets&&info.otherAssets.length>0&&(
                <div className="border-2 border-teal-300 rounded-xl p-4 mb-4 bg-teal-50">
                  <h4 className="font-bold text-lg mb-3 text-teal-800">üì¶ Other Assets ({info.otherAssets.length})</h4>
                  <div className="overflow-x-auto">
                    <table className="w-full text-sm">
                      <thead className="bg-teal-200">
                        <tr>
                          <th className="p-2 text-left">Asset Name</th>
                          <th className="p-2 text-left">Quantity</th>
                          <th className="p-2 text-left">Condition</th>
                          <th className="p-2 text-left">Notes</th>
                        </tr>
                      </thead>
                      <tbody>
                        {info.otherAssets.map((asset,idx)=>
                          <tr key={idx} className="border-b border-teal-200">
                            <td className="p-2 font-semibold">{asset.assetName||'‚Äî'}</td>
                            <td className="p-2">{asset.assetQuantity||'‚Äî'}</td>
                            <td className="p-2">
                              <span className={`px-2 py-1 rounded-full text-xs font-bold ${
                                asset.assetCondition==='Working'?'bg-green-100 text-green-700':
                                asset.assetCondition==='Not Working'?'bg-red-100 text-red-700':
                                'bg-yellow-100 text-yellow-700'
                              }`}>
                                {asset.assetCondition||'‚Äî'}
                              </span>
                            </td>
                            <td className="p-2">{asset.assetNotes||'‚Äî'}</td>
                          </tr>
                        )}
                      </tbody>
                    </table>
                  </div>
                </div>
              )}

              {/* Meeting Minutes Section */}
              {info.meetingMinutes && info.meetingMinutes.length > 0 && (
                <div className="border-2 border-purple-300 rounded-xl p-4 bg-purple-50">
                  <h4 className="font-bold text-lg mb-3 text-purple-800">üìù Meeting Minutes ({info.meetingMinutes.length})</h4>
                  <div className="space-y-3">
                    {info.meetingMinutes.map((meeting, idx) => (
                      <div key={idx} className="bg-white p-4 rounded-lg border border-purple-200">
                        <div className="flex justify-between items-start mb-3">
                          <div className="flex items-center gap-3">
                            <span className="px-3 py-1 bg-purple-600 text-white rounded-full text-xs font-semibold">
                              Meeting #{info.meetingMinutes.length - idx}
                            </span>
                            <span className="text-sm text-gray-600">
                              {meeting.meetingDate ? new Date(meeting.meetingDate).toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' }) : 'No date'} 
                              {meeting.meetingTime && ` at ${meeting.meetingTime}`}
                            </span>
                          </div>
                          <button
                            onClick={() => {
                              const printWindow = window.open('', '_blank');
                              const meetingNum = info.meetingMinutes.length - idx;
                              const schoolName = info.school;
                              const dateStr = meeting.meetingDate ? new Date(meeting.meetingDate).toLocaleDateString('en-IN', { weekday: 'long', day: '2-digit', month: 'long', year: 'numeric' }) : 'N/A';
                              const timeStr = meeting.meetingTime || 'N/A';
                              const attendeesStr = meeting.attendees || 'Not specified';
                              const discussedStr = (meeting.discussedPoints || 'No points recorded').replace(/\n/g, '<br>');
                              const actionStr = (meeting.actionPoints || 'No action items').replace(/\n/g, '<br>');
                              const updatedStr = meeting.updatedAt ? new Date(meeting.updatedAt).toLocaleString('en-IN') : 'N/A';
                              const updatedByStr = meeting.updatedBy || 'Unknown';
                              const nowStr = new Date().toLocaleString('en-IN');
                              
                              printWindow.document.write(
                                '<!DOCTYPE html><html><head><title>Meeting Minutes - ' + schoolName + '</title>' +
                                '<style>@media print { @page { margin: 1cm; size: A4; } body { -webkit-print-color-adjust: exact; } }' +
                                'body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; color: #333; }' +
                                '.header { display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 3px solid #7C3AED; padding-bottom: 15px; margin-bottom: 20px; }' +
                                '.logo { font-size: 24px; font-weight: bold; color: #7C3AED; }' +
                                '.meeting-badge { background: #7C3AED; color: white; padding: 8px 16px; border-radius: 20px; }' +
                                '.info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }' +
                                '.info-item { padding: 12px; background: #F9FAFB; border-radius: 8px; border-left: 4px solid #7C3AED; }' +
                                '.info-item label { font-size: 11px; color: #6B7280; text-transform: uppercase; display: block; margin-bottom: 4px; }' +
                                '.info-item span { font-weight: bold; color: #1F2937; }' +
                                '.section { margin-top: 20px; padding: 15px; background: #FAF5FF; border-radius: 8px; border: 1px solid #E9D5FF; }' +
                                '.section-title { font-weight: bold; color: #7C3AED; margin-bottom: 10px; }' +
                                '.section-content { white-space: pre-wrap; line-height: 1.8; }' +
                                '.footer { margin-top: 30px; padding-top: 15px; border-top: 2px solid #E9D5FF; font-size: 11px; color: #666; display: flex; justify-content: space-between; }' +
                                '</style></head><body>' +
                                '<div class="header"><div><div class="logo">‡§Ö‡§µ‡§Ç‡§§‡•Ä Avanti Fellows</div>' +
                                '<h1 style="margin: 10px 0 5px; font-size: 22px;">Minutes of Meeting</h1>' +
                                '<p style="margin: 0; color: #666;">üè´ ' + schoolName + '</p></div>' +
                                '<div class="meeting-badge">Meeting #' + meetingNum + '</div></div>' +
                                '<div class="info-grid"><div class="info-item"><label>üìÖ Date</label><span>' + dateStr + '</span></div>' +
                                '<div class="info-item"><label>üïê Time</label><span>' + timeStr + '</span></div></div>' +
                                '<div class="section"><div class="section-title">üë• Attendees</div><div class="section-content">' + attendeesStr + '</div></div>' +
                                '<div class="section"><div class="section-title">üí¨ Discussion Points</div><div class="section-content">' + discussedStr + '</div></div>' +
                                '<div class="section" style="background: #F0FDF4; border-color: #BBF7D0;"><div class="section-title" style="color: #059669;">‚úÖ Action Items</div><div class="section-content">' + actionStr + '</div></div>' +
                                '<div class="footer"><div>Updated: ' + updatedStr + ' by ' + updatedByStr + '</div><div>Generated: ' + nowStr + '</div></div>' +
                                '<script>window.onload = function() { setTimeout(function() { window.print(); }, 500); }</scr' + 'ipt></body></html>'
                              );
                              printWindow.document.close();
                            }}
                            className="px-3 py-1 bg-purple-600 text-white rounded-lg text-xs font-semibold hover:bg-purple-700"
                          >
                            üìÑ Export PDF
                          </button>
                        </div>
                        <div className="text-sm space-y-2">
                          <div><strong className="text-purple-700">üë• Attendees:</strong> {meeting.attendees || 'Not specified'}</div>
                          <div><strong className="text-purple-700">üí¨ Discussed:</strong> {meeting.discussedPoints?.substring(0, 150)}{meeting.discussedPoints?.length > 150 ? '...' : '' || 'No points'}</div>
                          {meeting.actionPoints && (
                            <div><strong className="text-green-700">‚úÖ Actions:</strong> {meeting.actionPoints.substring(0, 100)}{meeting.actionPoints.length > 100 ? '...' : ''}</div>
                          )}
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              )}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
// ========================================
// TEACHER DIRECTORY
// ========================================
function TeacherDirectory({ teachers, currentUser }) {
  const [searchTerm, setSearchTerm] = useState('');
  const [filterSchool, setFilterSchool] = useState('All');
  const [filterSubject, setFilterSubject] = useState('All');
  const [selectedTeacher, setSelectedTeacher] = useState(null);

  // Get unique schools
  const schools = ['All', ...new Set(teachers.map(t => t.school))];

  // Filter teachers
  const filteredTeachers = teachers.filter(teacher => {
    const matchesSearch = teacher.name?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                         teacher.email?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                         teacher.phone?.includes(searchTerm);
    const matchesSchool = filterSchool === 'All' || teacher.school === filterSchool;
    const matchesSubject = filterSubject === 'All' || teacher.subject === filterSubject;
    return matchesSearch && matchesSchool && matchesSubject;
  });

  // Get subject icon
  const getSubjectIcon = (subject) => {
    const icons = {
      'Physics': '‚öõÔ∏è',
      'Chemistry': 'üß™',
      'Mathematics': 'üìê',
      'Biology': 'üß¨'
    };
    return icons[subject] || 'üìö';
  };

  // Get school color
  const getSchoolColor = (school) => {
    const colors = {
      'CoE Barwani': 'from-blue-500 to-blue-600',
      'CoE Cuttak': 'from-green-500 to-green-600',
      'CoE Bundi': 'from-purple-500 to-purple-600',
      'CoE Mahisagar': 'from-orange-500 to-orange-600',
      'EMRS Bhopal': 'from-pink-500 to-pink-600',
      'JNV Bharuch': 'from-red-500 to-red-600'
    };
    return colors[school] || 'from-gray-500 to-gray-600';
  };

  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <h2 className="text-3xl font-bold">üìñ Teacher Directory</h2>
        <div className="text-lg font-semibold text-gray-600">
          {filteredTeachers.length} {filteredTeachers.length === 1 ? 'Teacher' : 'Teachers'}
        </div>
      </div>

      {/* Search and Filters */}
      <div className="bg-white p-6 rounded-2xl shadow-lg">
        <div className="grid md:grid-cols-3 gap-4">
          {/* Search */}
          <div>
            <label className="block text-sm font-semibold mb-2">üîç Search</label>
            <input
              type="text"
              placeholder="Name, email, or phone..."
              value={searchTerm}
              onChange={(e) => setSearchTerm(e.target.value)}
              className="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-yellow-500"
            />
          </div>

          {/* School Filter */}
          <div>
            <label className="block text-sm font-semibold mb-2">üè´ School</label>
            <select
              value={filterSchool}
              onChange={(e) => setFilterSchool(e.target.value)}
              className="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-yellow-500"
            >
              {schools.map(school => (
                <option key={school} value={school}>{school}</option>
              ))}
            </select>
          </div>

          {/* Subject Filter */}
          <div>
            <label className="block text-sm font-semibold mb-2">üìö Subject</label>
            <select
              value={filterSubject}
              onChange={(e) => setFilterSubject(e.target.value)}
              className="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-yellow-500"
            >
              <option value="All">All Subjects</option>
              {SUBJECTS.map(subject => (
                <option key={subject} value={subject}>{subject}</option>
              ))}
            </select>
          </div>
        </div>
      </div>

      {/* Teacher Cards Grid */}
      {filteredTeachers.length === 0 ? (
        <div className="bg-white p-12 rounded-2xl shadow-lg text-center">
          <div className="text-6xl mb-4">üîç</div>
          <div className="text-xl font-semibold text-gray-600">No teachers found</div>
          <div className="text-gray-500 mt-2">Try adjusting your search filters</div>
        </div>
      ) : (
        <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
          {filteredTeachers.map((teacher) => (
            <div
              key={teacher.docId}
              className={`bg-white rounded-2xl shadow-lg hover:shadow-2xl transition-all duration-300 overflow-hidden cursor-pointer transform hover:-translate-y-1 ${
                teacher.isArchived ? 'ring-2 ring-red-400 opacity-75' : ''
              }`}
              onClick={() => setSelectedTeacher(teacher)}
            >
              {/* Archived Banner */}
              {teacher.isArchived && (
                <div className="bg-red-500 text-white text-center py-1 text-xs font-bold">
                  üì¶ ARCHIVED - {teacher.archiveReason || 'Unknown'}
                </div>
              )}
              
              {/* Header with gradient */}
              <div className={`bg-gradient-to-r ${teacher.isArchived ? 'from-gray-400 to-gray-500' : getSchoolColor(teacher.school)} p-4 text-white`}>
                <div className="flex items-start justify-between">
                  <div className="flex-1">
                    <div className="text-xs font-semibold opacity-90 mb-1">{teacher.school}</div>
                    <div className="text-sm opacity-90">{teacher.grade || 'Class 11 & 12'}</div>
                  </div>
                  <div className="text-3xl">
                    {teacher.isArchived ? 'üì¶' : getSubjectIcon(teacher.subject)}
                  </div>
                </div>
              </div>

              {/* Profile Photo */}
              <div className="flex justify-center -mt-10 mb-4">
                {teacher.profilePhoto ? (
                  <img
                    src={teacher.profilePhoto}
                    alt={teacher.name}
                    className={`w-20 h-20 rounded-full border-4 shadow-lg object-cover ${
                      teacher.isArchived ? 'border-red-300 grayscale' : 'border-white'
                    }`}
                  />
                ) : (
                  <div className={`w-20 h-20 rounded-full border-4 shadow-lg flex items-center justify-center text-3xl font-bold text-white ${
                    teacher.isArchived 
                      ? 'border-red-300 bg-gradient-to-br from-gray-400 to-gray-500' 
                      : 'border-white bg-gradient-to-br from-gray-300 to-gray-400'
                  }`}>
                    {teacher.name?.charAt(0) || '?'}
                  </div>
                )}
              </div>

              {/* Teacher Info */}
              <div className="px-4 pb-4 space-y-3">
                {/* Name */}
                <div className="text-center">
                  <div className={`text-xl font-bold ${teacher.isArchived ? 'text-red-600' : 'text-gray-800'}`}>
                    {teacher.name}
                    {teacher.isArchived && <span className="text-sm ml-1">(Archived)</span>}
                  </div>
                  <div className="text-sm font-semibold text-gray-600">{teacher.subject}</div>
                  
                  {/* Archive Reason Badge */}
                  {teacher.isArchived && (
                    <div className="mt-2">
                      <span className={`px-3 py-1 rounded-full text-xs font-bold ${
                        teacher.archiveReason === 'Resigned' ? 'bg-yellow-100 text-yellow-800' :
                        teacher.archiveReason === 'Removed' ? 'bg-red-100 text-red-800' :
                        teacher.archiveReason === 'Transferred' ? 'bg-blue-100 text-blue-800' :
                        teacher.archiveReason === 'On Long Leave' ? 'bg-purple-100 text-purple-800' :
                        'bg-gray-100 text-gray-800'
                      }`}>
                        {teacher.archiveReason === 'Resigned' && 'üòî '}
                        {teacher.archiveReason === 'Removed' && '‚ùå '}
                        {teacher.archiveReason === 'Transferred' && 'üîÑ '}
                        {teacher.archiveReason === 'On Long Leave' && 'üèñÔ∏è '}
                        {teacher.archiveReason || 'Archived'}
                      </span>
                      {teacher.archivedAt && (
                        <div className="text-xs text-gray-500 mt-1">
                          Since {new Date(teacher.archivedAt).toLocaleDateString()}
                        </div>
                      )}
                    </div>
                  )}
                </div>

                {/* Contact Info */}
                <div className="space-y-2 text-sm">
                  {teacher.phone && (
                    <div className="flex items-center gap-2 text-gray-700">
                      <span className="text-lg">üì±</span>
                      <span className="font-medium">{teacher.phone}</span>
                    </div>
                  )}
                  
                  {teacher.whatsapp && (
                    <div className="flex items-center gap-2 text-gray-700">
                      <span className="text-lg">üí¨</span>
                      <span className="font-medium">{teacher.whatsapp}</span>
                    </div>
                  )}
                  
                  {teacher.email && (
                    <div className="flex items-center gap-2 text-gray-700">
                      <span className="text-lg">üìß</span>
                      <span className="font-medium text-xs break-all">{teacher.email}</span>
                    </div>
                  )}
                </div>

                {/* Dates */}
                <div className="grid grid-cols-2 gap-2 pt-2 border-t">
                  {teacher.dateOfJoining && (
                    <div className="text-center">
                      <div className="text-xs text-gray-500">Joined</div>
                      <div className="text-sm font-semibold text-gray-700">
                        {new Date(teacher.dateOfJoining).toLocaleDateString('en-IN', { day: 'numeric', month: 'short', year: 'numeric' })}
                      </div>
                    </div>
                  )}
                  {teacher.dateOfBirth && (
                    <div className="text-center">
                      <div className="text-xs text-gray-500">Birthday</div>
                      <div className="text-sm font-semibold text-gray-700">
                        {new Date(teacher.dateOfBirth).toLocaleDateString('en-IN', { day: 'numeric', month: 'short' })}
                      </div>
                    </div>
                  )}
                </div>

                {/* Click for more */}
                <div className="text-center pt-2">
                  <button className="text-xs text-blue-600 font-semibold hover:text-blue-800">
                    Click for full details ‚Üí
                  </button>
                </div>
              </div>
            </div>
          ))}
        </div>
      )}

      {/* Teacher Detail Modal */}
      {selectedTeacher && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setSelectedTeacher(null)}>
          <div className="bg-white rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto" onClick={(e) => e.stopPropagation()}>
            {/* Archived Warning Banner */}
            {selectedTeacher.isArchived && (
              <div className="bg-red-500 text-white p-4">
                <div className="flex items-center justify-center gap-2">
                  <span className="text-2xl">üì¶</span>
                  <div>
                    <div className="font-bold">This teacher has been archived</div>
                    <div className="text-sm opacity-90">
                      Reason: {selectedTeacher.archiveReason || 'Not specified'}
                      {selectedTeacher.archivedAt && ` ‚Ä¢ Since ${new Date(selectedTeacher.archivedAt).toLocaleDateString()}`}
                    </div>
                    {selectedTeacher.archiveNotes && (
                      <div className="text-sm opacity-80 mt-1">Notes: {selectedTeacher.archiveNotes}</div>
                    )}
                  </div>
                </div>
              </div>
            )}
            
            {/* Header */}
            <div className={`bg-gradient-to-r ${selectedTeacher.isArchived ? 'from-gray-400 to-gray-500' : getSchoolColor(selectedTeacher.school)} p-6 text-white relative`}>
              <button
                onClick={() => setSelectedTeacher(null)}
                className="absolute top-4 right-4 text-white text-2xl hover:text-gray-200 w-10 h-10 flex items-center justify-center rounded-full hover:bg-white/20"
              >
                √ó
              </button>
              <div className="flex items-center gap-4">
                {selectedTeacher.profilePhoto ? (
                  <img
                    src={selectedTeacher.profilePhoto}
                    alt={selectedTeacher.name}
                    className={`w-24 h-24 rounded-full border-4 border-white shadow-lg object-cover ${selectedTeacher.isArchived ? 'grayscale' : ''}`}
                  />
                ) : (
                  <div className="w-24 h-24 rounded-full border-4 border-white shadow-lg bg-white/30 flex items-center justify-center text-4xl font-bold">
                    {selectedTeacher.name?.charAt(0) || '?'}
                  </div>
                )}
                <div className="flex-1">
                  <div className="text-2xl font-bold">
                    {selectedTeacher.name}
                    {selectedTeacher.isArchived && <span className="text-sm ml-2 bg-red-600 px-2 py-1 rounded">Archived</span>}
                  </div>
                  <div className="text-lg opacity-90">{selectedTeacher.subject}</div>
                  <div className="text-sm opacity-80 mt-1">{selectedTeacher.school}</div>
                </div>
              </div>
            </div>

            {/* Content */}
            <div className="p-6 space-y-6">
              {/* Contact Information */}
              <div>
                <div className="text-lg font-bold mb-3 flex items-center gap-2">
                  <span>üìû</span> Contact Information
                </div>
                <div className="bg-gray-50 rounded-xl p-4 space-y-3">
                  {selectedTeacher.phone && (
                    <div className="flex items-center justify-between">
                      <span className="text-gray-600 font-medium">Phone:</span>
                      <a href={`tel:${selectedTeacher.phone}`} className="text-blue-600 font-semibold hover:underline">
                        {selectedTeacher.phone}
                      </a>
                    </div>
                  )}
                  {selectedTeacher.whatsapp && (
                    <div className="flex items-center justify-between">
                      <span className="text-gray-600 font-medium">WhatsApp:</span>
                      <a href={`https://wa.me/${selectedTeacher.whatsapp.replace(/[^0-9]/g, '')}`} target="_blank" rel="noopener noreferrer" className="text-green-600 font-semibold hover:underline">
                        {selectedTeacher.whatsapp}
                      </a>
                    </div>
                  )}
                  {selectedTeacher.email && (
                    <div className="flex items-start justify-between">
                      <span className="text-gray-600 font-medium">Email:</span>
                      <a href={`mailto:${selectedTeacher.email}`} className="text-blue-600 font-semibold hover:underline text-right break-all">
                        {selectedTeacher.email}
                      </a>
                    </div>
                  )}
                  {selectedTeacher.driveLink && (
                    <div className="flex items-center justify-between">
                      <span className="text-gray-600 font-medium">üìÅ Drive Folder:</span>
                      <a href={selectedTeacher.driveLink} target="_blank" rel="noopener noreferrer" className="text-blue-600 font-semibold hover:underline">
                        Open Folder ‚Üí
                      </a>
                    </div>
                  )}
                </div>
              </div>

              {/* Personal Information */}
              <div>
                <div className="text-lg font-bold mb-3 flex items-center gap-2">
                  <span>üë§</span> Personal Information
                </div>
                <div className="bg-gray-50 rounded-xl p-4 space-y-3">
                  <div className="flex items-center justify-between">
                    <span className="text-gray-600 font-medium">Class:</span>
                    <span className="font-semibold">{selectedTeacher.grade || 'Class 11 & 12'}</span>
                  </div>
                  {selectedTeacher.dateOfBirth && (
                    <div className="flex items-center justify-between">
                      <span className="text-gray-600 font-medium">Date of Birth:</span>
                      <span className="font-semibold">
                        {new Date(selectedTeacher.dateOfBirth).toLocaleDateString('en-IN', { day: 'numeric', month: 'long', year: 'numeric' })}
                      </span>
                    </div>
                  )}
                  {selectedTeacher.dateOfJoining && (
                    <div className="flex items-center justify-between">
                      <span className="text-gray-600 font-medium">Date of Joining:</span>
                      <span className="font-semibold">
                        {new Date(selectedTeacher.dateOfJoining).toLocaleDateString('en-IN', { day: 'numeric', month: 'long', year: 'numeric' })}
                      </span>
                    </div>
                  )}
                  {selectedTeacher.anniversary && (
                    <div className="flex items-center justify-between">
                      <span className="text-gray-600 font-medium">Anniversary:</span>
                      <span className="font-semibold">
                        {new Date(selectedTeacher.anniversary).toLocaleDateString('en-IN', { day: 'numeric', month: 'long' })}
                      </span>
                    </div>
                  )}
                </div>
              </div>

              {/* Additional Details */}
              {(selectedTeacher.additionalDetails || selectedTeacher.qualification || selectedTeacher.experience || selectedTeacher.bio) && (
                <div>
                  <div className="text-lg font-bold mb-3 flex items-center gap-2">
                    <span>üìù</span> Additional Information
                  </div>
                  <div className="bg-gray-50 rounded-xl p-4 space-y-3">
                    {selectedTeacher.qualification && (
                      <div>
                        <span className="text-gray-600 font-medium">Qualification:</span>
                        <div className="font-semibold mt-1">{selectedTeacher.qualification}</div>
                      </div>
                    )}
                    {selectedTeacher.experience && (
                      <div>
                        <span className="text-gray-600 font-medium">Experience:</span>
                        <div className="font-semibold mt-1">{selectedTeacher.experience}</div>
                      </div>
                    )}
                    {selectedTeacher.bio && (
                      <div>
                        <span className="text-gray-600 font-medium">About:</span>
                        <div className="font-semibold mt-1">{selectedTeacher.bio}</div>
                      </div>
                    )}
                    {selectedTeacher.additionalDetails && (
                      <div>
                        <span className="text-gray-600 font-medium">Notes:</span>
                        <div className="font-semibold mt-1">{selectedTeacher.additionalDetails}</div>
                      </div>
                    )}
                  </div>
                </div>
              )}

              {/* Action Buttons */}
              <div className="grid grid-cols-2 gap-3 pt-4">
                {selectedTeacher.phone && (
                  <a
                    href={`tel:${selectedTeacher.phone}`}
                    className="bg-blue-500 text-white px-4 py-3 rounded-xl font-semibold text-center hover:bg-blue-600 transition-colors"
                  >
                    üì± Call
                  </a>
                )}
                {selectedTeacher.whatsapp && (
                  <a
                    href={`https://wa.me/${selectedTeacher.whatsapp.replace(/[^0-9]/g, '')}`}
                    target="_blank"
                    rel="noopener noreferrer"
                    className="bg-green-500 text-white px-4 py-3 rounded-xl font-semibold text-center hover:bg-green-600 transition-colors"
                  >
                    üí¨ WhatsApp
                  </a>
                )}
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
function OrgChartDirectory({ teachers, currentUser }) {
  const [managers, setManagers] = useState([]);
  const [apcs, setApcs] = useState([]);
  const [allTeachers, setAllTeachers] = useState([]); // ‚úÖ FIX: Fetch all teachers directly
  const [selectedMember, setSelectedMember] = useState(null);
  const [loading, setLoading] = useState(true);
  
  // Filter states
  const [searchQuery, setSearchQuery] = useState('');
  const [filterSchool, setFilterSchool] = useState('all');
  const [filterRole, setFilterRole] = useState('all');
  const [filterSubject, setFilterSubject] = useState('all');
  const [filterManager, setFilterManager] = useState('all');

  useEffect(() => {
    const fetchData = async () => {
      try {
        setLoading(true);
        
        // ‚úÖ FIX: Fetch ALL data directly for directory (not filtered by school)
        const [managersSnap, apcsSnap, teachersSnap] = await Promise.all([
          db.collection('managers').get(),
          db.collection('apcs').get(),
          db.collection('teachers').get() // Fetch ALL teachers
        ]);
        
        const managersData = managersSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        setManagers(managersData);

        const apcsData = apcsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        setApcs(apcsData);
        
        // ‚úÖ FIX: Store all teachers
        const teachersData = teachersSnap.docs.map(doc => ({ docId: doc.id, ...doc.data() }));
        setAllTeachers(teachersData);
        
      } catch (error) {
        console.error('Error:', error);
      } finally {
        setLoading(false);
      }
    };
    fetchData();
  }, []);

  // Get all members combined
  const allMembers = useMemo(() => {
    const members = [];
    
    // Add managers (APH, PM, APM)
    managers.filter(m => m.status === 'active').forEach(m => {
      members.push({
        ...m,
        memberType: m.role,
        displayRole: m.role === 'aph' ? 'Program Head (APH)' :
                    m.role === 'pm' ? 'Program Manager (PM)' :
                    m.role === 'apm' ? 'Associate Program Manager (APM)' : m.role,
        sortOrder: m.role === 'aph' ? 1 : m.role === 'pm' ? 2 : m.role === 'apm' ? 3 : 4
      });
    });
    
    // Add APCs
    apcs.forEach(a => {
      members.push({
        ...a,
        memberType: 'apc',
        displayRole: 'Academic Program Coordinator (APC)',
        sortOrder: 5
      });
    });
    
    // ‚úÖ FIX: Use allTeachers (fetched directly) instead of filtered teachers prop
    allTeachers.filter(t => !t.isArchived && t.name?.toLowerCase() !== 'vacant').forEach(t => {
      members.push({
        ...t,
        memberType: 'teacher',
        displayRole: t.subject ? `${t.subject} Teacher` : 'Teacher',
        sortOrder: 6
      });
    });
    
    // Sort by role hierarchy, then by name
    return members.sort((a, b) => {
      if (a.sortOrder !== b.sortOrder) return a.sortOrder - b.sortOrder;
      return (a.name || '').localeCompare(b.name || '');
    });
  }, [managers, apcs, allTeachers]);

  // Get unique values for filter dropdowns
  const filterOptions = useMemo(() => {
    const schools = new Set();
    const subjects = new Set();
    
    allMembers.forEach(m => {
      if (m.school) schools.add(m.school);
      if (m.directSchools) m.directSchools.forEach(s => schools.add(s));
      if (m.subject) subjects.add(m.subject);
    });
    
    return {
      schools: Array.from(schools).sort(),
      subjects: Array.from(subjects).sort(),
      managers: managers.filter(m => m.status === 'active' && ['pm', 'apm'].includes(m.role))
    };
  }, [allMembers, managers]);

  // Get manager info for a member
  const getMemberManager = (member) => {
    if (member.memberType === 'teacher' || member.memberType === 'apc') {
      // Find which manager handles this school
      const school = member.school;
      if (!school) return null;
      
      // Check APMs first
      const apm = managers.find(m => m.role === 'apm' && m.directSchools?.includes(school));
      if (apm) return apm;
      
      // Then check PMs
      const pm = managers.find(m => m.role === 'pm' && m.directSchools?.includes(school));
      if (pm) return pm;
    }
    return null;
  };

  // Filter members
  const filteredMembers = useMemo(() => {
    return allMembers.filter(m => {
      // Search filter
      const matchesSearch = !searchQuery || 
        m.name?.toLowerCase().includes(searchQuery.toLowerCase()) ||
        m.email?.toLowerCase().includes(searchQuery.toLowerCase()) ||
        m.school?.toLowerCase().includes(searchQuery.toLowerCase()) ||
        m.afid?.toLowerCase().includes(searchQuery.toLowerCase()) ||
        m.afCode?.toLowerCase().includes(searchQuery.toLowerCase()) ||
        m.phone?.includes(searchQuery) ||
        m.whatsapp?.includes(searchQuery);
      
      // Role filter
      const matchesRole = filterRole === 'all' || m.memberType === filterRole;
      
      // School filter
      let matchesSchool = filterSchool === 'all';
      if (!matchesSchool) {
        if (m.school === filterSchool) matchesSchool = true;
        if (m.directSchools?.includes(filterSchool)) matchesSchool = true;
      }
      
      // Subject filter (only for teachers)
      const matchesSubject = filterSubject === 'all' || m.subject === filterSubject;
      
      // Manager filter
      let matchesManager = filterManager === 'all';
      if (!matchesManager) {
        const memberManager = getMemberManager(m);
        if (memberManager?.id === filterManager) matchesManager = true;
        // Also show the manager themselves
        if (m.id === filterManager) matchesManager = true;
        // Show members under this manager's schools
        const selectedManager = managers.find(mgr => mgr.id === filterManager);
        if (selectedManager?.directSchools?.includes(m.school)) matchesManager = true;
      }
      
      return matchesSearch && matchesRole && matchesSchool && matchesSubject && matchesManager;
    });
  }, [allMembers, searchQuery, filterRole, filterSchool, filterSubject, filterManager, managers]);

  // Get role badge color
  const getRoleColor = (role) => ({
    'aph': { bg: 'bg-purple-100', text: 'text-purple-700', border: 'border-purple-500', gradient: 'from-purple-500 to-purple-600' },
    'pm': { bg: 'bg-blue-100', text: 'text-blue-700', border: 'border-blue-500', gradient: 'from-blue-500 to-blue-600' },
    'apm': { bg: 'bg-green-100', text: 'text-green-700', border: 'border-green-500', gradient: 'from-green-500 to-green-600' },
    'apc': { bg: 'bg-orange-100', text: 'text-orange-700', border: 'border-orange-500', gradient: 'from-orange-500 to-orange-600' },
    'teacher': { bg: 'bg-pink-100', text: 'text-pink-700', border: 'border-pink-500', gradient: 'from-pink-500 to-pink-600' }
  }[role] || { bg: 'bg-gray-100', text: 'text-gray-700', border: 'border-gray-500', gradient: 'from-gray-500 to-gray-600' });

  const getSubjectColor = (subject) => ({
    'Physics': '#3b82f6',
    'Chemistry': '#8b5cf6', 
    'Mathematics': '#ef4444',
    'Maths': '#ef4444',
    'Biology': '#10b981',
    'Bio': '#10b981'
  }[subject] || '#6b7280');

  // Clear all filters
  const clearFilters = () => {
    setSearchQuery('');
    setFilterSchool('all');
    setFilterRole('all');
    setFilterSubject('all');
    setFilterManager('all');
  };

  const hasActiveFilters = searchQuery || filterSchool !== 'all' || filterRole !== 'all' || filterSubject !== 'all' || filterManager !== 'all';

  if (loading) {
    return (
      <div className="flex items-center justify-center h-64">
        <div className="animate-spin rounded-full h-12 w-12 border-4 border-yellow-500 border-t-transparent"></div>
      </div>
    );
  }

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
        <div className="inline-flex items-center gap-3 bg-gradient-to-r from-yellow-100 via-orange-100 to-red-100 px-6 py-3 rounded-full shadow-lg">
          <span className="text-3xl">üë•</span>
          <h2 className="text-2xl md:text-3xl font-bold bg-gradient-to-r from-yellow-600 via-orange-600 to-red-600 bg-clip-text text-transparent">
            Team Directory
          </h2>
        </div>
        <div className="text-sm text-gray-500">
          {filteredMembers.length} of {allMembers.length} members
        </div>
      </div>

      {/* Search & Filters */}
      <div className="bg-white rounded-2xl p-4 shadow-lg border border-gray-100">
        {/* Search Bar */}
        <div className="mb-4">
          <div className="relative">
            <span className="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 text-xl">üîç</span>
            <input
              type="text"
              placeholder="Search by name, email, phone, AFID..."
              value={searchQuery}
              onChange={e => setSearchQuery(e.target.value)}
              className="w-full pl-12 pr-4 py-3 rounded-xl border-2 border-gray-200 focus:border-yellow-400 focus:outline-none text-lg"
            />
            {searchQuery && (
              <button 
                onClick={() => setSearchQuery('')}
                className="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600"
              >
                ‚úï
              </button>
            )}
          </div>
        </div>

        {/* Filter Dropdowns */}
        <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
          {/* School Filter */}
          <div>
            <label className="block text-xs font-semibold text-gray-500 mb-1 ml-1">üè´ School</label>
            <select
              value={filterSchool}
              onChange={e => setFilterSchool(e.target.value)}
              className="w-full px-3 py-2 rounded-lg border-2 border-gray-200 bg-white focus:border-yellow-400 focus:outline-none text-sm"
            >
              <option value="all">All Schools</option>
              {filterOptions.schools.map(school => (
                <option key={school} value={school}>{school}</option>
              ))}
            </select>
          </div>

          {/* Role Filter */}
          <div>
            <label className="block text-xs font-semibold text-gray-500 mb-1 ml-1">üë§ Role</label>
            <select
              value={filterRole}
              onChange={e => setFilterRole(e.target.value)}
              className="w-full px-3 py-2 rounded-lg border-2 border-gray-200 bg-white focus:border-yellow-400 focus:outline-none text-sm"
            >
              <option value="all">All Roles</option>
              <option value="aph">Program Head (APH)</option>
              <option value="pm">Program Manager (PM)</option>
              <option value="apm">Associate PM (APM)</option>
              <option value="apc">Coordinator (APC)</option>
              <option value="teacher">Teachers</option>
            </select>
          </div>

          {/* Subject Filter */}
          <div>
            <label className="block text-xs font-semibold text-gray-500 mb-1 ml-1">üìö Subject</label>
            <select
              value={filterSubject}
              onChange={e => setFilterSubject(e.target.value)}
              className="w-full px-3 py-2 rounded-lg border-2 border-gray-200 bg-white focus:border-yellow-400 focus:outline-none text-sm"
            >
              <option value="all">All Subjects</option>
              {filterOptions.subjects.map(subject => (
                <option key={subject} value={subject}>{subject}</option>
              ))}
            </select>
          </div>

          {/* Manager Filter */}
          <div>
            <label className="block text-xs font-semibold text-gray-500 mb-1 ml-1">üë®‚Äçüíº Manager</label>
            <select
              value={filterManager}
              onChange={e => setFilterManager(e.target.value)}
              className="w-full px-3 py-2 rounded-lg border-2 border-gray-200 bg-white focus:border-yellow-400 focus:outline-none text-sm"
            >
              <option value="all">All Managers</option>
              {filterOptions.managers.map(mgr => (
                <option key={mgr.id} value={mgr.id}>
                  {mgr.name} ({mgr.role === 'pm' ? 'PM' : 'APM'})
                </option>
              ))}
            </select>
          </div>
        </div>

        {/* Clear Filters */}
        {hasActiveFilters && (
          <div className="mt-3 flex items-center justify-between">
            <div className="flex flex-wrap gap-2">
              {searchQuery && (
                <span className="inline-flex items-center gap-1 bg-yellow-100 text-yellow-700 px-2 py-1 rounded-full text-xs">
                  Search: "{searchQuery}" <button onClick={() => setSearchQuery('')}>‚úï</button>
                </span>
              )}
              {filterSchool !== 'all' && (
                <span className="inline-flex items-center gap-1 bg-blue-100 text-blue-700 px-2 py-1 rounded-full text-xs">
                  üè´ {filterSchool} <button onClick={() => setFilterSchool('all')}>‚úï</button>
                </span>
              )}
              {filterRole !== 'all' && (
                <span className="inline-flex items-center gap-1 bg-purple-100 text-purple-700 px-2 py-1 rounded-full text-xs">
                  üë§ {filterRole.toUpperCase()} <button onClick={() => setFilterRole('all')}>‚úï</button>
                </span>
              )}
              {filterSubject !== 'all' && (
                <span className="inline-flex items-center gap-1 bg-green-100 text-green-700 px-2 py-1 rounded-full text-xs">
                  üìö {filterSubject} <button onClick={() => setFilterSubject('all')}>‚úï</button>
                </span>
              )}
              {filterManager !== 'all' && (
                <span className="inline-flex items-center gap-1 bg-orange-100 text-orange-700 px-2 py-1 rounded-full text-xs">
                  üë®‚Äçüíº {managers.find(m => m.id === filterManager)?.name} <button onClick={() => setFilterManager('all')}>‚úï</button>
                </span>
              )}
            </div>
            <button 
              onClick={clearFilters}
              className="text-sm text-red-500 hover:text-red-700 font-medium"
            >
              Clear All
            </button>
          </div>
        )}
      </div>

      {/* Members Grid */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        {filteredMembers.map((member, idx) => {
          const roleColor = getRoleColor(member.memberType);
          const memberManager = getMemberManager(member);
          
          return (
            <div 
              key={member.id || idx}
              className={`bg-white rounded-xl p-4 shadow-md hover:shadow-xl transition-all cursor-pointer border-l-4 ${roleColor.border} hover:-translate-y-1`}
              onClick={() => setSelectedMember(member)}
            >
              <div className="flex items-start gap-3">
                {/* Profile Photo */}
                {member.profilePhoto ? (
                  <img src={member.profilePhoto} alt="" className="w-14 h-14 rounded-full object-cover border-2 border-gray-200 flex-shrink-0" />
                ) : (
                  <div className={`w-14 h-14 rounded-full bg-gradient-to-br ${roleColor.gradient} flex items-center justify-center text-xl font-bold text-white flex-shrink-0`}>
                    {member.name?.charAt(0) || '?'}
                  </div>
                )}
                
                {/* Info */}
                <div className="flex-1 min-w-0">
                  <div className="font-bold text-gray-800 truncate">{member.name}</div>
                  <div className={`text-xs px-2 py-0.5 rounded-full inline-block ${roleColor.bg} ${roleColor.text} font-medium mt-1`}>
                    {member.displayRole}
                  </div>
                  
                  {/* School */}
                  {member.school && (
                    <div className="text-sm text-gray-500 mt-1 truncate flex items-center gap-1">
                      <span>üè´</span> {member.school}
                    </div>
                  )}
                  
                  {/* Manages Schools (for managers) */}
                  {member.directSchools?.length > 0 && (
                    <div className="text-xs text-gray-400 mt-1 truncate">
                      Manages: {member.directSchools.slice(0, 2).join(', ')}{member.directSchools.length > 2 ? ` +${member.directSchools.length - 2}` : ''}
                    </div>
                  )}
                  
                  {/* Subject badge for teachers */}
                  {member.subject && (
                    <span 
                      className="inline-block mt-1 text-xs px-2 py-0.5 rounded-full text-white font-medium"
                      style={{background: getSubjectColor(member.subject)}}
                    >
                      {member.subject}
                    </span>
                  )}
                </div>
              </div>

              {/* Quick Contact */}
              <div className="mt-3 pt-3 border-t border-gray-100 flex flex-wrap gap-2">
                {/* Last Active Badge */}
                <LastActiveBadge userId={member.afid || member.uid || member.id || member.email} />
                
                {member.phone && (
                  <a 
                    href={`tel:${member.phone}`} 
                    onClick={e => e.stopPropagation()} 
                    className="text-xs bg-blue-50 text-blue-600 px-2 py-1 rounded-full hover:bg-blue-100 flex items-center gap-1"
                  >
                    üì± Call
                  </a>
                )}
                {member.whatsapp && (
                  <a 
                    href={`https://wa.me/${member.whatsapp.replace(/[^0-9]/g, '')}`} 
                    target="_blank" 
                    onClick={e => e.stopPropagation()} 
                    className="text-xs bg-green-50 text-green-600 px-2 py-1 rounded-full hover:bg-green-100 flex items-center gap-1"
                  >
                    üí¨ WhatsApp
                  </a>
                )}
                {member.email && (
                  <a 
                    href={`mailto:${member.email}`} 
                    onClick={e => e.stopPropagation()} 
                    className="text-xs bg-purple-50 text-purple-600 px-2 py-1 rounded-full hover:bg-purple-100 flex items-center gap-1"
                  >
                    üìß Email
                  </a>
                )}
                {!member.phone && !member.whatsapp && !member.email && (
                  <span className="text-xs text-gray-400">No contact info</span>
                )}
              </div>
              
              {/* Reports To (for teachers/APCs) */}
              {memberManager && (
                <div className="mt-2 text-xs text-gray-400 flex items-center gap-1">
                  <span>‚Ü≥</span> Reports to: <span className="font-medium text-gray-600">{memberManager.name}</span>
                </div>
              )}
            </div>
          );
        })}
        
        {/* No Results */}
        {filteredMembers.length === 0 && (
          <div className="col-span-full text-center py-16 text-gray-500">
            <div className="text-6xl mb-4">üîç</div>
            <p className="text-xl font-semibold">No members found</p>
            <p className="text-sm mt-2">Try adjusting your filters</p>
            {hasActiveFilters && (
              <button 
                onClick={clearFilters}
                className="mt-4 px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600"
              >
                Clear All Filters
              </button>
            )}
          </div>
        )}
      </div>

      {/* Member Details Modal */}
      {selectedMember && (
        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4" onClick={() => setSelectedMember(null)}>
          <div className="bg-white rounded-3xl max-w-lg w-full max-h-[90vh] overflow-y-auto shadow-2xl" onClick={e => e.stopPropagation()}>
            {/* Header */}
            <div className="p-6 text-white rounded-t-3xl relative" style={{ 
              background: `linear-gradient(135deg, ${
                selectedMember.memberType === 'aph' ? '#8b5cf6, #7c3aed' :
                selectedMember.memberType === 'pm' ? '#3b82f6, #2563eb' :
                selectedMember.memberType === 'apm' ? '#10b981, #059669' :
                selectedMember.memberType === 'apc' ? '#f59e0b, #d97706' :
                getSubjectColor(selectedMember.subject) + ', ' + getSubjectColor(selectedMember.subject) + 'cc'
              })`
            }}>
              <button 
                onClick={() => setSelectedMember(null)} 
                className="absolute top-4 right-4 w-10 h-10 rounded-full bg-white/20 hover:bg-white/30 flex items-center justify-center text-xl font-bold"
              >
                ‚úï
              </button>
              <div className="flex items-center gap-4">
                {selectedMember.profilePhoto ? (
                  <img src={selectedMember.profilePhoto} alt="" className="w-20 h-20 rounded-2xl object-cover border-4 border-white/30" />
                ) : (
                  <div className="w-20 h-20 rounded-2xl bg-white/20 flex items-center justify-center text-4xl font-bold">
                    {selectedMember.name?.charAt(0)}
                  </div>
                )}
                <div>
                  <h3 className="text-2xl font-bold">{selectedMember.name}</h3>
                  <p className="opacity-90">{selectedMember.displayRole}</p>
                </div>
              </div>
            </div>

            {/* Details */}
            <div className="p-5 space-y-3">
              {/* AFID / AF Code */}
              {(selectedMember.afid || selectedMember.afCode) && (
                <div className="flex items-center gap-3 p-3 bg-purple-50 rounded-xl">
                  <span className="text-xl">üÜî</span>
                  <div>
                    <div className="text-xs text-gray-500">AF ID / Code</div>
                    <div className="font-semibold">{selectedMember.afid || selectedMember.afCode}</div>
                  </div>
                </div>
              )}
              
              {/* School */}
              {selectedMember.school && (
                <div className="flex items-center gap-3 p-3 bg-yellow-50 rounded-xl">
                  <span className="text-xl">üè´</span>
                  <div>
                    <div className="text-xs text-gray-500">School</div>
                    <div className="font-semibold">{selectedMember.school}</div>
                  </div>
                </div>
              )}
              
              {/* Manages Schools */}
              {selectedMember.directSchools?.length > 0 && (
                <div className="flex items-start gap-3 p-3 bg-yellow-50 rounded-xl">
                  <span className="text-xl">üè´</span>
                  <div>
                    <div className="text-xs text-gray-500">Manages Schools</div>
                    <div className="font-semibold">{selectedMember.directSchools.join(', ')}</div>
                  </div>
                </div>
              )}
              
              {/* Subject */}
              {selectedMember.subject && (
                <div className="flex items-center gap-3 p-3 bg-blue-50 rounded-xl">
                  <span className="text-xl">üìö</span>
                  <div>
                    <div className="text-xs text-gray-500">Subject</div>
                    <div className="font-semibold">{selectedMember.subject}</div>
                  </div>
                </div>
              )}
              
              {/* Bio */}
              {selectedMember.bio && (
                <div className="flex items-start gap-3 p-3 bg-gray-50 rounded-xl">
                  <span className="text-xl">üìù</span>
                  <div>
                    <div className="text-xs text-gray-500">About</div>
                    <div className="font-medium text-sm">{selectedMember.bio}</div>
                  </div>
                </div>
              )}
              
              {/* Qualification */}
              {selectedMember.qualification && (
                <div className="flex items-center gap-3 p-3 bg-orange-50 rounded-xl">
                  <span className="text-xl">üéì</span>
                  <div>
                    <div className="text-xs text-gray-500">Qualification</div>
                    <div className="font-semibold">{selectedMember.qualification}</div>
                  </div>
                </div>
              )}
              
              {/* Experience */}
              {selectedMember.experience && (
                <div className="flex items-center gap-3 p-3 bg-amber-50 rounded-xl">
                  <span className="text-xl">üíº</span>
                  <div>
                    <div className="text-xs text-gray-500">Experience</div>
                    <div className="font-semibold">{selectedMember.experience}</div>
                  </div>
                </div>
              )}
              
              {/* Email */}
              {selectedMember.email && (
                <div className="flex items-center gap-3 p-3 bg-indigo-50 rounded-xl">
                  <span className="text-xl">üìß</span>
                  <div>
                    <div className="text-xs text-gray-500">Email</div>
                    <a href={`mailto:${selectedMember.email}`} className="font-semibold text-blue-600 hover:underline break-all">{selectedMember.email}</a>
                  </div>
                </div>
              )}
              
              {/* Phone */}
              {selectedMember.phone && (
                <div className="flex items-center gap-3 p-3 bg-cyan-50 rounded-xl">
                  <span className="text-xl">üì±</span>
                  <div>
                    <div className="text-xs text-gray-500">Phone Number</div>
                    <a href={`tel:${selectedMember.phone}`} className="font-semibold text-blue-600 hover:underline">{selectedMember.phone}</a>
                  </div>
                </div>
              )}
              
              {/* WhatsApp */}
              {selectedMember.whatsapp && (
                <div className="flex items-center gap-3 p-3 bg-green-50 rounded-xl">
                  <span className="text-xl">üí¨</span>
                  <div>
                    <div className="text-xs text-gray-500">WhatsApp</div>
                    <a href={`https://wa.me/${selectedMember.whatsapp.replace(/[^0-9]/g, '')}`} target="_blank" className="font-semibold text-green-600 hover:underline">{selectedMember.whatsapp}</a>
                  </div>
                </div>
              )}
              
              {/* Birthday */}
              {(selectedMember.dateOfBirth || selectedMember.dob) && (
                <div className="flex items-center gap-3 p-3 bg-pink-50 rounded-xl">
                  <span className="text-xl">üéÇ</span>
                  <div>
                    <div className="text-xs text-gray-500">Birthday</div>
                    <div className="font-semibold">{new Date(selectedMember.dateOfBirth || selectedMember.dob).toLocaleDateString('en-IN', { day: 'numeric', month: 'long' })}</div>
                  </div>
                </div>
              )}
              
              {/* Joining Date */}
              {selectedMember.joiningDate && (
                <div className="flex items-center gap-3 p-3 bg-teal-50 rounded-xl">
                  <span className="text-xl">üìÖ</span>
                  <div>
                    <div className="text-xs text-gray-500">Joined Avanti</div>
                    <div className="font-semibold">{new Date(selectedMember.joiningDate).toLocaleDateString('en-IN', { day: 'numeric', month: 'long', year: 'numeric' })}</div>
                  </div>
                </div>
              )}
              
              {/* Drive Link */}
              {selectedMember.driveLink && (
                <div className="flex items-center gap-3 p-3 bg-sky-50 rounded-xl">
                  <span className="text-xl">üìÅ</span>
                  <div>
                    <div className="text-xs text-gray-500">Drive Folder</div>
                    <a href={selectedMember.driveLink} target="_blank" className="font-semibold text-blue-600 hover:underline">Open Folder ‚Üí</a>
                  </div>
                </div>
              )}

              {/* Action Buttons */}
              {(selectedMember.phone || selectedMember.whatsapp || selectedMember.email) && (
                <div className="grid grid-cols-3 gap-2 pt-3">
                  {selectedMember.phone && (
                    <a href={`tel:${selectedMember.phone}`} className="bg-gradient-to-r from-blue-500 to-blue-600 text-white py-3 rounded-xl font-semibold text-center hover:shadow-lg text-sm flex items-center justify-center gap-1">
                      üì± Call
                    </a>
                  )}
                  {selectedMember.whatsapp && (
                    <a href={`https://wa.me/${selectedMember.whatsapp.replace(/[^0-9]/g, '')}`} target="_blank" className="bg-gradient-to-r from-green-500 to-green-600 text-white py-3 rounded-xl font-semibold text-center hover:shadow-lg text-sm flex items-center justify-center gap-1">
                      üí¨ WhatsApp
                    </a>
                  )}
                  {selectedMember.email && (
                    <a href={`mailto:${selectedMember.email}`} className="bg-gradient-to-r from-purple-500 to-purple-600 text-white py-3 rounded-xl font-semibold text-center hover:shadow-lg text-sm flex items-center justify-center gap-1">
                      üìß Email
                    </a>
                  )}
                </div>
              )}
            </div>
          </div>
        </div>
      )}
    </div>
  );
}




// ========================================
// SOCIAL WALL - WITH CELEBRATIONS
// ========================================
function SocialWall({ teachers, currentUser }) {
  const [posts, setPosts] = useState([]);
  const [birthdays, setBirthdays] = useState([]);
  const [upcomingBirthdays, setUpcomingBirthdays] = useState([]);
  const [weekBirthdays, setWeekBirthdays] = useState([]);
  const [monthBirthdays, setMonthBirthdays] = useState([]);
  const [anniversaries, setAnniversaries] = useState([]);
  const [weekAnniversaries, setWeekAnniversaries] = useState([]);
  const [monthAnniversaries, setMonthAnniversaries] = useState([]);
  const [showNewPost, setShowNewPost] = useState(false);
  const [newPostContent, setNewPostContent] = useState('');
  const [posting, setPosting] = useState(false);
  const [loading, setLoading] = useState(true);
  const [showBirthdayPopup, setShowBirthdayPopup] = useState(null);
  const [allMembers, setAllMembers] = useState([]);
  const [activeTab, setActiveTab] = useState('feed'); // 'feed', 'celebrations', or 'recognition'
  const [celebrationReactions, setCelebrationReactions] = useState({});
  const [wishMessage, setWishMessage] = useState('');
  const [showWishInput, setShowWishInput] = useState(null);
  
  // ‚úÖ NEW: State for Educator of the Month recognition
  const [topPerformers, setTopPerformers] = useState([]);
  const [previousMonthWinners, setPreviousMonthWinners] = useState([]);
  const [recognitionLoading, setRecognitionLoading] = useState(false);
  
  // New state for image attachments and replies
  const [postImage, setPostImage] = useState(null);
  const [postImagePreview, setPostImagePreview] = useState(null);
  const [uploadingImage, setUploadingImage] = useState(false);
  const [replyingTo, setReplyingTo] = useState(null);
  const [replyContent, setReplyContent] = useState('');
  const [replyImage, setReplyImage] = useState(null);
  const [replyImagePreview, setReplyImagePreview] = useState(null);
  const [showGifPicker, setShowGifPicker] = useState(null);
  const [expandedReplies, setExpandedReplies] = useState({});
  
  // ‚úÖ NEW: Edit state for posts and comments
  const [editingPost, setEditingPost] = useState(null);
  const [editPostContent, setEditPostContent] = useState('');
  const [editingComment, setEditingComment] = useState(null); // {postId, commentId}
  const [editCommentContent, setEditCommentContent] = useState('');
  
  // ‚úÖ Check if user is admin/moderator
  const isAdminOrModerator = currentUser?.role === 'super_admin' || 
                             currentUser?.role === 'aph' || 
                             currentUser?.role === 'pm' ||
                             currentUser?.isSuperAdmin === true;

  // Compress image for faster uploads
  // ‚úÖ FIX: Added error handling and timeout to prevent infinite loading on iOS
  const compressImage = (file, maxWidth = 1200, quality = 0.7) => {
    return new Promise((resolve, reject) => {
      // ‚úÖ FIX: Add timeout to prevent infinite loading (10 seconds max)
      const timeoutId = setTimeout(() => {
        console.warn('[compressImage] Timeout - returning original file');
        resolve(file); // Return original file on timeout
      }, 10000);
      
      // If file is small enough, return as-is
      if (file.size < 200 * 1024) { // Less than 200KB
        clearTimeout(timeoutId);
        resolve(file);
        return;
      }
      
      try {
        const reader = new FileReader();
        
        // ‚úÖ FIX: Handle FileReader errors
        reader.onerror = () => {
          clearTimeout(timeoutId);
          console.warn('[compressImage] FileReader error - returning original file');
          resolve(file); // Return original on error instead of hanging
        };
        
        reader.onload = (e) => {
          const img = new Image();
          
          // ‚úÖ FIX: Handle image load errors (common on iOS Safari)
          img.onerror = () => {
            clearTimeout(timeoutId);
            console.warn('[compressImage] Image load error - returning original file');
            resolve(file);
          };
          
          img.onload = () => {
            try {
              const canvas = document.createElement('canvas');
              let width = img.width;
              let height = img.height;
              
              // Scale down if too large
              if (width > maxWidth) {
                height = (height * maxWidth) / width;
                width = maxWidth;
              }
              
              canvas.width = width;
              canvas.height = height;
              
              const ctx = canvas.getContext('2d');
              if (!ctx) {
                clearTimeout(timeoutId);
                console.warn('[compressImage] Canvas context error - returning original file');
                resolve(file);
                return;
              }
              
              ctx.drawImage(img, 0, 0, width, height);
              
              canvas.toBlob((blob) => {
                clearTimeout(timeoutId);
                // ‚úÖ FIX: Handle null blob (can happen on iOS)
                if (!blob) {
                  console.warn('[compressImage] toBlob returned null - returning original file');
                  resolve(file);
                  return;
                }
                const compressedFile = new File([blob], file.name, {
                  type: 'image/jpeg',
                  lastModified: Date.now()
                });
                console.log(`Compressed: ${(file.size/1024).toFixed(1)}KB ‚Üí ${(compressedFile.size/1024).toFixed(1)}KB`);
                resolve(compressedFile);
              }, 'image/jpeg', quality);
            } catch (canvasError) {
              clearTimeout(timeoutId);
              console.warn('[compressImage] Canvas error:', canvasError);
              resolve(file);
            }
          };
          img.src = e.target.result;
        };
        reader.readAsDataURL(file);
      } catch (error) {
        clearTimeout(timeoutId);
        console.warn('[compressImage] Unexpected error:', error);
        resolve(file);
      }
    });
  };

  // Handle image selection for posts (with compression)
  const handlePostImageSelect = async (e) => {
    const file = e.target.files?.[0];
    if (file) {
      if (file.size > 10 * 1024 * 1024) {
        alert('Image size should be less than 10MB');
        return;
      }
      
      // Show preview immediately
      const reader = new FileReader();
      reader.onloadend = () => setPostImagePreview(reader.result);
      reader.readAsDataURL(file);
      
      // Compress in background
      const compressed = await compressImage(file);
      setPostImage(compressed);
    }
  };

  // Handle image selection for replies (with compression)
  const handleReplyImageSelect = async (e) => {
    const file = e.target.files?.[0];
    if (file) {
      if (file.size > 10 * 1024 * 1024) {
        alert('Image size should be less than 10MB');
        return;
      }
      
      // Show preview immediately  
      const reader = new FileReader();
      reader.onloadend = () => setReplyImagePreview(reader.result);
      reader.readAsDataURL(file);
      
      // Compress in background
      const compressed = await compressImage(file);
      setReplyImage(compressed);
    }
  };

  // Upload image to Firebase Storage with base64 fallback for CORS issues
  const uploadImage = async (file, path) => {
    if (!file || typeof firebase === 'undefined') return null;
    
    try {
      // First try Firebase Storage
      const storageRef = firebase.storage().ref();
      const fileRef = storageRef.child(path + '/' + Date.now() + '_' + file.name);
      await fileRef.put(file);
      const url = await fileRef.getDownloadURL();
      console.log('[SocialWall] Image uploaded to Storage successfully');
      return url;
    } catch (e) {
      console.warn('[SocialWall] Storage upload failed (CORS?), trying base64 fallback:', e.message);
      
      // Fallback: Convert to base64 and store directly in Firestore
      try {
        const compressedFile = await compressImageForBase64(file);
        const base64 = await fileToBase64(compressedFile);
        
        // Check size - Firestore has 1MB document limit
        if (base64.length > 750000) {
          throw new Error('Image too large even after compression');
        }
        
        console.log('[SocialWall] Using base64 fallback, size:', Math.round(base64.length / 1024) + 'KB');
        return base64;
      } catch (fallbackError) {
        console.error('[SocialWall] Base64 fallback also failed:', fallbackError);
        alert('‚ö†Ô∏è Image upload failed. Please try:\\n\\n1. Use a smaller image\\n2. Check your internet connection\\n3. Try again');
        return null;
      }
    }
  };
  
  // Helper: Compress image more aggressively for base64 storage
  const compressImageForBase64 = async (file) => {
    return new Promise((resolve) => {
      const reader = new FileReader();
      reader.onload = (e) => {
        const img = new Image();
        img.onload = () => {
          const canvas = document.createElement('canvas');
          const maxSize = 600;
          let { width, height } = img;
          
          if (width > maxSize || height > maxSize) {
            if (width > height) {
              height = (height / width) * maxSize;
              width = maxSize;
            } else {
              width = (width / height) * maxSize;
              height = maxSize;
            }
          }
          
          canvas.width = width;
          canvas.height = height;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, width, height);
          canvas.toBlob(resolve, 'image/jpeg', 0.5);
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    });
  };
  
  // Helper: Convert file to base64 string
  const fileToBase64 = (file) => {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  };

  // Popular GIFs (predefined list to avoid API calls)
  const popularGifs = [
    'https://media.giphy.com/media/l0MYt5jPR6QX5pnqM/giphy.gif',
    'https://media.giphy.com/media/3oz8xIsloV7zOmt81G/giphy.gif',
    'https://media.giphy.com/media/BPJmthQ3YRwD6QqcVD/giphy.gif',
    'https://media.giphy.com/media/artj92V8o75VPL7AeQ/giphy.gif',
    'https://media.giphy.com/media/111ebonMs90YLu/giphy.gif',
    'https://media.giphy.com/media/KJ1f5iTl4Oo7u/giphy.gif',
    'https://media.giphy.com/media/3o7abKhOpu0NwenH3O/giphy.gif',
    'https://media.giphy.com/media/l3q2K5jinAlChoCLS/giphy.gif'
  ];

  // Celebration emojis for reactions
  const celebrationEmojis = ['üéâ', 'üéÇ', 'ü•≥', '‚ù§Ô∏è', 'üëè', 'üéä'];

  // Load celebration reactions
  const loadCelebrationReactions = async () => {
    try {
      const today = new Date().toISOString().split('T')[0];
      const reactionsSnap = await db.collection('celebrationReactions')
        .where('date', '==', today)
        .get();
      
      const reactions = {};
      reactionsSnap.docs.forEach(doc => {
        const data = doc.data();
        reactions[data.personId] = data;
      });
      setCelebrationReactions(reactions);
    } catch (e) {
      console.log('Could not load celebration reactions:', e);
    }
  };

  // Handle celebration reaction
  // ‚úÖ FIX: Handle undefined values to prevent Firebase errors
  const handleCelebrationReaction = async (person, emoji) => {
    const personId = person.afid || person.id || person.email || String(Date.now());
    const userId = currentUser.afid || currentUser.uid || currentUser.email || 'anonymous';
    const today = new Date().toISOString().split('T')[0];
    const docId = `${today}_${personId}`;
    
    try {
      const currentReactions = celebrationReactions[personId] || { reactions: {}, wishes: [] };
      const userReaction = currentReactions.reactions?.[userId];
      
      // Toggle reaction
      const newReactions = { ...currentReactions.reactions };
      if (userReaction === emoji) {
        delete newReactions[userId];
      } else {
        newReactions[userId] = emoji;
      }
      
      await db.collection('celebrationReactions').doc(docId).set({
        personId: personId,
        personName: person.name || 'Unknown',
        date: today,
        reactions: newReactions,
        wishes: currentReactions.wishes || [],
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge: true });
      
      // Update local state
      setCelebrationReactions(prev => ({
        ...prev,
        [personId]: { ...currentReactions, reactions: newReactions }
      }));
    } catch (e) {
      console.error('Reaction error:', e);
    }
  };

  // Send birthday/anniversary wish
  // ‚úÖ FIX: Handle undefined values to prevent Firebase arrayUnion errors
  const sendWish = async (person) => {
    if (!wishMessage.trim()) return;
    
    const personId = person.afid || person.id || person.email || String(Date.now());
    const userId = currentUser.afid || currentUser.uid || currentUser.email || 'anonymous';
    const today = new Date().toISOString().split('T')[0];
    const docId = `${today}_${personId}`;
    
    try {
      const currentReactions = celebrationReactions[personId] || { reactions: {}, wishes: [] };
      
      // ‚úÖ FIX: Create wish object WITHOUT undefined values (Firebase doesn't allow undefined in arrayUnion)
      const newWish = {
        odId: `wish_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`, // Unique ID for wish
        userId: userId,
        userName: currentUser.name || currentUser.email?.split('@')[0] || 'Anonymous',
        userPhoto: currentUser.profilePhoto || '', // Empty string instead of undefined
        message: wishMessage.trim(),
        timestamp: new Date().toISOString()
      };
      
      // ‚úÖ FIX: First get current wishes, then add new one (avoid arrayUnion with complex objects)
      const docRef = db.collection('celebrationReactions').doc(docId);
      const docSnap = await docRef.get();
      const existingData = docSnap.exists ? docSnap.data() : {};
      const existingWishes = existingData.wishes || [];
      
      await docRef.set({
        personId: personId,
        personName: person.name || 'Unknown',
        date: today,
        reactions: currentReactions.reactions || {},
        wishes: [...existingWishes, newWish],
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge: true });
      
      // Update local state
      setCelebrationReactions(prev => ({
        ...prev,
        [personId]: {
          ...currentReactions,
          wishes: [...(currentReactions.wishes || []), newWish]
        }
      }));
      
      setWishMessage('');
      setShowWishInput(null);
      alert('üéâ Your wish has been sent!');
    } catch (e) {
      console.error('Wish error:', e);
      alert('Failed to send wish. Please check your connection and try again.');
    }
  };

  // Get reaction counts for a person
  const getReactionCounts = (personId) => {
    const reactions = celebrationReactions[personId]?.reactions || {};
    const counts = {};
    Object.values(reactions).forEach(emoji => {
      counts[emoji] = (counts[emoji] || 0) + 1;
    });
    return counts;
  };

  // Check if current user reacted
  const getUserReaction = (personId) => {
    const userId = currentUser.afid || currentUser.uid || currentUser.email;
    return celebrationReactions[personId]?.reactions?.[userId];
  };

  useEffect(() => {
    const fetchData = async () => {
      try {
        setLoading(true);
        
        // Load managers
        const managersSnap = await db.collection('managers').get();
        const managers = managersSnap.docs.map(doc => ({ id: doc.id, ...doc.data(), role: 'Manager' }));
        
        // Load APCs
        const apcsSnap = await db.collection('apcs').get();
        const apcs = apcsSnap.docs.map(doc => ({ id: doc.id, ...doc.data(), role: 'APC' }));
        
        // Load teachers directly from Firestore to get all data including DOB
        const teachersSnap = await db.collection('teachers').get();
        const allTeachers = teachersSnap.docs.map(doc => ({ id: doc.id, ...doc.data(), role: 'Teacher' }));
        
        // Combine all members
        const combined = [...managers, ...apcs, ...allTeachers].filter(m => m.name && m.name.toLowerCase() !== 'vacant' && !m.isArchived);
        setAllMembers(combined);
        
        console.log('[SocialWall] Total members loaded:', combined.length);
        console.log('[SocialWall] Members with DOB:', combined.filter(m => m.dateOfBirth || m.dob).length);
        console.log('[SocialWall] Members with joiningDate:', combined.filter(m => m.joiningDate).length);

        const today = new Date();
        today.setHours(0, 0, 0, 0); // Reset time for accurate day comparison
        const todayMonth = today.getMonth(); // 0-indexed
        const todayDate = today.getDate();

        // Helper function to get days until birthday
        const getDaysUntilBday = (dobString) => {
          if (!dobString) return 999;
          const dob = new Date(dobString);
          const thisYearBday = new Date(today.getFullYear(), dob.getMonth(), dob.getDate());
          if (thisYearBday < today) {
            thisYearBday.setFullYear(today.getFullYear() + 1);
          }
          return Math.ceil((thisYearBday - today) / (1000 * 60 * 60 * 24));
        };

        // Today's birthdays
        const todayBirthdays = combined.filter(m => {
          const dobField = m.dateOfBirth || m.dob;
          if (!dobField) return false;
          const dob = new Date(dobField);
          return dob.getMonth() === todayMonth && dob.getDate() === todayDate;
        });
        setBirthdays(todayBirthdays);
        console.log('[SocialWall] Today birthdays:', todayBirthdays.length);

        // This Week's Birthdays (next 7 days including today)
        const thisWeekBdays = combined.filter(m => {
          const dobField = m.dateOfBirth || m.dob;
          if (!dobField) return false;
          const days = getDaysUntilBday(dobField);
          return days >= 0 && days <= 7;
        }).sort((a, b) => getDaysUntilBday(a.dateOfBirth || a.dob) - getDaysUntilBday(b.dateOfBirth || b.dob));
        setWeekBirthdays(thisWeekBdays);
        console.log('[SocialWall] This week birthdays:', thisWeekBdays.length);

        // This Month's Birthdays
        const thisMonthBdays = combined.filter(m => {
          const dobField = m.dateOfBirth || m.dob;
          if (!dobField) return false;
          const dob = new Date(dobField);
          return dob.getMonth() === todayMonth;
        }).sort((a, b) => {
          const aDay = new Date(a.dateOfBirth || a.dob).getDate();
          const bDay = new Date(b.dateOfBirth || b.dob).getDate();
          return aDay - bDay;
        });
        setMonthBirthdays(thisMonthBdays);
        console.log('[SocialWall] This month birthdays:', thisMonthBdays.length);

        // Upcoming birthdays (next 30 days, excluding today)
        const upcoming = combined.filter(m => {
          const dobField = m.dateOfBirth || m.dob;
          if (!dobField) return false;
          const days = getDaysUntilBday(dobField);
          return days > 0 && days <= 30;
        }).sort((a, b) => getDaysUntilBday(a.dateOfBirth || a.dob) - getDaysUntilBday(b.dateOfBirth || b.dob))
        .slice(0, 15);
        setUpcomingBirthdays(upcoming);
        console.log('[SocialWall] Upcoming birthdays (30 days):', upcoming.length);

        // Helper function to get days until anniversary
        const getDaysUntilAnniv = (joinDateString) => {
          if (!joinDateString) return 999;
          const jDate = new Date(joinDateString);
          // Check if at least 1 year has passed
          if (jDate.getFullYear() >= today.getFullYear()) return 999;
          const thisYearAnniv = new Date(today.getFullYear(), jDate.getMonth(), jDate.getDate());
          if (thisYearAnniv < today) {
            thisYearAnniv.setFullYear(today.getFullYear() + 1);
          }
          return Math.ceil((thisYearAnniv - today) / (1000 * 60 * 60 * 24));
        };

        // Today's Anniversaries
        const todayAnniversaries = combined.filter(m => {
          if (!m.joiningDate) return false;
          const j = new Date(m.joiningDate);
          // Must have at least 1 year at company
          if (j.getFullYear() >= today.getFullYear()) return false;
          return j.getMonth() === todayMonth && j.getDate() === todayDate;
        });
        setAnniversaries(todayAnniversaries);
        console.log('[SocialWall] Today anniversaries:', todayAnniversaries.length);

        // This Week's Anniversaries (next 7 days)
        const weekAnn = combined.filter(m => {
          if (!m.joiningDate) return false;
          const j = new Date(m.joiningDate);
          if (j.getFullYear() >= today.getFullYear()) return false;
          const days = getDaysUntilAnniv(m.joiningDate);
          return days >= 0 && days <= 7;
        }).sort((a, b) => getDaysUntilAnniv(a.joiningDate) - getDaysUntilAnniv(b.joiningDate));
        setWeekAnniversaries(weekAnn);
        console.log('[SocialWall] This week anniversaries:', weekAnn.length);

        // This Month's Anniversaries
        const monthAnn = combined.filter(m => {
          if (!m.joiningDate) return false;
          const j = new Date(m.joiningDate);
          if (j.getFullYear() >= today.getFullYear()) return false;
          return j.getMonth() === todayMonth;
        }).sort((a, b) => {
          const aDay = new Date(a.joiningDate).getDate();
          const bDay = new Date(b.joiningDate).getDate();
          return aDay - bDay;
        });
        setMonthAnniversaries(monthAnn);
        console.log('[SocialWall] This month anniversaries:', monthAnn.length);

        // Show birthday popup for today's birthdays
        if (todayBirthdays.length > 0) {
          const dismissedToday = localStorage.getItem('birthdayDismissed_' + today.toDateString());
          if (!dismissedToday) {
            setShowBirthdayPopup(todayBirthdays[0]);
          }
        }

        // Fetch posts
        const postsSnap = await db.collection('socialPosts')
          .orderBy('createdAt', 'desc')
          .limit(50)
          .get();
        
        setPosts(postsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() })));
      } catch (error) {
        console.error('[SocialWall] Error:', error);
      } finally {
        setLoading(false);
      }
    };

    fetchData();
    loadCelebrationReactions();
  }, [teachers]);

  // ‚úÖ NEW: Fetch Educator of the Month recognition data
  useEffect(() => {
    const fetchRecognitionData = async () => {
      if (activeTab !== 'recognition') return;
      
      setRecognitionLoading(true);
      try {
        const now = new Date();
        const currentMonth = now.toISOString().slice(0, 7);
        const currentStartDate = currentMonth + '-01';
        const currentEndDate = currentMonth + '-31';
        
        // Get previous month
        const prevMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
        const prevMonthStr = prevMonth.toISOString().slice(0, 7);
        const prevStartDate = prevMonthStr + '-01';
        const prevEndDate = prevMonthStr + '-31';
        
        // Fetch current month entries
        const currentMonthSnap = await db.collection('timesheetEntries')
          .where('date', '>=', currentStartDate)
          .where('date', '<=', currentEndDate)
          .where('status', '==', 'approved')
          .get();
        
        // Aggregate current month hours by teacher
        const currentTeacherHours = {};
        currentMonthSnap.docs.forEach(doc => {
          const data = doc.data();
          const key = data.teacherAfid;
          if (!currentTeacherHours[key]) {
            currentTeacherHours[key] = {
              afid: data.teacherAfid,
              name: data.teacherName,
              school: data.school,
              subject: data.subject,
              totalHours: 0,
              entries: 0
            };
          }
          currentTeacherHours[key].totalHours += parseFloat(data.hours) || 0;
          currentTeacherHours[key].entries += 1;
        });
        
        // Get top 2 performers for current month
        const sortedCurrent = Object.values(currentTeacherHours)
          .sort((a, b) => b.totalHours - a.totalHours)
          .slice(0, 2);
        setTopPerformers(sortedCurrent);
        
        // Fetch previous month entries for previous winners
        const prevMonthSnap = await db.collection('timesheetEntries')
          .where('date', '>=', prevStartDate)
          .where('date', '<=', prevEndDate)
          .where('status', '==', 'approved')
          .get();
        
        // Aggregate previous month hours
        const prevTeacherHours = {};
        prevMonthSnap.docs.forEach(doc => {
          const data = doc.data();
          const key = data.teacherAfid;
          if (!prevTeacherHours[key]) {
            prevTeacherHours[key] = {
              afid: data.teacherAfid,
              name: data.teacherName,
              school: data.school,
              subject: data.subject,
              totalHours: 0,
              entries: 0,
              month: prevMonthStr
            };
          }
          prevTeacherHours[key].totalHours += parseFloat(data.hours) || 0;
          prevTeacherHours[key].entries += 1;
        });
        
        // Get top 2 performers for previous month
        const sortedPrev = Object.values(prevTeacherHours)
          .sort((a, b) => b.totalHours - a.totalHours)
          .slice(0, 2);
        setPreviousMonthWinners(sortedPrev);
        
      } catch (error) {
        console.error('Error fetching recognition data:', error);
      } finally {
        setRecognitionLoading(false);
      }
    };
    
    fetchRecognitionData();
  }, [activeTab]);

  const handleCreatePost = async () => {
    if (!newPostContent.trim() && !postImage) return;
    setPosting(true);
    setUploadingImage(true);
    try {
      // Upload image if present
      let imageUrl = null;
      if (postImage) {
        imageUrl = await uploadImage(postImage, 'social_posts');
        
        // If upload failed, ask user if they want to post without image
        if (!imageUrl) {
          const continueWithoutImage = confirm(
            '‚ö†Ô∏è Could not upload image.\\n\\nWould you like to post without the image?'
          );
          if (!continueWithoutImage) {
            setPosting(false);
            setUploadingImage(false);
            return;
          }
        }
      }
      
      const postData = {
        content: newPostContent.trim(),
        authorId: currentUser.afid || currentUser.uid,
        authorName: currentUser.name,
        authorPhoto: currentUser.profilePhoto || '',
        authorSchool: currentUser.school,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        reactions: {},
        comments: [],
        imageUrl: imageUrl || null,
        imageType: imageUrl?.startsWith('data:') ? 'base64' : 'url'
      };
      
      const docRef = await db.collection('socialPosts').add(postData);
      setPosts([{ id: docRef.id, ...postData, createdAt: new Date() }, ...posts]);
      
      // Process mentions and send notifications
      const postContent = newPostContent.trim();
      const mentionRegex = /@(\w+(?:\s\w+)?)/g;
      let match;
      
      // Check for @everyone first
      if (postContent.toLowerCase().includes('@everyone')) {
        MentionNotificationSystem.sendEveryoneNotification(
          postContent,
          currentUser.name,
          currentUser.afid || currentUser.uid
        );
      } else {
        // Process individual mentions
        while ((match = mentionRegex.exec(postContent)) !== null) {
          const mentionedName = match[1];
          const mentionedMember = allMembers.find(m => 
            m.name?.toLowerCase() === mentionedName.toLowerCase()
          );
          
          if (mentionedMember) {
            const mentionedUserId = mentionedMember.afid || mentionedMember.uid || mentionedMember.id;
            MentionNotificationSystem.sendMentionNotification(
              mentionedUserId,
              mentionedMember.name,
              postContent,
              currentUser.name,
              currentUser.afid || currentUser.uid
            );
          }
        }
      }
      
      setNewPostContent('');
      setPostImage(null);
      setPostImagePreview(null);
      setShowNewPost(false);
    } catch (error) {
      console.error('[SocialWall] Failed to create post:', error);
      alert('‚ùå Failed to create post. Please check your connection and try again.');
    } finally {
      setPosting(false);
      setUploadingImage(false);
    }
  };

  // Handle reply to a post
  const handleReply = async (postId) => {
    if (!replyContent.trim() && !replyImage && !replyImagePreview) return;
    
    try {
      const post = posts.find(p => p.id === postId);
      if (!post) return;
      
      // Upload reply image if present
      let replyImageUrl = null;
      if (replyImage) {
        replyImageUrl = await uploadImage(replyImage, 'social_replies');
      } else if (replyImagePreview && replyImagePreview.startsWith('http')) {
        // It's a GIF URL
        replyImageUrl = replyImagePreview;
      }
      
      const newReply = {
        id: Date.now().toString(),
        authorId: currentUser.afid || currentUser.uid,
        authorName: currentUser.name,
        authorPhoto: currentUser.profilePhoto || '',
        content: replyContent.trim(),
        imageUrl: replyImageUrl,
        reactions: {}, // Initialize empty reactions for the comment
        createdAt: new Date().toISOString()
      };
      
      const updatedComments = [...(post.comments || []), newReply];
      
      await db.collection('socialPosts').doc(postId).update({ 
        comments: updatedComments 
      });
      
      // Process mentions in comment and send notifications
      const commentContent = replyContent.trim();
      const mentionRegex = /@(\w+(?:\s\w+)?)/g;
      let match;
      
      // Check for @everyone first
      if (commentContent.toLowerCase().includes('@everyone')) {
        MentionNotificationSystem.sendEveryoneNotification(
          commentContent,
          currentUser.name,
          currentUser.afid || currentUser.uid
        );
      } else {
        // Process individual mentions
        while ((match = mentionRegex.exec(commentContent)) !== null) {
          const mentionedName = match[1];
          const mentionedMember = allMembers.find(m => 
            m.name?.toLowerCase() === mentionedName.toLowerCase()
          );
          
          if (mentionedMember) {
            const mentionedUserId = mentionedMember.afid || mentionedMember.uid || mentionedMember.id;
            MentionNotificationSystem.sendMentionNotification(
              mentionedUserId,
              mentionedMember.name,
              commentContent,
              currentUser.name,
              currentUser.afid || currentUser.uid
            );
          }
        }
      }
      
      setPosts(posts.map(p => p.id === postId ? { ...p, comments: updatedComments } : p));
      setReplyContent('');
      setReplyImage(null);
      setReplyImagePreview(null);
      setReplyingTo(null);
      setShowGifPicker(null);
    } catch (error) {
      console.error('Reply error:', error);
      alert('Failed to post reply');
    }
  };

  // Select a GIF
  const selectGif = (gifUrl) => {
    setReplyImagePreview(gifUrl);
    setReplyImage(null); // Clear file if any
    setShowGifPicker(null);
  };

  const handleReaction = async (postId, emoji) => {
    const userId = currentUser.afid || currentUser.uid;
    const post = posts.find(p => p.id === postId);
    if (!post) return;

    let newReactions = { ...(post.reactions || {}) };
    if (newReactions[userId] === emoji) {
      delete newReactions[userId];
    } else {
      newReactions[userId] = emoji;
    }

    try {
      await db.collection('socialPosts').doc(postId).update({ reactions: newReactions });
      setPosts(posts.map(p => p.id === postId ? { ...p, reactions: newReactions } : p));
    } catch (error) {
      console.error('Error:', error);
    }
  };

  // Handle comment/reply reactions
  const handleCommentReaction = async (postId, commentId, emoji) => {
    const userId = currentUser.afid || currentUser.uid;
    const post = posts.find(p => p.id === postId);
    if (!post) return;

    const comments = [...(post.comments || [])];
    const commentIndex = comments.findIndex(c => c.id === commentId);
    if (commentIndex === -1) return;

    const comment = comments[commentIndex];
    let newReactions = { ...(comment.reactions || {}) };
    
    if (newReactions[userId] === emoji) {
      delete newReactions[userId];
    } else {
      newReactions[userId] = emoji;
    }

    comments[commentIndex] = { ...comment, reactions: newReactions };

    try {
      await db.collection('socialPosts').doc(postId).update({ comments: comments });
      setPosts(posts.map(p => p.id === postId ? { ...p, comments: comments } : p));
    } catch (error) {
      console.error('Comment reaction error:', error);
    }
  };

  // Handle nested reply (reply to a comment)
  const handleNestedReply = async (postId, parentCommentId, replyText) => {
    if (!replyText.trim()) return;
    
    const post = posts.find(p => p.id === postId);
    if (!post) return;
    
    const comments = [...(post.comments || [])];
    const commentIndex = comments.findIndex(c => c.id === parentCommentId);
    if (commentIndex === -1) return;
    
    const parentComment = comments[commentIndex];
    
    const newNestedReply = {
      id: Date.now().toString(),
      authorId: currentUser.afid || currentUser.uid,
      authorName: currentUser.name,
      authorPhoto: currentUser.profilePhoto || '',
      content: replyText.trim(),
      reactions: {},
      createdAt: new Date().toISOString()
    };
    
    // Add nested reply to parent comment
    const updatedReplies = [...(parentComment.replies || []), newNestedReply];
    comments[commentIndex] = { ...parentComment, replies: updatedReplies };
    
    try {
      await db.collection('socialPosts').doc(postId).update({ comments: comments });
      setPosts(posts.map(p => p.id === postId ? { ...p, comments: comments } : p));
      
      // Send mention notifications if any
      const mentionRegex = /@(\w+(?:\s\w+)?)/g;
      let match;
      while ((match = mentionRegex.exec(replyText)) !== null) {
        const mentionedName = match[1];
        const mentionedMember = allMembers.find(m => 
          m.name?.toLowerCase() === mentionedName.toLowerCase()
        );
        
        if (mentionedMember) {
          const mentionedUserId = mentionedMember.afid || mentionedMember.uid || mentionedMember.id;
          MentionNotificationSystem.sendMentionNotification(
            mentionedUserId,
            mentionedMember.name,
            replyText,
            currentUser.name,
            currentUser.afid || currentUser.uid
          );
        }
      }
    } catch (error) {
      console.error('Nested reply error:', error);
      alert('Failed to post reply');
    }
  };

  // ‚úÖ NEW: Edit post handler
  const handleEditPost = async (postId) => {
    if (!editPostContent.trim()) return;
    try {
      await db.collection('socialPosts').doc(postId).update({
        content: editPostContent.trim(),
        editedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      setPosts(posts.map(p => p.id === postId ? { ...p, content: editPostContent.trim(), editedAt: new Date() } : p));
      setEditingPost(null);
      setEditPostContent('');
    } catch (error) {
      console.error('Edit post error:', error);
      alert('Failed to edit post');
    }
  };
  
  // ‚úÖ NEW: Delete post handler
  const handleDeletePost = async (postId) => {
    if (!confirm('Are you sure you want to delete this post?')) return;
    try {
      await db.collection('socialPosts').doc(postId).delete();
      setPosts(posts.filter(p => p.id !== postId));
    } catch (error) {
      console.error('Delete post error:', error);
      alert('Failed to delete post');
    }
  };
  
  // ‚úÖ NEW: Edit comment handler
  const handleEditComment = async (postId, commentId) => {
    if (!editCommentContent.trim()) return;
    try {
      const post = posts.find(p => p.id === postId);
      if (!post) return;
      
      const updatedComments = post.comments.map(c => 
        c.id === commentId ? { ...c, content: editCommentContent.trim(), editedAt: new Date().toISOString() } : c
      );
      
      await db.collection('socialPosts').doc(postId).update({ comments: updatedComments });
      setPosts(posts.map(p => p.id === postId ? { ...p, comments: updatedComments } : p));
      setEditingComment(null);
      setEditCommentContent('');
    } catch (error) {
      console.error('Edit comment error:', error);
      alert('Failed to edit comment');
    }
  };
  
  // ‚úÖ NEW: Delete comment handler  
  const handleDeleteComment = async (postId, commentId) => {
    if (!confirm('Are you sure you want to delete this comment?')) return;
    try {
      const post = posts.find(p => p.id === postId);
      if (!post) return;
      
      const updatedComments = post.comments.filter(c => c.id !== commentId);
      
      await db.collection('socialPosts').doc(postId).update({ comments: updatedComments });
      setPosts(posts.map(p => p.id === postId ? { ...p, comments: updatedComments } : p));
    } catch (error) {
      console.error('Delete comment error:', error);
      alert('Failed to delete comment');
    }
  };
  
  // ‚úÖ Check if user can edit/delete a post or comment
  const canModify = (authorId) => {
    const currentUserId = currentUser.afid || currentUser.uid;
    return authorId === currentUserId || isAdminOrModerator;
  };

  const dismissBirthdayPopup = () => {
    localStorage.setItem('birthdayDismissed_' + new Date().toDateString(), 'true');
    setShowBirthdayPopup(null);
  };

  const emojis = ['üëç', '‚ù§Ô∏è', 'üòä', 'üéâ', 'üëè', 'üôå'];

  const getDaysUntilBirthday = (dob) => {
    const today = new Date();
    const bday = new Date(dob);
    const thisYearBday = new Date(today.getFullYear(), bday.getMonth(), bday.getDate());
    if (thisYearBday < today) thisYearBday.setFullYear(today.getFullYear() + 1);
    return Math.ceil((thisYearBday - today) / (1000 * 60 * 60 * 24));
  };

  if (loading) {
    return (
      <div className="flex items-center justify-center h-64">
        <div className="text-center">
          <div className="text-6xl mb-4 animate-bounce">üéâ</div>
          <p className="text-gray-600">Loading fun stuff...</p>
        </div>
      </div>
    );
  }

  return (
    <div className="space-y-6">
      <style>{`
        .confetti {
          position: fixed;
          width: 10px;
          height: 10px;
          background: #f00;
          animation: fall 3s linear infinite;
        }
        
        @keyframes fall {
          to { transform: translateY(100vh) rotate(720deg); }
        }
        
        .celebration-card {
          background: linear-gradient(135deg, #fdf2f8 0%, #fce7f3 50%, #fbcfe8 100%);
          border: 2px solid #f9a8d4;
          position: relative;
          overflow: hidden;
        }
        
        .celebration-card::before {
          content: 'üéàüéâüéä';
          position: absolute;
          top: -10px;
          right: -10px;
          font-size: 40px;
          opacity: 0.3;
          transform: rotate(15deg);
        }
        
        .birthday-card {
          animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
          0%, 100% { box-shadow: 0 0 0 0 rgba(236, 72, 153, 0.4); }
          50% { box-shadow: 0 0 0 10px rgba(236, 72, 153, 0); }
        }
        
        .tab-btn {
          padding: 12px 24px;
          border-radius: 12px;
          font-weight: 600;
          transition: all 0.3s;
        }
        
        .tab-active {
          background: linear-gradient(135deg, #ec4899, #8b5cf6);
          color: white;
          box-shadow: 0 4px 15px rgba(236, 72, 153, 0.4);
        }
        
        .tab-inactive {
          background: white;
          color: #6b7280;
        }
        
        .tab-inactive:hover {
          background: #fdf2f8;
        }
        
        .post-card {
          background: white;
          border-radius: 20px;
          border: 1px solid #f3e8ff;
          transition: all 0.3s;
        }
        
        .post-card:hover {
          transform: translateY(-2px);
          box-shadow: 0 10px 30px rgba(139, 92, 246, 0.1);
        }
        
        .emoji-btn {
          padding: 6px 10px;
          border-radius: 20px;
          transition: all 0.2s;
          background: #f9fafb;
        }
        
        .emoji-btn:hover {
          background: #fdf2f8;
          transform: scale(1.1);
        }
        
        .emoji-btn.active {
          background: linear-gradient(135deg, #fce7f3, #ede9fe);
        }
      `}</style>

      {/* Fun Header */}
      <div className="text-center">
        <div className="inline-flex items-center gap-3 bg-gradient-to-r from-pink-100 via-purple-100 to-indigo-100 px-8 py-4 rounded-2xl shadow-lg">
          <span className="text-4xl animate-bounce">üéâ</span>
          <h2 className="text-3xl font-bold bg-gradient-to-r from-pink-600 via-purple-600 to-indigo-600 bg-clip-text text-transparent">
            Social Wall
          </h2>
          <span className="text-4xl animate-bounce" style={{ animationDelay: '0.5s' }}>üéä</span>
        </div>
      </div>

      {/* Tab Switcher */}
      <div className="flex justify-center gap-4 flex-wrap">
        <button 
          onClick={() => setActiveTab('feed')}
          className={`tab-btn ${activeTab === 'feed' ? 'tab-active' : 'tab-inactive'}`}
        >
          üìù Feed
        </button>
        <button 
          onClick={() => setActiveTab('celebrations')}
          className={`tab-btn ${activeTab === 'celebrations' ? 'tab-active' : 'tab-inactive'}`}
        >
          üéÇ Celebrations {birthdays.length > 0 && <span className="ml-2 bg-red-500 text-white text-xs px-2 py-1 rounded-full">{birthdays.length}</span>}
        </button>
        <button 
          onClick={() => setActiveTab('recognition')}
          className={`tab-btn ${activeTab === 'recognition' ? 'tab-active' : 'tab-inactive'}`}
        >
          üèÜ Recognition
        </button>
      </div>

      {/* Celebrations Tab */}
      {activeTab === 'celebrations' && (
        <div className="space-y-6">
          {/* Today's Birthdays */}
          {birthdays.length > 0 && (
            <div className="celebration-card rounded-3xl p-6">
              <h3 className="text-2xl font-bold text-pink-700 mb-4 flex items-center gap-2">
                <span className="text-3xl">üéÇ</span> Today's Birthday{birthdays.length > 1 ? 's' : ''}!
              </h3>
              <div className="grid md:grid-cols-2 gap-4">
                {birthdays.map((person, idx) => {
                  const personId = person.afid || person.id || person.email;
                  const reactionCounts = getReactionCounts(personId);
                  const myReaction = getUserReaction(personId);
                  const wishes = celebrationReactions[personId]?.wishes || [];
                  
                  return (
                    <div key={idx} className="bg-white rounded-2xl p-4 shadow-lg border-2 border-pink-200">
                      {/* Person info */}
                      <div className="flex items-center gap-4 mb-4">
                        {person.profilePhoto ? (
                          <img src={person.profilePhoto} alt="" className="w-16 h-16 rounded-full object-cover border-4 border-pink-300" />
                        ) : (
                          <div className="w-16 h-16 rounded-full bg-gradient-to-br from-pink-400 to-purple-500 flex items-center justify-center text-2xl text-white font-bold">
                            {person.name?.charAt(0)}
                          </div>
                        )}
                        <div className="flex-1">
                          <div className="font-bold text-gray-800 text-lg">{person.name}</div>
                          <div className="text-sm text-gray-500">{person.role || person.subject}</div>
                          {person.school && <div className="text-xs text-gray-400">{person.school}</div>}
                          <div className="text-sm text-pink-600 font-medium mt-1">üéà Happy Birthday!</div>
                        </div>
                      </div>
                      
                      {/* Reaction buttons */}
                      <div className="flex items-center gap-2 flex-wrap mb-3">
                        {celebrationEmojis.map(emoji => (
                          <button
                            key={emoji}
                            onClick={() => handleCelebrationReaction(person, emoji)}
                            className={`px-3 py-1.5 rounded-full text-lg transition-all ${
                              myReaction === emoji 
                                ? 'bg-pink-100 scale-110 ring-2 ring-pink-400' 
                                : 'bg-gray-100 hover:bg-pink-50 hover:scale-105'
                            }`}
                          >
                            {emoji} {reactionCounts[emoji] ? <span className="text-xs font-bold">{reactionCounts[emoji]}</span> : ''}
                          </button>
                        ))}
                      </div>
                      
                      {/* Wishes */}
                      {wishes.length > 0 && (
                        <div className="mb-3 max-h-32 overflow-y-auto">
                          {wishes.map((wish, widx) => (
                            <div key={widx} className="flex items-start gap-2 p-2 bg-pink-50 rounded-lg mb-1">
                              <div className="w-6 h-6 rounded-full bg-pink-300 flex items-center justify-center text-xs text-white font-bold">
                                {wish.userName?.charAt(0)}
                              </div>
                              <div className="flex-1">
                                <div className="text-xs font-semibold text-pink-700">{wish.userName}</div>
                                <div className="text-sm text-gray-700">{wish.message}</div>
                              </div>
                            </div>
                          ))}
                        </div>
                      )}
                      
                      {/* Send wish */}
                      {showWishInput === personId ? (
                        <div className="flex gap-2">
                          <input
                            type="text"
                            value={wishMessage}
                            onChange={e => setWishMessage(e.target.value)}
                            placeholder="Send your wishes..."
                            className="flex-1 border-2 border-pink-200 px-3 py-2 rounded-lg text-sm focus:border-pink-400 focus:ring-0"
                            autoFocus
                          />
                          <button
                            onClick={() => sendWish(person)}
                            className="px-4 py-2 bg-pink-500 text-white rounded-lg font-semibold hover:bg-pink-600"
                          >
                            Send
                          </button>
                          <button
                            onClick={() => { setShowWishInput(null); setWishMessage(''); }}
                            className="px-3 py-2 bg-gray-200 rounded-lg"
                          >
                            ‚úï
                          </button>
                        </div>
                      ) : (
                        <button
                          onClick={() => setShowWishInput(personId)}
                          className="w-full py-2 bg-gradient-to-r from-pink-400 to-purple-500 text-white rounded-lg font-semibold hover:shadow-lg transition-all"
                        >
                          üéÅ Send Birthday Wishes
                        </button>
                      )}
                    </div>
                  );
                })}
              </div>
            </div>
          )}

          {/* Today's Anniversaries */}
          {anniversaries.length > 0 && (
            <div className="bg-gradient-to-r from-amber-50 to-orange-50 rounded-3xl p-6 border-2 border-amber-200">
              <h3 className="text-2xl font-bold text-amber-700 mb-4 flex items-center gap-2">
                <span className="text-3xl">üíç</span> Work Anniversary!
              </h3>
              <div className="grid md:grid-cols-2 gap-4">
                {anniversaries.map((person, idx) => {
                  const personId = person.afid || person.id || person.email;
                  const reactionCounts = getReactionCounts(personId);
                  const myReaction = getUserReaction(personId);
                  const wishes = celebrationReactions[personId]?.wishes || [];
                  const years = new Date().getFullYear() - new Date(person.joiningDate).getFullYear();
                  
                  return (
                    <div key={idx} className="bg-white rounded-2xl p-4 shadow-lg border-2 border-amber-200">
                      {/* Person info */}
                      <div className="flex items-center gap-4 mb-4">
                        {person.profilePhoto ? (
                          <img src={person.profilePhoto} alt="" className="w-16 h-16 rounded-full object-cover border-4 border-amber-300" />
                        ) : (
                          <div className="w-16 h-16 rounded-full bg-gradient-to-br from-amber-400 to-orange-500 flex items-center justify-center text-2xl text-white font-bold">
                            {person.name?.charAt(0)}
                          </div>
                        )}
                        <div className="flex-1">
                          <div className="font-bold text-gray-800 text-lg">{person.name}</div>
                          <div className="text-sm text-gray-500">{person.role || person.subject}</div>
                          {person.school && <div className="text-xs text-gray-400">{person.school}</div>}
                          <div className="text-sm text-amber-600 font-medium mt-1">üéä {years} Year{years > 1 ? 's' : ''} at Avanti!</div>
                        </div>
                      </div>
                      
                      {/* Reaction buttons */}
                      <div className="flex items-center gap-2 flex-wrap mb-3">
                        {celebrationEmojis.map(emoji => (
                          <button
                            key={emoji}
                            onClick={() => handleCelebrationReaction(person, emoji)}
                            className={`px-3 py-1.5 rounded-full text-lg transition-all ${
                              myReaction === emoji 
                                ? 'bg-amber-100 scale-110 ring-2 ring-amber-400' 
                                : 'bg-gray-100 hover:bg-amber-50 hover:scale-105'
                            }`}
                          >
                            {emoji} {reactionCounts[emoji] ? <span className="text-xs font-bold">{reactionCounts[emoji]}</span> : ''}
                          </button>
                        ))}
                      </div>
                      
                      {/* Wishes */}
                      {wishes.length > 0 && (
                        <div className="mb-3 max-h-32 overflow-y-auto">
                          {wishes.map((wish, widx) => (
                            <div key={widx} className="flex items-start gap-2 p-2 bg-amber-50 rounded-lg mb-1">
                              <div className="w-6 h-6 rounded-full bg-amber-300 flex items-center justify-center text-xs text-white font-bold">
                                {wish.userName?.charAt(0)}
                              </div>
                              <div className="flex-1">
                                <div className="text-xs font-semibold text-amber-700">{wish.userName}</div>
                                <div className="text-sm text-gray-700">{wish.message}</div>
                              </div>
                            </div>
                          ))}
                        </div>
                      )}
                      
                      {/* Send wish */}
                      {showWishInput === personId ? (
                        <div className="flex gap-2">
                          <input
                            type="text"
                            value={wishMessage}
                            onChange={e => setWishMessage(e.target.value)}
                            placeholder="Send congratulations..."
                            className="flex-1 border-2 border-amber-200 px-3 py-2 rounded-lg text-sm focus:border-amber-400 focus:ring-0"
                            autoFocus
                          />
                          <button
                            onClick={() => sendWish(person)}
                            className="px-4 py-2 bg-amber-500 text-white rounded-lg font-semibold hover:bg-amber-600"
                          >
                            Send
                          </button>
                          <button
                            onClick={() => { setShowWishInput(null); setWishMessage(''); }}
                            className="px-3 py-2 bg-gray-200 rounded-lg"
                          >
                            ‚úï
                          </button>
                        </div>
                      ) : (
                        <button
                          onClick={() => setShowWishInput(personId)}
                          className="w-full py-2 bg-gradient-to-r from-amber-400 to-orange-500 text-white rounded-lg font-semibold hover:shadow-lg transition-all"
                        >
                          üéâ Send Congratulations
                        </button>
                      )}
                    </div>
                  );
                })}
              </div>
            </div>
          )}

          {/* Upcoming Birthdays */}
          <div className="bg-white rounded-3xl p-6 shadow-lg">
            <h3 className="text-xl font-bold text-gray-700 mb-4 flex items-center gap-2">
              <span className="text-2xl">üóìÔ∏è</span> This Week's Birthdays
            </h3>
            {weekBirthdays.length === 0 ? (
              <p className="text-gray-500 text-center py-4">No birthdays this week</p>
            ) : (
              <div className="space-y-3">
                {weekBirthdays.map((person, idx) => {
                  const dobField = person.dateOfBirth || person.dob;
                  const daysLeft = getDaysUntilBirthday(dobField);
                  const dob = new Date(dobField);
                  const isToday = daysLeft === 0;
                  return (
                    <div key={idx} className={`flex items-center justify-between p-3 rounded-xl transition-colors ${isToday ? 'bg-pink-100 border-2 border-pink-300' : 'bg-gray-50 hover:bg-pink-50'}`}>
                      <div className="flex items-center gap-3">
                        {person.profilePhoto ? (
                          <img src={person.profilePhoto} alt="" className="w-10 h-10 rounded-full object-cover" />
                        ) : (
                          <div className="w-10 h-10 rounded-full bg-gradient-to-br from-pink-400 to-purple-500 flex items-center justify-center text-white font-bold">
                            {person.name?.charAt(0)}
                          </div>
                        )}
                        <div>
                          <div className="font-semibold text-gray-800">{person.name} {isToday && 'üéÇ'}</div>
                          <div className="text-xs text-gray-500">{person.school || person.role}</div>
                        </div>
                      </div>
                      <div className="text-right">
                        <div className="text-sm font-bold text-pink-600">
                          {dob.toLocaleDateString('en-IN', { day: 'numeric', month: 'short' })}
                        </div>
                        <div className="text-xs text-gray-500">
                          {isToday ? 'üéâ Today!' : daysLeft === 1 ? 'Tomorrow!' : `in ${daysLeft} days`}
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>
            )}
          </div>

          {/* This Month's Birthdays */}
          <div className="bg-white rounded-3xl p-6 shadow-lg">
            <h3 className="text-xl font-bold text-gray-700 mb-4 flex items-center gap-2">
              <span className="text-2xl">üìÖ</span> This Month's Birthdays ({new Date().toLocaleDateString('en-IN', { month: 'long' })})
            </h3>
            {monthBirthdays.length === 0 ? (
              <p className="text-gray-500 text-center py-4">No birthdays this month</p>
            ) : (
              <div className="grid md:grid-cols-2 gap-3">
                {monthBirthdays.map((person, idx) => {
                  const dobField = person.dateOfBirth || person.dob;
                  const dob = new Date(dobField);
                  const daysLeft = getDaysUntilBirthday(dobField);
                  const isPast = dob.getDate() < new Date().getDate();
                  const isToday = daysLeft === 0;
                  return (
                    <div key={idx} className={`flex items-center justify-between p-3 rounded-xl transition-colors ${isToday ? 'bg-pink-100 border-2 border-pink-300' : isPast ? 'bg-gray-100 opacity-60' : 'bg-gray-50 hover:bg-pink-50'}`}>
                      <div className="flex items-center gap-3">
                        {person.profilePhoto ? (
                          <img src={person.profilePhoto} alt="" className="w-9 h-9 rounded-full object-cover" />
                        ) : (
                          <div className="w-9 h-9 rounded-full bg-gradient-to-br from-pink-400 to-purple-500 flex items-center justify-center text-white font-bold text-sm">
                            {person.name?.charAt(0)}
                          </div>
                        )}
                        <div>
                          <div className="font-semibold text-gray-800 text-sm">{person.name} {isToday && 'üéÇ'}</div>
                          <div className="text-xs text-gray-500">{person.school || person.role}</div>
                        </div>
                      </div>
                      <div className="text-right">
                        <div className={`text-sm font-bold ${isPast ? 'text-gray-400' : 'text-pink-600'}`}>
                          {dob.getDate()} {dob.toLocaleDateString('en-IN', { month: 'short' })}
                        </div>
                        <div className="text-xs text-gray-500">
                          {isToday ? 'üéâ Today!' : isPast ? 'Passed' : daysLeft === 1 ? 'Tomorrow' : `${daysLeft}d`}
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>
            )}
          </div>

          {/* This Week's Anniversaries */}
          <div className="bg-white rounded-3xl p-6 shadow-lg">
            <h3 className="text-xl font-bold text-gray-700 mb-4 flex items-center gap-2">
              <span className="text-2xl">üéâ</span> This Week's Work Anniversaries
            </h3>
            {weekAnniversaries.length === 0 ? (
              <p className="text-gray-500 text-center py-4">No work anniversaries this week</p>
            ) : (
              <div className="space-y-3">
                {weekAnniversaries.map((person, idx) => {
                  const years = new Date().getFullYear() - new Date(person.joiningDate).getFullYear();
                  const jDate = new Date(person.joiningDate);
                  return (
                    <div key={idx} className="flex items-center justify-between p-3 bg-amber-50 rounded-xl hover:bg-amber-100 transition-colors">
                      <div className="flex items-center gap-3">
                        {person.profilePhoto ? (
                          <img src={person.profilePhoto} alt="" className="w-10 h-10 rounded-full object-cover" />
                        ) : (
                          <div className="w-10 h-10 rounded-full bg-gradient-to-br from-amber-400 to-orange-500 flex items-center justify-center text-white font-bold">
                            {person.name?.charAt(0)}
                          </div>
                        )}
                        <div>
                          <div className="font-semibold text-gray-800">{person.name}</div>
                          <div className="text-xs text-gray-500">{person.school || person.role}</div>
                        </div>
                      </div>
                      <div className="text-right">
                        <div className="text-sm font-bold text-amber-600">
                          {years} Year{years > 1 ? 's' : ''}
                        </div>
                        <div className="text-xs text-gray-500">
                          {jDate.toLocaleDateString('en-IN', { day: 'numeric', month: 'short' })}
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>
            )}
          </div>

          {/* This Month's Anniversaries */}
          <div className="bg-white rounded-3xl p-6 shadow-lg">
            <h3 className="text-xl font-bold text-gray-700 mb-4 flex items-center gap-2">
              <span className="text-2xl">üìÖ</span> This Month's Work Anniversaries
            </h3>
            {monthAnniversaries.length === 0 ? (
              <p className="text-gray-500 text-center py-4">No work anniversaries this month</p>
            ) : (
              <div className="space-y-3 max-h-80 overflow-y-auto">
                {monthAnniversaries.map((person, idx) => {
                  const years = new Date().getFullYear() - new Date(person.joiningDate).getFullYear();
                  const jDate = new Date(person.joiningDate);
                  return (
                    <div key={idx} className="flex items-center justify-between p-3 bg-green-50 rounded-xl hover:bg-green-100 transition-colors">
                      <div className="flex items-center gap-3">
                        {person.profilePhoto ? (
                          <img src={person.profilePhoto} alt="" className="w-10 h-10 rounded-full object-cover" />
                        ) : (
                          <div className="w-10 h-10 rounded-full bg-gradient-to-br from-green-400 to-teal-500 flex items-center justify-center text-white font-bold">
                            {person.name?.charAt(0)}
                          </div>
                        )}
                        <div>
                          <div className="font-semibold text-gray-800">{person.name}</div>
                          <div className="text-xs text-gray-500">{person.school || person.role}</div>
                        </div>
                      </div>
                      <div className="text-right">
                        <div className="text-sm font-bold text-green-600">
                          {years} Year{years > 1 ? 's' : ''}
                        </div>
                        <div className="text-xs text-gray-500">
                          {jDate.toLocaleDateString('en-IN', { day: 'numeric', month: 'short' })}
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>
            )}
          </div>

          {/* No celebrations message */}
          {birthdays.length === 0 && anniversaries.length === 0 && upcomingBirthdays.length === 0 && weekAnniversaries.length === 0 && monthAnniversaries.length === 0 && (
            <div className="text-center py-12">
              <div className="text-6xl mb-4">üéà</div>
              <p className="text-gray-500">No celebrations today. Check back soon!</p>
            </div>
          )}
        </div>
      )}

      {/* Feed Tab */}
      {activeTab === 'feed' && (
        <div className="space-y-6">
          {/* Today's Celebrations Banner (if any) */}
          {(birthdays.length > 0 || anniversaries.length > 0) && (
            <div 
              onClick={() => setActiveTab('celebrations')}
              className="celebration-card rounded-2xl p-4 cursor-pointer hover:shadow-lg transition-all"
            >
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-3">
                  <span className="text-3xl">üéâ</span>
                  <div>
                    <div className="font-bold text-pink-700">
                      {birthdays.length > 0 && `${birthdays.length} Birthday${birthdays.length > 1 ? 's' : ''} Today!`}
                      {birthdays.length > 0 && anniversaries.length > 0 && ' + '}
                      {anniversaries.length > 0 && `${anniversaries.length} Anniversary`}
                    </div>
                    <div className="text-sm text-pink-600">Click to view celebrations ‚Üí</div>
                  </div>
                </div>
                <div className="flex -space-x-2">
                  {[...birthdays, ...anniversaries].slice(0, 3).map((p, i) => (
                    p.profilePhoto ? (
                      <img key={i} src={p.profilePhoto} alt="" className="w-10 h-10 rounded-full border-2 border-white object-cover" />
                    ) : (
                      <div key={i} className="w-10 h-10 rounded-full bg-gradient-to-br from-pink-400 to-purple-500 border-2 border-white flex items-center justify-center text-white font-bold text-sm">
                        {p.name?.charAt(0)}
                      </div>
                    )
                  ))}
                </div>
              </div>
            </div>
          )}

          {/* Create Post */}
          <div className="bg-white rounded-2xl p-4 shadow-lg border border-purple-100">
            {showNewPost ? (
              <div className="space-y-3">
                <div className="relative mention-input-container">
                  <MentionTextarea
                    value={newPostContent}
                    onChange={setNewPostContent}
                    placeholder="What's on your mind? Type @ to mention someone üëã"
                    allMembers={allMembers}
                    className="w-full p-4 pr-12 border-2 border-purple-200 rounded-2xl focus:border-purple-400 focus:ring-0 resize-none"
                    rows={3}
                  />
                  {/* Attachment button inside textarea area */}
                  <label className="absolute bottom-3 right-3 cursor-pointer text-gray-400 hover:text-purple-600 transition-colors">
                    <span className="text-xl">üìé</span>
                    <input
                      type="file"
                      accept="image/*,video/*"
                      onChange={handlePostImageSelect}
                      className="hidden"
                    />
                  </label>
                </div>
                
                {/* Mention hint */}
                <div className="text-xs text-gray-400 flex items-center gap-2">
                  <span>üí° Tip: Type <span className="mention-tag">@name</span> to mention someone or <span className="mention-tag mention-everyone">@everyone</span> to notify all</span>
                </div>
                
                {/* Image Preview */}
                {postImagePreview && (
                  <div className="relative inline-block">
                    <img src={postImagePreview} alt="Preview" className="max-h-40 rounded-xl border-2 border-purple-200" />
                    <button
                      onClick={() => { setPostImage(null); setPostImagePreview(null); }}
                      className="absolute -top-2 -right-2 bg-red-500 text-white w-6 h-6 rounded-full text-sm font-bold hover:bg-red-600"
                    >
                      ‚úï
                    </button>
                  </div>
                )}
                
                <div className="flex justify-end items-center gap-3">
                  <button
                    onClick={() => { setShowNewPost(false); setNewPostContent(''); setPostImage(null); setPostImagePreview(null); }}
                    className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-xl"
                  >
                    Cancel
                  </button>
                  <button
                    onClick={handleCreatePost}
                    disabled={(!newPostContent.trim() && !postImage) || posting}
                    className="px-6 py-2 bg-gradient-to-r from-pink-500 to-purple-600 text-white rounded-xl font-semibold disabled:opacity-50 hover:shadow-lg transition-all"
                  >
                    {uploadingImage ? 'üì§ Uploading...' : posting ? 'Posting...' : '‚ú® Post'}
                  </button>
                </div>
              </div>
            ) : (
              <div 
                onClick={() => setShowNewPost(true)}
                className="flex items-center gap-4 cursor-pointer p-2 hover:bg-purple-50 rounded-xl transition-colors"
              >
                {currentUser.profilePhoto ? (
                  <img src={currentUser.profilePhoto} alt="" className="w-11 h-11 rounded-full object-cover" />
                ) : (
                  <div className="w-11 h-11 rounded-full bg-gradient-to-br from-pink-400 to-purple-500 flex items-center justify-center text-white font-bold text-lg">
                    {currentUser.name?.charAt(0)}
                  </div>
                )}
                <div className="flex-1 text-gray-400 bg-gray-100 rounded-full py-3 px-4">
                  What's on your mind?
                </div>
              </div>
            )}
          </div>

          {/* Posts Feed */}
          {posts.length === 0 ? (
            <div className="text-center py-12 bg-white rounded-2xl">
              <div className="text-6xl mb-4">üìù</div>
              <p className="text-gray-500">No posts yet. Be the first to share something!</p>
            </div>
          ) : (
            <div className="space-y-4">
              {posts.map(post => {
                const reactionCounts = {};
                Object.values(post.reactions || {}).forEach(emoji => {
                  reactionCounts[emoji] = (reactionCounts[emoji] || 0) + 1;
                });
                const myReaction = post.reactions?.[currentUser.afid || currentUser.uid];

                return (
                  <div key={post.id} className="post-card p-5">
                    {/* Author + Actions */}
                    <div className="flex items-start justify-between mb-4">
                      <div className="flex items-center gap-3">
                        {post.authorPhoto ? (
                          <img src={post.authorPhoto} alt="" className="w-12 h-12 rounded-full object-cover" />
                        ) : (
                          <div className="w-12 h-12 rounded-full bg-gradient-to-br from-pink-400 to-purple-500 flex items-center justify-center text-white font-bold text-lg">
                            {post.authorName?.charAt(0)}
                          </div>
                        )}
                        <div>
                          <div className="font-bold text-gray-800">{post.authorName}</div>
                          <div className="text-xs text-gray-500">
                            {post.authorSchool} ‚Ä¢ {post.createdAt?.toDate ? post.createdAt.toDate().toLocaleDateString('en-IN', { day: 'numeric', month: 'short' }) : 'Just now'}
                            {post.editedAt && <span className="ml-1 text-gray-400">(edited)</span>}
                          </div>
                        </div>
                      </div>
                      
                      {/* ‚úÖ Edit/Delete Actions */}
                      {canModify(post.authorId) && (
                        <div className="flex items-center gap-1">
                          <button 
                            onClick={() => { setEditingPost(post.id); setEditPostContent(post.content); }}
                            className="p-2 text-gray-400 hover:text-blue-500 hover:bg-blue-50 rounded-lg transition-all"
                            title="Edit post"
                          >
                            ‚úèÔ∏è
                          </button>
                          <button 
                            onClick={() => handleDeletePost(post.id)}
                            className="p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-all"
                            title={isAdminOrModerator && post.authorId !== (currentUser.afid || currentUser.uid) ? 'Delete as moderator' : 'Delete post'}
                          >
                            üóëÔ∏è
                          </button>
                        </div>
                      )}
                    </div>

                    {/* Content - Editable or Display */}
                    {editingPost === post.id ? (
                      <div className="mb-4">
                        <textarea
                          value={editPostContent}
                          onChange={(e) => setEditPostContent(e.target.value)}
                          className="w-full p-3 border-2 border-purple-200 rounded-xl focus:border-purple-400 focus:ring-0 resize-none"
                          rows={3}
                          autoFocus
                        />
                        <div className="flex gap-2 mt-2">
                          <button 
                            onClick={() => handleEditPost(post.id)}
                            className="px-4 py-2 bg-purple-500 text-white rounded-lg font-semibold hover:bg-purple-600"
                          >
                            Save
                          </button>
                          <button 
                            onClick={() => { setEditingPost(null); setEditPostContent(''); }}
                            className="px-4 py-2 bg-gray-200 rounded-lg font-semibold hover:bg-gray-300"
                          >
                            Cancel
                          </button>
                        </div>
                      </div>
                    ) : (
                      <p className="text-gray-700 mb-4 whitespace-pre-wrap">{post.content}</p>
                    )}
                    
                    {/* Post Image */}
                    {post.imageUrl && (
                      <div className="mb-4">
                        <img 
                          src={post.imageUrl} 
                          alt="Post attachment" 
                          className="max-w-full rounded-xl border border-purple-100 max-h-96 object-contain"
                        />
                      </div>
                    )}

                    {/* Reactions with tooltips showing who reacted */}
                    <div className="flex items-center gap-2 flex-wrap mb-3">
                      {emojis.map(emoji => {
                        // Get list of user IDs who reacted with this emoji
                        const reactedBy = Object.entries(post.reactions || {})
                          .filter(([userId, reaction]) => reaction === emoji)
                          .map(([userId]) => userId);
                        
                        return (
                          <ReactionButton
                            key={emoji}
                            emoji={emoji}
                            count={reactionCounts[emoji]}
                            isActive={myReaction === emoji}
                            onClick={() => handleReaction(post.id, emoji)}
                            reactedBy={reactedBy}
                            allMembers={allMembers}
                          />
                        );
                      })}
                      {post.comments?.length > 0 && (
                        <span className="text-gray-400 text-sm ml-2">
                          üí¨ {post.comments.length} {post.comments.length === 1 ? 'comment' : 'comments'}
                        </span>
                      )}
                    </div>
                    
                    {/* Comments Section - Reddit Style */}
                    {post.comments?.length > 0 && (
                      <div className="space-y-2 mb-3">
                        {post.comments.slice(0, expandedReplies[post.id] ? post.comments.length : 2).map((reply, idx) => {
                          // Calculate comment reaction counts
                          const commentReactionCounts = {};
                          Object.values(reply.reactions || {}).forEach(e => {
                            commentReactionCounts[e] = (commentReactionCounts[e] || 0) + 1;
                          });
                          const myCommentReaction = reply.reactions?.[currentUser.afid || currentUser.uid];
                          const commentEmojis = ['üëç', '‚ù§Ô∏è', 'üòä'];
                          const isCollapsed = expandedReplies[`collapse_${post.id}_${reply.id}`];
                          const showEmojiPicker = expandedReplies[`emoji_${post.id}_${reply.id}`];
                          const hasAnyReactions = Object.keys(reply.reactions || {}).length > 0;
                          
                          return (
                            <div key={reply.id || idx} className="reddit-comment-thread">
                              {/* Collapse button */}
                              {(reply.replies?.length > 0) && (
                                <button 
                                  className="reddit-collapse-btn"
                                  onClick={() => setExpandedReplies({...expandedReplies, [`collapse_${post.id}_${reply.id}`]: !isCollapsed})}
                                  title={isCollapsed ? 'Expand' : 'Collapse'}
                                >
                                  {isCollapsed ? '+' : '‚àí'}
                                </button>
                              )}
                              
                              {/* Main comment */}
                              <div className="comment-wrapper flex gap-2 ml-0">
                                {reply.authorPhoto ? (
                                  <img src={reply.authorPhoto} alt="" className="w-8 h-8 rounded-full object-cover flex-shrink-0 border-0" style={{border: 'none'}} />
                                ) : (
                                  <div className="w-8 h-8 rounded-full bg-gradient-to-br from-pink-300 to-purple-400 flex items-center justify-center text-white text-sm font-bold flex-shrink-0">
                                    {reply.authorName?.charAt(0)}
                                  </div>
                                )}
                                <div className="flex-1">
                                  {/* ‚úÖ Comment content - editable or display */}
                                  {editingComment?.postId === post.id && editingComment?.commentId === reply.id ? (
                                    <div className="mb-2">
                                      <textarea
                                        value={editCommentContent}
                                        onChange={(e) => setEditCommentContent(e.target.value)}
                                        className="w-full p-2 border-2 border-purple-200 rounded-xl focus:border-purple-400 focus:ring-0 resize-none text-sm"
                                        rows={2}
                                        autoFocus
                                      />
                                      <div className="flex gap-2 mt-1">
                                        <button 
                                          onClick={() => handleEditComment(post.id, reply.id)}
                                          className="px-3 py-1 bg-purple-500 text-white rounded-lg text-xs font-semibold hover:bg-purple-600"
                                        >
                                          Save
                                        </button>
                                        <button 
                                          onClick={() => { setEditingComment(null); setEditCommentContent(''); }}
                                          className="px-3 py-1 bg-gray-200 rounded-lg text-xs font-semibold hover:bg-gray-300"
                                        >
                                          Cancel
                                        </button>
                                      </div>
                                    </div>
                                  ) : (
                                    <div className="bg-gray-50 rounded-2xl px-3 py-2">
                                      <span className="font-semibold text-sm">{reply.authorName}</span>
                                      {reply.editedAt && <span className="text-xs text-gray-400 ml-1">(edited)</span>}
                                      <span className="text-gray-700 text-sm ml-1">
                                        {/* Render content with mentions highlighted */}
                                        {reply.content?.split(/(@\w+(?:\s\w+)?)/g).map((part, i) => 
                                          part.startsWith('@') ? (
                                            <span key={i} className="mention-tag">{part}</span>
                                          ) : part
                                        )}
                                      </span>
                                      {reply.imageUrl && (
                                        <img src={reply.imageUrl} alt="" className="mt-2 max-h-32 rounded-lg" />
                                      )}
                                    </div>
                                  )}
                                  
                                  {/* ‚úÖ IMPROVED: Reddit-style comment actions row */}
                                  <div className="reddit-action-row">
                                    {/* Timestamp */}
                                    <span className="reddit-timestamp">
                                      {reply.createdAt ? new Date(reply.createdAt).toLocaleDateString('en-IN', { day: 'numeric', month: 'short' }) : ''}
                                    </span>
                                    
                                    {/* Reply button - Reddit style */}
                                    <button 
                                      className="reddit-action-btn"
                                      onClick={() => setExpandedReplies({...expandedReplies, [`reply_${post.id}_${reply.id}`]: !expandedReplies[`reply_${post.id}_${reply.id}`]})}
                                    >
                                      <span className="icon">üí¨</span>
                                      <span>Reply</span>
                                    </button>
                                    
                                    {/* ‚úÖ NEW: Edit button for comments */}
                                    {canModify(reply.authorId) && (
                                      <>
                                        <button 
                                          className="reddit-action-btn"
                                          onClick={() => { setEditingComment({postId: post.id, commentId: reply.id}); setEditCommentContent(reply.content); }}
                                        >
                                          <span className="icon">‚úèÔ∏è</span>
                                          <span>Edit</span>
                                        </button>
                                        <button 
                                          className="reddit-action-btn text-red-500"
                                          onClick={() => handleDeleteComment(post.id, reply.id)}
                                        >
                                          <span className="icon">üóëÔ∏è</span>
                                          <span>Delete</span>
                                        </button>
                                      </>
                                    )}
                                    
                                    {/* Reactions - Reddit style */}
                                    <div className="reddit-reactions">
                                      {commentEmojis.map(emoji => {
                                        const count = commentReactionCounts[emoji] || 0;
                                        const reactedBy = Object.entries(reply.reactions || {})
                                          .filter(([uid, reaction]) => reaction === emoji)
                                          .map(([uid]) => uid);
                                        
                                        return (
                                          <button
                                            key={emoji}
                                            className={`emoji-btn ${myCommentReaction === emoji ? 'active' : ''}`}
                                            onClick={() => handleCommentReaction(post.id, reply.id, emoji)}
                                            title={reactedBy.length > 0 ? `${reactedBy.length} reaction${reactedBy.length > 1 ? 's' : ''}` : 'React'}
                                          >
                                            {emoji}{count > 0 && <span style={{fontSize: '10px', marginLeft: '2px'}}>{count}</span>}
                                          </button>
                                        );
                                      })}
                                    </div>
                                    
                                    {/* Show nested reply count if any */}
                                    {reply.replies?.length > 0 && (
                                      <span className="reddit-timestamp" style={{marginLeft: '4px'}}>
                                        ‚Ä¢ {reply.replies.length} {reply.replies.length === 1 ? 'reply' : 'replies'}
                                      </span>
                                    )}
                                  </div>
                                  
                                  {/* Reply input for this comment */}
                                  {expandedReplies[`reply_${post.id}_${reply.id}`] && (
                                    <div className="reddit-reply-input mt-2">
                                      <div className="flex items-center gap-2">
                                        <MentionInput
                                          value={expandedReplies[`replyText_${post.id}_${reply.id}`] || ''}
                                          onChange={(val) => setExpandedReplies({...expandedReplies, [`replyText_${post.id}_${reply.id}`]: val})}
                                          placeholder={`Reply to ${reply.authorName}...`}
                                          allMembers={allMembers}
                                          className="flex-1 bg-white border border-gray-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-purple-400"
                                          onSubmit={() => {
                                            const replyText = expandedReplies[`replyText_${post.id}_${reply.id}`];
                                            if (replyText?.trim()) {
                                              handleNestedReply(post.id, reply.id, replyText.trim());
                                              setExpandedReplies({
                                                ...expandedReplies, 
                                                [`replyText_${post.id}_${reply.id}`]: '',
                                                [`reply_${post.id}_${reply.id}`]: false
                                              });
                                            }
                                          }}
                                        />
                                        <button
                                          onClick={() => {
                                            const replyText = expandedReplies[`replyText_${post.id}_${reply.id}`];
                                            if (replyText?.trim()) {
                                              handleNestedReply(post.id, reply.id, replyText.trim());
                                              setExpandedReplies({
                                                ...expandedReplies, 
                                                [`replyText_${post.id}_${reply.id}`]: '',
                                                [`reply_${post.id}_${reply.id}`]: false
                                              });
                                            }
                                          }}
                                          className="text-purple-600 font-semibold text-sm hover:text-purple-800 px-3 py-2"
                                        >
                                          Post
                                        </button>
                                      </div>
                                    </div>
                                  )}
                                  
                                  {/* Nested replies */}
                                  {!isCollapsed && reply.replies?.length > 0 && (
                                    <div className="mt-2 space-y-2 ml-4 pl-4 border-l-2 border-gray-200">
                                      {reply.replies.map((nestedReply, nidx) => {
                                        const nestedReactionCounts = {};
                                        Object.values(nestedReply.reactions || {}).forEach(e => {
                                          nestedReactionCounts[e] = (nestedReactionCounts[e] || 0) + 1;
                                        });
                                        const myNestedReaction = nestedReply.reactions?.[currentUser.afid || currentUser.uid];
                                        
                                        return (
                                          <div key={nestedReply.id || nidx} className="comment-wrapper flex gap-2">
                                            {nestedReply.authorPhoto ? (
                                              <img src={nestedReply.authorPhoto} alt="" className="w-6 h-6 rounded-full object-cover flex-shrink-0" />
                                            ) : (
                                              <div className="w-6 h-6 rounded-full bg-gradient-to-br from-blue-300 to-indigo-400 flex items-center justify-center text-white text-xs font-bold flex-shrink-0">
                                                {nestedReply.authorName?.charAt(0)}
                                              </div>
                                            )}
                                            <div className="flex-1">
                                              <div className="bg-gray-50 rounded-xl px-3 py-1.5">
                                                <span className="font-semibold text-xs">{nestedReply.authorName}</span>
                                                <span className="text-gray-700 text-xs ml-1">
                                                  {nestedReply.content?.split(/(@\w+(?:\s\w+)?)/g).map((part, i) => 
                                                    part.startsWith('@') ? (
                                                      <span key={i} className="mention-tag">{part}</span>
                                                    ) : part
                                                  )}
                                                </span>
                                              </div>
                                              <div className="flex items-center gap-1 mt-0.5 ml-2 text-xs text-gray-400">
                                                {nestedReply.createdAt && new Date(nestedReply.createdAt).toLocaleDateString('en-IN', { day: 'numeric', month: 'short' })}
                                              </div>
                                            </div>
                                          </div>
                                        );
                                      })}
                                    </div>
                                  )}
                                </div>
                              </div>
                            </div>
                          );
                        })}
                        {post.comments.length > 2 && !expandedReplies[post.id] && (
                          <button 
                            onClick={() => setExpandedReplies({...expandedReplies, [post.id]: true})}
                            className="text-sm text-gray-500 font-medium hover:text-gray-700 ml-10"
                          >
                            View all {post.comments.length} comments
                          </button>
                        )}
                      </div>
                    )}
                    
                    {/* Instagram-style Add a comment with @mention support */}
                    <div className="border-t border-gray-100 pt-3 mt-2">
                      <div className="flex items-center gap-3">
                        {currentUser.profilePhoto ? (
                          <img src={currentUser.profilePhoto} alt="" className="w-8 h-8 rounded-full object-cover flex-shrink-0" />
                        ) : (
                          <div className="w-8 h-8 rounded-full bg-gradient-to-br from-pink-400 to-purple-500 flex items-center justify-center text-white text-sm font-bold flex-shrink-0">
                            {currentUser.name?.charAt(0)}
                          </div>
                        )}
                        <div className="flex-1 flex items-center bg-gray-100 rounded-full px-4 py-2 border border-gray-200 focus-within:border-purple-400 focus-within:bg-white transition-all">
                          <MentionInput
                            value={replyingTo === post.id ? replyContent : ''}
                            onChange={(val) => { setReplyingTo(post.id); setReplyContent(val); }}
                            placeholder="Add a comment... (type @ to mention)"
                            allMembers={allMembers}
                            className="flex-1 bg-transparent border-none outline-none text-sm"
                            onSubmit={() => { if (replyContent.trim()) handleReply(post.id); }}
                          />
                          {/* Attachment button */}
                          <label className="cursor-pointer text-gray-400 hover:text-gray-600 p-1 ml-1">
                            <span className="text-lg">üìé</span>
                            <input
                              type="file"
                              accept="image/*,video/*"
                              onChange={(e) => { setReplyingTo(post.id); handleReplyImageSelect(e); }}
                              className="hidden"
                            />
                          </label>
                          {/* Post button - only show when there's content */}
                          {(replyingTo === post.id && (replyContent.trim() || replyImagePreview)) && (
                            <button
                              onClick={() => handleReply(post.id)}
                              className="text-purple-600 font-semibold text-sm ml-2 hover:text-purple-800"
                            >
                              Post
                            </button>
                          )}
                        </div>
                      </div>
                      
                      {/* Reply image preview */}
                      {replyingTo === post.id && replyImagePreview && (
                        <div className="relative inline-block ml-11 mt-2">
                          <img src={replyImagePreview} alt="Preview" className="max-h-20 rounded-lg" />
                          <button
                            onClick={() => { setReplyImage(null); setReplyImagePreview(null); }}
                            className="absolute -top-1 -right-1 bg-red-500 text-white w-5 h-5 rounded-full text-xs"
                          >‚úï</button>
                        </div>
                      )}
                    </div>
                  </div>
                );
              })}
            </div>
          )}
        </div>
      )}

      {/* Recognition Tab - Educator of the Month */}
      {activeTab === 'recognition' && (
        <div className="space-y-6">
          {recognitionLoading ? (
            <div className="flex items-center justify-center h-64">
              <div className="text-center">
                <div className="w-12 h-12 border-4 border-yellow-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
                <p className="text-gray-500">Loading recognition data...</p>
              </div>
            </div>
          ) : (
            <>
              {/* Current Month Top Performers */}
              <div className="bg-gradient-to-r from-yellow-400 via-orange-400 to-red-400 p-1 rounded-2xl">
                <div className="bg-white p-6 rounded-2xl">
                  <div className="text-center">
                    <div className="text-5xl mb-4">üèÜ</div>
                    <h2 className="text-2xl font-bold mb-2">Educators of the Month</h2>
                    <p className="text-gray-500 mb-6">{new Date().toLocaleDateString('en-IN', { month: 'long', year: 'numeric' })}</p>
                    
                    {topPerformers.length > 0 ? (
                      <div className="grid md:grid-cols-2 gap-6 max-w-2xl mx-auto">
                        {topPerformers.map((educator, idx) => (
                          <div key={educator.afid} className={`p-6 rounded-xl ${
                            idx === 0 
                              ? 'bg-gradient-to-r from-yellow-50 to-orange-50 border-2 border-yellow-300' 
                              : 'bg-gradient-to-r from-gray-50 to-slate-50 border-2 border-gray-300'
                          }`}>
                            <div className="text-4xl mb-3">
                              {idx === 0 ? 'ü•á' : 'ü•à'}
                            </div>
                            <div className={`w-16 h-16 rounded-full flex items-center justify-center text-white text-2xl font-bold mx-auto mb-3 ${
                              idx === 0 
                                ? 'bg-gradient-to-br from-yellow-400 to-orange-500' 
                                : 'bg-gradient-to-br from-gray-400 to-slate-500'
                            }`}>
                              {educator.name?.charAt(0)}
                            </div>
                            <h3 className="text-xl font-bold text-gray-800">{educator.name}</h3>
                            <p className="text-sm text-gray-600">{educator.subject}</p>
                            <p className="text-xs text-gray-500">{educator.school}</p>
                            <div className="mt-4 flex justify-center gap-3">
                              <div className={`px-3 py-2 rounded-lg ${
                                idx === 0 ? 'bg-yellow-100' : 'bg-gray-100'
                              }`}>
                                <div className={`text-xl font-bold ${
                                  idx === 0 ? 'text-yellow-600' : 'text-gray-600'
                                }`}>{educator.totalHours?.toFixed(1)}h</div>
                                <div className={`text-xs ${
                                  idx === 0 ? 'text-yellow-700' : 'text-gray-500'
                                }`}>Hours</div>
                              </div>
                              <div className="bg-green-100 px-3 py-2 rounded-lg">
                                <div className="text-xl font-bold text-green-600">{educator.entries}</div>
                                <div className="text-xs text-green-700">Entries</div>
                              </div>
                            </div>
                          </div>
                        ))}
                      </div>
                    ) : (
                      <div className="text-gray-500 py-8">
                        <div className="text-4xl mb-2">üìä</div>
                        <p>Not enough data yet this month</p>
                        <p className="text-sm">Keep logging your activities!</p>
                      </div>
                    )}
                  </div>
                </div>
              </div>
              
              {/* Previous Month Winners */}
              {previousMonthWinners.length > 0 && (
                <div className="bg-white p-6 rounded-xl shadow-lg">
                  <h3 className="text-xl font-bold mb-6 flex items-center gap-2">
                    <span>üåü</span> Previous Month's Top Performers
                    <span className="text-sm font-normal text-gray-500 ml-2">
                      ({new Date(new Date().setMonth(new Date().getMonth() - 1)).toLocaleDateString('en-IN', { month: 'long', year: 'numeric' })})
                    </span>
                  </h3>
                  <div className="grid md:grid-cols-2 gap-4">
                    {previousMonthWinners.map((educator, idx) => (
                      <div key={educator.afid} className={`p-4 rounded-xl border-2 flex items-center gap-4 ${
                        idx === 0 ? 'border-yellow-300 bg-yellow-50' : 'border-gray-200 bg-gray-50'
                      }`}>
                        <div className={`w-12 h-12 rounded-full flex items-center justify-center font-bold text-white ${
                          idx === 0 ? 'bg-yellow-500' : 'bg-gray-400'
                        }`}>
                          {idx === 0 ? 'ü•á' : 'ü•à'}
                        </div>
                        <div className="flex-1">
                          <div className="font-semibold">{educator.name}</div>
                          <div className="text-xs text-gray-500">{educator.school} ‚Ä¢ {educator.subject}</div>
                        </div>
                        <div className="text-right">
                          <span className="text-xl font-bold text-yellow-600">{educator.totalHours?.toFixed(1)}</span>
                          <span className="text-gray-500 text-sm"> hrs</span>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              )}
              
              {/* Recognition Info */}
              <div className="bg-gradient-to-r from-purple-50 to-indigo-50 p-6 rounded-xl border-2 border-purple-200">
                <h4 className="font-bold text-purple-800 mb-3 flex items-center gap-2">
                  <span>üí°</span> How Recognition Works
                </h4>
                <ul className="text-sm text-purple-700 space-y-2">
                  <li>‚Ä¢ Top 2 educators with most approved timesheet hours are recognized each month</li>
                  <li>‚Ä¢ Make sure to log your daily activities in the Timesheet</li>
                  <li>‚Ä¢ Get your entries approved by your line manager</li>
                  <li>‚Ä¢ Previous month's winners are also displayed for motivation!</li>
                </ul>
              </div>
            </>
          )}
        </div>
      )}

      {/* Birthday Popup */}
      {showBirthdayPopup && (
        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-3xl max-w-md w-full overflow-hidden shadow-2xl animate-bounce-in">
            <style>{`
              @keyframes bounce-in {
                0% { transform: scale(0.5); opacity: 0; }
                70% { transform: scale(1.05); }
                100% { transform: scale(1); opacity: 1; }
              }
              .animate-bounce-in { animation: bounce-in 0.5s ease-out; }
            `}</style>
            
            <div className="bg-gradient-to-r from-pink-500 via-purple-500 to-indigo-500 p-6 text-white text-center">
              <div className="text-6xl mb-2">üéÇ</div>
              <h3 className="text-2xl font-bold">Happy Birthday!</h3>
            </div>
            
            <div className="p-6 text-center">
              {showBirthdayPopup.profilePhoto ? (
                <img src={showBirthdayPopup.profilePhoto} alt="" className="w-24 h-24 rounded-full mx-auto mb-4 object-cover border-4 border-pink-300" />
              ) : (
                <div className="w-24 h-24 rounded-full mx-auto mb-4 bg-gradient-to-br from-pink-400 to-purple-500 flex items-center justify-center text-4xl text-white font-bold">
                  {showBirthdayPopup.name?.charAt(0)}
                </div>
              )}
              <h4 className="text-2xl font-bold text-gray-800">{showBirthdayPopup.name}</h4>
              <p className="text-gray-500">{showBirthdayPopup.role || showBirthdayPopup.subject}</p>
              <p className="text-pink-600 mt-2 font-medium">üéà Wishing you a wonderful day! üéà</p>
              
              <button
                onClick={dismissBirthdayPopup}
                className="mt-6 px-8 py-3 bg-gradient-to-r from-pink-500 to-purple-600 text-white rounded-full font-semibold hover:shadow-lg transition-all"
              >
                Send Wishes! üéâ
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

// ========================================
// TIMESHEET - Daily Activity Logging
// ========================================
function TimesheetPage({ currentUser, teachers, curriculum, isAdmin = false, isSuperAdmin = false, accessibleSchools = [], managers = [] }) {
  // State for form
  const [selectedDate, setSelectedDate] = useState(new Date().toISOString().split('T')[0]);
  const [activityType, setActivityType] = useState('');
  const [selectedClass, setSelectedClass] = useState('');
  const [selectedChapter, setSelectedChapter] = useState('');
  const [selectedTopic, setSelectedTopic] = useState('');
  const [otherTopicText, setOtherTopicText] = useState(''); // For "Others" topic
  const [otherChapterText, setOtherChapterText] = useState(''); // For "Others" chapter
  const [testType, setTestType] = useState('');
  const [notes, setNotes] = useState('');
  
  // ‚úÖ NEW: Time picker state with dropdowns
  const [startHour, setStartHour] = useState('');
  const [startMinute, setStartMinute] = useState('');
  const [startPeriod, setStartPeriod] = useState('AM');
  const [endHour, setEndHour] = useState('');
  const [endMinute, setEndMinute] = useState('');
  const [endPeriod, setEndPeriod] = useState('PM');
  
  const [submitting, setSubmitting] = useState(false);
  
  // State for data
  const [timesheetEntries, setTimesheetEntries] = useState([]);
  const [pendingApprovals, setPendingApprovals] = useState([]);
  const [loading, setLoading] = useState(true);
  const [activeView, setActiveView] = useState(isAdmin ? 'analytics' : 'entry'); // Managers default to analytics
  
  // Filters
  const [filterSchool, setFilterSchool] = useState('All');
  const [filterTeacher, setFilterTeacher] = useState('All');
  const [filterMonth, setFilterMonth] = useState(new Date().toISOString().slice(0, 7));
  
  // Chart ref
  const chartRef = useRef(null);
  const chartInstance = useRef(null);

  const mySubject = currentUser.subject;
  const mySchool = currentUser.school;
  const myAfid = currentUser.afid || currentUser.uid || currentUser.id;
  
  // Check if current user is a manager (APM/PM/Program Head/Director/Training) - they shouldn't see entry form
  const isManager = isAdmin || currentUser.role === 'apm' || currentUser.role === 'pm' || 
                    currentUser.role === 'aph' || currentUser.role === MANAGER_ROLES.APM || 
                    currentUser.role === MANAGER_ROLES.PM || currentUser.role === MANAGER_ROLES.APH ||
                    currentUser.role === 'super_admin' || currentUser.role === 'director' ||
                    currentUser.role === 'assoc_director' || currentUser.role === 'training' ||
                    currentUser.role === MANAGER_ROLES.DIRECTOR || currentUser.role === MANAGER_ROLES.ASSOC_DIRECTOR ||
                    currentUser.role === MANAGER_ROLES.TRAINING;
  
  // ‚úÖ NEW: Check if user is Director/Associate Director/Training (view-only access)
  const isViewOnly = currentUser.role === 'director' || currentUser.role === 'assoc_director' || 
                     currentUser.role === 'training' ||
                     currentUser.role === MANAGER_ROLES.DIRECTOR || currentUser.role === MANAGER_ROLES.ASSOC_DIRECTOR ||
                     currentUser.role === MANAGER_ROLES.TRAINING;
  
  // Check if user can enter timesheet (Teacher or APC only)
  const canEnterTimesheet = !isManager && (currentUser.userType === 'teacher' || currentUser.userType === 'apc' || 
                            currentUser.role === 'apc' || currentUser.role === MANAGER_ROLES.APC ||
                            (!currentUser.role && currentUser.subject)); // Teachers don't always have role set
  
  // ‚úÖ PERFORMANCE: Memoize stable values to prevent unnecessary recalculations
  const stableMySchool = useMemo(() => mySchool, [mySchool]);
  const stableMySubject = useMemo(() => mySubject, [mySubject]);
  
  // Time dropdown options
  const HOURS = ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12'];
  const MINUTES = ['00', '05', '10', '15', '20', '25', '30', '35', '40', '45', '50', '55'];
  const PERIODS = ['AM', 'PM'];
  
  // Convert 12-hour to 24-hour format for calculations
  const to24Hour = (hour, period) => {
    let h = parseInt(hour);
    if (period === 'AM' && h === 12) h = 0;
    if (period === 'PM' && h !== 12) h += 12;
    return h;
  };
  
  // Get formatted time string for display/storage
  const getTimeString = (hour, minute, period) => {
    if (!hour || !minute) return '';
    const h24 = to24Hour(hour, period);
    return `${h24.toString().padStart(2, '0')}:${minute}`;
  };
  
  // Activity types
  const ACTIVITY_TYPES = [
    { id: 'teaching', label: 'üìö Teaching', icon: 'üìö' },
    { id: 'class_preparation', label: 'üìñ Preparation for Class', icon: 'üìñ' },
    { id: 'tests', label: 'üìù Tests', icon: 'üìù' },
    { id: 'mentoring', label: 'üë• Mentoring', icon: 'üë•' },
    { id: 'class_cancelled', label: 'üö´ Class Cancelled', icon: 'üö´' },
    { id: 'class_observation', label: 'üëÅÔ∏è Class Observation', icon: 'üëÅÔ∏è' },
    { id: 'jnv_school_work', label: 'üè´ JNV School Work', icon: 'üè´' },
    { id: 'data_entry', label: 'üíª Data Entry', icon: 'üíª' },
    { id: 'weekly_checkin', label: 'üóìÔ∏è Weekly Check-in Meetings', icon: 'üóìÔ∏è' },
    { id: 'others', label: 'üìã Others', icon: 'üìã' }
  ];
  
  const TEST_TYPES = [
    { id: 'chapter_test', label: 'Chapter Test' },
    { id: 'aiet', label: 'AIET' }
  ];
  
  // ‚úÖ FIXED: Get subject initial from subject name
  const getSubjectInitial = () => {
    const subject = mySubject?.toLowerCase()?.trim();
    if (!subject) return '';
    
    if (subject.includes('physics')) return 'p';
    if (subject.includes('chemistry')) return 'c';
    if (subject.includes('math') || subject.includes('maths') || subject.includes('mathematics')) return 'm';
    if (subject.includes('biology') || subject.includes('bio')) return 'b';
    
    // Fallback: use first letter
    return subject.charAt(0);
  };
  
  // ‚úÖ FIXED: Get chapters for teacher's subject - filter by grade AND subject
  // ‚úÖ IMPROVED: Better deduplication to prevent duplicate chapters
  const getChaptersForSubject = (grade) => {
    if (!grade) return [];
    
    const chaptersMap = new Map(); // Use Map for case-insensitive deduplication
    const subjectKey = mySubject?.toLowerCase()?.trim();
    const gradeStr = String(grade);
    const subjectInitial = getSubjectInitial();
    
    // Helper to check if chapter matches grade AND subject
    const chapterMatchesGradeAndSubject = (chapterName) => {
      if (!chapterName) return false;
      const name = chapterName.toLowerCase();
      
      // Check patterns like "11B1", "12C35", "11M2", "11P3" etc.
      // Format: [grade][subject_initial][chapter_number]
      const match = name.match(/^(\d{2})([a-z])(\d+)/i);
      if (match) {
        const chapterGrade = match[1];
        const chapterSubject = match[2].toLowerCase();
        
        // Must match both grade AND subject initial
        if (chapterGrade !== gradeStr) return false;
        if (subjectInitial && chapterSubject !== subjectInitial) return false;
        
        return true;
      }
      
      // If no standard prefix, include if it seems to match subject
      return name.includes(subjectKey);
    };
    
    // ‚úÖ FIX: Extract chapter number for proper deduplication
    // Chapters like "11P2 Rectilinear Motion" should deduplicate by "11P2"
    const getChapterKey = (name) => {
      const match = name.match(/^(\d{2}[a-zA-Z]\d+)/);
      return match ? match[1].toUpperCase() : name.toLowerCase().trim();
    };
    
    Object.entries(curriculum).forEach(([key, data]) => {
      const keyLower = key.toLowerCase();
      
      // Check if key matches subject and school
      const matchesSubject = subjectKey && keyLower.includes(subjectKey);
      const matchesSchool = keyLower.includes(mySchool?.toLowerCase() || '');
      
      // Only process if subject matches
      if (matchesSubject || matchesSchool) {
        if (data.chapters && Array.isArray(data.chapters)) {
          data.chapters.forEach(ch => {
            if (ch.name) {
              // Filter chapters by grade AND subject
              if (chapterMatchesGradeAndSubject(ch.name)) {
                const chapterKey = getChapterKey(ch.name);
                
                // ‚úÖ FIX: Only add if not already exists (case-insensitive key check)
                if (!chaptersMap.has(chapterKey)) {
                  chaptersMap.set(chapterKey, {
                    name: ch.name,
                    topics: ch.topics || []
                  });
                } else {
                  // ‚úÖ FIX: Merge topics if chapter already exists
                  const existing = chaptersMap.get(chapterKey);
                  const newTopics = ch.topics || [];
                  const existingTopicNames = new Set(existing.topics.map(t => (t.name || t).toLowerCase()));
                  newTopics.forEach(t => {
                    const topicName = (t.name || t).toLowerCase();
                    if (!existingTopicNames.has(topicName)) {
                      existing.topics.push(t);
                    }
                  });
                }
              }
            }
          });
        }
      }
    });
    
    // Convert Map to array and sort
    const chapters = Array.from(chaptersMap.values());
    
    // ‚úÖ FIX: Sort by chapter number (11P1 before 11P2, 11P10 after 11P9)
    chapters.sort((a, b) => {
      const matchA = a.name.match(/^(\d{2})([a-zA-Z])(\d+)/);
      const matchB = b.name.match(/^(\d{2})([a-zA-Z])(\d+)/);
      
      if (matchA && matchB) {
        // Compare grade first
        if (matchA[1] !== matchB[1]) return matchA[1].localeCompare(matchB[1]);
        // Then subject letter
        if (matchA[2].toLowerCase() !== matchB[2].toLowerCase()) return matchA[2].localeCompare(matchB[2]);
        // Then chapter number (as integer for proper sorting)
        return parseInt(matchA[3]) - parseInt(matchB[3]);
      }
      // Fallback to string comparison
      return a.name.localeCompare(b.name);
    });
    
    return chapters;
  };
  
  // Get topics for selected chapter
  const getTopicsForChapter = () => {
    if (!selectedClass || !selectedChapter || selectedChapter === 'Others') return [];
    const chapters = getChaptersForSubject(selectedClass);
    const chapter = chapters.find(ch => ch.name === selectedChapter);
    return chapter?.topics || [];
  };
  
  // ‚úÖ FIXED: Calculate hours from dropdown time values
  const calculateHours = () => {
    if (!startHour || !startMinute || !endHour || !endMinute) return 0;
    
    try {
      const startH24 = to24Hour(startHour, startPeriod);
      const endH24 = to24Hour(endHour, endPeriod);
      
      const startMinutes = startH24 * 60 + parseInt(startMinute);
      const endMinutes = endH24 * 60 + parseInt(endMinute);
      
      let diffMinutes = endMinutes - startMinutes;
      
      // Handle overnight (end time is next day)
      if (diffMinutes < 0) {
        diffMinutes += 24 * 60; // Add 24 hours
      }
      
      const hours = diffMinutes / 60;
      return hours > 0 ? hours.toFixed(2) : 0;
    } catch (e) {
      console.error('Error calculating hours:', e);
      return 0;
    }
  };
  
  const hoursWorked = calculateHours();
  
  // Get formatted start/end time for storage
  const startTime = getTimeString(startHour, startMinute, startPeriod);
  const endTime = getTimeString(endHour, endMinute, endPeriod);
  
  // ‚úÖ FIX: Ref to prevent infinite re-fetching
  const dataFetchedRef = useRef(false);
  const lastFetchParamsRef = useRef('');
  
  // ‚úÖ PERFORMANCE: Add state for fetch errors
  const [fetchError, setFetchError] = useState(null);
  
  // Fetch timesheet entries
  useEffect(() => {
    // ‚úÖ FIX: Create stable hash of fetch parameters to prevent unnecessary re-fetches
    const fetchParamsHash = JSON.stringify({
      isAdmin,
      isSuperAdmin,
      myAfid,
      managersCount: managers?.length || 0,
      currentUserName: currentUser?.name,
      currentUserRole: currentUser?.role
    });
    
    // ‚úÖ FIX: Skip if already fetched with same params
    if (dataFetchedRef.current && lastFetchParamsRef.current === fetchParamsHash) {
      return;
    }
    
    // ‚úÖ PERFORMANCE: Add timeout wrapper for slow connections
    const fetchWithTimeout = (promise, timeoutMs = 15000) => {
      return Promise.race([
        promise,
        new Promise((_, reject) => 
          setTimeout(() => reject(new Error('Request timeout - slow connection')), timeoutMs)
        )
      ]);
    };
    
    const fetchData = async () => {
      try {
        setLoading(true);
        setFetchError(null);
        
        // Get current manager's ID for lineManagerId matching
        const myManagerId = currentUser.managerId || currentUser.id || currentUser.uid || currentUser.afid;
        const myManagerName = currentUser.name;
        
        // Get this manager's profile
        const myManagerProfile = managers.find(m => m.id === myManagerId || m.name === myManagerName);
        const myDirectSchools = myManagerProfile?.directSchools || [];
        const myRole = myManagerProfile?.role || currentUser.role || '';
        
        // ‚úÖ FIX: Check for Director/Associate Director/Training roles (view-only, see all data)
        const isDirector = myRole === 'director' || myRole === 'assoc_director' || myRole === 'training';
        const hasViewAllAccess = isSuperAdmin || isDirector;
        
        // Single log instead of multiple
        console.log('Timesheet - Fetching data:', { isAdmin, isSuperAdmin, isDirector, myRole, schools: myDirectSchools.length });
        
        // IMPORTANT: For PM, filter out schools that have an APM assigned
        // This ensures APM sees their schools, PM only sees schools without an APM
        let schoolsToManage = [...myDirectSchools];
        
        if (myRole === 'pm') {
          // Find all APMs and their schools
          const apmSchools = new Set();
          managers.forEach(m => {
            if (m.role === 'apm' && m.status === 'active' && m.directSchools) {
              m.directSchools.forEach(school => apmSchools.add(school?.toLowerCase?.() || school));
            }
          });
          
          // PM only manages schools that DON'T have an APM - case-insensitive
          schoolsToManage = myDirectSchools.filter(school => !apmSchools.has(school?.toLowerCase?.() || school));
        }
        
        // Fetch entries based on role
        let entriesQuery;
        if (isAdmin) {
          if (hasViewAllAccess) {
            // Super admin, Director, Associate Director sees all
            entriesQuery = db.collection('timesheetEntries')
              .orderBy('date', 'desc')
              .limit(500);
          } else {
            // Regular Manager - fetch all and filter client-side
            entriesQuery = db.collection('timesheetEntries')
              .orderBy('date', 'desc')
              .limit(500);
          }
        } else {
          // Teacher sees own entries
          entriesQuery = db.collection('timesheetEntries')
            .where('teacherAfid', '==', myAfid)
            .orderBy('date', 'desc')
            .limit(100);
        }
        
        const entriesSnap = await entriesQuery.get();
        let entries = entriesSnap.docs.map(d => ({
          ...d.data(),
          id: d.id,
          date: d.data().date || '',
          createdAt: d.data().createdAt?.toDate?.() || new Date()
        }));
        
        // For non-super-admin/non-director managers, filter to show only their managed schools
        if (isAdmin && !hasViewAllAccess) {
          entries = entries.filter(e => {
            // ‚úÖ FIX: Use case-insensitive school matching
            const entrySchoolLower = (e.school || '').toString().toLowerCase().trim();
            const schoolMatch = schoolsToManage.some(s => s && s.toString().toLowerCase().trim() === entrySchoolLower);
            
            // OR if entry is specifically assigned to this manager
            const assignedToMe = e.lineManagerId === myManagerId || e.lineManagerName === myManagerName;
            
            return schoolMatch || assignedToMe;
          });
        }
        
        setTimesheetEntries(entries);
        
        // Fetch pending approvals for managers (NOT for Director/Associate Director - they're view-only)
        if (isAdmin && !isDirector) {
          let allPendingEntries = [];
          
          // Fetch all pending, then filter client-side
          try {
            const pendingSnap = await db.collection('timesheetEntries')
              .where('status', '==', 'pending')
              .get();
            
            allPendingEntries = pendingSnap.docs.map(d => ({
              ...d.data(),
              id: d.id
            }));
            
          } catch (e) {
            console.error('Error fetching pending entries:', e);
          }
          
          // Filter for non-super-admin managers
          if (!isSuperAdmin && allPendingEntries.length > 0) {
            allPendingEntries = allPendingEntries.filter(entry => {
              // Check if entry is directly assigned to this manager
              const managerIdMatch = entry.lineManagerId === myManagerId;
              const managerNameMatch = entry.lineManagerName === myManagerName;
              
              // ‚úÖ FIX: Check if teacher's school is in this manager's managed schools - case-insensitive
              const entrySchoolLower = (entry.school || '').toString().toLowerCase().trim();
              const schoolMatch = schoolsToManage.some(s => s && s.toString().toLowerCase().trim() === entrySchoolLower);
              
              return managerIdMatch || managerNameMatch || schoolMatch;
            });
          }
          
          // Sort by date descending
          allPendingEntries.sort((a, b) => {
            const dateA = a.date || '';
            const dateB = b.date || '';
            return dateB.localeCompare(dateA);
          });
          
          setPendingApprovals(allPendingEntries);
        } else if (isDirector) {
          // Directors see all pending but can't approve (view-only)
          setPendingApprovals([]);
        }
        
        // ‚úÖ FIX: Mark as fetched
        dataFetchedRef.current = true;
        lastFetchParamsRef.current = fetchParamsHash;
        
      } catch (error) {
        console.error('Error fetching timesheet data:', error);
        // ‚úÖ PERFORMANCE: Set user-friendly error message
        if (error.message.includes('timeout')) {
          setFetchError('Slow connection. Data may be loading from cache.');
        } else if (!navigator.onLine) {
          setFetchError('You are offline. Showing cached data if available.');
        } else {
          setFetchError('Could not load data. Please try again.');
        }
      } finally {
        setLoading(false);
      }
    };
    
    fetchData();
  }, [isAdmin, isSuperAdmin, myAfid, currentUser?.name, currentUser?.role, managers?.length]);
  
  // Submit timesheet entry
  const handleSubmit = async (e) => {
    e.preventDefault();
    
    if (!activityType) {
      alert('Please select an activity type');
      return;
    }
    
    if (!startHour || !startMinute || !endHour || !endMinute) {
      alert('Please select start and end time');
      return;
    }
    
    if (parseFloat(hoursWorked) <= 0) {
      alert('End time must be after start time');
      return;
    }
    
    // Validate based on activity type
    if (activityType === 'teaching' && (!selectedClass || !selectedChapter)) {
      alert('Please select class and chapter for teaching');
      return;
    }
    
    // ‚úÖ FIXED: AIET doesn't require chapter selection (only Chapter Test does)
    if (activityType === 'tests') {
      if (!testType || !selectedClass) {
        alert('Please select test type and class');
        return;
      }
      // Only require chapter for Chapter Test, not for AIET
      if (testType === 'chapter_test' && !selectedChapter) {
        alert('Please select chapter for Chapter Test');
        return;
      }
    }
    
    if (activityType === 'mentoring' && !selectedClass) {
      alert('Please select class for mentoring');
      return;
    }
    
    if (activityType === 'class_cancelled' && !selectedClass) {
      alert('Please select class for cancelled class');
      return;
    }
    
    if (activityType === 'class_preparation' && !selectedClass) {
      alert('Please select class for preparation');
      return;
    }
    
    try {
      setSubmitting(true);
      
      // Find line manager - use SAME logic as Team Directory
      let lineManagerId = null;
      let lineManagerName = null;
      
      console.log('Timesheet - Looking up line manager for:', {
        teacherName: currentUser.name,
        teacherAfid: myAfid,
        school: mySchool,
        managersAvailable: managers.length
      });
      
      // Debug: Show all managers and their schools
      console.log('Timesheet - Available managers:', managers.map(m => ({
        id: m.id,
        name: m.name,
        role: m.role,
        directSchools: m.directSchools,
        status: m.status
      })));
      
      // Use SAME logic as Team Directory getMemberManager function:
      // 1. Check APMs first (role === 'apm' && directSchools includes school && status active)
      const apm = managers.find(m => 
        m.role === 'apm' && 
        m.status === 'active' &&
        m.directSchools?.includes(mySchool)
      );
      
      if (apm) {
        lineManagerId = apm.id;
        lineManagerName = apm.name;
        console.log('Timesheet - Found APM for school:', { 
          apmId: apm.id, 
          apmName: apm.name, 
          school: mySchool,
          apmDirectSchools: apm.directSchools 
        });
      }
      
      // 2. Then check PMs (only if no APM found)
      if (!lineManagerId) {
        const pm = managers.find(m => 
          m.role === 'pm' && 
          m.status === 'active' &&
          m.directSchools?.includes(mySchool)
        );
        
        if (pm) {
          lineManagerId = pm.id;
          lineManagerName = pm.name;
          console.log('Timesheet - Found PM for school:', { 
            pmId: pm.id, 
            pmName: pm.name, 
            school: mySchool 
          });
        }
      }
      
      // 3. Fallback: Any manager with this school
      if (!lineManagerId) {
        const anyManager = managers.find(m => 
          m.directSchools?.includes(mySchool) &&
          m.status === 'active'
        );
        
        if (anyManager) {
          lineManagerId = anyManager.id;
          lineManagerName = anyManager.name;
          console.log('Timesheet - Found fallback manager for school:', { 
            managerId: anyManager.id, 
            managerName: anyManager.name, 
            school: mySchool 
          });
        }
      }
      
      // 4. Last resort: Fetch from Firestore directly
      if (!lineManagerId) {
        console.log('Timesheet - No manager found in local data, checking Firestore...');
        try {
          const managersSnap = await db.collection('managers')
            .where('directSchools', 'array-contains', mySchool)
            .where('status', '==', 'active')
            .limit(1)
            .get();
          
          if (!managersSnap.empty) {
            const managerDoc = managersSnap.docs[0];
            lineManagerId = managerDoc.id;
            lineManagerName = managerDoc.data().name;
            console.log('Timesheet - Found manager from Firestore:', { lineManagerId, lineManagerName });
          }
        } catch (e) {
          console.error('Timesheet - Error fetching manager from Firestore:', e);
        }
      }
      
      // Final result
      console.log('Timesheet Entry - Final Line Manager Assignment:', {
        teacherName: currentUser.name,
        school: mySchool,
        lineManagerId,
        lineManagerName,
        success: !!lineManagerId
      });
      
      if (!lineManagerId) {
        console.warn('‚ö†Ô∏è Timesheet - No line manager found for school:', mySchool);
        alert('‚ö†Ô∏è Warning: No line manager found for your school. Please contact admin to set up manager assignment for ' + mySchool);
      }
      
      const entry = {
        date: selectedDate,
        activityType: activityType,
        teacherAfid: myAfid,
        teacherName: currentUser.name,
        teacherEmail: currentUser.email,
        school: mySchool,
        subject: mySubject,
        class: selectedClass || null,
        chapter: selectedChapter === 'Others' ? otherChapterText : (selectedChapter || null),
        topic: selectedTopic === 'Others' ? otherTopicText : (selectedTopic || null),
        testType: testType || null,
        notes: notes || '',
        startTime: startTime,
        endTime: endTime,
        hours: parseFloat(hoursWorked),
        status: 'pending', // pending, approved, rejected
        lineManagerId: lineManagerId,
        lineManagerName: lineManagerName,
        submittedAt: firebase.firestore.FieldValue.serverTimestamp(),
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      };
      
      const docRef = await db.collection('timesheetEntries').add(entry);
      
      // Add to local state
      setTimesheetEntries(prev => [{
        ...entry,
        id: docRef.id,
        createdAt: new Date()
      }, ...prev]);
      
      // Reset form
      setActivityType('');
      setSelectedClass('');
      setSelectedChapter('');
      setSelectedTopic('');
      setOtherTopicText('');
      setOtherChapterText('');
      setTestType('');
      setNotes('');
      setStartHour('');
      setStartMinute('');
      setStartPeriod('AM');
      setEndHour('');
      setEndMinute('');
      setEndPeriod('PM');
      
      alert('‚úÖ Timesheet entry submitted for approval!');
      
    } catch (error) {
      console.error('Error submitting timesheet:', error);
      alert('Error submitting entry. Please try again.');
    } finally {
      setSubmitting(false);
    }
  };
  
  // Approve/Reject timesheet entry (for managers)
  const handleApproval = async (entryId, action) => {
    try {
      await db.collection('timesheetEntries').doc(entryId).update({
        status: action,
        approvedBy: currentUser.name,
        approvedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      
      // Update local state
      setPendingApprovals(prev => prev.filter(e => e.id !== entryId));
      setTimesheetEntries(prev => prev.map(e => 
        e.id === entryId ? { ...e, status: action } : e
      ));
      
      alert(`‚úÖ Entry ${action}!`);
    } catch (error) {
      console.error('Error updating approval:', error);
      alert('Error updating entry');
    }
  };
  
  // Delete timesheet entry (for Managers/APMs only)
  const handleDeleteEntry = async (entryId, teacherName) => {
    if (!isAdmin) {
      alert('‚ùå Only Managers and APMs can delete entries');
      return;
    }
    
    const confirmDelete = confirm(`‚ö†Ô∏è Delete Entry\n\nAre you sure you want to delete this timesheet entry for ${teacherName}?\n\nThis action cannot be undone.`);
    
    if (!confirmDelete) return;
    
    try {
      await db.collection('timesheetEntries').doc(entryId).delete();
      
      // Update local state
      setPendingApprovals(prev => prev.filter(e => e.id !== entryId));
      setTimesheetEntries(prev => prev.filter(e => e.id !== entryId));
      
      alert('‚úÖ Entry deleted successfully!');
    } catch (error) {
      console.error('Error deleting entry:', error);
      alert('‚ùå Error deleting entry. Please try again.');
    }
  };
  
  // Filter entries for display
  const filteredEntries = useMemo(() => {
    return timesheetEntries.filter(entry => {
      const matchesSchool = filterSchool === 'All' || entry.school === filterSchool;
      const matchesTeacher = filterTeacher === 'All' || entry.teacherAfid === filterTeacher;
      const matchesMonth = entry.date?.startsWith(filterMonth);
      return matchesSchool && matchesTeacher && matchesMonth;
    });
  }, [timesheetEntries, filterSchool, filterTeacher, filterMonth]);
  
  // Calculate stats for chart
  const chartData = useMemo(() => {
    const byType = {};
    filteredEntries.forEach(entry => {
      const type = entry.activityType || 'others';
      byType[type] = (byType[type] || 0) + (parseFloat(entry.hours) || 0);
    });
    return byType;
  }, [filteredEntries]);
  
  // Teacher aggregates for chart
  const teacherAggregates = useMemo(() => {
    const byTeacher = {};
    filteredEntries.forEach(entry => {
      const key = entry.teacherAfid;
      if (!byTeacher[key]) {
        byTeacher[key] = {
          name: entry.teacherName,
          school: entry.school,
          totalHours: 0,
          approved: 0,
          pending: 0
        };
      }
      byTeacher[key].totalHours += parseFloat(entry.hours) || 0;
      if (entry.status === 'approved') byTeacher[key].approved += parseFloat(entry.hours) || 0;
      if (entry.status === 'pending') byTeacher[key].pending += parseFloat(entry.hours) || 0;
    });
    return Object.values(byTeacher).sort((a, b) => b.totalHours - a.totalHours);
  }, [filteredEntries]);
  
  // Render Chart
  useEffect(() => {
    if (!chartRef.current || Object.keys(chartData).length === 0) return;
    
    if (chartInstance.current) {
      chartInstance.current.destroy();
    }
    
    const labels = ACTIVITY_TYPES.map(t => t.label.replace(/^[^\s]+\s/, ''));
    const data = ACTIVITY_TYPES.map(t => chartData[t.id] || 0);
    const colors = ['#F4B41A', '#3B82F6', '#10B981', '#8B5CF6', '#EF4444', '#6B7280'];
    
    chartInstance.current = new Chart(chartRef.current, {
      type: 'doughnut',
      data: {
        labels: labels,
        datasets: [{
          data: data,
          backgroundColor: colors,
          borderWidth: 2,
          borderColor: '#fff'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'bottom',
            labels: { padding: 15, font: { size: 12 } }
          },
          title: {
            display: true,
            text: 'Hours by Activity Type',
            font: { size: 16, weight: 'bold' }
          }
        }
      }
    });
    
    return () => {
      if (chartInstance.current) chartInstance.current.destroy();
    };
  }, [chartData]);
  
  // Get my total hours this month
  const myMonthlyHours = useMemo(() => {
    return timesheetEntries
      .filter(e => e.teacherAfid === myAfid && e.date?.startsWith(filterMonth))
      .reduce((sum, e) => sum + (parseFloat(e.hours) || 0), 0);
  }, [timesheetEntries, myAfid, filterMonth]);
  
  // Unique teachers for filter
  const uniqueTeachers = useMemo(() => {
    const map = {};
    timesheetEntries.forEach(e => {
      if (e.teacherAfid && !map[e.teacherAfid]) {
        map[e.teacherAfid] = { afid: e.teacherAfid, name: e.teacherName };
      }
    });
    return Object.values(map);
  }, [timesheetEntries]);

  if (loading) {
    return (
      <div className="flex items-center justify-center h-64">
        <div className="text-center">
          <div className="w-12 h-12 border-4 border-yellow-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
          <p className="text-gray-500 font-medium">Loading Timesheet...</p>
          <p className="text-xs text-gray-400 mt-2">
            {navigator.onLine ? 'üì∂ Connected' : 'üì¥ Offline - Loading from cache'}
          </p>
        </div>
      </div>
    );
  }
  
  // ‚úÖ PERFORMANCE: Show error state with retry option
  if (fetchError) {
    return (
      <div className="flex items-center justify-center h-64">
        <div className="text-center">
          <div className="text-5xl mb-4">‚ö†Ô∏è</div>
          <p className="text-gray-700 font-medium mb-2">Could not load timesheet</p>
          <p className="text-sm text-gray-500 mb-4">{fetchError}</p>
          <button 
            onClick={() => {
              dataFetchedRef.current = false;
              lastFetchParamsRef.current = '';
              setFetchError(null);
              setLoading(true);
            }}
            className="px-6 py-2 bg-yellow-500 text-white rounded-lg font-semibold hover:bg-yellow-600"
          >
            üîÑ Retry
          </button>
        </div>
      </div>
    );
  }

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="bg-gradient-to-r from-yellow-400 to-orange-500 text-white p-6 rounded-2xl shadow-lg">
        <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
          <div>
            <h1 className="text-2xl md:text-3xl font-bold flex items-center gap-3">
              ‚è±Ô∏è Timesheet
            </h1>
            <p className="opacity-90 mt-1">Track your daily activities and work hours</p>
          </div>
          <div className="flex gap-3">
            <div className="bg-white/20 px-4 py-2 rounded-xl text-center">
              <div className="text-2xl font-bold">{myMonthlyHours.toFixed(1)}</div>
              <div className="text-xs opacity-90">Hours This Month</div>
            </div>
          </div>
        </div>
      </div>
      
      {/* Navigation Tabs */}
      <div className="flex flex-wrap gap-2 bg-white p-2 rounded-xl shadow">
        {/* Only show New Entry and My Logs for teachers/APC who can enter timesheet */}
        {canEnterTimesheet && (
          <>
            <button 
              onClick={() => setActiveView('entry')}
              className={`px-4 py-2 rounded-lg font-semibold transition-all ${activeView === 'entry' ? 'avanti-gradient text-white' : 'bg-gray-100 hover:bg-gray-200'}`}
            >
              ‚ûï New Entry
            </button>
            <button 
              onClick={() => setActiveView('myLogs')}
              className={`px-4 py-2 rounded-lg font-semibold transition-all ${activeView === 'myLogs' ? 'avanti-gradient text-white' : 'bg-gray-100 hover:bg-gray-200'}`}
            >
              üìã My Logs
            </button>
          </>
        )}
        {isAdmin && (
          <button 
            onClick={() => setActiveView('approvals')}
            className={`px-4 py-2 rounded-lg font-semibold transition-all ${activeView === 'approvals' ? 'avanti-gradient text-white' : 'bg-gray-100 hover:bg-gray-200'}`}
          >
            ‚úÖ Approvals {pendingApprovals.length > 0 && <span className="ml-1 px-2 py-0.5 bg-red-500 text-white text-xs rounded-full">{pendingApprovals.length}</span>}
          </button>
        )}
        {isAdmin && (
          <button 
            onClick={() => setActiveView('allEntries')}
            className={`px-4 py-2 rounded-lg font-semibold transition-all ${activeView === 'allEntries' ? 'avanti-gradient text-white' : 'bg-gray-100 hover:bg-gray-200'}`}
          >
            üìã All Entries
          </button>
        )}
        <button 
          onClick={() => setActiveView('analytics')}
          className={`px-4 py-2 rounded-lg font-semibold transition-all ${activeView === 'analytics' ? 'avanti-gradient text-white' : 'bg-gray-100 hover:bg-gray-200'}`}
        >
          üìä Analytics
        </button>
      </div>
      
      {/* New Entry Form - Only for Teachers and APC */}
      {activeView === 'entry' && canEnterTimesheet && (
        <div className="grid md:grid-cols-3 gap-6">
          {/* Entry Form */}
          <div className="md:col-span-2 bg-white p-8 rounded-2xl shadow-lg">
            <h2 className="text-2xl font-bold mb-8 flex items-center gap-3">
              <span className="text-3xl">üìù</span> Log Activity
            </h2>
            
            <form onSubmit={handleSubmit} className="space-y-6">
              {/* Date Selection */}
              <div>
                <label className="block text-base font-semibold text-gray-700 mb-3">üìÖ Date</label>
                <input
                  type="date"
                  value={selectedDate}
                  onChange={e => setSelectedDate(e.target.value)}
                  max={new Date().toISOString().split('T')[0]}
                  className="w-full border-2 border-gray-200 px-5 py-4 rounded-xl text-lg focus:border-yellow-500 focus:ring-2 focus:ring-yellow-200 transition-all"
                  required
                />
              </div>
              
              {/* Activity Type Selection */}
              <div>
                <label className="block text-base font-semibold text-gray-700 mb-3">üéØ Activity Type</label>
                <select
                  value={activityType}
                  onChange={e => {
                    setActivityType(e.target.value);
                    setSelectedClass('');
                    setSelectedChapter('');
                    setSelectedTopic('');
                    setTestType('');
                  }}
                  className="w-full border-2 border-gray-200 px-5 py-4 rounded-xl text-lg focus:border-yellow-500 focus:ring-2 focus:ring-yellow-200 transition-all appearance-none bg-white cursor-pointer"
                  required
                >
                  <option value="">-- Select Activity --</option>
                  {ACTIVITY_TYPES.map(type => (
                    <option key={type.id} value={type.id}>{type.label}</option>
                  ))}
                </select>
              </div>
              
              {/* TEACHING FIELDS */}
              {activityType === 'teaching' && (
                <>
                  <div className="grid md:grid-cols-2 gap-5">
                    <div>
                      <label className="block text-base font-semibold text-gray-700 mb-3">üéì Class</label>
                      <select
                        value={selectedClass}
                        onChange={e => {
                          setSelectedClass(e.target.value);
                          setSelectedChapter('');
                          setSelectedTopic('');
                          setOtherChapterText('');
                          setOtherTopicText('');
                        }}
                        className="w-full border-2 border-gray-200 px-5 py-4 rounded-xl text-lg focus:border-yellow-500 transition-all"
                        required
                      >
                        <option value="">-- Select Class --</option>
                        <option value="11">Class 11</option>
                        <option value="12">Class 12</option>
                      </select>
                    </div>
                    
                    <div>
                      <label className="block text-base font-semibold text-gray-700 mb-3">üìñ Chapter</label>
                      <select
                        value={selectedChapter}
                        onChange={e => {
                          setSelectedChapter(e.target.value);
                          setSelectedTopic('');
                          setOtherTopicText('');
                          if (e.target.value !== 'Others') setOtherChapterText('');
                        }}
                        className="w-full border-2 border-gray-200 px-5 py-4 rounded-xl text-lg focus:border-yellow-500 transition-all"
                        required
                        disabled={!selectedClass}
                      >
                        <option value="">-- Select Chapter --</option>
                        {getChaptersForSubject(selectedClass).map((ch, idx) => (
                          <option key={idx} value={ch.name}>{ch.name}</option>
                        ))}
                        <option value="Others">Others</option>
                      </select>
                    </div>
                  </div>
                  
                  {/* Show text input if "Others" is selected for chapter */}
                  {selectedChapter === 'Others' && (
                    <div>
                      <label className="block text-base font-semibold text-gray-700 mb-3">‚úèÔ∏è Enter Chapter Name</label>
                      <input
                        type="text"
                        value={otherChapterText}
                        onChange={e => setOtherChapterText(e.target.value)}
                        placeholder="Enter the chapter name..."
                        className="w-full border-2 border-gray-200 px-5 py-4 rounded-xl text-lg focus:border-yellow-500 transition-all"
                        required
                      />
                    </div>
                  )}
                  
                  <div>
                    <label className="block text-base font-semibold text-gray-700 mb-3">üìë Topic</label>
                    <select
                      value={selectedTopic}
                      onChange={e => {
                        setSelectedTopic(e.target.value);
                        if (e.target.value !== 'Others') setOtherTopicText('');
                      }}
                      className="w-full border-2 border-gray-200 px-5 py-4 rounded-xl text-lg focus:border-yellow-500 transition-all"
                      disabled={!selectedChapter}
                    >
                      <option value="">-- Select Topic (Optional) --</option>
                      {getTopicsForChapter().map((topic, idx) => (
                        <option key={idx} value={typeof topic === 'string' ? topic : topic.name}>
                          {typeof topic === 'string' ? topic : topic.name}
                        </option>
                      ))}
                      <option value="Others">Others</option>
                    </select>
                  </div>
                  
                  {/* Show text input if "Others" is selected for topic */}
                  {selectedTopic === 'Others' && (
                    <div>
                      <label className="block text-base font-semibold text-gray-700 mb-3">‚úèÔ∏è Enter Topic Name</label>
                      <input
                        type="text"
                        value={otherTopicText}
                        onChange={e => setOtherTopicText(e.target.value)}
                        placeholder="Enter the topic name..."
                        className="w-full border-2 border-gray-200 px-5 py-4 rounded-xl text-lg focus:border-yellow-500 transition-all"
                        required
                      />
                    </div>
                  )}
                </>
              )}
              
              {/* TESTS FIELDS */}
              {activityType === 'tests' && (
                <>
                  <div>
                    <label className="block text-base font-semibold text-gray-700 mb-3">üìù Test Type</label>
                    <select
                      value={testType}
                      onChange={e => {
                        setTestType(e.target.value);
                        // Clear chapter when switching to AIET
                        if (e.target.value === 'aiet') {
                          setSelectedChapter('');
                        }
                      }}
                      className="w-full border-2 border-gray-200 px-5 py-4 rounded-xl text-lg focus:border-yellow-500 transition-all"
                      required
                    >
                      <option value="">-- Select Test Type --</option>
                      {TEST_TYPES.map(t => (
                        <option key={t.id} value={t.id}>{t.label}</option>
                      ))}
                    </select>
                  </div>
                  
                  {/* ‚úÖ FIXED: Show class selection for all test types */}
                  <div>
                    <label className="block text-base font-semibold text-gray-700 mb-3">üéì Class</label>
                    <select
                      value={selectedClass}
                      onChange={e => {
                        setSelectedClass(e.target.value);
                        setSelectedChapter('');
                      }}
                      className="w-full border-2 border-gray-200 px-5 py-4 rounded-xl text-lg focus:border-yellow-500 transition-all"
                      required
                    >
                      <option value="">-- Select Class --</option>
                      <option value="11">Class 11</option>
                      <option value="12">Class 12</option>
                    </select>
                  </div>
                  
                  {/* ‚úÖ FIXED: Only show chapter selection for Chapter Test, not AIET */}
                  {testType === 'chapter_test' && (
                    <div>
                      <label className="block text-base font-semibold text-gray-700 mb-3">üìñ Chapter</label>
                      <select
                        value={selectedChapter}
                        onChange={e => setSelectedChapter(e.target.value)}
                        className="w-full border-2 border-gray-200 px-5 py-4 rounded-xl text-lg focus:border-yellow-500 transition-all"
                        required
                        disabled={!selectedClass}
                      >
                        <option value="">-- Select Chapter --</option>
                        {getChaptersForSubject(selectedClass).map((ch, idx) => (
                          <option key={idx} value={ch.name}>{ch.name}</option>
                        ))}
                        <option value="Others">Others</option>
                      </select>
                    </div>
                  )}
                  
                  {/* Info for AIET */}
                  {testType === 'aiet' && (
                    <div className="bg-blue-50 border border-blue-200 p-4 rounded-xl">
                      <p className="text-blue-700 text-sm">
                        <strong>‚ÑπÔ∏è AIET:</strong> All India Entrance Test - covers full syllabus, no specific chapter selection needed.
                      </p>
                    </div>
                  )}
                  
                  <div>
                    <label className="block text-base font-semibold text-gray-700 mb-3">üìù Notes</label>
                    <textarea
                      value={notes}
                      onChange={e => setNotes(e.target.value)}
                      placeholder="Add any notes about the test..."
                      className="w-full border-2 border-gray-200 px-5 py-4 rounded-xl text-lg focus:border-yellow-500 transition-all min-h-[100px] resize-y"
                    />
                  </div>
                </>
              )}
              
              {/* MENTORING FIELDS */}
              {activityType === 'mentoring' && (
                <>
                  <div>
                    <label className="block text-base font-semibold text-gray-700 mb-3">üéì Class</label>
                    <select
                      value={selectedClass}
                      onChange={e => setSelectedClass(e.target.value)}
                      className="w-full border-2 border-gray-200 px-5 py-4 rounded-xl text-lg focus:border-yellow-500 transition-all"
                      required
                    >
                      <option value="">-- Select Class --</option>
                      <option value="11">Class 11</option>
                      <option value="12">Class 12</option>
                    </select>
                  </div>
                  
                  <div>
                    <label className="block text-base font-semibold text-gray-700 mb-3">üìù Notes</label>
                    <textarea
                      value={notes}
                      onChange={e => setNotes(e.target.value)}
                      placeholder="What did you discuss during mentoring?"
                      className="w-full border-2 border-gray-200 px-5 py-4 rounded-xl text-lg focus:border-yellow-500 transition-all min-h-[100px] resize-y"
                    />
                  </div>
                </>
              )}
              
              {/* CLASS CANCELLED FIELDS */}
              {activityType === 'class_cancelled' && (
                <>
                  <div>
                    <label className="block text-base font-semibold text-gray-700 mb-3">üéì Class</label>
                    <select
                      value={selectedClass}
                      onChange={e => setSelectedClass(e.target.value)}
                      className="w-full border-2 border-gray-200 px-5 py-4 rounded-xl text-lg focus:border-yellow-500 transition-all"
                      required
                    >
                      <option value="">-- Select Class --</option>
                      <option value="11">Class 11</option>
                      <option value="12">Class 12</option>
                    </select>
                  </div>
                  
                  <div>
                    <label className="block text-base font-semibold text-gray-700 mb-3">üìù Reason for Cancellation</label>
                    <textarea
                      value={notes}
                      onChange={e => setNotes(e.target.value)}
                      placeholder="Please provide the reason why the class was cancelled..."
                      className="w-full border-2 border-gray-200 px-5 py-4 rounded-xl text-lg focus:border-yellow-500 transition-all min-h-[100px] resize-y"
                      required
                    />
                  </div>
                </>
              )}
              
              {/* ‚úÖ NEW: CLASS OBSERVATION FIELDS */}
              {activityType === 'class_observation' && (
                <>
                  <div className="bg-blue-50 border border-blue-200 p-4 rounded-xl mb-4">
                    <p className="text-blue-700 text-sm">
                      <strong>üëÅÔ∏è Class Observation:</strong> Record time spent observing classes for quality assessment and feedback.
                    </p>
                  </div>
                  
                  <div>
                    <label className="block text-base font-semibold text-gray-700 mb-3">üéì Class Observed</label>
                    <select
                      value={selectedClass}
                      onChange={e => setSelectedClass(e.target.value)}
                      className="w-full border-2 border-gray-200 px-5 py-4 rounded-xl text-lg focus:border-yellow-500 transition-all"
                      required
                    >
                      <option value="">-- Select Class --</option>
                      <option value="11">Class 11</option>
                      <option value="12">Class 12</option>
                    </select>
                  </div>
                  
                  <div>
                    <label className="block text-base font-semibold text-gray-700 mb-3">üìù Observation Notes</label>
                    <textarea
                      value={notes}
                      onChange={e => setNotes(e.target.value)}
                      placeholder="Enter observation details, feedback points, areas of improvement..."
                      className="w-full border-2 border-gray-200 px-5 py-4 rounded-xl text-lg focus:border-yellow-500 transition-all min-h-[120px] resize-y"
                      required
                    />
                  </div>
                </>
              )}
              
              {/* ‚úÖ NEW: JNV SCHOOL WORK FIELDS */}
              {activityType === 'jnv_school_work' && (
                <>
                  <div className="bg-green-50 border border-green-200 p-4 rounded-xl mb-4">
                    <p className="text-green-700 text-sm">
                      <strong>üè´ JNV School Work:</strong> Record time spent on JNV-related administrative or school work.
                    </p>
                  </div>
                  
                  <div>
                    <label className="block text-base font-semibold text-gray-700 mb-3">üìù Work Description</label>
                    <textarea
                      value={notes}
                      onChange={e => setNotes(e.target.value)}
                      placeholder="Describe the JNV school work done (e.g., exam supervision, duty assignments, administrative tasks, coordination meetings...)"
                      className="w-full border-2 border-gray-200 px-5 py-4 rounded-xl text-lg focus:border-yellow-500 transition-all min-h-[120px] resize-y"
                      required
                    />
                  </div>
                </>
              )}
              
              {/* CLASS PREPARATION FIELDS */}
              {activityType === 'class_preparation' && (
                <>
                  <div>
                    <label className="block text-base font-semibold text-gray-700 mb-3">üéì Class</label>
                    <select
                      value={selectedClass}
                      onChange={e => setSelectedClass(e.target.value)}
                      className="w-full border-2 border-gray-200 px-5 py-4 rounded-xl text-lg focus:border-yellow-500 transition-all"
                      required
                    >
                      <option value="">-- Select Class --</option>
                      <option value="11">Class 11</option>
                      <option value="12">Class 12</option>
                    </select>
                  </div>
                  
                  <div>
                    <label className="block text-base font-semibold text-gray-700 mb-3">üìù Preparation Notes</label>
                    <textarea
                      value={notes}
                      onChange={e => setNotes(e.target.value)}
                      placeholder="What did you prepare? (e.g., lesson plan, teaching materials, practice problems, lab setup...)"
                      className="w-full border-2 border-gray-200 px-5 py-4 rounded-xl text-lg focus:border-yellow-500 transition-all min-h-[120px] resize-y"
                      required
                    />
                  </div>
                </>
              )}
              
              {/* DATA ENTRY / WEEKLY CHECKIN / OTHERS FIELDS */}
              {(activityType === 'data_entry' || activityType === 'weekly_checkin' || activityType === 'others') && (
                <div>
                  <label className="block text-base font-semibold text-gray-700 mb-3">üìù Notes / Description</label>
                  <textarea
                    value={notes}
                    onChange={e => setNotes(e.target.value)}
                    placeholder="Describe what you worked on..."
                    className="w-full border-2 border-gray-200 px-5 py-4 rounded-xl text-lg focus:border-yellow-500 transition-all min-h-[120px] resize-y"
                    required
                  />
                </div>
              )}
              
              {/* ‚úÖ NEW: Time Entry with Dropdown Selectors */}
              <div className="bg-gradient-to-r from-yellow-50 to-orange-50 p-6 rounded-2xl border-2 border-yellow-200">
                <div className="text-base font-bold text-gray-700 mb-5 flex items-center gap-2">
                  <span className="text-xl">‚è∞</span> Work Duration
                </div>
                
                {/* Start Time */}
                <div className="mb-6">
                  <label className="block text-base font-semibold text-gray-600 mb-3">
                    üü¢ Start Time
                  </label>
                  <div className="flex gap-3 items-center flex-wrap">
                    <select
                      value={startHour}
                      onChange={e => setStartHour(e.target.value)}
                      className="border-2 border-gray-200 px-4 py-4 rounded-xl text-lg font-medium focus:border-yellow-500 transition-all min-w-[90px] text-center"
                    >
                      <option value="">Hour</option>
                      {HOURS.map(h => (
                        <option key={h} value={h}>{h}</option>
                      ))}
                    </select>
                    <span className="text-2xl font-bold text-gray-400">:</span>
                    <select
                      value={startMinute}
                      onChange={e => setStartMinute(e.target.value)}
                      className="border-2 border-gray-200 px-4 py-4 rounded-xl text-lg font-medium focus:border-yellow-500 transition-all min-w-[90px] text-center"
                    >
                      <option value="">Min</option>
                      {MINUTES.map(m => (
                        <option key={m} value={m}>{m}</option>
                      ))}
                    </select>
                    <select
                      value={startPeriod}
                      onChange={e => setStartPeriod(e.target.value)}
                      className="border-2 border-yellow-300 bg-yellow-100 px-4 py-4 rounded-xl text-lg font-bold focus:border-yellow-500 transition-all min-w-[80px] text-center"
                    >
                      {PERIODS.map(p => (
                        <option key={p} value={p}>{p}</option>
                      ))}
                    </select>
                    {startHour && startMinute && (
                      <span className="text-gray-600 font-medium ml-2">
                        ({startHour}:{startMinute} {startPeriod})
                      </span>
                    )}
                  </div>
                </div>
                
                {/* End Time */}
                <div className="mb-6">
                  <label className="block text-base font-semibold text-gray-600 mb-3">
                    üî¥ End Time
                  </label>
                  <div className="flex gap-3 items-center flex-wrap">
                    <select
                      value={endHour}
                      onChange={e => setEndHour(e.target.value)}
                      className="border-2 border-gray-200 px-4 py-4 rounded-xl text-lg font-medium focus:border-yellow-500 transition-all min-w-[90px] text-center"
                    >
                      <option value="">Hour</option>
                      {HOURS.map(h => (
                        <option key={h} value={h}>{h}</option>
                      ))}
                    </select>
                    <span className="text-2xl font-bold text-gray-400">:</span>
                    <select
                      value={endMinute}
                      onChange={e => setEndMinute(e.target.value)}
                      className="border-2 border-gray-200 px-4 py-4 rounded-xl text-lg font-medium focus:border-yellow-500 transition-all min-w-[90px] text-center"
                    >
                      <option value="">Min</option>
                      {MINUTES.map(m => (
                        <option key={m} value={m}>{m}</option>
                      ))}
                    </select>
                    <select
                      value={endPeriod}
                      onChange={e => setEndPeriod(e.target.value)}
                      className="border-2 border-orange-300 bg-orange-100 px-4 py-4 rounded-xl text-lg font-bold focus:border-orange-500 transition-all min-w-[80px] text-center"
                    >
                      {PERIODS.map(p => (
                        <option key={p} value={p}>{p}</option>
                      ))}
                    </select>
                    {endHour && endMinute && (
                      <span className="text-gray-600 font-medium ml-2">
                        ({endHour}:{endMinute} {endPeriod})
                      </span>
                    )}
                  </div>
                </div>
                
                {/* Total Hours Display */}
                <div className={`p-5 rounded-xl text-center ${
                  parseFloat(hoursWorked) > 0 
                    ? 'bg-green-100 border-2 border-green-300' 
                    : 'bg-white border-2 border-gray-200'
                }`}>
                  <div className="text-sm font-semibold text-gray-600 mb-2">‚è±Ô∏è Total Hours</div>
                  <div className={`text-4xl font-bold ${
                    parseFloat(hoursWorked) > 0 ? 'text-green-600' : 'text-gray-400'
                  }`}>
                    {hoursWorked || '0.00'}
                    <span className="text-lg font-medium ml-1">hrs</span>
                  </div>
                  {parseFloat(hoursWorked) > 0 && (
                    <div className="text-sm text-green-600 mt-1">
                      ({Math.floor(parseFloat(hoursWorked))} hours {Math.round((parseFloat(hoursWorked) % 1) * 60)} minutes)
                    </div>
                  )}
                </div>
                
                {parseFloat(hoursWorked) <= 0 && startHour && startMinute && endHour && endMinute && (
                  <div className="mt-3 text-sm text-red-500 text-center font-medium">
                    ‚ö†Ô∏è End time must be after start time
                  </div>
                )}
              </div>
              
              {/* Submit Button */}
              <button
                type="submit"
                disabled={submitting || !activityType}
                className="w-full avanti-gradient text-white py-5 rounded-xl font-bold text-xl hover:shadow-xl transition-all disabled:opacity-50 transform hover:scale-[1.02] active:scale-[0.98]"
              >
                {submitting ? '‚è≥ Submitting...' : '‚úÖ Submit for Approval'}
              </button>
            </form>
          </div>
          
          {/* Quick Stats & Chart */}
          <div className="space-y-6">
            {/* Today's Summary */}
            <div className="bg-white p-6 rounded-xl shadow-lg">
              <h3 className="font-bold text-lg mb-4">üìÖ Today's Logs</h3>
              {timesheetEntries.filter(e => e.date === new Date().toISOString().split('T')[0] && e.teacherAfid === myAfid).length === 0 ? (
                <p className="text-gray-500 text-center py-4">No entries today</p>
              ) : (
                <div className="space-y-2">
                  {timesheetEntries
                    .filter(e => e.date === new Date().toISOString().split('T')[0] && e.teacherAfid === myAfid)
                    .map(entry => (
                      <div key={entry.id} className="p-3 bg-gray-50 rounded-lg">
                        <div className="flex justify-between items-center">
                          <span className="font-semibold">{ACTIVITY_TYPES.find(t => t.id === entry.activityType)?.icon} {ACTIVITY_TYPES.find(t => t.id === entry.activityType)?.label.replace(/^[^\s]+\s/, '')}</span>
                          <span className="text-yellow-600 font-bold">{entry.hours}h</span>
                        </div>
                        <div className="text-xs text-gray-500 mt-1">
                          {entry.startTime} - {entry.endTime}
                          <span className={`ml-2 px-2 py-0.5 rounded-full text-xs ${
                            entry.status === 'approved' ? 'bg-green-100 text-green-700' :
                            entry.status === 'rejected' ? 'bg-red-100 text-red-700' :
                            'bg-yellow-100 text-yellow-700'
                          }`}>
                            {entry.status}
                          </span>
                        </div>
                      </div>
                    ))
                  }
                </div>
              )}
            </div>
            
            {/* Mini Chart */}
            <div className="bg-white p-6 rounded-xl shadow-lg">
              <h3 className="font-bold text-lg mb-4">üìä This Month's Breakdown</h3>
              <div style={{ height: '200px' }}>
                <canvas ref={chartRef}></canvas>
              </div>
            </div>
          </div>
        </div>
      )}
      
      {/* My Logs View - Only for Teachers and APC */}
      {activeView === 'myLogs' && canEnterTimesheet && (
        <div className="bg-white p-6 rounded-xl shadow-lg">
          <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
            <h2 className="text-xl font-bold">üìã My Activity Logs</h2>
            <div className="flex gap-3">
              <input
                type="month"
                value={filterMonth}
                onChange={e => setFilterMonth(e.target.value)}
                className="border-2 px-4 py-2 rounded-xl"
              />
            </div>
          </div>
          
          {/* Summary Cards */}
          <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <div className="bg-yellow-50 p-4 rounded-xl border-l-4 border-yellow-500">
              <div className="text-sm text-yellow-700">Total Hours</div>
              <div className="text-2xl font-bold text-yellow-600">
                {timesheetEntries.filter(e => e.teacherAfid === myAfid && e.date?.startsWith(filterMonth)).reduce((s, e) => s + (parseFloat(e.hours) || 0), 0).toFixed(1)}h
              </div>
            </div>
            <div className="bg-green-50 p-4 rounded-xl border-l-4 border-green-500">
              <div className="text-sm text-green-700">Approved</div>
              <div className="text-2xl font-bold text-green-600">
                {timesheetEntries.filter(e => e.teacherAfid === myAfid && e.date?.startsWith(filterMonth) && e.status === 'approved').reduce((s, e) => s + (parseFloat(e.hours) || 0), 0).toFixed(1)}h
              </div>
            </div>
            <div className="bg-orange-50 p-4 rounded-xl border-l-4 border-orange-500">
              <div className="text-sm text-orange-700">Pending</div>
              <div className="text-2xl font-bold text-orange-600">
                {timesheetEntries.filter(e => e.teacherAfid === myAfid && e.date?.startsWith(filterMonth) && e.status === 'pending').reduce((s, e) => s + (parseFloat(e.hours) || 0), 0).toFixed(1)}h
              </div>
            </div>
            <div className="bg-blue-50 p-4 rounded-xl border-l-4 border-blue-500">
              <div className="text-sm text-blue-700">Total Entries</div>
              <div className="text-2xl font-bold text-blue-600">
                {timesheetEntries.filter(e => e.teacherAfid === myAfid && e.date?.startsWith(filterMonth)).length}
              </div>
            </div>
          </div>
          
          {/* Logs Table */}
          <div className="overflow-x-auto">
            <table className="w-full">
              <thead className="avanti-gradient-light">
                <tr>
                  <th className="p-3 text-left">Date</th>
                  <th className="p-3 text-left">Activity</th>
                  <th className="p-3 text-left">Details</th>
                  <th className="p-3 text-left">Hours</th>
                  <th className="p-3 text-left">Approver</th>
                  <th className="p-3 text-left">Status</th>
                </tr>
              </thead>
              <tbody>
                {timesheetEntries
                  .filter(e => e.teacherAfid === myAfid && e.date?.startsWith(filterMonth))
                  .sort((a, b) => new Date(b.date) - new Date(a.date))
                  .map(entry => (
                    <tr key={entry.id} className="border-b hover:bg-gray-50">
                      <td className="p-3">
                        <div className="font-semibold">{new Date(entry.date).toLocaleDateString('en-IN', { day: '2-digit', month: 'short' })}</div>
                        <div className="text-xs text-gray-500">{entry.startTime} - {entry.endTime}</div>
                      </td>
                      <td className="p-3">
                        <span className="px-3 py-1 bg-gray-100 rounded-full text-sm">
                          {ACTIVITY_TYPES.find(t => t.id === entry.activityType)?.icon} {ACTIVITY_TYPES.find(t => t.id === entry.activityType)?.label.replace(/^[^\s]+\s/, '')}
                        </span>
                      </td>
                      <td className="p-3">
                        <div className="text-sm">
                          {entry.class && <span className="text-blue-600">Class {entry.class}</span>}
                          {entry.chapter && <span className="text-gray-600"> | {entry.chapter}</span>}
                          {entry.topic && <span className="text-gray-500"> | {entry.topic}</span>}
                          {entry.testType && <span className="text-purple-600"> ({entry.testType === 'chapter_test' ? 'Chapter Test' : 'AIET'})</span>}
                        </div>
                        {entry.notes && <div className="text-xs text-gray-500 mt-1 truncate max-w-xs">{entry.notes}</div>}
                      </td>
                      <td className="p-3">
                        <span className="text-lg font-bold text-yellow-600">{entry.hours}h</span>
                      </td>
                      <td className="p-3">
                        <div className="text-sm">
                          {entry.status === 'approved' || entry.status === 'rejected' ? (
                            <span className="text-gray-600">{entry.approvedBy || 'Manager'}</span>
                          ) : (
                            <span className="text-orange-600">{entry.lineManagerName || 'Pending assignment'}</span>
                          )}
                        </div>
                      </td>
                      <td className="p-3">
                        <span className={`px-3 py-1 rounded-full text-sm font-semibold ${
                          entry.status === 'approved' ? 'bg-green-100 text-green-700' :
                          entry.status === 'rejected' ? 'bg-red-100 text-red-700' :
                          'bg-yellow-100 text-yellow-700'
                        }`}>
                          {entry.status === 'approved' ? '‚úÖ Approved' : entry.status === 'rejected' ? '‚ùå Rejected' : '‚è≥ Pending'}
                        </span>
                      </td>
                    </tr>
                  ))
                }
              </tbody>
            </table>
            {timesheetEntries.filter(e => e.teacherAfid === myAfid && e.date?.startsWith(filterMonth)).length === 0 && (
              <div className="text-center py-12 text-gray-500">
                <div className="text-4xl mb-2">üì≠</div>
                <div>No entries for this month</div>
              </div>
            )}
          </div>
        </div>
      )}
      
      {/* Approvals View (Admin Only) */}
      {activeView === 'approvals' && isAdmin && (
        <div className="bg-white p-6 rounded-xl shadow-lg">
          <h2 className="text-xl font-bold mb-6 flex items-center gap-2">
            <span className="text-2xl">‚úÖ</span> Pending Approvals
            {pendingApprovals.length > 0 && (
              <span className="px-3 py-1 bg-red-100 text-red-700 rounded-full text-sm">{pendingApprovals.length} pending</span>
            )}
            {isViewOnly && (
              <span className="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm ml-2">View Only</span>
            )}
          </h2>
          
          {/* Directors (view-only) see a notice instead of approval buttons */}
          {isViewOnly && pendingApprovals.length > 0 && (
            <div className="mb-4 p-4 bg-blue-50 border-2 border-blue-200 rounded-xl">
              <p className="text-blue-700 font-semibold">üëÅÔ∏è View Only Mode</p>
              <p className="text-sm text-blue-600">As a Director/Associate Director, you can view all timesheet entries but cannot approve or reject them.</p>
            </div>
          )}
          
          {pendingApprovals.length === 0 ? (
            <div className="text-center py-12 text-gray-500">
              <div className="text-6xl mb-4">‚ú®</div>
              <div className="text-xl font-semibold">All caught up!</div>
              <div className="text-sm mt-2">No pending approvals</div>
            </div>
          ) : (
            <div className="space-y-4">
              {pendingApprovals.map(entry => (
                <div key={entry.id} className="border-2 border-yellow-200 bg-yellow-50 p-4 rounded-xl">
                  <div className="flex flex-col md:flex-row justify-between gap-4">
                    <div className="flex-1">
                      <div className="flex items-center gap-3 mb-2 flex-wrap">
                        <span className="font-bold text-lg">{entry.teacherName}</span>
                        <span className="px-2 py-0.5 bg-gray-200 rounded text-xs">{entry.school}</span>
                        <span className="px-2 py-0.5 bg-blue-100 text-blue-700 rounded text-xs">{entry.subject}</span>
                        {entry.lineManagerName && (
                          <span className="px-2 py-0.5 bg-purple-100 text-purple-700 rounded text-xs">üë§ Assigned to: {entry.lineManagerName}</span>
                        )}
                      </div>
                      <div className="text-sm text-gray-600 space-y-1">
                        <div><strong>Date:</strong> {new Date(entry.date).toLocaleDateString('en-IN', { weekday: 'short', day: '2-digit', month: 'short', year: 'numeric' })}</div>
                        <div><strong>Activity:</strong> {ACTIVITY_TYPES.find(t => t.id === entry.activityType)?.label}</div>
                        <div><strong>Time:</strong> {entry.startTime} - {entry.endTime} (<span className="text-yellow-600 font-bold">{entry.hours}h</span>)</div>
                        {entry.class && <div><strong>Class:</strong> {entry.class}</div>}
                        {entry.chapter && <div><strong>Chapter:</strong> {entry.chapter}</div>}
                        {entry.topic && <div><strong>Topic:</strong> {entry.topic}</div>}
                        {entry.notes && <div><strong>Notes:</strong> {entry.notes}</div>}
                      </div>
                    </div>
                    {/* ‚úÖ Only show approval buttons if NOT view-only */}
                    {!isViewOnly && (
                    <div className="flex flex-row md:flex-col gap-2">
                      <button
                        onClick={() => handleApproval(entry.id, 'approved')}
                        className="px-6 py-2 bg-green-500 text-white rounded-xl font-semibold hover:bg-green-600"
                      >
                        ‚úÖ Approve
                      </button>
                      <button
                        onClick={() => handleApproval(entry.id, 'rejected')}
                        className="px-6 py-2 bg-red-500 text-white rounded-xl font-semibold hover:bg-red-600"
                      >
                        ‚ùå Reject
                      </button>
                      <button
                        onClick={() => handleDeleteEntry(entry.id, entry.teacherName)}
                        className="px-6 py-2 bg-gray-600 text-white rounded-xl font-semibold hover:bg-gray-700"
                        title="Delete this entry permanently"
                      >
                        üóëÔ∏è Delete
                      </button>
                    </div>
                    )}
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>
      )}
      
      {/* All Entries View (Admin Only) - View and Delete any entry */}
      {activeView === 'allEntries' && isAdmin && (
        <div className="bg-white p-6 rounded-xl shadow-lg">
          <h2 className="text-xl font-bold mb-6 flex items-center gap-2">
            <span className="text-2xl">üìã</span> All Timesheet Entries
            <span className="ml-2 px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm">{filteredEntries.length} entries</span>
          </h2>
          
          {/* Filters */}
          <div className="bg-gray-50 p-4 rounded-xl mb-6 flex flex-wrap gap-4">
            <div>
              <label className="block text-xs text-gray-500 mb-1">Month</label>
              <input
                type="month"
                value={filterMonth}
                onChange={e => setFilterMonth(e.target.value)}
                className="border-2 px-3 py-2 rounded-lg"
              />
            </div>
            <div>
              <label className="block text-xs text-gray-500 mb-1">School</label>
              <select
                value={filterSchool}
                onChange={e => setFilterSchool(e.target.value)}
                className="border-2 px-3 py-2 rounded-lg"
              >
                <option value="All">All Schools</option>
                {accessibleSchools.map(school => (
                  <option key={school} value={school}>{school}</option>
                ))}
              </select>
            </div>
            <div>
              <label className="block text-xs text-gray-500 mb-1">Teacher</label>
              <select
                value={filterTeacher}
                onChange={e => setFilterTeacher(e.target.value)}
                className="border-2 px-3 py-2 rounded-lg"
              >
                <option value="All">All Teachers</option>
                {uniqueTeachers.map(t => (
                  <option key={t.afid} value={t.afid}>{t.name}</option>
                ))}
              </select>
            </div>
          </div>
          
          {filteredEntries.length === 0 ? (
            <div className="text-center py-12 text-gray-500">
              <div className="text-6xl mb-4">üì≠</div>
              <div className="text-xl font-semibold">No entries found</div>
              <div className="text-sm mt-2">Try adjusting your filters</div>
            </div>
          ) : (
            <div className="space-y-4 max-h-[600px] overflow-y-auto">
              {filteredEntries.map(entry => (
                <div key={entry.id} className={`border-2 p-4 rounded-xl ${
                  entry.status === 'approved' ? 'border-green-200 bg-green-50' :
                  entry.status === 'rejected' ? 'border-red-200 bg-red-50' :
                  'border-yellow-200 bg-yellow-50'
                }`}>
                  <div className="flex flex-col md:flex-row justify-between gap-4">
                    <div className="flex-1">
                      <div className="flex items-center gap-3 mb-2 flex-wrap">
                        <span className="font-bold text-lg">{entry.teacherName}</span>
                        <span className="px-2 py-0.5 bg-gray-200 rounded text-xs">{entry.school}</span>
                        <span className="px-2 py-0.5 bg-blue-100 text-blue-700 rounded text-xs">{entry.subject}</span>
                        <span className={`px-2 py-0.5 rounded text-xs font-semibold ${
                          entry.status === 'approved' ? 'bg-green-200 text-green-700' :
                          entry.status === 'rejected' ? 'bg-red-200 text-red-700' :
                          'bg-yellow-200 text-yellow-700'
                        }`}>
                          {entry.status === 'approved' ? '‚úÖ Approved' : entry.status === 'rejected' ? '‚ùå Rejected' : '‚è≥ Pending'}
                        </span>
                      </div>
                      <div className="text-sm text-gray-600 space-y-1">
                        <div><strong>Date:</strong> {new Date(entry.date).toLocaleDateString('en-IN', { weekday: 'short', day: '2-digit', month: 'short', year: 'numeric' })}</div>
                        <div><strong>Activity:</strong> {ACTIVITY_TYPES.find(t => t.id === entry.activityType)?.label}</div>
                        <div><strong>Time:</strong> {entry.startTime} - {entry.endTime} (<span className="text-yellow-600 font-bold">{entry.hours}h</span>)</div>
                        {entry.class && <div><strong>Class:</strong> {entry.class}</div>}
                        {entry.chapter && <div><strong>Chapter:</strong> {entry.chapter}</div>}
                        {entry.topic && <div><strong>Topic:</strong> {entry.topic}</div>}
                        {entry.notes && <div><strong>Notes:</strong> {entry.notes}</div>}
                        {entry.approvedBy && <div className="text-xs text-gray-500 mt-2">Processed by: {entry.approvedBy}</div>}
                      </div>
                    </div>
                    <div className="flex flex-row md:flex-col gap-2">
                      <button
                        onClick={() => handleDeleteEntry(entry.id, entry.teacherName)}
                        className="px-6 py-2 bg-gray-600 text-white rounded-xl font-semibold hover:bg-gray-700"
                        title="Delete this entry permanently"
                      >
                        üóëÔ∏è Delete
                      </button>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>
      )}
      
      {/* Analytics View */}
      {activeView === 'analytics' && (
        <div className="space-y-6">
          {/* Filters */}
          <div className="bg-white p-4 rounded-xl shadow flex flex-wrap gap-4">
            <div>
              <label className="block text-xs text-gray-500 mb-1">Month</label>
              <input
                type="month"
                value={filterMonth}
                onChange={e => setFilterMonth(e.target.value)}
                className="border-2 px-3 py-2 rounded-lg"
              />
            </div>
            {isAdmin && (
              <>
                <div>
                  <label className="block text-xs text-gray-500 mb-1">School</label>
                  <select
                    value={filterSchool}
                    onChange={e => setFilterSchool(e.target.value)}
                    className="border-2 px-3 py-2 rounded-lg"
                  >
                    <option value="All">All Schools</option>
                    {accessibleSchools.map(school => (
                      <option key={school} value={school}>{school}</option>
                    ))}
                  </select>
                </div>
                <div>
                  <label className="block text-xs text-gray-500 mb-1">Teacher</label>
                  <select
                    value={filterTeacher}
                    onChange={e => setFilterTeacher(e.target.value)}
                    className="border-2 px-3 py-2 rounded-lg"
                  >
                    <option value="All">All Teachers</option>
                    {uniqueTeachers.map(t => (
                      <option key={t.afid} value={t.afid}>{t.name}</option>
                    ))}
                  </select>
                </div>
              </>
            )}
          </div>
          
          {/* Stats Cards */}
          <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div className="bg-white p-4 rounded-xl shadow border-l-4 border-yellow-500">
              <div className="text-sm text-gray-500">Total Hours</div>
              <div className="text-3xl font-bold text-yellow-600">
                {filteredEntries.reduce((s, e) => s + (parseFloat(e.hours) || 0), 0).toFixed(1)}h
              </div>
            </div>
            <div className="bg-white p-4 rounded-xl shadow border-l-4 border-green-500">
              <div className="text-sm text-gray-500">Approved</div>
              <div className="text-3xl font-bold text-green-600">
                {filteredEntries.filter(e => e.status === 'approved').reduce((s, e) => s + (parseFloat(e.hours) || 0), 0).toFixed(1)}h
              </div>
            </div>
            <div className="bg-white p-4 rounded-xl shadow border-l-4 border-blue-500">
              <div className="text-sm text-gray-500">Total Entries</div>
              <div className="text-3xl font-bold text-blue-600">{filteredEntries.length}</div>
            </div>
            <div className="bg-white p-4 rounded-xl shadow border-l-4 border-purple-500">
              <div className="text-sm text-gray-500">Active Teachers</div>
              <div className="text-3xl font-bold text-purple-600">{new Set(filteredEntries.map(e => e.teacherAfid)).size}</div>
            </div>
          </div>
          
          {/* Charts and Leaderboard */}
          <div className="grid md:grid-cols-2 gap-6">
            {/* Activity Distribution Chart */}
            <div className="bg-white p-6 rounded-xl shadow-lg">
              <h3 className="font-bold text-lg mb-4">üìä Hours by Activity Type</h3>
              <div style={{ height: '300px' }}>
                <canvas id="analyticsChart"></canvas>
              </div>
            </div>
            
            {/* Teacher Leaderboard */}
            <div className="bg-white p-6 rounded-xl shadow-lg">
              <h3 className="font-bold text-lg mb-4">üèÜ Teacher Leaderboard</h3>
              <div className="space-y-3 max-h-[350px] overflow-y-auto">
                {teacherAggregates.slice(0, 10).map((teacher, idx) => (
                  <div key={teacher.name} className={`flex items-center gap-3 p-3 rounded-xl ${idx === 0 ? 'bg-yellow-50 border-2 border-yellow-300' : 'bg-gray-50'}`}>
                    <div className={`w-8 h-8 rounded-full flex items-center justify-center font-bold text-white ${
                      idx === 0 ? 'bg-yellow-500' : idx === 1 ? 'bg-gray-400' : idx === 2 ? 'bg-orange-400' : 'bg-gray-300'
                    }`}>
                      {idx + 1}
                    </div>
                    <div className="flex-1">
                      <div className="font-semibold">{teacher.name} {idx === 0 && 'üèÜ'}</div>
                      <div className="text-xs text-gray-500">{teacher.school}</div>
                    </div>
                    <div className="text-right">
                      <div className="font-bold text-yellow-600">{teacher.totalHours.toFixed(1)}h</div>
                      <div className="text-xs text-green-600">{teacher.approved.toFixed(1)}h approved</div>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          </div>
        </div>
      )}
      
    </div>
  );
}

// ========================================
// ROADMAP & FEATURE REQUESTS
// ========================================
function RoadmapPage({ currentUser }) {
  const [features, setFeatures] = useState([]);
  const [showNewRequest, setShowNewRequest] = useState(false);
  const [newTitle, setNewTitle] = useState('');
  const [newDetails, setNewDetails] = useState('');
  const [submitting, setSubmitting] = useState(false);
  const [loading, setLoading] = useState(true);
  const [sortBy, setSortBy] = useState('votes'); // 'votes' or 'recent'

  // Fetch feature requests
  useEffect(() => {
    const unsubscribe = db.collection('featureRequests')
      .orderBy('votes', 'desc')
      .onSnapshot(snap => {
        const data = snap.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));
        setFeatures(data);
        setLoading(false);
      }, error => {
        console.error('Error fetching features:', error);
        setLoading(false);
      });

    return () => unsubscribe();
  }, []);

  // Submit new feature request
  const handleSubmit = async () => {
    if (!newTitle.trim()) return;
    
    setSubmitting(true);
    try {
      await db.collection('featureRequests').add({
        title: newTitle.trim(),
        details: newDetails.trim(),
        authorId: currentUser.afid || currentUser.uid,
        authorName: currentUser.name,
        authorSchool: currentUser.school,
        status: 'pending',
        votes: 0,
        voters: [],
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      
      setNewTitle('');
      setNewDetails('');
      setShowNewRequest(false);
      alert('‚úÖ Feature request submitted!');
    } catch (error) {
      console.error('Error submitting feature:', error);
      alert('Failed to submit request');
    } finally {
      setSubmitting(false);
    }
  };

  // Upvote feature
  const handleVote = async (featureId) => {
    const userId = currentUser.afid || currentUser.uid;
    const feature = features.find(f => f.id === featureId);
    if (!feature) return;

    const hasVoted = feature.voters?.includes(userId);
    
    try {
      if (hasVoted) {
        await db.collection('featureRequests').doc(featureId).update({
          votes: firebase.firestore.FieldValue.increment(-1),
          voters: firebase.firestore.FieldValue.arrayRemove(userId)
        });
      } else {
        await db.collection('featureRequests').doc(featureId).update({
          votes: firebase.firestore.FieldValue.increment(1),
          voters: firebase.firestore.FieldValue.arrayUnion(userId)
        });
      }
    } catch (error) {
      console.error('Error voting:', error);
    }
  };

  // Get status badge
  const getStatusBadge = (status) => {
    const badges = {
      'pending': { bg: 'bg-gray-200', text: 'text-gray-700', label: 'Pending' },
      'planned': { bg: 'bg-blue-100', text: 'text-blue-700', label: 'Planned' },
      'in-progress': { bg: 'bg-yellow-100', text: 'text-yellow-700', label: 'In Progress' },
      'done': { bg: 'bg-green-100', text: 'text-green-700', label: 'Done' },
      'rejected': { bg: 'bg-red-100', text: 'text-red-700', label: 'Not Planned' }
    };
    return badges[status] || badges.pending;
  };

  // Sort features
  const sortedFeatures = useMemo(() => {
    if (sortBy === 'votes') {
      return [...features].sort((a, b) => (b.votes || 0) - (a.votes || 0));
    }
    return [...features].sort((a, b) => {
      const dateA = a.createdAt?.toDate?.() || new Date(0);
      const dateB = b.createdAt?.toDate?.() || new Date(0);
      return dateB - dateA;
    });
  }, [features, sortBy]);

  // Planned features (roadmap)
  const roadmapFeatures = features.filter(f => f.status === 'planned' || f.status === 'in-progress');
  const doneFeatures = features.filter(f => f.status === 'done');

  if (loading) {
    return (
      <div className="flex items-center justify-center h-64">
        <div className="text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-4 border-yellow-500 border-t-transparent mx-auto"></div>
          <p className="mt-4 text-gray-600">Loading roadmap...</p>
        </div>
      </div>
    );
  }

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex items-center justify-between flex-wrap gap-4">
        <div>
          <h2 className="text-3xl font-bold">üó∫Ô∏è Roadmap & Feature Requests</h2>
          <p className="text-gray-600">Help shape the future of Curriculum Tracker</p>
        </div>
        <button
          onClick={() => setShowNewRequest(true)}
          className="px-6 py-3 bg-gradient-to-r from-yellow-400 to-orange-500 text-white rounded-xl font-bold hover:shadow-lg transition-all"
        >
          ‚ú® Request Feature
        </button>
      </div>

      {/* üéØ OFFICIAL ROADMAP TIMELINE - Planned Features */}
      <div className="bg-gradient-to-br from-indigo-50 via-purple-50 to-pink-50 rounded-2xl p-6 border-2 border-indigo-200">
        <div className="flex items-center gap-3 mb-6">
          <span className="text-3xl">üöÄ</span>
          <div>
            <h3 className="text-2xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent">Official Roadmap Timeline</h3>
            <p className="text-gray-600 text-sm">Features we're planning to build</p>
          </div>
        </div>

        <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
          {/* Q1 2025 - January-March */}
          <div className="bg-white rounded-xl p-5 shadow-lg border-l-4 border-blue-500">
            <div className="flex items-center gap-2 mb-3">
              <span className="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-xs font-bold">Q1 2025</span>
              <span className="text-sm text-gray-500">Jan - Mar</span>
            </div>
            <div className="space-y-3">
              <div className="p-3 bg-blue-50 rounded-lg">
                <div className="font-semibold flex items-center gap-2">üë§ Individual Student Profile</div>
                <p className="text-xs text-gray-600 mt-1">Student academic level, AIET exam reports, chapter test reports, performance analytics</p>
              </div>
              <div className="p-3 bg-blue-50 rounded-lg">
                <div className="font-semibold flex items-center gap-2">üìù Teacher Timesheet</div>
                <p className="text-xs text-gray-600 mt-1">Daily logs - what chapter/topic taught, time spent, activities conducted</p>
              </div>
            </div>
          </div>

          {/* Q2 2025 - April-June */}
          <div className="bg-white rounded-xl p-5 shadow-lg border-l-4 border-green-500">
            <div className="flex items-center gap-2 mb-3">
              <span className="px-3 py-1 bg-green-100 text-green-700 rounded-full text-xs font-bold">Q2 2025</span>
              <span className="text-sm text-gray-500">Apr - Jun</span>
            </div>
            <div className="space-y-3">
              <div className="p-3 bg-green-50 rounded-lg">
                <div className="font-semibold flex items-center gap-2">üìÖ Exam Schedule Manager</div>
                <p className="text-xs text-gray-600 mt-1">Create, track and manage exam schedules across schools</p>
              </div>
              <div className="p-3 bg-green-50 rounded-lg">
                <div className="font-semibold flex items-center gap-2">üìä Advanced Analytics Dashboard</div>
                <p className="text-xs text-gray-600 mt-1">Cross-school comparisons, trend analysis, predictive insights</p>
              </div>
            </div>
          </div>

          {/* Q3 2025 - July-September */}
          <div className="bg-white rounded-xl p-5 shadow-lg border-l-4 border-orange-500">
            <div className="flex items-center gap-2 mb-3">
              <span className="px-3 py-1 bg-orange-100 text-orange-700 rounded-full text-xs font-bold">Q3 2025</span>
              <span className="text-sm text-gray-500">Jul - Sep</span>
            </div>
            <div className="space-y-3">
              <div className="p-3 bg-orange-50 rounded-lg">
                <div className="font-semibold flex items-center gap-2">üì± Offline Mode</div>
                <p className="text-xs text-gray-600 mt-1">Full offline support with automatic sync when connected</p>
              </div>
              <div className="p-3 bg-orange-50 rounded-lg">
                <div className="font-semibold flex items-center gap-2">üîî Smart Notifications</div>
                <p className="text-xs text-gray-600 mt-1">Auto reminders for curriculum deadlines, pending tasks</p>
              </div>
            </div>
          </div>

          {/* Q4 2025 - October-December */}
          <div className="bg-white rounded-xl p-5 shadow-lg border-l-4 border-purple-500">
            <div className="flex items-center gap-2 mb-3">
              <span className="px-3 py-1 bg-purple-100 text-purple-700 rounded-full text-xs font-bold">Q4 2025</span>
              <span className="text-sm text-gray-500">Oct - Dec</span>
            </div>
            <div className="space-y-3">
              <div className="p-3 bg-purple-50 rounded-lg">
                <div className="font-semibold flex items-center gap-2">üìö Resource Library</div>
                <p className="text-xs text-gray-600 mt-1">Shared teaching materials, lesson plans, worksheets</p>
              </div>
              <div className="p-3 bg-purple-50 rounded-lg">
                <div className="font-semibold flex items-center gap-2">üéØ Goal Tracking</div>
                <p className="text-xs text-gray-600 mt-1">Set and track personal & school goals</p>
              </div>
            </div>
          </div>

          {/* Future Plans */}
          <div className="bg-white rounded-xl p-5 shadow-lg border-l-4 border-gray-400">
            <div className="flex items-center gap-2 mb-3">
              <span className="px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-xs font-bold">2026+</span>
              <span className="text-sm text-gray-500">Future</span>
            </div>
            <div className="space-y-3">
              <div className="p-3 bg-gray-50 rounded-lg">
                <div className="font-semibold flex items-center gap-2">ü§ñ AI Insights</div>
                <p className="text-xs text-gray-600 mt-1">AI-powered suggestions for curriculum pacing</p>
              </div>
              <div className="p-3 bg-gray-50 rounded-lg">
                <div className="font-semibold flex items-center gap-2">üë• Parent Portal</div>
                <p className="text-xs text-gray-600 mt-1">Parent access to student progress reports</p>
              </div>
            </div>
          </div>

          {/* Coming Soon */}
          <div className="bg-gradient-to-br from-pink-100 to-purple-100 rounded-xl p-5 shadow-lg border-2 border-dashed border-pink-300">
            <div className="flex items-center gap-2 mb-3">
              <span className="text-2xl">‚ú®</span>
              <span className="font-bold text-pink-700">Want a Feature?</span>
            </div>
            <p className="text-sm text-gray-600 mb-4">Have an idea? Request it below and vote for features you want!</p>
            <button
              onClick={() => setShowNewRequest(true)}
              className="w-full py-2 bg-gradient-to-r from-pink-500 to-purple-600 text-white rounded-lg font-semibold hover:shadow-lg transition-all text-sm"
            >
              ‚ú® Request Feature
            </button>
          </div>
        </div>
      </div>

      {/* Roadmap Section */}
      {roadmapFeatures.length > 0 && (
        <div className="bg-gradient-to-r from-blue-50 to-purple-50 rounded-2xl p-6">
          <h3 className="text-xl font-bold mb-4">üìç Coming Soon</h3>
          <div className="grid md:grid-cols-2 gap-4">
            {roadmapFeatures.map(feature => (
              <div key={feature.id} className="bg-white rounded-xl p-4 shadow">
                <div className="flex items-start justify-between gap-2">
                  <div className="flex-1">
                    <div className="font-bold">{feature.title}</div>
                    {feature.details && <p className="text-sm text-gray-600 mt-1">{feature.details}</p>}
                  </div>
                  <span className={`${getStatusBadge(feature.status).bg} ${getStatusBadge(feature.status).text} px-3 py-1 rounded-full text-xs font-bold`}>
                    {getStatusBadge(feature.status).label}
                  </span>
                </div>
              </div>
            ))}
          </div>
        </div>
      )}

      {/* Completed Features */}
      {doneFeatures.length > 0 && (
        <div className="bg-green-50 rounded-2xl p-6">
          <h3 className="text-xl font-bold mb-4">‚úÖ Recently Completed</h3>
          <div className="flex flex-wrap gap-2">
            {doneFeatures.slice(0, 10).map(feature => (
              <span key={feature.id} className="bg-white px-4 py-2 rounded-lg shadow text-sm">
                ‚úì {feature.title}
              </span>
            ))}
          </div>
        </div>
      )}

      {/* Feature Requests */}
      <div className="bg-white rounded-2xl shadow-lg p-6">
        <div className="flex items-center justify-between mb-4">
          <h3 className="text-xl font-bold">üí° Feature Requests</h3>
          <select
            value={sortBy}
            onChange={e => setSortBy(e.target.value)}
            className="border-2 px-4 py-2 rounded-lg"
          >
            <option value="votes">Most Voted</option>
            <option value="recent">Most Recent</option>
          </select>
        </div>

        {sortedFeatures.length === 0 ? (
          <div className="text-center py-12 text-gray-500">
            <div className="text-6xl mb-4">üí°</div>
            <p>No feature requests yet</p>
            <p className="text-sm">Be the first to suggest an improvement!</p>
          </div>
        ) : (
          <div className="space-y-3">
            {sortedFeatures.map(feature => {
              const userId = currentUser.afid || currentUser.uid;
              const hasVoted = feature.voters?.includes(userId);
              const badge = getStatusBadge(feature.status);
              
              return (
                <div key={feature.id} className="border-2 rounded-xl p-4 hover:border-yellow-400 transition-all">
                  <div className="flex items-start gap-4">
                    <button
                      onClick={() => handleVote(feature.id)}
                      className={`flex flex-col items-center px-3 py-2 rounded-lg min-w-[60px] transition-all ${
                        hasVoted ? 'bg-yellow-100 text-yellow-700' : 'bg-gray-100 hover:bg-gray-200'
                      }`}
                    >
                      <span className="text-xl">‚ñ≤</span>
                      <span className="font-bold">{feature.votes || 0}</span>
                    </button>
                    <div className="flex-1">
                      <div className="flex items-start justify-between gap-2">
                        <div className="font-bold text-lg">{feature.title}</div>
                        <span className={`${badge.bg} ${badge.text} px-3 py-1 rounded-full text-xs font-bold whitespace-nowrap`}>
                          {badge.label}
                        </span>
                      </div>
                      {feature.details && <p className="text-gray-600 mt-1">{feature.details}</p>}
                      <div className="text-sm text-gray-400 mt-2">
                        Requested by {feature.authorName} from {feature.authorSchool}
                      </div>
                    </div>
                  </div>
                </div>
              );
            })}
          </div>
        )}
      </div>

      {/* New Request Modal */}
      {showNewRequest && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-2xl max-w-lg w-full p-6">
            <h3 className="text-xl font-bold mb-4">‚ú® Request a Feature</h3>
            
            <div className="space-y-4">
              <div>
                <label className="block text-sm font-bold mb-2">Feature Title *</label>
                <input
                  type="text"
                  value={newTitle}
                  onChange={e => setNewTitle(e.target.value)}
                  placeholder="e.g., Dark mode support"
                  className="w-full border-2 rounded-xl px-4 py-3"
                />
              </div>
              
              <div>
                <label className="block text-sm font-bold mb-2">Details (Optional)</label>
                <textarea
                  value={newDetails}
                  onChange={e => setNewDetails(e.target.value)}
                  placeholder="Describe the feature in more detail..."
                  className="w-full border-2 rounded-xl px-4 py-3 h-24 resize-none"
                />
              </div>
            </div>

            <div className="flex gap-3 mt-6">
              <button
                onClick={handleSubmit}
                disabled={submitting || !newTitle.trim()}
                className="flex-1 py-3 bg-gradient-to-r from-yellow-400 to-orange-500 text-white rounded-xl font-bold disabled:opacity-50"
              >
                {submitting ? '‚è≥ Submitting...' : 'üì§ Submit Request'}
              </button>
              <button
                onClick={() => setShowNewRequest(false)}
                className="px-6 py-3 bg-gray-200 rounded-xl font-bold"
              >
                Cancel
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

// ========================================
// TEACHER EXAM STATISTICS
// ========================================
function TeacherExamStats({ currentUser }) {
  const [examRegistrations, setExamRegistrations] = useState([]);
  const [students, setStudents] = useState([]);
  const [filterGrade, setFilterGrade] = useState('All');
  const [filterGender, setFilterGender] = useState('All');
  const [filterStatus, setFilterStatus] = useState('All');   // Completed / Partial / NotDone / NeedHelp
  const [filterExam, setFilterExam] = useState('All');

  useEffect(() => {
    const fetchData = async () => {
      // All exam registrations
      const regsSnap = await db.collection('studentExamRegistrations').get();
      setExamRegistrations(regsSnap.docs.map(d => ({ ...d.data(), id: d.id })));

      // Students of this school ‚Äì be sure `id` is the student ID
      const stuSnap = await db.collection('students')
        .where('school', '==', currentUser.school)
        .get();

      const studentsData = stuSnap.docs.map(d => {
        const data = d.data();
        let studentId = data.id;
        if (!studentId) {
          const parts = d.id.split('_');      // e.g. JNV_Barwani_1234
          studentId = parts[parts.length - 1];
        }
        return { ...data, id: studentId, docId: d.id };
      });

      setStudents(studentsData);
    };
    fetchData();
  }, [currentUser.school]);

  // Options for filters
  const gradeOptions = Array.from(new Set(students.map(s => s.grade).filter(Boolean))).sort();
  const genderOptions = Array.from(new Set(students.map(s => s.gender).filter(Boolean))).sort();
  const examOptions = Array.from(
    new Set(
      examRegistrations.flatMap(r => (r.exams || []).map(e => e.examName)).filter(Boolean)
    )
  ).sort();

  // Students in this school after basic filters
  const filteredStudents = students.filter(s => {
    if (filterGrade !== 'All' && s.grade !== filterGrade) return false;
    if (filterGender !== 'All' && (s.gender || '') !== filterGender) return false;
    return true;
  });

  // Flatten exam registrations ‚Üí one row per student+exam, with all filters applied
  const detailRows = [];
  examRegistrations.forEach(reg => {
    const student = filteredStudents.find(s => s.id === reg.studentId);
    if (!student) return;
    (reg.exams || []).forEach(exam => {
      if (filterExam !== 'All' && exam.examName !== filterExam) return;

      if (filterStatus === 'Completed' && exam.registrationStatus !== 'Yes') return;
      if (filterStatus === 'Partial' && exam.registrationStatus !== 'Partially') return;
      if (filterStatus === 'NotDone' && exam.registrationStatus !== 'No') return;
      if (filterStatus === 'NeedHelp' && exam.needSupport !== 'Yes') return;

      detailRows.push({ student, reg, exam });
    });
  });

  const totalStudents = filteredStudents.length;
  const studentsWithRegs = new Set(detailRows.map(r => r.reg.studentId)).size;
  const pendingStudents = totalStudents - studentsWithRegs;

  // Exam-wise stats from filtered rows
  const examStats = {};
  detailRows.forEach(({ exam }) => {
    const name = exam.examName || 'Other';
    if (!examStats[name]) {
      examStats[name] = { completed: 0, partial: 0, notCompleted: 0, needSupport: 0 };
    }
    if (exam.registrationStatus === 'Yes') examStats[name].completed++;
    if (exam.registrationStatus === 'Partially') examStats[name].partial++;
    if (exam.registrationStatus === 'No') examStats[name].notCompleted++;
    if (exam.needSupport === 'Yes') examStats[name].needSupport++;
  });

  return (
    <div className="space-y-6">
      <h2 className="text-3xl font-bold">üìä Exam Statistics - {currentUser.school}</h2>

      {/* Summary cards */}
      <div className="grid md:grid-cols-3 gap-4">
        <div className="stat-card bg-blue-500 text-white">
          <div className="text-sm opacity-90">Total Students</div>
          <div className="text-5xl font-bold">{totalStudents}</div>
        </div>
        <div className="stat-card bg-green-500 text-white">
          <div className="text-sm opacity-90">Registered</div>
          <div className="text-5xl font-bold">{studentsWithRegs}</div>
        </div>
        <div className="stat-card bg-orange-500 text-white">
          <div className="text-sm opacity-90">Pending</div>
          <div className="text-5xl font-bold">{pendingStudents}</div>
        </div>
      </div>

      {/* Filters */}
      <div className="bg-white p-6 rounded-2xl shadow-lg">
        <h3 className="text-xl font-bold mb-4">üîç Filters</h3>
        <div className="grid md:grid-cols-4 gap-4">
          <div>
            <label className="block text-sm font-bold mb-2">Grade</label>
            <select
              value={filterGrade}
              onChange={e => setFilterGrade(e.target.value)}
              className="w-full border-2 px-4 py-3 rounded-xl"
            >
              <option value="All">All Grades</option>
              {gradeOptions.map(g => (
                <option key={g} value={g}>Class {g}</option>
              ))}
            </select>
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">Gender</label>
            <select
              value={filterGender}
              onChange={e => setFilterGender(e.target.value)}
              className="w-full border-2 px-4 py-3 rounded-xl"
            >
              <option value="All">All</option>
              {genderOptions.map(g => (
                <option key={g} value={g}>{g}</option>
              ))}
            </select>
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">Exam Name</label>
            <select
              value={filterExam}
              onChange={e => setFilterExam(e.target.value)}
              className="w-full border-2 px-4 py-3 rounded-xl"
            >
              <option value="All">All Exams</option>
              {examOptions.map(name => (
                <option key={name} value={name}>{name}</option>
              ))}
            </select>
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">Status</label>
            <select
              value={filterStatus}
              onChange={e => setFilterStatus(e.target.value)}
              className="w-full border-2 px-4 py-3 rounded-xl"
            >
              <option value="All">All</option>
              <option value="Completed">Completed</option>
              <option value="Partial">Partial</option>
              <option value="NotDone">Not Done</option>
              <option value="NeedHelp">Need Help</option>
            </select>
          </div>
        </div>
      </div>

      {/* Exam-wise status table */}
      <div className="bg-white p-6 rounded-2xl shadow-lg">
        <h3 className="text-xl font-bold mb-4">üìã Exam-wise Status</h3>
        <div className="overflow-x-auto">
          <table className="w-full">
            <thead className="avanti-gradient-light">
              <tr>
                <th className="p-3 text-left">Exam</th>
                <th className="p-3 text-center">‚úì Done</th>
                <th className="p-3 text-center">‚ö† Partial</th>
                <th className="p-3 text-center">‚úó Not Done</th>
                <th className="p-3 text-center">üÜò Need Help</th>
              </tr>
            </thead>
            <tbody>
              {Object.keys(examStats).length === 0 ? (
                <tr>
                  <td colSpan="5" className="p-8 text-center text-gray-500">
                    No registrations yet
                  </td>
                </tr>
              ) : (
                Object.entries(examStats).map(([examName, stats]) => (
                  <tr key={examName} className="border-b hover:bg-gray-50">
                    <td className="p-3 font-semibold">{examName}</td>
                    <td className="p-3 text-center">
                      <span className="px-3 py-1 rounded-full bg-green-100 text-green-700 font-bold">
                        {stats.completed}
                      </span>
                    </td>
                    <td className="p-3 text-center">
                      <span className="px-3 py-1 rounded-full bg-yellow-100 text-yellow-700 font-bold">
                        {stats.partial}
                      </span>
                    </td>
                    <td className="p-3 text-center">
                      <span className="px-3 py-1 rounded-full bg-red-100 text-red-700 font-bold">
                        {stats.notCompleted}
                      </span>
                    </td>
                    <td className="p-3 text-center">
                      <span className="px-3 py-1 rounded-full bg-orange-100 text-orange-700 font-bold">
                        {stats.needSupport}
                      </span>
                    </td>
                  </tr>
                ))
              )}
            </tbody>
          </table>
        </div>
      </div>

      {/* NEW: Student-wise detail table */}
      <div className="bg-white p-6 rounded-2xl shadow-lg">
        <h3 className="text-xl font-bold mb-4">üßë‚Äçüéì Student-wise Exam Registrations</h3>
        <div className="overflow-x-auto">
          <table className="w-full text-sm">
            <thead className="bg-gray-100">
              <tr>
                <th className="p-3 text-left">Student ID</th>
                <th className="p-3 text-left">Name</th>
                <th className="p-3 text-left">Grade</th>
                <th className="p-3 text-left">Gender</th>
                <th className="p-3 text-left">Exam</th>
                <th className="p-3 text-left">Status</th>
                <th className="p-3 text-left">Need Help</th>
                <th className="p-3 text-left">Reg. No.</th>
                <th className="p-3 text-left">Email</th>
                <th className="p-3 text-left">Phone</th>
              </tr>
            </thead>
            <tbody>
              {detailRows.length === 0 ? (
                <tr>
                  <td colSpan="10" className="p-6 text-center text-gray-500">
                    No exam registrations found with current filters.
                  </td>
                </tr>
              ) : (
                detailRows.map((row, idx) => {
                  const status = row.exam.registrationStatus || 'No';
                  const needHelp = row.exam.needSupport === 'Yes';
                  return (
                    <tr key={idx} className="border-b hover:bg-gray-50">
                      <td className="p-3">{row.student.id}</td>
                      <td className="p-3">{row.student.name}</td>
                      <td className="p-3">{row.student.grade}</td>
                      <td className="p-3">{row.student.gender || '‚Äî'}</td>
                      <td className="p-3">{row.exam.examName}</td>
                      <td className="p-3">
                        {status === 'Yes' && <span className="px-3 py-1 rounded-full bg-green-100 text-green-700 font-semibold">Completed</span>}
                        {status === 'Partially' && <span className="px-3 py-1 rounded-full bg-yellow-100 text-yellow-700 font-semibold">Partial</span>}
                        {status === 'No' && <span className="px-3 py-1 rounded-full bg-red-100 text-red-700 font-semibold">Not Done</span>}
                      </td>
                      <td className="p-3">
                        {needHelp ? (
                          <span className="px-3 py-1 rounded-full bg-orange-100 text-orange-700 font-semibold">Yes</span>
                        ) : (
                          'No'
                        )}
                      </td>
                      <td className="p-3">{row.exam.registrationNumber || '‚Äî'}</td>
                      <td className="p-3">{row.exam.emailUsed || '‚Äî'}</td>
                      <td className="p-3">{row.exam.phoneUsed || '‚Äî'}</td>
                    </tr>
                  );
                })
              )}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  );
}

// ========================================
// STUDENT FEEDBACK VIEW (ADMIN)
// ========================================
function StudentFeedbackView({ accessibleSchools = [], isSuperAdmin = false, isDirector = false }) {
  const [feedbackList, setFeedbackList] = useState([]);
  const [students, setStudents] = useState([]);
  const [teachers, setTeachers] = useState([]);
  const [loading, setLoading] = useState(true);
  
  // ‚úÖ FIX: Directors get full data access like Super Admin
  const hasFullDataAccess = isSuperAdmin || isDirector;
  
  // Filters
  const [filterSchool, setFilterSchool] = useState('All');
  const [filterGrade, setFilterGrade] = useState('All');
  const [filterTeacher, setFilterTeacher] = useState('All');
  const [searchQuery, setSearchQuery] = useState('');
  const [dateFrom, setDateFrom] = useState('');
  const [dateTo, setDateTo] = useState('');
    // ----- Helpers to derive summary fields from 19-question responses -----
  const getCategoryFromRating = (rating) => {
    if (rating == null) return null;
    if (rating >= 5) return 'Excellent';
    if (rating >= 4) return 'Good';
    if (rating >= 3) return 'Average';
    return 'Needs Improvement';
  };

  const getExplanationSummary = (responses = {}) => {
    // Use Q4 - Explanation Clarity as proxy
    const rating = responses.q4?.rating ?? null;
    return getCategoryFromRating(rating);
  };

  const getDoubtSummary = (responses = {}) => {
    // Use Q3 ‚Äì Problem Solving / Doubt Clearing
    const rating = responses.q3?.rating;
    if (rating == null) return null;
    if (rating >= 5) return 'Always';
    if (rating >= 3) return 'Sometimes';
    return 'Rarely';
  };

  const getPaceSummary = (responses = {}) => {
    // Use Q6 ‚Äì Time Management
    const rating = responses.q6?.rating;
    if (rating == null) return null;
    if (rating >= 4) return 'Just Right';
    return 'Needs Change';
  };

  const getCommentsSummary = (responses = {}) => {
    // Q10 ‚Äì what they liked most
    return responses.q10?.text || '';
  };

  // Labels for raw export of all questions
  const QUESTION_DEFS = [
    { id: 'q1',  label: 'Q1 Punctuality (1-5)', type: 'mcq' },
    { id: 'q2',  label: 'Q2 Academic Level (1-5)', type: 'mcq' },
    { id: 'q3',  label: 'Q3 Problem Solving (1-5)', type: 'mcq' },
    { id: 'q4',  label: 'Q4 Explanation Clarity (1-5)', type: 'mcq' },
    { id: 'q5',  label: 'Q5 Handwriting & Voice (1-5)', type: 'mcq' },
    { id: 'q6',  label: 'Q6 Time Management (1-5)', type: 'mcq' },
    { id: 'q7',  label: 'Q7 Guidance & Motivation (1-5)', type: 'mcq' },
    { id: 'q8',  label: 'Q8 Student Participation (1-5)', type: 'mcq' },
    { id: 'q9',  label: 'Q9 Equal Attention (1-5)', type: 'mcq' },
    { id: 'q10', label: 'Q10 What they liked most', type: 'text' },
    { id: 'q11', label: 'Q11 What can be improved', type: 'text' },
  ];


  // Fetch all data
  useEffect(() => {
    const fetchData = async () => {
      try {
        setLoading(true);
        
        // Fetch feedback
const feedbackSnap = await db.collection('teacherFeedback').get();
const feedbackData = feedbackSnap.docs.map(doc => {
  const data = doc.data();
  const responses = data.responses || {};

  // Make sure submittedAt is always a real JS Date
  let submittedAt = new Date(); // default = now

  if (data.submittedAt) {
    if (typeof data.submittedAt.toDate === 'function') {
      // Firestore Timestamp
      submittedAt = data.submittedAt.toDate();
    } else {
      // ISO string or normal date string
      submittedAt = new Date(data.submittedAt);
    }
  } else if (data.completedAt) {
    // Fallback if only completedAt exists
    submittedAt = new Date(data.completedAt);
  }

  return {
    id: doc.id,
    ...data,
    submittedAt,
    // use averageRating (1‚Äì10) if simple rating is missing
    rating: data.rating || data.averageRating || 0,
    // derive summary fields from 19-question responses when old fields are missing
    explanationQuality: data.explanationQuality || getExplanationSummary(responses),
    doubtResolution: data.doubtResolution || getDoubtSummary(responses),
    teachingPace: data.teachingPace || getPaceSummary(responses),
    comments: data.comments || getCommentsSummary(responses),
  };
});



        
        // ‚úÖ FIXED: Fetch ALL students for admin views
        console.log('üìä [Feedback] Fetching ALL students');
        const studentsSnap = await db.collection('students').get();
        const studentsData = studentsSnap.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));
        console.log('‚úÖ [Feedback] Loaded', studentsData.length, 'students');
        
        // Fetch teachers
        const teachersSnap = await db.collection('teachers').get();
        const teachersData = teachersSnap.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));
        
        setFeedbackList(feedbackData);
        setStudents(studentsData);
        setTeachers(teachersData);
      } catch (error) {
        console.error('Error fetching data:', error);
        alert('Error loading feedback data');
      } finally {
        setLoading(false);
      }
    };
    
    fetchData();
  }, []);

  // ‚úÖ FIX: Use only accessible schools for dropdown - Directors get all schools
  const schoolOptions = hasFullDataAccess ? SCHOOLS : accessibleSchools;
  
  // ‚úÖ FIX: Filter feedback by accessible schools first - Directors see all
  const accessibleFeedback = hasFullDataAccess ? feedbackList : feedbackList.filter(f => accessibleSchools.includes(f.school));
  
  // ‚úÖ FIX: Filter teachers by accessible schools for dropdown - Directors see all
  const accessibleTeachers = hasFullDataAccess ? teachers : teachers.filter(t => accessibleSchools.includes(t.school));
  
  // When school filter is selected, further filter teachers to that school only
  const teachersForDropdown = filterSchool === 'All' 
    ? accessibleTeachers 
    : accessibleTeachers.filter(t => t.school === filterSchool);

  // Get student details
  const getStudentDetails = (studentId) => {
    return students.find(s => s.id === studentId) || {};
  };

  // Get teacher name
  const getTeacherName = (teacherId) => {
    const teacher = teachers.find(t => t.id === teacherId);
    if (!teacher) return 'Unknown Teacher';
    return teacher.isArchived ? `${teacher.name} (Archived)` : teacher.name;
  };
  
  // Get teacher object for detailed info
  const getTeacherInfo = (teacherId) => {
    return teachers.find(t => t.id === teacherId) || null;
  };

  // Filter feedback - using accessibleFeedback which is already filtered by accessible schools
  const filteredFeedback = accessibleFeedback.filter(feedback => {
    const student = getStudentDetails(feedback.studentId);
    const teacherName = getTeacherName(feedback.teacherId);
    
    // School filter
    if (filterSchool !== 'All' && feedback.school !== filterSchool) return false;
    
    // Grade filter
    if (filterGrade !== 'All' && student.grade !== filterGrade) return false;
    
    // Teacher filter
    if (filterTeacher !== 'All' && teacherName !== filterTeacher) return false;
    
    // Search query (student name or ID)
    if (searchQuery) {
      const query = searchQuery.toLowerCase();
      const matchesName = student.name?.toLowerCase().includes(query);
      const matchesId = student.studentId?.toLowerCase().includes(query);
      if (!matchesName && !matchesId) return false;
    }
    
    // Date range filter
    if (dateFrom) {
      const fromDate = new Date(dateFrom);
      fromDate.setHours(0, 0, 0, 0);
      if (feedback.submittedAt < fromDate) return false;
    }
    
    if (dateTo) {
      const toDate = new Date(dateTo);
      toDate.setHours(23, 59, 59, 999);
      if (feedback.submittedAt > toDate) return false;
    }
    
    return true;
  });

  // Get unique grades from accessible feedback only
  const uniqueGrades = [...new Set(accessibleFeedback.map(f => {
    const student = getStudentDetails(f.studentId);
    return student.grade;
  }))].filter(Boolean).sort();

    // Export to CSV (includes all Q1‚ÄìQ17 raw answers)
  const exportToCSV = () => {
    if (filteredFeedback.length === 0) {
      alert('No feedback to export');
      return;
    }

    const csvData = filteredFeedback.map(feedback => {
      const student = getStudentDetails(feedback.studentId);
      const teacherName = getTeacherName(feedback.teacherId);
      const responses = feedback.responses || {};

      // Base columns (same as before)
      const row = {
        'Date': feedback.submittedAt.toLocaleDateString('en-IN'),
        'Time': feedback.submittedAt.toLocaleTimeString('en-IN'),
        'School': feedback.school || student.school || 'N/A',
        'Student ID': student.studentId || 'N/A',
        'Student Name': student.name || feedback.studentName || 'N/A',
        'Grade': student.grade || feedback.grade || 'N/A',
        'Teacher Name': teacherName,
        'Subject': feedback.subject || 'N/A',
        'Overall Rating (1-5)': feedback.rating || feedback.averageRating || 0,
        'Explanation Quality (summary)': feedback.explanationQuality || 'N/A',
        'Doubt Resolution (summary)': feedback.doubtResolution || 'N/A',
        'Teaching Pace (summary)': feedback.teachingPace || 'N/A',
        'Comments (summary)': feedback.comments || '',
      };

      // Add one column per question + optional explanation
      QUESTION_DEFS.forEach(q => {
        const resp = responses[q.id] || {};
        let value = '';

        if (q.type === 'mcq') {
          // MCQ type stores rating value (1-5)
          value = resp.rating != null ? resp.rating : '';
        } else if (q.type === 'rating') {
          value = resp.rating != null ? resp.rating : '';
        } else if (q.type === 'yesno') {
          // your yes/no answers are stored as .answer
          value = resp.answer != null ? resp.answer : '';
        } else if (q.type === 'text') {
          value = resp.text || resp || '';
        } else {
          // Fallback - try to get any value
          value = resp.rating || resp.text || resp.answer || resp || '';
        }

        row[q.label] = value;

        // If student wrote explanation (when rating < threshold)
        if (resp.explanation) {
          row[`${q.label} - Explanation`] = resp.explanation;
        }
      });

      return row;
    });

    // Convert to CSV
    const headers = Object.keys(csvData[0]);
    const csvContent = [
      headers.join(','),
      ...csvData.map(row =>
        headers
          .map(header => {
            const value = row[header]?.toString() || '';
            return value.includes(',') || value.includes('"')
              ? `"${value.replace(/"/g, '""')}"`
              : value;
          })
          .join(',')
      ),
    ].join('\n');

    // Download
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute(
      'download',
      `student_feedback_${new Date().toISOString().split('T')[0]}.csv`
    );
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

    // Get rating badge (1‚Äì5 scale)
  const getRatingBadge = (rating) => {
    if (rating >= 4.5) return { text: 'Excellent', class: 'rating-excellent' };
    if (rating >= 3.5) return { text: 'Good', class: 'rating-good' };
    if (rating >= 2.5) return { text: 'Average', class: 'rating-average' };
    return { text: 'Needs Improvement', class: 'rating-poor' };
  };

  // Statistics for cards (1‚Äì5 scale)
  const stats = {
    total: filteredFeedback.length,
    avgRating:
      filteredFeedback.length > 0
        ? (
            filteredFeedback.reduce((sum, f) => sum + (f.rating || 0), 0) /
            filteredFeedback.length
          ).toFixed(1)
        : 0,
    excellent: filteredFeedback.filter(f => (f.rating || 0) >= 4.5).length,
    good:      filteredFeedback.filter(f => (f.rating || 0) >= 3.5 && (f.rating || 0) < 4.5).length,
    average:   filteredFeedback.filter(f => (f.rating || 0) >= 2.5 && (f.rating || 0) < 3.5).length,
    poor:      filteredFeedback.filter(f => (f.rating || 0) < 2.5).length,
  };

  if (loading) {
    return (
      <div className="flex items-center justify-center min-h-screen">
        <div className="text-2xl font-bold">Loading feedback data...</div>
      </div>
    );
  }

  return (
    <div className="space-y-6 p-6">
      {/* Header */}
      <div className="flex flex-wrap items-center justify-between gap-4">
        <h2 className="text-3xl font-bold">üí¨ Student Feedback</h2>
        <button
          onClick={exportToCSV}
          disabled={filteredFeedback.length === 0}
          className="px-6 py-3 avanti-gradient text-white rounded-xl font-semibold hover:opacity-90 disabled:opacity-50 disabled:cursor-not-allowed"
        >
          üì• Export to CSV
        </button>
      </div>

      {/* Statistics Cards */}
      <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
        <div className="stat-card bg-blue-500 text-white">
          <div className="text-sm opacity-90">Total Feedback</div>
          <div className="text-3xl font-bold">{stats.total}</div>
        </div>
        <div className="stat-card bg-purple-500 text-white">
          <div className="text-sm opacity-90">Avg Rating</div>
          <div className="text-3xl font-bold">‚≠ê {stats.avgRating}</div>
        </div>
        <div className="stat-card bg-green-500 text-white">
          <div className="text-sm opacity-90">Excellent</div>
          <div className="text-3xl font-bold">{stats.excellent}</div>
        </div>
        <div className="stat-card bg-blue-400 text-white">
          <div className="text-sm opacity-90">Good</div>
          <div className="text-3xl font-bold">{stats.good}</div>
        </div>
        <div className="stat-card bg-yellow-500 text-white">
          <div className="text-sm opacity-90">Average</div>
          <div className="text-3xl font-bold">{stats.average}</div>
        </div>
        <div className="stat-card bg-red-500 text-white">
          <div className="text-sm opacity-90">Poor</div>
          <div className="text-3xl font-bold">{stats.poor}</div>
        </div>
      </div>

      {/* Monthly Feedback Trend Graph */}
      <MonthlyFeedbackTrendGraph feedbackData={filteredFeedback} />

      {/* Filters */}
      <div className="bg-white p-6 rounded-2xl shadow-lg space-y-4">
        <h3 className="text-xl font-bold mb-4">üîç Filters</h3>
        
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          {/* School Filter */}
          <div>
            <label className="block text-sm font-semibold mb-2">School</label>
            <select
              value={filterSchool}
              onChange={(e) => {
                setFilterSchool(e.target.value);
                setFilterTeacher('All'); // Reset teacher filter when school changes
              }}
              className="w-full p-3 border-2 rounded-xl"
            >
              <option value="All">All Schools</option>
              {schoolOptions.map(school => (
                <option key={school} value={school}>{school}</option>
              ))}
            </select>
          </div>

          {/* Grade Filter */}
          <div>
            <label className="block text-sm font-semibold mb-2">Grade</label>
            <select
              value={filterGrade}
              onChange={(e) => setFilterGrade(e.target.value)}
              className="w-full p-3 border-2 rounded-xl"
            >
              <option value="All">All Grades</option>
              {uniqueGrades.map(grade => (
                <option key={grade} value={grade}>{grade}</option>
              ))}
            </select>
          </div>

          {/* Teacher Filter - Now filtered by selected school */}
          <div>
            <label className="block text-sm font-semibold mb-2">Teacher</label>
            <select
              value={filterTeacher}
              onChange={(e) => setFilterTeacher(e.target.value)}
              className="w-full p-3 border-2 rounded-xl"
            >
              <option value="All">All Teachers</option>
              {teachersForDropdown.map(teacher => (
                <option key={teacher.id} value={teacher.name}>{teacher.name}</option>
              ))}
            </select>
          </div>

          {/* Search */}
          <div>
            <label className="block text-sm font-semibold mb-2">Search Student</label>
            <input
              type="text"
              value={searchQuery}
              onChange={(e) => setSearchQuery(e.target.value)}
              placeholder="Name or ID..."
              className="w-full p-3 border-2 rounded-xl"
            />
          </div>

          {/* Date From */}
          <div>
            <label className="block text-sm font-semibold mb-2">From Date</label>
            <input
              type="date"
              value={dateFrom}
              onChange={(e) => setDateFrom(e.target.value)}
              className="w-full p-3 border-2 rounded-xl"
            />
          </div>

          {/* Date To */}
          <div>
            <label className="block text-sm font-semibold mb-2">To Date</label>
            <input
              type="date"
              value={dateTo}
              onChange={(e) => setDateTo(e.target.value)}
              className="w-full p-3 border-2 rounded-xl"
            />
          </div>
        </div>

        {/* Clear Filters */}
        <button
          onClick={() => {
            setFilterSchool('All');
            setFilterGrade('All');
            setFilterTeacher('All');
            setSearchQuery('');
            setDateFrom('');
            setDateTo('');
          }}
          className="mt-4 px-6 py-2 bg-gray-500 text-white rounded-xl font-semibold hover:bg-gray-600"
        >
          Clear All Filters
        </button>
      </div>

      {/* Feedback Table */}
      <div className="bg-white p-6 rounded-2xl shadow-lg">
        <h3 className="text-xl font-bold mb-4">
          üìã Feedback List ({filteredFeedback.length} {filteredFeedback.length === 1 ? 'entry' : 'entries'})
        </h3>
        
        <div className="overflow-x-auto">
          {filteredFeedback.length === 0 ? (
            <div className="text-center py-12 text-gray-500">
              <div className="text-6xl mb-4">üì≠</div>
              <div className="text-xl font-semibold">No feedback found</div>
              <div className="text-sm mt-2">Try adjusting your filters</div>
            </div>
          ) : (
            <table className="w-full">
              <thead className="avanti-gradient-light">
                <tr>
                  <th className="p-3 text-left">Date</th>
                  <th className="p-3 text-left">School</th>
                  <th className="p-3 text-left">Student ID</th>
                  <th className="p-3 text-left">Student Name</th>
                  <th className="p-3 text-left">Grade</th>
                  <th className="p-3 text-left">Teacher</th>
                  <th className="p-3 text-left">Subject</th>
                  <th className="p-3 text-left">Rating</th>
                  <th className="p-3 text-left">Explanation</th>
                  <th className="p-3 text-left">Doubt Help</th>
                  <th className="p-3 text-left">Pace</th>
                  <th className="p-3 text-left">Comments</th>
                </tr>
              </thead>
              <tbody>
                {filteredFeedback.map(feedback => {
                  const student = getStudentDetails(feedback.studentId);
                  const teacherName = getTeacherName(feedback.teacherId);
                  const ratingBadge = getRatingBadge(feedback.rating);
                  
                  return (
                    <tr key={feedback.id} className="border-b hover:bg-gray-50">
                      <td className="p-3">
                        <div className="text-sm font-semibold">
                          {feedback.submittedAt.toLocaleDateString('en-IN')}
                        </div>
                        <div className="text-xs text-gray-500">
                          {feedback.submittedAt.toLocaleTimeString('en-IN')}
                        </div>
                      </td>
                      <td className="p-3 font-semibold">{student.school || 'N/A'}</td>
                      <td className="p-3">{student.studentId || 'N/A'}</td>
                      <td className="p-3 font-semibold">{student.name || 'N/A'}</td>
                      <td className="p-3">{student.grade || 'N/A'}</td>
                      <td className="p-3 font-semibold">{teacherName}</td>
                      <td className="p-3">{feedback.subject || 'N/A'}</td>
                      <td className="p-3">
                        <div className={`rating-badge ${ratingBadge.class}`}>
                          ‚≠ê {feedback.rating?.toFixed(1) || 0}
                        </div>
                      </td>
                      <td className="p-3">
                        <span className={`px-3 py-1 rounded-full text-sm font-semibold ${
                          feedback.explanationQuality === 'Excellent' ? 'bg-green-100 text-green-700' :
                          feedback.explanationQuality === 'Good' ? 'bg-blue-100 text-blue-700' :
                          feedback.explanationQuality === 'Average' ? 'bg-yellow-100 text-yellow-700' :
                          'bg-red-100 text-red-700'
                        }`}>
                          {feedback.explanationQuality || 'N/A'}
                        </span>
                      </td>
                      <td className="p-3">
                        <span className={`px-3 py-1 rounded-full text-sm font-semibold ${
                          feedback.doubtResolution === 'Always' ? 'bg-green-100 text-green-700' :
                          feedback.doubtResolution === 'Sometimes' ? 'bg-yellow-100 text-yellow-700' :
                          'bg-red-100 text-red-700'
                        }`}>
                          {feedback.doubtResolution || 'N/A'}
                        </span>
                      </td>
                      <td className="p-3">
                        <span className={`px-3 py-1 rounded-full text-sm font-semibold ${
                          feedback.teachingPace === 'Just Right' ? 'bg-green-100 text-green-700' :
                          feedback.teachingPace === 'Too Fast' ? 'bg-orange-100 text-orange-700' :
                          'bg-blue-100 text-blue-700'
                        }`}>
                          {feedback.teachingPace || 'N/A'}
                        </span>
                      </td>
                      <td className="p-3">
                        <div className="max-w-xs truncate" title={feedback.comments}>
                          {feedback.comments || '-'}
                        </div>
                      </td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
          )}
        </div>
      </div>
    </div>
  );
}

// ========================================
// TEACHER SELF PROFILE (for teachers to see their own data)
// ========================================
function TeacherSelfProfile({ currentUser, teachers }) {
  // Find the current teacher in teachers array
  const [teacherData, setTeacherData] = useState(null);
  const [observations, setObservations] = useState([]);
  const [feedbackData, setFeedbackData] = useState([]);
  const [loading, setLoading] = useState(true);
  const [selectedMonth, setSelectedMonth] = useState('All');
  const [selectedObservation, setSelectedObservation] = useState(null);
  const [showEditModal, setShowEditModal] = useState(false);
  const [saving, setSaving] = useState(false);
  const [editForm, setEditForm] = useState({
    qualification: '',
    experience: '',
    phone: '',
    whatsapp: '',
    profilePhoto: '',
    driveLink: '',
    bio: '',
    dob: '',
    address: '',
    bloodGroup: '',
    emergencyContact: '',
    emergencyContactName: ''
  });
  const chartRef = useRef(null);
  const chartInstance = useRef(null);

  // Fetch teacher data and initialize form
  useEffect(() => {
    const teacher = teachers.find(t => t.afid === currentUser.afid || t.email === currentUser.email) || {
      name: currentUser.name || currentUser.email,
      subject: currentUser.subject,
      school: currentUser.school,
      afid: currentUser.afid,
      docId: currentUser.afid
    };
    setTeacherData(teacher);
    setEditForm({
      qualification: teacher.qualification || '',
      experience: teacher.experience || '',
      phone: teacher.phone || '',
      whatsapp: teacher.whatsapp || '',
      profilePhoto: teacher.profilePhoto || '',
      driveLink: teacher.driveLink || '',
      bio: teacher.bio || '',
      dob: teacher.dob || teacher.dateOfBirth || '',
      address: teacher.address || '',
      bloodGroup: teacher.bloodGroup || '',
      emergencyContact: teacher.emergencyContact || '',
      emergencyContactName: teacher.emergencyContactName || ''
    });
  }, [teachers, currentUser]);

  // Fetch observations and feedback for this teacher
  useEffect(() => {
    const fetchData = async () => {
      try {
        setLoading(true);
        const teacherId = currentUser.afid || currentUser.uid;
        
        // Fetch observations
        const obsSnap = await db.collection('classroomObservations')
          .where('teacherId', '==', teacherId)
          .orderBy('submittedAt', 'desc')
          .get();
        
        const obsData = obsSnap.docs.map(doc => ({
          id: doc.id,
          ...doc.data(),
          submittedAt: doc.data().submittedAt?.toDate() || new Date(doc.data().submittedAtISO)
        }));
        setObservations(obsData);

        // Fetch ALL feedback and filter client-side (avoids Firebase index requirement)
        const feedbackSnap = await db.collection('teacherFeedback').get();
        
        // Create list of all possible identifiers for this teacher
        const teacherIdentifiers = [
          currentUser.afid,
          currentUser.docId,
          currentUser.id,
          currentUser.uid,
          currentUser.name
        ].filter(Boolean).map(id => String(id).toLowerCase());
        
        const fbData = feedbackSnap.docs
          .filter(doc => {
            const data = doc.data();
            const feedbackTeacherId = String(data.teacherId || '').toLowerCase();
            const feedbackTeacherAfid = String(data.teacherAfid || '').toLowerCase();
            const feedbackTeacherDocId = String(data.teacherDocId || '').toLowerCase();
            const feedbackTeacherName = String(data.teacherName || '').toLowerCase();
            
            return teacherIdentifiers.includes(feedbackTeacherId) ||
                   teacherIdentifiers.includes(feedbackTeacherAfid) ||
                   teacherIdentifiers.includes(feedbackTeacherDocId) ||
                   teacherIdentifiers.includes(feedbackTeacherName);
          })
          .map(doc => {
            const data = doc.data();
            return {
              id: doc.id,
              ...data,
              submittedAt: data.submittedAt?.toDate ? data.submittedAt.toDate() : new Date(data.submittedAt || data.completedAt)
            };
          });
        
        console.log('My Profile - Found feedback:', fbData.length, 'responses');
        setFeedbackData(fbData);

      } catch (error) {
        console.error('Error fetching teacher profile data:', error);
      } finally {
        setLoading(false);
      }
    };

    fetchData();
  }, [currentUser]);

  // Save profile updates
  const handleSaveProfile = async () => {
    if (!teacherData?.docId) {
      alert('Unable to update profile. Please contact admin.');
      return;
    }

    setSaving(true);
    try {
      await db.collection('teachers').doc(teacherData.docId).update({
        qualification: editForm.qualification,
        experience: editForm.experience,
        phone: editForm.phone,
        whatsapp: editForm.whatsapp,
        profilePhoto: editForm.profilePhoto,
        driveLink: editForm.driveLink,
        bio: editForm.bio,
        dob: editForm.dob,
        dateOfBirth: editForm.dob, // Also save as dateOfBirth for compatibility
        address: editForm.address,
        bloodGroup: editForm.bloodGroup,
        emergencyContact: editForm.emergencyContact,
        emergencyContactName: editForm.emergencyContactName,
        updatedAt: new Date().toISOString()
      });
      
      // Update local state
      setTeacherData(prev => ({
        ...prev,
        ...editForm
      }));
      
      alert('‚úÖ Profile updated successfully!');
      setShowEditModal(false);
    } catch (error) {
      console.error('Error updating profile:', error);
      alert('‚ùå Failed to update profile: ' + error.message);
    } finally {
      setSaving(false);
    }
  };

  // Get unique months from observations
  const availableMonths = useMemo(() => {
    const months = new Set();
    observations.forEach(obs => {
      const date = new Date(obs.observationDate || obs.submittedAt);
      months.add(`${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`);
    });
    return Array.from(months).sort().reverse();
  }, [observations]);

  // Filter observations by month
  const filteredObservations = useMemo(() => {
    if (selectedMonth === 'All') return observations;
    return observations.filter(obs => {
      const date = new Date(obs.observationDate || obs.submittedAt);
      const month = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
      return month === selectedMonth;
    });
  }, [observations, selectedMonth]);

  // Calculate average feedback scores
  const feedbackAverages = useMemo(() => {
    if (feedbackData.length === 0) return null;
    
    const questionAverages = {};
    const questionLabels = {
      q1: 'Punctuality',
      q2: 'Academic Level', 
      q3: 'Problem Solving',
      q4: 'Explanation Clarity',
      q5: 'Handwriting & Voice',
      q6: 'Time Management',
      q7: 'Guidance & Motivation',
      q8: 'Student Participation',
      q9: 'Equal Attention',
      
      
      
      
      
      
    };

    Object.keys(questionLabels).forEach(qId => {
      const ratings = feedbackData
        .map(fb => fb.responses?.[qId]?.rating)
        .filter(r => r !== undefined && r !== null);
      
      if (ratings.length > 0) {
        questionAverages[qId] = {
          label: questionLabels[qId],
          average: (ratings.reduce((a, b) => a + b, 0) / ratings.length).toFixed(1),
          count: ratings.length
        };
      }
    });

    return questionAverages;
  }, [feedbackData]);

  // Overall average rating
  const overallRating = useMemo(() => {
    if (!feedbackAverages) return null;
    const values = Object.values(feedbackAverages).map(v => parseFloat(v.average));
    if (values.length === 0) return null;
    return (values.reduce((a, b) => a + b, 0) / values.length).toFixed(1);
  }, [feedbackAverages]);

  // Chart for observation trends
  useEffect(() => {
    if (chartInstance.current) {
      chartInstance.current.destroy();
    }

    if (chartRef.current && observations.length > 0) {
      const ctx = chartRef.current.getContext('2d');
      
      // Group by month
      const monthlyData = {};
      observations.forEach(obs => {
        const date = new Date(obs.observationDate || obs.submittedAt);
        const month = date.toLocaleDateString('en-IN', { month: 'short', year: '2-digit' });
        if (!monthlyData[month]) {
          monthlyData[month] = [];
        }
        monthlyData[month].push(obs.percentageScore);
      });

      const labels = Object.keys(monthlyData);
      const avgScores = labels.map(month => {
        const scores = monthlyData[month];
        return (scores.reduce((a, b) => a + b, 0) / scores.length).toFixed(1);
      });

      chartInstance.current = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Observation Score %',
            data: avgScores,
            borderColor: '#F4B41A',
            backgroundColor: 'rgba(244, 180, 26, 0.1)',
            tension: 0.4,
            fill: true,
            pointBackgroundColor: '#F4B41A',
            pointRadius: 6
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: { display: true, text: 'My Observation Score Trend', font: { size: 16, weight: 'bold' } },
            legend: { display: false }
          },
          scales: {
            y: { beginAtZero: true, max: 100, title: { display: true, text: 'Score %' } }
          }
        }
      });
    }

    return () => {
      if (chartInstance.current) {
        chartInstance.current.destroy();
      }
    };
  }, [observations]);

  // Calculate profile completion
  const calculateProfileCompletion = () => {
    if (!teacherData) return { percentage: 0, missing: [] };
    
    const fields = [
      { key: 'name', label: 'Full Name' },
      { key: 'email', label: 'Email' },
      { key: 'phone', label: 'Phone Number' },
      { key: 'whatsapp', label: 'WhatsApp Number' },
      { key: 'dob', label: 'Date of Birth', alt: 'dateOfBirth' },
      { key: 'school', label: 'School' },
      { key: 'subject', label: 'Subject' },
      { key: 'profilePhoto', label: 'Profile Photo' },
      { key: 'joiningDate', label: 'Joining Date' },
      { key: 'qualification', label: 'Qualification' },
      { key: 'address', label: 'Address' },
      { key: 'emergencyContact', label: 'Emergency Contact' },
      { key: 'bloodGroup', label: 'Blood Group' }
    ];
    
    let filled = 0;
    const missing = [];
    
    fields.forEach(field => {
      const value = teacherData[field.key] || (field.alt ? teacherData[field.alt] : null);
      if (value && String(value).trim() !== '') {
        filled++;
      } else {
        missing.push(field.label);
      }
    });
    
    return {
      percentage: Math.round((filled / fields.length) * 100),
      missing
    };
  };
  
  const profileCompletion = calculateProfileCompletion();

  if (loading || !teacherData) {
    return (
      <div className="flex items-center justify-center min-h-[400px]">
        <div className="text-center">
          <div className="text-4xl mb-4">‚è≥</div>
          <p>Loading your profile...</p>
        </div>
      </div>
    );
  }

  return (
    <div className="space-y-6">
      {/* Profile Completion Alert */}
      {profileCompletion.percentage < 100 && (
        <div className={`p-4 rounded-2xl border-2 ${
          profileCompletion.percentage < 50 ? 'bg-red-50 border-red-200' :
          profileCompletion.percentage < 80 ? 'bg-orange-50 border-orange-200' :
          'bg-blue-50 border-blue-200'
        }`}>
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-3">
              <div className={`text-3xl ${
                profileCompletion.percentage < 50 ? 'text-red-500' :
                profileCompletion.percentage < 80 ? 'text-orange-500' :
                'text-blue-500'
              }`}>
                {profileCompletion.percentage < 50 ? '‚ö†Ô∏è' : profileCompletion.percentage < 80 ? 'üìù' : '‚ú®'}
              </div>
              <div>
                <div className="font-bold text-gray-800">
                  Profile {profileCompletion.percentage}% Complete
                </div>
                <div className="text-sm text-gray-600">
                  {profileCompletion.missing.length} field{profileCompletion.missing.length !== 1 ? 's' : ''} remaining: {profileCompletion.missing.slice(0, 3).join(', ')}{profileCompletion.missing.length > 3 ? '...' : ''}
                </div>
              </div>
            </div>
            <button
              onClick={() => setShowEditModal(true)}
              className={`px-4 py-2 rounded-xl font-semibold text-white ${
                profileCompletion.percentage < 50 ? 'bg-red-500 hover:bg-red-600' :
                profileCompletion.percentage < 80 ? 'bg-orange-500 hover:bg-orange-600' :
                'bg-blue-500 hover:bg-blue-600'
              }`}
            >
              Complete Now ‚Üí
            </button>
          </div>
          {/* Progress bar */}
          <div className="mt-3 bg-white rounded-full h-2 overflow-hidden">
            <div 
              className={`h-full rounded-full transition-all ${
                profileCompletion.percentage < 50 ? 'bg-red-500' :
                profileCompletion.percentage < 80 ? 'bg-orange-500' :
                'bg-blue-500'
              }`}
              style={{ width: `${profileCompletion.percentage}%` }}
            />
          </div>
        </div>
      )}
      
      {/* 100% Complete Badge */}
      {profileCompletion.percentage >= 100 && (
        <div className="bg-green-50 border-2 border-green-200 p-4 rounded-2xl flex items-center gap-3">
          <div className="text-3xl">‚úÖ</div>
          <div>
            <div className="font-bold text-green-800">Profile 100% Complete!</div>
            <div className="text-sm text-green-600">Your profile is complete. Thank you!</div>
          </div>
        </div>
      )}

      {/* Header with Edit Button */}
      <div className="bg-gradient-to-r from-yellow-400 to-orange-500 text-white p-6 rounded-2xl">
        <div className="flex justify-between items-start">
          <div className="flex items-center gap-4">
            {teacherData.profilePhoto ? (
              <img src={teacherData.profilePhoto} alt={teacherData.name} className="w-20 h-20 rounded-full border-4 border-white object-cover"/>
            ) : (
              <div className="w-20 h-20 rounded-full border-4 border-white bg-white/30 flex items-center justify-center text-3xl font-bold">
                {teacherData.name?.charAt(0) || '?'}
              </div>
            )}
            <div>
              <h2 className="text-2xl font-bold">üë§ My Profile</h2>
              <p className="text-xl mt-1">{teacherData.name}</p>
              <p className="opacity-90">{teacherData.subject} | {teacherData.school}</p>
              <div className="flex gap-2 mt-2">
                {teacherData.afid && (
                  <span className="px-2 py-0.5 bg-white/30 text-white rounded text-xs font-mono">
                    AFID: {teacherData.afid}
                  </span>
                )}
                {teacherData.afCode && (
                  <span className="px-2 py-0.5 bg-blue-500 text-white rounded text-xs font-mono">
                    AF Code: {teacherData.afCode}
                  </span>
                )}
              </div>
            </div>
          </div>
          <button
            onClick={() => setShowEditModal(true)}
            className="px-4 py-2 bg-white text-orange-600 rounded-xl font-semibold hover:bg-orange-50"
          >
            ‚úèÔ∏è Edit Profile
          </button>
        </div>
      </div>

      {/* Profile Details */}
      <div className="bg-white p-6 rounded-xl shadow">
        <h3 className="text-xl font-bold mb-4">üìã Profile Details</h3>
        <div className="grid md:grid-cols-2 gap-4">
          <div className="bg-gray-50 p-4 rounded-lg">
            <div className="text-sm text-gray-500">Education Qualification</div>
            <div className="font-semibold">{teacherData.qualification || 'Not specified'}</div>
          </div>
          <div className="bg-gray-50 p-4 rounded-lg">
            <div className="text-sm text-gray-500">Experience</div>
            <div className="font-semibold">{teacherData.experience || 'Not specified'}</div>
          </div>
          <div className="bg-gray-50 p-4 rounded-lg">
            <div className="text-sm text-gray-500">Phone</div>
            <div className="font-semibold">{teacherData.phone || 'Not specified'}</div>
          </div>
          <div className="bg-gray-50 p-4 rounded-lg">
            <div className="text-sm text-gray-500">WhatsApp</div>
            <div className="font-semibold">{teacherData.whatsapp || 'Not specified'}</div>
          </div>
          <div className="bg-gray-50 p-4 rounded-lg">
            <div className="text-sm text-gray-500">Email</div>
            <div className="font-semibold">{teacherData.email || 'Not specified'}</div>
          </div>
          <div className="bg-gray-50 p-4 rounded-lg">
            <div className="text-sm text-gray-500">üéÇ Date of Birth</div>
            <div className="font-semibold">{teacherData.dob || teacherData.dateOfBirth || 'Not specified'}</div>
          </div>
          <div className="bg-gray-50 p-4 rounded-lg">
            <div className="text-sm text-gray-500">ü©∏ Blood Group</div>
            <div className="font-semibold">{teacherData.bloodGroup || 'Not specified'}</div>
          </div>
          <div className="bg-gray-50 p-4 rounded-lg">
            <div className="text-sm text-gray-500">üìÖ Joining Date</div>
            <div className="font-semibold">{teacherData.joiningDate || 'Not specified'}</div>
          </div>
          <div className="bg-gray-50 p-4 rounded-lg">
            <div className="text-sm text-gray-500">Average Rating</div>
            <div className="font-semibold text-yellow-600">{overallRating || 'N/A'}/5</div>
          </div>
        </div>
        
        {/* Address - Full width */}
        <div className="mt-4 bg-gray-50 p-4 rounded-lg">
          <div className="text-sm text-gray-500">üè† Address</div>
          <div className="font-semibold">{teacherData.address || 'Not specified'}</div>
        </div>
        
        {/* Emergency Contact */}
        <div className="mt-4 bg-red-50 p-4 rounded-lg border border-red-100">
          <div className="text-sm text-red-600 font-semibold mb-2">üÜò Emergency Contact</div>
          <div className="grid md:grid-cols-2 gap-4">
            <div>
              <div className="text-sm text-gray-500">Contact Name</div>
              <div className="font-semibold">{teacherData.emergencyContactName || 'Not specified'}</div>
            </div>
            <div>
              <div className="text-sm text-gray-500">Contact Number</div>
              <div className="font-semibold">{teacherData.emergencyContact || 'Not specified'}</div>
            </div>
          </div>
        </div>
        
        {teacherData.driveLink && (
          <div className="mt-4 bg-blue-50 p-4 rounded-lg">
            <div className="text-sm text-gray-500">üìÅ Google Drive Folder</div>
            <a 
              href={teacherData.driveLink} 
              target="_blank" 
              rel="noopener noreferrer"
              className="font-semibold text-blue-600 hover:underline flex items-center gap-2"
            >
              üìÇ Open Teaching Resources
            </a>
          </div>
        )}
        {teacherData.bio && (
          <div className="mt-4 bg-gray-50 p-4 rounded-lg">
            <div className="text-sm text-gray-500">Bio</div>
            <div className="font-semibold">{teacherData.bio}</div>
          </div>
        )}
      </div>

      {/* Overall Stats Cards */}
      <div className="grid md:grid-cols-3 gap-4">
        <div className="bg-white p-4 rounded-xl shadow border-l-4 border-yellow-500">
          <div className="text-sm text-gray-500">Total Observations</div>
          <div className="text-3xl font-bold text-yellow-600">{observations.length}</div>
        </div>
        <div className="bg-white p-4 rounded-xl shadow border-l-4 border-green-500">
          <div className="text-sm text-gray-500">Avg Observation Score</div>
          <div className="text-3xl font-bold text-green-600">
            {observations.length > 0 
              ? (observations.reduce((sum, o) => sum + o.percentageScore, 0) / observations.length).toFixed(1) + '%'
              : 'N/A'}
          </div>
        </div>
        <div className="bg-white p-4 rounded-xl shadow border-l-4 border-blue-500">
          <div className="text-sm text-gray-500">Student Feedback Rating</div>
          <div className="text-3xl font-bold text-blue-600">{overallRating || 'N/A'}/5</div>
          <div className="text-xs text-gray-400">{feedbackData.length} responses</div>
        </div>
      </div>

      {/* Observation Trend Chart */}
      {observations.length > 0 && (
        <div className="bg-white p-4 rounded-xl shadow">
          <div style={{ height: '250px' }}>
            <canvas ref={chartRef}></canvas>
          </div>
        </div>
      )}

      {/* My Classroom Observations */}
      <div className="bg-white p-6 rounded-xl shadow">
        <div className="flex justify-between items-center mb-4">
          <h3 className="text-xl font-bold">üìã My Classroom Observations</h3>
          <select 
            value={selectedMonth} 
            onChange={e => setSelectedMonth(e.target.value)}
            className="border-2 px-4 py-2 rounded-xl"
          >
            <option value="All">All Months</option>
            {availableMonths.map(month => (
              <option key={month} value={month}>
                {new Date(month + '-01').toLocaleDateString('en-IN', { month: 'long', year: 'numeric' })}
              </option>
            ))}
          </select>
        </div>

        {filteredObservations.length === 0 ? (
          <div className="text-center py-8 text-gray-500">
            <div className="text-4xl mb-2">üìã</div>
            <p>No classroom observations yet</p>
            <p className="text-sm">Your manager will add observations when they visit your class</p>
          </div>
        ) : (
          <div className="space-y-3">
            {filteredObservations.map(obs => (
              <div key={obs.id} className="border-2 rounded-xl p-4 hover:border-yellow-400 cursor-pointer transition" onClick={() => setSelectedObservation(obs)}>
                <div className="flex justify-between items-center">
                  <div>
                    <div className="font-bold">
                      {new Date(obs.observationDate || obs.submittedAt).toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' })}
                      <span className="text-gray-500 font-normal ml-2">Class {obs.grade}</span>
                    </div>
                    <div className="text-sm text-gray-500">Observer: {obs.observerName}</div>
                  </div>
                  <div className="text-right">
                    <div className={`text-2xl font-bold ${
                      obs.percentageScore >= 80 ? 'text-green-600' : 
                      obs.percentageScore >= 60 ? 'text-yellow-600' : 'text-red-600'
                    }`}>
                      {obs.percentageScore}%
                    </div>
                    <div className="text-sm text-gray-500">{obs.totalScore}/{obs.maxScore}</div>
                  </div>
                </div>
              </div>
            ))}
          </div>
        )}
      </div>

      {/* Student Feedback Summary */}
      <div className="bg-white p-6 rounded-xl shadow">
        <h3 className="text-xl font-bold mb-4">üí¨ Student Feedback Summary</h3>
        <p className="text-sm text-gray-500 mb-4">Average scores from {feedbackData.length} student responses (individual responses are anonymous)</p>
        
        {!feedbackAverages ? (
          <div className="text-center py-8 text-gray-500">
            <div className="text-4xl mb-2">üí¨</div>
            <p>No student feedback received yet</p>
          </div>
        ) : (
          <div className="grid md:grid-cols-3 gap-4">
            {Object.entries(feedbackAverages).map(([qId, data]) => (
              <div key={qId} className="bg-gray-50 p-3 rounded-lg">
                <div className="text-sm text-gray-600 mb-1">{data.label}</div>
                <div className="flex items-center justify-between">
                  <span className={`text-xl font-bold ${
                    parseFloat(data.average) >= 8 ? 'text-green-600' :
                    parseFloat(data.average) >= 6 ? 'text-yellow-600' : 'text-red-600'
                  }`}>
                    {data.average}/5
                  </span>
                  <span className="text-xs text-gray-400">({data.count} ratings)</span>
                </div>
              </div>
            ))}
          </div>
        )}
      </div>

      {/* Edit Profile Modal */}
      {showEditModal && (
        <div className="modal-overlay" onClick={() => setShowEditModal(false)}>
          <div className="modal-content max-w-lg" onClick={e => e.stopPropagation()}>
            <div className="p-6">
              <div className="flex justify-between items-center mb-6">
                <h3 className="text-xl font-bold">‚úèÔ∏è Edit Profile</h3>
                <button onClick={() => setShowEditModal(false)} className="text-2xl font-bold text-gray-400">√ó</button>
              </div>

              <div className="space-y-4">
                <div>
                  <label className="block text-sm font-bold mb-2">Profile Photo</label>
                  
                  {/* Current photo preview */}
                  <div className="flex items-center gap-4 mb-3">
                    {editForm.profilePhoto ? (
                      <img 
                        src={editForm.profilePhoto} 
                        alt="Profile" 
                        className="w-20 h-20 rounded-full object-cover border-2 border-yellow-400"
                      />
                    ) : (
                      <div className="w-20 h-20 rounded-full bg-gradient-to-br from-yellow-400 to-orange-500 flex items-center justify-center text-3xl text-white font-bold">
                        {teacherData?.name?.charAt(0) || '?'}
                      </div>
                    )}
                    <div className="flex-1">
                      <p className="text-sm text-gray-600">Upload a photo (max 1MB, JPG/PNG)</p>
                    </div>
                  </div>
                  
                  {/* File upload */}
                  <input
                    type="file"
                    id="profilePhotoUpload"
                    accept="image/jpeg,image/png,image/webp"
                    onChange={async (e) => {
                      const file = e.target.files[0];
                      if (!file) return;
                      
                      const uploadBtn = document.getElementById('uploadStatus');
                      
                      // Validate file size (max 1MB)
                      if (file.size > 1024 * 1024) {
                        alert('‚ùå File too large! Please upload an image under 1MB');
                        e.target.value = '';
                        return;
                      }
                      
                      // Validate file type
                      if (!['image/jpeg', 'image/png', 'image/webp'].includes(file.type)) {
                        alert('‚ùå Invalid file type! Please upload JPG, PNG, or WebP image');
                        e.target.value = '';
                        return;
                      }
                      
                      try {
                        // Show uploading state
                        if (uploadBtn) {
                          uploadBtn.textContent = '‚è≥ Uploading...';
                          uploadBtn.className = 'text-sm text-blue-600 font-medium';
                        }
                        
                        // First convert to base64 for immediate preview
                        const reader = new FileReader();
                        reader.onload = async (readerEvent) => {
                          // Show preview immediately
                          const base64 = readerEvent.target.result;
                          setEditForm(prev => ({...prev, profilePhoto: base64}));
                          
                          try {
                            // Upload to Firebase Storage
                            const storageRef = firebase.storage().ref();
                            const safeId = (teacherData.afid || teacherData.email || 'unknown').replace(/[^a-zA-Z0-9]/g, '_');
                            const fileName = `profile-photos/${safeId}_${Date.now()}.${file.name.split('.').pop() || 'jpg'}`;
                            const photoRef = storageRef.child(fileName);
                            
                            // Create upload task with timeout
                            const uploadTask = photoRef.put(file);
                            
                            // Set a timeout for the upload
                            const timeoutPromise = new Promise((_, reject) => {
                              setTimeout(() => reject(new Error('Upload timeout - please try again')), 30000);
                            });
                            
                            // Race between upload and timeout
                            await Promise.race([
                              new Promise((resolve, reject) => {
                                uploadTask.on('state_changed',
                                  (snapshot) => {
                                    const progress = Math.round((snapshot.bytesTransferred / snapshot.totalBytes) * 100);
                                    if (uploadBtn) uploadBtn.textContent = `‚è≥ Uploading... ${progress}%`;
                                  },
                                  (error) => reject(error),
                                  async () => {
                                    try {
                                      const downloadURL = await photoRef.getDownloadURL();
                                      setEditForm(prev => ({...prev, profilePhoto: downloadURL}));
                                      resolve(downloadURL);
                                    } catch (urlError) {
                                      reject(urlError);
                                    }
                                  }
                                );
                              }),
                              timeoutPromise
                            ]);
                            
                            if (uploadBtn) {
                              uploadBtn.textContent = '‚úÖ Uploaded successfully!';
                              uploadBtn.className = 'text-sm text-green-600 font-medium';
                            }
                            
                            setTimeout(() => {
                              if (uploadBtn) uploadBtn.textContent = '';
                            }, 3000);
                            
                          } catch (uploadError) {
                            console.error('Firebase upload error:', uploadError);
                            // Keep the base64 preview even if upload fails
                            if (uploadBtn) {
                              uploadBtn.textContent = '‚ö†Ô∏è Cloud save failed, using local preview';
                              uploadBtn.className = 'text-sm text-orange-600 font-medium';
                            }
                            // If Firebase fails, still allow the base64 image to be used
                          }
                        };
                        reader.onerror = () => {
                          throw new Error('Failed to read file');
                        };
                        reader.readAsDataURL(file);
                        
                      } catch (error) {
                        console.error('Upload error:', error);
                        if (uploadBtn) {
                          uploadBtn.textContent = '‚ùå ' + (error.message || 'Upload failed');
                          uploadBtn.className = 'text-sm text-red-600 font-medium';
                        }
                        e.target.value = '';
                      }
                    }}
                    className="w-full border-2 px-4 py-3 rounded-xl cursor-pointer file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-yellow-50 file:text-yellow-700 hover:file:bg-yellow-100"
                  />
                  <span id="uploadStatus" className="text-sm text-green-600 font-medium"></span>
                  
                  {/* Or enter URL manually */}
                  <div className="mt-3">
                    <p className="text-xs text-gray-500 mb-2">Or paste an image URL:</p>
                    <input
                      type="url"
                      value={editForm.profilePhoto}
                      onChange={e => setEditForm({...editForm, profilePhoto: e.target.value})}
                      placeholder="https://example.com/photo.jpg"
                      className="w-full border-2 px-4 py-2 rounded-xl text-sm"
                    />
                  </div>
                </div>

                <div>
                  <label className="block text-sm font-bold mb-2">Education Qualification</label>
                  <input
                    type="text"
                    value={editForm.qualification}
                    onChange={e => setEditForm({...editForm, qualification: e.target.value})}
                    placeholder="e.g., M.Sc Physics, B.Ed"
                    className="w-full border-2 px-4 py-3 rounded-xl"
                  />
                </div>

                <div>
                  <label className="block text-sm font-bold mb-2">Experience</label>
                  <input
                    type="text"
                    value={editForm.experience}
                    onChange={e => setEditForm({...editForm, experience: e.target.value})}
                    placeholder="e.g., 5 years teaching Physics"
                    className="w-full border-2 px-4 py-3 rounded-xl"
                  />
                </div>

                <div>
                  <label className="block text-sm font-bold mb-2">Phone Number</label>
                  <input
                    type="tel"
                    value={editForm.phone}
                    onChange={e => setEditForm({...editForm, phone: e.target.value})}
                    placeholder="e.g., 9876543210"
                    className="w-full border-2 px-4 py-3 rounded-xl"
                  />
                </div>

                <div>
                  <label className="block text-sm font-bold mb-2">WhatsApp Number</label>
                  <input
                    type="tel"
                    value={editForm.whatsapp}
                    onChange={e => setEditForm({...editForm, whatsapp: e.target.value})}
                    placeholder="e.g., 9876543210"
                    className="w-full border-2 px-4 py-3 rounded-xl"
                  />
                </div>

                <div>
                  <label className="block text-sm font-bold mb-2">üéÇ Date of Birth</label>
                  <input
                    type="date"
                    value={editForm.dob}
                    onChange={e => setEditForm({...editForm, dob: e.target.value})}
                    className="w-full border-2 px-4 py-3 rounded-xl"
                  />
                </div>

                <div>
                  <label className="block text-sm font-bold mb-2">ü©∏ Blood Group</label>
                  <select
                    value={editForm.bloodGroup}
                    onChange={e => setEditForm({...editForm, bloodGroup: e.target.value})}
                    className="w-full border-2 px-4 py-3 rounded-xl"
                  >
                    <option value="">Select Blood Group</option>
                    <option value="A+">A+</option>
                    <option value="A-">A-</option>
                    <option value="B+">B+</option>
                    <option value="B-">B-</option>
                    <option value="AB+">AB+</option>
                    <option value="AB-">AB-</option>
                    <option value="O+">O+</option>
                    <option value="O-">O-</option>
                  </select>
                </div>

                <div>
                  <label className="block text-sm font-bold mb-2">üè† Address</label>
                  <textarea
                    value={editForm.address}
                    onChange={e => setEditForm({...editForm, address: e.target.value})}
                    placeholder="Your full address..."
                    rows="2"
                    className="w-full border-2 px-4 py-3 rounded-xl"
                  />
                </div>

                <div>
                  <label className="block text-sm font-bold mb-2">üÜò Emergency Contact Name</label>
                  <input
                    type="text"
                    value={editForm.emergencyContactName}
                    onChange={e => setEditForm({...editForm, emergencyContactName: e.target.value})}
                    placeholder="e.g., Father, Mother, Spouse"
                    className="w-full border-2 px-4 py-3 rounded-xl"
                  />
                </div>

                <div>
                  <label className="block text-sm font-bold mb-2">üìû Emergency Contact Number</label>
                  <input
                    type="tel"
                    value={editForm.emergencyContact}
                    onChange={e => setEditForm({...editForm, emergencyContact: e.target.value})}
                    placeholder="e.g., 9876543210"
                    className="w-full border-2 px-4 py-3 rounded-xl"
                  />
                </div>

                <div>
                  <label className="block text-sm font-bold mb-2">üìÅ Google Drive Folder Link</label>
                  <input
                    type="url"
                    value={editForm.driveLink}
                    onChange={e => setEditForm({...editForm, driveLink: e.target.value})}
                    placeholder="https://drive.google.com/drive/folders/..."
                    className="w-full border-2 px-4 py-3 rounded-xl"
                  />
                  <p className="text-xs text-gray-500 mt-1">Link to your teaching resources folder</p>
                </div>

                <div>
                  <label className="block text-sm font-bold mb-2">Bio (About Me)</label>
                  <textarea
                    value={editForm.bio}
                    onChange={e => setEditForm({...editForm, bio: e.target.value})}
                    placeholder="Tell students about yourself..."
                    rows="3"
                    className="w-full border-2 px-4 py-3 rounded-xl"
                  />
                </div>

                <div className="flex gap-3 pt-4">
                  <button
                    onClick={handleSaveProfile}
                    disabled={saving}
                    className="flex-1 avanti-gradient text-white py-3 rounded-xl font-semibold disabled:opacity-50"
                  >
                    {saving ? '‚è≥ Saving...' : '‚úÖ Save Changes'}
                  </button>
                  <button
                    onClick={() => setShowEditModal(false)}
                    className="px-6 py-3 bg-gray-300 rounded-xl font-semibold"
                  >
                    Cancel
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Observation Detail Modal */}
      {selectedObservation && (
        <div className="modal-overlay" onClick={() => setSelectedObservation(null)}>
          <div className="modal-content max-w-3xl max-h-[90vh] overflow-y-auto" onClick={e => e.stopPropagation()}>
            <div className="p-6">
              <div className="flex justify-between items-start mb-4">
                <div>
                  <h3 className="text-xl font-bold">Observation Details</h3>
                  <p className="text-gray-500">
                    {new Date(selectedObservation.observationDate).toLocaleDateString('en-IN', { weekday: 'long', day: '2-digit', month: 'long', year: 'numeric' })}
                  </p>
                </div>
                <button onClick={() => setSelectedObservation(null)} className="text-2xl font-bold text-gray-400">√ó</button>
              </div>

              <div className={`p-4 rounded-xl mb-4 ${
                selectedObservation.percentageScore >= 80 ? 'bg-green-100' :
                selectedObservation.percentageScore >= 60 ? 'bg-yellow-100' : 'bg-red-100'
              }`}>
                <div className="text-center">
                  <div className="text-3xl font-bold">{selectedObservation.totalScore}/{selectedObservation.maxScore}</div>
                  <div className="text-xl">{selectedObservation.percentageScore}%</div>
                  <div className="text-sm text-gray-600">{selectedObservation.flaggedCount} items flagged</div>
                </div>
              </div>

              <div className="space-y-2 mb-4">
                {CLASSROOM_OBSERVATION_PARAMETERS.map(param => {
                  const score = selectedObservation.responses?.[param.id];
                  const remark = selectedObservation.remarks?.[param.id];
                  const isFlagged = score !== undefined && score < param.maxScore;
                  
                  return (
                    <div key={param.id} className={`p-3 rounded-lg ${isFlagged ? 'bg-red-50' : 'bg-green-50'}`}>
                      <div className="flex justify-between items-start">
                        <div className="flex-1 text-sm">{param.text}</div>
                        <div className={`font-bold ml-2 ${isFlagged ? 'text-red-600' : 'text-green-600'}`}>
                          {score ?? 'N/A'}/{param.maxScore}
                        </div>
                      </div>
                      {remark && <div className="text-xs text-red-600 mt-1">üìù {remark}</div>}
                    </div>
                  );
                })}
              </div>

              {selectedObservation.strengths && (
                <div className="bg-green-50 p-4 rounded-xl mb-3">
                  <h4 className="font-bold text-green-700 mb-2">‚úÖ Strengths</h4>
                  <p className="text-sm">{selectedObservation.strengths}</p>
                </div>
              )}

              {selectedObservation.improvements && (
                <div className="bg-yellow-50 p-4 rounded-xl mb-3">
                  <h4 className="font-bold text-yellow-700 mb-2">üí° Improvements</h4>
                  <p className="text-sm">{selectedObservation.improvements}</p>
                </div>
              )}

              <div className="text-sm text-gray-500 mt-4">
                Observer: {selectedObservation.observerName} ({selectedObservation.observerPosition}) | 
                Submitted: {new Date(selectedObservation.submittedAt).toLocaleString('en-IN')}
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

// ========================================
// ADMIN CLASSROOM OBSERVATIONS
// ========================================
function AdminClassroomObservations({ teachers, currentUser }) {
  const [observations, setObservations] = useState([]);
  const [loading, setLoading] = useState(true);
  const [selectedTeacher, setSelectedTeacher] = useState(null);
  const [showObservationForm, setShowObservationForm] = useState(false);
  const [showTeacherProfile, setShowTeacherProfile] = useState(false);
  const [filterSchool, setFilterSchool] = useState('All');
  const [filterSubject, setFilterSubject] = useState('All');
  const [searchTerm, setSearchTerm] = useState('');
  
  // For observation list view
  const [observationList, setObservationList] = useState([]);
  const [listFilterSchool, setListFilterSchool] = useState('All');
  const [listFilterTeacher, setListFilterTeacher] = useState('All');
  const [dateFrom, setDateFrom] = useState('');
  const [dateTo, setDateTo] = useState('');

  // ‚úÖ NEW: Generate PDF for observation
  const generateObservationPDF = (observation) => {
    const printWindow = window.open('', '_blank');
    
    const parameterRows = CLASSROOM_OBSERVATION_PARAMETERS.map(param => {
      const score = observation.responses?.[param.id] ?? 'N/A';
      const remark = observation.remarks?.[param.id] || '';
      const isFlagged = score !== param.maxScore;
      return `
        <tr style="border-bottom: 1px solid #eee; ${isFlagged ? 'background-color: #FEE2E2;' : ''}">
          <td style="padding: 8px; font-size: 12px;">${param.type === 'major' ? '‚≠ê' : 'üìå'} ${param.text}</td>
          <td style="padding: 8px; text-align: center; font-weight: bold; ${isFlagged ? 'color: #DC2626;' : 'color: #059669;'}">${score}/${param.maxScore}</td>
          <td style="padding: 8px; font-size: 11px; color: #666;">${remark}</td>
        </tr>
      `;
    }).join('');

    const mediaSection = observation.mediaLinks?.length > 0 ? `
      <div style="margin-top: 20px;">
        <h3 style="color: #1F2937; border-bottom: 2px solid #F4B41A; padding-bottom: 5px;">üì∏ Media Links</h3>
        <ul style="font-size: 12px;">
          ${observation.mediaLinks.map((link, i) => `<li><a href="${link}" target="_blank">Media ${i + 1}</a></li>`).join('')}
        </ul>
      </div>
    ` : '';

    printWindow.document.write(`
      <!DOCTYPE html>
      <html>
      <head>
        <title>Classroom Observation - ${observation.teacherName}</title>
        <style>
          @media print {
            @page { margin: 1cm; size: A4; }
            body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
          }
          body { font-family: Arial, sans-serif; padding: 20px; color: #333; }
          .header { display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 3px solid #F4B41A; padding-bottom: 15px; margin-bottom: 20px; }
          .logo { font-size: 24px; font-weight: bold; color: #F4B41A; }
          .score-box { background: linear-gradient(135deg, #F4B41A, #E8B039); color: white; padding: 15px 25px; border-radius: 10px; text-align: center; }
          .score-box .score { font-size: 32px; font-weight: bold; }
          .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
          .info-item { padding: 10px; background: #F9FAFB; border-radius: 8px; }
          .info-item label { font-size: 11px; color: #6B7280; text-transform: uppercase; }
          .info-item span { display: block; font-weight: bold; color: #1F2937; }
          table { width: 100%; border-collapse: collapse; margin-top: 15px; }
          th { background: #F4B41A; color: white; padding: 10px; text-align: left; }
          .flagged { background: #FEF2F2; }
          .footer { position: fixed; bottom: 0; left: 0; right: 0; padding: 10px 20px; font-size: 10px; border-top: 1px solid #ddd; display: flex; justify-content: space-between; }
        </style>
      </head>
      <body>
        <div class="header">
          <div>
            <div class="logo">‡§Ö‡§µ‡§Ç‡§§‡•Ä Avanti Fellows</div>
            <h1 style="margin: 10px 0 5px; font-size: 20px;">Classroom Observation Report</h1>
            <p style="margin: 0; color: #666;">Teacher: ${observation.teacherName} | ${observation.teacherSubject}</p>
          </div>
          <div class="score-box">
            <div class="score">${observation.totalScore}/${observation.maxScore}</div>
            <div style="font-size: 14px;">${observation.percentageScore}%</div>
            <div style="font-size: 12px; margin-top: 5px;">${observation.flaggedCount} flagged</div>
          </div>
        </div>

        <div class="info-grid">
          <div class="info-item">
            <label>School</label>
            <span>${observation.school}</span>
          </div>
          <div class="info-item">
            <label>Grade</label>
            <span>Class ${observation.grade}</span>
          </div>
          <div class="info-item">
            <label>Observation Date</label>
            <span>${new Date(observation.observationDate).toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' })} ${observation.observationTime || ''}</span>
          </div>
          <div class="info-item">
            <label>Observer</label>
            <span>${observation.observerName} (${observation.observerPosition || 'Manager'})</span>
          </div>
        </div>

        <h3 style="color: #1F2937; border-bottom: 2px solid #F4B41A; padding-bottom: 5px;">Observation Parameters</h3>
        <table>
          <thead>
            <tr>
              <th style="width: 60%;">Parameter</th>
              <th style="width: 15%;">Score</th>
              <th style="width: 25%;">Remarks</th>
            </tr>
          </thead>
          <tbody>
            ${parameterRows}
          </tbody>
        </table>

        ${observation.strengths ? `
          <div style="margin-top: 20px; background: #ECFDF5; padding: 15px; border-radius: 8px;">
            <h4 style="color: #059669; margin: 0 0 10px;">‚úÖ Strengths Observed</h4>
            <p style="margin: 0; font-size: 13px;">${observation.strengths}</p>
          </div>
        ` : ''}

        ${observation.improvements ? `
          <div style="margin-top: 15px; background: #FEF3C7; padding: 15px; border-radius: 8px;">
            <h4 style="color: #D97706; margin: 0 0 10px;">üí° Points of Improvement</h4>
            <p style="margin: 0; font-size: 13px;">${observation.improvements}</p>
          </div>
        ` : ''}

        ${mediaSection}

        <div class="footer">
          <span>Private & Confidential</span>
          <span>Avanti Fellows - Classroom Observation</span>
        </div>
      </body>
      </html>
    `);

    printWindow.document.close();
    setTimeout(() => {
      printWindow.print();
    }, 500);
  };

  // Fetch all observations
  useEffect(() => {
    const fetchObservations = async () => {
      try {
        setLoading(true);
        const snapshot = await db.collection('classroomObservations')
          .orderBy('submittedAt', 'desc')
          .get();
        
        const data = snapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data(),
          submittedAt: doc.data().submittedAt?.toDate() || new Date(doc.data().submittedAtISO)
        }));
        
        setObservationList(data);
      } catch (error) {
        console.error('Error fetching observations:', error);
      } finally {
        setLoading(false);
      }
    };

    fetchObservations();
  }, []);

  // Filter teachers
  const filteredTeachers = teachers.filter(t => {
    const matchesSearch = t.name?.toLowerCase().includes(searchTerm.toLowerCase());
    const matchesSchool = filterSchool === 'All' || t.school === filterSchool;
    const matchesSubject = filterSubject === 'All' || t.subject === filterSubject;
    return matchesSearch && matchesSchool && matchesSubject;
  });

  // Filter observations list
  const filteredObservations = observationList.filter(obs => {
    const matchesSchool = listFilterSchool === 'All' || obs.school === listFilterSchool;
    const matchesTeacher = listFilterTeacher === 'All' || obs.teacherId === listFilterTeacher;
    const obsDate = new Date(obs.observationDate || obs.submittedAt).toISOString().split('T')[0];
    const matchesDateFrom = !dateFrom || obsDate >= dateFrom;
    const matchesDateTo = !dateTo || obsDate <= dateTo;
    return matchesSchool && matchesTeacher && matchesDateFrom && matchesDateTo;
  });

  // Get observation counts per teacher
  const teacherObservationCounts = useMemo(() => {
    const counts = {};
    observationList.forEach(obs => {
      counts[obs.teacherId] = (counts[obs.teacherId] || 0) + 1;
    });
    return counts;
  }, [observationList]);

  // Get latest score per teacher
  const teacherLatestScores = useMemo(() => {
    const scores = {};
    observationList.forEach(obs => {
      if (!scores[obs.teacherId]) {
        scores[obs.teacherId] = obs.percentageScore;
      }
    });
    return scores;
  }, [observationList]);

  // Observer info for form
  const observerInfo = {
    id: currentUser?.afid || currentUser?.uid,
    name: currentUser?.name || currentUser?.email || 'Admin',
    position: currentUser?.position || 'Manager'
  };

  // Handle observation form success
  const handleObservationSuccess = async () => {
    // Refresh observation list
    const snapshot = await db.collection('classroomObservations')
      .orderBy('submittedAt', 'desc')
      .get();
    
    const data = snapshot.docs.map(doc => ({
      id: doc.id,
      ...doc.data(),
      submittedAt: doc.data().submittedAt?.toDate() || new Date(doc.data().submittedAtISO)
    }));
    
    setObservationList(data);
  };

  // Export observations
  const handleExport = () => {
    const exportData = filteredObservations.map(obs => ({
      'Date': new Date(obs.observationDate || obs.submittedAt).toLocaleDateString('en-IN'),
      'Time': obs.observationTime || '',
      'Teacher': obs.teacherName,
      'Subject': obs.teacherSubject,
      'School': obs.school,
      'Grade': obs.grade,
      'Score': obs.totalScore,
      'Max Score': obs.maxScore,
      'Percentage': obs.percentageScore + '%',
      'Flagged Items': obs.flaggedCount,
      'Strengths': obs.strengths || '',
      'Improvements': obs.improvements || '',
      'Observer': obs.observerName
    }));
    exportToExcel(exportData, 'classroom_observations');
  };

  return (
    <div className="space-y-6">
      <h2 className="text-3xl font-bold">üìã Classroom Observations</h2>

      {/* Stats Cards */}
      <div className="grid md:grid-cols-4 gap-4">
        <div className="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-4 rounded-xl">
          <div className="text-sm opacity-90">Total Observations</div>
          <div className="text-3xl font-bold">{observationList.length}</div>
        </div>
        <div className="bg-gradient-to-r from-green-500 to-green-600 text-white p-4 rounded-xl">
          <div className="text-sm opacity-90">Teachers Observed</div>
          <div className="text-3xl font-bold">{Object.keys(teacherObservationCounts).length}</div>
        </div>
        <div className="bg-gradient-to-r from-yellow-500 to-orange-500 text-white p-4 rounded-xl">
          <div className="text-sm opacity-90">Avg Score</div>
          <div className="text-3xl font-bold">
            {observationList.length > 0 
              ? (observationList.reduce((sum, o) => sum + o.percentageScore, 0) / observationList.length).toFixed(1) + '%'
              : 'N/A'}
          </div>
        </div>
        <div className="bg-gradient-to-r from-purple-500 to-purple-600 text-white p-4 rounded-xl">
          <div className="text-sm opacity-90">This Month</div>
          <div className="text-3xl font-bold">
            {observationList.filter(o => {
              const d = new Date(o.observationDate || o.submittedAt);
              const now = new Date();
              return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
            }).length}
          </div>
        </div>
      </div>

      {/* Teacher Selection for New Observation */}
      <div className="bg-white p-6 rounded-2xl shadow-lg">
        <h3 className="text-xl font-bold mb-4">üë• Select Teacher for Observation</h3>
        
        {/* Filters */}
        <div className="grid md:grid-cols-3 gap-4 mb-4">
          <div>
            <label className="block text-sm font-bold mb-2">Search Teacher</label>
            <input
              type="text"
              value={searchTerm}
              onChange={e => setSearchTerm(e.target.value)}
              placeholder="Type name..."
              className="w-full border-2 px-4 py-3 rounded-xl"
            />
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">School</label>
            <select value={filterSchool} onChange={e => setFilterSchool(e.target.value)} className="w-full border-2 px-4 py-3 rounded-xl">
              <option value="All">All Schools</option>
              {SCHOOLS.map(s => <option key={s} value={s}>{s}</option>)}
            </select>
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">Subject</label>
            <select value={filterSubject} onChange={e => setFilterSubject(e.target.value)} className="w-full border-2 px-4 py-3 rounded-xl">
              <option value="All">All Subjects</option>
              {SUBJECTS.map(s => <option key={s} value={s}>{s}</option>)}
            </select>
          </div>
        </div>

        {/* Teacher Cards */}
        <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
          {filteredTeachers.map(teacher => (
            <div key={teacher.docId || teacher.afid} className="border-2 rounded-xl p-4 hover:border-yellow-400 transition">
              <div className="flex justify-between items-start mb-3">
                <div>
                  <div className="font-bold text-lg">{teacher.name}</div>
                  <div className="text-sm text-gray-500">{teacher.subject} | {teacher.school}</div>
                </div>
                {teacherObservationCounts[teacher.afid] && (
                  <span className="px-2 py-1 bg-blue-100 text-blue-700 rounded-full text-xs font-bold">
                    {teacherObservationCounts[teacher.afid]} obs
                  </span>
                )}
              </div>
              
              {teacherLatestScores[teacher.afid] !== undefined && (
                <div className="mb-3">
                  <span className="text-sm text-gray-500">Latest Score: </span>
                  <span className={`font-bold ${
                    teacherLatestScores[teacher.afid] >= 80 ? 'text-green-600' :
                    teacherLatestScores[teacher.afid] >= 60 ? 'text-yellow-600' : 'text-red-600'
                  }`}>
                    {teacherLatestScores[teacher.afid]}%
                  </span>
                </div>
              )}

              <div className="flex gap-2">
                <button
                  onClick={() => {
                    setSelectedTeacher(teacher);
                    setShowObservationForm(true);
                  }}
                  className="flex-1 px-3 py-2 avanti-gradient text-white rounded-lg text-sm font-semibold"
                >
                  üìù New Observation
                </button>
                <button
                  onClick={() => {
                    setSelectedTeacher(teacher);
                    setShowTeacherProfile(true);
                  }}
                  className="flex-1 px-3 py-2 bg-gray-200 rounded-lg text-sm font-semibold hover:bg-gray-300"
                >
                  üë§ Profile
                </button>
              </div>
            </div>
          ))}
        </div>
      </div>

      {/* Observation History */}
      <div className="bg-white p-6 rounded-2xl shadow-lg">
        <div className="flex justify-between items-center mb-4">
          <h3 className="text-xl font-bold">üìä Observation History</h3>
          <button onClick={handleExport} className="px-4 py-2 bg-green-600 text-white rounded-xl font-semibold">
            üì• Export to Excel
          </button>
        </div>

        {/* List Filters */}
        <div className="grid md:grid-cols-4 gap-4 mb-4">
          <div>
            <label className="block text-sm font-bold mb-2">School</label>
            <select value={listFilterSchool} onChange={e => setListFilterSchool(e.target.value)} className="w-full border-2 px-4 py-2 rounded-xl">
              <option value="All">All Schools</option>
              {SCHOOLS.map(s => <option key={s} value={s}>{s}</option>)}
            </select>
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">Teacher</label>
            <select value={listFilterTeacher} onChange={e => setListFilterTeacher(e.target.value)} className="w-full border-2 px-4 py-2 rounded-xl">
              <option value="All">All Teachers</option>
              {teachers.map(t => <option key={t.afid} value={t.afid}>{t.name}</option>)}
            </select>
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">From Date</label>
            <input type="date" value={dateFrom} onChange={e => setDateFrom(e.target.value)} className="w-full border-2 px-4 py-2 rounded-xl"/>
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">To Date</label>
            <input type="date" value={dateTo} onChange={e => setDateTo(e.target.value)} className="w-full border-2 px-4 py-2 rounded-xl"/>
          </div>
        </div>

        {/* Observations Table */}
        {loading ? (
          <div className="text-center py-8">
            <div className="text-4xl mb-2">‚è≥</div>
            <p>Loading observations...</p>
          </div>
        ) : filteredObservations.length === 0 ? (
          <div className="text-center py-8 text-gray-500">
            <div className="text-4xl mb-2">üìã</div>
            <p>No observations found</p>
          </div>
        ) : (
          <div className="overflow-x-auto">
            <table className="w-full">
              <thead className="avanti-gradient-light">
                <tr>
                  <th className="p-3 text-left">Date</th>
                  <th className="p-3 text-left">Teacher</th>
                  <th className="p-3 text-left">Subject</th>
                  <th className="p-3 text-left">School</th>
                  <th className="p-3 text-left">Grade</th>
                  <th className="p-3 text-left">Score</th>
                  <th className="p-3 text-left">Flagged</th>
                  <th className="p-3 text-left">Observer</th>
                  <th className="p-3 text-left">Actions</th>
                </tr>
              </thead>
              <tbody>
                {filteredObservations.map(obs => (
                  <tr key={obs.id} className="border-b hover:bg-gray-50">
                    <td className="p-3">
                      <div className="font-semibold">{new Date(obs.observationDate || obs.submittedAt).toLocaleDateString('en-IN')}</div>
                      <div className="text-xs text-gray-500">{obs.observationTime}</div>
                    </td>
                    <td className="p-3 font-semibold">{obs.teacherName}</td>
                    <td className="p-3">{obs.teacherSubject}</td>
                    <td className="p-3">{obs.school}</td>
                    <td className="p-3">Class {obs.grade}</td>
                    <td className="p-3">
                      <span className={`px-3 py-1 rounded-full font-bold ${
                        obs.percentageScore >= 80 ? 'bg-green-100 text-green-700' :
                        obs.percentageScore >= 60 ? 'bg-yellow-100 text-yellow-700' : 'bg-red-100 text-red-700'
                      }`}>
                        {obs.percentageScore}%
                      </span>
                    </td>
                    <td className="p-3">
                      <span className="px-2 py-1 bg-red-100 text-red-700 rounded-full text-sm">
                        {obs.flaggedCount}
                      </span>
                    </td>
                    <td className="p-3 text-sm">{obs.observerName}</td>
                    <td className="p-3">
                      <div className="flex gap-2">
                        <button
                          onClick={() => {
                            const teacher = teachers.find(t => t.afid === obs.teacherId);
                            if (teacher) {
                              setSelectedTeacher(teacher);
                              setShowTeacherProfile(true);
                            }
                          }}
                          className="px-3 py-1 bg-blue-600 text-white rounded-lg text-sm"
                        >
                          View
                        </button>
                        <button
                          onClick={() => generateObservationPDF(obs)}
                          className="px-3 py-1 bg-green-600 text-white rounded-lg text-sm"
                          title="Download/Print PDF"
                        >
                          üìÑ PDF
                        </button>
                      </div>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        )}
      </div>

      {/* Observation Form Modal */}
      {showObservationForm && selectedTeacher && (
        <ClassroomObservationForm
          teacher={selectedTeacher}
          observerInfo={observerInfo}
          onClose={() => {
            setShowObservationForm(false);
            setSelectedTeacher(null);
          }}
          onSubmitSuccess={handleObservationSuccess}
        />
      )}

      {/* Teacher Profile Modal */}
      {showTeacherProfile && selectedTeacher && (
        <TeacherProfileView
          teacher={selectedTeacher}
          currentUser={currentUser}
          onClose={() => {
            setShowTeacherProfile(false);
            setSelectedTeacher(null);
          }}
        />
      )}
      
      {/* Network Status Indicator for low-connectivity areas */}
      <NetworkStatus />
    </div>
  );
}

ReactDOM.render(<App/>,document.getElementById('root'));
  </script>
  <script>
  // ========================================
  // AGGRESSIVE AUTO-UPDATE MECHANISM FOR PWA
  // ========================================
  // Version management - UPDATE THIS WITH EACH DEPLOYMENT
  const CURRENT_VERSION = '3.7.3'; // ‚úÖ FIX: Removed bottom nav + Firebase index fallback + Better student loading

  // Immediately check for updates on every page load
  (async function immediateUpdateCheck() {
    try {
      // Fetch the latest index.html with cache bypass
      const response = await fetch('/index.html?v=' + Date.now(), { 
        cache: 'no-store',
        headers: { 'Cache-Control': 'no-cache' }
      });
      const html = await response.text();
      
      // Extract version from fetched HTML
      const versionMatch = html.match(/CURRENT_VERSION\s*=\s*['"]([^'"]+)['"]/);
      if (versionMatch && versionMatch[1] !== CURRENT_VERSION) {
        console.log('üÜï New version available:', versionMatch[1], '(current:', CURRENT_VERSION, ')');
        // Auto-update without asking
        performUpdate();
      }
    } catch (e) {
      console.log('Version check failed:', e);
    }
  })();

  // Check stored version
  function checkStoredVersion() {
    const storedVersion = localStorage.getItem('appVersion');
    if (storedVersion && storedVersion !== CURRENT_VERSION) {
      console.log('üîÑ Stored version mismatch, updating...');
      performUpdate();
    } else if (!storedVersion) {
      localStorage.setItem('appVersion', CURRENT_VERSION);
    }
  }

  // Perform the update
  async function performUpdate() {
    console.log('üîÑ Starting auto-update...');
    
    // Show update indicator
    const updateBanner = document.createElement('div');
    updateBanner.innerHTML = `
      <div style="position: fixed; top: 0; left: 0; right: 0; background: linear-gradient(90deg, #F4B41A, #E8B039); color: white; padding: 12px 20px; text-align: center; z-index: 99999; font-family: Arial, sans-serif; box-shadow: 0 2px 10px rgba(0,0,0,0.2);">
        <span style="font-size: 16px;">üîÑ Updating to latest version... Please wait</span>
      </div>
    `;
    document.body.prepend(updateBanner);

    try {
      // Clear all caches
      if ('caches' in window) {
        const cacheNames = await caches.keys();
        await Promise.all(cacheNames.map(name => caches.delete(name)));
        console.log('üóëÔ∏è All caches cleared');
      }

      // Unregister all service workers
      if ('serviceWorker' in navigator) {
        const registrations = await navigator.serviceWorker.getRegistrations();
        await Promise.all(registrations.map(reg => reg.unregister()));
        console.log('üóëÔ∏è Service workers unregistered');
      }

      // Preserve user session AND device ID for 2FA
      const sessionData = {
        studentSession: localStorage.getItem('studentSession'),
        authToken: localStorage.getItem('authToken'),
        avanti_device_id: localStorage.getItem('avanti_device_id'), // ‚úÖ FIX: Preserve 2FA device trust
        darkMode: localStorage.getItem('darkMode')
      };

      // Clear storage
      localStorage.clear();
      sessionStorage.clear();

      // Restore session AND device ID
      if (sessionData.studentSession) localStorage.setItem('studentSession', sessionData.studentSession);
      if (sessionData.authToken) localStorage.setItem('authToken', sessionData.authToken);
      if (sessionData.avanti_device_id) {
        localStorage.setItem('avanti_device_id', sessionData.avanti_device_id);
        sessionStorage.setItem('avanti_device_id', sessionData.avanti_device_id);
        // Also restore cookie
        const expires = new Date(Date.now() + 30*24*60*60*1000).toUTCString();
        document.cookie = `avanti_device_id=${sessionData.avanti_device_id};expires=${expires};path=/;SameSite=Strict`;
        console.log('‚úÖ Device ID preserved during update');
      }
      if (sessionData.darkMode) localStorage.setItem('darkMode', sessionData.darkMode);
      
      // Set new version
      localStorage.setItem('appVersion', CURRENT_VERSION);

      // Force reload with cache bypass
      setTimeout(() => {
        window.location.href = window.location.pathname + '?updated=' + Date.now();
      }, 500);

    } catch (e) {
      console.error('Update failed:', e);
      window.location.reload(true);
    }
  }

  // Manual update function
  window.forceUpdate = performUpdate;

  // Register service worker with immediate update behavior
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', async () => {
      try {
        const registration = await navigator.serviceWorker.register('/sw.js');
        console.log('‚úÖ Service Worker registered');

        // Check for updates immediately
        registration.update();

        // Check for updates every 5 minutes
        setInterval(() => registration.update(), 5 * 60 * 1000);

        // Handle updates
        registration.addEventListener('updatefound', () => {
          const newWorker = registration.installing;
          newWorker.addEventListener('statechange', () => {
            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
              // Skip waiting and activate immediately
              newWorker.postMessage({ type: 'SKIP_WAITING' });
            }
          });
        });

        // Reload on controller change
        navigator.serviceWorker.addEventListener('controllerchange', () => {
          window.location.reload(true);
        });

      } catch (err) {
        console.error('SW registration failed:', err);
      }
    });
  }

  // Also check on visibility change (when user returns to app)
  document.addEventListener('visibilitychange', () => {
    if (!document.hidden) {
      checkStoredVersion();
    }
  });

  // Check on load
  window.addEventListener('load', () => setTimeout(checkStoredVersion, 2000));

  // Log version
  console.log('%cüì± Curriculum Tracker v' + CURRENT_VERSION, 'color: #F4B41A; font-size: 16px; font-weight: bold;');
  console.log('%cType forceUpdate() to manually update', 'color: #666; font-size: 12px;');
</script>
  <script>
  window.va = window.va || function () { (window.vaq = window.vaq || []).push(arguments); };
</script>
<script defer src="/_vercel/insights/script.js"></script>
<script defer src="/_vercel/speed-insights/script.js"></script>

<!-- START: Global saving-indicator + Firestore write wrapper (added by ChatGPT) -->
<style>
/* simple overlay */
#__global_saving_overlay {
  position: fixed;
  right: 16px;
  bottom: 16px;
  background: rgba(0,0,0,0.75);
  color: white;
  padding: 10px 14px;
  border-radius: 10px;
  font-weight: 600;
  z-index: 99999;
  display: none;
  align-items: center;
  gap: 8px;
  box-shadow: 0 6px 20px rgba(0,0,0,0.35);
  backdrop-filter: blur(4px);
}
.__saving_spinner {
  width: 16px;
  height: 16px;
  border: 2px solid rgba(255,255,255,0.25);
  border-top-color: white;
  border-radius: 50%;
  animation: __spin 1s linear infinite;
}
@keyframes __spin { to { transform: rotate(360deg); } }

/* disabled appearance when saving */
.__global_saving_disabled {
  pointer-events: none !important;
  opacity: 0.6 !important;
}
</style>

<div id="__global_saving_overlay" aria-live="polite" role="status">
  <div class="__saving_spinner" aria-hidden="true"></div>
  <div>Saving‚Ä¶</div>
</div>

<script>
(function(){
  // Small, resilient wrapper that watches Firestore write methods and shows a saving indicator.
  if (!window || !document) return;
  const overlay = document.getElementById('__global_saving_overlay');
  let activeWrites = 0;
  function updateUI(){
    if (activeWrites > 0) {
      overlay.style.display = 'flex';
      // disable interactive elements except those marked data-allow-during-saving="true"
      const selectors = 'button, input[type="button"], input[type="submit"], a[role="button"], select, textarea';
      document.querySelectorAll(selectors).forEach(el=>{
        if (el.dataset.allowDuringSaving === "true") return;
        el.__wasDisabledBySaving = el.disabled || false;
        try { el.disabled = true; } catch(e){}
        el.classList.add('__global_saving_disabled');
      });
    } else {
      overlay.style.display = 'none';
      const selectors = 'button, input[type="button"], input[type="submit"], a[role="button"], select, textarea';
      document.querySelectorAll(selectors).forEach(el=>{
        try {
          // restore original disabled state only if we changed it
          if (el.__wasDisabledBySaving !== undefined) el.disabled = !!el.__wasDisabledBySaving;
        } catch(e){}
        el.classList.remove('__global_saving_disabled');
      });
    }
  }

  function startWrite(){ activeWrites++; updateUI(); }
  function endWrite(){ activeWrites = Math.max(0, activeWrites-1); updateUI(); }

  // Wrap common Firestore write methods if firebase is present.
  function tryWrapFirestore(firebase){
    try {
      const firestore = firebase && firebase.firestore && firebase.firestore();
      if (!firestore) return;
      // DocumentReference.prototype.set/update/delete
      const docProto = firestore.constructor && firestore.constructor.prototype;
      // Instead, find DocumentReference from an actual doc object if possible
      let sampleDoc;
      try {
        sampleDoc = firestore.collection('_chattmp_').doc('_tmp_');
      } catch(e){}
      if (sampleDoc) {
        const docRefProto = Object.getPrototypeOf(sampleDoc);
        ['set','update','delete'].forEach(name=>{
          if (docRefProto && docRefProto[name]) {
            const orig = docRefProto[name];
            if (!orig.__wrappedBySaving) {
              docRefProto[name] = function(...args){
                startWrite();
                try {
                  const result = orig.apply(this,args);
                  if (result && typeof result.then === 'function') {
                    return result.finally(endWrite);
                  } else {
                    endWrite();
                    return result;
                  }
                } catch(err){
                  endWrite();
                  throw err;
                }
              };
              docRefProto[name].__wrappedBySaving = true;
            }
          }
        });
      }
      // CollectionReference.add
      let sampleCol;
      try { sampleCol = firestore.collection('_chattmp_'); } catch(e){}
      if (sampleCol) {
        const colProto = Object.getPrototypeOf(sampleCol);
        if (colProto && colProto.add && !colProto.add.__wrappedBySaving) {
          const origAdd = colProto.add;
          colProto.add = function(...args){
            startWrite();
            try {
              const result = origAdd.apply(this,args);
              if (result && typeof result.then === 'function') {
                return result.finally(endWrite);
              } else {
                endWrite();
                return result;
              }
            } catch(err){
              endWrite();
              throw err;
            }
          };
          colProto.add.__wrappedBySaving = true;
        }
      }

      // Wrap write batch commit if available
      try {
        const batch = firestore.batch();
        const batchProto = Object.getPrototypeOf(batch);
        if (batchProto && batchProto.commit && !batchProto.commit.__wrappedBySaving) {
          const origCommit = batchProto.commit;
          batchProto.commit = function(...args){
            startWrite();
            try {
              const res = origCommit.apply(this,args);
              if (res && typeof res.then === 'function') return res.finally(endWrite);
              endWrite();
              return res;
            } catch(e){
              endWrite();
              throw e;
            }
          };
          batchProto.commit.__wrappedBySaving = true;
        }
      } catch(e){}
    } catch(e){}
  }

  // Try to wrap immediately if firebase exists, otherwise poll until it does (for lazy init)
  function attemptWrap(){
    try {
      if (window.firebase && firebase.firestore) {
        tryWrapFirestore(window.firebase);
        return true;
      }
    } catch(e){}
    return false;
  }
  if (!attemptWrap()){
    // poll a few times
    const maxAttempts = 20;
    let attempts = 0;
    const t = setInterval(()=>{
      attempts++;
      if (attemptWrap() || attempts >= maxAttempts) clearInterval(t);
    }, 300);
  }

  // As a fallback, also watch for global ajax/fetch/XHR calls that return promises ‚Äî optional
  // Wrap fetch to show saving indicator if fetch options contain a header 'X-Expect-Save: true'
  if (window.fetch && !window.fetch.__wrappedBySaving) {
    const origFetch = window.fetch.bind(window);
    window.fetch = function(resource, init){
      const expectSave = init && init.headers && (init.headers['X-Expect-Save'] === 'true' || init.headers.get && init.headers.get('X-Expect-Save') === 'true');
      if (expectSave) startWrite();
      const p = origFetch(resource, init);
      if (expectSave && p && typeof p.then === 'function') return p.finally(()=>endWrite());
      return p;
    };
    window.fetch.__wrappedBySaving = true;
  }

  // expose controls for debugging
  window.__savingOverlay = {
    isActive: ()=> activeWrites > 0,
    startWrite,
    endWrite
  };

})();
</script>

<!-- Avanti Help Desk Widget - Standalone File -->
<script src="avanti-widget.js"></script>


<!-- ============================================
     GLOBAL NOTIFICATION SYSTEM
     For entire Curriculum Tracker app
============================================ -->
<style>
/* Notification Bell - Top Right Position */
.notification-bell {
    position: fixed;
    top: 20px;
    right: 80px;
    z-index: 9998;
    background: #12121a;
    border: 1px solid #2a2a3a;
    border-radius: 50%;
    width: 44px;
    height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}

/* Hide bell when all notifications are read */
.notification-bell.all-read {
    opacity: 0;
    pointer-events: none;
    transform: scale(0.8);
}

.notification-bell:hover {
    background: #1a1a24;
    transform: scale(1.05);
}

.notification-bell .bell-icon {
    font-size: 20px;
}

.notification-bell .badge {
    position: absolute;
    top: -4px;
    right: -4px;
    background: #ef4444;
    color: white;
    font-size: 11px;
    font-weight: 700;
    min-width: 18px;
    height: 18px;
    border-radius: 9px;
    display: none;
    align-items: center;
    justify-content: center;
    padding: 0 4px;
}

.notification-bell .badge.show {
    display: flex;
}

/* Notification Panel - Top Right Position */
.notification-panel {
    position: fixed;
    top: 70px;
    right: 20px;
    width: 340px;
    max-height: 450px;
    background: #12121a;
    border: 1px solid #2a2a3a;
    border-radius: 16px;
    z-index: 9997;
    display: none;
    flex-direction: column;
    box-shadow: 0 10px 40px rgba(0,0,0,0.4);
    overflow: hidden;
}

.notification-panel.show {
    display: flex;
}

.notification-panel-header {
    padding: 16px 20px;
    border-bottom: 1px solid #2a2a3a;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.notification-panel-header h3 {
    color: #F4B41A;
    font-size: 16px;
    font-weight: 600;
}

.notification-panel-header button {
    background: none;
    border: none;
    color: #8a8a9a;
    cursor: pointer;
    font-size: 12px;
}

.notification-panel-header button:hover {
    color: #F4B41A;
}

.notification-panel-body {
    flex: 1;
    overflow-y: auto;
    padding: 12px;
}

.notification-item {
    background: #1a1a24;
    border: 1px solid #2a2a3a;
    border-radius: 12px;
    padding: 14px;
    margin-bottom: 10px;
    cursor: pointer;
    transition: all 0.2s;
}

.notification-item:hover {
    border-color: #F4B41A;
}

.notification-item.unread {
    border-left: 3px solid #F4B41A;
}

.notification-item .title {
    color: #fff;
    font-weight: 600;
    font-size: 14px;
    margin-bottom: 6px;
}

.notification-item .message {
    color: #8a8a9a;
    font-size: 13px;
    line-height: 1.4;
}

.notification-item .time {
    color: #5a5a6a;
    font-size: 11px;
    margin-top: 8px;
}

/* Notification Expansion Popup */
.notification-expansion-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    z-index: 10001;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
}

.notification-expansion-popup {
    background: #12121a;
    border: 1px solid #2a2a3a;
    border-radius: 16px;
    max-width: 500px;
    width: 100%;
    max-height: 80vh;
    overflow: hidden;
    box-shadow: 0 20px 60px rgba(0,0,0,0.5);
}

.notification-expansion-header {
    padding: 16px 20px;
    border-bottom: 1px solid #2a2a3a;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.notification-expansion-header h3 {
    color: #F4B41A;
    font-size: 16px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
}

.notification-expansion-close {
    background: none;
    border: none;
    color: #8a8a9a;
    font-size: 24px;
    cursor: pointer;
    transition: color 0.2s;
}

.notification-expansion-close:hover {
    color: #fff;
}

.notification-expansion-body {
    padding: 20px;
    overflow-y: auto;
    max-height: calc(80vh - 150px);
}

.notification-expansion-message {
    color: #e0e0e0;
    font-size: 15px;
    line-height: 1.6;
    white-space: pre-wrap;
    margin-bottom: 16px;
}

.notification-expansion-meta {
    color: #6a6a7a;
    font-size: 12px;
    margin-top: 12px;
    padding-top: 12px;
    border-top: 1px solid #2a2a3a;
}

.notification-expansion-actions {
    padding: 16px 20px;
    border-top: 1px solid #2a2a3a;
    display: flex;
    gap: 12px;
}

.notification-expansion-actions button {
    flex: 1;
    padding: 12px 20px;
    border-radius: 10px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
}

.notification-reply-btn {
    background: #F4B41A;
    color: #000;
    border: none;
}

.notification-reply-btn:hover {
    background: #e5a617;
}

.notification-close-btn {
    background: #2a2a3a;
    color: #fff;
    border: 1px solid #3a3a4a;
}

.notification-close-btn:hover {
    background: #3a3a4a;
}

.notification-empty {
    text-align: center;
    padding: 40px 20px;
    color: #5a5a6a;
}

.notification-empty .icon {
    font-size: 40px;
    margin-bottom: 12px;
}

/* Enable notifications banner */
.enable-notifications-banner {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    padding: 12px 16px;
    margin: 12px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.enable-notifications-banner .text {
    flex: 1;
    color: #fff;
    font-size: 12px;
}

.enable-notifications-banner .btn {
    background: #fff;
    color: #667eea;
    border: none;
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 11px;
    font-weight: 600;
    cursor: pointer;
}

@media (max-width: 480px) {
    .notification-bell {
        top: 15px;
        right: 70px;
        width: 38px;
        height: 38px;
    }
    
    .notification-panel {
        top: 60px;
        right: 10px;
        left: 10px;
        width: auto;
    }
}
</style>

<!-- Notification Bell -->
<div class="notification-bell" id="notificationBell" onclick="NotificationManager.togglePanel()">
    <span class="bell-icon">üîî</span>
    <span class="badge" id="notificationBadge">0</span>
</div>

<!-- Notification Panel -->
<div class="notification-panel" id="notificationPanel">
    <div class="notification-panel-header">
        <h3>üîî Notifications</h3>
        <button onclick="NotificationManager.markAllRead()">Mark all read</button>
    </div>
    <div class="notification-panel-body" id="notificationList">
        <!-- Notifications loaded here -->
    </div>
</div>

<script>
// ============================================
// NOTIFICATION MANAGER - Global App Notifications
// ============================================
const NotificationManager = {
    notifications: [],
    unreadCount: 0,
    messaging: null,
    fcmToken: null,
    isOpen: false,
    userId: null,
    notificationSound: null,
    
    init: function() {
        console.log('[NotificationManager] Initializing...');
        
        // Initialize notification sound
        this.initSound();
        
        // Resume audio context on first user interaction
        const resumeAudio = () => {
            if (this.audioContext && this.audioContext.state === 'suspended') {
                this.audioContext.resume().then(() => {
                    console.log('[NotificationManager] AudioContext resumed');
                });
            }
        };
        document.addEventListener('click', resumeAudio, { once: true });
        document.addEventListener('touchstart', resumeAudio, { once: true });
        
        // Get user ID
        this.getUserId();
        
        // Initialize Firebase Messaging
        this.initMessaging();
        
        // Load notifications from Firestore
        setTimeout(() => this.loadNotifications(), 2000);
        
        // Check for today's birthdays/anniversaries at 8 AM
        this.scheduleCelebrationNotifications();
        
        // Close panel when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.notification-bell') && !e.target.closest('.notification-panel')) {
                this.closePanel();
            }
        });
        
        console.log('[NotificationManager] Initialized');
    },
    
    initSound: function() {
        try {
            // Use a simple beep sound (base64 encoded)
            // This is a short notification beep that works without external files
            const beepData = 'data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU' + 
              Array(300).fill('A').join('') + 
              Array(300).fill('/').join('') + 
              Array(200).fill('A').join('');
            
            // Create audio context for better browser support
            this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
            this.notificationSound = new Audio(beepData);
            this.notificationSound.volume = 0.5;
            
            // Also create an oscillator-based sound as backup
            this.useOscillator = true;
            console.log('[NotificationManager] Sound initialized');
        } catch (e) {
            console.log('[NotificationManager] Sound init error:', e);
        }
    },
    
    playSound: function() {
        try {
            // Try oscillator beep first (more reliable)
            if (this.audioContext) {
                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(this.audioContext.destination);
                
                oscillator.frequency.value = 800; // Hz
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.3, this.audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.3);
                
                oscillator.start(this.audioContext.currentTime);
                oscillator.stop(this.audioContext.currentTime + 0.3);
                
                console.log('[NotificationManager] Beep played!');
            }
        } catch (e) {
            console.log('[NotificationManager] Sound error:', e);
        }
    },
    
    scheduleCelebrationNotifications: function() {
        // Check if we should send celebration notifications
        const now = new Date();
        const targetHour = 8; // 8 AM
        const currentHour = now.getHours();
        
        // If it's between 8 AM and 9 AM, check immediately (for users who just opened the app)
        if (currentHour >= targetHour && currentHour < 10) {
            console.log('[NotificationManager] Checking for celebrations now (within morning window)');
            this.sendCelebrationNotifications();
        }
        
        // Calculate milliseconds until next 8 AM
        const target = new Date(now);
        target.setHours(targetHour, 0, 0, 0);
        
        if (now >= target) {
            // Already past 8 AM today, schedule for next day
            target.setDate(target.getDate() + 1);
        }
        
        const msUntil8AM = target - now;
        
        // Schedule the check for next 8 AM
        setTimeout(() => {
            this.sendCelebrationNotifications();
            // Then repeat every 24 hours
            setInterval(() => this.sendCelebrationNotifications(), 24 * 60 * 60 * 1000);
        }, msUntil8AM);
        
        console.log('[NotificationManager] Celebration check scheduled');
    },
    
    sendCelebrationNotifications: async function() {
        if (!this.userId || typeof firebase === 'undefined') return;
        
        const today = new Date();
        const todayStr = today.toDateString();
        
        // Check if already sent today
        const sentToday = localStorage.getItem('celebrationNotifSent_' + todayStr);
        if (sentToday) {
            console.log('[NotificationManager] Celebration notification already sent today');
            return;
        }
        
        try {
            console.log('[NotificationManager] Checking for celebrations at 8 AM...');
            
            // Check for birthdays and anniversaries
            const teachersSnap = await firebase.firestore().collection('teachers').get();
            const managersSnap = await firebase.firestore().collection('managers').get();
            const apcsSnap = await firebase.firestore().collection('apcs').get();
            
            const all = [
                ...teachersSnap.docs.map(d => ({ ...d.data(), id: d.id, type: 'teacher' })),
                ...managersSnap.docs.map(d => ({ ...d.data(), id: d.id, type: 'manager' })),
                ...apcsSnap.docs.map(d => ({ ...d.data(), id: d.id, type: 'apc' }))
            ].filter(m => m.name && m.name.toLowerCase() !== 'vacant' && !m.isArchived);
            
            console.log('[NotificationManager] Total members to check:', all.length);
            
            const birthdays = all.filter(m => {
                const dobField = m.dateOfBirth || m.dob;
                if (!dobField) return false;
                const dob = new Date(dobField);
                return dob.getMonth() === today.getMonth() && dob.getDate() === today.getDate();
            });
            
            const anniversaries = all.filter(m => {
                if (!m.joiningDate) return false;
                const j = new Date(m.joiningDate);
                if (j.getFullYear() >= today.getFullYear()) return false;
                return j.getMonth() === today.getMonth() && j.getDate() === today.getDate();
            });
            
            console.log('[NotificationManager] Birthdays found:', birthdays.length);
            console.log('[NotificationManager] Anniversaries found:', anniversaries.length);
            
            // Store celebration notifications in Firestore for background delivery
            // This allows a Cloud Function to send push notifications to all users
            if (birthdays.length > 0 || anniversaries.length > 0) {
                const celebrationNotification = {
                    type: 'celebration',
                    date: todayStr,
                    birthdays: birthdays.map(b => ({ name: b.name, id: b.id })),
                    anniversaries: anniversaries.map(a => ({ 
                        name: a.name, 
                        id: a.id, 
                        years: today.getFullYear() - new Date(a.joiningDate).getFullYear() 
                    })),
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    processed: false
                };
                
                // Store in app_notifications for all users to see
                await firebase.firestore().collection('app_notifications').add({
                    title: birthdays.length > 0 ? 'üéÇ Birthday Today!' : 'üéâ Work Anniversary!',
                    message: birthdays.length > 0 
                        ? `Wish ${birthdays.map(b => b.name).slice(0, 2).join(', ')}${birthdays.length > 2 ? ` and ${birthdays.length - 2} more` : ''} a Happy Birthday!`
                        : `Congratulate ${anniversaries.map(a => a.name).slice(0, 2).join(', ')}${anniversaries.length > 2 ? ` and ${anniversaries.length - 2} more` : ''} on their work anniversary!`,
                    type: 'celebration',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                console.log('[NotificationManager] Stored celebration notification in Firestore');
            }
            
            // Request notification permission if not granted
            if (Notification.permission === 'default') {
                console.log('[NotificationManager] Requesting notification permission...');
                await Notification.requestPermission();
            }
            
            // Show browser notification with sound
            if (Notification.permission === 'granted') {
                if (birthdays.length > 0) {
                    const names = birthdays.map(b => b.name).slice(0, 3).join(', ');
                    const notif = new Notification('üéÇ Birthday Today!', {
                        body: birthdays.length === 1 
                            ? `Wish ${names} a Happy Birthday!`
                            : `${names}${birthdays.length > 3 ? ` and ${birthdays.length - 3} more` : ''} have birthdays today!`,
                        icon: 'Icon-192.png',
                        tag: 'birthday-notification',
                        requireInteraction: true
                    });
                    
                    // Play notification sound
                    this.playNotificationSound('birthday');
                    
                    // Click handler to open app
                    notif.onclick = function() {
                        window.focus();
                        notif.close();
                    };
                }
                
                if (anniversaries.length > 0) {
                    // Delay second notification by 2 seconds if there's a birthday notification
                    setTimeout(() => {
                        const names = anniversaries.map(a => a.name).slice(0, 3).join(', ');
                        const notif = new Notification('üéâ Work Anniversary Today!', {
                            body: anniversaries.length === 1
                                ? `Congratulate ${names} on their work anniversary!`
                                : `${names}${anniversaries.length > 3 ? ` and ${anniversaries.length - 3} more` : ''} have work anniversaries today!`,
                            icon: 'Icon-192.png',
                            tag: 'anniversary-notification',
                            requireInteraction: true
                        });
                        
                        this.playNotificationSound('anniversary');
                        
                        notif.onclick = function() {
                            window.focus();
                            notif.close();
                        };
                    }, birthdays.length > 0 ? 2000 : 0);
                }
            } else {
                console.log('[NotificationManager] Notification permission not granted:', Notification.permission);
            }
            
            localStorage.setItem('celebrationNotifSent_' + todayStr, 'true');
        } catch (e) {
            console.error('[NotificationManager] Celebration check error:', e);
        }
    },
    
    // Play celebration notification sound
    playNotificationSound: function(type) {
        try {
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            
            if (type === 'birthday') {
                // Happy birthday jingle - C E G C (higher)
                const notes = [523.25, 659.25, 783.99, 1046.50];
                notes.forEach((freq, i) => {
                    setTimeout(() => {
                        const osc = audioCtx.createOscillator();
                        const gain = audioCtx.createGain();
                        osc.connect(gain);
                        gain.connect(audioCtx.destination);
                        osc.frequency.value = freq;
                        osc.type = 'sine';
                        gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
                        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                        osc.start(audioCtx.currentTime);
                        osc.stop(audioCtx.currentTime + 0.3);
                    }, i * 150);
                });
            } else {
                // Celebration sound - ascending chord
                const notes = [440, 554.37, 659.25];
                notes.forEach((freq, i) => {
                    const osc = audioCtx.createOscillator();
                    const gain = audioCtx.createGain();
                    osc.connect(gain);
                    gain.connect(audioCtx.destination);
                    osc.frequency.value = freq;
                    osc.type = 'sine';
                    gain.gain.setValueAtTime(0.2, audioCtx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
                    osc.start(audioCtx.currentTime);
                    osc.stop(audioCtx.currentTime + 0.5);
                });
            }
            
            console.log('[NotificationManager] üîî Celebration sound played');
        } catch (e) {
            console.log('[NotificationManager] Could not play sound:', e);
        }
    },
    
    getUserId: function() {
        // Try to get from localStorage (students)
        const studentSession = localStorage.getItem('studentSession');
        if (studentSession) {
            try {
                const student = JSON.parse(studentSession);
                this.userId = student.studentId || student.id || null;
                return;
            } catch (e) {}
        }
        
        // Try Firebase Auth (teachers)
        if (typeof firebase !== 'undefined' && firebase.auth) {
            firebase.auth().onAuthStateChanged(user => {
                if (user) {
                    this.userId = user.email;
                    this.loadNotifications();
                }
            });
        }
    },
    
    initMessaging: function() {
        // ‚úÖ FIX: Wait for firebase.messaging to be fully loaded (deferred script)
        const initWithRetry = (retries = 5) => {
            if (typeof firebase === 'undefined' || !firebase.messaging) {
                if (retries > 0) {
                    console.log('[NotificationManager] Waiting for Firebase Messaging... retries left:', retries);
                    setTimeout(() => initWithRetry(retries - 1), 1000);
                    return;
                }
                console.log('[NotificationManager] Firebase Messaging not available after retries');
                return;
            }
            
            try {
                this.messaging = firebase.messaging();
                console.log('[NotificationManager] Messaging ready');
                
                // Handle foreground messages
                this.messaging.onMessage((payload) => {
                    console.log('[NotificationManager] Message received:', payload);
                    
                    // Play notification sound
                    this.playSound();
                    
                    // Show browser notification
                    if (Notification.permission === 'granted') {
                        new Notification(payload.notification?.title || 'Avanti Fellows', {
                            body: payload.notification?.body,
                            icon: 'Icon-192.png'
                        });
                    }
                    
                    // Reload notifications
                    this.loadNotifications();
                });
                
                // Auto-request permission and get token if not already done
                this.autoRequestPermission();
                
                // Check for pending celebration notifications from background
                this.checkPendingCelebrations();
            } catch (e) {
                console.log('[NotificationManager] Messaging init error:', e);
            }
        };
        
        initWithRetry();
    },
    
    // ‚úÖ NEW: Auto-request permission silently if possible
    autoRequestPermission: async function() {
        try {
            // Check if we already have a token stored
            const storedToken = localStorage.getItem('fcmToken_' + (this.userId || 'guest'));
            if (storedToken) {
                this.fcmToken = storedToken;
                console.log('[NotificationManager] Using stored FCM token');
                return;
            }
            
            // If permission is already granted, get token
            if (Notification.permission === 'granted') {
                await this.getAndStoreFCMToken();
            } else if (Notification.permission === 'default') {
                // Show a subtle prompt after some delay
                setTimeout(() => {
                    this.showPermissionPrompt();
                }, 10000); // Wait 10 seconds before showing prompt
            }
        } catch (e) {
            console.log('[NotificationManager] Auto permission error:', e);
        }
    },
    
    // ‚úÖ NEW: Show a subtle permission prompt
    showPermissionPrompt: function() {
        // Don't show if user already dismissed recently
        const dismissed = localStorage.getItem('notifPromptDismissed');
        if (dismissed) {
            const dismissedDate = new Date(dismissed);
            const daysSince = (Date.now() - dismissedDate) / (1000 * 60 * 60 * 24);
            if (daysSince < 7) return; // Don't show again for 7 days
        }
        
        // ‚úÖ FIX: Actually show a prompt UI
        const promptDiv = document.createElement('div');
        promptDiv.id = 'notification-prompt';
        promptDiv.innerHTML = `
          <div style="position:fixed;bottom:20px;right:20px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:16px 20px;border-radius:16px;box-shadow:0 10px 40px rgba(0,0,0,0.3);z-index:9999;max-width:320px;font-family:system-ui,sans-serif;">
            <div style="display:flex;align-items:flex-start;gap:12px;">
              <div style="font-size:28px;">üîî</div>
              <div style="flex:1;">
                <div style="font-weight:600;font-size:14px;margin-bottom:4px;">Enable Notifications?</div>
                <div style="font-size:12px;opacity:0.9;line-height:1.4;">Get alerts for birthdays, mentions, and important updates even when you're not on this page.</div>
                <div style="display:flex;gap:8px;margin-top:12px;">
                  <button id="notif-enable-btn" style="flex:1;padding:8px 12px;background:white;color:#667eea;border:none;border-radius:8px;font-weight:600;font-size:12px;cursor:pointer;">Enable</button>
                  <button id="notif-later-btn" style="padding:8px 12px;background:rgba(255,255,255,0.2);color:white;border:none;border-radius:8px;font-size:12px;cursor:pointer;">Later</button>
                </div>
              </div>
              <button id="notif-close-btn" style="background:none;border:none;color:white;font-size:20px;cursor:pointer;padding:0;line-height:1;">√ó</button>
            </div>
          </div>
        `;
        document.body.appendChild(promptDiv);
        
        const self = this;
        
        document.getElementById('notif-enable-btn').onclick = async function() {
            promptDiv.remove();
            try {
                const permission = await Notification.requestPermission();
                if (permission === 'granted') {
                    console.log('[NotificationManager] Permission granted!');
                    await self.getAndStoreFCMToken();
                    // Show success toast
                    self.showToast('üîî Notifications enabled!', 'success');
                }
            } catch (e) {
                console.log('[NotificationManager] Permission error:', e);
            }
        };
        
        document.getElementById('notif-later-btn').onclick = function() {
            localStorage.setItem('notifPromptDismissed', new Date().toISOString());
            promptDiv.remove();
        };
        
        document.getElementById('notif-close-btn').onclick = function() {
            localStorage.setItem('notifPromptDismissed', new Date().toISOString());
            promptDiv.remove();
        };
        
        console.log('[NotificationManager] Permission prompt shown');
    },
    
    // ‚úÖ NEW: Show toast notification
    showToast: function(message, type = 'info') {
        const toast = document.createElement('div');
        toast.style.cssText = `position:fixed;bottom:80px;right:20px;padding:12px 20px;border-radius:12px;color:white;font-size:14px;font-weight:500;z-index:9999;animation:slideIn 0.3s ease;`;
        toast.style.background = type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6';
        toast.textContent = message;
        document.body.appendChild(toast);
        setTimeout(() => {
            toast.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    },
    
    // ‚úÖ NEW: Get and store FCM token
    getAndStoreFCMToken: async function() {
        if (!this.messaging) {
            console.log('[NotificationManager] Messaging not initialized');
            return;
        }
        
        try {
            // Register service worker if not already
            let sw = null;
            try {
                sw = await navigator.serviceWorker.getRegistration('/firebase-messaging-sw.js');
                if (!sw) {
                    console.log('[NotificationManager] Registering service worker...');
                    sw = await navigator.serviceWorker.register('/firebase-messaging-sw.js');
                    console.log('[NotificationManager] Service worker registered');
                }
            } catch (swError) {
                console.log('[NotificationManager] Service worker error (will try without):', swError);
            }
            
            // ‚úÖ FIX: Try to get token - first without VAPID key (works for many Firebase configs)
            let token = null;
            try {
                // Try with service worker if available
                if (sw) {
                    token = await this.messaging.getToken({
                        serviceWorkerRegistration: sw
                    });
                } else {
                    // Try without service worker
                    token = await this.messaging.getToken();
                }
            } catch (tokenError) {
                console.log('[NotificationManager] Token error (will retry):', tokenError.message);
                // Some errors are expected on first try, retry after a moment
                await new Promise(resolve => setTimeout(resolve, 1000));
                try {
                    token = await this.messaging.getToken();
                } catch (retryError) {
                    console.log('[NotificationManager] Token retry failed:', retryError.message);
                }
            }
            
            if (token) {
                this.fcmToken = token;
                try {
                    localStorage.setItem('fcmToken_' + (this.userId || 'guest'), token);
                } catch(e) {}
                console.log('[NotificationManager] ‚úÖ FCM Token obtained:', token.substring(0, 20) + '...');
                
                // Save token to Firestore for this user
                if (this.userId && typeof firebase !== 'undefined') {
                    try {
                        await firebase.firestore().collection('fcm_tokens').doc(this.userId).set({
                            token: token,
                            userId: this.userId,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                            platform: /Mobile|Android|iPhone|iPad/i.test(navigator.userAgent) ? 'mobile' : 'web',
                            userAgent: navigator.userAgent.substring(0, 200)
                        }, { merge: true });
                        console.log('[NotificationManager] ‚úÖ Token saved to Firestore');
                    } catch (firestoreError) {
                        console.log('[NotificationManager] Could not save token to Firestore:', firestoreError);
                    }
                }
                
                return token;
            } else {
                console.log('[NotificationManager] No token received');
            }
        } catch (e) {
            console.log('[NotificationManager] FCM token error:', e);
        }
        return null;
    },
    
    // Check if there are pending celebration notifications from when the app was closed
    checkPendingCelebrations: async function() {
        try {
            // Check IndexedDB for pending check flag
            if ('indexedDB' in window) {
                const db = await this.openIndexedDB();
                const pending = await this.getFromIndexedDB(db, 'pendingCelebrationCheck');
                if (pending) {
                    console.log('[NotificationManager] Pending celebration check from background');
                    await this.setInIndexedDB(db, 'pendingCelebrationCheck', false);
                    // Trigger immediate check
                    setTimeout(() => this.checkForCelebrations(), 1000);
                }
            }
        } catch (e) {
            console.log('[NotificationManager] IndexedDB check error:', e);
        }
    },
    
    // IndexedDB helpers
    openIndexedDB: function() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open('AvantiNotifications', 1);
            request.onerror = () => reject(request.error);
            request.onsuccess = () => resolve(request.result);
            request.onupgradeneeded = (event) => {
                const db = event.target.result;
                if (!db.objectStoreNames.contains('data')) {
                    db.createObjectStore('data');
                }
            };
        });
    },
    
    getFromIndexedDB: function(db, key) {
        return new Promise((resolve, reject) => {
            const tx = db.transaction('data', 'readonly');
            const store = tx.objectStore('data');
            const request = store.get(key);
            request.onerror = () => reject(request.error);
            request.onsuccess = () => resolve(request.result);
        });
    },
    
    setInIndexedDB: function(db, key, value) {
        return new Promise((resolve, reject) => {
            const tx = db.transaction('data', 'readwrite');
            const store = tx.objectStore('data');
            const request = store.put(value, key);
            request.onerror = () => reject(request.error);
            request.onsuccess = () => resolve();
        });
    },
    
    // Schedule a celebration notification to be sent later (stored in Firestore for Cloud Function)
    scheduleCelebrationNotification: async function(type, personName, personId, scheduledTime) {
        if (typeof firebase === 'undefined') return;
        
        try {
            await firebase.firestore().collection('scheduled_notifications').add({
                type: type, // 'birthday' or 'anniversary'
                personName: personName,
                personId: personId,
                scheduledTime: scheduledTime,
                sent: false,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            console.log('[NotificationManager] Scheduled notification for:', personName, type);
        } catch (e) {
            console.error('[NotificationManager] Schedule error:', e);
        }
    },
    
    requestPermission: async function() {
        if (!('Notification' in window)) {
            alert('Your browser does not support notifications');
            return false;
        }
        
        try {
            const permission = await Notification.requestPermission();
            
            if (permission === 'granted') {
                await this.getFCMToken();
                this.renderNotifications();
                return true;
            } else {
                alert('Notifications blocked. Enable in browser settings.');
                return false;
            }
        } catch (e) {
            console.error('[NotificationManager] Permission error:', e);
            return false;
        }
    },
    
    getFCMToken: async function() {
        if (!this.messaging) return null;
        
        try {
            // Register service worker
            if ('serviceWorker' in navigator) {
                try {
                    await navigator.serviceWorker.register('/firebase-messaging-sw.js');
                } catch (e) {
                    console.log('[NotificationManager] SW error:', e.message);
                }
            }
            
            const token = await this.messaging.getToken({
                vapidKey: 'BAmI6KolDdphNCYs1yHd5UtWT80R4MQIO-5VVu5yvc2UfSBez-n5UAJ--MBQc_ZOAvzGOTJRWHQv2uyW2enLbEw' // Replace with your key
            });
            
            if (token) {
                this.fcmToken = token;
                await this.saveFCMToken(token);
                return token;
            }
        } catch (e) {
            console.error('[NotificationManager] Token error:', e);
        }
        return null;
    },
    
    saveFCMToken: async function(token) {
        if (!this.userId || typeof firebase === 'undefined') return;
        
        try {
            await firebase.firestore().collection('app_fcm_tokens').doc(String(this.userId)).set({
                token: token,
                userId: this.userId,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true });
            console.log('[NotificationManager] Token saved');
        } catch (e) {
            console.error('[NotificationManager] Save token error:', e);
        }
    },
    
    // ‚úÖ FIX: Optimized notifications - periodic fetch instead of realtime
    loadNotifications: function() {
        if (typeof firebase === 'undefined') return;
        
        const fetchNotifications = async () => {
            try {
                // Fetch global announcements
                const globalSnap = await firebase.firestore().collection('app_notifications')
                    .orderBy('createdAt', 'desc')
                    .limit(15)
                    .get();
                const globalNotifs = globalSnap.docs.map(d => ({ id: d.id, source: 'global', ...d.data() }));
                this.mergeNotifications(globalNotifs, 'global');
                
                // Fetch user-specific ticket notifications
                if (this.userId) {
                    try {
                        const ticketSnap = await firebase.firestore().collection('user_notifications')
                            .where('userId', '==', String(this.userId))
                            .orderBy('createdAt', 'desc')
                            .limit(15)
                            .get();
                        const ticketNotifs = ticketSnap.docs.map(d => ({ id: d.id, source: 'ticket', ...d.data() }));
                        this.mergeNotifications(ticketNotifs, 'ticket');
                    } catch (indexErr) {
                        // If index error, try without orderBy
                        console.log('[NotificationManager] Trying without orderBy:', indexErr.message);
                        const ticketSnap = await firebase.firestore().collection('user_notifications')
                            .where('userId', '==', String(this.userId))
                            .limit(15)
                            .get();
                        const ticketNotifs = ticketSnap.docs.map(d => ({ id: d.id, source: 'ticket', ...d.data() }));
                        this.mergeNotifications(ticketNotifs, 'ticket');
                    }
                }
                
            } catch (e) {
                console.log('[NotificationManager] Fetch error:', e);
            }
        };
        
        // Initial fetch
        fetchNotifications();
        
        // ‚úÖ COST FIX: Refresh every 3 minutes instead of 60 seconds (saves ~‚Çπ500/month)
        this.notificationInterval = setInterval(fetchNotifications, 180000);
        
        // Load today's birthday/anniversary notifications (one-time)
        this.loadCelebrationNotifications();
    },
    
    // Load birthday and anniversary notifications
    // ‚úÖ COST FIX: Cache celebration data to avoid repeated fetches
    loadCelebrationNotifications: async function() {
        try {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todayStr = today.toISOString().split('T')[0];
            
            // ‚úÖ COST FIX: Check if we already loaded celebrations today
            const cacheKey = 'celebrationCache_' + todayStr;
            try {
                const cached = localStorage.getItem(cacheKey);
                if (cached) {
                    const cachedData = JSON.parse(cached);
                    console.log('[NotificationManager] Using cached celebration data');
                    this.mergeNotifications(cachedData, 'celebration');
                    return;
                }
            } catch (e) {
                // localStorage might fail in private mode, continue without cache
            }
            
            const todayMonth = today.getMonth();
            const todayDate = today.getDate();
            
            console.log('[NotificationManager] Loading celebration notifications for', today.toDateString());
            
            // Load teachers (without problematic query - filter client-side)
            const teachersSnap = await firebase.firestore().collection('teachers').get();
            
            // Load managers
            const managersSnap = await firebase.firestore().collection('managers').get();
            
            // Load APCs
            const apcsSnap = await firebase.firestore().collection('apcs').get();
            
            const allMembers = [
                ...teachersSnap.docs.map(d => ({ id: d.id, ...d.data(), type: 'teacher' })),
                ...managersSnap.docs.map(d => ({ id: d.id, ...d.data(), type: 'manager' })),
                ...apcsSnap.docs.map(d => ({ id: d.id, ...d.data(), type: 'apc' }))
            ].filter(m => m.name && m.name.toLowerCase() !== 'vacant' && !m.isArchived && m.status !== 'inactive');
            
            console.log('[NotificationManager] Total members:', allMembers.length);
            console.log('[NotificationManager] Members with DOB:', allMembers.filter(m => m.dateOfBirth || m.dob).length);
            
            const celebrationNotifs = [];
            
            // Find today's birthdays
            allMembers.forEach(member => {
                const dobField = member.dateOfBirth || member.dob;
                if (dobField) {
                    const birthDate = new Date(dobField);
                    if (birthDate.getMonth() === todayMonth && birthDate.getDate() === todayDate) {
                        console.log('[NotificationManager] Found birthday:', member.name);
                        celebrationNotifs.push({
                            id: 'birthday_' + member.id + '_' + today.toDateString(),
                            source: 'celebration',
                            type: 'birthday',
                            title: 'üéÇ Birthday Today!',
                            message: member.name + ' celebrates their birthday today! Send them your wishes! üéà',
                            personName: member.name,
                            personPhoto: member.profilePhoto,
                            personType: member.type,
                            createdAt: { toDate: () => today }
                        });
                    }
                }
                
                // Find today's work anniversaries
                const joiningDate = member.joiningDate;
                if (joiningDate) {
                    const joinDate = new Date(joiningDate);
                    const years = today.getFullYear() - joinDate.getFullYear();
                    if (years > 0 && joinDate.getMonth() === todayMonth && joinDate.getDate() === todayDate) {
                        console.log('[NotificationManager] Found anniversary:', member.name, years, 'years');
                        celebrationNotifs.push({
                            id: 'anniversary_' + member.id + '_' + today.toDateString(),
                            source: 'celebration',
                            type: 'anniversary',
                            title: 'üéâ Work Anniversary!',
                            message: member.name + ' completes ' + years + ' year' + (years > 1 ? 's' : '') + ' at Avanti today! Congratulate them! üíê',
                            personName: member.name,
                            personPhoto: member.profilePhoto,
                            personType: member.type,
                            years: years,
                            createdAt: { toDate: () => today }
                        });
                    }
                }
            });
            
            // Also find upcoming birthdays (next 7 days) for notification bell
            allMembers.forEach(member => {
                const dobField = member.dateOfBirth || member.dob;
                if (dobField) {
                    const birthDate = new Date(dobField);
                    // Create this year's birthday
                    const thisYearBirthday = new Date(today.getFullYear(), birthDate.getMonth(), birthDate.getDate());
                    
                    // If birthday has passed this year, check next year
                    if (thisYearBirthday < today) {
                        thisYearBirthday.setFullYear(today.getFullYear() + 1);
                    }
                    
                    const daysUntil = Math.ceil((thisYearBirthday - today) / (1000 * 60 * 60 * 24));
                    
                    if (daysUntil > 0 && daysUntil <= 7) {
                        celebrationNotifs.push({
                            id: 'upcoming_birthday_' + member.id + '_' + today.toDateString(),
                            source: 'celebration',
                            type: 'upcoming_birthday',
                            title: 'üìÖ Upcoming Birthday',
                            message: member.name + "'s birthday is in " + daysUntil + ' day' + (daysUntil > 1 ? 's' : '') + '!',
                            personName: member.name,
                            personPhoto: member.profilePhoto,
                            daysUntil: daysUntil,
                            createdAt: { toDate: () => new Date(today.getTime() - daysUntil * 60000) } // Make upcoming ones appear lower
                        });
                    }
                }
            });
            
            // Also find upcoming work anniversaries (next 7 days)
            allMembers.forEach(member => {
                if (member.joiningDate) {
                    const joinDate = new Date(member.joiningDate);
                    if (joinDate.getFullYear() >= today.getFullYear()) return;
                    
                    const thisYearAnniv = new Date(today.getFullYear(), joinDate.getMonth(), joinDate.getDate());
                    if (thisYearAnniv < today) {
                        thisYearAnniv.setFullYear(today.getFullYear() + 1);
                    }
                    
                    const daysUntil = Math.ceil((thisYearAnniv - today) / (1000 * 60 * 60 * 24));
                    const years = today.getFullYear() - joinDate.getFullYear() + (thisYearAnniv.getFullYear() > today.getFullYear() ? 1 : 0);
                    
                    if (daysUntil > 0 && daysUntil <= 7) {
                        celebrationNotifs.push({
                            id: 'upcoming_anniversary_' + member.id + '_' + today.toDateString(),
                            source: 'celebration',
                            type: 'upcoming_anniversary',
                            title: 'üéâ Upcoming Anniversary',
                            message: member.name + "'s " + years + " year work anniversary is in " + daysUntil + ' day' + (daysUntil > 1 ? 's' : '') + '!',
                            personName: member.name,
                            personPhoto: member.profilePhoto,
                            daysUntil: daysUntil,
                            years: years,
                            createdAt: { toDate: () => new Date(today.getTime() - daysUntil * 60000) }
                        });
                    }
                }
            });
            
            console.log('[NotificationManager] Total celebration notifications:', celebrationNotifs.length);
            
            if (celebrationNotifs.length > 0) {
                // ‚úÖ COST FIX: Cache celebration data to avoid repeated fetches
                try {
                    const cacheKey = 'celebrationCache_' + today.toISOString().split('T')[0];
                    localStorage.setItem(cacheKey, JSON.stringify(celebrationNotifs));
                    console.log('[NotificationManager] Cached celebration data for today');
                    
                    // Clean up old cache entries
                    const yesterday = new Date(today);
                    yesterday.setDate(yesterday.getDate() - 1);
                    const oldCacheKey = 'celebrationCache_' + yesterday.toISOString().split('T')[0];
                    localStorage.removeItem(oldCacheKey);
                } catch (e) {
                    // localStorage might fail, ignore
                }
                
                this.mergeNotifications(celebrationNotifs, 'celebration');
            }
            
        } catch (e) {
            console.error('[NotificationManager] Celebration notifications error:', e);
        }
    },
    
    // Merge notifications from different sources
    mergeNotifications: function(newNotifs, source) {
        // Check if there are new notifications we haven't seen before
        const readIds = JSON.parse(localStorage.getItem('readNotifications') || '[]');
        const existingIds = this.notifications.map(n => n.id);
        const trulyNewNotifs = newNotifs.filter(n => !existingIds.includes(n.id) && !readIds.includes(n.id));
        
        // Play sound and show browser notification if there are new unread notifications
        if (trulyNewNotifs.length > 0 && this.notifications.length > 0) {
            this.playSound();
            
            // Show browser push notification for ticket replies
            trulyNewNotifs.forEach(notif => {
                if ((notif.source === 'ticket' || notif.type === 'ticket_update') && Notification.permission === 'granted') {
                    try {
                        new Notification('üé´ ' + (notif.title || 'New Reply'), {
                            body: notif.message || 'You have a new message on your ticket',
                            icon: 'Icon-192.png',
                            tag: 'ticket-' + (notif.ticketId || notif.id),
                            requireInteraction: true
                        });
                    } catch (e) {
                        console.log('[NotificationManager] Browser notification error:', e);
                    }
                }
            });
        }
        
        // Remove old notifications from same source
        this.notifications = this.notifications.filter(n => n.source !== source);
        
        // Add new notifications
        this.notifications = this.notifications.concat(newNotifs);
        
        // Sort by date (newest first)
        this.notifications.sort((a, b) => {
            const dateA = a.createdAt?.toDate?.() || new Date(0);
            const dateB = b.createdAt?.toDate?.() || new Date(0);
            return dateB - dateA;
        });
        
        // Keep only latest 20
        this.notifications = this.notifications.slice(0, 20);
        
        this.updateUnreadCount();
        this.renderNotifications();
    },
    
    updateUnreadCount: function() {
        const readIds = JSON.parse(localStorage.getItem('readNotifications') || '[]');
        this.unreadCount = this.notifications.filter(n => !readIds.includes(n.id)).length;
        
        const badge = document.getElementById('notificationBadge');
        if (badge) {
            badge.textContent = this.unreadCount;
            badge.classList.toggle('show', this.unreadCount > 0);
        }
        
        // Check if bell should auto-hide
        this.checkAutoHideBell();
    },
    
    renderNotifications: function() {
        const list = document.getElementById('notificationList');
        if (!list) return;
        
        const readIds = JSON.parse(localStorage.getItem('readNotifications') || '[]');
        const permissionBanner = Notification.permission !== 'granted' ? 
            '<div class="enable-notifications-banner"><span class="text">üîî Enable push notifications to get instant updates</span><button class="btn" onclick="NotificationManager.requestPermission()">Enable</button></div>' : '';
        
        if (this.notifications.length === 0) {
            list.innerHTML = permissionBanner + '<div class="notification-empty"><div class="icon">üì≠</div><p>No notifications yet</p></div>';
            return;
        }
        
        list.innerHTML = permissionBanner + this.notifications.map(n => {
            const isUnread = !readIds.includes(n.id);
            const time = n.createdAt?.toDate?.() || new Date();
            const timeAgo = this.timeAgo(time);
            const isTicket = n.source === 'ticket' || n.type === 'ticket_update';
            const isCelebration = n.source === 'celebration';
            
            // Choose icon based on type
            let icon = 'üì¢';
            if (isTicket) icon = 'üé´';
            else if (n.type === 'birthday') icon = 'üéÇ';
            else if (n.type === 'anniversary') icon = 'üéâ';
            else if (n.type === 'upcoming_birthday') icon = 'üìÖ';
            else if (n.type === 'upcoming_anniversary') icon = 'üéä';
            
            const ticketLabel = isTicket && n.ticketId ? '<span style="color: #F4B41A; font-size: 11px; margin-left: 6px;">#' + n.ticketId + '</span>' : '';
            
            // Priority indicator
            const priorityColors = { 'urgent': '#ef4444', 'important': '#f59e0b', 'normal': '#3b82f6' };
            let priorityStyle = n.priority && n.priority !== 'normal' ? 'border-left: 3px solid ' + (priorityColors[n.priority] || '#3b82f6') + ';' : '';
            
            // Special styling for celebrations
            let celebrationStyle = '';
            if (n.type === 'birthday') {
                celebrationStyle = 'border-left: 3px solid #ec4899; background: linear-gradient(135deg, #fdf2f8 0%, #fce7f3 100%);';
            } else if (n.type === 'anniversary') {
                celebrationStyle = 'border-left: 3px solid #f59e0b; background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);';
            } else if (n.type === 'upcoming_birthday') {
                celebrationStyle = 'border-left: 3px solid #8b5cf6; background: linear-gradient(135deg, #f5f3ff 0%, #ede9fe 100%);';
            } else if (n.type === 'upcoming_anniversary') {
                celebrationStyle = 'border-left: 3px solid #06b6d4; background: linear-gradient(135deg, #ecfeff 0%, #cffafe 100%);';
            }
            
            // Link button
            const linkBtn = n.link ? '<a href="' + n.link + '" target="_blank" style="display: inline-block; margin-top: 8px; background: #2a2a3a; color: #3b82f6; padding: 4px 10px; border-radius: 6px; font-size: 11px; text-decoration: none;">üîó Open Link</a>' : '';
            
            // Person photo for celebrations
            let personPhoto = '';
            if (isCelebration && n.personPhoto) {
                const borderColor = n.type === 'birthday' || n.type === 'upcoming_birthday' ? '#ec4899' : '#f59e0b';
                personPhoto = '<img src="' + n.personPhoto + '" alt="" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; margin-right: 10px; border: 2px solid ' + borderColor + ';" />';
            } else if (isCelebration) {
                const gradientColor = n.type === 'birthday' || n.type === 'upcoming_birthday' ? '#ec4899, #f472b6' : '#f59e0b, #fbbf24';
                personPhoto = '<div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, ' + gradientColor + '); display: flex; align-items: center; justify-content: center; font-size: 20px; margin-right: 10px;">' + icon + '</div>';
            }
            
            return `<div class="notification-item ${isUnread ? 'unread' : ''}" style="${celebrationStyle || priorityStyle}" onclick="NotificationManager.expandNotification('${n.id}')">
                <div style="display: flex; align-items: flex-start;">
                    ${personPhoto}
                    <div style="flex: 1;">
                        <div class="title">${!isCelebration ? icon + ' ' : ''}${n.title || 'Notification'}${ticketLabel}</div>
                        <div class="message">${n.message || ''}</div>
                        ${linkBtn}
                        <div class="time">${timeAgo}</div>
                    </div>
                </div>
            </div>`;
        }).join('');
    },
    
    timeAgo: function(date) {
        const seconds = Math.floor((new Date() - date) / 1000);
        if (seconds < 60) return 'Just now';
        if (seconds < 3600) return Math.floor(seconds / 60) + ' min ago';
        if (seconds < 86400) return Math.floor(seconds / 3600) + ' hours ago';
        return Math.floor(seconds / 86400) + ' days ago';
    },
    
    togglePanel: function() {
        this.isOpen ? this.closePanel() : this.openPanel();
    },
    
    openPanel: function() {
        document.getElementById('notificationPanel')?.classList.add('show');
        this.isOpen = true;
    },
    
    closePanel: function() {
        document.getElementById('notificationPanel')?.classList.remove('show');
        this.isOpen = false;
    },
    
    markRead: function(id) {
        const readIds = JSON.parse(localStorage.getItem('readNotifications') || '[]');
        if (!readIds.includes(id)) {
            readIds.push(id);
            localStorage.setItem('readNotifications', JSON.stringify(readIds));
            this.updateUnreadCount();
            this.renderNotifications();
            
            // Track view in Firestore for analytics
            this.trackNotificationView(id);
        }
    },
    
    // Track notification view for analytics
    trackNotificationView: async function(notificationId) {
        if (!this.userId || typeof firebase === 'undefined') return;
        
        try {
            const notifRef = firebase.firestore().collection('app_notifications').doc(notificationId);
            
            // Increment view count and add user to viewedBy array
            await notifRef.update({
                viewCount: firebase.firestore.FieldValue.increment(1),
                viewedBy: firebase.firestore.FieldValue.arrayUnion(String(this.userId))
            });
            
            console.log('[NotificationManager] View tracked for:', notificationId);
        } catch (e) {
            // Notification might not exist or be a ticket notification
            console.log('[NotificationManager] Could not track view:', e.message);
        }
    },
    
    markAllRead: function() {
        const readIds = this.notifications.map(n => n.id);
        localStorage.setItem('readNotifications', JSON.stringify(readIds));
        this.updateUnreadCount();
        this.renderNotifications();
        
        // Auto-hide bell if all read
        this.checkAutoHideBell();
    },
    
    // Check if bell should auto-hide when all read
    // NOTE: This ONLY affects the notification bell, NOT the chatbot (AvantiWidget)
    checkAutoHideBell: function() {
        const bell = document.getElementById('notificationBell');
        if (!bell) return;
        
        // Only hide the notification bell, never touch the chatbot
        // The chatbot (avantiBtn) should always remain visible
        if (this.unreadCount === 0) {
            bell.classList.add('all-read');
        } else {
            bell.classList.remove('all-read');
        }
        
        // Ensure chatbot button is ALWAYS visible (fix for disappearing chatbot bug)
        const chatbotBtn = document.getElementById('avantiBtn');
        if (chatbotBtn) {
            chatbotBtn.style.display = 'flex';
            chatbotBtn.style.opacity = '1';
            chatbotBtn.style.visibility = 'visible';
        }
    },
    
    // Expand notification to show full message
    expandNotification: function(id) {
        const notification = this.notifications.find(n => n.id === id);
        if (!notification) return;
        
        this.markRead(id);
        
        const isTicket = notification.source === 'ticket' || notification.type === 'ticket_update';
        const time = notification.createdAt?.toDate?.() || new Date();
        const ticketId = notification.ticketId || id;
        
        let popup = document.getElementById('notificationExpansionPopup');
        if (!popup) {
            popup = document.createElement('div');
            popup.id = 'notificationExpansionPopup';
            document.body.appendChild(popup);
        }
        
        const ticketContent = isTicket ? `
            <div class="notification-expansion-body">
                <div class="notification-expansion-message">${notification.message || 'No message content'}</div>
                <div class="notification-expansion-meta">
                    <span>${this.timeAgo(time)}</span>
                </div>
                
                <!-- Reply Input -->
                <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #2a2a3a;">
                    <div style="display: flex; gap: 8px; align-items: flex-end;">
                        <textarea 
                            id="ticketReplyInput" 
                            placeholder="Type your reply..." 
                            style="flex: 1; background: #1a1a24; border: 1px solid #3a3a4a; border-radius: 12px; padding: 12px; color: #fff; font-size: 14px; resize: none; min-height: 60px;"
                            rows="2"
                        ></textarea>
                    </div>
                </div>
            </div>
            <div class="notification-expansion-actions" style="flex-direction: column; gap: 8px;">
                <button class="notification-reply-btn" onclick="NotificationManager.sendTicketReply('${ticketId}')" style="width: 100%;">
                    üì§ Send Reply
                </button>
                <div style="display: flex; gap: 8px;">
                    <button class="notification-close-btn" onclick="NotificationManager.endTicketChat('${ticketId}')" style="flex: 1;">
                        ‚úì End Chat
                    </button>
                    <button class="notification-close-btn" onclick="NotificationManager.closeExpansion()" style="flex: 1;">
                        Close
                    </button>
                </div>
            </div>
        ` : `
            <div class="notification-expansion-body">
                <div class="notification-expansion-message">${notification.message || 'No message content'}</div>
                ${notification.link ? '<a href="' + notification.link + '" target="_blank" style="display: inline-block; background: #2a2a3a; color: #3b82f6; padding: 8px 16px; border-radius: 8px; text-decoration: none; margin-top: 12px;">üîó Open Link</a>' : ''}
                <div class="notification-expansion-meta">
                    ${notification.source ? '<span>Source: ' + notification.source + '</span> ‚Ä¢ ' : ''}
                    <span>${this.timeAgo(time)}</span>
                </div>
            </div>
            <div class="notification-expansion-actions">
                <button class="notification-close-btn" onclick="NotificationManager.closeExpansion()" style="flex: 1;">
                    Close
                </button>
            </div>
        `;
        
        popup.innerHTML = `
            <div class="notification-expansion-overlay" onclick="NotificationManager.closeExpansion()">
                <div class="notification-expansion-popup" onclick="event.stopPropagation()">
                    <div class="notification-expansion-header">
                        <h3>${isTicket ? 'üé´' : 'üì¢'} ${notification.title || 'Notification'}${notification.ticketId ? ' <span style="color:#F4B41A;font-size:13px;">#' + notification.ticketId + '</span>' : ''}</h3>
                        <button class="notification-expansion-close" onclick="NotificationManager.closeExpansion()">√ó</button>
                    </div>
                    ${ticketContent}
                </div>
            </div>
        `;
    },
    
    // Close expansion popup
    closeExpansion: function() {
        const popup = document.getElementById('notificationExpansionPopup');
        if (popup) popup.innerHTML = '';
    },
    
    // ‚úÖ FIX: Track sending state
    _isSendingReply: false,
    
    // Send reply to ticket directly from notification popup
    sendTicketReply: async function(ticketId) {
        // ‚úÖ FIX: Prevent duplicate submissions
        if (this._isSendingReply) {
            console.log('[NotificationManager] Already sending reply, ignoring duplicate click');
            return;
        }
        
        const replyInput = document.getElementById('ticketReplyInput');
        const replyText = replyInput?.value?.trim();
        const sendBtn = document.querySelector(`[onclick="NotificationManager.sendTicketReply('${ticketId}')"]`);
        
        if (!replyText) {
            alert('Please enter a reply message');
            return;
        }
        
        // ‚úÖ FIX: Set sending state and show loading
        this._isSendingReply = true;
        const originalBtnText = sendBtn?.innerHTML;
        if (sendBtn) {
            sendBtn.innerHTML = '<span class="sending-spinner"></span> Sending...';
            sendBtn.disabled = true;
            sendBtn.style.opacity = '0.7';
        }
        
        try {
            // Find the ticket doc
            const ticketSnap = await firebase.firestore().collection('support_tickets')
                .where('ticketId', '==', ticketId)
                .limit(1)
                .get();
            
            if (ticketSnap.empty) {
                alert('Ticket not found');
                return;
            }
            
            const ticketDoc = ticketSnap.docs[0];
            const ticketData = ticketDoc.data();
            
            // Add user reply
            const newReply = {
                message: replyText,
                sender: 'user',
                senderName: ticketData.userName || 'User',
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            await ticketDoc.ref.update({
                replies: firebase.firestore.FieldValue.arrayUnion(newReply),
                status: 'open', // Reopen if was closed
                lastUserReply: firebase.firestore.FieldValue.serverTimestamp(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            alert('‚úì Reply sent successfully!');
            this.closeExpansion();
            
        } catch (e) {
            console.error('Error sending reply:', e);
            alert('Failed to send reply. Please try again.');
        } finally {
            // ‚úÖ FIX: Always reset sending state
            this._isSendingReply = false;
            if (sendBtn) {
                sendBtn.innerHTML = originalBtnText || 'Send Reply';
                sendBtn.disabled = false;
                sendBtn.style.opacity = '1';
            }
        }
    },
    
    // Reply to a ticket (open chatbot)
    replyToTicket: function(ticketId) {
        this.closeExpansion();
        // Open the chatbot and navigate to the ticket
        if (typeof AvantiWidget !== 'undefined') {
            AvantiWidget.open();
            setTimeout(() => {
                if (AvantiWidget.loadTicket) AvantiWidget.loadTicket(ticketId);
            }, 300);
        } else {
            alert('Please open the Help/Support chat to reply to this ticket.');
        }
    },
    
    // End ticket chat (with option to reopen)
    endTicketChat: async function(ticketId) {
        const action = confirm('End this chat?\n\nClick OK to close the ticket.\nYou can reopen it later if needed.');
        if (!action) return;
        
        try {
            // Find the ticket doc
            const ticketSnap = await firebase.firestore().collection('support_tickets')
                .where('ticketId', '==', ticketId)
                .limit(1)
                .get();
            
            if (!ticketSnap.empty) {
                await ticketSnap.docs[0].ref.update({
                    status: 'closed',
                    closedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    closedBy: 'user',
                    canReopen: true
                });
                alert('‚úì Chat ended. You can reopen this ticket anytime by sending a new reply.');
            }
            this.closeExpansion();
        } catch (e) {
            console.error('Error closing ticket:', e);
            alert('Could not close the chat. Please try again.');
        }
    }
};

// Initialize when Firebase is ready
setTimeout(() => NotificationManager.init(), 1500);
</script>

<!-- PWA Sync Handler - Handles data sync when back online -->
<script>
// Listen for sync events from PWA Manager
window.addEventListener('syncAttendance', async (event) => {
  const data = event.detail;
  console.log('[Sync] Syncing attendance:', data);
  
  try {
    if (typeof firebase !== 'undefined' && firebase.firestore) {
      const docId = data.docId || `${data.school}_${data.grade}_${data.studentId}_${data.date}`;
      await firebase.firestore().collection('studentAttendance').doc(docId).set({
        school: data.school,
        grade: data.grade,
        studentId: data.studentId,
        studentName: data.studentName,
        date: data.date,
        status: data.status,
        remarks: data.remarks || '',
        markedBy: data.markedBy,
        markedAt: data.markedAt,
        syncedAt: new Date().toISOString(),
        wasOffline: true
      });
      console.log('[Sync] ‚úÖ Attendance synced:', docId);
    }
  } catch (error) {
    console.error('[Sync] ‚ùå Failed to sync attendance:', error);
  }
});

// Listen for curriculum sync
window.addEventListener('syncCurriculum', async (event) => {
  const data = event.detail;
  console.log('[Sync] Syncing curriculum:', data);
  
  try {
    if (typeof firebase !== 'undefined' && firebase.firestore) {
      await firebase.firestore().collection('curriculum_progress').add({
        ...data,
        syncedAt: new Date().toISOString(),
        wasOffline: true
      });
      console.log('[Sync] ‚úÖ Curriculum synced');
    }
  } catch (error) {
    console.error('[Sync] ‚ùå Failed to sync curriculum:', error);
  }
});

// Listen for feedback sync
window.addEventListener('syncFeedback', async (event) => {
  const data = event.detail;
  console.log('[Sync] Syncing feedback:', data);
  
  try {
    if (typeof firebase !== 'undefined' && firebase.firestore) {
      await firebase.firestore().collection('student_feedback').add({
        ...data,
        syncedAt: new Date().toISOString(),
        wasOffline: true
      });
      console.log('[Sync] ‚úÖ Feedback synced');
    }
  } catch (error) {
    console.error('[Sync] ‚ùå Failed to sync feedback:', error);
  }
});

console.log('[PWA] Sync handlers registered');
</script>
<!-- Add before closing </body> tag -->
<script src="/pwa-manager.js"></script>
<!-- PWA Install Prompt -->
<script>
let deferredPrompt;

window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  
  // Show install button
  const installBtn = document.getElementById('pwa-install-btn');
  if (installBtn) installBtn.style.display = 'flex';
  
  console.log('[PWA] Install prompt ready');
});

// Install function
window.installPWA = async function() {
  if (!deferredPrompt) {
    alert('App is already installed or not available for installation');
    return;
  }
  
  deferredPrompt.prompt();
  const { outcome } = await deferredPrompt.userChoice;
  console.log('[PWA] Install outcome:', outcome);
  deferredPrompt = null;
  
  const installBtn = document.getElementById('pwa-install-btn');
  if (installBtn) installBtn.style.display = 'none';
};

window.addEventListener('appinstalled', () => {
  console.log('[PWA] App installed!');
  deferredPrompt = null;
});
</script>
<script src="avanti-widget.js"></script>
</body>
</html>
