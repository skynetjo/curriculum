<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Curriculum Tracker - Avanti Fellows</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Updated: 2025-10-24 - Time Tracker Fix -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
  <style>
    :root{--avanti-yellow:#F4B41A;--avanti-orange:#E8B039;--avanti-red:#C8342E}
    *{box-sizing:border-box}
    @keyframes confetti-fall{0%{transform:translateY(-100vh) rotate(0) scale(1);opacity:1}100%{transform:translateY(100vh) rotate(720deg) scale(.5);opacity:0}}
    .confetti-piece{position:fixed;pointer-events:none;z-index:9999;animation:confetti-fall 4s cubic-bezier(.25,.46,.45,.94) forwards}
    .chapter-card{transition:all .3s ease;position:relative;overflow:hidden}
    .chapter-card:hover{transform:translateY(-4px);box-shadow:0 20px 40px -12px rgba(0,0,0,.2)}
    .chapter-card.completed{background:linear-gradient(135deg,#d1fae5,#a7f3d0);border:3px solid #10b981}
    .chapter-card.delayed{background:linear-gradient(135deg,#fed7aa,#fdba74);border:3px solid #f97316}
    .chapter-card.pending{background:linear-gradient(135deg,#fecaca,#fca5a5);border:3px solid #ef4444}
    input:focus,select:focus,textarea:focus{outline:none;box-shadow:0 0 0 4px rgba(244,180,26,.2);border-color:var(--avanti-yellow)}
    .avanti-gradient{background:linear-gradient(135deg,var(--avanti-yellow) 0%,var(--avanti-orange) 50%,var(--avanti-red) 100%)}
    .avanti-gradient-light{background:linear-gradient(135deg,rgba(244,180,26,.1) 0%,rgba(232,176,57,.1) 50%,rgba(200,52,46,.1) 100%)}
    .stat-card{background:white;border-radius:1rem;padding:1.5rem;box-shadow:0 4px 6px -1px rgba(0,0,0,.1);transition:all .3s}
    .stat-card:hover{transform:translateY(-4px);box-shadow:0 10px 15px -3px rgba(0,0,0,.1)}
    input[type="checkbox"]{appearance:none;width:20px;height:20px;border:2px solid var(--avanti-red);border-radius:4px;cursor:pointer;position:relative;flex-shrink:0}
    input[type="checkbox"]:checked{background:var(--avanti-red)}
    input[type="checkbox"]:checked::after{content:'‚úì';position:absolute;color:white;font-size:14px;top:50%;left:50%;transform:translate(-50%,-50%)}
    .birthday-card{background:linear-gradient(135deg,#FFD700,#FFA500);border:3px solid #FF6347;animation:pulse 2s infinite}
    @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
    .modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:9998}
    .modal-content{background:white;border-radius:1rem;padding:2rem;max-width:600px;width:90%;max-height:90vh;overflow-y:auto}
    .status-badge{padding:.5rem 1rem;border-radius:.5rem;font-weight:bold;text-align:center;font-size:.875rem}
    .status-ahead{background:#10b981;color:white}
    .status-ontrack{background:#3b82f6;color:white}
    .status-delayed{background:#f97316;color:white}
    .ranking-card{background:white;border-radius:1rem;padding:1.5rem;box-shadow:0 4px 6px rgba(0,0,0,.1)}
    .ranking-1{border-left:4px solid #fbbf24}
    .ranking-2{border-left:4px solid #c0c0c0}
    .ranking-3{border-left:4px solid #cd7f32}
    .chapter-details{position:relative;z-index:10;pointer-events:auto!important}
.chapter-details input,.chapter-details select,.chapter-details textarea,.chapter-details button,.chapter-details label{position:relative;z-index:20;pointer-events:auto!important;cursor:pointer}
.chapter-details input[type="checkbox"]{cursor:pointer}
.chapter-details select{cursor:pointer;background-color:white}
.chapter-details input[type="date"]{cursor:pointer;background-color:white}
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel" data-presets="react">
<script type="text/babel">
// Add these lines at the very top
setTimeout(function() {
  
const {useState,useEffect,useRef,useCallback,useMemo}=React;
const firebaseConfig={apiKey:"AIzaSyDyyGAHNJvhuint86USW36eBJKfw_u3AcA",...};
// ... rest of your code
  
}, 100); // Wait 100ms for libraries to load
</script>
const {useState,useEffect,useRef,useCallback,useMemo}=React;
const firebaseConfig={apiKey:"AIzaSyDyyGAHNJvhuint86USW36eBJKfw_u3AcA",authDomain:"curriculum-dbb10.firebaseapp.com",projectId:"curriculum-dbb10",storageBucket:"curriculum-dbb10.firebasestorage.app",messagingSenderId:"706387632109",appId:"1:706387632109:web:06c78a304fdbdc12f391e4"};
if(!firebase.apps.length){firebase.initializeApp(firebaseConfig)}
const db=firebase.firestore();
const auth=firebase.auth();
const SUBJECTS=['Physics','Chemistry','Maths','Biology'];
const SCHOOLS=['CoE Barwani','CoE Cuttak','CoE Bundi','CoE Mahisagar','EMRS Bhopal','JNV Bharuch'];
const LEAVE_REASONS=['Present','Personal Leave','Sick Leave','Weekly Off','Public Holiday','Organization Holiday','School Holiday','Emergency Leave'];
const GENDERS=['Male','Female','Other'];
const DEFAULT_JOBS=['Teaching','Meetings','Centre Visit','Curriculum Planning','Assessment','Documentation','Training','Student Support'];
const DEFAULT_SUBJOBS={
  'Teaching':['Class 11 Physics','Class 11 Chemistry','Class 11 Maths','Class 11 Biology','Class 12 Physics','Class 12 Chemistry','Class 12 Maths','Class 12 Biology'],
  'Meetings':['Team Meeting','Parent Meeting','Admin Meeting','One-on-One','Planning Meeting'],
  'Centre Visit':['CoE Barwani','CoE Cuttak','CoE Bundi','CoE Mahisagar','EMRS Bhopal','JNV Bharuch'],
  'Curriculum Planning':['Lesson Planning','Content Development','Resource Creation','Assessment Design'],
  'Assessment':['Test Creation','Paper Checking','Result Analysis','Feedback Session'],
  'Documentation':['Reports','Data Entry','Progress Tracking','Attendance Records'],
  'Training':['Professional Development','Skill Building','Workshop','Orientation'],
  'Student Support':['Doubt Clearing','Counseling','Remedial Teaching','Mentoring']
};  
const AVANTI_LOGO = '/uploads/Avanti_Fellows-logo.png';
const exportToExcel=(data,filename)=>{const ws=XLSX.utils.json_to_sheet(data);const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,"Data");XLSX.writeFile(wb,`${filename}_${new Date().toISOString().slice(0,10)}.xlsx`)};
const getBirthdays=(teachers,period='week')=>{const now=new Date();return teachers.filter(t=>{if(!t.dob)return false;const d=new Date(t.dob);const thisYear=new Date(now.getFullYear(),d.getMonth(),d.getDate());const diff=Math.ceil((thisYear-now)/(1000*60*60*24));if(period==='today'){return d.getDate()===now.getDate()&&d.getMonth()===now.getMonth()}else if(period==='week'){return diff>=0&&diff<=7}else if(period==='month'){return d.getMonth()===now.getMonth()}return false})};
const getAnniversaries=(teachers,period='week')=>{const now=new Date();return teachers.filter(t=>{if(!t.joiningDate)return false;const j=new Date(t.joiningDate);if(j.getFullYear()>=now.getFullYear())return false;const thisYear=new Date(now.getFullYear(),j.getMonth(),j.getDate());const diff=Math.ceil((thisYear-now)/(1000*60*60*24));if(period==='today'){return j.getDate()===now.getDate()&&j.getMonth()===now.getMonth()}else if(period==='week'){return diff>=0&&diff<=7}else if(period==='month'){return j.getMonth()===now.getMonth()}return false})};
const getTodayDate=()=>{
const today=new Date();
  return today.toISOString().split('T')[0];
};

const getMonthYear=(date)=>{
  const d=new Date(date);
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
};

const getAttendanceStats=(attendanceRecords,filterDate=null)=>{
  if(filterDate){
    const filtered=attendanceRecords.filter(r=>r.date===filterDate);
    const present=filtered.filter(r=>r.status==='Present').length;
    return{total:filtered.length,present,absent:filtered.length-present};
  }
  const present=attendanceRecords.filter(r=>r.status==='Present').length;
  return{total:attendanceRecords.length,present,absent:attendanceRecords.length-present};
};

const getMonthlyAttendanceStats=(attendanceRecords,month)=>{
  const filtered=attendanceRecords.filter(r=>getMonthYear(r.date)===month);
  const dayStats={};
  filtered.forEach(record=>{
    if(!dayStats[record.date]){
      dayStats[record.date]={present:0,absent:0};
    }
    if(record.status==='Present'){
      dayStats[record.date].present++;
    }else{
      dayStats[record.date].absent++;
    }
  });
  return dayStats;
};
const getChapterStatus=(chapter,progress)=>{if(!chapter.targetDate){return{label:'No Target',color:'pending',class:'status-delayed'}}const targetDate=new Date(chapter.targetDate);const today=new Date();const completionDate=progress.completionDate?new Date(progress.completionDate):null;if(progress.completed==='Yes'&&progress.testConducted==='Yes'){if(completionDate){if(completionDate<targetDate){return{label:'Ahead - Good Job! üéâ',color:'completed',class:'status-ahead'}}else if(completionDate.toDateString()===targetDate.toDateString()){return{label:'On Track ‚úì',color:'completed',class:'status-ontrack'}}else{return{label:'Completed (Late)',color:'delayed',class:'status-delayed'}}}return{label:'Completed ‚úì',color:'completed',class:'status-ahead'}}if(today>targetDate){return{label:'Delayed ‚ö†Ô∏è',color:'delayed',class:'status-delayed'}}return{label:'Pending',color:'pending',class:'status-delayed'}};

function App(){const[currentUser,setCurrentUser]=useState(null);const[isAdmin,setIsAdmin]=useState(false);const[activeTab,setActiveTab]=useState('overview');const[loginForm,setLoginForm]=useState({email:'',password:''});const[loading,setLoading]=useState(true);const[authLoading,setAuthLoading]=useState(false);const[teachers,setTeachers]=useState([]);const[curriculum,setCurriculum]=useState({});const[chapterProgress,setChapterProgress]=useState({});const[students,setStudents]=useState([]);
const[studentAttendance,setStudentAttendance]=useState([]);
const[teacherAttendance,setTeacherAttendance]=useState([]);const[showConfetti,setShowConfetti]=useState(false);const[celebrationMessage,setCelebrationMessage]=useState('');
const[timeEntries,setTimeEntries]=useState([]);
const[jobSettings,setJobSettings]=useState({jobs:DEFAULT_JOBS,subjobs:DEFAULT_SUBJOBS});
useEffect(()=>{const unsubscribe=auth.onAuthStateChanged(async(user)=>{if(user){if(user.email==='admin@avantifellows.org'){setIsAdmin(true);setCurrentUser({name:'Administrator',email:user.email,afid:'ADMIN',school:'Admin'});setActiveTab('teachers')}else{const teacherSnapshot=await db.collection('teachers').where('email','==',user.email).limit(1).get();if(!teacherSnapshot.empty){const teacherData=teacherSnapshot.docs[0].data();setCurrentUser(teacherData);setIsAdmin(false);setActiveTab('overview');if(teacherData.dob){const d=new Date(teacherData.dob);const now=new Date();if(d.getMonth()===now.getMonth()&&d.getDate()===now.getDate()){setShowConfetti(true);setCelebrationMessage(`üéÇ Happy Birthday, ${teacherData.name}!`);setTimeout(()=>{setShowConfetti(false);setCelebrationMessage('')},8000)}}if(teacherData.joiningDate){const j=new Date(teacherData.joiningDate);const now=new Date();if(j.getMonth()===now.getMonth()&&j.getDate()===now.getDate()&&j.getFullYear()<now.getFullYear()){const years=now.getFullYear()-j.getFullYear();setShowConfetti(true);setCelebrationMessage(`üéâ Happy ${years} Year Work Anniversary, ${teacherData.name}!`);setTimeout(()=>{setShowConfetti(false);setCelebrationMessage('')},8000)}}}else{alert('Teacher profile not found. Please contact admin.');await auth.signOut()}}}else{setCurrentUser(null);setIsAdmin(false)}setLoading(false)});return()=>unsubscribe()},[]);
useEffect(() => {
  const unsubProgress = db.collection('chapterProgress').onSnapshot(snap => {
    const map = {};
    snap.docs.forEach(d => map[d.id] = d.data());
    setChapterProgress(map);
  });

  const unsubTeachers = db.collection('teachers').onSnapshot(snap => {
    setTeachers(snap.docs.map(d => ({ ...d.data(), id: d.id })));
  });

  const unsubCurriculum = db.collection('curriculum').onSnapshot(snap => {
    const currMap = {};
    snap.docs.forEach(doc => { currMap[doc.id] = doc.data() });
    setCurriculum(currMap);
  });

  // ‚úÖ Add these 3 new subscriptions here:

  const unsubStudents = db.collection('students').onSnapshot(snap => {
    setStudents(snap.docs.map(d => ({ ...d.data(), id: d.id })));
  });

  const unsubStudentAttendance = db.collection('studentAttendance').onSnapshot(snap => {
    setStudentAttendance(snap.docs.map(d => ({ ...d.data(), id: d.id })));
  });

  const unsubTeacherAttendance = db.collection('teacherAttendance').onSnapshot(snap => {
    setTeacherAttendance(snap.docs.map(d => ({ ...d.data(), id: d.id })));
  });
  const unsubTimeEntries = db.collection('timeEntries').onSnapshot(snap => {
    setTimeEntries(snap.docs.map(d => ({ ...d.data(), id: d.id })));
  });

  const unsubJobSettings = db.collection('settings').doc('jobSettings').onSnapshot(doc => {
    if(doc.exists){
      setJobSettings(doc.data());
    }else{
      setJobSettings({jobs:DEFAULT_JOBS,subjobs:DEFAULT_SUBJOBS});
    }
  });

  return () => {
    unsubProgress();
    unsubTeachers();
    unsubCurriculum();
    // ‚úÖ Cleanup the new ones too
    unsubStudents();
    unsubStudentAttendance();
    unsubTeacherAttendance();
    unsubTimeEntries();
    unsubJobSettings();
  };
}, []);
const handleLogin=async()=>{setAuthLoading(true);try{const email=(loginForm.email||'').trim().toLowerCase();const password=loginForm.password;if(!email||!password){alert('Please enter email and password');setAuthLoading(false);return}await auth.signInWithEmailAndPassword(email,password)}catch(e){console.error('login error',e);alert('Login failed: '+e.message)}setAuthLoading(false)};
const handleLogout=async()=>{try{await auth.signOut();setActiveTab('overview')}catch(e){console.error('logout error',e)}};
const updateChapterProgress=useCallback(async(school,chapterId,field,value)=>{try{const docId=`${school}_${chapterId}`;await db.collection('chapterProgress').doc(docId).set({[field]:value},{merge:true});if(field==='completed'&&value==='Yes'){const testStatus=chapterProgress[docId]?.testConducted;if(testStatus==='Yes'){setShowConfetti(true);setCelebrationMessage('üéâ Chapter Completed Successfully!');setTimeout(()=>{setShowConfetti(false);setCelebrationMessage('')},5000)}}}catch(e){console.error('Update error',e);alert('Failed to update: '+e.message)}},[chapterProgress]);
const addChapter=async(school,subject,grade,chapter)=>{try{const docId=`${school}_${subject}_${grade}`;const doc=await db.collection('curriculum').doc(docId).get();const existing=doc.exists?(doc.data().chapters||[]):[];chapter.id=`${subject.charAt(0)}${grade}-${existing.length+1}-${Date.now().toString().slice(-4)}`;const updated=[...existing,chapter];await db.collection('curriculum').doc(docId).set({chapters:updated});alert('Chapter added successfully!')}catch(e){console.error('Add error',e);alert('Failed to add: '+e.message)}};
const updateChapter=async(school,subject,grade,chapterId,updates)=>{try{const docId=`${school}_${subject}_${grade}`;const doc=await db.collection('curriculum').doc(docId).get();const existing=doc.exists?(doc.data().chapters||[]):[];const index=existing.findIndex(ch=>ch.id===chapterId);if(index===-1){alert('Chapter not found');return}existing[index]={...existing[index],...updates};await db.collection('curriculum').doc(docId).set({chapters:existing});alert('Chapter updated successfully!')}catch(e){console.error('Update error',e);alert('Failed to update: '+e.message)}};
const deleteChapter=async(school,subject,grade,chapterId)=>{if(!confirm('Delete this chapter?'))return;try{const docId=`${school}_${subject}_${grade}`;const doc=await db.collection('curriculum').doc(docId).get();const existing=doc.exists?(doc.data().chapters||[]):[];const updated=existing.filter(ch=>ch.id!==chapterId);await db.collection('curriculum').doc(docId).set({chapters:updated});alert('Chapter deleted successfully')}catch(e){console.error('Delete error',e);alert('Failed to delete: '+e.message)}};
function Confetti(){const shapes=['‚óè','‚ñ†','‚ñ≤','‚òÖ','‚ô¶','‚ô•','‚ú¶','‚úß'];const colors=['#F4B41A','#E8B039','#C8342E','#FFA07A','#98D8C8','#F7DC6F'];return(<div className="fixed inset-0 pointer-events-none z-[9999]">{Array.from({length:60}).map((_,i)=>{const shape=shapes[Math.floor(Math.random()*shapes.length)];const color=colors[Math.floor(Math.random()*colors.length)];const size=12+Math.random()*20;const left=Math.random()*100;const delay=Math.random()*2;return(<div key={i} className="confetti-piece" style={{left:`${left}%`,top:'-50px',color:color,fontSize:`${size}px`,animationDelay:`${delay}s`}}>{shape}</div>)})}</div>)}
if(loading){return(<div className="min-h-screen avanti-gradient flex items-center justify-center"><div className="text-center"><img src={AVANTI_LOGO} alt="Avanti Fellows" className="w-20 h-20 mx-auto mb-4 animate-bounce"/><div className="text-white text-2xl font-bold">Loading...</div></div></div>)}
if(!currentUser){return(<div className="min-h-screen avanti-gradient flex items-center justify-center p-4"><div className="bg-white rounded-3xl shadow-2xl p-10 w-full max-w-md"><div className="text-center mb-8"><img src={AVANTI_LOGO} alt="Avanti Fellows" className="w-20 h-20 mx-auto mb-4"/><h1 className="text-4xl font-bold text-gray-800 mb-2">Curriculum Tracker</h1><p className="text-gray-600 mt-3">Avanti Fellows</p></div><div className="space-y-5"><input type="email" className="w-full px-5 py-4 border-2 border-gray-300 rounded-xl text-lg" value={loginForm.email} onChange={e=>setLoginForm({...loginForm,email:e.target.value})} placeholder="Email"/><input type="password" className="w-full px-5 py-4 border-2 border-gray-300 rounded-xl text-lg" value={loginForm.password} onChange={e=>setLoginForm({...loginForm,password:e.target.value})} placeholder="Password" onKeyPress={e=>e.key==='Enter'&&handleLogin()}/><button onClick={handleLogin} disabled={authLoading} className="w-full avanti-gradient text-white py-4 rounded-xl font-bold text-lg disabled:opacity-50">{authLoading?'Logging in...':'Login'}</button></div></div></div>)}

return isAdmin?<AdminView currentUser={currentUser} handleLogout={handleLogout} teachers={teachers} students={students} curriculum={curriculum} chapterProgress={chapterProgress} studentAttendance={studentAttendance} teacherAttendance={teacherAttendance} timeEntries={timeEntries} jobSettings={jobSettings} addChapter={addChapter} updateChapter={updateChapter} deleteChapter={deleteChapter}/>:<TeacherView currentUser={currentUser} handleLogout={handleLogout} showConfetti={showConfetti} Confetti={Confetti} celebrationMessage={celebrationMessage} teachers={teachers} students={students} curriculum={curriculum} chapterProgress={chapterProgress} studentAttendance={studentAttendance} teacherAttendance={teacherAttendance} timeEntries={timeEntries} jobSettings={jobSettings} updateChapterProgress={updateChapterProgress} activeTab={activeTab} setActiveTab={setActiveTab}/>;
}

function TeacherView({currentUser,handleLogout,showConfetti,Confetti,celebrationMessage,teachers,students,curriculum,chapterProgress,studentAttendance,teacherAttendance,updateChapterProgress,activeTab,setActiveTab,timeEntries,jobSettings}){return(<div className="min-h-screen bg-gray-50 flex flex-col">{showConfetti&&<Confetti/>}<nav className="avanti-gradient shadow-lg sticky top-0 z-50"><div className="max-w-7xl mx-auto px-4 py-4"><div className="flex justify-between items-center"><div className="flex items-center gap-3"><img src={AVANTI_LOGO} alt="Avanti" className="w-12 h-12"/><div><h1 className="text-2xl font-bold text-white">Curriculum Tracker</h1><p className="text-sm text-white opacity-90">Avanti Fellows</p></div></div><div className="flex items-center gap-4"><div className="text-right hidden sm:block"><p className="text-white font-semibold">{currentUser.name}</p><p className="text-sm text-white opacity-90">{currentUser.school}</p></div><button onClick={handleLogout} className="px-4 py-2 bg-white text-gray-800 rounded-xl font-semibold">Logout</button></div></div></div></nav>{celebrationMessage&&<div className="avanti-gradient text-white text-center py-4 text-xl font-bold">{celebrationMessage}</div>}<div className="flex-1 max-w-7xl mx-auto px-4 py-6 w-full"><div className="flex gap-3 mb-6 overflow-x-auto pb-2">
  {['overview','analytics','class11','class12','attendance','attendancedash','myattendance','birthdays','timetracker','timeanalytics'].map(tab=><button key={tab} onClick={()=>setActiveTab(tab)} className={`px-6 py-3 rounded-xl font-semibold whitespace-nowrap ${activeTab===tab?'avanti-gradient text-white':'bg-white'}`}>
      {tab==='overview'&&'üìä Overview'}
      {tab==='analytics'&&'üìà Analytics'}
      {tab==='class11'&&'üìö Class 11'}
      {tab==='class12'&&'üìñ Class 12'}
      {tab==='attendance'&&'‚úÖ Mark Attendance'}
      {tab==='attendancedash'&&'üìä Attendance Dashboard'}
      {tab==='myattendance'&&'üë§ My Attendance'}
      {tab==='birthdays'&&'üéÇ Celebrations'}
      {tab==='timetracker'&&'‚è±Ô∏è Time Tracker'}
      {tab==='timeanalytics'&&'üìä Time Analytics'}
    </button>
  )}
</div>
  {activeTab==='overview'&&<TeacherOverview currentUser={currentUser} curriculum={curriculum} chapterProgress={chapterProgress} teachers={teachers} teacherAttendance={teacherAttendance} studentAttendance={studentAttendance}/>}{activeTab==='analytics'&&<TeacherAnalytics currentUser={currentUser} curriculum={curriculum} chapterProgress={chapterProgress}/>}{activeTab==='class11'&&<TeacherCurriculum grade="11" currentUser={currentUser} curriculum={curriculum} chapterProgress={chapterProgress} updateChapterProgress={updateChapterProgress}/>}{activeTab==='class12'&&<TeacherCurriculum grade="12" currentUser={currentUser} curriculum={curriculum} chapterProgress={chapterProgress} updateChapterProgress={updateChapterProgress}/>}{activeTab==='birthdays'&&<BirthdaysPage teachers={teachers} currentUser={currentUser}/>}{activeTab==='attendance'&&<StudentAttendanceView currentUser={currentUser} students={students} studentAttendance={studentAttendance}/>}
{activeTab==='attendancedash'&&<TeacherAttendanceDashboard currentUser={currentUser} students={students} teachers={teachers} studentAttendance={studentAttendance} teacherAttendance={teacherAttendance}/>}
{activeTab==='myattendance'&&<TeacherAttendanceView currentUser={currentUser} teacherAttendance={teacherAttendance}/>}
{activeTab==='timetracker'&&<TimeTrackerView currentUser={currentUser} timeEntries={timeEntries} jobSettings={jobSettings}/>}
{activeTab==='timeanalytics'&&<TimeAnalyticsView currentUser={currentUser} timeEntries={timeEntries} teachers={teachers}/>}</div><footer className="bg-gray-800 text-white text-center py-4 mt-auto"><p>Made by Anand with ‚ù§Ô∏è</p></footer></div>)}

function AdminView({currentUser,handleLogout,teachers,students,curriculum,chapterProgress,studentAttendance,teacherAttendance,timeEntries,jobSettings,addChapter,updateChapter,deleteChapter}){const[activeTab,setActiveTab]=useState('teachers');return(<div className="min-h-screen bg-gray-50 flex flex-col"><nav className="avanti-gradient shadow-lg sticky top-0 z-50"><div className="max-w-7xl mx-auto px-4 py-4"><div className="flex justify-between items-center"><div className="flex items-center gap-3"><img src={AVANTI_LOGO} alt="Avanti" className="w-12 h-12"/><h1 className="text-2xl font-bold text-white">Admin Dashboard</h1></div><button onClick={handleLogout} className="px-4 py-2 bg-white text-gray-800 rounded-xl font-semibold">Logout</button></div></div></nav><div className="flex-1 max-w-7xl mx-auto px-4 py-6 w-full"><div className="flex gap-3 mb-6 overflow-x-auto pb-2">
  {['teachers','students','curriculum','analytics','chapter-details','attendance','birthdays','timetracker','jobsettings'].map(tab=>
    <button key={tab} onClick={()=>setActiveTab(tab)} className={`px-6 py-3 rounded-xl font-semibold whitespace-nowrap ${activeTab===tab?'avanti-gradient text-white':'bg-white'}`}>
      {tab==='teachers'&&'üë• Teachers'}
      {tab==='students'&&'üë®‚Äçüéì Students'}
      {tab==='curriculum'&&'üìö Curriculum'}
      {tab==='analytics'&&'üìä Analytics'}
      {tab==='chapter-details'&&'üìã Chapter Details'}
      {tab==='attendance'&&'üìä Attendance Analytics'}
      {tab==='birthdays'&&'üéÇ Celebrations'}
      {tab==='timetracker'&&'‚è±Ô∏è Time Tracker Analytics'}
      {tab==='jobsettings'&&'‚öôÔ∏è Job Settings'}
    </button>
  )}
</div>{activeTab==='teachers'&&<TeacherManagement teachers={teachers}/>}{activeTab==='curriculum'&&<AdminCurriculum curriculum={curriculum} addChapter={addChapter} updateChapter={updateChapter} deleteChapter={deleteChapter}/>}{activeTab==='analytics'&&<AdminAnalytics teachers={teachers} curriculum={curriculum} chapterProgress={chapterProgress}/>}{activeTab==='chapter-details'&&<AdminChapterDetails curriculum={curriculum} chapterProgress={chapterProgress} teachers={teachers}/>}{activeTab==='birthdays'&&<AdminBirthdays teachers={teachers}/>}{activeTab==='students'&&<StudentManagement students={students}/>}
{activeTab==='attendance'&&<AdminAttendanceAnalytics students={students} teachers={teachers} studentAttendance={studentAttendance} teacherAttendance={teacherAttendance}/>}
{activeTab==='timetracker'&&<AdminTimeTrackerAnalytics teachers={teachers} timeEntries={timeEntries}/>}
{activeTab==='jobsettings'&&<JobSettingsManagement jobSettings={jobSettings}/>}</div><footer className="bg-gray-800 text-white text-center py-4 mt-auto"><p>Made by Anand with ‚ù§Ô∏è</p></footer></div>)}
function TeacherOverview({currentUser,curriculum,chapterProgress,teachers,teacherAttendance,studentAttendance}){const mySchool=currentUser.school;const mySubject=currentUser.subject;const schoolRankings=useMemo(()=>{const rankings=SCHOOLS.map(school=>{let total=0,completed=0;SUBJECTS.forEach(subject=>{['11','12'].forEach(grade=>{const docId=`${school}_${subject}_${grade}`;const chapters=curriculum[docId]?.chapters||[];chapters.forEach(ch=>{total++;const progressId=`${school}_${ch.id}`;const prog=chapterProgress[progressId]||{};if(prog.completed==='Yes'&&prog.testConducted==='Yes'){completed++}})})});return{school,total,completed,percentage:total?Math.round((completed/total)*100):0}});rankings.sort((a,b)=>b.percentage-a.percentage);return rankings},[curriculum,chapterProgress]);const subjectRankings=useMemo(()=>{
  const rankings=SUBJECTS.map(subject=>{
    let total=0,completed=0;
    ['11','12'].forEach(grade=>{
      const docId=`${mySchool}_${subject}_${grade}`;
      const chapters=curriculum[docId]?.chapters||[];
      chapters.forEach(ch=>{
        total++;
        const progressId=`${mySchool}_${ch.id}`;
        const prog=chapterProgress[progressId]||{};
        if(prog.completed==='Yes'&&prog.testConducted==='Yes'){
          completed++
        }
      })
    });
    return{subject,total,completed,percentage:total?Math.round((completed/total)*100):0}
  })
  .filter(rank=>rank.total>0); // ‚≠ê ADD THIS LINE - Filter out subjects with no chapters

  rankings.sort((a,b)=>b.percentage-a.percentage);
  return rankings
},[curriculum,chapterProgress,mySchool]);const mySchoolRank=schoolRankings.findIndex(r=>r.school===mySchool)+1;const laggingSubject=subjectRankings[subjectRankings.length-1];return(<div className="space-y-6"><h2 className="text-3xl font-bold">Dashboard Overview</h2><div className="grid md:grid-cols-4 gap-4"><div className="stat-card avanti-gradient text-white"><div className="text-sm opacity-90">Your School Rank</div><div className="text-5xl font-bold">#{mySchoolRank}</div><div className="text-sm mt-2">Out of {SCHOOLS.length} schools</div></div><div className="stat-card bg-gradient-to-br from-green-500 to-emerald-600 text-white"><div className="text-sm opacity-90">Best Performing School</div><div className="text-2xl font-bold mt-2">{schoolRankings[0]?.school}</div><div className="text-sm mt-2">{schoolRankings[0]?.percentage}% completed</div></div><div className="stat-card bg-gradient-to-br from-orange-500 to-red-600 text-white"><div className="text-sm opacity-90">Lagging Subject (Your School)</div><div className="text-2xl font-bold mt-2">{laggingSubject?.subject}</div><div className="text-sm mt-2">{laggingSubject?.percentage}% completed</div></div></div><div className="bg-white p-6 rounded-2xl shadow-lg"><h3 className="text-2xl font-bold mb-4">üèÜ School Rankings</h3><div className="space-y-3">{schoolRankings.map((rank,index)=><div key={rank.school} className={`ranking-card ${index===0?'ranking-1':index===1?'ranking-2':index===2?'ranking-3':''} ${rank.school===mySchool?'bg-yellow-50':''}`}><div className="flex justify-between items-center"><div className="flex items-center gap-4"><div className="text-2xl font-bold text-gray-400">#{index+1}</div><div><div className="font-bold text-lg">{rank.school} {rank.school===mySchool&&'‚≠ê'}</div><div className="text-sm text-gray-600">{rank.completed} / {rank.total} chapters completed</div></div></div><div className="text-3xl font-bold" style={{color:'var(--avanti-red)'}}>{rank.percentage}%</div></div></div>)}</div></div><div className="bg-white p-6 rounded-2xl shadow-lg"><h3 className="text-2xl font-bold mb-4">üìö Subject Performance in {mySchool}</h3><div className="grid md:grid-cols-2 gap-4">{subjectRankings.map(rank=><div key={rank.subject} className="border-2 rounded-xl p-4"><div className="flex justify-between items-center mb-2"><div className="font-bold text-lg">{rank.subject}</div><div className="text-2xl font-bold" style={{color:'var(--avanti-red)'}}>{rank.percentage}%</div></div><div className="h-2 bg-gray-200 rounded-full"><div className="h-2 avanti-gradient rounded-full" style={{width:`${rank.percentage}%`}}/></div><div className="text-sm text-gray-600 mt-2">{rank.completed} / {rank.total} chapters</div></div>)}</div></div><div className="stat-card bg-gradient-to-br from-purple-500 to-pink-600 text-white">
  <div className="text-sm opacity-90">My Attendance (This Month)</div>
  <div className="text-2xl font-bold mt-2">
    {teacherAttendance.filter(a=>a.teacherId===currentUser.afid&&getMonthYear(a.date)===getMonthYear(getTodayDate())).length} days
  </div>
  <div className="text-sm mt-2">Marked this month</div>
  <div className="bg-white p-6 rounded-2xl shadow-lg">
  <h3 className="text-2xl font-bold mb-4">üìä Quick Attendance Overview</h3>
  <div className="grid md:grid-cols-2 gap-4">
    <div className="border-2 rounded-xl p-4">
      <h4 className="font-bold mb-2">Today's Student Attendance</h4>
      <p className="text-sm text-gray-600">
        Present: <strong className="text-green-600">
          {studentAttendance.filter(a=>a.date===getTodayDate()&&a.school===currentUser.school&&a.status==='Present').length}
        </strong>
      </p>
      <p className="text-sm text-gray-600">
        Absent: <strong className="text-red-600">
          {studentAttendance.filter(a=>a.date===getTodayDate()&&a.school===currentUser.school&&a.status==='Absent').length}
        </strong>
      </p>
    </div>
    <div className="border-2 rounded-xl p-4">
      <h4 className="font-bold mb-2">My Attendance Status</h4>
      {teacherAttendance.find(a=>a.teacherId===currentUser.afid&&a.date===getTodayDate())?
        <div className="text-sm">
          <p className="text-green-600 font-bold">‚úì Marked for today</p>
          <p className="text-gray-600">
            Status: {teacherAttendance.find(a=>a.teacherId===currentUser.afid&&a.date===getTodayDate()).status}
          </p>
        </div>
      :
        <p className="text-orange-600 font-bold">‚ö†Ô∏è Not marked yet</p>
      }
    </div>
  </div>
</div>
</div></div>)}
function TeacherAnalytics({currentUser,curriculum,chapterProgress}){const chartRef=useRef(null);const chartInstance=useRef(null);const mySchool=currentUser.school;const mySubject=currentUser.subject;const analyticsData=useMemo(()=>{const data={11:{total:0,completed:0},12:{total:0,completed:0}};let totalDays=0;let chaptersWithDates=0;['11','12'].forEach(grade=>{const docId=`${mySchool}_${mySubject}_${grade}`;const chapters=curriculum[docId]?.chapters||[];chapters.forEach(ch=>{data[grade].total++;const progressId=`${mySchool}_${ch.id}`;const prog=chapterProgress[progressId]||{};if(prog.completed==='Yes'&&prog.testConducted==='Yes'){data[grade].completed++;if(prog.completionDate&&ch.targetDate){const target=new Date(ch.targetDate);const completion=new Date(prog.completionDate);const days=Math.abs(Math.ceil((completion-target)/(1000*60*60*24)));totalDays+=days;chaptersWithDates++}}})});const avgDays=chaptersWithDates?Math.round(totalDays/chaptersWithDates):0;return{...data,avgDays}},[curriculum,chapterProgress,mySchool,mySubject]);useEffect(()=>{if(chartRef.current){if(chartInstance.current){chartInstance.current.destroy()}const ctx=chartRef.current.getContext('2d');chartInstance.current=new Chart(ctx,{type:'bar',data:{labels:['Class 11','Class 12'],datasets:[{label:'Completed',data:[analyticsData[11].completed,analyticsData[12].completed],backgroundColor:'#10B981'},{label:'Pending',data:[analyticsData[11].total-analyticsData[11].completed,analyticsData[12].total-analyticsData[12].completed],backgroundColor:'#F59E0B'}]},options:{responsive:true,maintainAspectRatio:false,scales:{x:{stacked:true},y:{stacked:true}}}})}return()=>{if(chartInstance.current){chartInstance.current.destroy()}}},[analyticsData]);const handleExport=()=>{const exportData=[{Grade:'Class 11','Total Chapters':analyticsData[11].total,'Completed':analyticsData[11].completed,'Pending':analyticsData[11].total-analyticsData[11].completed,'Completion %':analyticsData[11].total?Math.round((analyticsData[11].completed/analyticsData[11].total)*100):0},{Grade:'Class 12','Total Chapters':analyticsData[12].total,'Completed':analyticsData[12].completed,'Pending':analyticsData[12].total-analyticsData[12].completed,'Completion %':analyticsData[12].total?Math.round((analyticsData[12].completed/analyticsData[12].total)*100):0}];exportToExcel(exportData,'my_analytics')};return(<div className="space-y-6"><div className="flex justify-between items-center"><h2 className="text-3xl font-bold">My Analytics</h2><button onClick={handleExport} className="px-6 py-3 bg-green-600 text-white rounded-xl font-semibold">üìä Export to Excel</button></div><div className="grid grid-cols-3 gap-4"><div className="stat-card"><div className="text-sm text-gray-600">Avg Days per Chapter</div><div className="text-4xl font-bold">{analyticsData.avgDays}</div></div><div className="stat-card"><div className="text-sm text-gray-600">Class 11 Progress</div><div className="text-4xl font-bold">{analyticsData[11].total?Math.round((analyticsData[11].completed/analyticsData[11].total)*100):0}%</div></div><div className="stat-card"><div className="text-sm text-gray-600">Class 12 Progress</div><div className="text-4xl font-bold">{analyticsData[12].total?Math.round((analyticsData[12].completed/analyticsData[12].total)*100):0}%</div></div></div><div className="bg-white p-6 rounded-2xl shadow-lg" style={{height:'400px'}}><canvas ref={chartRef}></canvas></div></div>)}
function TeacherCurriculum({grade,currentUser,curriculum,chapterProgress,updateChapterProgress}){
  const[expandedChapters,setExpandedChapters]=useState({});
  const mySchool=currentUser.school;
  const mySubject=currentUser.subject;
  const docId=`${mySchool}_${mySubject}_${grade}`;
  const chapters=curriculum[docId]?.chapters||[];

  const handleCompletedChange=(chapterId,value)=>{
    const progressId=`${mySchool}_${chapterId}`;
    const prog=chapterProgress[progressId]||{};
    if(value==='Yes'&&prog.testConducted!=='Yes'){
      alert('‚ö†Ô∏è Please conduct the chapter test before marking as completed!');
      return;
    }
    updateChapterProgress(mySchool,chapterId,'completed',value);
  };

  return(
    <div className="space-y-6">
      <h2 className="text-3xl font-bold">Class {grade} - {mySubject}</h2>
      {chapters.length===0?
        <div className="bg-white p-8 rounded-2xl text-center">
          <p className="text-gray-600">No chapters available. Contact admin.</p>
        </div>
      :
        <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
          {chapters.map(chapter=>{
            const progressId=`${mySchool}_${chapter.id}`;
            const prog=chapterProgress[progressId]||{};
            const completedTopics=prog.completedTopics||[];
            const allTopics=chapter.topics||[];
            const progress=allTopics.length?Math.round((completedTopics.length/allTopics.length)*100):0;
            const isExpanded=expandedChapters[chapter.id];
            const status=getChapterStatus(chapter,prog);

            return(
              <div key={chapter.id} className={`chapter-card ${status.color} rounded-2xl shadow-lg p-5`}>
                <div className="flex justify-between items-start mb-3">
                  <h3 className="text-xl font-bold pr-2">{chapter.name}</h3>
                  <button 
                    onClick={(e)=>{
                      e.preventDefault();
                      e.stopPropagation();
                      setExpandedChapters(prev=>({...prev,[chapter.id]:!prev[chapter.id]}));
                    }} 
                    className="text-sm px-3 py-1 bg-white rounded-lg font-semibold"
                  >
                    {isExpanded?'‚ñ≤':'‚ñº'}
                  </button>
                </div>

                <div className={`status-badge ${status.class} mb-3`}>{status.label}</div>

                <div className="space-y-3">
                  <div>
                    <div className="flex justify-between text-sm mb-1">
                      <span className="font-semibold">Topics</span>
                      <span className="font-bold">{completedTopics.length}/{allTopics.length}</span>
                    </div>
                    <div className="h-2 bg-gray-200 rounded-full">
                      <div className="h-2 avanti-gradient rounded-full transition-all" style={{width:`${progress}%`}}/>
                    </div>
                  </div>

                  {isExpanded&&(
                    <>
                      <div className="space-y-2 max-h-40 overflow-y-auto bg-white p-2 rounded-lg">
  {allTopics.map((topic,idx)=>{
    const checked=completedTopics.includes(topic);
    return(
      <label 
        key={idx} 
        className="flex items-center gap-2 cursor-pointer p-2 hover:bg-gray-50 rounded"
      >
        <input 
          type="checkbox" 
          checked={checked}
          onChange={(e)=>{
            const updated=e.target.checked?[...completedTopics,topic]:completedTopics.filter(t=>t!==topic);
            updateChapterProgress(mySchool,chapter.id,'completedTopics',updated);
          }}
        />
        <span className={`text-sm ${checked?'line-through text-gray-500':'font-medium'}`}>
          {topic}
        </span>
      </label>
    );
  })}
</div>

                      <div className="bg-white p-3 rounded-lg">
                        <label className="block text-sm font-bold mb-1">Target Date</label>
                        <div className="text-sm">{chapter.targetDate||'‚Äî'}</div>
                      </div>

                      <div className="bg-white p-3 rounded-lg">
                        <label className="block text-sm font-bold mb-1">Completion Date *</label>
                        <input 
  type="date" 
  value={prog.completionDate||''} 
  onClick={(e)=>e.stopPropagation()}
  onChange={(e)=>{
    e.stopPropagation();
    updateChapterProgress(mySchool,chapter.id,'completionDate',e.target.value);
  }}
  className="w-full border-2 px-3 py-2 rounded-lg cursor-pointer"
/>
                      </div>

                      <div className="bg-white p-3 rounded-lg">
                        <label className="block text-sm font-bold mb-1">Test Conducted? *</label>
                        <select 
  value={prog.testConducted||'No'} 
  onClick={(e)=>e.stopPropagation()}
  onChange={(e)=>{
    e.stopPropagation();
    updateChapterProgress(mySchool,chapter.id,'testConducted',e.target.value);
  }}
  className="w-full border-2 px-3 py-2 rounded-lg cursor-pointer"
>
                          <option value="No">No</option>
                          <option value="Yes">Yes</option>
                        </select>
                      </div>

                      <div className="bg-white p-3 rounded-lg">
                        <label className="block text-sm font-bold mb-1">Chapter Completed? *</label>
                        <select 
  value={prog.completed||'No'} 
  onClick={(e)=>e.stopPropagation()}
  onChange={(e)=>{
    e.stopPropagation();
    handleCompletedChange(chapter.id,e.target.value);
  }}
  className="w-full border-2 px-3 py-2 rounded-lg cursor-pointer"
>
                          <option value="No">No</option>
                          <option value="Yes">Yes</option>
                        </select>
                      </div>

                      <div className="bg-white p-3 rounded-lg">
                        <label className="block text-sm font-bold mb-1">Notes</label>
                        <textarea 
  value={prog.notes||''} 
  onClick={(e)=>e.stopPropagation()}
  onChange={(e)=>{
    e.stopPropagation();
    updateChapterProgress(mySchool,chapter.id,'notes',e.target.value);
  }}
  className="w-full border-2 px-3 py-2 rounded-lg cursor-text" 
  rows="2" 
  placeholder="Add notes..."
/>
                      </div>
                    </>
                  )}
                </div>
              </div>
            );
          })}
        </div>
      }
    </div>
  );
}

function BirthdaysPage({teachers}){const todayBirthdays=useMemo(()=>getBirthdays(teachers,'today'),[teachers]);const weekBirthdays=useMemo(()=>getBirthdays(teachers,'week'),[teachers]);const monthBirthdays=useMemo(()=>getBirthdays(teachers,'month'),[teachers]);const todayAnniversaries=useMemo(()=>getAnniversaries(teachers,'today'),[teachers]);const weekAnniversaries=useMemo(()=>getAnniversaries(teachers,'week'),[teachers]);return(<div className="space-y-6"><h2 className="text-3xl font-bold">üéâ Celebrations</h2><div className="grid md:grid-cols-2 gap-6">{todayBirthdays.length>0&&<div className="birthday-card p-6 rounded-2xl"><h3 className="text-2xl font-bold text-white mb-4">üéÇ Today's Birthdays</h3>{todayBirthdays.map(t=><div key={t.id} className="bg-white p-4 rounded-lg mb-2"><div className="font-bold text-lg">{t.name}</div><div className="text-sm text-gray-600">{t.school}</div></div>)}</div>}{todayAnniversaries.length>0&&<div className="birthday-card p-6 rounded-2xl"><h3 className="text-2xl font-bold text-white mb-4">üéâ Today's Anniversaries</h3>{todayAnniversaries.map(t=>{const years=new Date().getFullYear()-new Date(t.joiningDate).getFullYear();return(<div key={t.id} className="bg-white p-4 rounded-lg mb-2"><div className="font-bold text-lg">{t.name}</div><div className="text-sm text-gray-600">{years} Years at Avanti</div></div>)})}</div>}</div><div className="grid md:grid-cols-2 gap-6"><div className="bg-white p-6 rounded-2xl shadow-lg"><h3 className="text-xl font-bold mb-4">This Week's Birthdays</h3>{weekBirthdays.length===0?<p className="text-gray-500">No birthdays this week</p>:<div className="space-y-2">{weekBirthdays.map(t=><div key={t.id} className="p-3 bg-gray-50 rounded-lg"><div className="font-semibold">{t.name}</div><div className="text-sm text-gray-600">{new Date(t.dob).toLocaleDateString(undefined,{month:'short',day:'numeric'})}</div></div>)}</div>}</div><div className="bg-white p-6 rounded-2xl shadow-lg"><h3 className="text-xl font-bold mb-4">This Month's Birthdays</h3>{monthBirthdays.length===0?<p className="text-gray-500">No birthdays this month</p>:<div className="space-y-2 max-h-96 overflow-y-auto">{monthBirthdays.map(t=><div key={t.id} className="p-3 bg-gray-50 rounded-lg"><div className="font-semibold">{t.name}</div><div className="text-sm text-gray-600">{new Date(t.dob).toLocaleDateString(undefined,{month:'short',day:'numeric'})}</div></div>)}</div>}</div></div></div>)}

function TeacherManagement({teachers}){const[showModal,setShowModal]=useState(false);const[editingTeacher,setEditingTeacher]=useState(null);const[form,setForm]=useState({name:'',afid:'',email:'',password:'',dob:'',joiningDate:'',subject:'',school:'',phone:''});const openAddModal=()=>{setEditingTeacher(null);setForm({name:'',afid:'',email:'',password:'',dob:'',joiningDate:'',subject:'',school:'',phone:''});setShowModal(true)};const openEditModal=teacher=>{setEditingTeacher(teacher);setForm({...teacher,password:''});setShowModal(true)};const handleSave=async()=>{if(!form.afid||!form.name||!form.email||!form.subject||!form.school){alert('Please fill all required fields (AFID, Name, Email, Subject, School)');return}try{await db.collection('teachers').doc(form.afid).set({afid:form.afid,name:form.name,email:form.email.toLowerCase(),subject:form.subject,school:form.school,dob:form.dob||null,joiningDate:form.joiningDate||null,phone:form.phone||null});if(!editingTeacher&&form.password){alert(`Teacher added!\n\nCREATE FIREBASE AUTH:\n1. Firebase Console ‚Üí Authentication\n2. Add User\n3. Email: ${form.email}\n4. Password: ${form.password}`)}else{alert('Teacher updated!')}setShowModal(false)}catch(e){alert('Failed: '+e.message)}};const handleDelete=async teacher=>{if(!confirm(`Delete ${teacher.name}?`))return;try{await db.collection('teachers').doc(teacher.afid).delete();alert('Teacher deleted!')}catch(e){alert('Failed: '+e.message)}};return(<div className="space-y-6"><div className="flex justify-between items-center"><h2 className="text-3xl font-bold">Teacher Management</h2><button onClick={openAddModal} className="px-6 py-3 bg-blue-600 text-white rounded-xl font-semibold">+ Add Teacher</button></div><div className="bg-white p-6 rounded-2xl shadow-lg overflow-x-auto"><table className="w-full"><thead className="avanti-gradient-light"><tr><th className="p-3 text-left">AFID</th><th className="p-3 text-left">Name</th><th className="p-3 text-left">Email</th><th className="p-3 text-left">Subject</th><th className="p-3 text-left">School</th><th className="p-3 text-left">Actions</th></tr></thead><tbody>{teachers.map(t=><tr key={t.id} className="border-b hover:bg-gray-50"><td className="p-3 font-mono">{t.afid}</td><td className="p-3">{t.name}</td><td className="p-3 text-sm">{t.email}</td><td className="p-3">{t.subject}</td><td className="p-3">{t.school}</td><td className="p-3"><div className="flex gap-2"><button onClick={()=>openEditModal(t)} className="px-3 py-1 bg-yellow-400 rounded-lg">Edit</button><button onClick={()=>handleDelete(t)} className="px-3 py-1 bg-red-500 text-white rounded-lg">Delete</button></div></td></tr>)}</tbody></table></div>{showModal&&<div className="modal-overlay" onClick={()=>setShowModal(false)}><div className="modal-content" onClick={e=>e.stopPropagation()}><h3 className="text-2xl font-bold mb-4">{editingTeacher?'Edit Teacher':'Add New Teacher'}</h3><div className="space-y-4"><div><label className="block text-sm font-bold mb-1">AFID *</label><input type="text" value={form.afid} onChange={e=>setForm({...form,afid:e.target.value})} disabled={!!editingTeacher} className="w-full border-2 px-3 py-2 rounded-lg"/></div><div><label className="block text-sm font-bold mb-1">Name *</label><input type="text" value={form.name} onChange={e=>setForm({...form,name:e.target.value})} className="w-full border-2 px-3 py-2 rounded-lg"/></div><div><label className="block text-sm font-bold mb-1">Email *</label><input type="email" value={form.email} onChange={e=>setForm({...form,email:e.target.value})} className="w-full border-2 px-3 py-2 rounded-lg"/></div>{!editingTeacher&&<div><label className="block text-sm font-bold mb-1">Password *</label><input type="password" value={form.password} onChange={e=>setForm({...form,password:e.target.value})} className="w-full border-2 px-3 py-2 rounded-lg"/></div>}<div className="grid grid-cols-2 gap-4"><div><label className="block text-sm font-bold mb-1">Subject *</label><select value={form.subject} onChange={e=>setForm({...form,subject:e.target.value})} className="w-full border-2 px-3 py-2 rounded-lg"><option value="">Select</option>{SUBJECTS.map(s=><option key={s} value={s}>{s}</option>)}</select></div><div><label className="block text-sm font-bold mb-1">School *</label><select value={form.school} onChange={e=>setForm({...form,school:e.target.value})} className="w-full border-2 px-3 py-2 rounded-lg"><option value="">Select</option>{SCHOOLS.map(s=><option key={s} value={s}>{s}</option>)}</select></div></div><div className="grid grid-cols-2 gap-4"><div><label className="block text-sm font-bold mb-1">Date of Birth</label><input type="date" value={form.dob} onChange={e=>setForm({...form,dob:e.target.value})} className="w-full border-2 px-3 py-2 rounded-lg"/></div><div><label className="block text-sm font-bold mb-1">Joining Date</label><input type="date" value={form.joiningDate} onChange={e=>setForm({...form,joiningDate:e.target.value})} className="w-full border-2 px-3 py-2 rounded-lg"/></div></div><div><label className="block text-sm font-bold mb-1">Phone</label><input type="text" value={form.phone} onChange={e=>setForm({...form,phone:e.target.value})} className="w-full border-2 px-3 py-2 rounded-lg"/></div><div className="flex gap-3"><button onClick={handleSave} className="flex-1 avanti-gradient text-white py-3 rounded-xl font-semibold">Save</button><button onClick={()=>setShowModal(false)} className="flex-1 bg-gray-300 py-3 rounded-xl font-semibold">Cancel</button></div></div></div></div>}</div>)}

function AdminCurriculum({curriculum,addChapter,updateChapter,deleteChapter}){const[selectedSchool,setSelectedSchool]=useState(SCHOOLS[0]);const[selectedSubject,setSelectedSubject]=useState(SUBJECTS[0]);const[selectedGrade,setSelectedGrade]=useState('11');const[showAddForm,setShowAddForm]=useState(false);const[editingChapter,setEditingChapter]=useState(null);const[chapterForm,setChapterForm]=useState({name:'',topics:[],targetDate:''});const[newTopic,setNewTopic]=useState('');const fileInputRef=useRef(null);const docId=`${selectedSchool}_${selectedSubject}_${selectedGrade}`;const chapters=curriculum[docId]?.chapters||[];const handleSaveChapter=()=>{if(!chapterForm.name){alert('Chapter name is required');return}if(editingChapter){updateChapter(selectedSchool,selectedSubject,selectedGrade,editingChapter.id,chapterForm);setEditingChapter(null)}else{addChapter(selectedSchool,selectedSubject,selectedGrade,chapterForm)}setChapterForm({name:'',topics:[],targetDate:''});setShowAddForm(false)};const handleEditChapter=chapter=>{setEditingChapter(chapter);setChapterForm({name:chapter.name,topics:chapter.topics||[],targetDate:chapter.targetDate||''});setShowAddForm(true)};const handleAddTopic=()=>{if(!newTopic.trim())return;setChapterForm({...chapterForm,topics:[...chapterForm.topics,newTopic.trim()]});setNewTopic('')};const handleCSVImport=e=>{
  const file=e.target.files[0];
  if(!file)return;

  Papa.parse(file,{
    complete:async results=>{
      try{
        const rows=results.data;
        if(rows.length<2){
          alert('CSV file is empty');
          return;
        }

        let currentChapter=null;
        const chaptersToAdd=[];

        rows.forEach((row,index)=>{
          if(index===0)return; // Skip header

          const chapterName=row[0]?row[0].trim():'';
          const topicName=row[1]?row[1].trim():'';
          const targetDate=row[2]?row[2].trim():''; // Column C for target date

          if(chapterName){
            if(currentChapter){
              chaptersToAdd.push(currentChapter);
            }
            currentChapter={
              name:chapterName,
              topics:topicName?[topicName]:[],
              targetDate:targetDate||''
            };
          }else if(topicName&&currentChapter){
            currentChapter.topics.push(topicName);
          }
        });

        if(currentChapter){
          chaptersToAdd.push(currentChapter);
        }

        if(chaptersToAdd.length===0){
          alert('No valid chapters found in CSV');
          return;
        }

        for(const chapter of chaptersToAdd){
          await addChapter(selectedSchool,selectedSubject,selectedGrade,chapter);
        }

        alert(`Imported ${chaptersToAdd.length} chapters with target dates!`);
        if(fileInputRef.current)fileInputRef.current.value='';
      }catch(e){
        alert('Import failed: '+e.message);
      }
    },
    error:()=>alert('Failed to parse CSV')
  });
};return(<div className="space-y-6"><h2 className="text-3xl font-bold">Curriculum Management</h2><div className="bg-white p-6 rounded-2xl shadow-lg"><div className="grid md:grid-cols-3 gap-4 mb-4"><div><label className="block text-sm font-bold mb-2">School</label><select value={selectedSchool} onChange={e=>setSelectedSchool(e.target.value)} className="w-full border-2 px-4 py-3 rounded-xl">{SCHOOLS.map(s=><option key={s} value={s}>{s}</option>)}</select></div><div><label className="block text-sm font-bold mb-2">Subject</label><select value={selectedSubject} onChange={e=>setSelectedSubject(e.target.value)} className="w-full border-2 px-4 py-3 rounded-xl">{SUBJECTS.map(s=><option key={s} value={s}>{s}</option>)}</select></div><div><label className="block text-sm font-bold mb-2">Grade</label><select value={selectedGrade} onChange={e=>setSelectedGrade(e.target.value)} className="w-full border-2 px-4 py-3 rounded-xl"><option value="11">Class 11</option><option value="12">Class 12</option></select></div></div><div className="flex gap-3"><button onClick={()=>{setEditingChapter(null);setChapterForm({name:'',topics:[],targetDate:''});setShowAddForm(!showAddForm)}} className="px-6 py-3 bg-blue-600 text-white rounded-xl font-semibold">{showAddForm?'Cancel':'+ Add Chapter'}</button><label className="px-6 py-3 bg-green-600 text-white rounded-xl font-semibold cursor-pointer">üì§ Import CSV<input ref={fileInputRef} type="file" accept=".csv" onChange={handleCSVImport} className="hidden"/></label></div></div>{showAddForm&&<div className="bg-white p-6 rounded-2xl shadow-lg"><h4 className="text-xl font-bold mb-4">{editingChapter?'Edit Chapter':'Add New Chapter'}</h4><div className="space-y-4"><div><label className="block text-sm font-bold mb-2">Chapter Name *</label><input type="text" value={chapterForm.name} onChange={e=>setChapterForm({...chapterForm,name:e.target.value})} className="w-full border-2 px-4 py-3 rounded-xl"/></div><div><label className="block text-sm font-bold mb-2">Target Date</label><input type="date" value={chapterForm.targetDate} onChange={e=>setChapterForm({...chapterForm,targetDate:e.target.value})} className="w-full border-2 px-4 py-3 rounded-xl"/></div><div><label className="block text-sm font-bold mb-2">Topics</label><div className="flex gap-2 mb-3"><input type="text" value={newTopic} onChange={e=>setNewTopic(e.target.value)} onKeyPress={e=>e.key==='Enter'&&handleAddTopic()} className="flex-1 border-2 px-4 py-3 rounded-xl" placeholder="Enter topic"/><button onClick={handleAddTopic} className="px-6 py-3 bg-blue-600 text-white rounded-xl">Add</button></div><div className="space-y-2">{chapterForm.topics.map((topic,idx)=><div key={idx} className="flex justify-between items-center p-3 bg-gray-50 rounded-lg"><span>{topic}</span><button onClick={()=>{const updated=chapterForm.topics.filter((_,i)=>i!==idx);setChapterForm({...chapterForm,topics:updated})}} className="px-3 py-1 bg-red-500 text-white rounded-lg">Remove</button></div>)}</div></div><button onClick={handleSaveChapter} className="px-6 py-3 avanti-gradient text-white rounded-xl font-semibold">{editingChapter?'Update Chapter':'Save Chapter'}</button></div></div>}<div className="bg-white p-6 rounded-2xl shadow-lg"><h4 className="text-xl font-bold mb-4">{selectedSchool} - {selectedSubject} - Class {selectedGrade} ({chapters.length} chapters)</h4>{chapters.length===0?<p className="text-gray-500 text-center py-8">No chapters yet</p>:<div className="space-y-3">{chapters.map(ch=><div key={ch.id} className="border-2 rounded-xl p-4 hover:bg-gray-50"><div className="flex justify-between items-start"><div className="flex-1"><h5 className="font-bold text-lg">{ch.name}</h5><p className="text-sm text-gray-600">Target: {ch.targetDate||'Not set'} | Topics: {ch.topics?.length||0}</p>{ch.topics&&ch.topics.length>0&&<ul className="text-xs text-gray-600 ml-4 mt-2">{ch.topics.map((t,i)=><li key={i}>‚Ä¢ {t}</li>)}</ul>}</div><div className="flex gap-2"><button onClick={()=>handleEditChapter(ch)} className="px-3 py-1 bg-yellow-400 rounded-lg">Edit</button><button onClick={()=>deleteChapter(selectedSchool,selectedSubject,selectedGrade,ch.id)} className="px-3 py-1 bg-red-500 text-white rounded-lg">Delete</button></div></div></div>)}</div>}</div></div>)}
function AdminAnalytics({teachers,curriculum,chapterProgress}){
  const[filterSchool,setFilterSchool]=useState('All');
  const[filterGrade,setFilterGrade]=useState('All');
  const[filterTeacher,setFilterTeacher]=useState('All');

  const chart1Ref=useRef(null);
  const chart2Ref=useRef(null);
  const chart3Ref=useRef(null);
  const chart4Ref=useRef(null);
  const chart5Ref=useRef(null);
  const chart6Ref=useRef(null);
  const chart7Ref=useRef(null);
  const chart8Ref=useRef(null);

  const chartInstances=useRef({});

  const filteredData=useMemo(()=>{
    const data={
      totalChapters:0,
      completedChapters:0,
      delayedChapters:0,
      aheadChapters:0,
      testsCompleted:0,
      testsPending:0,
      schoolData:{},
      subjectData:{},
      gradeData:{},
      teacherData:{},
      statusData:{ahead:0,ontrack:0,delayed:0,pending:0}
    };

    const schoolsToProcess=filterSchool==='All'?SCHOOLS:[filterSchool];
    const gradesToProcess=filterGrade==='All'?['11','12']:[filterGrade];
    const teachersFiltered=filterTeacher==='All'?teachers:teachers.filter(t=>t.afid===filterTeacher);

    schoolsToProcess.forEach(school=>{
      if(!data.schoolData[school]){
        data.schoolData[school]={total:0,completed:0,delayed:0,ahead:0,tests:0};
      }

      SUBJECTS.forEach(subject=>{
        if(!data.subjectData[subject]){
          data.subjectData[subject]={total:0,completed:0};
        }

        gradesToProcess.forEach(grade=>{
          if(!data.gradeData[grade]){
            data.gradeData[grade]={total:0,completed:0};
          }

          const docId=`${school}_${subject}_${grade}`;
          const chapters=curriculum[docId]?.chapters||[];

          const relevantTeachers=teachersFiltered.filter(t=>t.school===school&&t.subject===subject);
          if(filterTeacher!=='All'&&relevantTeachers.length===0)return;

          chapters.forEach(ch=>{
            data.totalChapters++;
            data.schoolData[school].total++;
            data.subjectData[subject].total++;
            data.gradeData[grade].total++;

            const progressId=`${school}_${ch.id}`;
            const prog=chapterProgress[progressId]||{};
            const status=getChapterStatus(ch,prog);

            if(prog.completed==='Yes'&&prog.testConducted==='Yes'){
              data.completedChapters++;
              data.schoolData[school].completed++;
              data.subjectData[subject].completed++;
              data.gradeData[grade].completed++;

              if(status.class==='status-ahead'){
                data.aheadChapters++;
                data.schoolData[school].ahead++;
                data.statusData.ahead++;
              }else if(status.class==='status-ontrack'){
                data.statusData.ontrack++;
              }
            }

            if(prog.testConducted==='Yes'){
              data.testsCompleted++;
              data.schoolData[school].tests++;
            }else if(prog.completed==='Yes'){
              data.testsPending++;
            }

            if(status.label.includes('Delayed')){
              data.delayedChapters++;
              data.schoolData[school].delayed++;
              data.statusData.delayed++;
            }

            if(status.label==='Pending'){
              data.statusData.pending++;
            }
          });
        });
      });
    });

    teachersFiltered.forEach(teacher=>{
      if(!data.teacherData[teacher.afid]){
        data.teacherData[teacher.afid]={name:teacher.name,total:0,completed:0};
      }
    });

    return data;
  },[curriculum,chapterProgress,teachers,filterSchool,filterGrade,filterTeacher]);

  useEffect(()=>{
    Object.values(chartInstances.current).forEach(chart=>{
      if(chart)chart.destroy();
    });
    chartInstances.current={};

    // Chart 1: School Completion Rate (Bar)
    if(chart1Ref.current){
      const ctx=chart1Ref.current.getContext('2d');
      const schools=Object.keys(filteredData.schoolData);
      chartInstances.current.chart1=new Chart(ctx,{
        type:'bar',
        data:{
          labels:schools,
          datasets:[{
            label:'Completion %',
            data:schools.map(s=>{
              const d=filteredData.schoolData[s];
              return d.total?Math.round((d.completed/d.total)*100):0;
            }),
            backgroundColor:'#C8342E',
            borderRadius:8
          }]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            title:{display:true,text:'School-wise Completion %',font:{size:16,weight:'bold'}},
            legend:{display:false}
          },
          scales:{y:{beginAtZero:true,max:100,ticks:{callback:v=>v+'%'}}}
        }
      });
    }

    // Chart 2: Subject Distribution (Pie)
    if(chart2Ref.current){
      const ctx=chart2Ref.current.getContext('2d');
      const subjects=Object.keys(filteredData.subjectData);
      chartInstances.current.chart2=new Chart(ctx,{
        type:'pie',
        data:{
          labels:subjects,
          datasets:[{
            data:subjects.map(s=>filteredData.subjectData[s].completed),
            backgroundColor:['#F4B41A','#3B82F6','#10B981','#EF4444'],
            borderWidth:2
          }]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            title:{display:true,text:'Completed Chapters by Subject',font:{size:16,weight:'bold'}},
            legend:{position:'bottom'}
          }
        }
      });
    }

    // Chart 3: Grade Comparison (Bar)
    if(chart3Ref.current){
      const ctx=chart3Ref.current.getContext('2d');
      const grades=Object.keys(filteredData.gradeData);
      chartInstances.current.chart3=new Chart(ctx,{
        type:'bar',
        data:{
          labels:grades.map(g=>`Class ${g}`),
          datasets:[
            {
              label:'Completed',
              data:grades.map(g=>filteredData.gradeData[g].completed),
              backgroundColor:'#10B981'
            },
            {
              label:'Pending',
              data:grades.map(g=>filteredData.gradeData[g].total-filteredData.gradeData[g].completed),
              backgroundColor:'#F59E0B'
            }
          ]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            title:{display:true,text:'Grade-wise Progress',font:{size:16,weight:'bold'}},
            legend:{position:'bottom'}
          },
          scales:{x:{stacked:true},y:{stacked:true,beginAtZero:true}}
        }
      });
    }

    // Chart 4: Overall Status (Doughnut)
    if(chart4Ref.current){
      const ctx=chart4Ref.current.getContext('2d');
      chartInstances.current.chart4=new Chart(ctx,{
        type:'doughnut',
        data:{
          labels:['Completed','Pending','Delayed'],
          datasets:[{
            data:[
              filteredData.completedChapters,
              filteredData.totalChapters-filteredData.completedChapters-filteredData.delayedChapters,
              filteredData.delayedChapters
            ],
            backgroundColor:['#10B981','#F59E0B','#EF4444'],
            borderWidth:0
          }]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            title:{display:true,text:'Overall Chapter Status',font:{size:16,weight:'bold'}},
            legend:{position:'bottom'}
          }
        }
      });
    }

    // Chart 5: Tests Status (Pie)
    if(chart5Ref.current){
      const ctx=chart5Ref.current.getContext('2d');
      chartInstances.current.chart5=new Chart(ctx,{
        type:'pie',
        data:{
          labels:['Tests Completed','Tests Pending'],
          datasets:[{
            data:[filteredData.testsCompleted,filteredData.testsPending],
            backgroundColor:['#3B82F6','#F97316'],
            borderWidth:2
          }]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            title:{display:true,text:'Chapter Tests Status',font:{size:16,weight:'bold'}},
            legend:{position:'bottom'}
          }
        }
      });
    }

    // Chart 6: Performance Status (Bar)
    if(chart6Ref.current){
      const ctx=chart6Ref.current.getContext('2d');
      chartInstances.current.chart6=new Chart(ctx,{
        type:'bar',
        data:{
          labels:['Ahead','On Track','Delayed','Pending'],
          datasets:[{
            label:'Chapters',
            data:[
              filteredData.statusData.ahead,
              filteredData.statusData.ontrack,
              filteredData.statusData.delayed,
              filteredData.statusData.pending
            ],
            backgroundColor:['#10B981','#3B82F6','#F97316','#EF4444'],
            borderRadius:8
          }]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            title:{display:true,text:'Performance Status Distribution',font:{size:16,weight:'bold'}},
            legend:{display:false}
          },
          scales:{y:{beginAtZero:true}}
        }
      });
    }

    // Chart 7: School Delayed Chapters (Horizontal Bar)
    if(chart7Ref.current){
      const ctx=chart7Ref.current.getContext('2d');
      const schools=Object.keys(filteredData.schoolData);
      chartInstances.current.chart7=new Chart(ctx,{
        type:'bar',
        data:{
          labels:schools,
          datasets:[{
            label:'Delayed Chapters',
            data:schools.map(s=>filteredData.schoolData[s].delayed),
            backgroundColor:'#EF4444',
            borderRadius:6
          }]
        },
        options:{
          indexAxis:'y',
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            title:{display:true,text:'Delayed Chapters by School',font:{size:16,weight:'bold'}},
            legend:{display:false}
          },
          scales:{x:{beginAtZero:true}}
        }
      });
    }

    // Chart 8: Subject Completion Rate (Doughnut)
    if(chart8Ref.current){
      const ctx=chart8Ref.current.getContext('2d');
      const subjects=Object.keys(filteredData.subjectData);
      chartInstances.current.chart8=new Chart(ctx,{
        type:'doughnut',
        data:{
          labels:subjects.map(s=>`${s} - ${filteredData.subjectData[s].total?Math.round((filteredData.subjectData[s].completed/filteredData.subjectData[s].total)*100):0}%`),
          datasets:[{
            data:subjects.map(s=>filteredData.subjectData[s].completed),
            backgroundColor:['#F4B41A','#3B82F6','#10B981','#EF4444'],
            borderWidth:2
          }]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            title:{display:true,text:'Subject-wise Completion Rate',font:{size:16,weight:'bold'}},
            legend:{position:'bottom'}
          }
        }
      });
    }

    return()=>{
      Object.values(chartInstances.current).forEach(chart=>{
        if(chart)chart.destroy();
      });
    };
  },[filteredData]);

  const handleExport=()=>{
    const exportData=Object.keys(filteredData.schoolData).map(school=>({
      School:school,
      'Total Chapters':filteredData.schoolData[school].total,
      'Completed':filteredData.schoolData[school].completed,
      'Delayed':filteredData.schoolData[school].delayed,
      'Ahead':filteredData.schoolData[school].ahead,
      'Tests Completed':filteredData.schoolData[school].tests,
      'Completion %':filteredData.schoolData[school].total?Math.round((filteredData.schoolData[school].completed/filteredData.schoolData[school].total)*100):0
    }));
    exportToExcel(exportData,'admin_analytics_filtered');
  };

  return(
    <div className="space-y-6">
      <div className="flex justify-between items-center">
        <h2 className="text-3xl font-bold">üìä Analytics Dashboard</h2>
        <button onClick={handleExport} className="px-6 py-3 bg-green-600 text-white rounded-xl font-semibold">
          üì• Export Filtered Data
        </button>
      </div>

      <div className="bg-white p-6 rounded-2xl shadow-lg">
        <h3 className="text-xl font-bold mb-4">üîç Filters (Apply to All Charts)</h3>
        <div className="grid md:grid-cols-3 gap-4">
          <div>
            <label className="block text-sm font-bold mb-2">School</label>
            <select 
              value={filterSchool} 
              onChange={e=>setFilterSchool(e.target.value)}
              className="w-full border-2 px-4 py-3 rounded-xl"
            >
              <option value="All">All Schools</option>
              {SCHOOLS.map(s=><option key={s} value={s}>{s}</option>)}
            </select>
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">Grade</label>
            <select 
              value={filterGrade} 
              onChange={e=>setFilterGrade(e.target.value)}
              className="w-full border-2 px-4 py-3 rounded-xl"
            >
              <option value="All">All Grades</option>
              <option value="11">Class 11</option>
              <option value="12">Class 12</option>
            </select>
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">Teacher</label>
            <select 
              value={filterTeacher} 
              onChange={e=>setFilterTeacher(e.target.value)}
              className="w-full border-2 px-4 py-3 rounded-xl"
            >
              <option value="All">All Teachers</option>
              {teachers.map(t=><option key={t.afid} value={t.afid}>{t.name} ({t.afid})</option>)}
            </select>
          </div>
        </div>
      </div>

      <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div className="stat-card avanti-gradient text-white">
          <div className="text-sm opacity-90">Total Chapters</div>
          <div className="text-4xl font-bold">{filteredData.totalChapters}</div>
        </div>
        <div className="stat-card bg-green-500 text-white">
          <div className="text-sm opacity-90">Completed</div>
          <div className="text-4xl font-bold">{filteredData.completedChapters}</div>
        </div>
        <div className="stat-card bg-blue-500 text-white">
          <div className="text-sm opacity-90">Ahead Schedule</div>
          <div className="text-4xl font-bold">{filteredData.aheadChapters}</div>
        </div>
        <div className="stat-card bg-orange-500 text-white">
          <div className="text-sm opacity-90">Delayed</div>
          <div className="text-4xl font-bold">{filteredData.delayedChapters}</div>
        </div>
      </div>

      <div className="grid md:grid-cols-2 lg:grid-cols-2 gap-6">
        <div className="bg-white p-6 rounded-2xl shadow-lg" style={{height:'350px'}}>
          <canvas ref={chart1Ref}></canvas>
        </div>
        <div className="bg-white p-6 rounded-2xl shadow-lg" style={{height:'350px'}}>
          <canvas ref={chart2Ref}></canvas>
        </div>
        <div className="bg-white p-6 rounded-2xl shadow-lg" style={{height:'350px'}}>
          <canvas ref={chart3Ref}></canvas>
        </div>
        <div className="bg-white p-6 rounded-2xl shadow-lg" style={{height:'350px'}}>
          <canvas ref={chart4Ref}></canvas>
        </div>
        <div className="bg-white p-6 rounded-2xl shadow-lg" style={{height:'350px'}}>
          <canvas ref={chart5Ref}></canvas>
        </div>
        <div className="bg-white p-6 rounded-2xl shadow-lg" style={{height:'350px'}}>
          <canvas ref={chart6Ref}></canvas>
        </div>
        <div className="bg-white p-6 rounded-2xl shadow-lg" style={{height:'350px'}}>
          <canvas ref={chart7Ref}></canvas>
        </div>
        <div className="bg-white p-6 rounded-2xl shadow-lg" style={{height:'350px'}}>
          <canvas ref={chart8Ref}></canvas>
        </div>
      </div>
    </div>
  );
}

function AdminChapterDetails({curriculum,chapterProgress}){const[filterSchool,setFilterSchool]=useState('All');const[filterSubject,setFilterSubject]=useState('All');const[filterGrade,setFilterGrade]=useState('All');const chapterDetails=useMemo(()=>{const details=[];const schoolsToProcess=filterSchool==='All'?SCHOOLS:[filterSchool];const subjectsToProcess=filterSubject==='All'?SUBJECTS:[filterSubject];const gradesToProcess=filterGrade==='All'?['11','12']:[filterGrade];schoolsToProcess.forEach(school=>{subjectsToProcess.forEach(subject=>{gradesToProcess.forEach(grade=>{const docId=`${school}_${subject}_${grade}`;const chapters=curriculum[docId]?.chapters||[];chapters.forEach(ch=>{const progressId=`${school}_${ch.id}`;const prog=chapterProgress[progressId]||{};details.push({school,subject,grade:`Class ${grade}`,chapterName:ch.name,targetDate:ch.targetDate||'‚Äî',completed:prog.completed||'No',completionDate:prog.completionDate||'‚Äî',testConducted:prog.testConducted||'No',notes:prog.notes||'‚Äî'})})})})});return details},[curriculum,chapterProgress,filterSchool,filterSubject,filterGrade]);const handleExport=()=>{exportToExcel(chapterDetails,'chapter_details')};return(<div className="space-y-6"><div className="flex justify-between items-center"><h2 className="text-3xl font-bold">Chapter Details</h2><button onClick={handleExport} className="px-6 py-3 bg-green-600 text-white rounded-xl font-semibold">üìä Export to Excel</button></div><div className="bg-white p-6 rounded-2xl shadow-lg"><h3 className="font-bold mb-4">Filters</h3><div className="grid md:grid-cols-3 gap-4"><div><label className="block text-sm font-bold mb-2">School</label><select value={filterSchool} onChange={e=>setFilterSchool(e.target.value)} className="w-full border-2 px-4 py-3 rounded-xl"><option value="All">All Schools</option>{SCHOOLS.map(s=><option key={s} value={s}>{s}</option>)}</select></div><div><label className="block text-sm font-bold mb-2">Subject</label><select value={filterSubject} onChange={e=>setFilterSubject(e.target.value)} className="w-full border-2 px-4 py-3 rounded-xl"><option value="All">All Subjects</option>{SUBJECTS.map(s=><option key={s} value={s}>{s}</option>)}</select></div><div><label className="block text-sm font-bold mb-2">Grade</label><select value={filterGrade} onChange={e=>setFilterGrade(e.target.value)} className="w-full border-2 px-4 py-3 rounded-xl"><option value="All">All Grades</option><option value="11">Class 11</option><option value="12">Class 12</option></select></div></div></div><div className="bg-white p-6 rounded-2xl shadow-lg overflow-x-auto"><h3 className="font-bold mb-4">All Chapters ({chapterDetails.length})</h3><table className="w-full"><thead className="avanti-gradient-light"><tr><th className="p-3 text-left">School</th><th className="p-3 text-left">Subject</th><th className="p-3 text-left">Grade</th><th className="p-3 text-left">Chapter Name</th><th className="p-3 text-left">Target Date</th><th className="p-3 text-left">Completed</th><th className="p-3 text-left">Completion Date</th><th className="p-3 text-left">Test Conducted</th><th className="p-3 text-left">Notes</th></tr></thead><tbody>{chapterDetails.length===0?<tr><td colSpan="9" className="p-8 text-center text-gray-500">No chapters found</td></tr>:chapterDetails.map((ch,idx)=><tr key={idx} className="border-b hover:bg-gray-50"><td className="p-3">{ch.school}</td><td className="p-3">{ch.subject}</td><td className="p-3">{ch.grade}</td><td className="p-3 font-semibold">{ch.chapterName}</td><td className="p-3 text-sm">{ch.targetDate}</td><td className="p-3"><span className={`px-2 py-1 rounded-full text-xs font-bold ${ch.completed==='Yes'?'bg-green-100 text-green-700':'bg-gray-100'}`}>{ch.completed}</span></td><td className="p-3 text-sm">{ch.completionDate}</td><td className="p-3"><span className={`px-2 py-1 rounded-full text-xs font-bold ${ch.testConducted==='Yes'?'bg-blue-100 text-blue-700':'bg-orange-100 text-orange-700'}`}>{ch.testConducted}</span></td><td className="p-3 text-sm">{ch.notes}</td></tr>)}</tbody></table></div></div>)}

function AdminBirthdays({teachers}){const todayBirthdays=useMemo(()=>getBirthdays(teachers,'today'),[teachers]);const weekBirthdays=useMemo(()=>getBirthdays(teachers,'week'),[teachers]);const monthBirthdays=useMemo(()=>getBirthdays(teachers,'month'),[teachers]);const todayAnniversaries=useMemo(()=>getAnniversaries(teachers,'today'),[teachers]);const weekAnniversaries=useMemo(()=>getAnniversaries(teachers,'week'),[teachers]);const monthAnniversaries=useMemo(()=>getAnniversaries(teachers,'month'),[teachers]);return(<div className="space-y-6"><h2 className="text-3xl font-bold">üéâ Celebrations</h2><div className="grid md:grid-cols-2 gap-6">{todayBirthdays.length>0&&<div className="birthday-card p-6 rounded-2xl"><h3 className="text-2xl font-bold text-white mb-4">üéÇ Today's Birthdays</h3>{todayBirthdays.map(t=><div key={t.id} className="bg-white p-4 rounded-lg mb-2"><div className="font-bold text-lg">{t.name}</div><div className="text-sm text-gray-600">{t.school} - {t.subject}</div></div>)}</div>}{todayAnniversaries.length>0&&<div className="birthday-card p-6 rounded-2xl"><h3 className="text-2xl font-bold text-white mb-4">üéâ Today's Work Anniversaries</h3>{todayAnniversaries.map(t=>{const years=new Date().getFullYear()-new Date(t.joiningDate).getFullYear();return(<div key={t.id} className="bg-white p-4 rounded-lg mb-2"><div className="font-bold text-lg">{t.name}</div><div className="text-sm text-gray-600">{years} Years - {t.school}</div></div>)})}</div>}</div><div className="grid md:grid-cols-3 gap-6"><div className="bg-white p-6 rounded-2xl shadow-lg"><h3 className="text-xl font-bold mb-4">This Week</h3>{weekBirthdays.length===0&&weekAnniversaries.length===0?<p className="text-gray-500">No celebrations</p>:<div className="space-y-2">{weekBirthdays.map(t=><div key={t.id} className="p-3 bg-blue-50 rounded-lg"><div className="font-semibold">üéÇ {t.name}</div><div className="text-sm text-gray-600">{new Date(t.dob).toLocaleDateString(undefined,{month:'short',day:'numeric'})}</div></div>)}{weekAnniversaries.map(t=><div key={t.id} className="p-3 bg-green-50 rounded-lg"><div className="font-semibold">üéâ {t.name}</div><div className="text-sm text-gray-600">Work Anniversary</div></div>)}</div>}</div><div className="bg-white p-6 rounded-2xl shadow-lg"><h3 className="text-xl font-bold mb-4">This Month - Birthdays</h3>{monthBirthdays.length===0?<p className="text-gray-500">No birthdays</p>:<div className="space-y-2 max-h-96 overflow-y-auto">{monthBirthdays.map(t=><div key={t.id} className="p-3 bg-gray-50 rounded-lg"><div className="font-semibold">{t.name}</div><div className="text-sm text-gray-600">{new Date(t.dob).toLocaleDateString(undefined,{month:'short',day:'numeric'})}</div></div>)}</div>}</div><div className="bg-white p-6 rounded-2xl shadow-lg"><h3 className="text-xl font-bold mb-4">This Month - Anniversaries</h3>{monthAnniversaries.length===0?<p className="text-gray-500">No anniversaries</p>:<div className="space-y-2 max-h-96 overflow-y-auto">{monthAnniversaries.map(t=>{const years=new Date().getFullYear()-new Date(t.joiningDate).getFullYear();return(<div key={t.id} className="p-3 bg-gray-50 rounded-lg"><div className="font-semibold">{t.name}</div><div className="text-sm text-gray-600">{years} Years</div></div>)})}</div>}</div></div></div>)}

// ========================================
// STUDENT MANAGEMENT COMPONENT
// ========================================
function StudentManagement({students}){
  const[showModal,setShowModal]=useState(false);
  const[editingStudent,setEditingStudent]=useState(null);
  const[form,setForm]=useState({school:'',grade:'',name:'',gender:''});
  const[selectedStudents,setSelectedStudents]=useState([]);
  const[filterSchool,setFilterSchool]=useState('All');
  const[filterGrade,setFilterGrade]=useState('All');
  const[selectAll,setSelectAll]=useState(false);
  const fileInputRef=useRef(null);

  const filteredStudents=students.filter(s=>{
    if(filterSchool!=='All'&&s.school!==filterSchool)return false;
    if(filterGrade!=='All'&&s.grade!==filterGrade)return false;
    return true;
  });

  const handleSave=async()=>{
    if(!form.school||!form.grade||!form.name||!form.gender){
      alert('Please fill all fields');
      return;
    }
    try{
      if(editingStudent){
        await db.collection('students').doc(editingStudent.id).update({
          school:form.school,
          grade:form.grade,
          name:form.name,
          gender:form.gender,
          updatedAt:new Date().toISOString()
        });
        alert('Student updated!');
      }else{
        await db.collection('students').add({
          school:form.school,
          grade:form.grade,
          name:form.name,
          gender:form.gender,
          createdAt:new Date().toISOString()
        });
        alert('Student added!');
      }
      setShowModal(false);
      setEditingStudent(null);
      setForm({school:'',grade:'',name:'',gender:''});
    }catch(e){
      alert('Failed: '+e.message);
    }
  };
  const openAddModal=()=>{
    setEditingStudent(null);
    setForm({school:'',grade:'',name:'',gender:''});
    setShowModal(true);
  };

  const openEditModal=(student)=>{
    setEditingStudent(student);
    setForm({
      school:student.school,
      grade:student.grade,
      name:student.name,
      gender:student.gender
    });
    setShowModal(true);
  };

  const handleSelectAll=()=>{
    if(selectAll){
      setSelectedStudents([]);
      setSelectAll(false);
    }else{
      setSelectedStudents(filteredStudents.map(s=>s.id));
      setSelectAll(true);
    }
  };

  const handleSelectStudent=(studentId)=>{
    if(selectedStudents.includes(studentId)){
      setSelectedStudents(selectedStudents.filter(id=>id!==studentId));
    }else{
      setSelectedStudents([...selectedStudents,studentId]);
    }
  };

  const handleBulkDelete=async()=>{
    if(selectedStudents.length===0){
      alert('Please select students to delete');
      return;
    }
    if(!confirm(`Delete ${selectedStudents.length} selected students?`))return;
    
    try{
      const batch=db.batch();
      selectedStudents.forEach(id=>{
        batch.delete(db.collection('students').doc(id));
      });
      await batch.commit();
      alert(`${selectedStudents.length} students deleted!`);
      setSelectedStudents([]);
      setSelectAll(false);
    }catch(e){
      alert('Failed: '+e.message);
    }
  };

  const handleBulkUpdateSchool=async()=>{
    if(selectedStudents.length===0){
      alert('Please select students first');
      return;
    }
    const newSchool=prompt('Enter new school name:');
    if(!newSchool||!SCHOOLS.includes(newSchool)){
      alert('Invalid school name');
      return;
    }
    if(!confirm(`Update school to "${newSchool}" for ${selectedStudents.length} students?`))return;

    try{
      const batch=db.batch();
      selectedStudents.forEach(id=>{
        batch.update(db.collection('students').doc(id),{school:newSchool,updatedAt:new Date().toISOString()});
      });
      await batch.commit();
      alert(`${selectedStudents.length} students updated!`);
      setSelectedStudents([]);
      setSelectAll(false);
    }catch(e){
      alert('Failed: '+e.message);
    }
  };

  const handleBulkUpdateGrade=async()=>{
    if(selectedStudents.length===0){
      alert('Please select students first');
      return;
    }
    const newGrade=prompt('Enter new grade (11 or 12):');
    if(!newGrade||!['11','12'].includes(newGrade)){
      alert('Invalid grade. Must be 11 or 12');
      return;
    }
    if(!confirm(`Update grade to "${newGrade}" for ${selectedStudents.length} students?`))return;

    try{
      const batch=db.batch();
      selectedStudents.forEach(id=>{
        batch.update(db.collection('students').doc(id),{grade:newGrade,updatedAt:new Date().toISOString()});
      });
      await batch.commit();
      alert(`${selectedStudents.length} students updated!`);
      setSelectedStudents([]);
      setSelectAll(false);
    }catch(e){
      alert('Failed: '+e.message);
    }
  };

  const handleCSVImport=e=>{
    const file=e.target.files[0];
    if(!file)return;

    Papa.parse(file,{
      complete:async results=>{
        try{
          const rows=results.data;
          if(rows.length<2){
            alert('CSV file is empty');
            return;
          }

          let imported=0;
          for(let i=1;i<rows.length;i++){
            const row=rows[i];
            const school=row[0]?row[0].trim():'';
            const grade=row[1]?row[1].trim():'';
            const name=row[2]?row[2].trim():'';
            const gender=row[3]?row[3].trim():'';

            if(school&&grade&&name&&gender){
              await db.collection('students').add({
                school,
                grade,
                name,
                gender,
                createdAt:new Date().toISOString()
              });
              imported++;
            }
          }

          alert(`Imported ${imported} students!`);
          if(fileInputRef.current)fileInputRef.current.value='';
        }catch(e){
          alert('Import failed: '+e.message);
        }
      },
      error:()=>alert('Failed to parse CSV')
    });
  };

  const handleDelete=async student=>{
    if(!confirm(`Delete ${student.name}?`))return;
    try{
      await db.collection('students').doc(student.id).delete();
      alert('Student deleted!');
    }catch(e){
      alert('Failed: '+e.message);
    }
  };

  const handleExport=()=>{
    const exportData=students.map(s=>({
      School:s.school,
      Grade:s.grade,
      Name:s.name,
      Gender:s.gender
    }));
    exportToExcel(exportData,'students_list');
  };

  return(
    <div className="space-y-6">
      <div className="flex justify-between items-center">
        <h2 className="text-3xl font-bold">Student Management</h2>
        <div className="flex gap-3">
          <button onClick={openAddModal} className="px-6 py-3 bg-blue-600 text-white rounded-xl font-semibold">
            + Add Student
          </button>
          <label className="px-6 py-3 bg-green-600 text-white rounded-xl font-semibold cursor-pointer">
            üì§ Import CSV
            <input ref={fileInputRef} type="file" accept=".csv" onChange={handleCSVImport} className="hidden"/>
          </label>
          <button onClick={handleExport} className="px-6 py-3 bg-purple-600 text-white rounded-xl font-semibold">
            üì• Export
          </button>
        </div>
      </div>

      {selectedStudents.length>0&&(
        <div className="bg-blue-50 border-2 border-blue-300 p-4 rounded-xl">
          <div className="flex justify-between items-center">
            <div className="font-bold text-blue-800">
              {selectedStudents.length} student(s) selected
            </div>
            <div className="flex gap-2">
              <button onClick={handleBulkUpdateSchool} className="px-4 py-2 bg-blue-600 text-white rounded-lg font-semibold">
                üè´ Change School
              </button>
              <button onClick={handleBulkUpdateGrade} className="px-4 py-2 bg-green-600 text-white rounded-lg font-semibold">
                üìö Change Grade
              </button>
              <button onClick={handleBulkDelete} className="px-4 py-2 bg-red-600 text-white rounded-lg font-semibold">
                üóëÔ∏è Delete Selected
              </button>
              <button onClick={()=>{setSelectedStudents([]);setSelectAll(false)}} className="px-4 py-2 bg-gray-400 text-white rounded-lg font-semibold">
                Cancel
              </button>
            </div>
          </div>
        </div>
      )}

      <div className="bg-white p-6 rounded-2xl shadow-lg">
        <h3 className="text-xl font-bold mb-4">üîç Filters</h3>
        <div className="grid md:grid-cols-2 gap-4">
          <div>
            <label className="block text-sm font-bold mb-2">School</label>
            <select value={filterSchool} onChange={e=>{setFilterSchool(e.target.value);setSelectedStudents([]);setSelectAll(false)}} className="w-full border-2 px-4 py-3 rounded-xl">
              <option value="All">All Schools</option>
              {SCHOOLS.map(s=><option key={s} value={s}>{s}</option>)}
            </select>
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">Grade</label>
            <select value={filterGrade} onChange={e=>{setFilterGrade(e.target.value);setSelectedStudents([]);setSelectAll(false)}} className="w-full border-2 px-4 py-3 rounded-xl">
              <option value="All">All Grades</option>
              <option value="11">Class 11</option>
              <option value="12">Class 12</option>
            </select>
          </div>
        </div>
      </div>

      <div className="bg-white p-4 rounded-xl border-2 border-gray-200">
        <p className="text-sm text-gray-600">
          <strong>CSV Format:</strong> School, Grade, Student Name, Gender
          <br/>
          <strong>Example:</strong> CoE Barwani, 11, Raj Kumar, Male
        </p>
      </div>

      <div className="bg-white p-6 rounded-2xl shadow-lg overflow-x-auto">
        <h3 className="font-bold mb-4">
          Showing {filteredStudents.length} of {students.length} Students
        </h3>
        <table className="w-full">
          <thead className="avanti-gradient-light">
            <tr>
              <th className="p-3">
                <input 
                  type="checkbox" 
                  checked={selectAll&&filteredStudents.length>0} 
                  onChange={handleSelectAll}
                  className="cursor-pointer"
                />
              </th>
              <th className="p-3 text-left">School</th>
              <th className="p-3 text-left">Grade</th>
              <th className="p-3 text-left">Name</th>
              <th className="p-3 text-left">Gender</th>
              <th className="p-3 text-left">Actions</th>
            </tr>
          </thead>
          <tbody>
            {filteredStudents.length===0?(
              <tr>
                <td colSpan="6" className="p-8 text-center text-gray-500">
                  No students found
                </td>
              </tr>
            ):(
              filteredStudents.map(s=>
                <tr key={s.id} className={`border-b hover:bg-gray-50 ${selectedStudents.includes(s.id)?'bg-blue-50':''}`}>
                  <td className="p-3">
                    <input 
                      type="checkbox" 
                      checked={selectedStudents.includes(s.id)}
                      onChange={()=>handleSelectStudent(s.id)}
                      className="cursor-pointer"
                    />
                  </td>
                  <td className="p-3">{s.school}</td>
                  <td className="p-3">Class {s.grade}</td>
                  <td className="p-3 font-semibold">{s.name}</td>
                  <td className="p-3">{s.gender}</td>
                  <td className="p-3">
                    <div className="flex gap-2">
                      <button onClick={()=>openEditModal(s)} className="px-3 py-1 bg-yellow-400 rounded-lg font-semibold">
                        Edit
                      </button>
                      <button onClick={()=>handleDelete(s)} className="px-3 py-1 bg-red-500 text-white rounded-lg font-semibold">
                        Delete
                      </button>
                    </div>
                  </td>
                </tr>
              )
            )}
          </tbody>
        </table>
      </div>

      {showModal&&(
        <div className="modal-overlay" onClick={()=>{setShowModal(false);setEditingStudent(null)}}>
          <div className="modal-content" onClick={e=>e.stopPropagation()}>
            <h3 className="text-2xl font-bold mb-4">{editingStudent?'Edit Student':'Add New Student'}</h3>
            <div className="space-y-4">
              <div>
                <label className="block text-sm font-bold mb-1">School *</label>
                <select value={form.school} onChange={e=>setForm({...form,school:e.target.value})} className="w-full border-2 px-3 py-2 rounded-lg">
                  <option value="">Select</option>
                  {SCHOOLS.map(s=><option key={s} value={s}>{s}</option>)}
                </select>
              </div>
              <div>
                <label className="block text-sm font-bold mb-1">Grade *</label>
                <select value={form.grade} onChange={e=>setForm({...form,grade:e.target.value})} className="w-full border-2 px-3 py-2 rounded-lg">
                  <option value="">Select</option>
                  <option value="11">Class 11</option>
                  <option value="12">Class 12</option>
                </select>
              </div>
              <div>
                <label className="block text-sm font-bold mb-1">Name *</label>
                <input type="text" value={form.name} onChange={e=>setForm({...form,name:e.target.value})} className="w-full border-2 px-3 py-2 rounded-lg"/>
              </div>
              <div>
                <label className="block text-sm font-bold mb-1">Gender *</label>
                <select value={form.gender} onChange={e=>setForm({...form,gender:e.target.value})} className="w-full border-2 px-3 py-2 rounded-lg">
                  <option value="">Select</option>
                  {GENDERS.map(g=><option key={g} value={g}>{g}</option>)}
                </select>
              </div>
              <div className="flex gap-3">
                <button onClick={handleSave} className="flex-1 avanti-gradient text-white py-3 rounded-xl font-semibold">
                  Save
                </button>
                <button onClick={()=>{setShowModal(false);setEditingStudent(null);setForm({school:'',grade:'',name:'',gender:''})}} className="flex-1 bg-gray-300 py-3 rounded-xl font-semibold">
                  Cancel
                </button>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

// ========================================
// TEACHER ATTENDANCE DASHBOARD
// ========================================
function TeacherAttendanceDashboard({currentUser,students,teachers,studentAttendance,teacherAttendance}){
  const[filterGrade,setFilterGrade]=useState('All');
  const[filterSubject,setFilterSubject]=useState('All');
  const[startDate,setStartDate]=useState(getTodayDate().slice(0,7)+'-01');
  const[endDate,setEndDate]=useState(getTodayDate());

  const mySchool=currentUser.school;

  const chart1Ref=useRef(null);
  const chart2Ref=useRef(null);
  const chart3Ref=useRef(null);
  const chartInstances=useRef({});

  const filteredStudentAttendance=useMemo(()=>{
    return studentAttendance.filter(a=>{
      if(a.school!==mySchool)return false;
      if(filterGrade!=='All'&&a.grade!==filterGrade)return false;
      if(a.date<startDate||a.date>endDate)return false;
      return true;
    });
  },[studentAttendance,mySchool,filterGrade,startDate,endDate]);

  const filteredTeacherAttendance=useMemo(()=>{
    return teacherAttendance.filter(a=>{
      if(a.school!==mySchool)return false;
      if(filterSubject!=='All'){
        const teacher=teachers.find(t=>t.afid===a.teacherId);
        if(!teacher||teacher.subject!==filterSubject)return false;
      }
      if(a.date<startDate||a.date>endDate)return false;
      return true;
    });
  },[teacherAttendance,mySchool,teachers,filterSubject,startDate,endDate]);

  const dailyStats=useMemo(()=>{
    const stats={};
    filteredStudentAttendance.forEach(a=>{
      if(!stats[a.date]){
        stats[a.date]={present:0,absent:0};
      }
      if(a.status==='Present'){
        stats[a.date].present++;
      }else{
        stats[a.date].absent++;
      }
    });
    return stats;
  },[filteredStudentAttendance]);

  const gradeStats=useMemo(()=>{
    const stats={'11':{present:0,absent:0},'12':{present:0,absent:0}};
    filteredStudentAttendance.forEach(a=>{
      if(stats[a.grade]){
        if(a.status==='Present'){
          stats[a.grade].present++;
        }else{
          stats[a.grade].absent++;
        }
      }
    });
    return stats;
  },[filteredStudentAttendance]);

  const teacherStats=useMemo(()=>{
    const present=filteredTeacherAttendance.filter(a=>a.status==='Present').length;
    const onLeave=filteredTeacherAttendance.filter(a=>a.status==='On Leave').length;
    return{present,onLeave};
  },[filteredTeacherAttendance]);

  useEffect(()=>{
    Object.values(chartInstances.current).forEach(chart=>{
      if(chart)chart.destroy();
    });
    chartInstances.current={};

    if(chart1Ref.current){
      const ctx=chart1Ref.current.getContext('2d');
      const dates=Object.keys(dailyStats).sort();
      chartInstances.current.chart1=new Chart(ctx,{
        type:'line',
        data:{
          labels:dates.map(d=>new Date(d).getDate()+'/'+String(new Date(d).getMonth()+1)),
          datasets:[
            {
              label:'Present',
              data:dates.map(d=>dailyStats[d].present),
              borderColor:'#10B981',
              backgroundColor:'rgba(16,185,129,0.1)',
              tension:0.4,
              fill:true
            },
            {
              label:'Absent',
              data:dates.map(d=>dailyStats[d].absent),
              borderColor:'#EF4444',
              backgroundColor:'rgba(239,68,68,0.1)',
              tension:0.4,
              fill:true
            }
          ]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            title:{display:true,text:'Daily Student Attendance Trend',font:{size:16,weight:'bold'}},
            legend:{position:'bottom'}
          },
          scales:{y:{beginAtZero:true}}
        }
      });
    }

    if(chart2Ref.current){
      const ctx=chart2Ref.current.getContext('2d');
      chartInstances.current.chart2=new Chart(ctx,{
        type:'bar',
        data:{
          labels:['Class 11','Class 12'],
          datasets:[
            {
              label:'Present',
              data:[gradeStats['11'].present,gradeStats['12'].present],
              backgroundColor:'#10B981'
            },
            {
              label:'Absent',
              data:[gradeStats['11'].absent,gradeStats['12'].absent],
              backgroundColor:'#EF4444'
            }
          ]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            title:{display:true,text:'Grade-wise Attendance',font:{size:16,weight:'bold'}},
            legend:{position:'bottom'}
          },
          scales:{y:{beginAtZero:true}}
        }
      });
    }

    if(chart3Ref.current){
      const ctx=chart3Ref.current.getContext('2d');
      chartInstances.current.chart3=new Chart(ctx,{
        type:'pie',
        data:{
          labels:['Present','On Leave'],
          datasets:[{
            data:[teacherStats.present,teacherStats.onLeave],
            backgroundColor:['#10B981','#F59E0B'],
            borderWidth:2
          }]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            title:{display:true,text:'Teacher Attendance',font:{size:16,weight:'bold'}},
            legend:{position:'bottom'}
          }
        }
      });
    }

    return()=>{
      Object.values(chartInstances.current).forEach(chart=>{
        if(chart)chart.destroy();
      });
    };
  },[dailyStats,gradeStats,teacherStats]);

  const handleExportStudents=()=>{
    const exportData=filteredStudentAttendance.map(a=>({
      Date:a.date,
      Grade:a.grade,
      'Student Name':a.studentName,
      Status:a.status,
      Remarks:a.remarks||'',
      'Marked By':a.markedBy
    }));
    exportToExcel(exportData,`student_attendance_${mySchool}_${startDate}_to_${endDate}`);
  };

  const handleExportTeachers=()=>{
    const exportData=filteredTeacherAttendance.map(a=>({
      Date:a.date,
      'Teacher Name':a.teacherName,
      Status:a.status,
      Reason:a.reason,
      Location:a.location
    }));
    exportToExcel(exportData,`teacher_attendance_${mySchool}_${startDate}_to_${endDate}`);
  };

  return(
    <div className="space-y-6">
      <div className="flex justify-between items-center">
        <h2 className="text-3xl font-bold">üìä Attendance Dashboard - {mySchool}</h2>
      </div>

      <div className="bg-white p-6 rounded-2xl shadow-lg">
        <h3 className="text-xl font-bold mb-4">üîç Filters</h3>
        <div className="grid md:grid-cols-4 gap-4">
          <div>
            <label className="block text-sm font-bold mb-2">Student Grade</label>
            <select value={filterGrade} onChange={e=>setFilterGrade(e.target.value)} className="w-full border-2 px-4 py-3 rounded-xl">
              <option value="All">All Grades</option>
              <option value="11">Class 11</option>
              <option value="12">Class 12</option>
            </select>
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">Teacher Subject</label>
            <select value={filterSubject} onChange={e=>setFilterSubject(e.target.value)} className="w-full border-2 px-4 py-3 rounded-xl">
              <option value="All">All Subjects</option>
              {SUBJECTS.map(s=><option key={s} value={s}>{s}</option>)}
            </select>
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">Start Date</label>
            <input type="date" value={startDate} onChange={e=>setStartDate(e.target.value)} className="w-full border-2 px-4 py-3 rounded-xl"/>
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">End Date</label>
            <input type="date" value={endDate} onChange={e=>setEndDate(e.target.value)} className="w-full border-2 px-4 py-3 rounded-xl"/>
          </div>
        </div>
        <div className="flex gap-3 mt-4">
          <button onClick={handleExportStudents} className="px-6 py-3 bg-green-600 text-white rounded-xl font-semibold">
            üì• Export Student Attendance
          </button>
          <button onClick={handleExportTeachers} className="px-6 py-3 bg-blue-600 text-white rounded-xl font-semibold">
            üì• Export Teacher Attendance
          </button>
        </div>
      </div>

      <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div className="stat-card bg-green-500 text-white">
          <div className="text-sm opacity-90">Students Present</div>
          <div className="text-4xl font-bold">{filteredStudentAttendance.filter(a=>a.status==='Present').length}</div>
        </div>
        <div className="stat-card bg-red-500 text-white">
          <div className="text-sm opacity-90">Students Absent</div>
          <div className="text-4xl font-bold">{filteredStudentAttendance.filter(a=>a.status==='Absent').length}</div>
        </div>
        <div className="stat-card bg-blue-500 text-white">
          <div className="text-sm opacity-90">Teachers Present</div>
          <div className="text-4xl font-bold">{teacherStats.present}</div>
        </div>
        <div className="stat-card bg-orange-500 text-white">
          <div className="text-sm opacity-90">Teachers on Leave</div>
          <div className="text-4xl font-bold">{teacherStats.onLeave}</div>
        </div>
      </div>

      <div className="grid md:grid-cols-2 gap-6">
        <div className="bg-white p-6 rounded-2xl shadow-lg" style={{height:'350px'}}>
          <canvas ref={chart1Ref}></canvas>
        </div>
        <div className="bg-white p-6 rounded-2xl shadow-lg" style={{height:'350px'}}>
          <canvas ref={chart2Ref}></canvas>
        </div>
      </div>

      <div className="bg-white p-6 rounded-2xl shadow-lg" style={{height:'350px'}}>
        <canvas ref={chart3Ref}></canvas>
      </div>

      <div className="grid md:grid-cols-2 gap-6">
        <div className="bg-white p-6 rounded-2xl shadow-lg">
          <h3 className="text-xl font-bold mb-4">üìã Recent Student Attendance</h3>
          <div className="overflow-x-auto max-h-96">
            <table className="w-full">
              <thead className="avanti-gradient-light sticky top-0">
                <tr>
                  <th className="p-3 text-left">Date</th>
                  <th className="p-3 text-left">Grade</th>
                  <th className="p-3 text-left">Student</th>
                  <th className="p-3 text-left">Status</th>
                </tr>
              </thead>
              <tbody>
                {filteredStudentAttendance.slice(0,50).map((a,idx)=>
                  <tr key={idx} className="border-b hover:bg-gray-50">
                    <td className="p-3 text-sm">{a.date}</td>
                    <td className="p-3">{a.grade}</td>
                    <td className="p-3 font-semibold">{a.studentName}</td>
                    <td className="p-3">
                      <span className={`px-2 py-1 rounded-full text-xs font-bold ${a.status==='Present'?'bg-green-100 text-green-700':'bg-red-100 text-red-700'}`}>
                        {a.status}
                      </span>
                    </td>
                  </tr>
                )}
              </tbody>
            </table>
          </div>
        </div>

        <div className="bg-white p-6 rounded-2xl shadow-lg">
          <h3 className="text-xl font-bold mb-4">üë• Teacher Attendance Records</h3>
          <div className="overflow-x-auto max-h-96">
            <table className="w-full">
              <thead className="avanti-gradient-light sticky top-0">
                <tr>
                  <th className="p-3 text-left">Date</th>
                  <th className="p-3 text-left">Teacher</th>
                  <th className="p-3 text-left">Status</th>
                  <th className="p-3 text-left">Reason</th>
                </tr>
              </thead>
              <tbody>
                {filteredTeacherAttendance.slice(0,50).map((a,idx)=>
                  <tr key={idx} className="border-b hover:bg-gray-50">
                    <td className="p-3 text-sm">{a.date}</td>
                    <td className="p-3 font-semibold">{a.teacherName}</td>
                    <td className="p-3">
                      <span className={`px-2 py-1 rounded-full text-xs font-bold ${a.status==='Present'?'bg-green-100 text-green-700':'bg-orange-100 text-orange-700'}`}>
                        {a.status}
                      </span>
                    </td>
                    <td className="p-3 text-sm">{a.reason}</td>
                  </tr>
                )}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  );
}
// ========================================
// REMARKS MODAL FOR ABSENT STUDENTS
// ========================================
function RemarksModal({student,onSave,onClose}){
  const[selectedRemark,setSelectedRemark]=useState('Sick Leave');
  const[customRemark,setCustomRemark]=useState('');

  const ABSENCE_REASONS=[
    'Sick Leave',
    'Went Home for Festival',
    'Family Emergency',
    'Medical Appointment',
    'Personal Reason',
    'Others'
  ];

  const handleSave=()=>{
    const finalRemark=selectedRemark==='Others'?customRemark:selectedRemark;
    if(selectedRemark==='Others'&&!customRemark.trim()){
      alert('Please enter a custom reason');
      return;
    }
    onSave(finalRemark);
  };

  return(
    <div className="modal-overlay" onClick={onClose}>
      <div className="modal-content" onClick={e=>e.stopPropagation()}>
        <h3 className="text-2xl font-bold mb-4">üìù Absence Remarks</h3>
        <p className="text-gray-600 mb-4">Student: <strong>{student.name}</strong></p>
        
        <div className="space-y-4">
          <div>
            <label className="block text-sm font-bold mb-2">Reason for Absence *</label>
            <select 
              value={selectedRemark} 
              onChange={e=>setSelectedRemark(e.target.value)} 
              className="w-full border-2 px-4 py-3 rounded-xl"
            >
              {ABSENCE_REASONS.map(reason=>
                <option key={reason} value={reason}>{reason}</option>
              )}
            </select>
          </div>

          {selectedRemark==='Others'&&(
            <div>
              <label className="block text-sm font-bold mb-2">Please Specify *</label>
              <textarea
                value={customRemark}
                onChange={e=>setCustomRemark(e.target.value)}
                className="w-full border-2 px-4 py-3 rounded-xl"
                rows="3"
                placeholder="Enter custom reason..."
              />
            </div>
          )}

          <div className="flex gap-3 mt-6">
            <button 
              onClick={handleSave} 
              className="flex-1 bg-red-500 text-white py-3 rounded-xl font-semibold"
            >
              Mark Absent
            </button>
            <button 
              onClick={onClose} 
              className="flex-1 bg-gray-300 py-3 rounded-xl font-semibold"
            >
              Cancel
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}    
// ========================================
// STUDENT ATTENDANCE VIEW (FOR TEACHERS)
// ========================================
function StudentAttendanceView({currentUser,students,studentAttendance}){
  const[selectedGrade,setSelectedGrade]=useState('11');
  const[selectedDate,setSelectedDate]=useState(getTodayDate());
  const[attendanceMap,setAttendanceMap]=useState({});
  const[showRemarksModal,setShowRemarksModal]=useState(false);
  const[selectedStudent,setSelectedStudent]=useState(null);

  const mySchool=currentUser.school;
  const filteredStudents=students.filter(s=>s.school===mySchool&&s.grade===selectedGrade);

  console.log('StudentAttendanceView Debug:',{
    mySchool,
    selectedGrade,
    totalStudents:students.length,
    filteredCount:filteredStudents.length,
    allSchools:Array.from(new Set(students.map(s=>s.school))),
    allGrades:Array.from(new Set(students.map(s=>s.grade)))
  });

  useEffect(()=>{
    const map={};
    studentAttendance
      .filter(a=>a.date===selectedDate&&a.school===mySchool&&a.grade===selectedGrade)
      .forEach(a=>{
        map[a.studentId]=a.status;
      });
    setAttendanceMap(map);
  },[selectedDate,mySchool,selectedGrade]);
  const handleAttendanceChange=async(studentId,status,remarks='')=>{
    try{
      const docId=`${mySchool}_${selectedGrade}_${studentId}_${selectedDate}`;
      await db.collection('studentAttendance').doc(docId).set({
        school:mySchool,
        grade:selectedGrade,
        studentId,
        studentName:filteredStudents.find(s=>s.id===studentId)?.name||'',
        date:selectedDate,
        status,
        remarks:status==='Absent'?remarks:'',
        markedBy:currentUser.afid,
        markedAt:new Date().toISOString()
      });
      setAttendanceMap(prev=>({...prev,[studentId]:status}));
    }catch(e){
      alert('Failed: '+e.message);
    }
  };

  const handleSelectAll=async()=>{
    try{
      for(const student of filteredStudents){
        const docId=`${mySchool}_${selectedGrade}_${student.id}_${selectedDate}`;
        await db.collection('studentAttendance').doc(docId).set({
          school:mySchool,
          grade:selectedGrade,
          studentId:student.id,
          studentName:student.name,
          date:selectedDate,
          status:'Present',
          markedBy:currentUser.afid,
          markedAt:new Date().toISOString()
        });
      }
      const newMap={};
      filteredStudents.forEach(s=>newMap[s.id]='Present');
      setAttendanceMap(newMap);
      alert('All students marked present!');
    }catch(e){
      alert('Failed: '+e.message);
    }
  };

  return(
    <div className="space-y-6">
      <h2 className="text-3xl font-bold">Student Attendance - {mySchool}</h2>

      <div className="bg-white p-6 rounded-2xl shadow-lg">
        <div className="grid md:grid-cols-3 gap-4 mb-4">
          <div>
            <label className="block text-sm font-bold mb-2">Grade</label>
            <select value={selectedGrade} onChange={e=>setSelectedGrade(e.target.value)} className="w-full border-2 px-4 py-3 rounded-xl">
              <option value="11">Class 11</option>
              <option value="12">Class 12</option>
            </select>
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">Date</label>
            <input type="date" value={selectedDate} onChange={e=>setSelectedDate(e.target.value)} className="w-full border-2 px-4 py-3 rounded-xl"/>
          </div>
          <div className="flex items-end">
            <button onClick={handleSelectAll} className="w-full px-6 py-3 bg-green-600 text-white rounded-xl font-semibold">
              ‚úÖ Mark All Present
            </button>
          </div>
        </div>
      </div>

      <div className="bg-white p-6 rounded-2xl shadow-lg">
        <h3 className="font-bold mb-4">Students ({filteredStudents.length})</h3>
        {filteredStudents.length===0?
          <p className="text-gray-500 text-center py-8">No students found</p>
        :
          <div className="space-y-2">
            {filteredStudents.map(student=>
              <div key={student.id} className="flex items-center justify-between p-4 border-2 rounded-xl hover:bg-gray-50">
                <div className="flex-1">
                  <div className="font-semibold text-lg">{student.name}</div>
                  <div className="text-sm text-gray-600">{student.gender}</div>
                  {attendanceMap[student.id]==='Absent'&&(
                    <div className="text-xs text-red-600 mt-1">
                      üìù {studentAttendance.find(a=>a.studentId===student.id&&a.date===selectedDate)?.remarks||'No reason provided'}
                    </div>
                  )}
                </div>
                <div className="flex gap-2">
                  <button 
                    onClick={()=>handleAttendanceChange(student.id,'Present')}
                    className={`px-6 py-2 rounded-lg font-semibold ${attendanceMap[student.id]==='Present'?'bg-green-500 text-white':'bg-gray-200'}`}
                  >
                    ‚úì Present
                  </button>
                  <button 
                    onClick={()=>{
                      setSelectedStudent(student);
                      setShowRemarksModal(true);
                    }}
                    className={`px-6 py-2 rounded-lg font-semibold ${attendanceMap[student.id]==='Absent'?'bg-red-500 text-white':'bg-gray-200'}`}
                  >
                    ‚úó Absent
                  </button>
                </div>
              </div>
            )}
          </div>
        }
      </div>

      {showRemarksModal&&selectedStudent&&(
        <RemarksModal
          student={selectedStudent}
          onSave={(remarks)=>{
            handleAttendanceChange(selectedStudent.id,'Absent',remarks);
            setShowRemarksModal(false);
            setSelectedStudent(null);
          }}
          onClose={()=>{
            setShowRemarksModal(false);
            setSelectedStudent(null);
          }}
        />
      )}
    </div>
  );
}

// ========================================
// TEACHER ATTENDANCE VIEW
// ========================================
function TeacherAttendanceView({currentUser,teacherAttendance}){
  const[selectedDate,setSelectedDate]=useState(getTodayDate());
  const[status,setStatus]=useState('Present');
  const[reason,setReason]=useState('Present');
  const[location,setLocation]=useState('');
  const[fetchingLocation,setFetchingLocation]=useState(false);

  const todayRecord=teacherAttendance.find(a=>a.teacherId===currentUser.afid&&a.date===selectedDate);

  useEffect(()=>{
    if(todayRecord){
      setStatus(todayRecord.status);
      setReason(todayRecord.reason||'Present');
      setLocation(todayRecord.location||'');
    }
  },[todayRecord]);

  const getLocation=()=>{
  setFetchingLocation(true);
  
  // First check if geolocation is supported
  if(!navigator.geolocation){
    setFetchingLocation(false);
    alert('‚ùå GPS location tracking is not supported by your browser.\n\nüìù Please enter your location manually in the text field above.\n\nExample: "CoE Barwani Office" or "Main Building"');
    // Focus on input field
    setTimeout(()=>{
      const input=document.querySelector('input[placeholder*="location"]');
      if(input)input.focus();
    },100);
    return;
  }

  // Check if we're on HTTPS (required for geolocation)
  if(window.location.protocol==='https:'||window.location.hostname.includes('localhost')){
    // All good, proceed with geolocation
  } else {
    alert('‚ö†Ô∏è Location access requires HTTPS. Please access the site using https:// instead of http://');
    setFetchingLocation(false);
    return;
  }

  // Use getCurrentPosition with better error handling
  navigator.geolocation.getCurrentPosition(
    // Success callback
    (position)=>{
      const loc=`${position.coords.latitude.toFixed(6)}, ${position.coords.longitude.toFixed(6)}`;
      setLocation(loc);
      setFetchingLocation(false);
      alert('‚úÖ Location fetched successfully!\n\nüìç GPS coordinates have been added.');
    },
    // Error callback
    (error)=>{
      setFetchingLocation(false);
      let errorMessage='';
      
      switch(error.code){
        case error.PERMISSION_DENIED:
          errorMessage='üö´ GPS location tracking failed - Permission denied.\n\nüìù Please enter your location manually.\n\nExample: "CoE Barwani Office", "Main Building", or "Work from Home"';
          break;
        case error.POSITION_UNAVAILABLE:
          errorMessage='üìç GPS location tracking failed - Location information unavailable.\n\nüìù Please enter your location manually.\n\nExample: "CoE Barwani Office", "Main Building", or "Work from Home"';
          break;
        case error.TIMEOUT:
          errorMessage='‚è±Ô∏è GPS location tracking timed out.\n\nüìù Please enter your location manually.\n\nExample: "CoE Barwani Office", "Main Building", or "Work from Home"';
          break;
        default:
          errorMessage='‚ùå GPS location tracking failed.\n\nüìù Please enter your location manually in the text field above.\n\nExample: "CoE Barwani Office", "Main Building", or "Work from Home"';
      }
      
      alert(errorMessage);
      
      // Focus on the input field after alert is dismissed
      setTimeout(()=>{
        const input=document.querySelector('input[placeholder*="location"]');
        if(input)input.focus();
      },100);
    },
    // Options
    {
      enableHighAccuracy:false,
      timeout:10000,
      maximumAge:300000
    }
  );
};
  const handleSubmit=async()=>{
  if(status!=='Present'&&!reason){
    alert('Please select a reason');
    return;
  }
  
  // Make location optional with a default value
  const finalLocation=location.trim()||'Not provided';
  
  try{
    const docId=`${currentUser.afid}_${selectedDate}`;
    await db.collection('teacherAttendance').doc(docId).set({
      teacherId:currentUser.afid,
      teacherName:currentUser.name,
      school:currentUser.school,
      date:selectedDate,
      status,
      reason:status==='Present'?'Present':reason,
      location:finalLocation,
      markedAt:new Date().toISOString()
    });
    alert('‚úÖ Attendance marked successfully!');
  }catch(e){
    alert('‚ùå Failed: '+e.message);
  }
};

  return(
    <div className="space-y-6">
      <h2 className="text-3xl font-bold">My Attendance</h2>

      <div className="bg-white p-6 rounded-2xl shadow-lg max-w-2xl mx-auto">
        <div className="space-y-4">
          <div>
            <label className="block text-sm font-bold mb-2">Date</label>
            <input type="date" value={selectedDate} onChange={e=>setSelectedDate(e.target.value)} className="w-full border-2 px-4 py-3 rounded-xl"/>
          </div>

          <div>
            <label className="block text-sm font-bold mb-2">Status *</label>
            <div className="flex gap-3">
              <button 
                onClick={()=>{setStatus('Present');setReason('Present')}}
                className={`flex-1 py-3 rounded-xl font-semibold ${status==='Present'?'bg-green-500 text-white':'bg-gray-200'}`}
              >
                ‚úì Present
              </button>
              <button 
                onClick={()=>setStatus('On Leave')}
                className={`flex-1 py-3 rounded-xl font-semibold ${status==='On Leave'?'bg-orange-500 text-white':'bg-gray-200'}`}
              >
                üìÖ On Leave
              </button>
            </div>
          </div>

          {status==='On Leave'&&(
            <div>
              <label className="block text-sm font-bold mb-2">Reason *</label>
              <select value={reason} onChange={e=>setReason(e.target.value)} className="w-full border-2 px-4 py-3 rounded-xl">
                {LEAVE_REASONS.filter(r=>r!=='Present').map(r=><option key={r} value={r}>{r}</option>)}
              </select>
            </div>
          )}

          <div>
  <label className="block text-sm font-bold mb-2">Location (Optional)</label>
  <div className="flex gap-2">
    <input 
      type="text" 
      value={location} 
      onChange={e=>setLocation(e.target.value)} 
      className="flex-1 border-2 px-4 py-3 rounded-xl" 
      placeholder="Enter location or fetch GPS"
    />
    <button 
      onClick={getLocation} 
      disabled={fetchingLocation} 
      className="px-6 py-3 bg-blue-600 text-white rounded-xl font-semibold disabled:opacity-50 whitespace-nowrap"
    >
      {fetchingLocation?'üìç Fetching...':'üìç Get GPS'}
    </button>
  </div>
  {location&&<p className="text-sm text-gray-600 mt-2">üìç {location}</p>}
  <p className="text-xs text-gray-500 mt-1">
    üí° Tip: If GPS doesn't work, type your location manually (e.g., "CoE Barwani Office" or "Work from Home")
  </p>
</div>

          {todayRecord&&(
            <div className="mt-6 p-4 bg-green-50 border-2 border-green-200 rounded-xl">
              <h4 className="font-bold text-green-800 mb-2">‚úì Already Marked for {selectedDate}</h4>
              <p><strong>Status:</strong> {todayRecord.status}</p>
              <p><strong>Reason:</strong> {todayRecord.reason}</p>
              <p><strong>Location:</strong> {todayRecord.location}</p>
            </div>
          )}
        </div>
      </div>
    </div>
  );
}

// ========================================
// ADMIN ATTENDANCE ANALYTICS
// ========================================
function AdminAttendanceAnalytics({students,teachers,studentAttendance,teacherAttendance}){
  const[filterSchool,setFilterSchool]=useState('All');
  const[filterGrade,setFilterGrade]=useState('All');
  const[startDate,setStartDate]=useState(getTodayDate().slice(0,7)+'-01');
  const[endDate,setEndDate]=useState(getTodayDate());
  const[selectedDate,setSelectedDate]=useState(getTodayDate());

  const chart1Ref=useRef(null);
  const chart2Ref=useRef(null);
  const chart3Ref=useRef(null);
  const chart4Ref=useRef(null);

  const chartInstances=useRef({});

  const filteredStudentAttendance=useMemo(()=>{
    return studentAttendance.filter(a=>{
      if(filterSchool!=='All'&&a.school!==filterSchool)return false;
      if(filterGrade!=='All'&&a.grade!==filterGrade)return false;
      if(a.date<startDate||a.date>endDate)return false;
      return true;
    });
  },[studentAttendance,filterSchool,filterGrade,startDate,endDate]);

  const filteredTeacherAttendance=useMemo(()=>{
    return teacherAttendance.filter(a=>{
      if(filterSchool!=='All'&&a.school!==filterSchool)return false;
      if(a.date<startDate||a.date>endDate)return false;
      return true;
    });
  },[teacherAttendance,filterSchool,startDate,endDate]);

  const todayStats=useMemo(()=>{
    const studentRecords=studentAttendance.filter(a=>a.date===selectedDate);
    const teacherRecords=teacherAttendance.filter(a=>a.date===selectedDate);
    return{
      studentPresent:studentRecords.filter(r=>r.status==='Present').length,
      studentAbsent:studentRecords.filter(r=>r.status==='Absent').length,
      teacherPresent:teacherRecords.filter(r=>r.status==='Present').length,
      teacherAbsent:teacherRecords.filter(r=>r.status==='On Leave').length
    };
  },[studentAttendance,teacherAttendance,selectedDate]);

  const genderStats=useMemo(()=>{
    const stats={Male:{present:0,absent:0},Female:{present:0,absent:0},Other:{present:0,absent:0}};
    filteredStudentAttendance.forEach(a=>{
      const student=students.find(s=>s.id===a.studentId);
      if(student&&stats[student.gender]){
        if(a.status==='Present'){
          stats[student.gender].present++;
        }else{
          stats[student.gender].absent++;
        }
      }
    });
    return stats;
  },[filteredStudentAttendance,students]);

  const monthlyDayStats=useMemo(()=>{
    const stats={};
    filteredStudentAttendance.forEach(a=>{
      if(!stats[a.date]){
        stats[a.date]={present:0,absent:0};
      }
      if(a.status==='Present'){
        stats[a.date].present++;
      }else{
        stats[a.date].absent++;
      }
    });
    return stats;
  },[filteredStudentAttendance]);

  useEffect(()=>{
    Object.values(chartInstances.current).forEach(chart=>{
      if(chart)chart.destroy();
    });
    chartInstances.current={};

    // Chart 1: Daily Student Attendance (Line)
    if(chart1Ref.current){
      const ctx=chart1Ref.current.getContext('2d');
      const dates=Object.keys(monthlyDayStats).sort();
      chartInstances.current.chart1=new Chart(ctx,{
        type:'line',
        data:{
          labels:dates.map(d=>new Date(d).getDate()),
          datasets:[
            {
              label:'Present',
              data:dates.map(d=>monthlyDayStats[d].present),
              borderColor:'#10B981',
              backgroundColor:'rgba(16,185,129,0.1)',
              tension:0.4,
              fill:true
            },
            {
              label:'Absent',
              data:dates.map(d=>monthlyDayStats[d].absent),
              borderColor:'#EF4444',
              backgroundColor:'rgba(239,68,68,0.1)',
              tension:0.4,
              fill:true
            }
          ]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            title:{display:true,text:'Daily Student Attendance (Month)',font:{size:16,weight:'bold'}},
            legend:{position:'bottom'}
          },
          scales:{
            y:{beginAtZero:true}
          }
        }
      });
    }

    // Chart 2: Gender-wise Attendance (Bar)
    if(chart2Ref.current){
      const ctx=chart2Ref.current.getContext('2d');
      const genders=Object.keys(genderStats);
      chartInstances.current.chart2=new Chart(ctx,{
        type:'bar',
        data:{
          labels:genders,
          datasets:[
            {
              label:'Present',
              data:genders.map(g=>genderStats[g].present),
              backgroundColor:'#10B981'
            },
            {
              label:'Absent',
              data:genders.map(g=>genderStats[g].absent),
              backgroundColor:'#EF4444'
            }
          ]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            title:{display:true,text:'Gender-wise Student Attendance',font:{size:16,weight:'bold'}},
            legend:{position:'bottom'}
          },
          scales:{
            y:{beginAtZero:true}
          }
        }
      });
    }

    // Chart 3: Teacher Attendance Status (Pie)
    if(chart3Ref.current){
      const ctx=chart3Ref.current.getContext('2d');
      const present=filteredTeacherAttendance.filter(a=>a.status==='Present').length;
      const onLeave=filteredTeacherAttendance.filter(a=>a.status==='On Leave').length;
      chartInstances.current.chart3=new Chart(ctx,{
        type:'pie',
        data:{
          labels:['Present','On Leave'],
          datasets:[{
            data:[present,onLeave],
            backgroundColor:['#10B981','#F59E0B'],
            borderWidth:2
          }]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            title:{display:true,text:'Teacher Attendance Status (Month)',font:{size:16,weight:'bold'}},
            legend:{position:'bottom'}
          }
        }
      });
    }

    // Chart 4: Overall Student Attendance (Doughnut)
    if(chart4Ref.current){
      const ctx=chart4Ref.current.getContext('2d');
      const present=filteredStudentAttendance.filter(a=>a.status==='Present').length;
      const absent=filteredStudentAttendance.filter(a=>a.status==='Absent').length;
      chartInstances.current.chart4=new Chart(ctx,{
        type:'doughnut',
        data:{
          labels:['Present','Absent'],
          datasets:[{
            data:[present,absent],
            backgroundColor:['#3B82F6','#EF4444'],
            borderWidth:0
          }]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            title:{display:true,text:'Overall Student Attendance (Month)',font:{size:16,weight:'bold'}},
            legend:{position:'bottom'}
          }
        }
      });
    }

    return()=>{
      Object.values(chartInstances.current).forEach(chart=>{
        if(chart)chart.destroy();
      });
    };
  },[monthlyDayStats,genderStats,filteredTeacherAttendance,filteredStudentAttendance]);

  const handleExportStudents=()=>{
    const exportData=filteredStudentAttendance.map(a=>({
      Date:a.date,
      School:a.school,
      Grade:a.grade,
      'Student Name':a.studentName,
      Status:a.status,
      Remarks:a.remarks||'',
      'Marked By':a.markedBy
    }));
    exportToExcel(exportData,`student_attendance_${startDate}_to_${endDate}`);
  };

  const handleExportTeachers=()=>{
    const exportData=filteredTeacherAttendance.map(a=>({
      Date:a.date,
      'Teacher Name':a.teacherName,
      School:a.school,
      Status:a.status,
      Reason:a.reason,
      Location:a.location
    }));
    exportToExcel(exportData,`teacher_attendance_${startDate}_to_${endDate}`);
  };

  return(
    <div className="space-y-6">
      <div className="flex justify-between items-center">
        <h2 className="text-3xl font-bold">üìä Attendance Analytics</h2>
        <div className="flex gap-2">
          <button onClick={handleExportStudents} className="px-4 py-2 bg-green-600 text-white rounded-xl font-semibold">
            üì• Export Students
          </button>
          <button onClick={handleExportTeachers} className="px-4 py-2 bg-blue-600 text-white rounded-xl font-semibold">
            üì• Export Teachers
          </button>
        </div>
      </div>

      <div className="bg-white p-6 rounded-2xl shadow-lg">
        <h3 className="text-xl font-bold mb-4">üîç Filters</h3>
        <div className="grid md:grid-cols-5 gap-4">
          <div>
            <label className="block text-sm font-bold mb-2">School</label>
            <select value={filterSchool} onChange={e=>setFilterSchool(e.target.value)} className="w-full border-2 px-4 py-3 rounded-xl">
              <option value="All">All Schools</option>
              {SCHOOLS.map(s=><option key={s} value={s}>{s}</option>)}
            </select>
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">Grade</label>
            <select value={filterGrade} onChange={e=>setFilterGrade(e.target.value)} className="w-full border-2 px-4 py-3 rounded-xl">
              <option value="All">All Grades</option>
              <option value="11">Class 11</option>
              <option value="12">Class 12</option>
            </select>
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">Start Date</label>
            <input type="date" value={startDate} onChange={e=>setStartDate(e.target.value)} className="w-full border-2 px-4 py-3 rounded-xl"/>
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">End Date</label>
            <input type="date" value={endDate} onChange={e=>setEndDate(e.target.value)} className="w-full border-2 px-4 py-3 rounded-xl"/>
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">Today's View</label>
            <input type="date" value={selectedDate} onChange={e=>setSelectedDate(e.target.value)} className="w-full border-2 px-4 py-3 rounded-xl"/>
          </div>
        </div>
      </div>

      <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div className="stat-card bg-green-500 text-white">
          <div className="text-sm opacity-90">Students Present Today</div>
          <div className="text-4xl font-bold">{todayStats.studentPresent}</div>
        </div>
        <div className="stat-card bg-red-500 text-white">
          <div className="text-sm opacity-90">Students Absent Today</div>
          <div className="text-4xl font-bold">{todayStats.studentAbsent}</div>
        </div>
        <div className="stat-card bg-blue-500 text-white">
          <div className="text-sm opacity-90">Teachers Present Today</div>
          <div className="text-4xl font-bold">{todayStats.teacherPresent}</div>
        </div>
        <div className="stat-card bg-orange-500 text-white">
          <div className="text-sm opacity-90">Teachers on Leave Today</div>
          <div className="text-4xl font-bold">{todayStats.teacherAbsent}</div>
        </div>
      </div>

      <div className="grid md:grid-cols-2 gap-6">
        <div className="bg-white p-6 rounded-2xl shadow-lg" style={{height:'350px'}}>
          <canvas ref={chart1Ref}></canvas>
        </div>
        <div className="bg-white p-6 rounded-2xl shadow-lg" style={{height:'350px'}}>
          <canvas ref={chart2Ref}></canvas>
        </div>
        <div className="bg-white p-6 rounded-2xl shadow-lg" style={{height:'350px'}}>
          <canvas ref={chart3Ref}></canvas>
        </div>
        <div className="bg-white p-6 rounded-2xl shadow-lg" style={{height:'350px'}}>
          <canvas ref={chart4Ref}></canvas>
        </div>
      </div>

      <div className="bg-white p-6 rounded-2xl shadow-lg">
        <h3 className="text-xl font-bold mb-4">üìã Detailed Teacher Attendance</h3>
        <div className="overflow-x-auto">
          <table className="w-full">
            <thead className="avanti-gradient-light">
                <tr>
                  <th className="p-3 text-left">Date</th>
                  <th className="p-3 text-left">School</th>
                  <th className="p-3 text-left">Grade</th>
                  <th className="p-3 text-left">Student</th>
                  <th className="p-3 text-left">Status</th>
                  <th className="p-3 text-left">Remarks</th>
                </tr>
              </thead>
            <tbody>
              {filteredTeacherAttendance.length===0?
                <tr><td colSpan="6" className="p-8 text-center text-gray-500">No records found</td></tr>
              :
                filteredTeacherAttendance.slice(0,50).map((a,idx)=>
                  <tr key={idx} className="border-b hover:bg-gray-50">
                    <td className="p-3">{a.date}</td>
                    <td className="p-3 font-semibold">{a.teacherName}</td>
                    <td className="p-3">{a.school}</td>
                    <td className="p-3">
                      <span className={`px-2 py-1 rounded-full text-xs font-bold ${a.status==='Present'?'bg-green-100 text-green-700':'bg-orange-100 text-orange-700'}`}>
                        {a.status}
                      </span>
                    </td>
                    <td className="p-3">{a.reason}</td>
                    <td className="p-3 text-sm">üìç {a.location}</td>
                  </tr>
                )
              }
            </tbody>
          </table>
        </div>
      </div>
    </div>
  );
}
// ========================================
// TIME TRACKER ADDITIONS TO INDEX.HTML
// ========================================

// ========================================
// ADD TO App() FUNCTION STATE (after line 119):
// ========================================
const[timeEntries,setTimeEntries]=useState([]);
const[jobSettings,setJobSettings]=useState({jobs:DEFAULT_JOBS,subjobs:DEFAULT_SUBJOBS});

// ========================================
// ADD TO useEffect() subscriptions (around line 165):
// ========================================
const unsubTimeEntries = db.collection('timeEntries').onSnapshot(snap => {
  setTimeEntries(snap.docs.map(d => ({ ...d.data(), id: d.id })));
});

const unsubJobSettings = db.collection('settings').doc('jobSettings').onSnapshot(doc => {
  if(doc.exists){
    setJobSettings(doc.data());
  }else{
    setJobSettings({jobs:DEFAULT_JOBS,subjobs:DEFAULT_SUBJOBS});
  }
});

// ADD TO CLEANUP:
unsubTimeEntries();
unsubJobSettings();

// ========================================
// ADD TO TEACHER TAB NAVIGATION (around line 315):
// ========================================
// Add 'timetracker' and 'timeanalytics' to the tabs array

{tab==='timetracker'&&'‚è±Ô∏è Time Tracker'}
{tab==='timeanalytics'&&'üìä Time Analytics'}

// ========================================
// ADD TO TEACHER VIEW RENDER (around line 340):
// ========================================
{activeTab==='timetracker'&&<TimeTrackerView currentUser={currentUser} timeEntries={timeEntries} jobSettings={jobSettings}/>}
{activeTab==='timeanalytics'&&<TimeAnalyticsView currentUser={currentUser} timeEntries={timeEntries} teachers={teachers}/>}

// ========================================
// ADD TO ADMIN TAB NAVIGATION (around line 369):
// ========================================
// Add 'timetracker' and 'jobsettings' to admin tabs

{tab==='timetracker'&&'‚è±Ô∏è Time Tracker Analytics'}
{tab==='jobsettings'&&'‚öôÔ∏è Job Settings'}

// ========================================
// ADD TO ADMIN VIEW RENDER (around line 385):
// ========================================
{activeTab==='timetracker'&&<AdminTimeTrackerAnalytics teachers={teachers} timeEntries={timeEntries}/>}
{activeTab==='jobsettings'&&<JobSettingsManagement jobSettings={jobSettings}/>}

// ========================================
// NEW COMPONENTS TO ADD BEFORE ReactDOM.render
// ========================================

// TIME TRACKER VIEW FOR TEACHERS
function TimeTrackerView({currentUser,timeEntries,jobSettings}){
  const[showModal,setShowModal]=useState(false);
  const[form,setForm]=useState({date:getTodayDate(),job:'',subjob:'',startTime:'',endTime:'',notes:''});
  const[editingEntry,setEditingEntry]=useState(null);

  const myEntries=timeEntries.filter(e=>e.teacherId===currentUser.afid).sort((a,b)=>b.date.localeCompare(a.date));

  const calculateDuration=(start,end)=>{
    if(!start||!end)return 0;
    const[sh,sm]=start.split(':').map(Number);
    const[eh,em]=end.split(':').map(Number);
    const startMins=sh*60+sm;
    const endMins=eh*60+em;
    return((endMins-startMins)/60).toFixed(2);
  };

  const openAddModal=()=>{
    setEditingEntry(null);
    setForm({date:getTodayDate(),job:'',subjob:'',startTime:'',endTime:'',notes:''});
    setShowModal(true);
  };

  const openEditModal=(entry)=>{
    setEditingEntry(entry);
    setForm({
      date:entry.date,
      job:entry.job,
      subjob:entry.subjob,
      startTime:entry.startTime,
      endTime:entry.endTime,
      notes:entry.notes||''
    });
    setShowModal(true);
  };

  const handleSave=async()=>{
    if(!form.date||!form.job||!form.subjob||!form.startTime||!form.endTime){
      alert('Please fill all required fields');
      return;
    }
    
    const duration=calculateDuration(form.startTime,form.endTime);
    if(duration<=0){
      alert('End time must be after start time');
      return;
    }

    try{
      const data={
        teacherId:currentUser.afid,
        teacherName:currentUser.name,
        school:currentUser.school,
        date:form.date,
        job:form.job,
        subjob:form.subjob,
        startTime:form.startTime,
        endTime:form.endTime,
        duration:parseFloat(duration),
        notes:form.notes,
        updatedAt:new Date().toISOString()
      };

      if(editingEntry){
        await db.collection('timeEntries').doc(editingEntry.id).update(data);
        alert('Time entry updated!');
      }else{
        data.createdAt=new Date().toISOString();
        await db.collection('timeEntries').add(data);
        alert('Time entry added!');
      }
      setShowModal(false);
    }catch(e){
      alert('Failed: '+e.message);
    }
  };

  const handleDelete=async(entry)=>{
    if(!confirm('Delete this time entry?'))return;
    try{
      await db.collection('timeEntries').doc(entry.id).delete();
      alert('Time entry deleted!');
    }catch(e){
      alert('Failed: '+e.message);
    }
  };

  const todayTotal=myEntries.filter(e=>e.date===getTodayDate()).reduce((sum,e)=>sum+e.duration,0).toFixed(2);
  const weekStart=new Date();
  weekStart.setDate(weekStart.getDate()-weekStart.getDay());
  const weekStartStr=weekStart.toISOString().split('T')[0];
  const weekTotal=myEntries.filter(e=>e.date>=weekStartStr).reduce((sum,e)=>sum+e.duration,0).toFixed(2);

  const monthStart=getTodayDate().slice(0,7)+'-01';
  const monthTotal=myEntries.filter(e=>e.date>=monthStart).reduce((sum,e)=>sum+e.duration,0).toFixed(2);

  return(
    <div className="space-y-6">
      <div className="flex justify-between items-center">
        <h2 className="text-3xl font-bold">‚è±Ô∏è Time Tracker</h2>
        <button onClick={openAddModal} className="px-6 py-3 bg-blue-600 text-white rounded-xl font-semibold">
          + Add Time Entry
        </button>
      </div>

      <div className="grid grid-cols-3 gap-4">
        <div className="stat-card bg-green-500 text-white">
          <div className="text-sm opacity-90">Today's Hours</div>
          <div className="text-4xl font-bold">{todayTotal}h</div>
        </div>
        <div className="stat-card bg-blue-500 text-white">
          <div className="text-sm opacity-90">This Week</div>
          <div className="text-4xl font-bold">{weekTotal}h</div>
        </div>
        <div className="stat-card bg-purple-500 text-white">
          <div className="text-sm opacity-90">This Month</div>
          <div className="text-4xl font-bold">{monthTotal}h</div>
        </div>
      </div>

      <div className="bg-white p-6 rounded-2xl shadow-lg">
        <h3 className="text-xl font-bold mb-4">üìã My Time Entries</h3>
        <div className="overflow-x-auto">
          <table className="w-full">
            <thead className="avanti-gradient-light">
              <tr>
                <th className="p-3 text-left">Date</th>
                <th className="p-3 text-left">Job</th>
                <th className="p-3 text-left">Sub Job</th>
                <th className="p-3 text-left">Time</th>
                <th className="p-3 text-left">Duration</th>
                <th className="p-3 text-left">Notes</th>
                <th className="p-3 text-left">Actions</th>
              </tr>
            </thead>
            <tbody>
              {myEntries.length===0?
                <tr><td colSpan="7" className="p-8 text-center text-gray-500">No time entries yet</td></tr>
              :
                myEntries.map(entry=>
                  <tr key={entry.id} className="border-b hover:bg-gray-50">
                    <td className="p-3">{entry.date}</td>
                    <td className="p-3 font-semibold">{entry.job}</td>
                    <td className="p-3">{entry.subjob}</td>
                    <td className="p-3 text-sm">{entry.startTime} - {entry.endTime}</td>
                    <td className="p-3 font-bold text-blue-600">{entry.duration}h</td>
                    <td className="p-3 text-sm">{entry.notes||'-'}</td>
                    <td className="p-3">
                      <div className="flex gap-2">
                        <button onClick={()=>openEditModal(entry)} className="px-3 py-1 bg-yellow-400 rounded-lg font-semibold">Edit</button>
                        <button onClick={()=>handleDelete(entry)} className="px-3 py-1 bg-red-500 text-white rounded-lg font-semibold">Delete</button>
                      </div>
                    </td>
                  </tr>
                )
              }
            </tbody>
          </table>
        </div>
      </div>

      {showModal&&(
        <div className="modal-overlay" onClick={()=>setShowModal(false)}>
          <div className="modal-content" onClick={e=>e.stopPropagation()}>
            <h3 className="text-2xl font-bold mb-4">{editingEntry?'Edit Time Entry':'Add Time Entry'}</h3>
            <div className="space-y-4">
              <div>
                <label className="block text-sm font-bold mb-1">Date *</label>
                <input type="date" value={form.date} onChange={e=>setForm({...form,date:e.target.value})} className="w-full border-2 px-3 py-2 rounded-lg"/>
              </div>
              <div>
                <label className="block text-sm font-bold mb-1">Job *</label>
                <select value={form.job} onChange={e=>setForm({...form,job:e.target.value,subjob:''})} className="w-full border-2 px-3 py-2 rounded-lg">
                  <option value="">Select Job</option>
                  {jobSettings.jobs.map(j=><option key={j} value={j}>{j}</option>)}
                </select>
              </div>
              {form.job&&(
                <div>
                  <label className="block text-sm font-bold mb-1">Sub Job *</label>
                  <select value={form.subjob} onChange={e=>setForm({...form,subjob:e.target.value})} className="w-full border-2 px-3 py-2 rounded-lg">
                    <option value="">Select Sub Job</option>
                    {(jobSettings.subjobs[form.job]||[]).map(sj=><option key={sj} value={sj}>{sj}</option>)}
                  </select>
                </div>
              )}
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-bold mb-1">Start Time *</label>
                  <input type="time" value={form.startTime} onChange={e=>setForm({...form,startTime:e.target.value})} className="w-full border-2 px-3 py-2 rounded-lg"/>
                </div>
                <div>
                  <label className="block text-sm font-bold mb-1">End Time *</label>
                  <input type="time" value={form.endTime} onChange={e=>setForm({...form,endTime:e.target.value})} className="w-full border-2 px-3 py-2 rounded-lg"/>
                </div>
              </div>
              {form.startTime&&form.endTime&&(
                <div className="bg-blue-50 p-3 rounded-lg">
                  <strong>Duration:</strong> {calculateDuration(form.startTime,form.endTime)} hours
                </div>
              )}
              <div>
                <label className="block text-sm font-bold mb-1">Notes</label>
                <textarea value={form.notes} onChange={e=>setForm({...form,notes:e.target.value})} className="w-full border-2 px-3 py-2 rounded-lg" rows="3" placeholder="Add any notes..."/>
              </div>
              <div className="flex gap-3">
                <button onClick={handleSave} className="flex-1 avanti-gradient text-white py-3 rounded-xl font-semibold">Save</button>
                <button onClick={()=>setShowModal(false)} className="flex-1 bg-gray-300 py-3 rounded-xl font-semibold">Cancel</button>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

// Continue in next part...
// ========================================
// TIME ANALYTICS VIEW FOR TEACHERS
// ========================================
function TimeAnalyticsView({currentUser,timeEntries,teachers}){
  const[filterPeriod,setFilterPeriod]=useState('month');
  const chart1Ref=useRef(null);
  const chart2Ref=useRef(null);
  const chart3Ref=useRef(null);
  const chartInstances=useRef({});

  const myEntries=timeEntries.filter(e=>e.teacherId===currentUser.afid);

  const getFilteredEntries=()=>{
    const today=getTodayDate();
    if(filterPeriod==='day'){
      return myEntries.filter(e=>e.date===today);
    }else if(filterPeriod==='week'){
      const weekStart=new Date();
      weekStart.setDate(weekStart.getDate()-weekStart.getDay());
      const weekStartStr=weekStart.toISOString().split('T')[0];
      return myEntries.filter(e=>e.date>=weekStartStr);
    }else{
      const monthStart=today.slice(0,7)+'-01';
      return myEntries.filter(e=>e.date>=monthStart);
    }
  };

  const filteredEntries=getFilteredEntries();

  const jobStats=useMemo(()=>{
    const stats={};
    filteredEntries.forEach(e=>{
      if(!stats[e.job]){
        stats[e.job]=0;
      }
      stats[e.job]+=e.duration;
    });
    return stats;
  },[filteredEntries]);

  const dailyStats=useMemo(()=>{
    const stats={};
    filteredEntries.forEach(e=>{
      if(!stats[e.date]){
        stats[e.date]=0;
      }
      stats[e.date]+=e.duration;
    });
    return stats;
  },[filteredEntries]);

  const schoolComparison=useMemo(()=>{
    const stats={};
    SCHOOLS.forEach(school=>{
      const schoolTeachers=teachers.filter(t=>t.school===school);
      const schoolEntries=timeEntries.filter(e=>{
        const teacher=teachers.find(t=>t.afid===e.teacherId);
        return teacher&&teacher.school===school;
      });
      const monthStart=getTodayDate().slice(0,7)+'-01';
      const monthEntries=schoolEntries.filter(e=>e.date>=monthStart);
      const total=monthEntries.reduce((sum,e)=>sum+e.duration,0);
      stats[school]={
        total:total,
        avg:schoolTeachers.length>0?(total/schoolTeachers.length).toFixed(2):0
      };
    });
    return stats;
  },[timeEntries,teachers]);

  const mySchoolRanking=useMemo(()=>{
    const rankings=Object.entries(schoolComparison)
      .map(([school,data])=>({school,total:data.total}))
      .sort((a,b)=>b.total-a.total);
    return rankings.findIndex(r=>r.school===currentUser.school)+1;
  },[schoolComparison,currentUser.school]);

  const totalHours=filteredEntries.reduce((sum,e)=>sum+e.duration,0).toFixed(2);

  useEffect(()=>{
    Object.values(chartInstances.current).forEach(chart=>{
      if(chart)chart.destroy();
    });
    chartInstances.current={};

    if(chart1Ref.current){
      const ctx=chart1Ref.current.getContext('2d');
      const jobs=Object.keys(jobStats);
      chartInstances.current.chart1=new Chart(ctx,{
        type:'pie',
        data:{
          labels:jobs,
          datasets:[{
            data:jobs.map(j=>jobStats[j]),
            backgroundColor:['#F4B41A','#3B82F6','#10B981','#EF4444','#8B5CF6','#F59E0B','#EC4899','#14B8A6']
          }]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            title:{display:true,text:`Hours by Job (${filterPeriod})`,font:{size:16,weight:'bold'}},
            legend:{position:'bottom'}
          }
        }
      });
    }

    if(chart2Ref.current&&filterPeriod!=='day'){
      const ctx=chart2Ref.current.getContext('2d');
      const dates=Object.keys(dailyStats).sort();
      chartInstances.current.chart2=new Chart(ctx,{
        type:'bar',
        data:{
          labels:dates.map(d=>new Date(d).getDate()),
          datasets:[{
            label:'Hours Worked',
            data:dates.map(d=>dailyStats[d]),
            backgroundColor:'#3B82F6',
            borderRadius:8
          }]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            title:{display:true,text:'Daily Hours',font:{size:16,weight:'bold'}},
            legend:{display:false}
          },
          scales:{y:{beginAtZero:true}}
        }
      });
    }

    if(chart3Ref.current){
      const ctx=chart3Ref.current.getContext('2d');
      const schools=Object.keys(schoolComparison);
      chartInstances.current.chart3=new Chart(ctx,{
        type:'bar',
        data:{
          labels:schools,
          datasets:[{
            label:'Average Hours per Teacher',
            data:schools.map(s=>schoolComparison[s].avg),
            backgroundColor:schools.map(s=>s===currentUser.school?'#C8342E':'#94A3B8'),
            borderRadius:8
          }]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            title:{display:true,text:'School Comparison (This Month)',font:{size:16,weight:'bold'}},
            legend:{display:false}
          },
          scales:{y:{beginAtZero:true}}
        }
      });
    }

    return()=>{
      Object.values(chartInstances.current).forEach(chart=>{
        if(chart)chart.destroy();
      });
    };
  },[jobStats,dailyStats,schoolComparison,filterPeriod,currentUser.school]);

  const handleExport=()=>{
    const exportData=filteredEntries.map(e=>({
      Date:e.date,
      Job:e.job,
      'Sub Job':e.subjob,
      'Start Time':e.startTime,
      'End Time':e.endTime,
      'Duration (hrs)':e.duration,
      Notes:e.notes||''
    }));
    exportToExcel(exportData,`time_entries_${currentUser.name}_${filterPeriod}`);
  };

  return(
    <div className="space-y-6">
      <div className="flex justify-between items-center">
        <h2 className="text-3xl font-bold">üìä Time Analytics</h2>
        <button onClick={handleExport} className="px-6 py-3 bg-green-600 text-white rounded-xl font-semibold">
          üì• Export
        </button>
      </div>

      <div className="bg-white p-6 rounded-2xl shadow-lg">
        <h3 className="text-xl font-bold mb-4">üîç Period</h3>
        <div className="flex gap-3">
          <button onClick={()=>setFilterPeriod('day')} className={`px-6 py-3 rounded-xl font-semibold ${filterPeriod==='day'?'avanti-gradient text-white':'bg-gray-200'}`}>
            Today
          </button>
          <button onClick={()=>setFilterPeriod('week')} className={`px-6 py-3 rounded-xl font-semibold ${filterPeriod==='week'?'avanti-gradient text-white':'bg-gray-200'}`}>
            This Week
          </button>
          <button onClick={()=>setFilterPeriod('month')} className={`px-6 py-3 rounded-xl font-semibold ${filterPeriod==='month'?'avanti-gradient text-white':'bg-gray-200'}`}>
            This Month
          </button>
        </div>
      </div>

      <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div className="stat-card avanti-gradient text-white">
          <div className="text-sm opacity-90">Total Hours</div>
          <div className="text-4xl font-bold">{totalHours}h</div>
        </div>
        <div className="stat-card bg-blue-500 text-white">
          <div className="text-sm opacity-90">Entries</div>
          <div className="text-4xl font-bold">{filteredEntries.length}</div>
        </div>
        <div className="stat-card bg-green-500 text-white">
          <div className="text-sm opacity-90">School Ranking</div>
          <div className="text-4xl font-bold">#{mySchoolRanking}</div>
        </div>
        <div className="stat-card bg-purple-500 text-white">
          <div className="text-sm opacity-90">Avg per Day</div>
          <div className="text-4xl font-bold">{Object.keys(dailyStats).length>0?(totalHours/Object.keys(dailyStats).length).toFixed(2):0}h</div>
        </div>
      </div>

      <div className="grid md:grid-cols-2 gap-6">
        <div className="bg-white p-6 rounded-2xl shadow-lg" style={{height:'350px'}}>
          <canvas ref={chart1Ref}></canvas>
        </div>
        {filterPeriod!=='day'&&(
          <div className="bg-white p-6 rounded-2xl shadow-lg" style={{height:'350px'}}>
            <canvas ref={chart2Ref}></canvas>
          </div>
        )}
      </div>

      <div className="bg-white p-6 rounded-2xl shadow-lg" style={{height:'400px'}}>
        <canvas ref={chart3Ref}></canvas>
      </div>

      <div className="bg-white p-6 rounded-2xl shadow-lg">
        <h3 className="text-xl font-bold mb-4">üèÜ School Rankings (Monthly Avg Hours per Teacher)</h3>
        <div className="space-y-3">
          {Object.entries(schoolComparison)
            .sort((a,b)=>b[1].total-a[1].total)
            .map(([school,data],index)=>
              <div key={school} className={`p-4 rounded-xl border-2 ${school===currentUser.school?'bg-yellow-50 border-yellow-400':'bg-gray-50 border-gray-200'}`}>
                <div className="flex justify-between items-center">
                  <div className="flex items-center gap-4">
                    <div className="text-2xl font-bold text-gray-400">#{index+1}</div>
                    <div>
                      <div className="font-bold text-lg">{school} {school===currentUser.school&&'‚≠ê'}</div>
                      <div className="text-sm text-gray-600">Total: {data.total.toFixed(2)}h</div>
                    </div>
                  </div>
                  <div className="text-3xl font-bold" style={{color:'var(--avanti-red)'}}>{data.avg}h</div>
                </div>
              </div>
            )
          }
        </div>
      </div>
    </div>
  );
}

// ========================================
// ADMIN TIME TRACKER ANALYTICS
// ========================================
function AdminTimeTrackerAnalytics({teachers,timeEntries}){
  const[filterSchool,setFilterSchool]=useState('All');
  const[filterTeacher,setFilterTeacher]=useState('All');
  const[filterPeriod,setFilterPeriod]=useState('month');

  const chart1Ref=useRef(null);
  const chart2Ref=useRef(null);
  const chart3Ref=useRef(null);
  const chart4Ref=useRef(null);
  const chartInstances=useRef({});

  const getDateRange=()=>{
    const today=getTodayDate();
    if(filterPeriod==='day'){
      return{start:today,end:today};
    }else if(filterPeriod==='week'){
      const weekStart=new Date();
      weekStart.setDate(weekStart.getDate()-weekStart.getDay());
      return{start:weekStart.toISOString().split('T')[0],end:today};
    }else{
      return{start:today.slice(0,7)+'-01',end:today};
    }
  };

  const dateRange=getDateRange();

  const filteredEntries=useMemo(()=>{
    return timeEntries.filter(e=>{
      if(e.date<dateRange.start||e.date>dateRange.end)return false;
      if(filterTeacher!=='All'&&e.teacherId!==filterTeacher)return false;
      if(filterSchool!=='All'){
        const teacher=teachers.find(t=>t.afid===e.teacherId);
        if(!teacher||teacher.school!==filterSchool)return false;
      }
      return true;
    });
  },[timeEntries,teachers,filterSchool,filterTeacher,dateRange]);

  const schoolStats=useMemo(()=>{
    const stats={};
    SCHOOLS.forEach(school=>{
      const schoolTeachers=teachers.filter(t=>t.school===school);
      const schoolEntries=timeEntries.filter(e=>{
        const teacher=teachers.find(t=>t.afid===e.teacherId);
        return teacher&&teacher.school===school&&e.date>=dateRange.start&&e.date<=dateRange.end;
      });
      const total=schoolEntries.reduce((sum,e)=>sum+e.duration,0);
      stats[school]={
        total:total,
        avg:schoolTeachers.length>0?(total/schoolTeachers.length).toFixed(2):0,
        teachers:schoolTeachers.length
      };
    });
    return stats;
  },[timeEntries,teachers,dateRange]);

  const jobStats=useMemo(()=>{
    const stats={};
    filteredEntries.forEach(e=>{
      if(!stats[e.job]){
        stats[e.job]=0;
      }
      stats[e.job]+=e.duration;
    });
    return stats;
  },[filteredEntries]);

  const teacherStats=useMemo(()=>{
    const stats={};
    filteredEntries.forEach(e=>{
      if(!stats[e.teacherId]){
        stats[e.teacherId]={
          name:e.teacherName,
          school:e.school,
          total:0,
          entries:0
        };
      }
      stats[e.teacherId].total+=e.duration;
      stats[e.teacherId].entries++;
    });
    return Object.entries(stats).map(([id,data])=>({id,...data})).sort((a,b)=>b.total-a.total);
  },[filteredEntries]);

  const dailyStats=useMemo(()=>{
    const stats={};
    filteredEntries.forEach(e=>{
      if(!stats[e.date]){
        stats[e.date]=0;
      }
      stats[e.date]+=e.duration;
    });
    return stats;
  },[filteredEntries]);

  const totalHours=filteredEntries.reduce((sum,e)=>sum+e.duration,0).toFixed(2);

  useEffect(()=>{
    Object.values(chartInstances.current).forEach(chart=>{
      if(chart)chart.destroy();
    });
    chartInstances.current={};

    if(chart1Ref.current){
      const ctx=chart1Ref.current.getContext('2d');
      const schools=Object.keys(schoolStats);
      chartInstances.current.chart1=new Chart(ctx,{
        type:'bar',
        data:{
          labels:schools,
          datasets:[{
            label:'Average Hours per Teacher',
            data:schools.map(s=>schoolStats[s].avg),
            backgroundColor:'#C8342E',
            borderRadius:8
          }]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            title:{display:true,text:'School Comparison (Avg Hours)',font:{size:16,weight:'bold'}},
            legend:{display:false}
          },
          scales:{y:{beginAtZero:true}}
        }
      });
    }

    if(chart2Ref.current){
      const ctx=chart2Ref.current.getContext('2d');
      const jobs=Object.keys(jobStats);
      chartInstances.current.chart2=new Chart(ctx,{
        type:'doughnut',
        data:{
          labels:jobs,
          datasets:[{
            data:jobs.map(j=>jobStats[j]),
            backgroundColor:['#F4B41A','#3B82F6','#10B981','#EF4444','#8B5CF6','#F59E0B','#EC4899','#14B8A6']
          }]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            title:{display:true,text:'Hours by Job Type',font:{size:16,weight:'bold'}},
            legend:{position:'bottom'}
          }
        }
      });
    }

    if(chart3Ref.current&&filterPeriod!=='day'){
      const ctx=chart3Ref.current.getContext('2d');
      const dates=Object.keys(dailyStats).sort();
      chartInstances.current.chart3=new Chart(ctx,{
        type:'line',
        data:{
          labels:dates.map(d=>new Date(d).getDate()),
          datasets:[{
            label:'Total Hours',
            data:dates.map(d=>dailyStats[d]),
            borderColor:'#3B82F6',
            backgroundColor:'rgba(59,130,246,0.1)',
            tension:0.4,
            fill:true
          }]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            title:{display:true,text:'Daily Trend',font:{size:16,weight:'bold'}},
            legend:{display:false}
          },
          scales:{y:{beginAtZero:true}}
        }
      });
    }

    if(chart4Ref.current){
      const ctx=chart4Ref.current.getContext('2d');
      const topTeachers=teacherStats.slice(0,10);
      chartInstances.current.chart4=new Chart(ctx,{
        type:'bar',
        data:{
          labels:topTeachers.map(t=>t.name),
          datasets:[{
            label:'Hours Worked',
            data:topTeachers.map(t=>t.total),
            backgroundColor:'#10B981',
            borderRadius:8
          }]
        },
        options:{
          indexAxis:'y',
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            title:{display:true,text:'Top 10 Teachers (Hours)',font:{size:16,weight:'bold'}},
            legend:{display:false}
          },
          scales:{x:{beginAtZero:true}}
        }
      });
    }

    return()=>{
      Object.values(chartInstances.current).forEach(chart=>{
        if(chart)chart.destroy();
      });
    };
  },[schoolStats,jobStats,dailyStats,teacherStats,filterPeriod]);

  const handleExport=()=>{
    const exportData=filteredEntries.map(e=>({
      Date:e.date,
      Teacher:e.teacherName,
      School:e.school,
      Job:e.job,
      'Sub Job':e.subjob,
      'Start Time':e.startTime,
      'End Time':e.endTime,
      'Duration (hrs)':e.duration,
      Notes:e.notes||''
    }));
    exportToExcel(exportData,`admin_time_entries_${filterPeriod}`);
  };

  return(
    <div className="space-y-6">
      <div className="flex justify-between items-center">
        <h2 className="text-3xl font-bold">‚è±Ô∏è Time Tracker Analytics</h2>
        <button onClick={handleExport} className="px-6 py-3 bg-green-600 text-white rounded-xl font-semibold">
          üì• Export
        </button>
      </div>

      <div className="bg-white p-6 rounded-2xl shadow-lg">
        <h3 className="text-xl font-bold mb-4">üîç Filters</h3>
        <div className="grid md:grid-cols-3 gap-4 mb-4">
          <div>
            <label className="block text-sm font-bold mb-2">School</label>
            <select value={filterSchool} onChange={e=>setFilterSchool(e.target.value)} className="w-full border-2 px-4 py-3 rounded-xl">
              <option value="All">All Schools</option>
              {SCHOOLS.map(s=><option key={s} value={s}>{s}</option>)}
            </select>
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">Teacher</label>
            <select value={filterTeacher} onChange={e=>setFilterTeacher(e.target.value)} className="w-full border-2 px-4 py-3 rounded-xl">
              <option value="All">All Teachers</option>
              {teachers.map(t=><option key={t.afid} value={t.afid}>{t.name} ({t.school})</option>)}
            </select>
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">Period</label>
            <select value={filterPeriod} onChange={e=>setFilterPeriod(e.target.value)} className="w-full border-2 px-4 py-3 rounded-xl">
              <option value="day">Today</option>
              <option value="week">This Week</option>
              <option value="month">This Month</option>
            </select>
          </div>
        </div>
      </div>

      <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div className="stat-card avanti-gradient text-white">
          <div className="text-sm opacity-90">Total Hours</div>
          <div className="text-4xl font-bold">{totalHours}h</div>
        </div>
        <div className="stat-card bg-blue-500 text-white">
          <div className="text-sm opacity-90">Total Entries</div>
          <div className="text-4xl font-bold">{filteredEntries.length}</div>
        </div>
        <div className="stat-card bg-green-500 text-white">
          <div className="text-sm opacity-90">Active Teachers</div>
          <div className="text-4xl font-bold">{teacherStats.length}</div>
        </div>
        <div className="stat-card bg-purple-500 text-white">
          <div className="text-sm opacity-90">Avg per Teacher</div>
          <div className="text-4xl font-bold">{teacherStats.length>0?(totalHours/teacherStats.length).toFixed(2):0}h</div>
        </div>
      </div>

      <div className="grid md:grid-cols-2 gap-6">
        <div className="bg-white p-6 rounded-2xl shadow-lg" style={{height:'350px'}}>
          <canvas ref={chart1Ref}></canvas>
        </div>
        <div className="bg-white p-6 rounded-2xl shadow-lg" style={{height:'350px'}}>
          <canvas ref={chart2Ref}></canvas>
        </div>
        {filterPeriod!=='day'&&(
          <div className="bg-white p-6 rounded-2xl shadow-lg" style={{height:'350px'}}>
            <canvas ref={chart3Ref}></canvas>
          </div>
        )}
        <div className="bg-white p-6 rounded-2xl shadow-lg" style={{height:'350px'}}>
          <canvas ref={chart4Ref}></canvas>
        </div>
      </div>

      <div className="bg-white p-6 rounded-2xl shadow-lg">
        <h3 className="text-xl font-bold mb-4">üìä School Rankings</h3>
        <div className="space-y-3">
          {Object.entries(schoolStats)
            .sort((a,b)=>b[1].total-a[1].total)
            .map(([school,data],index)=>
              <div key={school} className={`p-4 rounded-xl border-2 ${index===0?'border-yellow-400 bg-yellow-50':index===1?'border-gray-300 bg-gray-50':index===2?'border-orange-300 bg-orange-50':'border-gray-200 bg-gray-50'}`}>
                <div className="flex justify-between items-center">
                  <div className="flex items-center gap-4">
                    <div className="text-2xl font-bold text-gray-400">#{index+1}</div>
                    <div>
                      <div className="font-bold text-lg">{school}</div>
                      <div className="text-sm text-gray-600">Total: {data.total.toFixed(2)}h | Teachers: {data.teachers}</div>
                    </div>
                  </div>
                  <div className="text-3xl font-bold" style={{color:'var(--avanti-red)'}}>{data.avg}h</div>
                </div>
              </div>
            )
          }
        </div>
      </div>

      <div className="bg-white p-6 rounded-2xl shadow-lg overflow-x-auto">
        <h3 className="text-xl font-bold mb-4">üë• Teacher Performance</h3>
        <table className="w-full">
          <thead className="avanti-gradient-light">
            <tr>
              <th className="p-3 text-left">Rank</th>
              <th className="p-3 text-left">Teacher</th>
              <th className="p-3 text-left">School</th>
              <th className="p-3 text-left">Total Hours</th>
              <th className="p-3 text-left">Entries</th>
              <th className="p-3 text-left">Avg per Entry</th>
            </tr>
          </thead>
          <tbody>
            {teacherStats.map((t,idx)=>
              <tr key={t.id} className="border-b hover:bg-gray-50">
                <td className="p-3 font-bold text-gray-400">#{idx+1}</td>
                <td className="p-3 font-semibold">{t.name}</td>
                <td className="p-3">{t.school}</td>
                <td className="p-3 font-bold text-blue-600">{t.total.toFixed(2)}h</td>
                <td className="p-3">{t.entries}</td>
                <td className="p-3">{(t.total/t.entries).toFixed(2)}h</td>
              </tr>
            )}
          </tbody>
        </table>
      </div>
    </div>
  );
}

// Continue in next part with Job Settings Management...
// ========================================
// JOB SETTINGS MANAGEMENT (ADMIN)
// ========================================
function JobSettingsManagement({jobSettings}){
  const[jobs,setJobs]=useState(jobSettings.jobs||[]);
  const[subjobs,setSubjobs]=useState(jobSettings.subjobs||{});
  const[newJob,setNewJob]=useState('');
  const[selectedJob,setSelectedJob]=useState('');
  const[newSubjob,setNewSubjob]=useState('');
  const[editingJob,setEditingJob]=useState(null);
  const[editJobName,setEditJobName]=useState('');

  useEffect(()=>{
    setJobs(jobSettings.jobs||[]);
    setSubjobs(jobSettings.subjobs||{});
  },[jobSettings]);

  const handleAddJob=async()=>{
    if(!newJob.trim()){
      alert('Please enter a job name');
      return;
    }
    if(jobs.includes(newJob.trim())){
      alert('Job already exists');
      return;
    }
    try{
      const updatedJobs=[...jobs,newJob.trim()];
      const updatedSubjobs={...subjobs,[newJob.trim()]:[]};
      await db.collection('settings').doc('jobSettings').set({
        jobs:updatedJobs,
        subjobs:updatedSubjobs
      });
      setNewJob('');
      alert('Job added successfully!');
    }catch(e){
      alert('Failed: '+e.message);
    }
  };

  const handleUpdateJob=async()=>{
    if(!editJobName.trim()){
      alert('Please enter a job name');
      return;
    }
    if(editJobName.trim()===editingJob){
      setEditingJob(null);
      return;
    }
    if(jobs.includes(editJobName.trim())&&editJobName.trim()!==editingJob){
      alert('Job name already exists');
      return;
    }
    try{
      const updatedJobs=jobs.map(j=>j===editingJob?editJobName.trim():j);
      const updatedSubjobs={...subjobs};
      if(editingJob!==editJobName.trim()){
        updatedSubjobs[editJobName.trim()]=updatedSubjobs[editingJob];
        delete updatedSubjobs[editingJob];
      }
      await db.collection('settings').doc('jobSettings').set({
        jobs:updatedJobs,
        subjobs:updatedSubjobs
      });
      setEditingJob(null);
      setEditJobName('');
      alert('Job updated successfully!');
    }catch(e){
      alert('Failed: '+e.message);
    }
  };

  const handleDeleteJob=async(job)=>{
    if(!confirm(`Delete job "${job}" and all its sub-jobs?`))return;
    try{
      const updatedJobs=jobs.filter(j=>j!==job);
      const updatedSubjobs={...subjobs};
      delete updatedSubjobs[job];
      await db.collection('settings').doc('jobSettings').set({
        jobs:updatedJobs,
        subjobs:updatedSubjobs
      });
      alert('Job deleted successfully!');
    }catch(e){
      alert('Failed: '+e.message);
    }
  };

  const handleAddSubjob=async()=>{
    if(!selectedJob){
      alert('Please select a job first');
      return;
    }
    if(!newSubjob.trim()){
      alert('Please enter a sub-job name');
      return;
    }
    if((subjobs[selectedJob]||[]).includes(newSubjob.trim())){
      alert('Sub-job already exists');
      return;
    }
    try{
      const updatedSubjobs={
        ...subjobs,
        [selectedJob]:[...(subjobs[selectedJob]||[]),newSubjob.trim()]
      };
      await db.collection('settings').doc('jobSettings').set({
        jobs,
        subjobs:updatedSubjobs
      });
      setNewSubjob('');
      alert('Sub-job added successfully!');
    }catch(e){
      alert('Failed: '+e.message);
    }
  };

  const handleDeleteSubjob=async(job,subjob)=>{
    if(!confirm(`Delete sub-job "${subjob}"?`))return;
    try{
      const updatedSubjobs={
        ...subjobs,
        [job]:(subjobs[job]||[]).filter(sj=>sj!==subjob)
      };
      await db.collection('settings').doc('jobSettings').set({
        jobs,
        subjobs:updatedSubjobs
      });
      alert('Sub-job deleted successfully!');
    }catch(e){
      alert('Failed: '+e.message);
    }
  };

  const handleResetDefaults=async()=>{
    if(!confirm('Reset to default job settings? This will replace all current jobs and sub-jobs.'))return;
    try{
      await db.collection('settings').doc('jobSettings').set({
        jobs:DEFAULT_JOBS,
        subjobs:DEFAULT_SUBJOBS
      });
      alert('Reset to defaults successfully!');
    }catch(e){
      alert('Failed: '+e.message);
    }
  };

  return(
    <div className="space-y-6">
      <div className="flex justify-between items-center">
        <h2 className="text-3xl font-bold">‚öôÔ∏è Job Settings Management</h2>
        <button onClick={handleResetDefaults} className="px-6 py-3 bg-red-600 text-white rounded-xl font-semibold">
          üîÑ Reset to Defaults
        </button>
      </div>

      <div className="grid md:grid-cols-2 gap-6">
        <div className="bg-white p-6 rounded-2xl shadow-lg">
          <h3 className="text-xl font-bold mb-4">‚ûï Add New Job</h3>
          <div className="flex gap-2">
            <input 
              type="text" 
              value={newJob} 
              onChange={e=>setNewJob(e.target.value)} 
              onKeyPress={e=>e.key==='Enter'&&handleAddJob()}
              className="flex-1 border-2 px-4 py-3 rounded-xl" 
              placeholder="Enter job name"
            />
            <button onClick={handleAddJob} className="px-6 py-3 bg-blue-600 text-white rounded-xl font-semibold">
              Add
            </button>
          </div>
        </div>

        <div className="bg-white p-6 rounded-2xl shadow-lg">
          <h3 className="text-xl font-bold mb-4">‚ûï Add Sub-Job</h3>
          <div className="space-y-3">
            <select 
              value={selectedJob} 
              onChange={e=>setSelectedJob(e.target.value)} 
              className="w-full border-2 px-4 py-3 rounded-xl"
            >
              <option value="">Select Job</option>
              {jobs.map(j=><option key={j} value={j}>{j}</option>)}
            </select>
            <div className="flex gap-2">
              <input 
                type="text" 
                value={newSubjob} 
                onChange={e=>setNewSubjob(e.target.value)} 
                onKeyPress={e=>e.key==='Enter'&&handleAddSubjob()}
                className="flex-1 border-2 px-4 py-3 rounded-xl" 
                placeholder="Enter sub-job name"
                disabled={!selectedJob}
              />
              <button 
                onClick={handleAddSubjob} 
                disabled={!selectedJob}
                className="px-6 py-3 bg-green-600 text-white rounded-xl font-semibold disabled:opacity-50"
              >
                Add
              </button>
            </div>
          </div>
        </div>
      </div>

      <div className="bg-white p-6 rounded-2xl shadow-lg">
        <h3 className="text-xl font-bold mb-4">üìã Current Jobs & Sub-Jobs</h3>
        <div className="space-y-4">
          {jobs.length===0?
            <p className="text-gray-500 text-center py-8">No jobs configured</p>
          :
            jobs.map(job=>
              <div key={job} className="border-2 rounded-xl p-4 hover:bg-gray-50">
                <div className="flex justify-between items-start mb-3">
                  {editingJob===job?
                    <div className="flex-1 flex gap-2">
                      <input 
                        type="text" 
                        value={editJobName} 
                        onChange={e=>setEditJobName(e.target.value)} 
                        className="flex-1 border-2 px-3 py-2 rounded-lg"
                      />
                      <button onClick={handleUpdateJob} className="px-4 py-2 bg-green-600 text-white rounded-lg font-semibold">
                        Save
                      </button>
                      <button onClick={()=>{setEditingJob(null);setEditJobName('')}} className="px-4 py-2 bg-gray-300 rounded-lg font-semibold">
                        Cancel
                      </button>
                    </div>
                  :
                    <>
                      <h4 className="text-lg font-bold">{job}</h4>
                      <div className="flex gap-2">
                        <button 
                          onClick={()=>{setEditingJob(job);setEditJobName(job)}} 
                          className="px-3 py-1 bg-yellow-400 rounded-lg font-semibold"
                        >
                          Edit
                        </button>
                        <button 
                          onClick={()=>handleDeleteJob(job)} 
                          className="px-3 py-1 bg-red-500 text-white rounded-lg font-semibold"
                        >
                          Delete
                        </button>
                      </div>
                    </>
                  }
                </div>
                <div className="ml-4">
                  <p className="text-sm font-semibold text-gray-600 mb-2">Sub-Jobs ({(subjobs[job]||[]).length}):</p>
                  {(subjobs[job]||[]).length===0?
                    <p className="text-sm text-gray-400 italic">No sub-jobs</p>
                  :
                    <div className="space-y-2">
                      {(subjobs[job]||[]).map(sj=>
                        <div key={sj} className="flex justify-between items-center p-2 bg-gray-50 rounded-lg">
                          <span className="text-sm">{sj}</span>
                          <button 
                            onClick={()=>handleDeleteSubjob(job,sj)} 
                            className="px-2 py-1 bg-red-400 text-white rounded text-xs font-semibold"
                          >
                            Delete
                          </button>
                        </div>
                      )}
                    </div>
                  }
                </div>
              </div>
            )
          }
        </div>
      </div>

      <div className="bg-blue-50 border-2 border-blue-300 p-6 rounded-xl">
        <h4 className="font-bold text-blue-800 mb-2">üí° Tips:</h4>
        <ul className="text-sm text-blue-700 space-y-1">
          <li>‚Ä¢ Jobs are the main categories (e.g., Teaching, Meetings)</li>
          <li>‚Ä¢ Sub-jobs are specific activities under each job</li>
          <li>‚Ä¢ Teachers will see these options when adding time entries</li>
          <li>‚Ä¢ Deleting a job will also delete all its sub-jobs</li>
          <li>‚Ä¢ Use "Reset to Defaults" to restore the original configuration</li>
        </ul>
      </div>
    </div>
  );
}
ReactDOM.render(<App/>,document.getElementById('root'));
  </script>
</body>
</html>
