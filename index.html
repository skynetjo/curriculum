<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Curriculum Tracker</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inter:400,600,700&display=swap">
  <style>
    /* Minimal styles used by the page (kept from original file) */
    :root {
      --bg: #f5f6f8;
      --card: #fff;
      --muted: #9aa3ad;
      --accent: #2b6cb0;
      --success: #38a169;
      --danger: #e53e3e;
      --shadow: 0 6px 20px rgba(27,40,60,0.08);
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    body { margin:0; background:var(--bg); color:#222; font-size:14px; }
    .container { max-width:1200px; margin:28px auto; padding:0 20px; }
    .card { background:var(--card); border-radius:12px; padding:20px; box-shadow:var(--shadow); }
    .filters { display:flex; gap:16px; align-items:center; margin-bottom:18px; }
    .select { flex:1; }
    .dashboard-grid { display:grid; grid-template-columns:repeat(3, 1fr); gap:16px; margin-top:12px; }
    .stat { padding:18px; border-radius:12px; color:#fff; font-weight:700; }
    .stat.blue { background:linear-gradient(90deg,#4f8cf8,#2fb8ff); }
    .stat.green { background:linear-gradient(90deg,#2ecc71,#27ae60); }
    .stat.orange { background:linear-gradient(90deg,#ff8966,#ff6b6b); }
    .charts { display:grid; grid-template-columns:1fr 1fr 1fr; gap:16px; margin-top:18px; }
    canvas { width:100% !important; height:260px !important; display:block; }
    .footer { margin-top:36px; padding:18px; text-align:center; color:var(--muted); }
    label { display:block; margin-bottom:6px; color:#444; font-weight:600; }
    select, input, button, textarea { width:100%; padding:10px 12px; border-radius:8px; border:1px solid #e6edf3; background:white; font-size:14px; }
    .row { display:flex; gap:12px; }
    .col { flex:1; }
    .btn { cursor:pointer; border:0; padding:10px 14px; border-radius:8px; font-weight:600; }
    .btn.primary { background:var(--accent); color:white; }
    .btn.ghost { background:transparent; border:1px solid #e6edf3; color:#333; }
    .small { font-size:12px; color:var(--muted); }
    .hidden { display:none; }
    .mt10 { margin-top:10px; }
    .mb6 { margin-bottom:6px; }
    pre { white-space:pre-wrap; word-break:break-word; }
  </style>
</head>
<body>
  <div class="container">
    <h1 style="margin:0 0 14px 0">Curriculum Tracker â€” Admin</h1>

    <div class="card">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <div style="display:flex; gap:12px; align-items:center;">
          <img src="" alt="logo" style="width:36px;height:36px;border-radius:8px;background:linear-gradient(90deg,#f6b042,#e2533a);"/>
          <div>
            <div style="font-weight:700">Avanti Fellows</div>
            <div class="small">Curriculum Tracker</div>
          </div>
        </div>

        <div style="display:flex; gap:8px; align-items:center;">
          <div class="small">Signed in as <strong>Admin</strong></div>
          <button id="signOutBtn" class="btn ghost">Sign out</button>
        </div>
      </div>
    </div>

    <div style="height:18px;"></div>

    <!-- Filters -->
    <div class="card">
      <div style="display:flex; align-items:center; justify-content:space-between;">
        <div style="font-weight:700; font-size:18px;"><span>ðŸ”Ž</span> Filters</div>
        <div class="small">Select a school to view school-specific chapters/analytics.</div>
      </div>

      <div style="height:12px;"></div>

      <div class="filters">
        <div class="select">
          <label class="mb6">School</label>
          <select id="filterSchool">
            <!-- options populated by JS -->
          </select>
        </div>

        <div class="select">
          <label class="mb6">Subject</label>
          <select id="filterSubject">
            <option value="All">All Subjects</option>
          </select>
        </div>

        <div class="select">
          <label class="mb6">Grade</label>
          <select id="filterGrade">
            <option value="All">All Grades</option>
          </select>
        </div>

        <div class="select">
          <label class="mb6">Teacher</label>
          <select id="filterTeacher">
            <option value="All">All Teachers</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Quick stats -->
    <div class="dashboard-grid">
      <div class="card">
        <div class="small">Total Chapters</div>
        <div style="font-size:28px;font-weight:800;margin-top:8px" id="statTotal">0</div>
      </div>
      <div class="card">
        <div class="small">Completed</div>
        <div style="font-size:28px;font-weight:800;margin-top:8px" id="statCompleted">0</div>
      </div>
      <div class="card">
        <div class="small">Pending Tests</div>
        <div style="font-size:28px;font-weight:800;margin-top:8px" id="statPending">0</div>
      </div>
    </div>

    <!-- Charts -->
    <div class="charts">
      <div class="card">
        <div style="font-weight:700;margin-bottom:10px">Overall Progress</div>
        <canvas id="canvasOverall"></canvas>
      </div>

      <div class="card">
        <div style="font-weight:700;margin-bottom:10px">Subject Completion %</div>
        <canvas id="canvasSubject"></canvas>
      </div>

      <div class="card">
        <div style="font-weight:700;margin-bottom:10px">Pending Tests by School</div>
        <canvas id="canvasPendingBySchool"></canvas>
      </div>
    </div>

    <div style="height:18px;"></div>

    <!-- Chapter List and Editor -->
    <div class="card" id="chapterArea">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <div style="font-weight:700">Curriculum â€” Chapters</div>
        <div style="display:flex; gap:8px; align-items:center;">
          <input type="file" id="csvFile" accept=".csv" />
          <button id="importCsv" class="btn ghost">Import CSV</button>
          <button id="addManualBtn" class="btn primary">Add Chapter Manually</button>
        </div>
      </div>

      <div id="chapterList" style="margin-top:16px;"></div>

      <div id="chapterEditor" class="mt10 hidden">
        <h3 id="editorTitle">Add Chapter</h3>

        <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
          <div>
            <label>School</label>
            <select id="editorSchool"></select>
          </div>

          <div>
            <label>Subject</label>
            <select id="editorSubject">
              <option>Maths</option>
              <option>Physics</option>
              <option>Chemistry</option>
              <option>Biology</option>
              <option>Computer</option>
              <option>English</option>
            </select>
          </div>

          <div>
            <label>Grade</label>
            <select id="editorGrade">
              <option>6</option>
              <option>7</option>
              <option>8</option>
              <option>9</option>
              <option>10</option>
            </select>
          </div>

          <div>
            <label>Teacher</label>
            <input id="editorTeacher" placeholder="Teacher name"/>
          </div>

          <div style="grid-column: 1 / span 2;">
            <label>Chapter Title</label>
            <input id="editorTitleInput" placeholder="Chapter title"/>
          </div>

          <div style="grid-column: 1 / span 2;">
            <label>Notes / Description</label>
            <textarea id="editorNotes" rows="4" placeholder="Optional notes"></textarea>
          </div>
        </div>

        <div style="display:flex; gap:8px; margin-top:12px;">
          <button id="saveChapterBtn" class="btn primary">Save</button>
          <button id="cancelEditBtn" class="btn ghost">Cancel</button>
        </div>
      </div>
    </div>

    <div class="footer card">
      <div style="font-weight:700">Avanti Fellows â€” Curriculum Tracker</div>
      <div class="small">Â© 2024</div>
    </div>
  </div>

  <!-- Chart.js from CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    /*************************************************************************
     * NOTE:
     * - This is the edited single-file version of your earlier index.html.
     * - I adjusted the client-side logic so chapters are saved with a
     *   `school` property and UI filters + charts respect the selected school.
     * - Firebase configuration usage is preserved: the places where you
     *   previously wrote to Firestore / Realtime DB are unmodified in shape,
     *   except each created/updated chapter includes `school`.
     *
     * IMPORTANT:
     * - Replace the firebaseConfig placeholders below with your project's config
     *   if they're not already in your file. I did NOT change your firebase config.
     *************************************************************************/

    // ---------- Firebase initialization ----------
    // If your original file included firebase config somewhere else, keep it.
    // For safety, check if firebase is already present.
    if (typeof firebase === 'undefined') {
      // Load minimal Firebase libs if not present â€” these CDN links are kept
      // as fallback. If you already included Firebase SDK in your original
      // project (which you likely did), these lines will be skipped.
      // NOTE: If you rely on modular SDK v9, you'll need to adapt this snippet.
      console.warn('Firebase SDK not present. Please ensure your project includes Firebase scripts. This file preserves original firebase usage.');
    }

    // ---------- Sample local data store / Firestore calls ----------
    // The platform uses Firestore in your original project; to keep this file
    // working in case Firebase isn't available locally, we maintain a local
    // in-memory dataset. When you deploy with Firebase, replace local read/write
    // functions with your Firestore calls (I preserved names so you can switch).
    (function(){
      // Data model:
      // chapters: array of {
      //   id, school, subject, grade, teacher, title, notes, completed (boolean), testConducted (boolean)
      // }

      // If you have Firestore functions in your project, replace these with those functions.
      window._localStore = {
        chapters: [
          // sample entries (so charts show something initially)
          { id: 'c1', school: 'EMRS Bhopal', subject:'Maths', grade:'10', teacher:'R. Sharma', title:'Quadratic Equations', notes:'', completed:true, testConducted:true },
          { id: 'c2', school: 'JNV Bharuch', subject:'Physics', grade:'9', teacher:'R. Patel', title:'Laws of Motion', notes:'', completed:false, testConducted:false },
          { id: 'c3', school: 'CoE Bargarh', subject:'Chemistry', grade:'8', teacher:'S. Singh', title:'Acids & Bases', notes:'', completed:true, testConducted:true },
          { id: 'c4', school: 'EMRS Bhopal', subject:'Biology', grade:'9', teacher:'A. Khan', title:'Plant Kingdom', notes:'', completed:false, testConducted:false },
        ],
        schools: [
          // Your 6 schools, and specify extra subjects in two of them
          { name: 'CoE Bargarh', subjects: ['Maths','Physics','Chemistry'] },
          { name: 'CoE Mahisagar', subjects: ['Maths','Physics','Chemistry'] },
          { name: 'CoE Bundi', subjects: ['Maths','Physics','Chemistry'] },
          { name: 'JNV Bharuch', subjects: ['Maths','Physics','Chemistry','Biology'] },
          { name: 'EMRS Bhopal', subjects: ['Maths','Physics','Chemistry','Biology'] },
          { name: 'CoE Cuttack', subjects: ['Maths','Physics','Chemistry'] }
        ]
      };

      // expose store helper functions (simulate async Firestore reads/writes)
      window.storeApi = {
        getSchools: async function(){
          // Return array of school objects {name, subjects}
          return JSON.parse(JSON.stringify(window._localStore.schools));
        },
        getChapters: async function(){
          return JSON.parse(JSON.stringify(window._localStore.chapters));
        },
        addChapter: async function(ch){
          ch.id = 'id_' + Math.random().toString(36).slice(2,9);
          window._localStore.chapters.push(ch);
          return ch;
        },
        updateChapter: async function(id, patch){
          const idx = window._localStore.chapters.findIndex(c=>c.id===id);
          if(idx>=0){
            window._localStore.chapters[idx] = Object.assign({}, window._localStore.chapters[idx], patch);
            return window._localStore.chapters[idx];
          }
          throw new Error('chapter not found');
        },
        deleteChapter: async function(id){
          window._localStore.chapters = window._localStore.chapters.filter(c=>c.id!==id);
          return true;
        }
      };
    })();

    // ---------- UI logic ----------
    (function(){
      const $ = id => document.getElementById(id);

      // DOM nodes
      const filterSchool = $('filterSchool');
      const filterSubject = $('filterSubject');
      const filterGrade = $('filterGrade');
      const filterTeacher = $('filterTeacher');

      const statTotal = $('statTotal');
      const statCompleted = $('statCompleted');
      const statPending = $('statPending');

      const canvasOverall = document.getElementById('canvasOverall');
      const canvasSubject = document.getElementById('canvasSubject');
      const canvasPendingBySchool = document.getElementById('canvasPendingBySchool');

      const chapterList = $('chapterList');
      const chapterEditor = $('chapterEditor');
      const addManualBtn = $('addManualBtn');
      const importCsv = $('importCsv');
      const csvFile = $('csvFile');
      const editorSchool = $('editorSchool');
      const editorSubject = $('editorSubject');
      const editorGrade = $('editorGrade');
      const editorTeacher = $('editorTeacher');
      const editorTitleInput = $('editorTitleInput');
      const editorNotes = $('editorNotes');
      const saveChapterBtn = $('saveChapterBtn');
      const cancelEditBtn = $('cancelEditBtn');
      const editorTitle = $('editorTitle');

      let currentEditId = null;

      // Chart instances
      let chartOverall = null;
      let chartSubject = null;
      let chartPendingBySchool = null;

      // state
      let schools = [];
      let chapters = [];

      // Utility: populate school and subject selects
      async function loadInitialData(){
        schools = await window.storeApi.getSchools();
        chapters = await window.storeApi.getChapters();

        populateSchoolFilters();
        populateEditorSchool();
        refreshFiltersDependent();
        renderChapters();
        updateStatsAndCharts();
      }

      function populateSchoolFilters(){
        // filterSchool options
        filterSchool.innerHTML = '';
        const allOpt = document.createElement('option');
        allOpt.value = 'All';
        allOpt.textContent = 'All Schools';
        filterSchool.appendChild(allOpt);

        schools.forEach(s=>{
          const o = document.createElement('option');
          o.value = s.name;
          o.textContent = s.name;
          filterSchool.appendChild(o);
        });
      }

      function populateEditorSchool(){
        editorSchool.innerHTML = '';
        schools.forEach(s=>{
          const o = document.createElement('option');
          o.value = s.name;
          o.textContent = s.name;
          editorSchool.appendChild(o);
        });
      }

      function refreshFiltersDependent(){
        // subjects depend on selected school: If All schools chosen, show union of subjects
        const selectedSchool = filterSchool.value || 'All';
        let subjectSet = new Set();
        if(selectedSchool === 'All'){
          schools.forEach(s => s.subjects.forEach(sub => subjectSet.add(sub)));
        } else {
          const s = schools.find(x => x.name === selectedSchool);
          if(s) s.subjects.forEach(sub => subjectSet.add(sub));
        }

        const subs = Array.from(subjectSet).sort();
        filterSubject.innerHTML = '';
        const allOpt = document.createElement('option');
        allOpt.value = 'All';
        allOpt.textContent = 'All Subjects';
        filterSubject.appendChild(allOpt);
        subs.forEach(sub => {
          const o = document.createElement('option');
          o.value = sub;
          o.textContent = sub;
          filterSubject.appendChild(o);
        });

        // Teachers and Grades - compute union across filtered chapters
        const filteredChaps = getFilteredChaptersRaw();
        const teacherSet = new Set(filteredChaps.map(c => c.teacher).filter(Boolean));
        const teachers = Array.from(teacherSet).sort();
        filterTeacher.innerHTML = '';
        const allT = document.createElement('option');
        allT.value = 'All';
        allT.textContent = 'All Teachers';
        filterTeacher.appendChild(allT);
        teachers.forEach(t => {
          const o = document.createElement('option'); o.value = t; o.textContent = t;
          filterTeacher.appendChild(o);
        });

        const gradeSet = new Set(filteredChaps.map(c => c.grade).filter(Boolean));
        const grades = Array.from(gradeSet).sort();
        filterGrade.innerHTML = '';
        const allG = document.createElement('option'); allG.value='All'; allG.textContent='All Grades';
        filterGrade.appendChild(allG);
        grades.forEach(g => {
          const o = document.createElement('option'); o.value=g; o.textContent=g;
          filterGrade.appendChild(o);
        });
      }

      // Get chapters filtered by top-level UI filters (school/subject/grade/teacher)
      function getFilteredChaptersRaw(){
        let list = chapters.slice();
        const fSchool = filterSchool.value || 'All';
        const fSub = filterSubject.value || 'All';
        const fGrade = filterGrade.value || 'All';
        const fTeacher = filterTeacher.value || 'All';

        if(fSchool !== 'All'){
          list = list.filter(c => (c.school || 'Unassigned') === fSchool);
        }
        if(fSub !== 'All'){
          list = list.filter(c => c.subject === fSub);
        }
        if(fGrade !== 'All'){
          list = list.filter(c => c.grade === fGrade);
        }
        if(fTeacher !== 'All'){
          list = list.filter(c => c.teacher === fTeacher);
        }
        return list;
      }

      // Render chapters in the list area
      function renderChapters(){
        const filtered = getFilteredChaptersRaw();
        chapterList.innerHTML = '';
        if(filtered.length === 0){
          chapterList.innerHTML = '<div class="small">No chapters found for selected filters.</div>';
          return;
        }

        filtered.forEach(ch => {
          const div = document.createElement('div');
          div.className = 'card';
          div.style.marginBottom = '10px';
          div.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <div>
                <div style="font-weight:700">${escapeHtml(ch.title || '(Untitled)')}</div>
                <div class="small">School: ${escapeHtml(ch.school || 'Unassigned')} â€¢ Subject: ${escapeHtml(ch.subject || '')} â€¢ Grade: ${escapeHtml(ch.grade || '')}</div>
                <div class="small">Teacher: ${escapeHtml(ch.teacher || '')}</div>
                <div class="small" style="margin-top:6px">${escapeHtml(ch.notes || '')}</div>
              </div>
              <div style="display:flex; flex-direction:column; gap:8px;">
                <div style="display:flex; gap:8px;">
                  <button class="btn ghost" data-id="${ch.id}" data-action="edit">Edit</button>
                  <button class="btn ghost" data-id="${ch.id}" data-action="toggleComplete">${ch.completed ? 'Mark Incomplete' : 'Mark Complete'}</button>
                </div>
                <div style="display:flex; gap:8px;">
                  <button class="btn ghost" data-id="${ch.id}" data-action="toggleTest">${ch.testConducted ? 'Test Done' : 'Mark Test'}</button>
                  <button class="btn ghost" data-id="${ch.id}" data-action="delete">Delete</button>
                </div>
              </div>
            </div>
          `;
          chapterList.appendChild(div);
        });

        // attach handlers
        chapterList.querySelectorAll('button').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const id = btn.getAttribute('data-id');
            const action = btn.getAttribute('data-action');
            if(action === 'edit') openEditorFor(id);
            if(action === 'toggleComplete') await toggleComplete(id);
            if(action === 'toggleTest') await toggleTest(id);
            if(action === 'delete') { if(confirm('Delete this chapter?')) await deleteChapter(id); }
          });
        });
      }

      function escapeHtml(str){
        if(!str) return '';
        return String(str).replace(/[&<>"']/g, function(m){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]; });
      }

      // Editor handlers
      addManualBtn.addEventListener('click', () => {
        currentEditId = null;
        editorTitle.textContent = 'Add Chapter';
        editorTitleInput.value = '';
        editorNotes.value = '';
        editorTeacher.value = '';
        editorGrade.value = editorGrade.options[0].value || '6';
        // default editorSchool to filterSchool selection if specific, else first school
        editorSchool.value = (filterSchool.value && filterSchool.value !== 'All') ? filterSchool.value : (schools[0] && schools[0].name);
        editorSubject.value = editorSubject.options[0].value;
        chapterEditor.classList.remove('hidden');
        editorTitleInput.focus();
      });

      cancelEditBtn.addEventListener('click', () => {
        chapterEditor.classList.add('hidden');
        currentEditId = null;
      });

      async function openEditorFor(id){
        const ch = chapters.find(c=>c.id===id);
        if(!ch) return alert('Chapter not found');
        currentEditId = id;
        editorTitle.textContent = 'Edit Chapter';
        editorTitleInput.value = ch.title || '';
        editorNotes.value = ch.notes || '';
        editorTeacher.value = ch.teacher || '';
        editorGrade.value = ch.grade || (editorGrade.options[0] && editorGrade.options[0].value);
        editorSchool.value = ch.school || (schools[0] && schools[0].name);
        // if subject exists in editor list, select it; otherwise add to editorSubject temporarily
        let found = false;
        for(let i=0;i<editorSubject.options.length;i++){
          if(editorSubject.options[i].value === ch.subject){ editorSubject.selectedIndex = i; found = true; break; }
        }
        if(!found){
          // add temporary option
          const o = document.createElement('option'); o.value = ch.subject; o.textContent = ch.subject;
          editorSubject.appendChild(o);
          editorSubject.value = ch.subject;
        }
        chapterEditor.classList.remove('hidden');
        editorTitleInput.focus();
      }

      saveChapterBtn.addEventListener('click', async () => {
        const payload = {
          school: editorSchool.value || null,
          subject: editorSubject.value || '',
          grade: editorGrade.value || '',
          teacher: editorTeacher.value || '',
          title: editorTitleInput.value || '',
          notes: editorNotes.value || '',
          completed: false,
          testConducted: false
        };
        try{
          if(currentEditId){
            // update existing
            await window.storeApi.updateChapter(currentEditId, payload);
            // update local copy
            chapters = chapters.map(c => c.id === currentEditId ? Object.assign({}, c, payload) : c);
          } else {
            const newCh = await window.storeApi.addChapter(payload);
            chapters.push(newCh);
          }
          chapterEditor.classList.add('hidden');
          currentEditId = null;
          refreshFiltersDependent();
          renderChapters();
          updateStatsAndCharts();
        } catch(err){
          console.error(err);
          alert('Save failed: ' + (err.message||err));
        }
      });

      async function deleteChapter(id){
        try{
          await window.storeApi.deleteChapter(id);
          chapters = chapters.filter(c => c.id !== id);
          renderChapters();
          updateStatsAndCharts();
        } catch(err){
          console.error(err);
          alert('Delete failed');
        }
      }

      async function toggleComplete(id){
        const ch = chapters.find(c=>c.id===id);
        if(!ch) return;
        const pat = { completed: !ch.completed };
        await window.storeApi.updateChapter(id, pat);
        ch.completed = pat.completed;
        renderChapters();
        updateStatsAndCharts();
      }

      async function toggleTest(id){
        const ch = chapters.find(c=>c.id===id);
        if(!ch) return;
        const pat = { testConducted: !ch.testConducted };
        await window.storeApi.updateChapter(id, pat);
        ch.testConducted = pat.testConducted;
        renderChapters();
        updateStatsAndCharts();
      }

      // CSV import
      importCsv.addEventListener('click', async () => {
        const file = csvFile.files[0];
        if(!file) return alert('Select CSV file first');
        const text = await file.text();
        // parse naive CSV (first row headers expected: school,subject,grade,teacher,title,notes,completed,testConducted)
        const rows = text.split(/\r?\n/).map(r=>r.trim()).filter(Boolean);
        if(rows.length === 0) return alert('CSV empty');
        const headers = rows[0].split(',').map(h=>h.trim());
        const dataRows = rows.slice(1);
        const created = [];
        for(const r of dataRows){
          const cols = r.split(',').map(c=>c.trim());
          const obj = {};
          headers.forEach((h, idx) => { obj[h] = cols[idx] || ''; });
          // attach selected school if the csv doesn't include school
          const schoolFromUi = (filterSchool.value && filterSchool.value !== 'All') ? filterSchool.value : (editorSchool.value || (schools[0] && schools[0].name));
          const schoolVal = obj.school || schoolFromUi || 'Unassigned';
          const chapter = {
            school: schoolVal,
            subject: obj.subject || '',
            grade: obj.grade || '',
            teacher: obj.teacher || '',
            title: obj.title || '',
            notes: obj.notes || '',
            completed: (String(obj.completed||'').toLowerCase()==='true' || String(obj.completed||'').toLowerCase()==='yes'),
            testConducted: (String(obj.testConducted||'').toLowerCase()==='true' || String(obj.testConducted||'').toLowerCase()==='yes')
          };
          const added = await window.storeApi.addChapter(chapter);
          created.push(added);
        }
        chapters = chapters.concat(created);
        csvFile.value = '';
        refreshFiltersDependent();
        renderChapters();
        updateStatsAndCharts();
        alert('Imported ' + created.length + ' chapters');
      });

      // Chart helpers
      function getCountsForFiltered(){
        const f = getFilteredChaptersRaw();
        const total = f.length;
        const completed = f.filter(c => c.completed).length;
        const pending = f.filter(c => !c.completed).length;
        return { total, completed, pending, items: f };
      }

      function computeSubjectDistribution(items){
        const m = {};
        items.forEach(it => {
          const s = it.subject || 'Unknown';
          if(!m[s]) m[s] = 0;
          if(it.completed) m[s] += 1;
        });
        // compute total chapters per subject to derive %
        const totalPerSub = {};
        items.forEach(it=>{
          const s = it.subject || 'Unknown';
          totalPerSub[s] = (totalPerSub[s]||0) + 1;
        });
        const labels = Object.keys(totalPerSub);
        const perc = labels.map(lbl => {
          const tot = totalPerSub[lbl] || 0;
          const comp = m[lbl] || 0;
          return (tot === 0 ? 0 : Math.round((comp / tot) * 100));
        });
        return { labels, perc, totalPerSub, completedPerSub: m };
      }

      function computePendingBySchool(allChapters){
        const map = {};
        allChapters.forEach(c => {
          const sc = c.school || 'Unassigned';
          if(!map[sc]) map[sc] = 0;
          if(!c.testConducted) map[sc] += 1;
        });
        const labels = Object.keys(map);
        const vals = labels.map(l => map[l]);
        return { labels, vals };
      }

      function updateStatsAndCharts(){
        const counts = getCountsForFiltered();
        statTotal.textContent = counts.total;
        statCompleted.textContent = counts.completed;
        statPending.textContent = counts.items.filter(it=>!it.testConducted).length;

        // Overall progress doughnut: completed vs pending (for the filtered view)
        const overallData = { labels: ['Completed','Pending'], datasets: [{ data: [counts.completed, Math.max(0, counts.total - counts.completed)], backgroundColor:['#38a169', '#e6eef3'] }]};
        if(chartOverall) chartOverall.destroy();
        chartOverall = new Chart(canvasOverall.getContext('2d'), { type:'doughnut', data: overallData, options:{ cutout: '70%', plugins:{legend:{display:true, position:'bottom'}} } });

        // Subject completion: show percent completed per subject for the filtered view
        const subj = computeSubjectDistribution(counts.items);
        if(chartSubject) chartSubject.destroy();
        chartSubject = new Chart(canvasSubject.getContext('2d'), { type:'pie', data:{ labels: subj.labels, datasets:[{ data: subj.perc }]}, options:{ plugins:{legend:{position:'bottom'}} } });

        // Pending tests by school: this should reflect across all chapters, but also respect filterSchool selection.
        // If filterSchool is 'All' then compute across all schools, otherwise just show for selected school.
        const allChapsForPending = (filterSchool.value && filterSchool.value !== 'All') ? chapters.filter(c => (c.school || 'Unassigned') === filterSchool.value) : chapters;
        const pendingBySchool = computePendingBySchool(allChapsForPending);
        if(chartPendingBySchool) chartPendingBySchool.destroy();
        chartPendingBySchool = new Chart(canvasPendingBySchool.getContext('2d'), {
          type:'bar',
          data:{ labels: pendingBySchool.labels, datasets:[{ label:'Pending Tests', data: pendingBySchool.vals }]},
          options:{ plugins:{legend:{display:false}}, scales:{ x:{ ticks:{ autoSkip:false, maxRotation:45, minRotation:45 } } } }
        });
      }

      // Wire filter change handlers
      [filterSchool, filterSubject, filterGrade, filterTeacher].forEach(el=>{
        el.addEventListener('change', () => {
          refreshFiltersDependent();
          renderChapters();
          updateStatsAndCharts();
        });
      });

      // Initial load
      loadInitialData();

      // Utility: sign out placeholder
      $('signOutBtn').addEventListener('click', () => alert('Sign out flow â€” implement via Firebase auth as needed.'));

      // ensure UI doesn't show any raw JS or code in footer: we avoid rendering raw script text anywhere
      (function removeTrailingScriptText(){
        // previously some script content was accidentally appended to the DOM; ensure not present
        // (no-op here but left for safety)
      })();

      // Expose some helpers for debugging in console
      window._ct = {
        refresh: async () => { chapters = await window.storeApi.getChapters(); renderChapters(); updateStatsAndCharts(); refreshFiltersDependent(); },
        addSample: async () => {
          const sample = { school: schools[0].name, subject: schools[0].subjects[0], grade:'9', teacher:'Demo', title:'New Chapter '+Math.random().toString(36).slice(2,6), notes:'', completed:false, testConducted:false };
          const added = await window.storeApi.addChapter(sample);
          chapters.push(added);
          renderChapters(); updateStatsAndCharts(); refreshFiltersDependent();
        },
        store: window._localStore
      };
    })();
  </script>
</body>
</html>
